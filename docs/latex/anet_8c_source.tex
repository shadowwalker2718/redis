\hypertarget{anet_8c_source}{}\section{anet.\+c}
\label{anet_8c_source}\index{src/anet.\+c@{src/anet.\+c}}

\begin{DoxyCode}
00001 \textcolor{comment}{/* anet.c -- Basic TCP socket stuff made a bit less boring}
00002 \textcolor{comment}{ *}
00003 \textcolor{comment}{ * Copyright (c) 2006-2012, Salvatore Sanfilippo <antirez at gmail dot com>}
00004 \textcolor{comment}{ * All rights reserved.}
00005 \textcolor{comment}{ *}
00006 \textcolor{comment}{ * Redistribution and use in source and binary forms, with or without}
00007 \textcolor{comment}{ * modification, are permitted provided that the following conditions are met:}
00008 \textcolor{comment}{ *}
00009 \textcolor{comment}{ *   * Redistributions of source code must retain the above copyright notice,}
00010 \textcolor{comment}{ *     this list of conditions and the following disclaimer.}
00011 \textcolor{comment}{ *   * Redistributions in binary form must reproduce the above copyright}
00012 \textcolor{comment}{ *     notice, this list of conditions and the following disclaimer in the}
00013 \textcolor{comment}{ *     documentation and/or other materials provided with the distribution.}
00014 \textcolor{comment}{ *   * Neither the name of Redis nor the names of its contributors may be used}
00015 \textcolor{comment}{ *     to endorse or promote products derived from this software without}
00016 \textcolor{comment}{ *     specific prior written permission.}
00017 \textcolor{comment}{ *}
00018 \textcolor{comment}{ * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"}
00019 \textcolor{comment}{ * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE}
00020 \textcolor{comment}{ * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE}
00021 \textcolor{comment}{ * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE}
00022 \textcolor{comment}{ * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR}
00023 \textcolor{comment}{ * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF}
00024 \textcolor{comment}{ * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS}
00025 \textcolor{comment}{ * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN}
00026 \textcolor{comment}{ * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)}
00027 \textcolor{comment}{ * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE}
00028 \textcolor{comment}{ * POSSIBILITY OF SUCH DAMAGE.}
00029 \textcolor{comment}{ */}
00030 
00031 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \hyperlink{fmacros_8h}{"fmacros.h"}
00032 
00033 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{sys}\textcolor{preprocessor}{/}\textcolor{preprocessor}{types}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00034 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{sys}\textcolor{preprocessor}{/}\textcolor{preprocessor}{socket}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00035 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{sys}\textcolor{preprocessor}{/}\textcolor{preprocessor}{stat}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00036 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{sys}\textcolor{preprocessor}{/}\textcolor{preprocessor}{un}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00037 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{sys}\textcolor{preprocessor}{/}\textcolor{preprocessor}{time}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00038 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{netinet}\textcolor{preprocessor}{/}\textcolor{preprocessor}{in}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00039 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{netinet}\textcolor{preprocessor}{/}\textcolor{preprocessor}{tcp}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00040 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{arpa}\textcolor{preprocessor}{/}\textcolor{preprocessor}{inet}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00041 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{unistd}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00042 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{fcntl}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00043 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{string}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00044 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{netdb}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00045 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{errno}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00046 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{stdarg}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00047 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{stdio}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00048 
00049 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \hyperlink{anet_8h}{"anet.h"}
00050 
00051 \textcolor{keyword}{static} \textcolor{keywordtype}{void} anetSetError(\textcolor{keywordtype}{char} *err, \textcolor{keyword}{const} \textcolor{keywordtype}{char} *fmt, ...)
00052 \{
00053     va\_list ap;
00054 
00055     \textcolor{keywordflow}{if} (!err) \textcolor{keywordflow}{return};
00056     va\_start(ap, fmt);
00057     vsnprintf(err, \hyperlink{anet_8h_a92d565f421c133e9fac9dbbe8c88922b}{ANET\_ERR\_LEN}, fmt, ap);
00058     va\_end(ap);
00059 \}
00060 
00061 \textcolor{keywordtype}{int} anetSetBlock(\textcolor{keywordtype}{char} *err, \textcolor{keywordtype}{int} fd, \textcolor{keywordtype}{int} non\_block) \{
00062     \textcolor{keywordtype}{int} flags;
00063 
00064     \textcolor{comment}{/* Set the socket blocking (if non\_block is zero) or non-blocking.}
00065 \textcolor{comment}{     * Note that fcntl(2) for F\_GETFL and F\_SETFL can't be}
00066 \textcolor{comment}{     * interrupted by a signal. */}
00067     \textcolor{keywordflow}{if} ((flags = fcntl(fd, F\_GETFL)) == -1) \{
00068         anetSetError(err, \textcolor{stringliteral}{"fcntl(F\_GETFL): %s"}, strerror(errno));
00069         \textcolor{keywordflow}{return} \hyperlink{anet_8h_a0697b7774a7e0f4ef141839fe93536fe}{ANET\_ERR};
00070     \}
00071 
00072     \textcolor{keywordflow}{if} (non\_block)
00073         flags |= O\_NONBLOCK;
00074     \textcolor{keywordflow}{else}
00075         flags &= ~O\_NONBLOCK;
00076 
00077     \textcolor{keywordflow}{if} (fcntl(fd, F\_SETFL, flags) == -1) \{
00078         anetSetError(err, \textcolor{stringliteral}{"fcntl(F\_SETFL,O\_NONBLOCK): %s"}, strerror(errno));
00079         \textcolor{keywordflow}{return} \hyperlink{anet_8h_a0697b7774a7e0f4ef141839fe93536fe}{ANET\_ERR};
00080     \}
00081     \textcolor{keywordflow}{return} \hyperlink{anet_8h_a25fb91ccc6457153f6d2e21380d4c6cf}{ANET\_OK};
00082 \}
00083 
00084 \textcolor{keywordtype}{int} anetNonBlock(\textcolor{keywordtype}{char} *err, \textcolor{keywordtype}{int} fd) \{
00085     \textcolor{keywordflow}{return} anetSetBlock(err,fd,1);
00086 \}
00087 
00088 \textcolor{keywordtype}{int} anetBlock(\textcolor{keywordtype}{char} *err, \textcolor{keywordtype}{int} fd) \{
00089     \textcolor{keywordflow}{return} anetSetBlock(err,fd,0);
00090 \}
00091 
00092 \textcolor{comment}{/* Set TCP keep alive option to detect dead peers. The interval option}
00093 \textcolor{comment}{ * is only used for Linux as we are using Linux-specific APIs to set}
00094 \textcolor{comment}{ * the probe send time, interval, and count. */}
00095 \textcolor{keywordtype}{int} anetKeepAlive(\textcolor{keywordtype}{char} *err, \textcolor{keywordtype}{int} fd, \textcolor{keywordtype}{int} interval)
00096 \{
00097     \textcolor{keywordtype}{int} val = 1;
00098 
00099     \textcolor{keywordflow}{if} (setsockopt(fd, SOL\_SOCKET, SO\_KEEPALIVE, &val, \textcolor{keyword}{sizeof}(val)) == -1)
00100     \{
00101         anetSetError(err, \textcolor{stringliteral}{"setsockopt SO\_KEEPALIVE: %s"}, strerror(errno));
00102         \textcolor{keywordflow}{return} \hyperlink{anet_8h_a0697b7774a7e0f4ef141839fe93536fe}{ANET\_ERR};
00103     \}
00104 
00105 \textcolor{preprocessor}{#}\textcolor{preprocessor}{ifdef} \_\_linux\_\_
00106     \textcolor{comment}{/* Default settings are more or less garbage, with the keepalive time}
00107 \textcolor{comment}{     * set to 7200 by default on Linux. Modify settings to make the feature}
00108 \textcolor{comment}{     * actually useful. */}
00109 
00110     \textcolor{comment}{/* Send first probe after interval. */}
00111     val = interval;
00112     \textcolor{keywordflow}{if} (setsockopt(fd, IPPROTO\_TCP, TCP\_KEEPIDLE, &val, \textcolor{keyword}{sizeof}(val)) < 0) \{
00113         anetSetError(err, \textcolor{stringliteral}{"setsockopt TCP\_KEEPIDLE: %s\(\backslash\)n"}, strerror(errno));
00114         \textcolor{keywordflow}{return} \hyperlink{anet_8h_a0697b7774a7e0f4ef141839fe93536fe}{ANET\_ERR};
00115     \}
00116 
00117     \textcolor{comment}{/* Send next probes after the specified interval. Note that we set the}
00118 \textcolor{comment}{     * delay as interval / 3, as we send three probes before detecting}
00119 \textcolor{comment}{     * an error (see the next setsockopt call). */}
00120     val = interval/3;
00121     \textcolor{keywordflow}{if} (val == 0) val = 1;
00122     \textcolor{keywordflow}{if} (setsockopt(fd, IPPROTO\_TCP, TCP\_KEEPINTVL, &val, \textcolor{keyword}{sizeof}(val)) < 0) \{
00123         anetSetError(err, \textcolor{stringliteral}{"setsockopt TCP\_KEEPINTVL: %s\(\backslash\)n"}, strerror(errno));
00124         \textcolor{keywordflow}{return} \hyperlink{anet_8h_a0697b7774a7e0f4ef141839fe93536fe}{ANET\_ERR};
00125     \}
00126 
00127     \textcolor{comment}{/* Consider the socket in error state after three we send three ACK}
00128 \textcolor{comment}{     * probes without getting a reply. */}
00129     val = 3;
00130     \textcolor{keywordflow}{if} (setsockopt(fd, IPPROTO\_TCP, TCP\_KEEPCNT, &val, \textcolor{keyword}{sizeof}(val)) < 0) \{
00131         anetSetError(err, \textcolor{stringliteral}{"setsockopt TCP\_KEEPCNT: %s\(\backslash\)n"}, strerror(errno));
00132         \textcolor{keywordflow}{return} \hyperlink{anet_8h_a0697b7774a7e0f4ef141839fe93536fe}{ANET\_ERR};
00133     \}
00134 \textcolor{preprocessor}{#}\textcolor{preprocessor}{else}
00135     ((\textcolor{keywordtype}{void}) interval); \textcolor{comment}{/* Avoid unused var warning for non Linux systems. */}
00136 \textcolor{preprocessor}{#}\textcolor{preprocessor}{endif}
00137 
00138     \textcolor{keywordflow}{return} \hyperlink{anet_8h_a25fb91ccc6457153f6d2e21380d4c6cf}{ANET\_OK};
00139 \}
00140 
00141 \textcolor{keyword}{static} \textcolor{keywordtype}{int} anetSetTcpNoDelay(\textcolor{keywordtype}{char} *err, \textcolor{keywordtype}{int} fd, \textcolor{keywordtype}{int} val)
00142 \{
00143     \textcolor{keywordflow}{if} (setsockopt(fd, IPPROTO\_TCP, TCP\_NODELAY, &val, \textcolor{keyword}{sizeof}(val)) == -1)
00144     \{
00145         anetSetError(err, \textcolor{stringliteral}{"setsockopt TCP\_NODELAY: %s"}, strerror(errno));
00146         \textcolor{keywordflow}{return} \hyperlink{anet_8h_a0697b7774a7e0f4ef141839fe93536fe}{ANET\_ERR};
00147     \}
00148     \textcolor{keywordflow}{return} \hyperlink{anet_8h_a25fb91ccc6457153f6d2e21380d4c6cf}{ANET\_OK};
00149 \}
00150 
00151 \textcolor{keywordtype}{int} anetEnableTcpNoDelay(\textcolor{keywordtype}{char} *err, \textcolor{keywordtype}{int} fd)
00152 \{
00153     \textcolor{keywordflow}{return} anetSetTcpNoDelay(err, fd, 1);
00154 \}
00155 
00156 \textcolor{keywordtype}{int} anetDisableTcpNoDelay(\textcolor{keywordtype}{char} *err, \textcolor{keywordtype}{int} fd)
00157 \{
00158     \textcolor{keywordflow}{return} anetSetTcpNoDelay(err, fd, 0);
00159 \}
00160 
00161 
00162 \textcolor{keywordtype}{int} anetSetSendBuffer(\textcolor{keywordtype}{char} *err, \textcolor{keywordtype}{int} fd, \textcolor{keywordtype}{int} buffsize)
00163 \{
00164     \textcolor{keywordflow}{if} (setsockopt(fd, SOL\_SOCKET, SO\_SNDBUF, &buffsize, \textcolor{keyword}{sizeof}(buffsize)) == -1)
00165     \{
00166         anetSetError(err, \textcolor{stringliteral}{"setsockopt SO\_SNDBUF: %s"}, strerror(errno));
00167         \textcolor{keywordflow}{return} \hyperlink{anet_8h_a0697b7774a7e0f4ef141839fe93536fe}{ANET\_ERR};
00168     \}
00169     \textcolor{keywordflow}{return} \hyperlink{anet_8h_a25fb91ccc6457153f6d2e21380d4c6cf}{ANET\_OK};
00170 \}
00171 
00172 \textcolor{keywordtype}{int} anetTcpKeepAlive(\textcolor{keywordtype}{char} *err, \textcolor{keywordtype}{int} fd)
00173 \{
00174     \textcolor{keywordtype}{int} yes = 1;
00175     \textcolor{keywordflow}{if} (setsockopt(fd, SOL\_SOCKET, SO\_KEEPALIVE, &yes, \textcolor{keyword}{sizeof}(yes)) == -1) \{
00176         anetSetError(err, \textcolor{stringliteral}{"setsockopt SO\_KEEPALIVE: %s"}, strerror(errno));
00177         \textcolor{keywordflow}{return} \hyperlink{anet_8h_a0697b7774a7e0f4ef141839fe93536fe}{ANET\_ERR};
00178     \}
00179     \textcolor{keywordflow}{return} \hyperlink{anet_8h_a25fb91ccc6457153f6d2e21380d4c6cf}{ANET\_OK};
00180 \}
00181 
00182 \textcolor{comment}{/* Set the socket send timeout (SO\_SNDTIMEO socket option) to the specified}
00183 \textcolor{comment}{ * number of milliseconds, or disable it if the 'ms' argument is zero. */}
00184 \textcolor{keywordtype}{int} anetSendTimeout(\textcolor{keywordtype}{char} *err, \textcolor{keywordtype}{int} fd, \textcolor{keywordtype}{long} \textcolor{keywordtype}{long} ms) \{
00185     \textcolor{keyword}{struct} timeval tv;
00186 
00187     tv.tv\_sec = ms/1000;
00188     tv.tv\_usec = (ms%1000)*1000;
00189     \textcolor{keywordflow}{if} (setsockopt(fd, SOL\_SOCKET, SO\_SNDTIMEO, &tv, \textcolor{keyword}{sizeof}(tv)) == -1) \{
00190         anetSetError(err, \textcolor{stringliteral}{"setsockopt SO\_SNDTIMEO: %s"}, strerror(errno));
00191         \textcolor{keywordflow}{return} \hyperlink{anet_8h_a0697b7774a7e0f4ef141839fe93536fe}{ANET\_ERR};
00192     \}
00193     \textcolor{keywordflow}{return} \hyperlink{anet_8h_a25fb91ccc6457153f6d2e21380d4c6cf}{ANET\_OK};
00194 \}
00195 
00196 \textcolor{comment}{/* anetGenericResolve() is called by anetResolve() and anetResolveIP() to}
00197 \textcolor{comment}{ * do the actual work. It resolves the hostname "host" and set the string}
00198 \textcolor{comment}{ * representation of the IP address into the buffer pointed by "ipbuf".}
00199 \textcolor{comment}{ *}
00200 \textcolor{comment}{ * If flags is set to ANET\_IP\_ONLY the function only resolves hostnames}
00201 \textcolor{comment}{ * that are actually already IPv4 or IPv6 addresses. This turns the function}
00202 \textcolor{comment}{ * into a validating / normalizing function. */}
00203 \textcolor{keywordtype}{int} anetGenericResolve(\textcolor{keywordtype}{char} *err, \textcolor{keywordtype}{char} *host, \textcolor{keywordtype}{char} *ipbuf, size\_t ipbuf\_len,
00204                        \textcolor{keywordtype}{int} flags)
00205 \{
00206     \textcolor{keyword}{struct} addrinfo hints, *info;
00207     \textcolor{keywordtype}{int} rv;
00208 
00209     memset(&hints,0,\textcolor{keyword}{sizeof}(hints));
00210     \textcolor{keywordflow}{if} (flags & \hyperlink{anet_8h_a705c91a7b61459ba004364262845c5f4}{ANET\_IP\_ONLY}) hints.ai\_flags = AI\_NUMERICHOST;
00211     hints.ai\_family = AF\_UNSPEC;
00212     hints.ai\_socktype = SOCK\_STREAM;  \textcolor{comment}{/* specify socktype to avoid dups */}
00213 
00214     \textcolor{keywordflow}{if} ((rv = getaddrinfo(host, NULL, &hints, &info)) != 0) \{
00215         anetSetError(err, \textcolor{stringliteral}{"%s"}, gai\_strerror(rv));
00216         \textcolor{keywordflow}{return} \hyperlink{anet_8h_a0697b7774a7e0f4ef141839fe93536fe}{ANET\_ERR};
00217     \}
00218     \textcolor{keywordflow}{if} (info->ai\_family == AF\_INET) \{
00219         \textcolor{keyword}{struct} sockaddr\_in *sa = (\textcolor{keyword}{struct} sockaddr\_in *)info->ai\_addr;
00220         inet\_ntop(AF\_INET, &(sa->sin\_addr), ipbuf, ipbuf\_len);
00221     \} \textcolor{keywordflow}{else} \{
00222         \textcolor{keyword}{struct} sockaddr\_in6 *sa = (\textcolor{keyword}{struct} sockaddr\_in6 *)info->ai\_addr;
00223         inet\_ntop(AF\_INET6, &(sa->sin6\_addr), ipbuf, ipbuf\_len);
00224     \}
00225 
00226     freeaddrinfo(info);
00227     \textcolor{keywordflow}{return} \hyperlink{anet_8h_a25fb91ccc6457153f6d2e21380d4c6cf}{ANET\_OK};
00228 \}
00229 
00230 \textcolor{keywordtype}{int} anetResolve(\textcolor{keywordtype}{char} *err, \textcolor{keywordtype}{char} *host, \textcolor{keywordtype}{char} *ipbuf, size\_t ipbuf\_len) \{
00231     \textcolor{keywordflow}{return} anetGenericResolve(err,host,ipbuf,ipbuf\_len,\hyperlink{anet_8h_aea959562fbeec73b16b1cc037e700c02}{ANET\_NONE});
00232 \}
00233 
00234 \textcolor{keywordtype}{int} anetResolveIP(\textcolor{keywordtype}{char} *err, \textcolor{keywordtype}{char} *host, \textcolor{keywordtype}{char} *ipbuf, size\_t ipbuf\_len) \{
00235     \textcolor{keywordflow}{return} anetGenericResolve(err,host,ipbuf,ipbuf\_len,\hyperlink{anet_8h_a705c91a7b61459ba004364262845c5f4}{ANET\_IP\_ONLY});
00236 \}
00237 
00238 \textcolor{keyword}{static} \textcolor{keywordtype}{int} anetSetReuseAddr(\textcolor{keywordtype}{char} *err, \textcolor{keywordtype}{int} fd) \{
00239     \textcolor{keywordtype}{int} yes = 1;
00240     \textcolor{comment}{/* Make sure connection-intensive things like the redis benchmark}
00241 \textcolor{comment}{     * will be able to close/open sockets a zillion of times */}
00242     \textcolor{keywordflow}{if} (setsockopt(fd, SOL\_SOCKET, SO\_REUSEADDR, &yes, \textcolor{keyword}{sizeof}(yes)) == -1) \{
00243         anetSetError(err, \textcolor{stringliteral}{"setsockopt SO\_REUSEADDR: %s"}, strerror(errno));
00244         \textcolor{keywordflow}{return} \hyperlink{anet_8h_a0697b7774a7e0f4ef141839fe93536fe}{ANET\_ERR};
00245     \}
00246     \textcolor{keywordflow}{return} \hyperlink{anet_8h_a25fb91ccc6457153f6d2e21380d4c6cf}{ANET\_OK};
00247 \}
00248 
00249 \textcolor{keyword}{static} \textcolor{keywordtype}{int} anetCreateSocket(\textcolor{keywordtype}{char} *err, \textcolor{keywordtype}{int} domain) \{
00250     \textcolor{keywordtype}{int} s;
00251     \textcolor{keywordflow}{if} ((s = socket(domain, SOCK\_STREAM, 0)) == -1) \{
00252         anetSetError(err, \textcolor{stringliteral}{"creating socket: %s"}, strerror(errno));
00253         \textcolor{keywordflow}{return} \hyperlink{anet_8h_a0697b7774a7e0f4ef141839fe93536fe}{ANET\_ERR};
00254     \}
00255 
00256     \textcolor{comment}{/* Make sure connection-intensive things like the redis benchmark}
00257 \textcolor{comment}{     * will be able to close/open sockets a zillion of times */}
00258     \textcolor{keywordflow}{if} (anetSetReuseAddr(err,s) == \hyperlink{anet_8h_a0697b7774a7e0f4ef141839fe93536fe}{ANET\_ERR}) \{
00259         close(s);
00260         \textcolor{keywordflow}{return} \hyperlink{anet_8h_a0697b7774a7e0f4ef141839fe93536fe}{ANET\_ERR};
00261     \}
00262     \textcolor{keywordflow}{return} s;
00263 \}
00264 
00265 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{ANET\_CONNECT\_NONE} 0
00266 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{ANET\_CONNECT\_NONBLOCK} 1
00267 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{ANET\_CONNECT\_BE\_BINDING} 2 \textcolor{comment}{/* Best effort binding. */}
00268 \textcolor{keyword}{static} \textcolor{keywordtype}{int} anetTcpGenericConnect(\textcolor{keywordtype}{char} *err, \textcolor{keywordtype}{char} *addr, \textcolor{keywordtype}{int} port,
00269                                  \textcolor{keywordtype}{char} *source\_addr, \textcolor{keywordtype}{int} flags)
00270 \{
00271     \textcolor{keywordtype}{int} s = \hyperlink{anet_8h_a0697b7774a7e0f4ef141839fe93536fe}{ANET\_ERR}, rv;
00272     \textcolor{keywordtype}{char} portstr[6];  \textcolor{comment}{/* strlen("65535") + 1; */}
00273     \textcolor{keyword}{struct} addrinfo hints, *servinfo, *bservinfo, *p, *b;
00274 
00275     snprintf(portstr,\textcolor{keyword}{sizeof}(portstr),\textcolor{stringliteral}{"%d"},port);
00276     memset(&hints,0,\textcolor{keyword}{sizeof}(hints));
00277     hints.ai\_family = AF\_UNSPEC;
00278     hints.ai\_socktype = SOCK\_STREAM;
00279 
00280     \textcolor{keywordflow}{if} ((rv = getaddrinfo(addr,portstr,&hints,&servinfo)) != 0) \{
00281         anetSetError(err, \textcolor{stringliteral}{"%s"}, gai\_strerror(rv));
00282         \textcolor{keywordflow}{return} \hyperlink{anet_8h_a0697b7774a7e0f4ef141839fe93536fe}{ANET\_ERR};
00283     \}
00284     \textcolor{keywordflow}{for} (p = servinfo; p != NULL; p = p->ai\_next) \{
00285         \textcolor{comment}{/* Try to create the socket and to connect it.}
00286 \textcolor{comment}{         * If we fail in the socket() call, or on connect(), we retry with}
00287 \textcolor{comment}{         * the next entry in servinfo. */}
00288         \textcolor{keywordflow}{if} ((s = socket(p->ai\_family,p->ai\_socktype,p->ai\_protocol)) == -1)
00289             \textcolor{keywordflow}{continue};
00290         \textcolor{keywordflow}{if} (anetSetReuseAddr(err,s) == \hyperlink{anet_8h_a0697b7774a7e0f4ef141839fe93536fe}{ANET\_ERR}) \textcolor{keywordflow}{goto} error;
00291         \textcolor{keywordflow}{if} (flags & \hyperlink{anet_8c_a487909d18aa88f156b4ef393bc9ceaed}{ANET\_CONNECT\_NONBLOCK} && anetNonBlock(err,s) != 
      \hyperlink{anet_8h_a25fb91ccc6457153f6d2e21380d4c6cf}{ANET\_OK})
00292             \textcolor{keywordflow}{goto} error;
00293         \textcolor{keywordflow}{if} (source\_addr) \{
00294             \textcolor{keywordtype}{int} bound = 0;
00295             \textcolor{comment}{/* Using getaddrinfo saves us from self-determining IPv4 vs IPv6 */}
00296             \textcolor{keywordflow}{if} ((rv = getaddrinfo(source\_addr, NULL, &hints, &bservinfo)) != 0)
00297             \{
00298                 anetSetError(err, \textcolor{stringliteral}{"%s"}, gai\_strerror(rv));
00299                 \textcolor{keywordflow}{goto} error;
00300             \}
00301             \textcolor{keywordflow}{for} (b = bservinfo; b != NULL; b = b->ai\_next) \{
00302                 \textcolor{keywordflow}{if} (bind(s,b->ai\_addr,b->ai\_addrlen) != -1) \{
00303                     bound = 1;
00304                     \textcolor{keywordflow}{break};
00305                 \}
00306             \}
00307             freeaddrinfo(bservinfo);
00308             \textcolor{keywordflow}{if} (!bound) \{
00309                 anetSetError(err, \textcolor{stringliteral}{"bind: %s"}, strerror(errno));
00310                 \textcolor{keywordflow}{goto} error;
00311             \}
00312         \}
00313         \textcolor{keywordflow}{if} (connect(s,p->ai\_addr,p->ai\_addrlen) == -1) \{
00314             \textcolor{comment}{/* If the socket is non-blocking, it is ok for connect() to}
00315 \textcolor{comment}{             * return an EINPROGRESS error here. */}
00316             \textcolor{keywordflow}{if} (errno == EINPROGRESS && flags & \hyperlink{anet_8c_a487909d18aa88f156b4ef393bc9ceaed}{ANET\_CONNECT\_NONBLOCK})
00317                 \textcolor{keywordflow}{goto} end;
00318             close(s);
00319             s = \hyperlink{anet_8h_a0697b7774a7e0f4ef141839fe93536fe}{ANET\_ERR};
00320             \textcolor{keywordflow}{continue};
00321         \}
00322 
00323         \textcolor{comment}{/* If we ended an iteration of the for loop without errors, we}
00324 \textcolor{comment}{         * have a connected socket. Let's return to the caller. */}
00325         \textcolor{keywordflow}{goto} end;
00326     \}
00327     \textcolor{keywordflow}{if} (p == NULL)
00328         anetSetError(err, \textcolor{stringliteral}{"creating socket: %s"}, strerror(errno));
00329 
00330 error:
00331     \textcolor{keywordflow}{if} (s != \hyperlink{anet_8h_a0697b7774a7e0f4ef141839fe93536fe}{ANET\_ERR}) \{
00332         close(s);
00333         s = \hyperlink{anet_8h_a0697b7774a7e0f4ef141839fe93536fe}{ANET\_ERR};
00334     \}
00335 
00336 end:
00337     freeaddrinfo(servinfo);
00338 
00339     \textcolor{comment}{/* Handle best effort binding: if a binding address was used, but it is}
00340 \textcolor{comment}{     * not possible to create a socket, try again without a binding address. */}
00341     \textcolor{keywordflow}{if} (s == \hyperlink{anet_8h_a0697b7774a7e0f4ef141839fe93536fe}{ANET\_ERR} && source\_addr && (flags & 
      \hyperlink{anet_8c_ad7a12e96a6a3deac27f3fb90db759d8b}{ANET\_CONNECT\_BE\_BINDING})) \{
00342         \textcolor{keywordflow}{return} anetTcpGenericConnect(err,addr,port,NULL,flags);
00343     \} \textcolor{keywordflow}{else} \{
00344         \textcolor{keywordflow}{return} s;
00345     \}
00346 \}
00347 
00348 \textcolor{keywordtype}{int} anetTcpConnect(\textcolor{keywordtype}{char} *err, \textcolor{keywordtype}{char} *addr, \textcolor{keywordtype}{int} port)
00349 \{
00350     \textcolor{keywordflow}{return} anetTcpGenericConnect(err,addr,port,NULL,\hyperlink{anet_8c_a8e16527c2634344c5ff2d2c3db91d318}{ANET\_CONNECT\_NONE});
00351 \}
00352 
00353 \textcolor{keywordtype}{int} anetTcpNonBlockConnect(\textcolor{keywordtype}{char} *err, \textcolor{keywordtype}{char} *addr, \textcolor{keywordtype}{int} port)
00354 \{
00355     \textcolor{keywordflow}{return} anetTcpGenericConnect(err,addr,port,NULL,\hyperlink{anet_8c_a487909d18aa88f156b4ef393bc9ceaed}{ANET\_CONNECT\_NONBLOCK});
00356 \}
00357 
00358 \textcolor{keywordtype}{int} anetTcpNonBlockBindConnect(\textcolor{keywordtype}{char} *err, \textcolor{keywordtype}{char} *addr, \textcolor{keywordtype}{int} port,
00359                                \textcolor{keywordtype}{char} *source\_addr)
00360 \{
00361     \textcolor{keywordflow}{return} anetTcpGenericConnect(err,addr,port,source\_addr,
00362             \hyperlink{anet_8c_a487909d18aa88f156b4ef393bc9ceaed}{ANET\_CONNECT\_NONBLOCK});
00363 \}
00364 
00365 \textcolor{keywordtype}{int} anetTcpNonBlockBestEffortBindConnect(\textcolor{keywordtype}{char} *err, \textcolor{keywordtype}{char} *addr, \textcolor{keywordtype}{int} port,
00366                                          \textcolor{keywordtype}{char} *source\_addr)
00367 \{
00368     \textcolor{keywordflow}{return} anetTcpGenericConnect(err,addr,port,source\_addr,
00369             \hyperlink{anet_8c_a487909d18aa88f156b4ef393bc9ceaed}{ANET\_CONNECT\_NONBLOCK}|
      \hyperlink{anet_8c_ad7a12e96a6a3deac27f3fb90db759d8b}{ANET\_CONNECT\_BE\_BINDING});
00370 \}
00371 
00372 \textcolor{keywordtype}{int} anetUnixGenericConnect(\textcolor{keywordtype}{char} *err, \textcolor{keywordtype}{char} *path, \textcolor{keywordtype}{int} flags)
00373 \{
00374     \textcolor{keywordtype}{int} s;
00375     \textcolor{keyword}{struct} sockaddr\_un sa;
00376 
00377     \textcolor{keywordflow}{if} ((s = anetCreateSocket(err,AF\_LOCAL)) == \hyperlink{anet_8h_a0697b7774a7e0f4ef141839fe93536fe}{ANET\_ERR})
00378         \textcolor{keywordflow}{return} \hyperlink{anet_8h_a0697b7774a7e0f4ef141839fe93536fe}{ANET\_ERR};
00379 
00380     sa.sun\_family = AF\_LOCAL;
00381     strncpy(sa.sun\_path,path,\textcolor{keyword}{sizeof}(sa.sun\_path)-1);
00382     \textcolor{keywordflow}{if} (flags & \hyperlink{anet_8c_a487909d18aa88f156b4ef393bc9ceaed}{ANET\_CONNECT\_NONBLOCK}) \{
00383         \textcolor{keywordflow}{if} (anetNonBlock(err,s) != \hyperlink{anet_8h_a25fb91ccc6457153f6d2e21380d4c6cf}{ANET\_OK}) \{
00384             close(s);
00385             \textcolor{keywordflow}{return} \hyperlink{anet_8h_a0697b7774a7e0f4ef141839fe93536fe}{ANET\_ERR};
00386         \}
00387     \}
00388     \textcolor{keywordflow}{if} (connect(s,(\textcolor{keyword}{struct} sockaddr*)&sa,\textcolor{keyword}{sizeof}(sa)) == -1) \{
00389         \textcolor{keywordflow}{if} (errno == EINPROGRESS &&
00390             flags & \hyperlink{anet_8c_a487909d18aa88f156b4ef393bc9ceaed}{ANET\_CONNECT\_NONBLOCK})
00391             \textcolor{keywordflow}{return} s;
00392 
00393         anetSetError(err, \textcolor{stringliteral}{"connect: %s"}, strerror(errno));
00394         close(s);
00395         \textcolor{keywordflow}{return} \hyperlink{anet_8h_a0697b7774a7e0f4ef141839fe93536fe}{ANET\_ERR};
00396     \}
00397     \textcolor{keywordflow}{return} s;
00398 \}
00399 
00400 \textcolor{keywordtype}{int} anetUnixConnect(\textcolor{keywordtype}{char} *err, \textcolor{keywordtype}{char} *path)
00401 \{
00402     \textcolor{keywordflow}{return} anetUnixGenericConnect(err,path,\hyperlink{anet_8c_a8e16527c2634344c5ff2d2c3db91d318}{ANET\_CONNECT\_NONE});
00403 \}
00404 
00405 \textcolor{keywordtype}{int} anetUnixNonBlockConnect(\textcolor{keywordtype}{char} *err, \textcolor{keywordtype}{char} *path)
00406 \{
00407     \textcolor{keywordflow}{return} anetUnixGenericConnect(err,path,\hyperlink{anet_8c_a487909d18aa88f156b4ef393bc9ceaed}{ANET\_CONNECT\_NONBLOCK});
00408 \}
00409 
00410 \textcolor{comment}{/* Like read(2) but make sure 'count' is read before to return}
00411 \textcolor{comment}{ * (unless error or EOF condition is encountered) */}
00412 \textcolor{keywordtype}{int} anetRead(\textcolor{keywordtype}{int} fd, \textcolor{keywordtype}{char} *buf, \textcolor{keywordtype}{int} count)
00413 \{
00414     ssize\_t nread, totlen = 0;
00415     \textcolor{keywordflow}{while}(totlen != count) \{
00416         nread = read(fd,buf,count-totlen);
00417         \textcolor{keywordflow}{if} (nread == 0) \textcolor{keywordflow}{return} totlen;
00418         \textcolor{keywordflow}{if} (nread == -1) \textcolor{keywordflow}{return} -1;
00419         totlen += nread;
00420         buf += nread;
00421     \}
00422     \textcolor{keywordflow}{return} totlen;
00423 \}
00424 
00425 \textcolor{comment}{/* Like write(2) but make sure 'count' is written before to return}
00426 \textcolor{comment}{ * (unless error is encountered) */}
00427 \textcolor{keywordtype}{int} anetWrite(\textcolor{keywordtype}{int} fd, \textcolor{keywordtype}{char} *buf, \textcolor{keywordtype}{int} count)
00428 \{
00429     ssize\_t nwritten, totlen = 0;
00430     \textcolor{keywordflow}{while}(totlen != count) \{
00431         nwritten = write(fd,buf,count-totlen);
00432         \textcolor{keywordflow}{if} (nwritten == 0) \textcolor{keywordflow}{return} totlen;
00433         \textcolor{keywordflow}{if} (nwritten == -1) \textcolor{keywordflow}{return} -1;
00434         totlen += nwritten;
00435         buf += nwritten;
00436     \}
00437     \textcolor{keywordflow}{return} totlen;
00438 \}
00439 
00440 \textcolor{keyword}{static} \textcolor{keywordtype}{int} anetListen(\textcolor{keywordtype}{char} *err, \textcolor{keywordtype}{int} s, \textcolor{keyword}{struct} sockaddr *sa, socklen\_t len, \textcolor{keywordtype}{int} backlog) \{
00441     \textcolor{keywordflow}{if} (bind(s,sa,len) == -1) \{
00442         anetSetError(err, \textcolor{stringliteral}{"bind: %s"}, strerror(errno));
00443         close(s);
00444         \textcolor{keywordflow}{return} \hyperlink{anet_8h_a0697b7774a7e0f4ef141839fe93536fe}{ANET\_ERR};
00445     \}
00446 
00447     \textcolor{keywordflow}{if} (listen(s, backlog) == -1) \{
00448         anetSetError(err, \textcolor{stringliteral}{"listen: %s"}, strerror(errno));
00449         close(s);
00450         \textcolor{keywordflow}{return} \hyperlink{anet_8h_a0697b7774a7e0f4ef141839fe93536fe}{ANET\_ERR};
00451     \}
00452     \textcolor{keywordflow}{return} \hyperlink{anet_8h_a25fb91ccc6457153f6d2e21380d4c6cf}{ANET\_OK};
00453 \}
00454 
00455 \textcolor{keyword}{static} \textcolor{keywordtype}{int} anetV6Only(\textcolor{keywordtype}{char} *err, \textcolor{keywordtype}{int} s) \{
00456     \textcolor{keywordtype}{int} yes = 1;
00457     \textcolor{keywordflow}{if} (setsockopt(s,IPPROTO\_IPV6,IPV6\_V6ONLY,&yes,\textcolor{keyword}{sizeof}(yes)) == -1) \{
00458         anetSetError(err, \textcolor{stringliteral}{"setsockopt: %s"}, strerror(errno));
00459         close(s);
00460         \textcolor{keywordflow}{return} \hyperlink{anet_8h_a0697b7774a7e0f4ef141839fe93536fe}{ANET\_ERR};
00461     \}
00462     \textcolor{keywordflow}{return} \hyperlink{anet_8h_a25fb91ccc6457153f6d2e21380d4c6cf}{ANET\_OK};
00463 \}
00464 
00465 \textcolor{keyword}{static} \textcolor{keywordtype}{int} \_anetTcpServer(\textcolor{keywordtype}{char} *err, \textcolor{keywordtype}{int} port, \textcolor{keywordtype}{char} *bindaddr, \textcolor{keywordtype}{int} af, \textcolor{keywordtype}{int} backlog)
00466 \{
00467     \textcolor{keywordtype}{int} s = -1, rv;
00468     \textcolor{keywordtype}{char} \_port[6];  \textcolor{comment}{/* strlen("65535") */}
00469     \textcolor{keyword}{struct} addrinfo hints, *servinfo, *p;
00470 
00471     snprintf(\_port,6,\textcolor{stringliteral}{"%d"},port);
00472     memset(&hints,0,\textcolor{keyword}{sizeof}(hints));
00473     hints.ai\_family = af;
00474     hints.ai\_socktype = SOCK\_STREAM;
00475     hints.ai\_flags = AI\_PASSIVE;    \textcolor{comment}{/* No effect if bindaddr != NULL */}
00476 
00477     \textcolor{keywordflow}{if} ((rv = getaddrinfo(bindaddr,\_port,&hints,&servinfo)) != 0) \{
00478         anetSetError(err, \textcolor{stringliteral}{"%s"}, gai\_strerror(rv));
00479         \textcolor{keywordflow}{return} \hyperlink{anet_8h_a0697b7774a7e0f4ef141839fe93536fe}{ANET\_ERR};
00480     \}
00481     \textcolor{keywordflow}{for} (p = servinfo; p != NULL; p = p->ai\_next) \{
00482         \textcolor{keywordflow}{if} ((s = socket(p->ai\_family,p->ai\_socktype,p->ai\_protocol)) == -1)
00483             \textcolor{keywordflow}{continue};
00484 
00485         \textcolor{keywordflow}{if} (af == AF\_INET6 && anetV6Only(err,s) == \hyperlink{anet_8h_a0697b7774a7e0f4ef141839fe93536fe}{ANET\_ERR}) \textcolor{keywordflow}{goto} error;
00486         \textcolor{keywordflow}{if} (anetSetReuseAddr(err,s) == \hyperlink{anet_8h_a0697b7774a7e0f4ef141839fe93536fe}{ANET\_ERR}) \textcolor{keywordflow}{goto} error;
00487         \textcolor{keywordflow}{if} (anetListen(err,s,p->ai\_addr,p->ai\_addrlen,backlog) == \hyperlink{anet_8h_a0697b7774a7e0f4ef141839fe93536fe}{ANET\_ERR}) \textcolor{keywordflow}{goto} error;
00488         \textcolor{keywordflow}{goto} end;
00489     \}
00490     \textcolor{keywordflow}{if} (p == NULL) \{
00491         anetSetError(err, \textcolor{stringliteral}{"unable to bind socket, errno: %d"}, errno);
00492         \textcolor{keywordflow}{goto} error;
00493     \}
00494 
00495 error:
00496     \textcolor{keywordflow}{if} (s != -1) close(s);
00497     s = \hyperlink{anet_8h_a0697b7774a7e0f4ef141839fe93536fe}{ANET\_ERR};
00498 end:
00499     freeaddrinfo(servinfo);
00500     \textcolor{keywordflow}{return} s;
00501 \}
00502 
00503 \textcolor{keywordtype}{int} anetTcpServer(\textcolor{keywordtype}{char} *err, \textcolor{keywordtype}{int} port, \textcolor{keywordtype}{char} *bindaddr, \textcolor{keywordtype}{int} backlog)
00504 \{
00505     \textcolor{keywordflow}{return} \_anetTcpServer(err, port, bindaddr, AF\_INET, backlog);
00506 \}
00507 
00508 \textcolor{keywordtype}{int} anetTcp6Server(\textcolor{keywordtype}{char} *err, \textcolor{keywordtype}{int} port, \textcolor{keywordtype}{char} *bindaddr, \textcolor{keywordtype}{int} backlog)
00509 \{
00510     \textcolor{keywordflow}{return} \_anetTcpServer(err, port, bindaddr, AF\_INET6, backlog);
00511 \}
00512 
00513 \textcolor{keywordtype}{int} anetUnixServer(\textcolor{keywordtype}{char} *err, \textcolor{keywordtype}{char} *path, mode\_t perm, \textcolor{keywordtype}{int} backlog)
00514 \{
00515     \textcolor{keywordtype}{int} s;
00516     \textcolor{keyword}{struct} sockaddr\_un sa;
00517 
00518     \textcolor{keywordflow}{if} ((s = anetCreateSocket(err,AF\_LOCAL)) == \hyperlink{anet_8h_a0697b7774a7e0f4ef141839fe93536fe}{ANET\_ERR})
00519         \textcolor{keywordflow}{return} \hyperlink{anet_8h_a0697b7774a7e0f4ef141839fe93536fe}{ANET\_ERR};
00520 
00521     memset(&sa,0,\textcolor{keyword}{sizeof}(sa));
00522     sa.sun\_family = AF\_LOCAL;
00523     strncpy(sa.sun\_path,path,\textcolor{keyword}{sizeof}(sa.sun\_path)-1);
00524     \textcolor{keywordflow}{if} (anetListen(err,s,(\textcolor{keyword}{struct} sockaddr*)&sa,\textcolor{keyword}{sizeof}(sa),backlog) == 
      \hyperlink{anet_8h_a0697b7774a7e0f4ef141839fe93536fe}{ANET\_ERR})
00525         \textcolor{keywordflow}{return} \hyperlink{anet_8h_a0697b7774a7e0f4ef141839fe93536fe}{ANET\_ERR};
00526     \textcolor{keywordflow}{if} (perm)
00527         chmod(sa.sun\_path, perm);
00528     \textcolor{keywordflow}{return} s;
00529 \}
00530 
00531 \textcolor{keyword}{static} \textcolor{keywordtype}{int} anetGenericAccept(\textcolor{keywordtype}{char} *err, \textcolor{keywordtype}{int} s, \textcolor{keyword}{struct} sockaddr *sa, socklen\_t *len) \{
00532     \textcolor{keywordtype}{int} fd;
00533     \textcolor{keywordflow}{while}(1) \{
00534         fd = accept(s,sa,len);
00535         \textcolor{keywordflow}{if} (fd == -1) \{
00536             \textcolor{keywordflow}{if} (errno == EINTR)
00537                 \textcolor{keywordflow}{continue};
00538             \textcolor{keywordflow}{else} \{
00539                 anetSetError(err, \textcolor{stringliteral}{"accept: %s"}, strerror(errno));
00540                 \textcolor{keywordflow}{return} \hyperlink{anet_8h_a0697b7774a7e0f4ef141839fe93536fe}{ANET\_ERR};
00541             \}
00542         \}
00543         \textcolor{keywordflow}{break};
00544     \}
00545     \textcolor{keywordflow}{return} fd;
00546 \}
00547 
00548 \textcolor{keywordtype}{int} anetTcpAccept(\textcolor{keywordtype}{char} *err, \textcolor{keywordtype}{int} s, \textcolor{keywordtype}{char} *ip, size\_t ip\_len, \textcolor{keywordtype}{int} *port) \{
00549     \textcolor{keywordtype}{int} fd;
00550     \textcolor{keyword}{struct} sockaddr\_storage sa;
00551     socklen\_t salen = \textcolor{keyword}{sizeof}(sa);
00552     \textcolor{keywordflow}{if} ((fd = anetGenericAccept(err,s,(\textcolor{keyword}{struct} sockaddr*)&sa,&salen)) == -1)
00553         \textcolor{keywordflow}{return} \hyperlink{anet_8h_a0697b7774a7e0f4ef141839fe93536fe}{ANET\_ERR};
00554 
00555     \textcolor{keywordflow}{if} (sa.ss\_family == AF\_INET) \{
00556         \textcolor{keyword}{struct} sockaddr\_in *s = (\textcolor{keyword}{struct} sockaddr\_in *)&sa;
00557         \textcolor{keywordflow}{if} (ip) inet\_ntop(AF\_INET,(\textcolor{keywordtype}{void}*)&(s->sin\_addr),ip,ip\_len);
00558         \textcolor{keywordflow}{if} (port) *port = ntohs(s->sin\_port);
00559     \} \textcolor{keywordflow}{else} \{
00560         \textcolor{keyword}{struct} sockaddr\_in6 *s = (\textcolor{keyword}{struct} sockaddr\_in6 *)&sa;
00561         \textcolor{keywordflow}{if} (ip) inet\_ntop(AF\_INET6,(\textcolor{keywordtype}{void}*)&(s->sin6\_addr),ip,ip\_len);
00562         \textcolor{keywordflow}{if} (port) *port = ntohs(s->sin6\_port);
00563     \}
00564     \textcolor{keywordflow}{return} fd;
00565 \}
00566 
00567 \textcolor{keywordtype}{int} anetUnixAccept(\textcolor{keywordtype}{char} *err, \textcolor{keywordtype}{int} s) \{
00568     \textcolor{keywordtype}{int} fd;
00569     \textcolor{keyword}{struct} sockaddr\_un sa;
00570     socklen\_t salen = \textcolor{keyword}{sizeof}(sa);
00571     \textcolor{keywordflow}{if} ((fd = anetGenericAccept(err,s,(\textcolor{keyword}{struct} sockaddr*)&sa,&salen)) == -1)
00572         \textcolor{keywordflow}{return} \hyperlink{anet_8h_a0697b7774a7e0f4ef141839fe93536fe}{ANET\_ERR};
00573 
00574     \textcolor{keywordflow}{return} fd;
00575 \}
00576 
00577 \textcolor{keywordtype}{int} anetPeerToString(\textcolor{keywordtype}{int} fd, \textcolor{keywordtype}{char} *ip, size\_t ip\_len, \textcolor{keywordtype}{int} *port) \{
00578     \textcolor{keyword}{struct} sockaddr\_storage sa;
00579     socklen\_t salen = \textcolor{keyword}{sizeof}(sa);
00580 
00581     \textcolor{keywordflow}{if} (getpeername(fd,(\textcolor{keyword}{struct} sockaddr*)&sa,&salen) == -1) \textcolor{keywordflow}{goto} error;
00582     \textcolor{keywordflow}{if} (ip\_len == 0) \textcolor{keywordflow}{goto} error;
00583 
00584     \textcolor{keywordflow}{if} (sa.ss\_family == AF\_INET) \{
00585         \textcolor{keyword}{struct} sockaddr\_in *s = (\textcolor{keyword}{struct} sockaddr\_in *)&sa;
00586         \textcolor{keywordflow}{if} (ip) inet\_ntop(AF\_INET,(\textcolor{keywordtype}{void}*)&(s->sin\_addr),ip,ip\_len);
00587         \textcolor{keywordflow}{if} (port) *port = ntohs(s->sin\_port);
00588     \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (sa.ss\_family == AF\_INET6) \{
00589         \textcolor{keyword}{struct} sockaddr\_in6 *s = (\textcolor{keyword}{struct} sockaddr\_in6 *)&sa;
00590         \textcolor{keywordflow}{if} (ip) inet\_ntop(AF\_INET6,(\textcolor{keywordtype}{void}*)&(s->sin6\_addr),ip,ip\_len);
00591         \textcolor{keywordflow}{if} (port) *port = ntohs(s->sin6\_port);
00592     \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (sa.ss\_family == AF\_UNIX) \{
00593         \textcolor{keywordflow}{if} (ip) strncpy(ip,\textcolor{stringliteral}{"/unixsocket"},ip\_len);
00594         \textcolor{keywordflow}{if} (port) *port = 0;
00595     \} \textcolor{keywordflow}{else} \{
00596         \textcolor{keywordflow}{goto} error;
00597     \}
00598     \textcolor{keywordflow}{return} 0;
00599 
00600 error:
00601     \textcolor{keywordflow}{if} (ip) \{
00602         \textcolor{keywordflow}{if} (ip\_len >= 2) \{
00603             ip[0] = \textcolor{stringliteral}{'?'};
00604             ip[1] = \textcolor{stringliteral}{'\(\backslash\)0'};
00605         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (ip\_len == 1) \{
00606             ip[0] = \textcolor{stringliteral}{'\(\backslash\)0'};
00607         \}
00608     \}
00609     \textcolor{keywordflow}{if} (port) *port = 0;
00610     \textcolor{keywordflow}{return} -1;
00611 \}
00612 
00613 \textcolor{comment}{/* Format an IP,port pair into something easy to parse. If IP is IPv6}
00614 \textcolor{comment}{ * (matches for ":"), the ip is surrounded by []. IP and port are just}
00615 \textcolor{comment}{ * separated by colons. This the standard to display addresses within Redis. */}
00616 \textcolor{keywordtype}{int} anetFormatAddr(\textcolor{keywordtype}{char} *buf, size\_t buf\_len, \textcolor{keywordtype}{char} *ip, \textcolor{keywordtype}{int} port) \{
00617     \textcolor{keywordflow}{return} snprintf(buf,buf\_len, strchr(ip,\textcolor{stringliteral}{':'}) ?
00618            \textcolor{stringliteral}{"[%s]:%d"} : \textcolor{stringliteral}{"%s:%d"}, ip, port);
00619 \}
00620 
00621 \textcolor{comment}{/* Like anetFormatAddr() but extract ip and port from the socket's peer. */}
00622 \textcolor{keywordtype}{int} anetFormatPeer(\textcolor{keywordtype}{int} fd, \textcolor{keywordtype}{char} *buf, size\_t buf\_len) \{
00623     \textcolor{keywordtype}{char} ip[INET6\_ADDRSTRLEN];
00624     \textcolor{keywordtype}{int} port;
00625 
00626     anetPeerToString(fd,ip,\textcolor{keyword}{sizeof}(ip),&port);
00627     \textcolor{keywordflow}{return} anetFormatAddr(buf, buf\_len, ip, port);
00628 \}
00629 
00630 \textcolor{keywordtype}{int} anetSockName(\textcolor{keywordtype}{int} fd, \textcolor{keywordtype}{char} *ip, size\_t ip\_len, \textcolor{keywordtype}{int} *port) \{
00631     \textcolor{keyword}{struct} sockaddr\_storage sa;
00632     socklen\_t salen = \textcolor{keyword}{sizeof}(sa);
00633 
00634     \textcolor{keywordflow}{if} (getsockname(fd,(\textcolor{keyword}{struct} sockaddr*)&sa,&salen) == -1) \{
00635         \textcolor{keywordflow}{if} (port) *port = 0;
00636         ip[0] = \textcolor{stringliteral}{'?'};
00637         ip[1] = \textcolor{stringliteral}{'\(\backslash\)0'};
00638         \textcolor{keywordflow}{return} -1;
00639     \}
00640     \textcolor{keywordflow}{if} (sa.ss\_family == AF\_INET) \{
00641         \textcolor{keyword}{struct} sockaddr\_in *s = (\textcolor{keyword}{struct} sockaddr\_in *)&sa;
00642         \textcolor{keywordflow}{if} (ip) inet\_ntop(AF\_INET,(\textcolor{keywordtype}{void}*)&(s->sin\_addr),ip,ip\_len);
00643         \textcolor{keywordflow}{if} (port) *port = ntohs(s->sin\_port);
00644     \} \textcolor{keywordflow}{else} \{
00645         \textcolor{keyword}{struct} sockaddr\_in6 *s = (\textcolor{keyword}{struct} sockaddr\_in6 *)&sa;
00646         \textcolor{keywordflow}{if} (ip) inet\_ntop(AF\_INET6,(\textcolor{keywordtype}{void}*)&(s->sin6\_addr),ip,ip\_len);
00647         \textcolor{keywordflow}{if} (port) *port = ntohs(s->sin6\_port);
00648     \}
00649     \textcolor{keywordflow}{return} 0;
00650 \}
00651 
00652 \textcolor{keywordtype}{int} anetFormatSock(\textcolor{keywordtype}{int} fd, \textcolor{keywordtype}{char} *fmt, size\_t fmt\_len) \{
00653     \textcolor{keywordtype}{char} ip[INET6\_ADDRSTRLEN];
00654     \textcolor{keywordtype}{int} port;
00655 
00656     anetSockName(fd,ip,\textcolor{keyword}{sizeof}(ip),&port);
00657     \textcolor{keywordflow}{return} anetFormatAddr(fmt, fmt\_len, ip, port);
00658 \}
\end{DoxyCode}
