\hypertarget{geohash__helper_8c_source}{}\section{geohash\+\_\+helper.\+c}
\label{geohash__helper_8c_source}\index{src/geohash\+\_\+helper.\+c@{src/geohash\+\_\+helper.\+c}}

\begin{DoxyCode}
00001 \textcolor{comment}{/*}
00002 \textcolor{comment}{ * Copyright (c) 2013-2014, yinqiwen <yinqiwen@gmail.com>}
00003 \textcolor{comment}{ * Copyright (c) 2014, Matt Stancliff <matt@genges.com>.}
00004 \textcolor{comment}{ * Copyright (c) 2015-2016, Salvatore Sanfilippo <antirez@gmail.com>.}
00005 \textcolor{comment}{ * All rights reserved.}
00006 \textcolor{comment}{ *}
00007 \textcolor{comment}{ * Redistribution and use in source and binary forms, with or without}
00008 \textcolor{comment}{ * modification, are permitted provided that the following conditions are met:}
00009 \textcolor{comment}{ *}
00010 \textcolor{comment}{ *  * Redistributions of source code must retain the above copyright notice,}
00011 \textcolor{comment}{ *    this list of conditions and the following disclaimer.}
00012 \textcolor{comment}{ *  * Redistributions in binary form must reproduce the above copyright}
00013 \textcolor{comment}{ *    notice, this list of conditions and the following disclaimer in the}
00014 \textcolor{comment}{ *    documentation and/or other materials provided with the distribution.}
00015 \textcolor{comment}{ *  * Neither the name of Redis nor the names of its contributors may be used}
00016 \textcolor{comment}{ *    to endorse or promote products derived from this software without}
00017 \textcolor{comment}{ *    specific prior written permission.}
00018 \textcolor{comment}{ *}
00019 \textcolor{comment}{ * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"}
00020 \textcolor{comment}{ * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE}
00021 \textcolor{comment}{ * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE}
00022 \textcolor{comment}{ * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS}
00023 \textcolor{comment}{ * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR}
00024 \textcolor{comment}{ * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF}
00025 \textcolor{comment}{ * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS}
00026 \textcolor{comment}{ * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN}
00027 \textcolor{comment}{ * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)}
00028 \textcolor{comment}{ * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF}
00029 \textcolor{comment}{ * THE POSSIBILITY OF SUCH DAMAGE.}
00030 \textcolor{comment}{ */}
00031 
00032 \textcolor{comment}{/* This is a C++ to C conversion from the ardb project.}
00033 \textcolor{comment}{ * This file started out as:}
00034 \textcolor{comment}{ * https://github.com/yinqiwen/ardb/blob/d42503/src/geo/geohash\_helper.cpp}
00035 \textcolor{comment}{ */}
00036 
00037 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \hyperlink{fmacros_8h}{"fmacros.h"}
00038 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \hyperlink{geohash__helper_8h}{"geohash\_helper.h"}
00039 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \hyperlink{debugmacro_8h}{"debugmacro.h"}
00040 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{math}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00041 
00042 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{D\_R} \textcolor{preprocessor}{(}M\_PI \textcolor{preprocessor}{/} 180.0\textcolor{preprocessor}{)}
00043 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{R\_MAJOR} 6378137.0
00044 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{R\_MINOR} 6356752.3142
00045 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{RATIO} \textcolor{preprocessor}{(}\hyperlink{geohash__helper_8c_aaed2746737d8a4ae298ef4c61d58a1eb}{R\_MINOR} \textcolor{preprocessor}{/} \hyperlink{geohash__helper_8c_a829002fc4dfdb3d37fa2d2e8ca61d2cf}{R\_MAJOR}\textcolor{preprocessor}{)}
00046 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{ECCENT} \textcolor{preprocessor}{(}\textcolor{preprocessor}{sqrt}\textcolor{preprocessor}{(}1.0 \textcolor{preprocessor}{-} \textcolor{preprocessor}{(}\hyperlink{geohash__helper_8c_a7e8b3c8482e593df0ace933ad3de22ee}{RATIO} \textcolor{preprocessor}{*}\hyperlink{geohash__helper_8c_a7e8b3c8482e593df0ace933ad3de22ee}{RATIO}\textcolor{preprocessor}{)}\textcolor{preprocessor}{)}\textcolor{preprocessor}{)}
00047 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{COM} \textcolor{preprocessor}{(}0.5 \textcolor{preprocessor}{*} \hyperlink{geohash__helper_8c_a6e8637818fcb5466c85681cabd563e88}{ECCENT}\textcolor{preprocessor}{)}
00048 
00049 \textcolor{comment}{/// @brief The usual PI/180 constant}
00050 \textcolor{keyword}{const} \textcolor{keywordtype}{double} DEG\_TO\_RAD = 0.017453292519943295769236907684886;
00051 \textcolor{comment}{/// @brief Earth's quatratic mean radius for WGS-84}
00052 \textcolor{keyword}{const} \textcolor{keywordtype}{double} EARTH\_RADIUS\_IN\_METERS = 6372797.560856;
00053 
00054 \textcolor{keyword}{const} \textcolor{keywordtype}{double} MERCATOR\_MAX = 20037726.37;
00055 \textcolor{keyword}{const} \textcolor{keywordtype}{double} MERCATOR\_MIN = -20037726.37;
00056 
00057 \textcolor{keyword}{static} \textcolor{keyword}{inline} \textcolor{keywordtype}{double} deg\_rad(\textcolor{keywordtype}{double} ang) \{ \textcolor{keywordflow}{return} ang * \hyperlink{geohash__helper_8c_a96d3ed094cee215a1c3806455ecfc4d2}{D\_R}; \}
00058 \textcolor{keyword}{static} \textcolor{keyword}{inline} \textcolor{keywordtype}{double} rad\_deg(\textcolor{keywordtype}{double} ang) \{ \textcolor{keywordflow}{return} ang / \hyperlink{geohash__helper_8c_a96d3ed094cee215a1c3806455ecfc4d2}{D\_R}; \}
00059 
00060 \textcolor{comment}{/* This function is used in order to estimate the step (bits precision)}
00061 \textcolor{comment}{ * of the 9 search area boxes during radius queries. */}
00062 uint8\_t geohashEstimateStepsByRadius(\textcolor{keywordtype}{double} range\_meters, \textcolor{keywordtype}{double} lat) \{
00063     \textcolor{keywordflow}{if} (range\_meters == 0) \textcolor{keywordflow}{return} 26;
00064     \textcolor{keywordtype}{int} step = 1;
00065     \textcolor{keywordflow}{while} (range\_meters < MERCATOR\_MAX) \{
00066         range\_meters *= 2;
00067         step++;
00068     \}
00069     step -= 2; \textcolor{comment}{/* Make sure range is included in most of the base cases. */}
00070 
00071     \textcolor{comment}{/* Wider range torwards the poles... Note: it is possible to do better}
00072 \textcolor{comment}{     * than this approximation by computing the distance between meridians}
00073 \textcolor{comment}{     * at this latitude, but this does the trick for now. */}
00074     \textcolor{keywordflow}{if} (lat > 66 || lat < -66) \{
00075         step--;
00076         \textcolor{keywordflow}{if} (lat > 80 || lat < -80) step--;
00077     \}
00078 
00079     \textcolor{comment}{/* Frame to valid range. */}
00080     \textcolor{keywordflow}{if} (step < 1) step = 1;
00081     \textcolor{keywordflow}{if} (step > 26) step = 26;
00082     \textcolor{keywordflow}{return} step;
00083 \}
00084 
00085 \textcolor{comment}{/* Return the bounding box of the search area centered at latitude,longitude}
00086 \textcolor{comment}{ * having a radius of radius\_meter. bounds[0] - bounds[2] is the minimum}
00087 \textcolor{comment}{ * and maxium longitude, while bounds[1] - bounds[3] is the minimum and}
00088 \textcolor{comment}{ * maximum latitude.}
00089 \textcolor{comment}{ *}
00090 \textcolor{comment}{ * This function does not behave correctly with very large radius values, for}
00091 \textcolor{comment}{ * instance for the coordinates 81.634948934258375 30.561509253718668 and a}
00092 \textcolor{comment}{ * radius of 7083 kilometers, it reports as bounding boxes:}
00093 \textcolor{comment}{ *}
00094 \textcolor{comment}{ * min\_lon 7.680495, min\_lat -33.119473, max\_lon 155.589402, max\_lat 94.242491}
00095 \textcolor{comment}{ *}
00096 \textcolor{comment}{ * However, for instance, a min\_lon of 7.680495 is not correct, because the}
00097 \textcolor{comment}{ * point -1.27579540014266968 61.33421815228281559 is at less than 7000}
00098 \textcolor{comment}{ * kilometers away.}
00099 \textcolor{comment}{ *}
00100 \textcolor{comment}{ * Since this function is currently only used as an optimization, the}
00101 \textcolor{comment}{ * optimization is not used for very big radiuses, however the function}
00102 \textcolor{comment}{ * should be fixed. */}
00103 \textcolor{keywordtype}{int} geohashBoundingBox(\textcolor{keywordtype}{double} longitude, \textcolor{keywordtype}{double} latitude, \textcolor{keywordtype}{double} radius\_meters,
00104                        \textcolor{keywordtype}{double} *bounds) \{
00105     \textcolor{keywordflow}{if} (!bounds) \textcolor{keywordflow}{return} 0;
00106 
00107     bounds[0] = longitude - rad\_deg(radius\_meters/EARTH\_RADIUS\_IN\_METERS/cos(deg\_rad(latitude)));
00108     bounds[2] = longitude + rad\_deg(radius\_meters/EARTH\_RADIUS\_IN\_METERS/cos(deg\_rad(latitude)));
00109     bounds[1] = latitude - rad\_deg(radius\_meters/EARTH\_RADIUS\_IN\_METERS);
00110     bounds[3] = latitude + rad\_deg(radius\_meters/EARTH\_RADIUS\_IN\_METERS);
00111     \textcolor{keywordflow}{return} 1;
00112 \}
00113 
00114 \textcolor{comment}{/* Return a set of areas (center + 8) that are able to cover a range query}
00115 \textcolor{comment}{ * for the specified position and radius. */}
00116 GeoHashRadius geohashGetAreasByRadius(\textcolor{keywordtype}{double} longitude, \textcolor{keywordtype}{double} latitude, \textcolor{keywordtype}{double} radius\_meters) \{
00117     GeoHashRange long\_range, lat\_range;
00118     GeoHashRadius radius;
00119     GeoHashBits hash;
00120     GeoHashNeighbors neighbors;
00121     GeoHashArea area;
00122     \textcolor{keywordtype}{double} min\_lon, max\_lon, min\_lat, max\_lat;
00123     \textcolor{keywordtype}{double} bounds[4];
00124     \textcolor{keywordtype}{int} steps;
00125 
00126     geohashBoundingBox(longitude, latitude, radius\_meters, bounds);
00127     min\_lon = bounds[0];
00128     min\_lat = bounds[1];
00129     max\_lon = bounds[2];
00130     max\_lat = bounds[3];
00131 
00132     steps = geohashEstimateStepsByRadius(radius\_meters,latitude);
00133 
00134     geohashGetCoordRange(&long\_range,&lat\_range);
00135     geohashEncode(&long\_range,&lat\_range,longitude,latitude,steps,&hash);
00136     geohashNeighbors(&hash,&neighbors);
00137     geohashDecode(long\_range,lat\_range,hash,&area);
00138 
00139     \textcolor{comment}{/* Check if the step is enough at the limits of the covered area.}
00140 \textcolor{comment}{     * Sometimes when the search area is near an edge of the}
00141 \textcolor{comment}{     * area, the estimated step is not small enough, since one of the}
00142 \textcolor{comment}{     * north / south / west / east square is too near to the search area}
00143 \textcolor{comment}{     * to cover everything. */}
00144     \textcolor{keywordtype}{int} decrease\_step = 0;
00145     \{
00146         GeoHashArea north, south, east, west;
00147 
00148         geohashDecode(long\_range, lat\_range, neighbors.north, &north);
00149         geohashDecode(long\_range, lat\_range, neighbors.south, &south);
00150         geohashDecode(long\_range, lat\_range, neighbors.east, &east);
00151         geohashDecode(long\_range, lat\_range, neighbors.west, &west);
00152 
00153         \textcolor{keywordflow}{if} (geohashGetDistance(longitude,latitude,longitude,north.latitude.max)
00154             < radius\_meters) decrease\_step = 1;
00155         \textcolor{keywordflow}{if} (geohashGetDistance(longitude,latitude,longitude,south.latitude.min)
00156             < radius\_meters) decrease\_step = 1;
00157         \textcolor{keywordflow}{if} (geohashGetDistance(longitude,latitude,east.longitude.max,latitude)
00158             < radius\_meters) decrease\_step = 1;
00159         \textcolor{keywordflow}{if} (geohashGetDistance(longitude,latitude,west.longitude.min,latitude)
00160             < radius\_meters) decrease\_step = 1;
00161     \}
00162 
00163     \textcolor{keywordflow}{if} (steps > 1 && decrease\_step) \{
00164         steps--;
00165         geohashEncode(&long\_range,&lat\_range,longitude,latitude,steps,&hash);
00166         geohashNeighbors(&hash,&neighbors);
00167         geohashDecode(long\_range,lat\_range,hash,&area);
00168     \}
00169 
00170     \textcolor{comment}{/* Exclude the search areas that are useless. */}
00171     \textcolor{keywordflow}{if} (steps >= 2) \{
00172         \textcolor{keywordflow}{if} (area.latitude.min < min\_lat) \{
00173             \hyperlink{geohash__helper_8h_a0ac998d4746216b3a6730185529fe567}{GZERO}(neighbors.south);
00174             \hyperlink{geohash__helper_8h_a0ac998d4746216b3a6730185529fe567}{GZERO}(neighbors.south\_west);
00175             \hyperlink{geohash__helper_8h_a0ac998d4746216b3a6730185529fe567}{GZERO}(neighbors.south\_east);
00176         \}
00177         \textcolor{keywordflow}{if} (area.latitude.max > max\_lat) \{
00178             \hyperlink{geohash__helper_8h_a0ac998d4746216b3a6730185529fe567}{GZERO}(neighbors.north);
00179             \hyperlink{geohash__helper_8h_a0ac998d4746216b3a6730185529fe567}{GZERO}(neighbors.north\_east);
00180             \hyperlink{geohash__helper_8h_a0ac998d4746216b3a6730185529fe567}{GZERO}(neighbors.north\_west);
00181         \}
00182         \textcolor{keywordflow}{if} (area.longitude.min < min\_lon) \{
00183             \hyperlink{geohash__helper_8h_a0ac998d4746216b3a6730185529fe567}{GZERO}(neighbors.west);
00184             \hyperlink{geohash__helper_8h_a0ac998d4746216b3a6730185529fe567}{GZERO}(neighbors.south\_west);
00185             \hyperlink{geohash__helper_8h_a0ac998d4746216b3a6730185529fe567}{GZERO}(neighbors.north\_west);
00186         \}
00187         \textcolor{keywordflow}{if} (area.longitude.max > max\_lon) \{
00188             \hyperlink{geohash__helper_8h_a0ac998d4746216b3a6730185529fe567}{GZERO}(neighbors.east);
00189             \hyperlink{geohash__helper_8h_a0ac998d4746216b3a6730185529fe567}{GZERO}(neighbors.south\_east);
00190             \hyperlink{geohash__helper_8h_a0ac998d4746216b3a6730185529fe567}{GZERO}(neighbors.north\_east);
00191         \}
00192     \}
00193     radius.hash = hash;
00194     radius.neighbors = neighbors;
00195     radius.area = area;
00196     \textcolor{keywordflow}{return} radius;
00197 \}
00198 
00199 GeoHashRadius geohashGetAreasByRadiusWGS84(\textcolor{keywordtype}{double} longitude, \textcolor{keywordtype}{double} latitude,
00200                                            \textcolor{keywordtype}{double} radius\_meters) \{
00201     \textcolor{keywordflow}{return} geohashGetAreasByRadius(longitude, latitude, radius\_meters);
00202 \}
00203 
00204 GeoHashFix52Bits geohashAlign52Bits(\textcolor{keyword}{const} GeoHashBits hash) \{
00205     uint64\_t bits = hash.bits;
00206     bits <<= (52 - hash.step * 2);
00207     \textcolor{keywordflow}{return} bits;
00208 \}
00209 
00210 \textcolor{comment}{/* Calculate distance using haversin great circle distance formula. */}
00211 \textcolor{keywordtype}{double} geohashGetDistance(\textcolor{keywordtype}{double} lon1d, \textcolor{keywordtype}{double} lat1d, \textcolor{keywordtype}{double} lon2d, \textcolor{keywordtype}{double} lat2d) \{
00212     \textcolor{keywordtype}{double} lat1r, lon1r, lat2r, lon2r, u, v;
00213     lat1r = deg\_rad(lat1d);
00214     lon1r = deg\_rad(lon1d);
00215     lat2r = deg\_rad(lat2d);
00216     lon2r = deg\_rad(lon2d);
00217     u = sin((lat2r - lat1r) / 2);
00218     v = sin((lon2r - lon1r) / 2);
00219     \textcolor{keywordflow}{return} 2.0 * EARTH\_RADIUS\_IN\_METERS *
00220            asin(sqrt(u * u + cos(lat1r) * cos(lat2r) * v * v));
00221 \}
00222 
00223 \textcolor{keywordtype}{int} geohashGetDistanceIfInRadius(\textcolor{keywordtype}{double} x1, \textcolor{keywordtype}{double} y1,
00224                                  \textcolor{keywordtype}{double} x2, \textcolor{keywordtype}{double} y2, \textcolor{keywordtype}{double} radius,
00225                                  \textcolor{keywordtype}{double} *distance) \{
00226     *distance = geohashGetDistance(x1, y1, x2, y2);
00227     \textcolor{keywordflow}{if} (*distance > radius) \textcolor{keywordflow}{return} 0;
00228     \textcolor{keywordflow}{return} 1;
00229 \}
00230 
00231 \textcolor{keywordtype}{int} geohashGetDistanceIfInRadiusWGS84(\textcolor{keywordtype}{double} x1, \textcolor{keywordtype}{double} y1, \textcolor{keywordtype}{double} x2,
00232                                       \textcolor{keywordtype}{double} y2, \textcolor{keywordtype}{double} radius,
00233                                       \textcolor{keywordtype}{double} *distance) \{
00234     \textcolor{keywordflow}{return} geohashGetDistanceIfInRadius(x1, y1, x2, y2, radius, distance);
00235 \}
\end{DoxyCode}
