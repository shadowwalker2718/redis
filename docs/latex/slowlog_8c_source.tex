\hypertarget{slowlog_8c_source}{}\section{slowlog.\+c}
\label{slowlog_8c_source}\index{src/slowlog.\+c@{src/slowlog.\+c}}

\begin{DoxyCode}
00001 \textcolor{comment}{/* Slowlog implements a system that is able to remember the latest N}
00002 \textcolor{comment}{ * queries that took more than M microseconds to execute.}
00003 \textcolor{comment}{ *}
00004 \textcolor{comment}{ * The execution time to reach to be logged in the slow log is set}
00005 \textcolor{comment}{ * using the 'slowlog-log-slower-than' config directive, that is also}
00006 \textcolor{comment}{ * readable and writable using the CONFIG SET/GET command.}
00007 \textcolor{comment}{ *}
00008 \textcolor{comment}{ * The slow queries log is actually not "logged" in the Redis log file}
00009 \textcolor{comment}{ * but is accessible thanks to the SLOWLOG command.}
00010 \textcolor{comment}{ *}
00011 \textcolor{comment}{ * ----------------------------------------------------------------------------}
00012 \textcolor{comment}{ *}
00013 \textcolor{comment}{ * Copyright (c) 2009-2012, Salvatore Sanfilippo <antirez at gmail dot com>}
00014 \textcolor{comment}{ * All rights reserved.}
00015 \textcolor{comment}{ *}
00016 \textcolor{comment}{ * Redistribution and use in source and binary forms, with or without}
00017 \textcolor{comment}{ * modification, are permitted provided that the following conditions are met:}
00018 \textcolor{comment}{ *}
00019 \textcolor{comment}{ *   * Redistributions of source code must retain the above copyright notice,}
00020 \textcolor{comment}{ *     this list of conditions and the following disclaimer.}
00021 \textcolor{comment}{ *   * Redistributions in binary form must reproduce the above copyright}
00022 \textcolor{comment}{ *     notice, this list of conditions and the following disclaimer in the}
00023 \textcolor{comment}{ *     documentation and/or other materials provided with the distribution.}
00024 \textcolor{comment}{ *   * Neither the name of Redis nor the names of its contributors may be used}
00025 \textcolor{comment}{ *     to endorse or promote products derived from this software without}
00026 \textcolor{comment}{ *     specific prior written permission.}
00027 \textcolor{comment}{ *}
00028 \textcolor{comment}{ * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"}
00029 \textcolor{comment}{ * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE}
00030 \textcolor{comment}{ * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE}
00031 \textcolor{comment}{ * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE}
00032 \textcolor{comment}{ * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR}
00033 \textcolor{comment}{ * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF}
00034 \textcolor{comment}{ * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS}
00035 \textcolor{comment}{ * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN}
00036 \textcolor{comment}{ * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)}
00037 \textcolor{comment}{ * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE}
00038 \textcolor{comment}{ * POSSIBILITY OF SUCH DAMAGE.}
00039 \textcolor{comment}{ */}
00040 
00041 
00042 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \hyperlink{server_8h}{"server.h"}
00043 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \hyperlink{slowlog_8h}{"slowlog.h"}
00044 
00045 \textcolor{comment}{/* Create a new slowlog entry.}
00046 \textcolor{comment}{ * Incrementing the ref count of all the objects retained is up to}
00047 \textcolor{comment}{ * this function. */}
00048 slowlogEntry *slowlogCreateEntry(\hyperlink{structclient}{client} *c, robj **argv, \textcolor{keywordtype}{int} argc, \textcolor{keywordtype}{long} \textcolor{keywordtype}{long} duration) \{
00049     slowlogEntry *se = zmalloc(\textcolor{keyword}{sizeof}(*se));
00050     \textcolor{keywordtype}{int} j, slargc = argc;
00051 
00052     \textcolor{keywordflow}{if} (slargc > \hyperlink{slowlog_8h_a0b9eefa88302f670eaec2f86a71900f7}{SLOWLOG\_ENTRY\_MAX\_ARGC}) slargc = 
      \hyperlink{slowlog_8h_a0b9eefa88302f670eaec2f86a71900f7}{SLOWLOG\_ENTRY\_MAX\_ARGC};
00053     se->argc = slargc;
00054     se->argv = zmalloc(\textcolor{keyword}{sizeof}(robj*)*slargc);
00055     \textcolor{keywordflow}{for} (j = 0; j < slargc; j++) \{
00056         \textcolor{comment}{/* Logging too many arguments is a useless memory waste, so we stop}
00057 \textcolor{comment}{         * at SLOWLOG\_ENTRY\_MAX\_ARGC, but use the last argument to specify}
00058 \textcolor{comment}{         * how many remaining arguments there were in the original command. */}
00059         \textcolor{keywordflow}{if} (slargc != argc && j == slargc-1) \{
00060             se->argv[j] = createObject(\hyperlink{server_8h_a65236ea160f69cdef33ec942092af88f}{OBJ\_STRING},
00061                 sdscatprintf(sdsempty(),\textcolor{stringliteral}{"... (%d more arguments)"},
00062                 argc-slargc+1));
00063         \} \textcolor{keywordflow}{else} \{
00064             \textcolor{comment}{/* Trim too long strings as well... */}
00065             \textcolor{keywordflow}{if} (argv[j]->type == \hyperlink{server_8h_a65236ea160f69cdef33ec942092af88f}{OBJ\_STRING} &&
00066                 \hyperlink{server_8h_afcfb5bd97af52d1dbce331745cae030c}{sdsEncodedObject}(argv[j]) &&
00067                 sdslen(argv[j]->ptr) > \hyperlink{slowlog_8h_a2b240c1b44f90bb05f0902c94a6a9b57}{SLOWLOG\_ENTRY\_MAX\_STRING})
00068             \{
00069                 sds s = sdsnewlen(argv[j]->ptr, \hyperlink{slowlog_8h_a2b240c1b44f90bb05f0902c94a6a9b57}{SLOWLOG\_ENTRY\_MAX\_STRING});
00070 
00071                 s = sdscatprintf(s,\textcolor{stringliteral}{"... (%lu more bytes)"},
00072                     (\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{long})
00073                     sdslen(argv[j]->ptr) - \hyperlink{slowlog_8h_a2b240c1b44f90bb05f0902c94a6a9b57}{SLOWLOG\_ENTRY\_MAX\_STRING});
00074                 se->argv[j] = createObject(\hyperlink{server_8h_a65236ea160f69cdef33ec942092af88f}{OBJ\_STRING},s);
00075             \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (argv[j]->refcount == \hyperlink{server_8h_a1dc2a137875b0c8ee0fa1df43684a7b8}{OBJ\_SHARED\_REFCOUNT}) \{
00076                 se->argv[j] = argv[j];
00077             \} \textcolor{keywordflow}{else} \{
00078                 \textcolor{comment}{/* Here we need to dupliacate the string objects composing the}
00079 \textcolor{comment}{                 * argument vector of the command, because those may otherwise}
00080 \textcolor{comment}{                 * end shared with string objects stored into keys. Having}
00081 \textcolor{comment}{                 * shared objects between any part of Redis, and the data}
00082 \textcolor{comment}{                 * structure holding the data, is a problem: FLUSHALL ASYNC}
00083 \textcolor{comment}{                 * may release the shared string object and create a race. */}
00084                 se->argv[j] = dupStringObject(argv[j]);
00085             \}
00086         \}
00087     \}
00088     se->time = time(NULL);
00089     se->duration = duration;
00090     se->id = server.slowlog\_entry\_id++;
00091     se->peerid = sdsnew(getClientPeerId(c));
00092     se->cname = c->name ? sdsnew(c->name->ptr) : sdsempty();
00093     \textcolor{keywordflow}{return} se;
00094 \}
00095 
00096 \textcolor{comment}{/* Free a slow log entry. The argument is void so that the prototype of this}
00097 \textcolor{comment}{ * function matches the one of the 'free' method of adlist.c.}
00098 \textcolor{comment}{ *}
00099 \textcolor{comment}{ * This function will take care to release all the retained object. */}
00100 \textcolor{keywordtype}{void} slowlogFreeEntry(\textcolor{keywordtype}{void} *septr) \{
00101     slowlogEntry *se = septr;
00102     \textcolor{keywordtype}{int} j;
00103 
00104     \textcolor{keywordflow}{for} (j = 0; j < se->argc; j++)
00105         decrRefCount(se->argv[j]);
00106     zfree(se->argv);
00107     sdsfree(se->peerid);
00108     sdsfree(se->cname);
00109     zfree(se);
00110 \}
00111 
00112 \textcolor{comment}{/* Initialize the slow log. This function should be called a single time}
00113 \textcolor{comment}{ * at server startup. */}
00114 \textcolor{keywordtype}{void} slowlogInit(\textcolor{keywordtype}{void}) \{
00115     server.slowlog = listCreate();
00116     server.slowlog\_entry\_id = 0;
00117     \hyperlink{adlist_8h_a648e4a2d20decff3182a72a608b0b8f2}{listSetFreeMethod}(server.slowlog,slowlogFreeEntry);
00118 \}
00119 
00120 \textcolor{comment}{/* Push a new entry into the slow log.}
00121 \textcolor{comment}{ * This function will make sure to trim the slow log accordingly to the}
00122 \textcolor{comment}{ * configured max length. */}
00123 \textcolor{keywordtype}{void} slowlogPushEntryIfNeeded(\hyperlink{structclient}{client} *c, robj **argv, \textcolor{keywordtype}{int} argc, \textcolor{keywordtype}{long} \textcolor{keywordtype}{long} duration) \{
00124     \textcolor{keywordflow}{if} (server.slowlog\_log\_slower\_than < 0) \textcolor{keywordflow}{return}; \textcolor{comment}{/* Slowlog disabled */}
00125     \textcolor{keywordflow}{if} (duration >= server.slowlog\_log\_slower\_than)
00126         listAddNodeHead(server.slowlog,
00127                         slowlogCreateEntry(c,argv,argc,duration));
00128 
00129     \textcolor{comment}{/* Remove old entries if needed. */}
00130     \textcolor{keywordflow}{while} (\hyperlink{adlist_8h_afde0ab079f934670e82119b43120e94b}{listLength}(server.slowlog) > server.slowlog\_max\_len)
00131         listDelNode(server.slowlog,\hyperlink{adlist_8h_a5e0fad60032ef0fe9adcf9811e2f2fba}{listLast}(server.slowlog));
00132 \}
00133 
00134 \textcolor{comment}{/* Remove all the entries from the current slow log. */}
00135 \textcolor{keywordtype}{void} slowlogReset(\textcolor{keywordtype}{void}) \{
00136     \textcolor{keywordflow}{while} (\hyperlink{adlist_8h_afde0ab079f934670e82119b43120e94b}{listLength}(server.slowlog) > 0)
00137         listDelNode(server.slowlog,\hyperlink{adlist_8h_a5e0fad60032ef0fe9adcf9811e2f2fba}{listLast}(server.slowlog));
00138 \}
00139 
00140 \textcolor{comment}{/* The SLOWLOG command. Implements all the subcommands needed to handle the}
00141 \textcolor{comment}{ * Redis slow log. */}
00142 \textcolor{keywordtype}{void} slowlogCommand(\hyperlink{structclient}{client} *c) \{
00143     \textcolor{keywordflow}{if} (c->argc == 2 && !strcasecmp(c->argv[1]->ptr,\textcolor{stringliteral}{"help"})) \{
00144         \textcolor{keyword}{const} \textcolor{keywordtype}{char} *help[] = \{
00145 \textcolor{stringliteral}{"get [count] -- Return top entries from the slowlog (default: 10)."}
00146 \textcolor{stringliteral}{"    Entries are made of:"},
00147 \textcolor{stringliteral}{"    id, timestamp, time in microseconds, arguments array, client IP and port, client name"},
00148 \textcolor{stringliteral}{"len -- Return the length of the slowlog."},
00149 \textcolor{stringliteral}{"reset -- Reset the slowlog."},
00150 NULL
00151         \};
00152         addReplyHelp(c, help);
00153     \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (c->argc == 2 && !strcasecmp(c->argv[1]->ptr,\textcolor{stringliteral}{"reset"})) \{
00154         slowlogReset();
00155         addReply(c,shared.ok);
00156     \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (c->argc == 2 && !strcasecmp(c->argv[1]->ptr,\textcolor{stringliteral}{"len"})) \{
00157         addReplyLongLong(c,\hyperlink{adlist_8h_afde0ab079f934670e82119b43120e94b}{listLength}(server.slowlog));
00158     \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} ((c->argc == 2 || c->argc == 3) &&
00159                !strcasecmp(c->argv[1]->ptr,\textcolor{stringliteral}{"get"}))
00160     \{
00161         \textcolor{keywordtype}{long} count = 10, sent = 0;
00162         listIter li;
00163         \textcolor{keywordtype}{void} *totentries;
00164         listNode *ln;
00165         slowlogEntry *se;
00166 
00167         \textcolor{keywordflow}{if} (c->argc == 3 &&
00168             getLongFromObjectOrReply(c,c->argv[2],&count,NULL) != \hyperlink{server_8h_a303769ef1065076e68731584e758d3e1}{C\_OK})
00169             \textcolor{keywordflow}{return};
00170 
00171         listRewind(server.slowlog,&li);
00172         totentries = addDeferredMultiBulkLength(c);
00173         \textcolor{keywordflow}{while}(count-- && (ln = listNext(&li))) \{
00174             \textcolor{keywordtype}{int} j;
00175 
00176             se = ln->value;
00177             addReplyMultiBulkLen(c,6);
00178             addReplyLongLong(c,se->id);
00179             addReplyLongLong(c,se->time);
00180             addReplyLongLong(c,se->duration);
00181             addReplyMultiBulkLen(c,se->argc);
00182             \textcolor{keywordflow}{for} (j = 0; j < se->argc; j++)
00183                 addReplyBulk(c,se->argv[j]);
00184             addReplyBulkCBuffer(c,se->peerid,sdslen(se->peerid));
00185             addReplyBulkCBuffer(c,se->cname,sdslen(se->cname));
00186             sent++;
00187         \}
00188         setDeferredMultiBulkLength(c,totentries,sent);
00189     \} \textcolor{keywordflow}{else} \{
00190          addReplyErrorFormat(c, \textcolor{stringliteral}{"Unknown subcommand or wrong number of arguments for '%s'. Try SLOWLOG
       HELP"}, (\textcolor{keywordtype}{char}*)c->argv[1]->ptr);
00191     \}
00192 \}
\end{DoxyCode}
