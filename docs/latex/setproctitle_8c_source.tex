\hypertarget{setproctitle_8c_source}{}\section{setproctitle.\+c}
\label{setproctitle_8c_source}\index{src/setproctitle.\+c@{src/setproctitle.\+c}}

\begin{DoxyCode}
00001 \textcolor{comment}{/* ==========================================================================}
00002 \textcolor{comment}{ * setproctitle.c - Linux/Darwin setproctitle.}
00003 \textcolor{comment}{ * --------------------------------------------------------------------------}
00004 \textcolor{comment}{ * Copyright (C) 2010  William Ahern}
00005 \textcolor{comment}{ * Copyright (C) 2013  Salvatore Sanfilippo}
00006 \textcolor{comment}{ * Copyright (C) 2013  Stam He}
00007 \textcolor{comment}{ *}
00008 \textcolor{comment}{ * Permission is hereby granted, free of charge, to any person obtaining a}
00009 \textcolor{comment}{ * copy of this software and associated documentation files (the}
00010 \textcolor{comment}{ * "Software"), to deal in the Software without restriction, including}
00011 \textcolor{comment}{ * without limitation the rights to use, copy, modify, merge, publish,}
00012 \textcolor{comment}{ * distribute, sublicense, and/or sell copies of the Software, and to permit}
00013 \textcolor{comment}{ * persons to whom the Software is furnished to do so, subject to the}
00014 \textcolor{comment}{ * following conditions:}
00015 \textcolor{comment}{ *}
00016 \textcolor{comment}{ * The above copyright notice and this permission notice shall be included}
00017 \textcolor{comment}{ * in all copies or substantial portions of the Software.}
00018 \textcolor{comment}{ *}
00019 \textcolor{comment}{ * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS}
00020 \textcolor{comment}{ * OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF}
00021 \textcolor{comment}{ * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN}
00022 \textcolor{comment}{ * NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,}
00023 \textcolor{comment}{ * DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR}
00024 \textcolor{comment}{ * OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE}
00025 \textcolor{comment}{ * USE OR OTHER DEALINGS IN THE SOFTWARE.}
00026 \textcolor{comment}{ * ==========================================================================}
00027 \textcolor{comment}{ */}
00028 \textcolor{preprocessor}{#}\textcolor{preprocessor}{ifndef} \hyperlink{setproctitle_8c_a369266c24eacffb87046522897a570d5}{\_GNU\_SOURCE}
00029 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{\_GNU\_SOURCE}
00030 \textcolor{preprocessor}{#}\textcolor{preprocessor}{endif}
00031 
00032 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{stddef}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>} \textcolor{comment}{/* NULL size\_t */}
00033 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{stdarg}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>} \textcolor{comment}{/* va\_list va\_start va\_end */}
00034 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{stdlib}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>} \textcolor{comment}{/* malloc(3) setenv(3) clearenv(3) setproctitle(3) getprogname(3) */}
00035 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{stdio}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}  \textcolor{comment}{/* vsnprintf(3) snprintf(3) */}
00036 
00037 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{string}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>} \textcolor{comment}{/* strlen(3) strchr(3) strdup(3) memset(3) memcpy(3) */}
00038 
00039 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{errno}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}  \textcolor{comment}{/* errno program\_invocation\_name program\_invocation\_short\_name */}
00040 
00041 \textcolor{preprocessor}{#}\textcolor{preprocessor}{if} \textcolor{preprocessor}{!}\textcolor{preprocessor}{defined}\textcolor{preprocessor}{(}\textcolor{preprocessor}{HAVE\_SETPROCTITLE}\textcolor{preprocessor}{)}
00042 \textcolor{preprocessor}{#}\textcolor{preprocessor}{if} \textcolor{preprocessor}{(}\textcolor{preprocessor}{defined} \textcolor{preprocessor}{\_\_NetBSD\_\_} \textcolor{preprocessor}{||} \textcolor{preprocessor}{defined} \textcolor{preprocessor}{\_\_FreeBSD\_\_} \textcolor{preprocessor}{||} \textcolor{preprocessor}{defined} \textcolor{preprocessor}{\_\_OpenBSD\_\_}\textcolor{preprocessor}{)}
00043 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{HAVE\_SETPROCTITLE} 1
00044 \textcolor{preprocessor}{#}\textcolor{preprocessor}{else}
00045 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{HAVE\_SETPROCTITLE} 0
00046 \textcolor{preprocessor}{#}\textcolor{preprocessor}{endif}
00047 \textcolor{preprocessor}{#}\textcolor{preprocessor}{endif}
00048 
00049 
00050 \textcolor{preprocessor}{#}\textcolor{preprocessor}{if} \textcolor{preprocessor}{!}\hyperlink{setproctitle_8c_a6ebfd77a271188adf38748322fdbfe29}{HAVE\_SETPROCTITLE}
00051 \textcolor{preprocessor}{#}\textcolor{preprocessor}{if} \textcolor{preprocessor}{(}\textcolor{preprocessor}{defined} \_\_linux \textcolor{preprocessor}{||} \textcolor{preprocessor}{defined} \textcolor{preprocessor}{\_\_APPLE\_\_}\textcolor{preprocessor}{)}
00052 
00053 \textcolor{keyword}{extern} \textcolor{keywordtype}{char} **environ;
00054 
00055 \textcolor{keyword}{static} \textcolor{keyword}{struct} \{
00056     \textcolor{comment}{/* original value */}
00057     \textcolor{keyword}{const} \textcolor{keywordtype}{char} *arg0;
00058 
00059     \textcolor{comment}{/* title space available */}
00060     \textcolor{keywordtype}{char} *base, *end;
00061 
00062      \textcolor{comment}{/* pointer to original nul character within base */}
00063     \textcolor{keywordtype}{char} *nul;
00064 
00065     \_Bool reset;
00066     \textcolor{keywordtype}{int} error;
00067 \} SPT;
00068 
00069 
00070 \textcolor{preprocessor}{#}\textcolor{preprocessor}{ifndef} \textcolor{preprocessor}{SPT\_MIN}
00071 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{SPT\_MIN}\textcolor{preprocessor}{(}\textcolor{preprocessor}{a}\textcolor{preprocessor}{,} \textcolor{preprocessor}{b}\textcolor{preprocessor}{)} \textcolor{preprocessor}{(}\textcolor{preprocessor}{(}\textcolor{preprocessor}{(}\textcolor{preprocessor}{a}\textcolor{preprocessor}{)} \textcolor{preprocessor}{<} \textcolor{preprocessor}{(}\textcolor{preprocessor}{b}\textcolor{preprocessor}{)}\textcolor{preprocessor}{)}\textcolor{preprocessor}{?} \textcolor{preprocessor}{(}\textcolor{preprocessor}{a}\textcolor{preprocessor}{)} \textcolor{preprocessor}{:} \textcolor{preprocessor}{(}\textcolor{preprocessor}{b}\textcolor{preprocessor}{)}\textcolor{preprocessor}{)}
00072 \textcolor{preprocessor}{#}\textcolor{preprocessor}{endif}
00073 
00074 \textcolor{keyword}{static} \textcolor{keyword}{inline} size\_t spt\_min(size\_t a, size\_t b) \{
00075     \textcolor{keywordflow}{return} SPT\_MIN(a, b);
00076 \} \textcolor{comment}{/* spt\_min() */}
00077 
00078 
00079 \textcolor{comment}{/*}
00080 \textcolor{comment}{ * For discussion on the portability of the various methods, see}
00081 \textcolor{comment}{ * http://lists.freebsd.org/pipermail/freebsd-stable/2008-June/043136.html}
00082 \textcolor{comment}{ */}
00083 \textcolor{keyword}{static} \textcolor{keywordtype}{int} spt\_clearenv(\textcolor{keywordtype}{void}) \{
00084 \textcolor{preprocessor}{#}\textcolor{preprocessor}{if} \_\_GLIBC\_\_
00085     clearenv();
00086 
00087     \textcolor{keywordflow}{return} 0;
00088 \textcolor{preprocessor}{#}\textcolor{preprocessor}{else}
00089     \textcolor{keyword}{extern} \textcolor{keywordtype}{char} **environ;
00090     \textcolor{keyword}{static} \textcolor{keywordtype}{char} **tmp;
00091 
00092     \textcolor{keywordflow}{if} (!(tmp = malloc(\textcolor{keyword}{sizeof} *tmp)))
00093         \textcolor{keywordflow}{return} errno;
00094 
00095     tmp[0]  = NULL;
00096     environ = tmp;
00097 
00098     \textcolor{keywordflow}{return} 0;
00099 \textcolor{preprocessor}{#}\textcolor{preprocessor}{endif}
00100 \} \textcolor{comment}{/* spt\_clearenv() */}
00101 
00102 
00103 \textcolor{keyword}{static} \textcolor{keywordtype}{int} spt\_copyenv(\textcolor{keywordtype}{char} *oldenv[]) \{
00104     \textcolor{keyword}{extern} \textcolor{keywordtype}{char} **environ;
00105     \textcolor{keywordtype}{char} *eq;
00106     \textcolor{keywordtype}{int} i, error;
00107 
00108     \textcolor{keywordflow}{if} (environ != oldenv)
00109         \textcolor{keywordflow}{return} 0;
00110 
00111     \textcolor{keywordflow}{if} ((error = spt\_clearenv()))
00112         \textcolor{keywordflow}{goto} error;
00113 
00114     \textcolor{keywordflow}{for} (i = 0; oldenv[i]; i++) \{
00115         \textcolor{keywordflow}{if} (!(eq = strchr(oldenv[i], \textcolor{stringliteral}{'='})))
00116             \textcolor{keywordflow}{continue};
00117 
00118         *eq = \textcolor{stringliteral}{'\(\backslash\)0'};
00119         error = (0 != setenv(oldenv[i], eq + 1, 1))? errno : 0;
00120         *eq = \textcolor{stringliteral}{'='};
00121 
00122         \textcolor{keywordflow}{if} (error)
00123             \textcolor{keywordflow}{goto} error;
00124     \}
00125 
00126     \textcolor{keywordflow}{return} 0;
00127 error:
00128     environ = oldenv;
00129 
00130     \textcolor{keywordflow}{return} error;
00131 \} \textcolor{comment}{/* spt\_copyenv() */}
00132 
00133 
00134 \textcolor{keyword}{static} \textcolor{keywordtype}{int} spt\_copyargs(\textcolor{keywordtype}{int} argc, \textcolor{keywordtype}{char} *argv[]) \{
00135     \textcolor{keywordtype}{char} *tmp;
00136     \textcolor{keywordtype}{int} i;
00137 
00138     \textcolor{keywordflow}{for} (i = 1; i < argc || (i >= argc && argv[i]); i++) \{
00139         \textcolor{keywordflow}{if} (!argv[i])
00140             \textcolor{keywordflow}{continue};
00141 
00142         \textcolor{keywordflow}{if} (!(tmp = strdup(argv[i])))
00143             \textcolor{keywordflow}{return} errno;
00144 
00145         argv[i] = tmp;
00146     \}
00147 
00148     \textcolor{keywordflow}{return} 0;
00149 \} \textcolor{comment}{/* spt\_copyargs() */}
00150 
00151 
00152 \textcolor{keywordtype}{void} spt\_init(\textcolor{keywordtype}{int} argc, \textcolor{keywordtype}{char} *argv[]) \{
00153         \textcolor{keywordtype}{char} **envp = environ;
00154     \textcolor{keywordtype}{char} *base, *end, *nul, *tmp;
00155     \textcolor{keywordtype}{int} i, error;
00156 
00157     \textcolor{keywordflow}{if} (!(base = argv[0]))
00158         \textcolor{keywordflow}{return};
00159 
00160     nul = &base[strlen(base)];
00161     end = nul + 1;
00162 
00163     \textcolor{keywordflow}{for} (i = 0; i < argc || (i >= argc && argv[i]); i++) \{
00164         \textcolor{keywordflow}{if} (!argv[i] || argv[i] < end)
00165             \textcolor{keywordflow}{continue};
00166 
00167         end = argv[i] + strlen(argv[i]) + 1;
00168     \}
00169 
00170     \textcolor{keywordflow}{for} (i = 0; envp[i]; i++) \{
00171         \textcolor{keywordflow}{if} (envp[i] < end)
00172             \textcolor{keywordflow}{continue};
00173 
00174         end = envp[i] + strlen(envp[i]) + 1;
00175     \}
00176 
00177     \textcolor{keywordflow}{if} (!(SPT.arg0 = strdup(argv[0])))
00178         \textcolor{keywordflow}{goto} syerr;
00179 
00180 \textcolor{preprocessor}{#}\textcolor{preprocessor}{if} \_\_GLIBC\_\_
00181     \textcolor{keywordflow}{if} (!(tmp = strdup(program\_invocation\_name)))
00182         \textcolor{keywordflow}{goto} syerr;
00183 
00184     program\_invocation\_name = tmp;
00185 
00186     \textcolor{keywordflow}{if} (!(tmp = strdup(program\_invocation\_short\_name)))
00187         \textcolor{keywordflow}{goto} syerr;
00188 
00189     program\_invocation\_short\_name = tmp;
00190 \textcolor{preprocessor}{#}\textcolor{preprocessor}{elif} \textcolor{preprocessor}{\_\_APPLE\_\_}
00191     \textcolor{keywordflow}{if} (!(tmp = strdup(getprogname())))
00192         \textcolor{keywordflow}{goto} syerr;
00193 
00194     setprogname(tmp);
00195 \textcolor{preprocessor}{#}\textcolor{preprocessor}{endif}
00196 
00197 
00198     \textcolor{keywordflow}{if} ((error = spt\_copyenv(envp)))
00199         \textcolor{keywordflow}{goto} error;
00200 
00201     \textcolor{keywordflow}{if} ((error = spt\_copyargs(argc, argv)))
00202         \textcolor{keywordflow}{goto} error;
00203 
00204     SPT.nul  = nul;
00205     SPT.base = base;
00206     SPT.end  = end;
00207 
00208     \textcolor{keywordflow}{return};
00209 syerr:
00210     error = errno;
00211 error:
00212     SPT.error = error;
00213 \} \textcolor{comment}{/* spt\_init() */}
00214 
00215 
00216 \textcolor{preprocessor}{#}\textcolor{preprocessor}{ifndef} \textcolor{preprocessor}{SPT\_MAXTITLE}
00217 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{SPT\_MAXTITLE} 255
00218 \textcolor{preprocessor}{#}\textcolor{preprocessor}{endif}
00219 
00220 \textcolor{keywordtype}{void} setproctitle(\textcolor{keyword}{const} \textcolor{keywordtype}{char} *fmt, ...) \{
00221     \textcolor{keywordtype}{char} buf[SPT\_MAXTITLE + 1]; \textcolor{comment}{/* use buffer in case argv[0] is passed */}
00222     va\_list ap;
00223     \textcolor{keywordtype}{char} *nul;
00224     \textcolor{keywordtype}{int} len, error;
00225 
00226     \textcolor{keywordflow}{if} (!SPT.base)
00227         \textcolor{keywordflow}{return};
00228 
00229     \textcolor{keywordflow}{if} (fmt) \{
00230         va\_start(ap, fmt);
00231         len = vsnprintf(buf, \textcolor{keyword}{sizeof} buf, fmt, ap);
00232         va\_end(ap);
00233     \} \textcolor{keywordflow}{else} \{
00234         len = snprintf(buf, \textcolor{keyword}{sizeof} buf, \textcolor{stringliteral}{"%s"}, SPT.arg0);
00235     \}
00236 
00237     \textcolor{keywordflow}{if} (len <= 0)
00238         \{ error = errno; \textcolor{keywordflow}{goto} error; \}
00239 
00240     \textcolor{keywordflow}{if} (!SPT.reset) \{
00241         memset(SPT.base, 0, SPT.end - SPT.base);
00242         SPT.reset = 1;
00243     \} \textcolor{keywordflow}{else} \{
00244         memset(SPT.base, 0, spt\_min(\textcolor{keyword}{sizeof} buf, SPT.end - SPT.base));
00245     \}
00246 
00247     len = spt\_min(len, spt\_min(\textcolor{keyword}{sizeof} buf, SPT.end - SPT.base) - 1);
00248     memcpy(SPT.base, buf, len);
00249     nul = &SPT.base[len];
00250 
00251     \textcolor{keywordflow}{if} (nul < SPT.nul) \{
00252         *SPT.nul = \textcolor{stringliteral}{'.'};
00253     \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (nul == SPT.nul && &nul[1] < SPT.end) \{
00254         *SPT.nul = \textcolor{stringliteral}{' '};
00255         *++nul = \textcolor{stringliteral}{'\(\backslash\)0'};
00256     \}
00257 
00258     \textcolor{keywordflow}{return};
00259 error:
00260     SPT.error = error;
00261 \} \textcolor{comment}{/* setproctitle() */}
00262 
00263 
00264 \textcolor{preprocessor}{#}\textcolor{preprocessor}{endif} \textcolor{comment}{/* \_\_linux || \_\_APPLE\_\_ */}
00265 \textcolor{preprocessor}{#}\textcolor{preprocessor}{endif} \textcolor{comment}{/* !HAVE\_SETPROCTITLE */}
\end{DoxyCode}
