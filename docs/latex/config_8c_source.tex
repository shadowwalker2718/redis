\hypertarget{config_8c_source}{}\section{config.\+c}
\label{config_8c_source}\index{src/config.\+c@{src/config.\+c}}

\begin{DoxyCode}
00001 \textcolor{comment}{/* Configuration file parsing and CONFIG GET/SET commands implementation.}
00002 \textcolor{comment}{ *}
00003 \textcolor{comment}{ * Copyright (c) 2009-2012, Salvatore Sanfilippo <antirez at gmail dot com>}
00004 \textcolor{comment}{ * All rights reserved.}
00005 \textcolor{comment}{ *}
00006 \textcolor{comment}{ * Redistribution and use in source and binary forms, with or without}
00007 \textcolor{comment}{ * modification, are permitted provided that the following conditions are met:}
00008 \textcolor{comment}{ *}
00009 \textcolor{comment}{ *   * Redistributions of source code must retain the above copyright notice,}
00010 \textcolor{comment}{ *     this list of conditions and the following disclaimer.}
00011 \textcolor{comment}{ *   * Redistributions in binary form must reproduce the above copyright}
00012 \textcolor{comment}{ *     notice, this list of conditions and the following disclaimer in the}
00013 \textcolor{comment}{ *     documentation and/or other materials provided with the distribution.}
00014 \textcolor{comment}{ *   * Neither the name of Redis nor the names of its contributors may be used}
00015 \textcolor{comment}{ *     to endorse or promote products derived from this software without}
00016 \textcolor{comment}{ *     specific prior written permission.}
00017 \textcolor{comment}{ *}
00018 \textcolor{comment}{ * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"}
00019 \textcolor{comment}{ * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE}
00020 \textcolor{comment}{ * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE}
00021 \textcolor{comment}{ * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE}
00022 \textcolor{comment}{ * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR}
00023 \textcolor{comment}{ * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF}
00024 \textcolor{comment}{ * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS}
00025 \textcolor{comment}{ * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN}
00026 \textcolor{comment}{ * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)}
00027 \textcolor{comment}{ * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE}
00028 \textcolor{comment}{ * POSSIBILITY OF SUCH DAMAGE.}
00029 \textcolor{comment}{ */}
00030 
00031 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \hyperlink{server_8h}{"server.h"}
00032 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \hyperlink{cluster_8h}{"cluster.h"}
00033 
00034 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{fcntl}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00035 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{sys}\textcolor{preprocessor}{/}\textcolor{preprocessor}{stat}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00036 
00037 \textcolor{comment}{/*-----------------------------------------------------------------------------}
00038 \textcolor{comment}{ * Config file name-value maps.}
00039 \textcolor{comment}{ *----------------------------------------------------------------------------*/}
00040 
\Hypertarget{config_8c_source_l00041}\hyperlink{structconfigEnum}{00041} \textcolor{keyword}{typedef} \textcolor{keyword}{struct} \hyperlink{structconfigEnum}{configEnum} \{
00042     \textcolor{keyword}{const} \textcolor{keywordtype}{char} *name;
00043     \textcolor{keyword}{const} \textcolor{keywordtype}{int} val;
00044 \} configEnum;
00045 
00046 configEnum maxmemory\_policy\_enum[] = \{
00047     \{\textcolor{stringliteral}{"volatile-lru"}, \hyperlink{server_8h_a21d27e73cad2234340c026f1fa58c4f9}{MAXMEMORY\_VOLATILE\_LRU}\},
00048     \{\textcolor{stringliteral}{"volatile-lfu"}, \hyperlink{server_8h_ac909ffc67308cb846c08431aa91aa513}{MAXMEMORY\_VOLATILE\_LFU}\},
00049     \{\textcolor{stringliteral}{"volatile-random"},\hyperlink{server_8h_a87a1f8341c97c33069827b359302a1c4}{MAXMEMORY\_VOLATILE\_RANDOM}\},
00050     \{\textcolor{stringliteral}{"volatile-ttl"},\hyperlink{server_8h_a463db85c87bf7ecf91e3f9d182397969}{MAXMEMORY\_VOLATILE\_TTL}\},
00051     \{\textcolor{stringliteral}{"allkeys-lru"},\hyperlink{server_8h_af15f1d0b6d6330f44d42f34ba2faf2d9}{MAXMEMORY\_ALLKEYS\_LRU}\},
00052     \{\textcolor{stringliteral}{"allkeys-lfu"},\hyperlink{server_8h_ac92818fe68a9928917cfa26d5c816f06}{MAXMEMORY\_ALLKEYS\_LFU}\},
00053     \{\textcolor{stringliteral}{"allkeys-random"},\hyperlink{server_8h_adcde0cca14eeb32039c92a26c4672961}{MAXMEMORY\_ALLKEYS\_RANDOM}\},
00054     \{\textcolor{stringliteral}{"noeviction"},\hyperlink{server_8h_a418e5a222cf659c003df77830f1ae343}{MAXMEMORY\_NO\_EVICTION}\},
00055     \{NULL, 0\}
00056 \};
00057 
00058 configEnum syslog\_facility\_enum[] = \{
00059     \{\textcolor{stringliteral}{"user"},    LOG\_USER\},
00060     \{\textcolor{stringliteral}{"local0"},  LOG\_LOCAL0\},
00061     \{\textcolor{stringliteral}{"local1"},  LOG\_LOCAL1\},
00062     \{\textcolor{stringliteral}{"local2"},  LOG\_LOCAL2\},
00063     \{\textcolor{stringliteral}{"local3"},  LOG\_LOCAL3\},
00064     \{\textcolor{stringliteral}{"local4"},  LOG\_LOCAL4\},
00065     \{\textcolor{stringliteral}{"local5"},  LOG\_LOCAL5\},
00066     \{\textcolor{stringliteral}{"local6"},  LOG\_LOCAL6\},
00067     \{\textcolor{stringliteral}{"local7"},  LOG\_LOCAL7\},
00068     \{NULL, 0\}
00069 \};
00070 
00071 configEnum loglevel\_enum[] = \{
00072     \{\textcolor{stringliteral}{"debug"}, \hyperlink{server_8h_abcaffe365dee628fcf9fc90c69d534a1}{LL\_DEBUG}\},
00073     \{\textcolor{stringliteral}{"verbose"}, \hyperlink{server_8h_a479b60032f8da6d8ad72e1a9d0809950}{LL\_VERBOSE}\},
00074     \{\textcolor{stringliteral}{"notice"}, \hyperlink{server_8h_a8c54c191e436c7dd3012167212692401}{LL\_NOTICE}\},
00075     \{\textcolor{stringliteral}{"warning"}, \hyperlink{server_8h_a31229b9334bba7d6be2a72970967a14b}{LL\_WARNING}\},
00076     \{NULL,0\}
00077 \};
00078 
00079 configEnum supervised\_mode\_enum[] = \{
00080     \{\textcolor{stringliteral}{"upstart"}, \hyperlink{server_8h_ae34bdafb8c6d3cc58fc6b319e623b604}{SUPERVISED\_UPSTART}\},
00081     \{\textcolor{stringliteral}{"systemd"}, \hyperlink{server_8h_aea7b4966d78f67f5ab89f38f0e1bde74}{SUPERVISED\_SYSTEMD}\},
00082     \{\textcolor{stringliteral}{"auto"}, \hyperlink{server_8h_a7b2b1d1fd04a4f2c1a141e0976dd479b}{SUPERVISED\_AUTODETECT}\},
00083     \{\textcolor{stringliteral}{"no"}, \hyperlink{server_8h_a2a0d6ba64b419357e52a6473f48bc882}{SUPERVISED\_NONE}\},
00084     \{NULL, 0\}
00085 \};
00086 
00087 configEnum aof\_fsync\_enum[] = \{
00088     \{\textcolor{stringliteral}{"everysec"}, \hyperlink{server_8h_a9784233b87ec796d0343556106fb778e}{AOF\_FSYNC\_EVERYSEC}\},
00089     \{\textcolor{stringliteral}{"always"}, \hyperlink{server_8h_a83bfec10b7b4be60ec6d5868cadc73bb}{AOF\_FSYNC\_ALWAYS}\},
00090     \{\textcolor{stringliteral}{"no"}, \hyperlink{server_8h_ae5ee4e99d817a4921da225edcd36a8a9}{AOF\_FSYNC\_NO}\},
00091     \{NULL, 0\}
00092 \};
00093 
00094 \textcolor{comment}{/* Output buffer limits presets. */}
00095 clientBufferLimitsConfig clientBufferLimitsDefaults[\hyperlink{server_8h_aea8f6f3fac3a68e35807eba109dbc501}{CLIENT\_TYPE\_OBUF\_COUNT}] = \{
00096     \{0, 0, 0\}, \textcolor{comment}{/* normal */}
00097     \{1024*1024*256, 1024*1024*64, 60\}, \textcolor{comment}{/* slave */}
00098     \{1024*1024*32, 1024*1024*8, 60\}  \textcolor{comment}{/* pubsub */}
00099 \};
00100 
00101 \textcolor{comment}{/*-----------------------------------------------------------------------------}
00102 \textcolor{comment}{ * Enum access functions}
00103 \textcolor{comment}{ *----------------------------------------------------------------------------*/}
00104 
00105 \textcolor{comment}{/* Get enum value from name. If there is no match INT\_MIN is returned. */}
00106 \textcolor{keywordtype}{int} configEnumGetValue(configEnum *ce, \textcolor{keywordtype}{char} *name) \{
00107     \textcolor{keywordflow}{while}(ce->name != NULL) \{
00108         \textcolor{keywordflow}{if} (!strcasecmp(ce->name,name)) \textcolor{keywordflow}{return} ce->val;
00109         ce++;
00110     \}
00111     \textcolor{keywordflow}{return} INT\_MIN;
00112 \}
00113 
00114 \textcolor{comment}{/* Get enum name from value. If no match is found NULL is returned. */}
00115 \textcolor{keyword}{const} \textcolor{keywordtype}{char} *configEnumGetName(configEnum *ce, \textcolor{keywordtype}{int} val) \{
00116     \textcolor{keywordflow}{while}(ce->name != NULL) \{
00117         \textcolor{keywordflow}{if} (ce->val == val) \textcolor{keywordflow}{return} ce->name;
00118         ce++;
00119     \}
00120     \textcolor{keywordflow}{return} NULL;
00121 \}
00122 
00123 \textcolor{comment}{/* Wrapper for configEnumGetName() returning "unknown" insetad of NULL if}
00124 \textcolor{comment}{ * there is no match. */}
00125 \textcolor{keyword}{const} \textcolor{keywordtype}{char} *configEnumGetNameOrUnknown(configEnum *ce, \textcolor{keywordtype}{int} val) \{
00126     \textcolor{keyword}{const} \textcolor{keywordtype}{char} *name = configEnumGetName(ce,val);
00127     \textcolor{keywordflow}{return} name ? name : \textcolor{stringliteral}{"unknown"};
00128 \}
00129 
00130 \textcolor{comment}{/* Used for INFO generation. */}
00131 \textcolor{keyword}{const} \textcolor{keywordtype}{char} *evictPolicyToString(\textcolor{keywordtype}{void}) \{
00132     \textcolor{keywordflow}{return} configEnumGetNameOrUnknown(maxmemory\_policy\_enum,server.maxmemory\_policy);
00133 \}
00134 
00135 \textcolor{comment}{/*-----------------------------------------------------------------------------}
00136 \textcolor{comment}{ * Config file parsing}
00137 \textcolor{comment}{ *----------------------------------------------------------------------------*/}
00138 
00139 \textcolor{keywordtype}{int} yesnotoi(\textcolor{keywordtype}{char} *s) \{
00140     \textcolor{keywordflow}{if} (!strcasecmp(s,\textcolor{stringliteral}{"yes"})) \textcolor{keywordflow}{return} 1;
00141     \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(s,\textcolor{stringliteral}{"no"})) \textcolor{keywordflow}{return} 0;
00142     \textcolor{keywordflow}{else} \textcolor{keywordflow}{return} -1;
00143 \}
00144 
00145 \textcolor{keywordtype}{void} appendServerSaveParams(time\_t seconds, \textcolor{keywordtype}{int} changes) \{
00146     server.saveparams = zrealloc(server.saveparams,\textcolor{keyword}{sizeof}(\textcolor{keyword}{struct} saveparam)*(server.saveparamslen+1));
00147     server.saveparams[server.saveparamslen].seconds = seconds;
00148     server.saveparams[server.saveparamslen].changes = changes;
00149     server.saveparamslen++;
00150 \}
00151 
00152 \textcolor{keywordtype}{void} resetServerSaveParams(\textcolor{keywordtype}{void}) \{
00153     zfree(server.saveparams);
00154     server.saveparams = NULL;
00155     server.saveparamslen = 0;
00156 \}
00157 
00158 \textcolor{keywordtype}{void} queueLoadModule(sds path, sds *argv, \textcolor{keywordtype}{int} argc) \{
00159     \textcolor{keywordtype}{int} i;
00160     \textcolor{keyword}{struct} \hyperlink{structmoduleLoadQueueEntry}{moduleLoadQueueEntry} *loadmod;
00161 
00162     loadmod = zmalloc(\textcolor{keyword}{sizeof}(\textcolor{keyword}{struct} moduleLoadQueueEntry));
00163     loadmod->argv = zmalloc(\textcolor{keyword}{sizeof}(robj*)*argc);
00164     loadmod->path = sdsnew(path);
00165     loadmod->argc = argc;
00166     \textcolor{keywordflow}{for} (i = 0; i < argc; i++) \{
00167         loadmod->argv[i] = createRawStringObject(argv[i],sdslen(argv[i]));
00168     \}
00169     listAddNodeTail(server.loadmodule\_queue,loadmod);
00170 \}
00171 
00172 \textcolor{keywordtype}{void} loadServerConfigFromString(\textcolor{keywordtype}{char} *config) \{
00173     \textcolor{keywordtype}{char} *err = NULL;
00174     \textcolor{keywordtype}{int} linenum = 0, totlines, i;
00175     \textcolor{keywordtype}{int} slaveof\_linenum = 0;
00176     sds *lines;
00177 
00178     lines = sdssplitlen(config,strlen(config),\textcolor{stringliteral}{"\(\backslash\)n"},1,&totlines);
00179 
00180     \textcolor{keywordflow}{for} (i = 0; i < totlines; i++) \{
00181         sds *argv;
00182         \textcolor{keywordtype}{int} argc;
00183 
00184         linenum = i+1;
00185         lines[i] = sdstrim(lines[i],\textcolor{stringliteral}{" \(\backslash\)t\(\backslash\)r\(\backslash\)n"});
00186 
00187         \textcolor{comment}{/* Skip comments and blank lines */}
00188         \textcolor{keywordflow}{if} (lines[i][0] == \textcolor{stringliteral}{'#'} || lines[i][0] == \textcolor{stringliteral}{'\(\backslash\)0'}) \textcolor{keywordflow}{continue};
00189 
00190         \textcolor{comment}{/* Split into arguments */}
00191         argv = sdssplitargs(lines[i],&argc);
00192         \textcolor{keywordflow}{if} (argv == NULL) \{
00193             err = \textcolor{stringliteral}{"Unbalanced quotes in configuration line"};
00194             \textcolor{keywordflow}{goto} loaderr;
00195         \}
00196 
00197         \textcolor{comment}{/* Skip this line if the resulting command vector is empty. */}
00198         \textcolor{keywordflow}{if} (argc == 0) \{
00199             sdsfreesplitres(argv,argc);
00200             \textcolor{keywordflow}{continue};
00201         \}
00202         sdstolower(argv[0]);
00203 
00204         \textcolor{comment}{/* Execute config directives */}
00205         \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"timeout"}) && argc == 2) \{
00206             server.maxidletime = atoi(argv[1]);
00207             \textcolor{keywordflow}{if} (server.maxidletime < 0) \{
00208                 err = \textcolor{stringliteral}{"Invalid timeout value"}; \textcolor{keywordflow}{goto} loaderr;
00209             \}
00210         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"tcp-keepalive"}) && argc == 2) \{
00211             server.tcpkeepalive = atoi(argv[1]);
00212             \textcolor{keywordflow}{if} (server.tcpkeepalive < 0) \{
00213                 err = \textcolor{stringliteral}{"Invalid tcp-keepalive value"}; \textcolor{keywordflow}{goto} loaderr;
00214             \}
00215         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"protected-mode"}) && argc == 2) \{
00216             \textcolor{keywordflow}{if} ((server.protected\_mode = yesnotoi(argv[1])) == -1) \{
00217                 err = \textcolor{stringliteral}{"argument must be 'yes' or 'no'"}; \textcolor{keywordflow}{goto} loaderr;
00218             \}
00219         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"port"}) && argc == 2) \{
00220             server.port = atoi(argv[1]);
00221             \textcolor{keywordflow}{if} (server.port < 0 || server.port > 65535) \{
00222                 err = \textcolor{stringliteral}{"Invalid port"}; \textcolor{keywordflow}{goto} loaderr;
00223             \}
00224         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"tcp-backlog"}) && argc == 2) \{
00225             server.tcp\_backlog = atoi(argv[1]);
00226             \textcolor{keywordflow}{if} (server.tcp\_backlog < 0) \{
00227                 err = \textcolor{stringliteral}{"Invalid backlog value"}; \textcolor{keywordflow}{goto} loaderr;
00228             \}
00229         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"bind"}) && argc >= 2) \{
00230             \textcolor{keywordtype}{int} j, addresses = argc-1;
00231 
00232             \textcolor{keywordflow}{if} (addresses > \hyperlink{server_8h_a314d02fcabccac3e59ecaa9d34f0d597}{CONFIG\_BINDADDR\_MAX}) \{
00233                 err = \textcolor{stringliteral}{"Too many bind addresses specified"}; \textcolor{keywordflow}{goto} loaderr;
00234             \}
00235             \textcolor{keywordflow}{for} (j = 0; j < addresses; j++)
00236                 server.bindaddr[j] = zstrdup(argv[j+1]);
00237             server.bindaddr\_count = addresses;
00238         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"unixsocket"}) && argc == 2) \{
00239             server.unixsocket = zstrdup(argv[1]);
00240         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"unixsocketperm"}) && argc == 2) \{
00241             errno = 0;
00242             server.unixsocketperm = (mode\_t)strtol(argv[1], NULL, 8);
00243             \textcolor{keywordflow}{if} (errno || server.unixsocketperm > 0777) \{
00244                 err = \textcolor{stringliteral}{"Invalid socket file permissions"}; \textcolor{keywordflow}{goto} loaderr;
00245             \}
00246         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"save"})) \{
00247             \textcolor{keywordflow}{if} (argc == 3) \{
00248                 \textcolor{keywordtype}{int} seconds = atoi(argv[1]);
00249                 \textcolor{keywordtype}{int} changes = atoi(argv[2]);
00250                 \textcolor{keywordflow}{if} (seconds < 1 || changes < 0) \{
00251                     err = \textcolor{stringliteral}{"Invalid save parameters"}; \textcolor{keywordflow}{goto} loaderr;
00252                 \}
00253                 appendServerSaveParams(seconds,changes);
00254             \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (argc == 2 && !strcasecmp(argv[1],\textcolor{stringliteral}{""})) \{
00255                 resetServerSaveParams();
00256             \}
00257         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"dir"}) && argc == 2) \{
00258             \textcolor{keywordflow}{if} (chdir(argv[1]) == -1) \{
00259                 serverLog(\hyperlink{server_8h_a31229b9334bba7d6be2a72970967a14b}{LL\_WARNING},\textcolor{stringliteral}{"Can't chdir to '%s': %s"},
00260                     argv[1], strerror(errno));
00261                 exit(1);
00262             \}
00263         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"loglevel"}) && argc == 2) \{
00264             server.verbosity = configEnumGetValue(loglevel\_enum,argv[1]);
00265             \textcolor{keywordflow}{if} (server.verbosity == INT\_MIN) \{
00266                 err = \textcolor{stringliteral}{"Invalid log level. "}
00267                       \textcolor{stringliteral}{"Must be one of debug, verbose, notice, warning"};
00268                 \textcolor{keywordflow}{goto} loaderr;
00269             \}
00270         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"logfile"}) && argc == 2) \{
00271             FILE *logfp;
00272 
00273             zfree(server.logfile);
00274             server.logfile = zstrdup(argv[1]);
00275             \textcolor{keywordflow}{if} (server.logfile[0] != \textcolor{stringliteral}{'\(\backslash\)0'}) \{
00276                 \textcolor{comment}{/* Test if we are able to open the file. The server will not}
00277 \textcolor{comment}{                 * be able to abort just for this problem later... */}
00278                 logfp = fopen(server.logfile,\textcolor{stringliteral}{"a"});
00279                 \textcolor{keywordflow}{if} (logfp == NULL) \{
00280                     err = sdscatprintf(sdsempty(),
00281                         \textcolor{stringliteral}{"Can't open the log file: %s"}, strerror(errno));
00282                     \textcolor{keywordflow}{goto} loaderr;
00283                 \}
00284                 fclose(logfp);
00285             \}
00286         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"always-show-logo"}) && argc == 2) \{
00287             \textcolor{keywordflow}{if} ((server.always\_show\_logo = yesnotoi(argv[1])) == -1) \{
00288                 err = \textcolor{stringliteral}{"argument must be 'yes' or 'no'"}; \textcolor{keywordflow}{goto} loaderr;
00289             \}
00290         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"syslog-enabled"}) && argc == 2) \{
00291             \textcolor{keywordflow}{if} ((server.syslog\_enabled = yesnotoi(argv[1])) == -1) \{
00292                 err = \textcolor{stringliteral}{"argument must be 'yes' or 'no'"}; \textcolor{keywordflow}{goto} loaderr;
00293             \}
00294         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"syslog-ident"}) && argc == 2) \{
00295             \textcolor{keywordflow}{if} (server.syslog\_ident) zfree(server.syslog\_ident);
00296             server.syslog\_ident = zstrdup(argv[1]);
00297         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"syslog-facility"}) && argc == 2) \{
00298             server.syslog\_facility =
00299                 configEnumGetValue(syslog\_facility\_enum,argv[1]);
00300             \textcolor{keywordflow}{if} (server.syslog\_facility == INT\_MIN) \{
00301                 err = \textcolor{stringliteral}{"Invalid log facility. Must be one of USER or between LOCAL0-LOCAL7"};
00302                 \textcolor{keywordflow}{goto} loaderr;
00303             \}
00304         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"databases"}) && argc == 2) \{
00305             server.dbnum = atoi(argv[1]);
00306             \textcolor{keywordflow}{if} (server.dbnum < 1) \{
00307                 err = \textcolor{stringliteral}{"Invalid number of databases"}; \textcolor{keywordflow}{goto} loaderr;
00308             \}
00309         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"include"}) && argc == 2) \{
00310             loadServerConfig(argv[1],NULL);
00311         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"maxclients"}) && argc == 2) \{
00312             server.maxclients = atoi(argv[1]);
00313             \textcolor{keywordflow}{if} (server.maxclients < 1) \{
00314                 err = \textcolor{stringliteral}{"Invalid max clients limit"}; \textcolor{keywordflow}{goto} loaderr;
00315             \}
00316         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"maxmemory"}) && argc == 2) \{
00317             server.maxmemory = memtoll(argv[1],NULL);
00318         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"maxmemory-policy"}) && argc == 2) \{
00319             server.maxmemory\_policy =
00320                 configEnumGetValue(maxmemory\_policy\_enum,argv[1]);
00321             \textcolor{keywordflow}{if} (server.maxmemory\_policy == INT\_MIN) \{
00322                 err = \textcolor{stringliteral}{"Invalid maxmemory policy"};
00323                 \textcolor{keywordflow}{goto} loaderr;
00324             \}
00325         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"maxmemory-samples"}) && argc == 2) \{
00326             server.maxmemory\_samples = atoi(argv[1]);
00327             \textcolor{keywordflow}{if} (server.maxmemory\_samples <= 0) \{
00328                 err = \textcolor{stringliteral}{"maxmemory-samples must be 1 or greater"};
00329                 \textcolor{keywordflow}{goto} loaderr;
00330             \}
00331         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"lfu-log-factor"}) && argc == 2) \{
00332             server.lfu\_log\_factor = atoi(argv[1]);
00333             \textcolor{keywordflow}{if} (server.lfu\_log\_factor < 0) \{
00334                 err = \textcolor{stringliteral}{"lfu-log-factor must be 0 or greater"};
00335                 \textcolor{keywordflow}{goto} loaderr;
00336             \}
00337         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"lfu-decay-time"}) && argc == 2) \{
00338             server.lfu\_decay\_time = atoi(argv[1]);
00339             \textcolor{keywordflow}{if} (server.lfu\_decay\_time < 0) \{
00340                 err = \textcolor{stringliteral}{"lfu-decay-time must be 0 or greater"};
00341                 \textcolor{keywordflow}{goto} loaderr;
00342             \}
00343         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"slaveof"}) && argc == 3) \{
00344             slaveof\_linenum = linenum;
00345             server.masterhost = sdsnew(argv[1]);
00346             server.masterport = atoi(argv[2]);
00347             server.repl\_state = \hyperlink{server_8h_adfe013d4a620f0b98b47b2144760e69f}{REPL\_STATE\_CONNECT};
00348         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"repl-ping-slave-period"}) && argc == 2) \{
00349             server.repl\_ping\_slave\_period = atoi(argv[1]);
00350             \textcolor{keywordflow}{if} (server.repl\_ping\_slave\_period <= 0) \{
00351                 err = \textcolor{stringliteral}{"repl-ping-slave-period must be 1 or greater"};
00352                 \textcolor{keywordflow}{goto} loaderr;
00353             \}
00354         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"repl-timeout"}) && argc == 2) \{
00355             server.repl\_timeout = atoi(argv[1]);
00356             \textcolor{keywordflow}{if} (server.repl\_timeout <= 0) \{
00357                 err = \textcolor{stringliteral}{"repl-timeout must be 1 or greater"};
00358                 \textcolor{keywordflow}{goto} loaderr;
00359             \}
00360         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"repl-disable-tcp-nodelay"}) && argc==2) \{
00361             \textcolor{keywordflow}{if} ((server.repl\_disable\_tcp\_nodelay = yesnotoi(argv[1])) == -1) \{
00362                 err = \textcolor{stringliteral}{"argument must be 'yes' or 'no'"}; \textcolor{keywordflow}{goto} loaderr;
00363             \}
00364         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"repl-diskless-sync"}) && argc==2) \{
00365             \textcolor{keywordflow}{if} ((server.repl\_diskless\_sync = yesnotoi(argv[1])) == -1) \{
00366                 err = \textcolor{stringliteral}{"argument must be 'yes' or 'no'"}; \textcolor{keywordflow}{goto} loaderr;
00367             \}
00368         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"repl-diskless-sync-delay"}) && argc==2) \{
00369             server.repl\_diskless\_sync\_delay = atoi(argv[1]);
00370             \textcolor{keywordflow}{if} (server.repl\_diskless\_sync\_delay < 0) \{
00371                 err = \textcolor{stringliteral}{"repl-diskless-sync-delay can't be negative"};
00372                 \textcolor{keywordflow}{goto} loaderr;
00373             \}
00374         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"repl-backlog-size"}) && argc == 2) \{
00375             \textcolor{keywordtype}{long} \textcolor{keywordtype}{long} size = memtoll(argv[1],NULL);
00376             \textcolor{keywordflow}{if} (size <= 0) \{
00377                 err = \textcolor{stringliteral}{"repl-backlog-size must be 1 or greater."};
00378                 \textcolor{keywordflow}{goto} loaderr;
00379             \}
00380             resizeReplicationBacklog(size);
00381         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"repl-backlog-ttl"}) && argc == 2) \{
00382             server.repl\_backlog\_time\_limit = atoi(argv[1]);
00383             \textcolor{keywordflow}{if} (server.repl\_backlog\_time\_limit < 0) \{
00384                 err = \textcolor{stringliteral}{"repl-backlog-ttl can't be negative "};
00385                 \textcolor{keywordflow}{goto} loaderr;
00386             \}
00387         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"masterauth"}) && argc == 2) \{
00388             zfree(server.masterauth);
00389             server.masterauth = zstrdup(argv[1]);
00390         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"slave-serve-stale-data"}) && argc == 2) \{
00391             \textcolor{keywordflow}{if} ((server.repl\_serve\_stale\_data = yesnotoi(argv[1])) == -1) \{
00392                 err = \textcolor{stringliteral}{"argument must be 'yes' or 'no'"}; \textcolor{keywordflow}{goto} loaderr;
00393             \}
00394         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"slave-read-only"}) && argc == 2) \{
00395             \textcolor{keywordflow}{if} ((server.repl\_slave\_ro = yesnotoi(argv[1])) == -1) \{
00396                 err = \textcolor{stringliteral}{"argument must be 'yes' or 'no'"}; \textcolor{keywordflow}{goto} loaderr;
00397             \}
00398         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"rdbcompression"}) && argc == 2) \{
00399             \textcolor{keywordflow}{if} ((server.rdb\_compression = yesnotoi(argv[1])) == -1) \{
00400                 err = \textcolor{stringliteral}{"argument must be 'yes' or 'no'"}; \textcolor{keywordflow}{goto} loaderr;
00401             \}
00402         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"rdbchecksum"}) && argc == 2) \{
00403             \textcolor{keywordflow}{if} ((server.rdb\_checksum = yesnotoi(argv[1])) == -1) \{
00404                 err = \textcolor{stringliteral}{"argument must be 'yes' or 'no'"}; \textcolor{keywordflow}{goto} loaderr;
00405             \}
00406         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"activerehashing"}) && argc == 2) \{
00407             \textcolor{keywordflow}{if} ((server.activerehashing = yesnotoi(argv[1])) == -1) \{
00408                 err = \textcolor{stringliteral}{"argument must be 'yes' or 'no'"}; \textcolor{keywordflow}{goto} loaderr;
00409             \}
00410         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"lazyfree-lazy-eviction"}) && argc == 2) \{
00411             \textcolor{keywordflow}{if} ((server.lazyfree\_lazy\_eviction = yesnotoi(argv[1])) == -1) \{
00412                 err = \textcolor{stringliteral}{"argument must be 'yes' or 'no'"}; \textcolor{keywordflow}{goto} loaderr;
00413             \}
00414         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"lazyfree-lazy-expire"}) && argc == 2) \{
00415             \textcolor{keywordflow}{if} ((server.lazyfree\_lazy\_expire = yesnotoi(argv[1])) == -1) \{
00416                 err = \textcolor{stringliteral}{"argument must be 'yes' or 'no'"}; \textcolor{keywordflow}{goto} loaderr;
00417             \}
00418         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"lazyfree-lazy-server-del"}) && argc == 2)\{
00419             \textcolor{keywordflow}{if} ((server.lazyfree\_lazy\_server\_del = yesnotoi(argv[1])) == -1) \{
00420                 err = \textcolor{stringliteral}{"argument must be 'yes' or 'no'"}; \textcolor{keywordflow}{goto} loaderr;
00421             \}
00422         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"slave-lazy-flush"}) && argc == 2) \{
00423             \textcolor{keywordflow}{if} ((server.repl\_slave\_lazy\_flush = yesnotoi(argv[1])) == -1) \{
00424                 err = \textcolor{stringliteral}{"argument must be 'yes' or 'no'"}; \textcolor{keywordflow}{goto} loaderr;
00425             \}
00426         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"activedefrag"}) && argc == 2) \{
00427             \textcolor{keywordflow}{if} ((server.active\_defrag\_enabled = yesnotoi(argv[1])) == -1) \{
00428                 err = \textcolor{stringliteral}{"argument must be 'yes' or 'no'"}; \textcolor{keywordflow}{goto} loaderr;
00429             \}
00430         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"daemonize"}) && argc == 2) \{
00431             \textcolor{keywordflow}{if} ((server.daemonize = yesnotoi(argv[1])) == -1) \{
00432                 err = \textcolor{stringliteral}{"argument must be 'yes' or 'no'"}; \textcolor{keywordflow}{goto} loaderr;
00433             \}
00434         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"hz"}) && argc == 2) \{
00435             server.hz = atoi(argv[1]);
00436             \textcolor{keywordflow}{if} (server.hz < \hyperlink{server_8h_aba98a7c0e14b8f68e19c43e3e0334fc2}{CONFIG\_MIN\_HZ}) server.hz = 
      \hyperlink{server_8h_aba98a7c0e14b8f68e19c43e3e0334fc2}{CONFIG\_MIN\_HZ};
00437             \textcolor{keywordflow}{if} (server.hz > \hyperlink{server_8h_a39e5c16e64adef2e14a9d66a725b91fd}{CONFIG\_MAX\_HZ}) server.hz = 
      \hyperlink{server_8h_a39e5c16e64adef2e14a9d66a725b91fd}{CONFIG\_MAX\_HZ};
00438         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"appendonly"}) && argc == 2) \{
00439             \textcolor{keywordtype}{int} yes;
00440 
00441             \textcolor{keywordflow}{if} ((yes = yesnotoi(argv[1])) == -1) \{
00442                 err = \textcolor{stringliteral}{"argument must be 'yes' or 'no'"}; \textcolor{keywordflow}{goto} loaderr;
00443             \}
00444             server.aof\_state = yes ? \hyperlink{server_8h_af6b151c9dced28e94c19479197113a83}{AOF\_ON} : \hyperlink{server_8h_a5226306fbcebcb6d5d02e0fef3c213c2}{AOF\_OFF};
00445         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"appendfilename"}) && argc == 2) \{
00446             \textcolor{keywordflow}{if} (!pathIsBaseName(argv[1])) \{
00447                 err = \textcolor{stringliteral}{"appendfilename can't be a path, just a filename"};
00448                 \textcolor{keywordflow}{goto} loaderr;
00449             \}
00450             zfree(server.aof\_filename);
00451             server.aof\_filename = zstrdup(argv[1]);
00452         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"no-appendfsync-on-rewrite"})
00453                    && argc == 2) \{
00454             \textcolor{keywordflow}{if} ((server.aof\_no\_fsync\_on\_rewrite= yesnotoi(argv[1])) == -1) \{
00455                 err = \textcolor{stringliteral}{"argument must be 'yes' or 'no'"}; \textcolor{keywordflow}{goto} loaderr;
00456             \}
00457         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"appendfsync"}) && argc == 2) \{
00458             server.\hyperlink{config_8h_af5994c643c434574580bb7816af82cad}{aof\_fsync} = configEnumGetValue(aof\_fsync\_enum,argv[1]);
00459             \textcolor{keywordflow}{if} (server.\hyperlink{config_8h_af5994c643c434574580bb7816af82cad}{aof\_fsync} == INT\_MIN) \{
00460                 err = \textcolor{stringliteral}{"argument must be 'no', 'always' or 'everysec'"};
00461                 \textcolor{keywordflow}{goto} loaderr;
00462             \}
00463         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"auto-aof-rewrite-percentage"}) &&
00464                    argc == 2)
00465         \{
00466             server.aof\_rewrite\_perc = atoi(argv[1]);
00467             \textcolor{keywordflow}{if} (server.aof\_rewrite\_perc < 0) \{
00468                 err = \textcolor{stringliteral}{"Invalid negative percentage for AOF auto rewrite"};
00469                 \textcolor{keywordflow}{goto} loaderr;
00470             \}
00471         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"auto-aof-rewrite-min-size"}) &&
00472                    argc == 2)
00473         \{
00474             server.aof\_rewrite\_min\_size = memtoll(argv[1],NULL);
00475         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"aof-rewrite-incremental-fsync"}) &&
00476                    argc == 2)
00477         \{
00478             \textcolor{keywordflow}{if} ((server.aof\_rewrite\_incremental\_fsync =
00479                  yesnotoi(argv[1])) == -1) \{
00480                 err = \textcolor{stringliteral}{"argument must be 'yes' or 'no'"}; \textcolor{keywordflow}{goto} loaderr;
00481             \}
00482         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"aof-load-truncated"}) && argc == 2) \{
00483             \textcolor{keywordflow}{if} ((server.aof\_load\_truncated = yesnotoi(argv[1])) == -1) \{
00484                 err = \textcolor{stringliteral}{"argument must be 'yes' or 'no'"}; \textcolor{keywordflow}{goto} loaderr;
00485             \}
00486         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"aof-use-rdb-preamble"}) && argc == 2) \{
00487             \textcolor{keywordflow}{if} ((server.aof\_use\_rdb\_preamble = yesnotoi(argv[1])) == -1) \{
00488                 err = \textcolor{stringliteral}{"argument must be 'yes' or 'no'"}; \textcolor{keywordflow}{goto} loaderr;
00489             \}
00490         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"requirepass"}) && argc == 2) \{
00491             \textcolor{keywordflow}{if} (strlen(argv[1]) > \hyperlink{server_8h_a8e9d7cd814b95c2cbd17701efe1374f2}{CONFIG\_AUTHPASS\_MAX\_LEN}) \{
00492                 err = \textcolor{stringliteral}{"Password is longer than CONFIG\_AUTHPASS\_MAX\_LEN"};
00493                 \textcolor{keywordflow}{goto} loaderr;
00494             \}
00495             server.requirepass = zstrdup(argv[1]);
00496         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"pidfile"}) && argc == 2) \{
00497             zfree(server.pidfile);
00498             server.pidfile = zstrdup(argv[1]);
00499         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"dbfilename"}) && argc == 2) \{
00500             \textcolor{keywordflow}{if} (!pathIsBaseName(argv[1])) \{
00501                 err = \textcolor{stringliteral}{"dbfilename can't be a path, just a filename"};
00502                 \textcolor{keywordflow}{goto} loaderr;
00503             \}
00504             zfree(server.rdb\_filename);
00505             server.rdb\_filename = zstrdup(argv[1]);
00506         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"active-defrag-threshold-lower"}) && argc == 2) \{
00507             server.active\_defrag\_threshold\_lower = atoi(argv[1]);
00508             \textcolor{keywordflow}{if} (server.active\_defrag\_threshold\_lower < 0) \{
00509                 err = \textcolor{stringliteral}{"active-defrag-threshold-lower must be 0 or greater"};
00510                 \textcolor{keywordflow}{goto} loaderr;
00511             \}
00512         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"active-defrag-threshold-upper"}) && argc == 2) \{
00513             server.active\_defrag\_threshold\_upper = atoi(argv[1]);
00514             \textcolor{keywordflow}{if} (server.active\_defrag\_threshold\_upper < 0) \{
00515                 err = \textcolor{stringliteral}{"active-defrag-threshold-upper must be 0 or greater"};
00516                 \textcolor{keywordflow}{goto} loaderr;
00517             \}
00518         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"active-defrag-ignore-bytes"}) && argc == 2) \{
00519             server.active\_defrag\_ignore\_bytes = memtoll(argv[1], NULL);
00520             \textcolor{keywordflow}{if} (server.active\_defrag\_ignore\_bytes <= 0) \{
00521                 err = \textcolor{stringliteral}{"active-defrag-ignore-bytes must above 0"};
00522                 \textcolor{keywordflow}{goto} loaderr;
00523             \}
00524         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"active-defrag-cycle-min"}) && argc == 2) \{
00525             server.active\_defrag\_cycle\_min = atoi(argv[1]);
00526             \textcolor{keywordflow}{if} (server.active\_defrag\_cycle\_min < 1 || server.active\_defrag\_cycle\_min > 99) \{
00527                 err = \textcolor{stringliteral}{"active-defrag-cycle-min must be between 1 and 99"};
00528                 \textcolor{keywordflow}{goto} loaderr;
00529             \}
00530         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"active-defrag-cycle-max"}) && argc == 2) \{
00531             server.active\_defrag\_cycle\_max = atoi(argv[1]);
00532             \textcolor{keywordflow}{if} (server.active\_defrag\_cycle\_max < 1 || server.active\_defrag\_cycle\_max > 99) \{
00533                 err = \textcolor{stringliteral}{"active-defrag-cycle-max must be between 1 and 99"};
00534                 \textcolor{keywordflow}{goto} loaderr;
00535             \}
00536         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"hash-max-ziplist-entries"}) && argc == 2) \{
00537             server.hash\_max\_ziplist\_entries = memtoll(argv[1], NULL);
00538         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"hash-max-ziplist-value"}) && argc == 2) \{
00539             server.hash\_max\_ziplist\_value = memtoll(argv[1], NULL);
00540         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"list-max-ziplist-entries"}) && argc == 2)\{
00541             \textcolor{comment}{/* DEAD OPTION */}
00542         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"list-max-ziplist-value"}) && argc == 2) \{
00543             \textcolor{comment}{/* DEAD OPTION */}
00544         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"list-max-ziplist-size"}) && argc == 2) \{
00545             server.list\_max\_ziplist\_size = atoi(argv[1]);
00546         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"list-compress-depth"}) && argc == 2) \{
00547             server.list\_compress\_depth = atoi(argv[1]);
00548         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"set-max-intset-entries"}) && argc == 2) \{
00549             server.set\_max\_intset\_entries = memtoll(argv[1], NULL);
00550         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"zset-max-ziplist-entries"}) && argc == 2) \{
00551             server.zset\_max\_ziplist\_entries = memtoll(argv[1], NULL);
00552         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"zset-max-ziplist-value"}) && argc == 2) \{
00553             server.zset\_max\_ziplist\_value = memtoll(argv[1], NULL);
00554         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"hll-sparse-max-bytes"}) && argc == 2) \{
00555             server.hll\_sparse\_max\_bytes = memtoll(argv[1], NULL);
00556         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"rename-command"}) && argc == 3) \{
00557             \textcolor{keyword}{struct} \hyperlink{structredisCommand}{redisCommand} *cmd = lookupCommand(argv[1]);
00558             \textcolor{keywordtype}{int} retval;
00559 
00560             \textcolor{keywordflow}{if} (!cmd) \{
00561                 err = \textcolor{stringliteral}{"No such command in rename-command"};
00562                 \textcolor{keywordflow}{goto} loaderr;
00563             \}
00564 
00565             \textcolor{comment}{/* If the target command name is the empty string we just}
00566 \textcolor{comment}{             * remove it from the command table. */}
00567             retval = dictDelete(server.commands, argv[1]);
00568             \hyperlink{server_8h_a88114b5169b4c382df6b56506285e56a}{serverAssert}(retval == \hyperlink{dict_8h_a2afecbeab8f7efbc183048f52f6d17e5}{DICT\_OK});
00569 
00570             \textcolor{comment}{/* Otherwise we re-add the command under a different name. */}
00571             \textcolor{keywordflow}{if} (sdslen(argv[2]) != 0) \{
00572                 sds copy = sdsdup(argv[2]);
00573 
00574                 retval = dictAdd(server.commands, copy, cmd);
00575                 \textcolor{keywordflow}{if} (retval != \hyperlink{dict_8h_a2afecbeab8f7efbc183048f52f6d17e5}{DICT\_OK}) \{
00576                     sdsfree(copy);
00577                     err = \textcolor{stringliteral}{"Target command name already exists"}; \textcolor{keywordflow}{goto} loaderr;
00578                 \}
00579             \}
00580         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"cluster-enabled"}) && argc == 2) \{
00581             \textcolor{keywordflow}{if} ((server.cluster\_enabled = yesnotoi(argv[1])) == -1) \{
00582                 err = \textcolor{stringliteral}{"argument must be 'yes' or 'no'"}; \textcolor{keywordflow}{goto} loaderr;
00583             \}
00584         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"cluster-config-file"}) && argc == 2) \{
00585             zfree(server.cluster\_configfile);
00586             server.cluster\_configfile = zstrdup(argv[1]);
00587         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"cluster-announce-ip"}) && argc == 2) \{
00588             zfree(server.cluster\_announce\_ip);
00589             server.cluster\_announce\_ip = zstrdup(argv[1]);
00590         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"cluster-announce-port"}) && argc == 2) \{
00591             server.cluster\_announce\_port = atoi(argv[1]);
00592             \textcolor{keywordflow}{if} (server.cluster\_announce\_port < 0 ||
00593                 server.cluster\_announce\_port > 65535)
00594             \{
00595                 err = \textcolor{stringliteral}{"Invalid port"}; \textcolor{keywordflow}{goto} loaderr;
00596             \}
00597         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"cluster-announce-bus-port"}) &&
00598                    argc == 2)
00599         \{
00600             server.cluster\_announce\_bus\_port = atoi(argv[1]);
00601             \textcolor{keywordflow}{if} (server.cluster\_announce\_bus\_port < 0 ||
00602                 server.cluster\_announce\_bus\_port > 65535)
00603             \{
00604                 err = \textcolor{stringliteral}{"Invalid port"}; \textcolor{keywordflow}{goto} loaderr;
00605             \}
00606         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"cluster-require-full-coverage"}) &&
00607                     argc == 2)
00608         \{
00609             \textcolor{keywordflow}{if} ((server.cluster\_require\_full\_coverage = yesnotoi(argv[1])) == -1)
00610             \{
00611                 err = \textcolor{stringliteral}{"argument must be 'yes' or 'no'"}; \textcolor{keywordflow}{goto} loaderr;
00612             \}
00613         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"cluster-node-timeout"}) && argc == 2) \{
00614             server.cluster\_node\_timeout = strtoll(argv[1],NULL,10);
00615             \textcolor{keywordflow}{if} (server.cluster\_node\_timeout <= 0) \{
00616                 err = \textcolor{stringliteral}{"cluster node timeout must be 1 or greater"}; \textcolor{keywordflow}{goto} loaderr;
00617             \}
00618         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"cluster-migration-barrier"})
00619                    && argc == 2)
00620         \{
00621             server.cluster\_migration\_barrier = atoi(argv[1]);
00622             \textcolor{keywordflow}{if} (server.cluster\_migration\_barrier < 0) \{
00623                 err = \textcolor{stringliteral}{"cluster migration barrier must zero or positive"};
00624                 \textcolor{keywordflow}{goto} loaderr;
00625             \}
00626         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"cluster-slave-validity-factor"})
00627                    && argc == 2)
00628         \{
00629             server.cluster\_slave\_validity\_factor = atoi(argv[1]);
00630             \textcolor{keywordflow}{if} (server.cluster\_slave\_validity\_factor < 0) \{
00631                 err = \textcolor{stringliteral}{"cluster slave validity factor must be zero or positive"};
00632                 \textcolor{keywordflow}{goto} loaderr;
00633             \}
00634         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"lua-time-limit"}) && argc == 2) \{
00635             server.lua\_time\_limit = strtoll(argv[1],NULL,10);
00636         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"slowlog-log-slower-than"}) &&
00637                    argc == 2)
00638         \{
00639             server.slowlog\_log\_slower\_than = strtoll(argv[1],NULL,10);
00640         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"latency-monitor-threshold"}) &&
00641                    argc == 2)
00642         \{
00643             server.latency\_monitor\_threshold = strtoll(argv[1],NULL,10);
00644             \textcolor{keywordflow}{if} (server.latency\_monitor\_threshold < 0) \{
00645                 err = \textcolor{stringliteral}{"The latency threshold can't be negative"};
00646                 \textcolor{keywordflow}{goto} loaderr;
00647             \}
00648         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"slowlog-max-len"}) && argc == 2) \{
00649             server.slowlog\_max\_len = strtoll(argv[1],NULL,10);
00650         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"client-output-buffer-limit"}) &&
00651                    argc == 5)
00652         \{
00653             \textcolor{keywordtype}{int} \textcolor{keyword}{class} = getClientTypeByName(argv[1]);
00654             \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{long} \textcolor{keywordtype}{long} hard, soft;
00655             \textcolor{keywordtype}{int} soft\_seconds;
00656 
00657             \textcolor{keywordflow}{if} (\textcolor{keyword}{class} == -1 || \textcolor{keyword}{class} == \hyperlink{server_8h_ae96c04932d9a47108994d8f337fd8563}{CLIENT\_TYPE\_MASTER}) \{
00658                 err = \textcolor{stringliteral}{"Unrecognized client limit class: the user specified "}
00659                 \textcolor{stringliteral}{"an invalid one, or 'master' which has no buffer limits."};
00660                 \textcolor{keywordflow}{goto} loaderr;
00661             \}
00662             hard = memtoll(argv[2],NULL);
00663             soft = memtoll(argv[3],NULL);
00664             soft\_seconds = atoi(argv[4]);
00665             \textcolor{keywordflow}{if} (soft\_seconds < 0) \{
00666                 err = \textcolor{stringliteral}{"Negative number of seconds in soft limit is invalid"};
00667                 \textcolor{keywordflow}{goto} loaderr;
00668             \}
00669             server.client\_obuf\_limits[\textcolor{keyword}{class}].hard\_limit\_bytes = hard;
00670             server.client\_obuf\_limits[\textcolor{keyword}{class}].soft\_limit\_bytes = soft;
00671             server.client\_obuf\_limits[\textcolor{keyword}{class}].soft\_limit\_seconds = soft\_seconds;
00672         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"stop-writes-on-bgsave-error"}) &&
00673                    argc == 2) \{
00674             \textcolor{keywordflow}{if} ((server.stop\_writes\_on\_bgsave\_err = yesnotoi(argv[1])) == -1) \{
00675                 err = \textcolor{stringliteral}{"argument must be 'yes' or 'no'"}; \textcolor{keywordflow}{goto} loaderr;
00676             \}
00677         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"slave-priority"}) && argc == 2) \{
00678             server.slave\_priority = atoi(argv[1]);
00679         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"slave-announce-ip"}) && argc == 2) \{
00680             zfree(server.slave\_announce\_ip);
00681             server.slave\_announce\_ip = zstrdup(argv[1]);
00682         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"slave-announce-port"}) && argc == 2) \{
00683             server.slave\_announce\_port = atoi(argv[1]);
00684             \textcolor{keywordflow}{if} (server.slave\_announce\_port < 0 ||
00685                 server.slave\_announce\_port > 65535)
00686             \{
00687                 err = \textcolor{stringliteral}{"Invalid port"}; \textcolor{keywordflow}{goto} loaderr;
00688             \}
00689         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"min-slaves-to-write"}) && argc == 2) \{
00690             server.repl\_min\_slaves\_to\_write = atoi(argv[1]);
00691             \textcolor{keywordflow}{if} (server.repl\_min\_slaves\_to\_write < 0) \{
00692                 err = \textcolor{stringliteral}{"Invalid value for min-slaves-to-write."}; \textcolor{keywordflow}{goto} loaderr;
00693             \}
00694         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"min-slaves-max-lag"}) && argc == 2) \{
00695             server.repl\_min\_slaves\_max\_lag = atoi(argv[1]);
00696             \textcolor{keywordflow}{if} (server.repl\_min\_slaves\_max\_lag < 0) \{
00697                 err = \textcolor{stringliteral}{"Invalid value for min-slaves-max-lag."}; \textcolor{keywordflow}{goto} loaderr;
00698             \}
00699         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"notify-keyspace-events"}) && argc == 2) \{
00700             \textcolor{keywordtype}{int} flags = keyspaceEventsStringToFlags(argv[1]);
00701 
00702             \textcolor{keywordflow}{if} (flags == -1) \{
00703                 err = \textcolor{stringliteral}{"Invalid event class character. Use 'g$lshzxeA'."};
00704                 \textcolor{keywordflow}{goto} loaderr;
00705             \}
00706             server.notify\_keyspace\_events = flags;
00707         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"supervised"}) && argc == 2) \{
00708             server.supervised\_mode =
00709                 configEnumGetValue(supervised\_mode\_enum,argv[1]);
00710 
00711             \textcolor{keywordflow}{if} (server.supervised\_mode == INT\_MIN) \{
00712                 err = \textcolor{stringliteral}{"Invalid option for 'supervised'. "}
00713                     \textcolor{stringliteral}{"Allowed values: 'upstart', 'systemd', 'auto', or 'no'"};
00714                 \textcolor{keywordflow}{goto} loaderr;
00715             \}
00716         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"loadmodule"}) && argc >= 2) \{
00717             queueLoadModule(argv[1],&argv[2],argc-2);
00718         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"sentinel"})) \{
00719             \textcolor{comment}{/* argc == 1 is handled by main() as we need to enter the sentinel}
00720 \textcolor{comment}{             * mode ASAP. */}
00721             \textcolor{keywordflow}{if} (argc != 1) \{
00722                 \textcolor{keywordflow}{if} (!server.sentinel\_mode) \{
00723                     err = \textcolor{stringliteral}{"sentinel directive while not in sentinel mode"};
00724                     \textcolor{keywordflow}{goto} loaderr;
00725                 \}
00726                 err = sentinelHandleConfiguration(argv+1,argc-1);
00727                 \textcolor{keywordflow}{if} (err) \textcolor{keywordflow}{goto} loaderr;
00728             \}
00729         \} \textcolor{keywordflow}{else} \{
00730             err = \textcolor{stringliteral}{"Bad directive or wrong number of arguments"}; \textcolor{keywordflow}{goto} loaderr;
00731         \}
00732         sdsfreesplitres(argv,argc);
00733     \}
00734 
00735     \textcolor{comment}{/* Sanity checks. */}
00736     \textcolor{keywordflow}{if} (server.cluster\_enabled && server.masterhost) \{
00737         linenum = slaveof\_linenum;
00738         i = linenum-1;
00739         err = \textcolor{stringliteral}{"slaveof directive not allowed in cluster mode"};
00740         \textcolor{keywordflow}{goto} loaderr;
00741     \}
00742 
00743     sdsfreesplitres(lines,totlines);
00744     \textcolor{keywordflow}{return};
00745 
00746 loaderr:
00747     fprintf(stderr, \textcolor{stringliteral}{"\(\backslash\)n*** FATAL CONFIG FILE ERROR ***\(\backslash\)n"});
00748     fprintf(stderr, \textcolor{stringliteral}{"Reading the configuration file, at line %d\(\backslash\)n"}, linenum);
00749     fprintf(stderr, \textcolor{stringliteral}{">>> '%s'\(\backslash\)n"}, lines[i]);
00750     fprintf(stderr, \textcolor{stringliteral}{"%s\(\backslash\)n"}, err);
00751     exit(1);
00752 \}
00753 
00754 \textcolor{comment}{/* Load the server configuration from the specified filename.}
00755 \textcolor{comment}{ * The function appends the additional configuration directives stored}
00756 \textcolor{comment}{ * in the 'options' string to the config file before loading.}
00757 \textcolor{comment}{ *}
00758 \textcolor{comment}{ * Both filename and options can be NULL, in such a case are considered}
00759 \textcolor{comment}{ * empty. This way loadServerConfig can be used to just load a file or}
00760 \textcolor{comment}{ * just load a string. */}
00761 \textcolor{keywordtype}{void} loadServerConfig(\textcolor{keywordtype}{char} *filename, \textcolor{keywordtype}{char} *options) \{
00762     sds config = sdsempty();
00763     \textcolor{keywordtype}{char} buf[\hyperlink{server_8h_a0d8887ba7f096f153f904f206986a9fc}{CONFIG\_MAX\_LINE}+1];
00764 
00765     \textcolor{comment}{/* Load the file content */}
00766     \textcolor{keywordflow}{if} (filename) \{
00767         FILE *fp;
00768 
00769         \textcolor{keywordflow}{if} (filename[0] == \textcolor{stringliteral}{'-'} && filename[1] == \textcolor{stringliteral}{'\(\backslash\)0'}) \{
00770             fp = stdin;
00771         \} \textcolor{keywordflow}{else} \{
00772             \textcolor{keywordflow}{if} ((fp = fopen(filename,\textcolor{stringliteral}{"r"})) == NULL) \{
00773                 serverLog(\hyperlink{server_8h_a31229b9334bba7d6be2a72970967a14b}{LL\_WARNING},
00774                     \textcolor{stringliteral}{"Fatal error, can't open config file '%s'"}, filename);
00775                 exit(1);
00776             \}
00777         \}
00778         \textcolor{keywordflow}{while}(fgets(buf,\hyperlink{server_8h_a0d8887ba7f096f153f904f206986a9fc}{CONFIG\_MAX\_LINE}+1,fp) != NULL)
00779             config = sdscat(config,buf);
00780         \textcolor{keywordflow}{if} (fp != stdin) fclose(fp);
00781     \}
00782     \textcolor{comment}{/* Append the additional options */}
00783     \textcolor{keywordflow}{if} (options) \{
00784         config = sdscat(config,\textcolor{stringliteral}{"\(\backslash\)n"});
00785         config = sdscat(config,options);
00786     \}
00787     loadServerConfigFromString(config);
00788     sdsfree(config);
00789 \}
00790 
00791 \textcolor{comment}{/*-----------------------------------------------------------------------------}
00792 \textcolor{comment}{ * CONFIG SET implementation}
00793 \textcolor{comment}{ *----------------------------------------------------------------------------*/}
00794 
00795 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{config\_set\_bool\_field}\textcolor{preprocessor}{(}\textcolor{preprocessor}{\_name}\textcolor{preprocessor}{,}\textcolor{preprocessor}{\_var}\textcolor{preprocessor}{)}
00796     \textcolor{preprocessor}{\}} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} \textcolor{preprocessor}{(}\textcolor{preprocessor}{!}\textcolor{preprocessor}{strcasecmp}\textcolor{preprocessor}{(}\textcolor{preprocessor}{c}\textcolor{preprocessor}{->}\textcolor{preprocessor}{argv}\textcolor{preprocessor}{[}2\textcolor{preprocessor}{]}\textcolor{preprocessor}{->}\textcolor{preprocessor}{ptr}\textcolor{preprocessor}{,}\textcolor{preprocessor}{\_name}\textcolor{preprocessor}{)}\textcolor{preprocessor}{)} \textcolor{preprocessor}{\{}
00797         \textcolor{keywordtype}{int} \textcolor{preprocessor}{yn} \textcolor{preprocessor}{=} \textcolor{preprocessor}{yesnotoi}\textcolor{preprocessor}{(}\textcolor{preprocessor}{o}\textcolor{preprocessor}{->}\textcolor{preprocessor}{ptr}\textcolor{preprocessor}{)}\textcolor{preprocessor}{;}
00798         \textcolor{keywordflow}{if} \textcolor{preprocessor}{(}\textcolor{preprocessor}{yn} \textcolor{preprocessor}{==} \textcolor{preprocessor}{-}1\textcolor{preprocessor}{)} \textcolor{keywordflow}{goto} \textcolor{preprocessor}{badfmt}\textcolor{preprocessor}{;}
00799         \textcolor{preprocessor}{\_var} \textcolor{preprocessor}{=} \textcolor{preprocessor}{yn}\textcolor{preprocessor}{;}
00800 
00801 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{config\_set\_numerical\_field}\textcolor{preprocessor}{(}\textcolor{preprocessor}{\_name}\textcolor{preprocessor}{,}\textcolor{preprocessor}{\_var}\textcolor{preprocessor}{,}\textcolor{preprocessor}{min}\textcolor{preprocessor}{,}\textcolor{preprocessor}{max}\textcolor{preprocessor}{)}
00802     \textcolor{preprocessor}{\}} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} \textcolor{preprocessor}{(}\textcolor{preprocessor}{!}\textcolor{preprocessor}{strcasecmp}\textcolor{preprocessor}{(}\textcolor{preprocessor}{c}\textcolor{preprocessor}{->}\textcolor{preprocessor}{argv}\textcolor{preprocessor}{[}2\textcolor{preprocessor}{]}\textcolor{preprocessor}{->}\textcolor{preprocessor}{ptr}\textcolor{preprocessor}{,}\textcolor{preprocessor}{\_name}\textcolor{preprocessor}{)}\textcolor{preprocessor}{)} \textcolor{preprocessor}{\{}
00803         \textcolor{keywordflow}{if} \textcolor{preprocessor}{(}\textcolor{preprocessor}{getLongLongFromObject}\textcolor{preprocessor}{(}\textcolor{preprocessor}{o}\textcolor{preprocessor}{,}\textcolor{preprocessor}{&}\textcolor{preprocessor}{ll}\textcolor{preprocessor}{)} \textcolor{preprocessor}{==} \hyperlink{server_8h_af98ac28d5f4d23d7ed5985188e6fb7d1}{C\_ERR}\textcolor{preprocessor}{)} \textcolor{keywordflow}{goto} \textcolor{preprocessor}{badfmt}\textcolor{preprocessor}{;}
00804         \textcolor{keywordflow}{if} \textcolor{preprocessor}{(}\textcolor{preprocessor}{min} \textcolor{preprocessor}{!=} LLONG\_MIN \textcolor{preprocessor}{&&} \textcolor{preprocessor}{ll} \textcolor{preprocessor}{<} \textcolor{preprocessor}{min}\textcolor{preprocessor}{)} \textcolor{keywordflow}{goto} \textcolor{preprocessor}{badfmt}\textcolor{preprocessor}{;}
00805         \textcolor{keywordflow}{if} \textcolor{preprocessor}{(}\textcolor{preprocessor}{max} \textcolor{preprocessor}{!=} LLONG\_MAX \textcolor{preprocessor}{&&} \textcolor{preprocessor}{ll} \textcolor{preprocessor}{>} \textcolor{preprocessor}{max}\textcolor{preprocessor}{)} \textcolor{keywordflow}{goto} \textcolor{preprocessor}{badfmt}\textcolor{preprocessor}{;}
00806         \textcolor{preprocessor}{\_var} \textcolor{preprocessor}{=} \textcolor{preprocessor}{ll}\textcolor{preprocessor}{;}
00807 
00808 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{config\_set\_memory\_field}\textcolor{preprocessor}{(}\textcolor{preprocessor}{\_name}\textcolor{preprocessor}{,}\textcolor{preprocessor}{\_var}\textcolor{preprocessor}{)}
00809     \textcolor{preprocessor}{\}} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} \textcolor{preprocessor}{(}\textcolor{preprocessor}{!}\textcolor{preprocessor}{strcasecmp}\textcolor{preprocessor}{(}\textcolor{preprocessor}{c}\textcolor{preprocessor}{->}\textcolor{preprocessor}{argv}\textcolor{preprocessor}{[}2\textcolor{preprocessor}{]}\textcolor{preprocessor}{->}\textcolor{preprocessor}{ptr}\textcolor{preprocessor}{,}\textcolor{preprocessor}{\_name}\textcolor{preprocessor}{)}\textcolor{preprocessor}{)} \textcolor{preprocessor}{\{}
00810         \textcolor{preprocessor}{ll} \textcolor{preprocessor}{=} \textcolor{preprocessor}{memtoll}\textcolor{preprocessor}{(}\textcolor{preprocessor}{o}\textcolor{preprocessor}{->}\textcolor{preprocessor}{ptr}\textcolor{preprocessor}{,}\textcolor{preprocessor}{&}\textcolor{preprocessor}{err}\textcolor{preprocessor}{)}\textcolor{preprocessor}{;}
00811         \textcolor{keywordflow}{if} \textcolor{preprocessor}{(}\textcolor{preprocessor}{err} \textcolor{preprocessor}{||} \textcolor{preprocessor}{ll} \textcolor{preprocessor}{<} 0\textcolor{preprocessor}{)} \textcolor{keywordflow}{goto} \textcolor{preprocessor}{badfmt}\textcolor{preprocessor}{;}
00812         \textcolor{preprocessor}{\_var} \textcolor{preprocessor}{=} \textcolor{preprocessor}{ll}\textcolor{preprocessor}{;}
00813 
00814 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{config\_set\_enum\_field}\textcolor{preprocessor}{(}\textcolor{preprocessor}{\_name}\textcolor{preprocessor}{,}\textcolor{preprocessor}{\_var}\textcolor{preprocessor}{,}\textcolor{preprocessor}{\_enumvar}\textcolor{preprocessor}{)}
00815     \textcolor{preprocessor}{\}} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} \textcolor{preprocessor}{(}\textcolor{preprocessor}{!}\textcolor{preprocessor}{strcasecmp}\textcolor{preprocessor}{(}\textcolor{preprocessor}{c}\textcolor{preprocessor}{->}\textcolor{preprocessor}{argv}\textcolor{preprocessor}{[}2\textcolor{preprocessor}{]}\textcolor{preprocessor}{->}\textcolor{preprocessor}{ptr}\textcolor{preprocessor}{,}\textcolor{preprocessor}{\_name}\textcolor{preprocessor}{)}\textcolor{preprocessor}{)} \textcolor{preprocessor}{\{}
00816         \textcolor{keywordtype}{int} \textcolor{preprocessor}{enumval} \textcolor{preprocessor}{=} \textcolor{preprocessor}{configEnumGetValue}\textcolor{preprocessor}{(}\textcolor{preprocessor}{\_enumvar}\textcolor{preprocessor}{,}\textcolor{preprocessor}{o}\textcolor{preprocessor}{->}\textcolor{preprocessor}{ptr}\textcolor{preprocessor}{)}\textcolor{preprocessor}{;}
00817         \textcolor{keywordflow}{if} \textcolor{preprocessor}{(}\textcolor{preprocessor}{enumval} \textcolor{preprocessor}{==} \textcolor{preprocessor}{INT\_MIN}\textcolor{preprocessor}{)} \textcolor{keywordflow}{goto} \textcolor{preprocessor}{badfmt}\textcolor{preprocessor}{;}
00818         \textcolor{preprocessor}{\_var} \textcolor{preprocessor}{=} \textcolor{preprocessor}{enumval}\textcolor{preprocessor}{;}
00819 
00820 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{config\_set\_special\_field}\textcolor{preprocessor}{(}\textcolor{preprocessor}{\_name}\textcolor{preprocessor}{)}
00821     \textcolor{preprocessor}{\}} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} \textcolor{preprocessor}{(}\textcolor{preprocessor}{!}\textcolor{preprocessor}{strcasecmp}\textcolor{preprocessor}{(}\textcolor{preprocessor}{c}\textcolor{preprocessor}{->}\textcolor{preprocessor}{argv}\textcolor{preprocessor}{[}2\textcolor{preprocessor}{]}\textcolor{preprocessor}{->}\textcolor{preprocessor}{ptr}\textcolor{preprocessor}{,}\textcolor{preprocessor}{\_name}\textcolor{preprocessor}{)}\textcolor{preprocessor}{)} \textcolor{preprocessor}{\{}
00822 
00823 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{config\_set\_else} \textcolor{preprocessor}{\}} \textcolor{keywordflow}{else}
00824 
00825 \textcolor{keywordtype}{void} configSetCommand(\hyperlink{structclient}{client} *c) \{
00826     robj *o;
00827     \textcolor{keywordtype}{long} \textcolor{keywordtype}{long} ll;
00828     \textcolor{keywordtype}{int} err;
00829     \hyperlink{server_8h_a7308f76cbff9a8d3797fe78190b91282}{serverAssertWithInfo}(c,c->argv[2],\hyperlink{server_8h_afcfb5bd97af52d1dbce331745cae030c}{sdsEncodedObject}(c->argv[2])
      );
00830     \hyperlink{server_8h_a7308f76cbff9a8d3797fe78190b91282}{serverAssertWithInfo}(c,c->argv[3],\hyperlink{server_8h_afcfb5bd97af52d1dbce331745cae030c}{sdsEncodedObject}(c->argv[3])
      );
00831     o = c->argv[3];
00832 
00833     \textcolor{keywordflow}{if} (0) \{ \textcolor{comment}{/* this starts the config\_set macros else-if chain. */}
00834 
00835     \textcolor{comment}{/* Special fields that can't be handled with general macros. */}
00836     \hyperlink{config_8c_a7bdda941057dd2668e0e5b5df1d3ab4c}{config\_set\_special\_field}(\textcolor{stringliteral}{"dbfilename"}) \{
00837         \textcolor{keywordflow}{if} (!pathIsBaseName(o->ptr)) \{
00838             addReplyError(c, \textcolor{stringliteral}{"dbfilename can't be a path, just a filename"});
00839             \textcolor{keywordflow}{return};
00840         \}
00841         zfree(server.rdb\_filename);
00842         server.rdb\_filename = zstrdup(o->ptr);
00843     \} \hyperlink{config_8c_a7bdda941057dd2668e0e5b5df1d3ab4c}{config\_set\_special\_field}(\textcolor{stringliteral}{"requirepass"}) \{
00844         \textcolor{keywordflow}{if} (sdslen(o->ptr) > \hyperlink{server_8h_a8e9d7cd814b95c2cbd17701efe1374f2}{CONFIG\_AUTHPASS\_MAX\_LEN}) \textcolor{keywordflow}{goto} badfmt;
00845         zfree(server.requirepass);
00846         server.requirepass = ((\textcolor{keywordtype}{char}*)o->ptr)[0] ? zstrdup(o->ptr) : NULL;
00847     \} \hyperlink{config_8c_a7bdda941057dd2668e0e5b5df1d3ab4c}{config\_set\_special\_field}(\textcolor{stringliteral}{"masterauth"}) \{
00848         zfree(server.masterauth);
00849         server.masterauth = ((\textcolor{keywordtype}{char}*)o->ptr)[0] ? zstrdup(o->ptr) : NULL;
00850     \} \hyperlink{config_8c_a7bdda941057dd2668e0e5b5df1d3ab4c}{config\_set\_special\_field}(\textcolor{stringliteral}{"cluster-announce-ip"}) \{
00851         zfree(server.cluster\_announce\_ip);
00852         server.cluster\_announce\_ip = ((\textcolor{keywordtype}{char}*)o->ptr)[0] ? zstrdup(o->ptr) : NULL;
00853     \} \hyperlink{config_8c_a7bdda941057dd2668e0e5b5df1d3ab4c}{config\_set\_special\_field}(\textcolor{stringliteral}{"maxclients"}) \{
00854         \textcolor{keywordtype}{int} orig\_value = server.maxclients;
00855 
00856         \textcolor{keywordflow}{if} (getLongLongFromObject(o,&ll) == \hyperlink{server_8h_af98ac28d5f4d23d7ed5985188e6fb7d1}{C\_ERR} || ll < 1) \textcolor{keywordflow}{goto} badfmt;
00857 
00858         \textcolor{comment}{/* Try to check if the OS is capable of supporting so many FDs. */}
00859         server.maxclients = ll;
00860         \textcolor{keywordflow}{if} (ll > orig\_value) \{
00861             adjustOpenFilesLimit();
00862             \textcolor{keywordflow}{if} (server.maxclients != ll) \{
00863                 addReplyErrorFormat(c,\textcolor{stringliteral}{"The operating system is not able to handle the specified number
       of clients, try with %d"}, server.maxclients);
00864                 server.maxclients = orig\_value;
00865                 \textcolor{keywordflow}{return};
00866             \}
00867             \textcolor{keywordflow}{if} ((\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int}) aeGetSetSize(server.el) <
00868                 server.maxclients + \hyperlink{server_8h_a6725c1ff5b6a17f930627263f484d107}{CONFIG\_FDSET\_INCR})
00869             \{
00870                 \textcolor{keywordflow}{if} (aeResizeSetSize(server.el,
00871                     server.maxclients + \hyperlink{server_8h_a6725c1ff5b6a17f930627263f484d107}{CONFIG\_FDSET\_INCR}) == 
      \hyperlink{ae_8h_aa16dcf7effdf8f8df97f51b1cb51a9df}{AE\_ERR})
00872                 \{
00873                     addReplyError(c,\textcolor{stringliteral}{"The event loop API used by Redis is not able to handle the
       specified number of clients"});
00874                     server.maxclients = orig\_value;
00875                     \textcolor{keywordflow}{return};
00876                 \}
00877             \}
00878         \}
00879     \} \hyperlink{config_8c_a7bdda941057dd2668e0e5b5df1d3ab4c}{config\_set\_special\_field}(\textcolor{stringliteral}{"appendonly"}) \{
00880         \textcolor{keywordtype}{int} enable = yesnotoi(o->ptr);
00881 
00882         \textcolor{keywordflow}{if} (enable == -1) \textcolor{keywordflow}{goto} badfmt;
00883         \textcolor{keywordflow}{if} (enable == 0 && server.aof\_state != \hyperlink{server_8h_a5226306fbcebcb6d5d02e0fef3c213c2}{AOF\_OFF}) \{
00884             stopAppendOnly();
00885         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (enable && server.aof\_state == \hyperlink{server_8h_a5226306fbcebcb6d5d02e0fef3c213c2}{AOF\_OFF}) \{
00886             \textcolor{keywordflow}{if} (startAppendOnly() == \hyperlink{server_8h_af98ac28d5f4d23d7ed5985188e6fb7d1}{C\_ERR}) \{
00887                 addReplyError(c,
00888                     \textcolor{stringliteral}{"Unable to turn on AOF. Check server logs."});
00889                 \textcolor{keywordflow}{return};
00890             \}
00891         \}
00892     \} \hyperlink{config_8c_a7bdda941057dd2668e0e5b5df1d3ab4c}{config\_set\_special\_field}(\textcolor{stringliteral}{"save"}) \{
00893         \textcolor{keywordtype}{int} vlen, j;
00894         sds *v = sdssplitlen(o->ptr,sdslen(o->ptr),\textcolor{stringliteral}{" "},1,&vlen);
00895 
00896         \textcolor{comment}{/* Perform sanity check before setting the new config:}
00897 \textcolor{comment}{         * - Even number of args}
00898 \textcolor{comment}{         * - Seconds >= 1, changes >= 0 */}
00899         \textcolor{keywordflow}{if} (vlen & 1) \{
00900             sdsfreesplitres(v,vlen);
00901             \textcolor{keywordflow}{goto} badfmt;
00902         \}
00903         \textcolor{keywordflow}{for} (j = 0; j < vlen; j++) \{
00904             \textcolor{keywordtype}{char} *eptr;
00905             \textcolor{keywordtype}{long} val;
00906 
00907             val = strtoll(v[j], &eptr, 10);
00908             \textcolor{keywordflow}{if} (eptr[0] != \textcolor{stringliteral}{'\(\backslash\)0'} ||
00909                 ((j & 1) == 0 && val < 1) ||
00910                 ((j & 1) == 1 && val < 0)) \{
00911                 sdsfreesplitres(v,vlen);
00912                 \textcolor{keywordflow}{goto} badfmt;
00913             \}
00914         \}
00915         \textcolor{comment}{/* Finally set the new config */}
00916         resetServerSaveParams();
00917         \textcolor{keywordflow}{for} (j = 0; j < vlen; j += 2) \{
00918             time\_t seconds;
00919             \textcolor{keywordtype}{int} changes;
00920 
00921             seconds = strtoll(v[j],NULL,10);
00922             changes = strtoll(v[j+1],NULL,10);
00923             appendServerSaveParams(seconds, changes);
00924         \}
00925         sdsfreesplitres(v,vlen);
00926     \} \hyperlink{config_8c_a7bdda941057dd2668e0e5b5df1d3ab4c}{config\_set\_special\_field}(\textcolor{stringliteral}{"dir"}) \{
00927         \textcolor{keywordflow}{if} (chdir((\textcolor{keywordtype}{char}*)o->ptr) == -1) \{
00928             addReplyErrorFormat(c,\textcolor{stringliteral}{"Changing directory: %s"}, strerror(errno));
00929             \textcolor{keywordflow}{return};
00930         \}
00931     \} \hyperlink{config_8c_a7bdda941057dd2668e0e5b5df1d3ab4c}{config\_set\_special\_field}(\textcolor{stringliteral}{"client-output-buffer-limit"}) \{
00932         \textcolor{keywordtype}{int} vlen, j;
00933         sds *v = sdssplitlen(o->ptr,sdslen(o->ptr),\textcolor{stringliteral}{" "},1,&vlen);
00934 
00935         \textcolor{comment}{/* We need a multiple of 4: <class> <hard> <soft> <soft\_seconds> */}
00936         \textcolor{keywordflow}{if} (vlen % 4) \{
00937             sdsfreesplitres(v,vlen);
00938             \textcolor{keywordflow}{goto} badfmt;
00939         \}
00940 
00941         \textcolor{comment}{/* Sanity check of single arguments, so that we either refuse the}
00942 \textcolor{comment}{         * whole configuration string or accept it all, even if a single}
00943 \textcolor{comment}{         * error in a single client class is present. */}
00944         \textcolor{keywordflow}{for} (j = 0; j < vlen; j++) \{
00945             \textcolor{keywordtype}{long} val;
00946 
00947             \textcolor{keywordflow}{if} ((j % 4) == 0) \{
00948                 \textcolor{keywordtype}{int} \textcolor{keyword}{class} = getClientTypeByName(v[j]);
00949                 \textcolor{keywordflow}{if} (\textcolor{keyword}{class} == -1 || \textcolor{keyword}{class} == \hyperlink{server_8h_ae96c04932d9a47108994d8f337fd8563}{CLIENT\_TYPE\_MASTER}) \{
00950                     sdsfreesplitres(v,vlen);
00951                     \textcolor{keywordflow}{goto} badfmt;
00952                 \}
00953             \} \textcolor{keywordflow}{else} \{
00954                 val = memtoll(v[j], &err);
00955                 \textcolor{keywordflow}{if} (err || val < 0) \{
00956                     sdsfreesplitres(v,vlen);
00957                     \textcolor{keywordflow}{goto} badfmt;
00958                 \}
00959             \}
00960         \}
00961         \textcolor{comment}{/* Finally set the new config */}
00962         \textcolor{keywordflow}{for} (j = 0; j < vlen; j += 4) \{
00963             \textcolor{keywordtype}{int} \textcolor{keyword}{class};
00964             \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{long} \textcolor{keywordtype}{long} hard, soft;
00965             \textcolor{keywordtype}{int} soft\_seconds;
00966 
00967             \textcolor{keyword}{class} = getClientTypeByName(v[j]);
00968             hard = strtoll(v[j+1],NULL,10);
00969             soft = strtoll(v[j+2],NULL,10);
00970             soft\_seconds = strtoll(v[j+3],NULL,10);
00971 
00972             server.client\_obuf\_limits[\textcolor{keyword}{class}].hard\_limit\_bytes = hard;
00973             server.client\_obuf\_limits[\textcolor{keyword}{class}].soft\_limit\_bytes = soft;
00974             server.client\_obuf\_limits[\textcolor{keyword}{class}].soft\_limit\_seconds = soft\_seconds;
00975         \}
00976         sdsfreesplitres(v,vlen);
00977     \} \hyperlink{config_8c_a7bdda941057dd2668e0e5b5df1d3ab4c}{config\_set\_special\_field}(\textcolor{stringliteral}{"notify-keyspace-events"}) \{
00978         \textcolor{keywordtype}{int} flags = keyspaceEventsStringToFlags(o->ptr);
00979 
00980         \textcolor{keywordflow}{if} (flags == -1) \textcolor{keywordflow}{goto} badfmt;
00981         server.notify\_keyspace\_events = flags;
00982     \} \hyperlink{config_8c_a7bdda941057dd2668e0e5b5df1d3ab4c}{config\_set\_special\_field}(\textcolor{stringliteral}{"slave-announce-ip"}) \{
00983         zfree(server.slave\_announce\_ip);
00984         server.slave\_announce\_ip = ((\textcolor{keywordtype}{char}*)o->ptr)[0] ? zstrdup(o->ptr) : NULL;
00985 
00986     \textcolor{comment}{/* Boolean fields.}
00987 \textcolor{comment}{     * config\_set\_bool\_field(name,var). */}
00988     \} \hyperlink{config_8c_a345bb09b35c40e88bc2e2e3c3a1db6b0}{config\_set\_bool\_field}(
00989       \textcolor{stringliteral}{"rdbcompression"}, server.rdb\_compression) \{
00990     \} \hyperlink{config_8c_a345bb09b35c40e88bc2e2e3c3a1db6b0}{config\_set\_bool\_field}(
00991       \textcolor{stringliteral}{"repl-disable-tcp-nodelay"},server.repl\_disable\_tcp\_nodelay) \{
00992     \} \hyperlink{config_8c_a345bb09b35c40e88bc2e2e3c3a1db6b0}{config\_set\_bool\_field}(
00993       \textcolor{stringliteral}{"repl-diskless-sync"},server.repl\_diskless\_sync) \{
00994     \} \hyperlink{config_8c_a345bb09b35c40e88bc2e2e3c3a1db6b0}{config\_set\_bool\_field}(
00995       \textcolor{stringliteral}{"cluster-require-full-coverage"},server.cluster\_require\_full\_coverage) \{
00996     \} \hyperlink{config_8c_a345bb09b35c40e88bc2e2e3c3a1db6b0}{config\_set\_bool\_field}(
00997       \textcolor{stringliteral}{"aof-rewrite-incremental-fsync"},server.aof\_rewrite\_incremental\_fsync) \{
00998     \} \hyperlink{config_8c_a345bb09b35c40e88bc2e2e3c3a1db6b0}{config\_set\_bool\_field}(
00999       \textcolor{stringliteral}{"aof-load-truncated"},server.aof\_load\_truncated) \{
01000     \} \hyperlink{config_8c_a345bb09b35c40e88bc2e2e3c3a1db6b0}{config\_set\_bool\_field}(
01001       \textcolor{stringliteral}{"aof-use-rdb-preamble"},server.aof\_use\_rdb\_preamble) \{
01002     \} \hyperlink{config_8c_a345bb09b35c40e88bc2e2e3c3a1db6b0}{config\_set\_bool\_field}(
01003       \textcolor{stringliteral}{"slave-serve-stale-data"},server.repl\_serve\_stale\_data) \{
01004     \} \hyperlink{config_8c_a345bb09b35c40e88bc2e2e3c3a1db6b0}{config\_set\_bool\_field}(
01005       \textcolor{stringliteral}{"slave-read-only"},server.repl\_slave\_ro) \{
01006     \} \hyperlink{config_8c_a345bb09b35c40e88bc2e2e3c3a1db6b0}{config\_set\_bool\_field}(
01007       \textcolor{stringliteral}{"activerehashing"},server.activerehashing) \{
01008     \} \hyperlink{config_8c_a345bb09b35c40e88bc2e2e3c3a1db6b0}{config\_set\_bool\_field}(
01009       \textcolor{stringliteral}{"activedefrag"},server.active\_defrag\_enabled) \{
01010 \textcolor{preprocessor}{#}\textcolor{preprocessor}{ifndef} \textcolor{preprocessor}{HAVE\_DEFRAG}
01011         \textcolor{keywordflow}{if} (server.active\_defrag\_enabled) \{
01012             server.active\_defrag\_enabled = 0;
01013             addReplyError(c,
01014                 \textcolor{stringliteral}{"Active defragmentation cannot be enabled: it requires a "}
01015                 \textcolor{stringliteral}{"Redis server compiled with a modified Jemalloc like the "}
01016                 \textcolor{stringliteral}{"one shipped by default with the Redis source distribution"});
01017             \textcolor{keywordflow}{return};
01018         \}
01019 \textcolor{preprocessor}{#}\textcolor{preprocessor}{endif}
01020     \} \hyperlink{config_8c_a345bb09b35c40e88bc2e2e3c3a1db6b0}{config\_set\_bool\_field}(
01021       \textcolor{stringliteral}{"protected-mode"},server.protected\_mode) \{
01022     \} \hyperlink{config_8c_a345bb09b35c40e88bc2e2e3c3a1db6b0}{config\_set\_bool\_field}(
01023       \textcolor{stringliteral}{"stop-writes-on-bgsave-error"},server.stop\_writes\_on\_bgsave\_err) \{
01024     \} \hyperlink{config_8c_a345bb09b35c40e88bc2e2e3c3a1db6b0}{config\_set\_bool\_field}(
01025       \textcolor{stringliteral}{"lazyfree-lazy-eviction"},server.lazyfree\_lazy\_eviction) \{
01026     \} \hyperlink{config_8c_a345bb09b35c40e88bc2e2e3c3a1db6b0}{config\_set\_bool\_field}(
01027       \textcolor{stringliteral}{"lazyfree-lazy-expire"},server.lazyfree\_lazy\_expire) \{
01028     \} \hyperlink{config_8c_a345bb09b35c40e88bc2e2e3c3a1db6b0}{config\_set\_bool\_field}(
01029       \textcolor{stringliteral}{"lazyfree-lazy-server-del"},server.lazyfree\_lazy\_server\_del) \{
01030     \} \hyperlink{config_8c_a345bb09b35c40e88bc2e2e3c3a1db6b0}{config\_set\_bool\_field}(
01031       \textcolor{stringliteral}{"slave-lazy-flush"},server.repl\_slave\_lazy\_flush) \{
01032     \} \hyperlink{config_8c_a345bb09b35c40e88bc2e2e3c3a1db6b0}{config\_set\_bool\_field}(
01033       \textcolor{stringliteral}{"no-appendfsync-on-rewrite"},server.aof\_no\_fsync\_on\_rewrite) \{
01034 
01035     \textcolor{comment}{/* Numerical fields.}
01036 \textcolor{comment}{     * config\_set\_numerical\_field(name,var,min,max) */}
01037     \} \hyperlink{config_8c_aba8f21b37a3e47952951cf4bd15ad296}{config\_set\_numerical\_field}(
01038       \textcolor{stringliteral}{"tcp-keepalive"},server.tcpkeepalive,0,LLONG\_MAX) \{
01039     \} \hyperlink{config_8c_aba8f21b37a3e47952951cf4bd15ad296}{config\_set\_numerical\_field}(
01040       \textcolor{stringliteral}{"maxmemory-samples"},server.maxmemory\_samples,1,LLONG\_MAX) \{
01041     \} \hyperlink{config_8c_aba8f21b37a3e47952951cf4bd15ad296}{config\_set\_numerical\_field}(
01042       \textcolor{stringliteral}{"lfu-log-factor"},server.lfu\_log\_factor,0,LLONG\_MAX) \{
01043     \} \hyperlink{config_8c_aba8f21b37a3e47952951cf4bd15ad296}{config\_set\_numerical\_field}(
01044       \textcolor{stringliteral}{"lfu-decay-time"},server.lfu\_decay\_time,0,LLONG\_MAX) \{
01045     \} \hyperlink{config_8c_aba8f21b37a3e47952951cf4bd15ad296}{config\_set\_numerical\_field}(
01046       \textcolor{stringliteral}{"timeout"},server.maxidletime,0,LONG\_MAX) \{
01047     \} \hyperlink{config_8c_aba8f21b37a3e47952951cf4bd15ad296}{config\_set\_numerical\_field}(
01048       \textcolor{stringliteral}{"active-defrag-threshold-lower"},server.active\_defrag\_threshold\_lower,0,1000) \{
01049     \} \hyperlink{config_8c_aba8f21b37a3e47952951cf4bd15ad296}{config\_set\_numerical\_field}(
01050       \textcolor{stringliteral}{"active-defrag-threshold-upper"},server.active\_defrag\_threshold\_upper,0,1000) \{
01051     \} \hyperlink{config_8c_ae9b891f5f43617ea158d55f449285b7d}{config\_set\_memory\_field}(
01052       \textcolor{stringliteral}{"active-defrag-ignore-bytes"},server.active\_defrag\_ignore\_bytes) \{
01053     \} \hyperlink{config_8c_aba8f21b37a3e47952951cf4bd15ad296}{config\_set\_numerical\_field}(
01054       \textcolor{stringliteral}{"active-defrag-cycle-min"},server.active\_defrag\_cycle\_min,1,99) \{
01055     \} \hyperlink{config_8c_aba8f21b37a3e47952951cf4bd15ad296}{config\_set\_numerical\_field}(
01056       \textcolor{stringliteral}{"active-defrag-cycle-max"},server.active\_defrag\_cycle\_max,1,99) \{
01057     \} \hyperlink{config_8c_aba8f21b37a3e47952951cf4bd15ad296}{config\_set\_numerical\_field}(
01058       \textcolor{stringliteral}{"auto-aof-rewrite-percentage"},server.aof\_rewrite\_perc,0,LLONG\_MAX)\{
01059     \} \hyperlink{config_8c_aba8f21b37a3e47952951cf4bd15ad296}{config\_set\_numerical\_field}(
01060       \textcolor{stringliteral}{"hash-max-ziplist-entries"},server.hash\_max\_ziplist\_entries,0,LLONG\_MAX) \{
01061     \} \hyperlink{config_8c_aba8f21b37a3e47952951cf4bd15ad296}{config\_set\_numerical\_field}(
01062       \textcolor{stringliteral}{"hash-max-ziplist-value"},server.hash\_max\_ziplist\_value,0,LLONG\_MAX) \{
01063     \} \hyperlink{config_8c_aba8f21b37a3e47952951cf4bd15ad296}{config\_set\_numerical\_field}(
01064       \textcolor{stringliteral}{"list-max-ziplist-size"},server.list\_max\_ziplist\_size,INT\_MIN,INT\_MAX) \{
01065     \} \hyperlink{config_8c_aba8f21b37a3e47952951cf4bd15ad296}{config\_set\_numerical\_field}(
01066       \textcolor{stringliteral}{"list-compress-depth"},server.list\_compress\_depth,0,INT\_MAX) \{
01067     \} \hyperlink{config_8c_aba8f21b37a3e47952951cf4bd15ad296}{config\_set\_numerical\_field}(
01068       \textcolor{stringliteral}{"set-max-intset-entries"},server.set\_max\_intset\_entries,0,LLONG\_MAX) \{
01069     \} \hyperlink{config_8c_aba8f21b37a3e47952951cf4bd15ad296}{config\_set\_numerical\_field}(
01070       \textcolor{stringliteral}{"zset-max-ziplist-entries"},server.zset\_max\_ziplist\_entries,0,LLONG\_MAX) \{
01071     \} \hyperlink{config_8c_aba8f21b37a3e47952951cf4bd15ad296}{config\_set\_numerical\_field}(
01072       \textcolor{stringliteral}{"zset-max-ziplist-value"},server.zset\_max\_ziplist\_value,0,LLONG\_MAX) \{
01073     \} \hyperlink{config_8c_aba8f21b37a3e47952951cf4bd15ad296}{config\_set\_numerical\_field}(
01074       \textcolor{stringliteral}{"hll-sparse-max-bytes"},server.hll\_sparse\_max\_bytes,0,LLONG\_MAX) \{
01075     \} \hyperlink{config_8c_aba8f21b37a3e47952951cf4bd15ad296}{config\_set\_numerical\_field}(
01076       \textcolor{stringliteral}{"lua-time-limit"},server.lua\_time\_limit,0,LLONG\_MAX) \{
01077     \} \hyperlink{config_8c_aba8f21b37a3e47952951cf4bd15ad296}{config\_set\_numerical\_field}(
01078       \textcolor{stringliteral}{"slowlog-log-slower-than"},server.slowlog\_log\_slower\_than,0,LLONG\_MAX) \{
01079     \} \hyperlink{config_8c_aba8f21b37a3e47952951cf4bd15ad296}{config\_set\_numerical\_field}(
01080       \textcolor{stringliteral}{"slowlog-max-len"},ll,0,LLONG\_MAX) \{
01081       \textcolor{comment}{/* Cast to unsigned. */}
01082         server.slowlog\_max\_len = (\textcolor{keywordtype}{unsigned})ll;
01083     \} \hyperlink{config_8c_aba8f21b37a3e47952951cf4bd15ad296}{config\_set\_numerical\_field}(
01084       \textcolor{stringliteral}{"latency-monitor-threshold"},server.latency\_monitor\_threshold,0,LLONG\_MAX)\{
01085     \} \hyperlink{config_8c_aba8f21b37a3e47952951cf4bd15ad296}{config\_set\_numerical\_field}(
01086       \textcolor{stringliteral}{"repl-ping-slave-period"},server.repl\_ping\_slave\_period,1,LLONG\_MAX) \{
01087     \} \hyperlink{config_8c_aba8f21b37a3e47952951cf4bd15ad296}{config\_set\_numerical\_field}(
01088       \textcolor{stringliteral}{"repl-timeout"},server.repl\_timeout,1,LLONG\_MAX) \{
01089     \} \hyperlink{config_8c_aba8f21b37a3e47952951cf4bd15ad296}{config\_set\_numerical\_field}(
01090       \textcolor{stringliteral}{"repl-backlog-ttl"},server.repl\_backlog\_time\_limit,0,LLONG\_MAX) \{
01091     \} \hyperlink{config_8c_aba8f21b37a3e47952951cf4bd15ad296}{config\_set\_numerical\_field}(
01092       \textcolor{stringliteral}{"repl-diskless-sync-delay"},server.repl\_diskless\_sync\_delay,0,LLONG\_MAX) \{
01093     \} \hyperlink{config_8c_aba8f21b37a3e47952951cf4bd15ad296}{config\_set\_numerical\_field}(
01094       \textcolor{stringliteral}{"slave-priority"},server.slave\_priority,0,LLONG\_MAX) \{
01095     \} \hyperlink{config_8c_aba8f21b37a3e47952951cf4bd15ad296}{config\_set\_numerical\_field}(
01096       \textcolor{stringliteral}{"slave-announce-port"},server.slave\_announce\_port,0,65535) \{
01097     \} \hyperlink{config_8c_aba8f21b37a3e47952951cf4bd15ad296}{config\_set\_numerical\_field}(
01098       \textcolor{stringliteral}{"min-slaves-to-write"},server.repl\_min\_slaves\_to\_write,0,LLONG\_MAX) \{
01099         refreshGoodSlavesCount();
01100     \} \hyperlink{config_8c_aba8f21b37a3e47952951cf4bd15ad296}{config\_set\_numerical\_field}(
01101       \textcolor{stringliteral}{"min-slaves-max-lag"},server.repl\_min\_slaves\_max\_lag,0,LLONG\_MAX) \{
01102         refreshGoodSlavesCount();
01103     \} \hyperlink{config_8c_aba8f21b37a3e47952951cf4bd15ad296}{config\_set\_numerical\_field}(
01104       \textcolor{stringliteral}{"cluster-node-timeout"},server.cluster\_node\_timeout,0,LLONG\_MAX) \{
01105     \} \hyperlink{config_8c_aba8f21b37a3e47952951cf4bd15ad296}{config\_set\_numerical\_field}(
01106       \textcolor{stringliteral}{"cluster-announce-port"},server.cluster\_announce\_port,0,65535) \{
01107     \} \hyperlink{config_8c_aba8f21b37a3e47952951cf4bd15ad296}{config\_set\_numerical\_field}(
01108       \textcolor{stringliteral}{"cluster-announce-bus-port"},server.cluster\_announce\_bus\_port,0,65535) \{
01109     \} \hyperlink{config_8c_aba8f21b37a3e47952951cf4bd15ad296}{config\_set\_numerical\_field}(
01110       \textcolor{stringliteral}{"cluster-migration-barrier"},server.cluster\_migration\_barrier,0,LLONG\_MAX)\{
01111     \} \hyperlink{config_8c_aba8f21b37a3e47952951cf4bd15ad296}{config\_set\_numerical\_field}(
01112       \textcolor{stringliteral}{"cluster-slave-validity-factor"},server.cluster\_slave\_validity\_factor,0,LLONG\_MAX) \{
01113     \} \hyperlink{config_8c_aba8f21b37a3e47952951cf4bd15ad296}{config\_set\_numerical\_field}(
01114       \textcolor{stringliteral}{"hz"},server.hz,0,LLONG\_MAX) \{
01115         \textcolor{comment}{/* Hz is more an hint from the user, so we accept values out of range}
01116 \textcolor{comment}{         * but cap them to reasonable values. */}
01117         \textcolor{keywordflow}{if} (server.hz < \hyperlink{server_8h_aba98a7c0e14b8f68e19c43e3e0334fc2}{CONFIG\_MIN\_HZ}) server.hz = 
      \hyperlink{server_8h_aba98a7c0e14b8f68e19c43e3e0334fc2}{CONFIG\_MIN\_HZ};
01118         \textcolor{keywordflow}{if} (server.hz > \hyperlink{server_8h_a39e5c16e64adef2e14a9d66a725b91fd}{CONFIG\_MAX\_HZ}) server.hz = 
      \hyperlink{server_8h_a39e5c16e64adef2e14a9d66a725b91fd}{CONFIG\_MAX\_HZ};
01119     \} \hyperlink{config_8c_aba8f21b37a3e47952951cf4bd15ad296}{config\_set\_numerical\_field}(
01120       \textcolor{stringliteral}{"watchdog-period"},ll,0,LLONG\_MAX) \{
01121         \textcolor{keywordflow}{if} (ll)
01122             enableWatchdog(ll);
01123         \textcolor{keywordflow}{else}
01124             disableWatchdog();
01125 
01126     \textcolor{comment}{/* Memory fields.}
01127 \textcolor{comment}{     * config\_set\_memory\_field(name,var) */}
01128     \} \hyperlink{config_8c_ae9b891f5f43617ea158d55f449285b7d}{config\_set\_memory\_field}(\textcolor{stringliteral}{"maxmemory"},server.maxmemory) \{
01129         \textcolor{keywordflow}{if} (server.maxmemory) \{
01130             \textcolor{keywordflow}{if} (server.maxmemory < zmalloc\_used\_memory()) \{
01131                 serverLog(\hyperlink{server_8h_a31229b9334bba7d6be2a72970967a14b}{LL\_WARNING},\textcolor{stringliteral}{"WARNING: the new maxmemory value set via CONFIG SET is
       smaller than the current memory usage. This will result in keys eviction and/or inability to accept new
       write commands depending on the maxmemory-policy."});
01132             \}
01133             freeMemoryIfNeeded();
01134         \}
01135     \} \hyperlink{config_8c_ae9b891f5f43617ea158d55f449285b7d}{config\_set\_memory\_field}(\textcolor{stringliteral}{"repl-backlog-size"},ll) \{
01136         resizeReplicationBacklog(ll);
01137     \} \hyperlink{config_8c_ae9b891f5f43617ea158d55f449285b7d}{config\_set\_memory\_field}(\textcolor{stringliteral}{"auto-aof-rewrite-min-size"},ll) \{
01138         server.aof\_rewrite\_min\_size = ll;
01139 
01140     \textcolor{comment}{/* Enumeration fields.}
01141 \textcolor{comment}{     * config\_set\_enum\_field(name,var,enum\_var) */}
01142     \} \hyperlink{config_8c_a57a2639202841d0e66af977ef0f3bc66}{config\_set\_enum\_field}(
01143       \textcolor{stringliteral}{"loglevel"},server.verbosity,loglevel\_enum) \{
01144     \} \hyperlink{config_8c_a57a2639202841d0e66af977ef0f3bc66}{config\_set\_enum\_field}(
01145       \textcolor{stringliteral}{"maxmemory-policy"},server.maxmemory\_policy,maxmemory\_policy\_enum) \{
01146     \} \hyperlink{config_8c_a57a2639202841d0e66af977ef0f3bc66}{config\_set\_enum\_field}(
01147       \textcolor{stringliteral}{"appendfsync"},server.\hyperlink{config_8h_af5994c643c434574580bb7816af82cad}{aof\_fsync},aof\_fsync\_enum) \{
01148 
01149     \textcolor{comment}{/* Everyhing else is an error... */}
01150     \} \hyperlink{config_8c_acf8c5da6434cc641a95acc8fca27b971}{config\_set\_else} \{
01151         addReplyErrorFormat(c,\textcolor{stringliteral}{"Unsupported CONFIG parameter: %s"},
01152             (\textcolor{keywordtype}{char}*)c->argv[2]->ptr);
01153         \textcolor{keywordflow}{return};
01154     \}
01155 
01156     \textcolor{comment}{/* On success we just return a generic OK for all the options. */}
01157     addReply(c,shared.ok);
01158     \textcolor{keywordflow}{return};
01159 
01160 badfmt: \textcolor{comment}{/* Bad format errors */}
01161     addReplyErrorFormat(c,\textcolor{stringliteral}{"Invalid argument '%s' for CONFIG SET '%s'"},
01162             (\textcolor{keywordtype}{char}*)o->ptr,
01163             (\textcolor{keywordtype}{char}*)c->argv[2]->ptr);
01164 \}
01165 
01166 \textcolor{comment}{/*-----------------------------------------------------------------------------}
01167 \textcolor{comment}{ * CONFIG GET implementation}
01168 \textcolor{comment}{ *----------------------------------------------------------------------------*/}
01169 
01170 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{config\_get\_string\_field}\textcolor{preprocessor}{(}\textcolor{preprocessor}{\_name}\textcolor{preprocessor}{,}\textcolor{preprocessor}{\_var}\textcolor{preprocessor}{)} \textcolor{keywordflow}{do} \textcolor{preprocessor}{\{}
01171     \textcolor{keywordflow}{if} \textcolor{preprocessor}{(}\textcolor{preprocessor}{stringmatch}\textcolor{preprocessor}{(}\textcolor{preprocessor}{pattern}\textcolor{preprocessor}{,}\textcolor{preprocessor}{\_name}\textcolor{preprocessor}{,}1\textcolor{preprocessor}{)}\textcolor{preprocessor}{)} \textcolor{preprocessor}{\{}
01172         \textcolor{preprocessor}{addReplyBulkCString}\textcolor{preprocessor}{(}\textcolor{preprocessor}{c}\textcolor{preprocessor}{,}\textcolor{preprocessor}{\_name}\textcolor{preprocessor}{)}\textcolor{preprocessor}{;}
01173         \textcolor{preprocessor}{addReplyBulkCString}\textcolor{preprocessor}{(}\textcolor{preprocessor}{c}\textcolor{preprocessor}{,}\textcolor{preprocessor}{\_var} \textcolor{preprocessor}{?} \textcolor{preprocessor}{\_var} \textcolor{preprocessor}{:} \textcolor{stringliteral}{""}\textcolor{preprocessor}{)}\textcolor{preprocessor}{;}
01174         \textcolor{preprocessor}{matches}\textcolor{preprocessor}{++}\textcolor{preprocessor}{;}
01175     \textcolor{preprocessor}{\}} \textcolor{preprocessor}{\(\backslash\)}
01176 \textcolor{preprocessor}{\}}\textcolor{keywordflow}{while}\textcolor{preprocessor}{(}0\textcolor{preprocessor}{)}\textcolor{preprocessor}{;}
01177 
01178 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{config\_get\_bool\_field}\textcolor{preprocessor}{(}\textcolor{preprocessor}{\_name}\textcolor{preprocessor}{,}\textcolor{preprocessor}{\_var}\textcolor{preprocessor}{)} \textcolor{keywordflow}{do} \textcolor{preprocessor}{\{}
01179     \textcolor{keywordflow}{if} \textcolor{preprocessor}{(}\textcolor{preprocessor}{stringmatch}\textcolor{preprocessor}{(}\textcolor{preprocessor}{pattern}\textcolor{preprocessor}{,}\textcolor{preprocessor}{\_name}\textcolor{preprocessor}{,}1\textcolor{preprocessor}{)}\textcolor{preprocessor}{)} \textcolor{preprocessor}{\{}
01180         \textcolor{preprocessor}{addReplyBulkCString}\textcolor{preprocessor}{(}\textcolor{preprocessor}{c}\textcolor{preprocessor}{,}\textcolor{preprocessor}{\_name}\textcolor{preprocessor}{)}\textcolor{preprocessor}{;}
01181         \textcolor{preprocessor}{addReplyBulkCString}\textcolor{preprocessor}{(}\textcolor{preprocessor}{c}\textcolor{preprocessor}{,}\textcolor{preprocessor}{\_var} \textcolor{preprocessor}{?} \textcolor{stringliteral}{"yes"} \textcolor{preprocessor}{:} \textcolor{stringliteral}{"no"}\textcolor{preprocessor}{)}\textcolor{preprocessor}{;}
01182         \textcolor{preprocessor}{matches}\textcolor{preprocessor}{++}\textcolor{preprocessor}{;}
01183     \textcolor{preprocessor}{\}} \textcolor{preprocessor}{\(\backslash\)}
01184 \textcolor{preprocessor}{\}}\textcolor{keywordflow}{while}\textcolor{preprocessor}{(}0\textcolor{preprocessor}{)}\textcolor{preprocessor}{;}
01185 
01186 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{config\_get\_numerical\_field}\textcolor{preprocessor}{(}\textcolor{preprocessor}{\_name}\textcolor{preprocessor}{,}\textcolor{preprocessor}{\_var}\textcolor{preprocessor}{)} \textcolor{keywordflow}{do} \textcolor{preprocessor}{\{}
01187     \textcolor{keywordflow}{if} \textcolor{preprocessor}{(}\textcolor{preprocessor}{stringmatch}\textcolor{preprocessor}{(}\textcolor{preprocessor}{pattern}\textcolor{preprocessor}{,}\textcolor{preprocessor}{\_name}\textcolor{preprocessor}{,}1\textcolor{preprocessor}{)}\textcolor{preprocessor}{)} \textcolor{preprocessor}{\{}
01188         \textcolor{preprocessor}{ll2string}\textcolor{preprocessor}{(}\textcolor{preprocessor}{buf}\textcolor{preprocessor}{,}\textcolor{keyword}{sizeof}\textcolor{preprocessor}{(}\textcolor{preprocessor}{buf}\textcolor{preprocessor}{)}\textcolor{preprocessor}{,}\textcolor{preprocessor}{\_var}\textcolor{preprocessor}{)}\textcolor{preprocessor}{;}
01189         \textcolor{preprocessor}{addReplyBulkCString}\textcolor{preprocessor}{(}\textcolor{preprocessor}{c}\textcolor{preprocessor}{,}\textcolor{preprocessor}{\_name}\textcolor{preprocessor}{)}\textcolor{preprocessor}{;}
01190         \textcolor{preprocessor}{addReplyBulkCString}\textcolor{preprocessor}{(}\textcolor{preprocessor}{c}\textcolor{preprocessor}{,}\textcolor{preprocessor}{buf}\textcolor{preprocessor}{)}\textcolor{preprocessor}{;}
01191         \textcolor{preprocessor}{matches}\textcolor{preprocessor}{++}\textcolor{preprocessor}{;}
01192     \textcolor{preprocessor}{\}} \textcolor{preprocessor}{\(\backslash\)}
01193 \textcolor{preprocessor}{\}}\textcolor{keywordflow}{while}\textcolor{preprocessor}{(}0\textcolor{preprocessor}{)}\textcolor{preprocessor}{;}
01194 
01195 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{config\_get\_enum\_field}\textcolor{preprocessor}{(}\textcolor{preprocessor}{\_name}\textcolor{preprocessor}{,}\textcolor{preprocessor}{\_var}\textcolor{preprocessor}{,}\textcolor{preprocessor}{\_enumvar}\textcolor{preprocessor}{)} \textcolor{keywordflow}{do} \textcolor{preprocessor}{\{}
01196     \textcolor{keywordflow}{if} \textcolor{preprocessor}{(}\textcolor{preprocessor}{stringmatch}\textcolor{preprocessor}{(}\textcolor{preprocessor}{pattern}\textcolor{preprocessor}{,}\textcolor{preprocessor}{\_name}\textcolor{preprocessor}{,}1\textcolor{preprocessor}{)}\textcolor{preprocessor}{)} \textcolor{preprocessor}{\{}
01197         \textcolor{preprocessor}{addReplyBulkCString}\textcolor{preprocessor}{(}\textcolor{preprocessor}{c}\textcolor{preprocessor}{,}\textcolor{preprocessor}{\_name}\textcolor{preprocessor}{)}\textcolor{preprocessor}{;}
01198         \textcolor{preprocessor}{addReplyBulkCString}\textcolor{preprocessor}{(}\textcolor{preprocessor}{c}\textcolor{preprocessor}{,}\textcolor{preprocessor}{configEnumGetNameOrUnknown}\textcolor{preprocessor}{(}\textcolor{preprocessor}{\_enumvar}\textcolor{preprocessor}{,}\textcolor{preprocessor}{\_var}\textcolor{preprocessor}{)}\textcolor{preprocessor}{)}\textcolor{preprocessor}{;}
01199         \textcolor{preprocessor}{matches}\textcolor{preprocessor}{++}\textcolor{preprocessor}{;}
01200     \textcolor{preprocessor}{\}} \textcolor{preprocessor}{\(\backslash\)}
01201 \textcolor{preprocessor}{\}}\textcolor{keywordflow}{while}\textcolor{preprocessor}{(}0\textcolor{preprocessor}{)}\textcolor{preprocessor}{;}
01202 
01203 \textcolor{keywordtype}{void} configGetCommand(\hyperlink{structclient}{client} *c) \{
01204     robj *o = c->argv[2];
01205     \textcolor{keywordtype}{void} *replylen = addDeferredMultiBulkLength(c);
01206     \textcolor{keywordtype}{char} *pattern = o->ptr;
01207     \textcolor{keywordtype}{char} buf[128];
01208     \textcolor{keywordtype}{int} matches = 0;
01209     \hyperlink{server_8h_a7308f76cbff9a8d3797fe78190b91282}{serverAssertWithInfo}(c,o,\hyperlink{server_8h_afcfb5bd97af52d1dbce331745cae030c}{sdsEncodedObject}(o));
01210 
01211     \textcolor{comment}{/* String values */}
01212     \hyperlink{config_8c_a88a85229639d42e707850d558522da27}{config\_get\_string\_field}(\textcolor{stringliteral}{"dbfilename"},server.rdb\_filename);
01213     \hyperlink{config_8c_a88a85229639d42e707850d558522da27}{config\_get\_string\_field}(\textcolor{stringliteral}{"requirepass"},server.requirepass);
01214     \hyperlink{config_8c_a88a85229639d42e707850d558522da27}{config\_get\_string\_field}(\textcolor{stringliteral}{"masterauth"},server.masterauth);
01215     \hyperlink{config_8c_a88a85229639d42e707850d558522da27}{config\_get\_string\_field}(\textcolor{stringliteral}{"cluster-announce-ip"},server.cluster\_announce\_ip);
01216     \hyperlink{config_8c_a88a85229639d42e707850d558522da27}{config\_get\_string\_field}(\textcolor{stringliteral}{"unixsocket"},server.unixsocket);
01217     \hyperlink{config_8c_a88a85229639d42e707850d558522da27}{config\_get\_string\_field}(\textcolor{stringliteral}{"logfile"},server.logfile);
01218     \hyperlink{config_8c_a88a85229639d42e707850d558522da27}{config\_get\_string\_field}(\textcolor{stringliteral}{"pidfile"},server.pidfile);
01219     \hyperlink{config_8c_a88a85229639d42e707850d558522da27}{config\_get\_string\_field}(\textcolor{stringliteral}{"slave-announce-ip"},server.slave\_announce\_ip);
01220 
01221     \textcolor{comment}{/* Numerical values */}
01222     \hyperlink{config_8c_ac10aa922264623cceca62df3262920c6}{config\_get\_numerical\_field}(\textcolor{stringliteral}{"maxmemory"},server.maxmemory);
01223     \hyperlink{config_8c_ac10aa922264623cceca62df3262920c6}{config\_get\_numerical\_field}(\textcolor{stringliteral}{"maxmemory-samples"},server.maxmemory\_samples)
      ;
01224     \hyperlink{config_8c_ac10aa922264623cceca62df3262920c6}{config\_get\_numerical\_field}(\textcolor{stringliteral}{"lfu-log-factor"},server.lfu\_log\_factor);
01225     \hyperlink{config_8c_ac10aa922264623cceca62df3262920c6}{config\_get\_numerical\_field}(\textcolor{stringliteral}{"lfu-decay-time"},server.lfu\_decay\_time);
01226     \hyperlink{config_8c_ac10aa922264623cceca62df3262920c6}{config\_get\_numerical\_field}(\textcolor{stringliteral}{"timeout"},server.maxidletime);
01227     \hyperlink{config_8c_ac10aa922264623cceca62df3262920c6}{config\_get\_numerical\_field}(\textcolor{stringliteral}{"active-defrag-threshold-lower"},server.
      active\_defrag\_threshold\_lower);
01228     \hyperlink{config_8c_ac10aa922264623cceca62df3262920c6}{config\_get\_numerical\_field}(\textcolor{stringliteral}{"active-defrag-threshold-upper"},server.
      active\_defrag\_threshold\_upper);
01229     \hyperlink{config_8c_ac10aa922264623cceca62df3262920c6}{config\_get\_numerical\_field}(\textcolor{stringliteral}{"active-defrag-ignore-bytes"},server.
      active\_defrag\_ignore\_bytes);
01230     \hyperlink{config_8c_ac10aa922264623cceca62df3262920c6}{config\_get\_numerical\_field}(\textcolor{stringliteral}{"active-defrag-cycle-min"},server.
      active\_defrag\_cycle\_min);
01231     \hyperlink{config_8c_ac10aa922264623cceca62df3262920c6}{config\_get\_numerical\_field}(\textcolor{stringliteral}{"active-defrag-cycle-max"},server.
      active\_defrag\_cycle\_max);
01232     \hyperlink{config_8c_ac10aa922264623cceca62df3262920c6}{config\_get\_numerical\_field}(\textcolor{stringliteral}{"auto-aof-rewrite-percentage"},
01233             server.aof\_rewrite\_perc);
01234     \hyperlink{config_8c_ac10aa922264623cceca62df3262920c6}{config\_get\_numerical\_field}(\textcolor{stringliteral}{"auto-aof-rewrite-min-size"},
01235             server.aof\_rewrite\_min\_size);
01236     \hyperlink{config_8c_ac10aa922264623cceca62df3262920c6}{config\_get\_numerical\_field}(\textcolor{stringliteral}{"hash-max-ziplist-entries"},
01237             server.hash\_max\_ziplist\_entries);
01238     \hyperlink{config_8c_ac10aa922264623cceca62df3262920c6}{config\_get\_numerical\_field}(\textcolor{stringliteral}{"hash-max-ziplist-value"},
01239             server.hash\_max\_ziplist\_value);
01240     \hyperlink{config_8c_ac10aa922264623cceca62df3262920c6}{config\_get\_numerical\_field}(\textcolor{stringliteral}{"list-max-ziplist-size"},
01241             server.list\_max\_ziplist\_size);
01242     \hyperlink{config_8c_ac10aa922264623cceca62df3262920c6}{config\_get\_numerical\_field}(\textcolor{stringliteral}{"list-compress-depth"},
01243             server.list\_compress\_depth);
01244     \hyperlink{config_8c_ac10aa922264623cceca62df3262920c6}{config\_get\_numerical\_field}(\textcolor{stringliteral}{"set-max-intset-entries"},
01245             server.set\_max\_intset\_entries);
01246     \hyperlink{config_8c_ac10aa922264623cceca62df3262920c6}{config\_get\_numerical\_field}(\textcolor{stringliteral}{"zset-max-ziplist-entries"},
01247             server.zset\_max\_ziplist\_entries);
01248     \hyperlink{config_8c_ac10aa922264623cceca62df3262920c6}{config\_get\_numerical\_field}(\textcolor{stringliteral}{"zset-max-ziplist-value"},
01249             server.zset\_max\_ziplist\_value);
01250     \hyperlink{config_8c_ac10aa922264623cceca62df3262920c6}{config\_get\_numerical\_field}(\textcolor{stringliteral}{"hll-sparse-max-bytes"},
01251             server.hll\_sparse\_max\_bytes);
01252     \hyperlink{config_8c_ac10aa922264623cceca62df3262920c6}{config\_get\_numerical\_field}(\textcolor{stringliteral}{"lua-time-limit"},server.lua\_time\_limit);
01253     \hyperlink{config_8c_ac10aa922264623cceca62df3262920c6}{config\_get\_numerical\_field}(\textcolor{stringliteral}{"slowlog-log-slower-than"},
01254             server.slowlog\_log\_slower\_than);
01255     \hyperlink{config_8c_ac10aa922264623cceca62df3262920c6}{config\_get\_numerical\_field}(\textcolor{stringliteral}{"latency-monitor-threshold"},
01256             server.latency\_monitor\_threshold);
01257     \hyperlink{config_8c_ac10aa922264623cceca62df3262920c6}{config\_get\_numerical\_field}(\textcolor{stringliteral}{"slowlog-max-len"},
01258             server.slowlog\_max\_len);
01259     \hyperlink{config_8c_ac10aa922264623cceca62df3262920c6}{config\_get\_numerical\_field}(\textcolor{stringliteral}{"port"},server.port);
01260     \hyperlink{config_8c_ac10aa922264623cceca62df3262920c6}{config\_get\_numerical\_field}(\textcolor{stringliteral}{"cluster-announce-port"},server.
      cluster\_announce\_port);
01261     \hyperlink{config_8c_ac10aa922264623cceca62df3262920c6}{config\_get\_numerical\_field}(\textcolor{stringliteral}{"cluster-announce-bus-port"},server.
      cluster\_announce\_bus\_port);
01262     \hyperlink{config_8c_ac10aa922264623cceca62df3262920c6}{config\_get\_numerical\_field}(\textcolor{stringliteral}{"tcp-backlog"},server.tcp\_backlog);
01263     \hyperlink{config_8c_ac10aa922264623cceca62df3262920c6}{config\_get\_numerical\_field}(\textcolor{stringliteral}{"databases"},server.dbnum);
01264     \hyperlink{config_8c_ac10aa922264623cceca62df3262920c6}{config\_get\_numerical\_field}(\textcolor{stringliteral}{"repl-ping-slave-period"},server.
      repl\_ping\_slave\_period);
01265     \hyperlink{config_8c_ac10aa922264623cceca62df3262920c6}{config\_get\_numerical\_field}(\textcolor{stringliteral}{"repl-timeout"},server.repl\_timeout);
01266     \hyperlink{config_8c_ac10aa922264623cceca62df3262920c6}{config\_get\_numerical\_field}(\textcolor{stringliteral}{"repl-backlog-size"},server.repl\_backlog\_size)
      ;
01267     \hyperlink{config_8c_ac10aa922264623cceca62df3262920c6}{config\_get\_numerical\_field}(\textcolor{stringliteral}{"repl-backlog-ttl"},server.
      repl\_backlog\_time\_limit);
01268     \hyperlink{config_8c_ac10aa922264623cceca62df3262920c6}{config\_get\_numerical\_field}(\textcolor{stringliteral}{"maxclients"},server.maxclients);
01269     \hyperlink{config_8c_ac10aa922264623cceca62df3262920c6}{config\_get\_numerical\_field}(\textcolor{stringliteral}{"watchdog-period"},server.watchdog\_period);
01270     \hyperlink{config_8c_ac10aa922264623cceca62df3262920c6}{config\_get\_numerical\_field}(\textcolor{stringliteral}{"slave-priority"},server.slave\_priority);
01271     \hyperlink{config_8c_ac10aa922264623cceca62df3262920c6}{config\_get\_numerical\_field}(\textcolor{stringliteral}{"slave-announce-port"},server.
      slave\_announce\_port);
01272     \hyperlink{config_8c_ac10aa922264623cceca62df3262920c6}{config\_get\_numerical\_field}(\textcolor{stringliteral}{"min-slaves-to-write"},server.
      repl\_min\_slaves\_to\_write);
01273     \hyperlink{config_8c_ac10aa922264623cceca62df3262920c6}{config\_get\_numerical\_field}(\textcolor{stringliteral}{"min-slaves-max-lag"},server.
      repl\_min\_slaves\_max\_lag);
01274     \hyperlink{config_8c_ac10aa922264623cceca62df3262920c6}{config\_get\_numerical\_field}(\textcolor{stringliteral}{"hz"},server.hz);
01275     \hyperlink{config_8c_ac10aa922264623cceca62df3262920c6}{config\_get\_numerical\_field}(\textcolor{stringliteral}{"cluster-node-timeout"},server.
      cluster\_node\_timeout);
01276     \hyperlink{config_8c_ac10aa922264623cceca62df3262920c6}{config\_get\_numerical\_field}(\textcolor{stringliteral}{"cluster-migration-barrier"},server.
      cluster\_migration\_barrier);
01277     \hyperlink{config_8c_ac10aa922264623cceca62df3262920c6}{config\_get\_numerical\_field}(\textcolor{stringliteral}{"cluster-slave-validity-factor"},server.
      cluster\_slave\_validity\_factor);
01278     \hyperlink{config_8c_ac10aa922264623cceca62df3262920c6}{config\_get\_numerical\_field}(\textcolor{stringliteral}{"repl-diskless-sync-delay"},server.
      repl\_diskless\_sync\_delay);
01279     \hyperlink{config_8c_ac10aa922264623cceca62df3262920c6}{config\_get\_numerical\_field}(\textcolor{stringliteral}{"tcp-keepalive"},server.tcpkeepalive);
01280 
01281     \textcolor{comment}{/* Bool (yes/no) values */}
01282     \hyperlink{config_8c_a7dbc6f4e538d2db2aa10ae47511d6c92}{config\_get\_bool\_field}(\textcolor{stringliteral}{"cluster-require-full-coverage"},
01283             server.cluster\_require\_full\_coverage);
01284     \hyperlink{config_8c_a7dbc6f4e538d2db2aa10ae47511d6c92}{config\_get\_bool\_field}(\textcolor{stringliteral}{"no-appendfsync-on-rewrite"},
01285             server.aof\_no\_fsync\_on\_rewrite);
01286     \hyperlink{config_8c_a7dbc6f4e538d2db2aa10ae47511d6c92}{config\_get\_bool\_field}(\textcolor{stringliteral}{"slave-serve-stale-data"},
01287             server.repl\_serve\_stale\_data);
01288     \hyperlink{config_8c_a7dbc6f4e538d2db2aa10ae47511d6c92}{config\_get\_bool\_field}(\textcolor{stringliteral}{"slave-read-only"},
01289             server.repl\_slave\_ro);
01290     \hyperlink{config_8c_a7dbc6f4e538d2db2aa10ae47511d6c92}{config\_get\_bool\_field}(\textcolor{stringliteral}{"stop-writes-on-bgsave-error"},
01291             server.stop\_writes\_on\_bgsave\_err);
01292     \hyperlink{config_8c_a7dbc6f4e538d2db2aa10ae47511d6c92}{config\_get\_bool\_field}(\textcolor{stringliteral}{"daemonize"}, server.daemonize);
01293     \hyperlink{config_8c_a7dbc6f4e538d2db2aa10ae47511d6c92}{config\_get\_bool\_field}(\textcolor{stringliteral}{"rdbcompression"}, server.rdb\_compression);
01294     \hyperlink{config_8c_a7dbc6f4e538d2db2aa10ae47511d6c92}{config\_get\_bool\_field}(\textcolor{stringliteral}{"rdbchecksum"}, server.rdb\_checksum);
01295     \hyperlink{config_8c_a7dbc6f4e538d2db2aa10ae47511d6c92}{config\_get\_bool\_field}(\textcolor{stringliteral}{"activerehashing"}, server.activerehashing);
01296     \hyperlink{config_8c_a7dbc6f4e538d2db2aa10ae47511d6c92}{config\_get\_bool\_field}(\textcolor{stringliteral}{"activedefrag"}, server.active\_defrag\_enabled);
01297     \hyperlink{config_8c_a7dbc6f4e538d2db2aa10ae47511d6c92}{config\_get\_bool\_field}(\textcolor{stringliteral}{"protected-mode"}, server.protected\_mode);
01298     \hyperlink{config_8c_a7dbc6f4e538d2db2aa10ae47511d6c92}{config\_get\_bool\_field}(\textcolor{stringliteral}{"repl-disable-tcp-nodelay"},
01299             server.repl\_disable\_tcp\_nodelay);
01300     \hyperlink{config_8c_a7dbc6f4e538d2db2aa10ae47511d6c92}{config\_get\_bool\_field}(\textcolor{stringliteral}{"repl-diskless-sync"},
01301             server.repl\_diskless\_sync);
01302     \hyperlink{config_8c_a7dbc6f4e538d2db2aa10ae47511d6c92}{config\_get\_bool\_field}(\textcolor{stringliteral}{"aof-rewrite-incremental-fsync"},
01303             server.aof\_rewrite\_incremental\_fsync);
01304     \hyperlink{config_8c_a7dbc6f4e538d2db2aa10ae47511d6c92}{config\_get\_bool\_field}(\textcolor{stringliteral}{"aof-load-truncated"},
01305             server.aof\_load\_truncated);
01306     \hyperlink{config_8c_a7dbc6f4e538d2db2aa10ae47511d6c92}{config\_get\_bool\_field}(\textcolor{stringliteral}{"aof-use-rdb-preamble"},
01307             server.aof\_use\_rdb\_preamble);
01308     \hyperlink{config_8c_a7dbc6f4e538d2db2aa10ae47511d6c92}{config\_get\_bool\_field}(\textcolor{stringliteral}{"lazyfree-lazy-eviction"},
01309             server.lazyfree\_lazy\_eviction);
01310     \hyperlink{config_8c_a7dbc6f4e538d2db2aa10ae47511d6c92}{config\_get\_bool\_field}(\textcolor{stringliteral}{"lazyfree-lazy-expire"},
01311             server.lazyfree\_lazy\_expire);
01312     \hyperlink{config_8c_a7dbc6f4e538d2db2aa10ae47511d6c92}{config\_get\_bool\_field}(\textcolor{stringliteral}{"lazyfree-lazy-server-del"},
01313             server.lazyfree\_lazy\_server\_del);
01314     \hyperlink{config_8c_a7dbc6f4e538d2db2aa10ae47511d6c92}{config\_get\_bool\_field}(\textcolor{stringliteral}{"slave-lazy-flush"},
01315             server.repl\_slave\_lazy\_flush);
01316 
01317     \textcolor{comment}{/* Enum values */}
01318     \hyperlink{config_8c_a70dc0615718e584a2c51615aba594479}{config\_get\_enum\_field}(\textcolor{stringliteral}{"maxmemory-policy"},
01319             server.maxmemory\_policy,maxmemory\_policy\_enum);
01320     \hyperlink{config_8c_a70dc0615718e584a2c51615aba594479}{config\_get\_enum\_field}(\textcolor{stringliteral}{"loglevel"},
01321             server.verbosity,loglevel\_enum);
01322     \hyperlink{config_8c_a70dc0615718e584a2c51615aba594479}{config\_get\_enum\_field}(\textcolor{stringliteral}{"supervised"},
01323             server.supervised\_mode,supervised\_mode\_enum);
01324     \hyperlink{config_8c_a70dc0615718e584a2c51615aba594479}{config\_get\_enum\_field}(\textcolor{stringliteral}{"appendfsync"},
01325             server.\hyperlink{config_8h_af5994c643c434574580bb7816af82cad}{aof\_fsync},aof\_fsync\_enum);
01326     \hyperlink{config_8c_a70dc0615718e584a2c51615aba594479}{config\_get\_enum\_field}(\textcolor{stringliteral}{"syslog-facility"},
01327             server.syslog\_facility,syslog\_facility\_enum);
01328 
01329     \textcolor{comment}{/* Everything we can't handle with macros follows. */}
01330 
01331     \textcolor{keywordflow}{if} (stringmatch(pattern,\textcolor{stringliteral}{"appendonly"},1)) \{
01332         addReplyBulkCString(c,\textcolor{stringliteral}{"appendonly"});
01333         addReplyBulkCString(c,server.aof\_state == \hyperlink{server_8h_a5226306fbcebcb6d5d02e0fef3c213c2}{AOF\_OFF} ? \textcolor{stringliteral}{"no"} : \textcolor{stringliteral}{"yes"});
01334         matches++;
01335     \}
01336     \textcolor{keywordflow}{if} (stringmatch(pattern,\textcolor{stringliteral}{"dir"},1)) \{
01337         \textcolor{keywordtype}{char} buf[1024];
01338 
01339         \textcolor{keywordflow}{if} (getcwd(buf,\textcolor{keyword}{sizeof}(buf)) == NULL)
01340             buf[0] = \textcolor{stringliteral}{'\(\backslash\)0'};
01341 
01342         addReplyBulkCString(c,\textcolor{stringliteral}{"dir"});
01343         addReplyBulkCString(c,buf);
01344         matches++;
01345     \}
01346     \textcolor{keywordflow}{if} (stringmatch(pattern,\textcolor{stringliteral}{"save"},1)) \{
01347         sds buf = sdsempty();
01348         \textcolor{keywordtype}{int} j;
01349 
01350         \textcolor{keywordflow}{for} (j = 0; j < server.saveparamslen; j++) \{
01351             buf = sdscatprintf(buf,\textcolor{stringliteral}{"%jd %d"},
01352                     (intmax\_t)server.saveparams[j].seconds,
01353                     server.saveparams[j].changes);
01354             \textcolor{keywordflow}{if} (j != server.saveparamslen-1)
01355                 buf = sdscatlen(buf,\textcolor{stringliteral}{" "},1);
01356         \}
01357         addReplyBulkCString(c,\textcolor{stringliteral}{"save"});
01358         addReplyBulkCString(c,buf);
01359         sdsfree(buf);
01360         matches++;
01361     \}
01362     \textcolor{keywordflow}{if} (stringmatch(pattern,\textcolor{stringliteral}{"client-output-buffer-limit"},1)) \{
01363         sds buf = sdsempty();
01364         \textcolor{keywordtype}{int} j;
01365 
01366         \textcolor{keywordflow}{for} (j = 0; j < \hyperlink{server_8h_aea8f6f3fac3a68e35807eba109dbc501}{CLIENT\_TYPE\_OBUF\_COUNT}; j++) \{
01367             buf = sdscatprintf(buf,\textcolor{stringliteral}{"%s %llu %llu %ld"},
01368                     getClientTypeName(j),
01369                     server.client\_obuf\_limits[j].hard\_limit\_bytes,
01370                     server.client\_obuf\_limits[j].soft\_limit\_bytes,
01371                     (\textcolor{keywordtype}{long}) server.client\_obuf\_limits[j].soft\_limit\_seconds);
01372             \textcolor{keywordflow}{if} (j != \hyperlink{server_8h_aea8f6f3fac3a68e35807eba109dbc501}{CLIENT\_TYPE\_OBUF\_COUNT}-1)
01373                 buf = sdscatlen(buf,\textcolor{stringliteral}{" "},1);
01374         \}
01375         addReplyBulkCString(c,\textcolor{stringliteral}{"client-output-buffer-limit"});
01376         addReplyBulkCString(c,buf);
01377         sdsfree(buf);
01378         matches++;
01379     \}
01380     \textcolor{keywordflow}{if} (stringmatch(pattern,\textcolor{stringliteral}{"unixsocketperm"},1)) \{
01381         \textcolor{keywordtype}{char} buf[32];
01382         snprintf(buf,\textcolor{keyword}{sizeof}(buf),\textcolor{stringliteral}{"%o"},server.unixsocketperm);
01383         addReplyBulkCString(c,\textcolor{stringliteral}{"unixsocketperm"});
01384         addReplyBulkCString(c,buf);
01385         matches++;
01386     \}
01387     \textcolor{keywordflow}{if} (stringmatch(pattern,\textcolor{stringliteral}{"slaveof"},1)) \{
01388         \textcolor{keywordtype}{char} buf[256];
01389 
01390         addReplyBulkCString(c,\textcolor{stringliteral}{"slaveof"});
01391         \textcolor{keywordflow}{if} (server.masterhost)
01392             snprintf(buf,\textcolor{keyword}{sizeof}(buf),\textcolor{stringliteral}{"%s %d"},
01393                 server.masterhost, server.masterport);
01394         \textcolor{keywordflow}{else}
01395             buf[0] = \textcolor{stringliteral}{'\(\backslash\)0'};
01396         addReplyBulkCString(c,buf);
01397         matches++;
01398     \}
01399     \textcolor{keywordflow}{if} (stringmatch(pattern,\textcolor{stringliteral}{"notify-keyspace-events"},1)) \{
01400         robj *flagsobj = createObject(\hyperlink{server_8h_a65236ea160f69cdef33ec942092af88f}{OBJ\_STRING},
01401             keyspaceEventsFlagsToString(server.notify\_keyspace\_events));
01402 
01403         addReplyBulkCString(c,\textcolor{stringliteral}{"notify-keyspace-events"});
01404         addReplyBulk(c,flagsobj);
01405         decrRefCount(flagsobj);
01406         matches++;
01407     \}
01408     \textcolor{keywordflow}{if} (stringmatch(pattern,\textcolor{stringliteral}{"bind"},1)) \{
01409         sds aux = sdsjoin(server.bindaddr,server.bindaddr\_count,\textcolor{stringliteral}{" "});
01410 
01411         addReplyBulkCString(c,\textcolor{stringliteral}{"bind"});
01412         addReplyBulkCString(c,aux);
01413         sdsfree(aux);
01414         matches++;
01415     \}
01416     setDeferredMultiBulkLength(c,replylen,matches*2);
01417 \}
01418 
01419 \textcolor{comment}{/*-----------------------------------------------------------------------------}
01420 \textcolor{comment}{ * CONFIG REWRITE implementation}
01421 \textcolor{comment}{ *----------------------------------------------------------------------------*/}
01422 
01423 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{REDIS\_CONFIG\_REWRITE\_SIGNATURE} \textcolor{stringliteral}{"# Generated by CONFIG REWRITE"}
01424 
01425 \textcolor{comment}{/* We use the following dictionary type to store where a configuration}
01426 \textcolor{comment}{ * option is mentioned in the old configuration file, so it's}
01427 \textcolor{comment}{ * like "maxmemory" -> list of line numbers (first line is zero). */}
01428 uint64\_t dictSdsCaseHash(\textcolor{keyword}{const} \textcolor{keywordtype}{void} *key);
01429 \textcolor{keywordtype}{int} dictSdsKeyCaseCompare(\textcolor{keywordtype}{void} *privdata, \textcolor{keyword}{const} \textcolor{keywordtype}{void} *key1, \textcolor{keyword}{const} \textcolor{keywordtype}{void} *key2);
01430 \textcolor{keywordtype}{void} dictSdsDestructor(\textcolor{keywordtype}{void} *privdata, \textcolor{keywordtype}{void} *val);
01431 \textcolor{keywordtype}{void} dictListDestructor(\textcolor{keywordtype}{void} *privdata, \textcolor{keywordtype}{void} *val);
01432 
01433 \textcolor{comment}{/* Sentinel config rewriting is implemented inside sentinel.c by}
01434 \textcolor{comment}{ * rewriteConfigSentinelOption(). */}
01435 \textcolor{keywordtype}{void} rewriteConfigSentinelOption(\textcolor{keyword}{struct} rewriteConfigState *state);
01436 
01437 dictType optionToLineDictType = \{
01438     dictSdsCaseHash,            \textcolor{comment}{/* hash function */}
01439     NULL,                       \textcolor{comment}{/* key dup */}
01440     NULL,                       \textcolor{comment}{/* val dup */}
01441     dictSdsKeyCaseCompare,      \textcolor{comment}{/* key compare */}
01442     dictSdsDestructor,          \textcolor{comment}{/* key destructor */}
01443     dictListDestructor          \textcolor{comment}{/* val destructor */}
01444 \};
01445 
01446 dictType optionSetDictType = \{
01447     dictSdsCaseHash,            \textcolor{comment}{/* hash function */}
01448     NULL,                       \textcolor{comment}{/* key dup */}
01449     NULL,                       \textcolor{comment}{/* val dup */}
01450     dictSdsKeyCaseCompare,      \textcolor{comment}{/* key compare */}
01451     dictSdsDestructor,          \textcolor{comment}{/* key destructor */}
01452     NULL                        \textcolor{comment}{/* val destructor */}
01453 \};
01454 
01455 \textcolor{comment}{/* The config rewrite state. */}
01456 \textcolor{keyword}{struct} rewriteConfigState \{
01457     dict *option\_to\_line; \textcolor{comment}{/* Option -> list of config file lines map */}
01458     dict *rewritten;      \textcolor{comment}{/* Dictionary of already processed options */}
01459     \textcolor{keywordtype}{int} numlines;         \textcolor{comment}{/* Number of lines in current config */}
01460     sds *lines;           \textcolor{comment}{/* Current lines as an array of sds strings */}
01461     \textcolor{keywordtype}{int} has\_tail;         \textcolor{comment}{/* True if we already added directives that were}
01462 \textcolor{comment}{                             not present in the original config file. */}
01463 \};
01464 
01465 \textcolor{comment}{/* Append the new line to the current configuration state. */}
01466 \textcolor{keywordtype}{void} rewriteConfigAppendLine(\textcolor{keyword}{struct} rewriteConfigState *state, sds line) \{
01467     state->lines = zrealloc(state->lines, \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{char}*) * (state->numlines+1));
01468     state->lines[state->numlines++] = line;
01469 \}
01470 
01471 \textcolor{comment}{/* Populate the option -> list of line numbers map. */}
01472 \textcolor{keywordtype}{void} rewriteConfigAddLineNumberToOption(\textcolor{keyword}{struct} rewriteConfigState *state, sds option, \textcolor{keywordtype}{int} linenum) \{
01473     list *l = dictFetchValue(state->option\_to\_line,option);
01474 
01475     \textcolor{keywordflow}{if} (l == NULL) \{
01476         l = listCreate();
01477         dictAdd(state->option\_to\_line,sdsdup(option),l);
01478     \}
01479     listAddNodeTail(l,(\textcolor{keywordtype}{void}*)(\textcolor{keywordtype}{long})linenum);
01480 \}
01481 
01482 \textcolor{comment}{/* Add the specified option to the set of processed options.}
01483 \textcolor{comment}{ * This is useful as only unused lines of processed options will be blanked}
01484 \textcolor{comment}{ * in the config file, while options the rewrite process does not understand}
01485 \textcolor{comment}{ * remain untouched. */}
01486 \textcolor{keywordtype}{void} rewriteConfigMarkAsProcessed(\textcolor{keyword}{struct} rewriteConfigState *state, \textcolor{keyword}{const} \textcolor{keywordtype}{char} *option) \{
01487     sds opt = sdsnew(option);
01488 
01489     \textcolor{keywordflow}{if} (dictAdd(state->rewritten,opt,NULL) != \hyperlink{dict_8h_a2afecbeab8f7efbc183048f52f6d17e5}{DICT\_OK}) sdsfree(opt);
01490 \}
01491 
01492 \textcolor{comment}{/* Read the old file, split it into lines to populate a newly created}
01493 \textcolor{comment}{ * config rewrite state, and return it to the caller.}
01494 \textcolor{comment}{ *}
01495 \textcolor{comment}{ * If it is impossible to read the old file, NULL is returned.}
01496 \textcolor{comment}{ * If the old file does not exist at all, an empty state is returned. */}
01497 \textcolor{keyword}{struct} rewriteConfigState *rewriteConfigReadOldFile(\textcolor{keywordtype}{char} *path) \{
01498     FILE *fp = fopen(path,\textcolor{stringliteral}{"r"});
01499     \textcolor{keyword}{struct} rewriteConfigState *state = zmalloc(\textcolor{keyword}{sizeof}(*state));
01500     \textcolor{keywordtype}{char} buf[\hyperlink{server_8h_a0d8887ba7f096f153f904f206986a9fc}{CONFIG\_MAX\_LINE}+1];
01501     \textcolor{keywordtype}{int} linenum = -1;
01502 
01503     \textcolor{keywordflow}{if} (fp == NULL && errno != ENOENT) \textcolor{keywordflow}{return} NULL;
01504 
01505     state->option\_to\_line = dictCreate(&optionToLineDictType,NULL);
01506     state->rewritten = dictCreate(&optionSetDictType,NULL);
01507     state->numlines = 0;
01508     state->lines = NULL;
01509     state->has\_tail = 0;
01510     \textcolor{keywordflow}{if} (fp == NULL) \textcolor{keywordflow}{return} state;
01511 
01512     \textcolor{comment}{/* Read the old file line by line, populate the state. */}
01513     \textcolor{keywordflow}{while}(fgets(buf,\hyperlink{server_8h_a0d8887ba7f096f153f904f206986a9fc}{CONFIG\_MAX\_LINE}+1,fp) != NULL) \{
01514         \textcolor{keywordtype}{int} argc;
01515         sds *argv;
01516         sds line = sdstrim(sdsnew(buf),\textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n\(\backslash\)t "});
01517 
01518         linenum++; \textcolor{comment}{/* Zero based, so we init at -1 */}
01519 
01520         \textcolor{comment}{/* Handle comments and empty lines. */}
01521         \textcolor{keywordflow}{if} (line[0] == \textcolor{stringliteral}{'#'} || line[0] == \textcolor{stringliteral}{'\(\backslash\)0'}) \{
01522             \textcolor{keywordflow}{if} (!state->has\_tail && !strcmp(line,
      \hyperlink{config_8c_aaa12a1e51316cd3b3e52143ec8d03aeb}{REDIS\_CONFIG\_REWRITE\_SIGNATURE}))
01523                 state->has\_tail = 1;
01524             rewriteConfigAppendLine(state,line);
01525             \textcolor{keywordflow}{continue};
01526         \}
01527 
01528         \textcolor{comment}{/* Not a comment, split into arguments. */}
01529         argv = sdssplitargs(line,&argc);
01530         \textcolor{keywordflow}{if} (argv == NULL) \{
01531             \textcolor{comment}{/* Apparently the line is unparsable for some reason, for}
01532 \textcolor{comment}{             * instance it may have unbalanced quotes. Load it as a}
01533 \textcolor{comment}{             * comment. */}
01534             sds aux = sdsnew(\textcolor{stringliteral}{"# ??? "});
01535             aux = sdscatsds(aux,line);
01536             sdsfree(line);
01537             rewriteConfigAppendLine(state,aux);
01538             \textcolor{keywordflow}{continue};
01539         \}
01540 
01541         sdstolower(argv[0]); \textcolor{comment}{/* We only want lowercase config directives. */}
01542 
01543         \textcolor{comment}{/* Now we populate the state according to the content of this line.}
01544 \textcolor{comment}{         * Append the line and populate the option -> line numbers map. */}
01545         rewriteConfigAppendLine(state,line);
01546         rewriteConfigAddLineNumberToOption(state,argv[0],linenum);
01547 
01548         sdsfreesplitres(argv,argc);
01549     \}
01550     fclose(fp);
01551     \textcolor{keywordflow}{return} state;
01552 \}
01553 
01554 \textcolor{comment}{/* Rewrite the specified configuration option with the new "line".}
01555 \textcolor{comment}{ * It progressively uses lines of the file that were already used for the same}
01556 \textcolor{comment}{ * configuration option in the old version of the file, removing that line from}
01557 \textcolor{comment}{ * the map of options -> line numbers.}
01558 \textcolor{comment}{ *}
01559 \textcolor{comment}{ * If there are lines associated with a given configuration option and}
01560 \textcolor{comment}{ * "force" is non-zero, the line is appended to the configuration file.}
01561 \textcolor{comment}{ * Usually "force" is true when an option has not its default value, so it}
01562 \textcolor{comment}{ * must be rewritten even if not present previously.}
01563 \textcolor{comment}{ *}
01564 \textcolor{comment}{ * The first time a line is appended into a configuration file, a comment}
01565 \textcolor{comment}{ * is added to show that starting from that point the config file was generated}
01566 \textcolor{comment}{ * by CONFIG REWRITE.}
01567 \textcolor{comment}{ *}
01568 \textcolor{comment}{ * "line" is either used, or freed, so the caller does not need to free it}
01569 \textcolor{comment}{ * in any way. */}
01570 \textcolor{keywordtype}{void} rewriteConfigRewriteLine(\textcolor{keyword}{struct} rewriteConfigState *state, \textcolor{keyword}{const} \textcolor{keywordtype}{char} *option, sds line, \textcolor{keywordtype}{int} 
      force) \{
01571     sds o = sdsnew(option);
01572     list *l = dictFetchValue(state->option\_to\_line,o);
01573 
01574     rewriteConfigMarkAsProcessed(state,option);
01575 
01576     \textcolor{keywordflow}{if} (!l && !force) \{
01577         \textcolor{comment}{/* Option not used previously, and we are not forced to use it. */}
01578         sdsfree(line);
01579         sdsfree(o);
01580         \textcolor{keywordflow}{return};
01581     \}
01582 
01583     \textcolor{keywordflow}{if} (l) \{
01584         listNode *ln = \hyperlink{adlist_8h_aa8dc514bbe217bb2e87c1c77cfa84690}{listFirst}(l);
01585         \textcolor{keywordtype}{int} linenum = (\textcolor{keywordtype}{long}) ln->value;
01586 
01587         \textcolor{comment}{/* There are still lines in the old configuration file we can reuse}
01588 \textcolor{comment}{         * for this option. Replace the line with the new one. */}
01589         listDelNode(l,ln);
01590         \textcolor{keywordflow}{if} (\hyperlink{adlist_8h_afde0ab079f934670e82119b43120e94b}{listLength}(l) == 0) dictDelete(state->option\_to\_line,o);
01591         sdsfree(state->lines[linenum]);
01592         state->lines[linenum] = line;
01593     \} \textcolor{keywordflow}{else} \{
01594         \textcolor{comment}{/* Append a new line. */}
01595         \textcolor{keywordflow}{if} (!state->has\_tail) \{
01596             rewriteConfigAppendLine(state,
01597                 sdsnew(\hyperlink{config_8c_aaa12a1e51316cd3b3e52143ec8d03aeb}{REDIS\_CONFIG\_REWRITE\_SIGNATURE}));
01598             state->has\_tail = 1;
01599         \}
01600         rewriteConfigAppendLine(state,line);
01601     \}
01602     sdsfree(o);
01603 \}
01604 
01605 \textcolor{comment}{/* Write the long long 'bytes' value as a string in a way that is parsable}
01606 \textcolor{comment}{ * inside redis.conf. If possible uses the GB, MB, KB notation. */}
01607 \textcolor{keywordtype}{int} rewriteConfigFormatMemory(\textcolor{keywordtype}{char} *buf, size\_t len, \textcolor{keywordtype}{long} \textcolor{keywordtype}{long} bytes) \{
01608     \textcolor{keywordtype}{int} gb = 1024*1024*1024;
01609     \textcolor{keywordtype}{int} mb = 1024*1024;
01610     \textcolor{keywordtype}{int} kb = 1024;
01611 
01612     \textcolor{keywordflow}{if} (bytes && (bytes % gb) == 0) \{
01613         \textcolor{keywordflow}{return} snprintf(buf,len,\textcolor{stringliteral}{"%lldgb"},bytes/gb);
01614     \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (bytes && (bytes % mb) == 0) \{
01615         \textcolor{keywordflow}{return} snprintf(buf,len,\textcolor{stringliteral}{"%lldmb"},bytes/mb);
01616     \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (bytes && (bytes % kb) == 0) \{
01617         \textcolor{keywordflow}{return} snprintf(buf,len,\textcolor{stringliteral}{"%lldkb"},bytes/kb);
01618     \} \textcolor{keywordflow}{else} \{
01619         \textcolor{keywordflow}{return} snprintf(buf,len,\textcolor{stringliteral}{"%lld"},bytes);
01620     \}
01621 \}
01622 
01623 \textcolor{comment}{/* Rewrite a simple "option-name <bytes>" configuration option. */}
01624 \textcolor{keywordtype}{void} rewriteConfigBytesOption(\textcolor{keyword}{struct} rewriteConfigState *state, \textcolor{keywordtype}{char} *option, \textcolor{keywordtype}{long} \textcolor{keywordtype}{long} value, \textcolor{keywordtype}{long} \textcolor{keywordtype}{
      long} defvalue) \{
01625     \textcolor{keywordtype}{char} buf[64];
01626     \textcolor{keywordtype}{int} force = value != defvalue;
01627     sds line;
01628 
01629     rewriteConfigFormatMemory(buf,\textcolor{keyword}{sizeof}(buf),value);
01630     line = sdscatprintf(sdsempty(),\textcolor{stringliteral}{"%s %s"},option,buf);
01631     rewriteConfigRewriteLine(state,option,line,force);
01632 \}
01633 
01634 \textcolor{comment}{/* Rewrite a yes/no option. */}
01635 \textcolor{keywordtype}{void} rewriteConfigYesNoOption(\textcolor{keyword}{struct} rewriteConfigState *state, \textcolor{keywordtype}{char} *option, \textcolor{keywordtype}{int} value, \textcolor{keywordtype}{int} defvalue)
       \{
01636     \textcolor{keywordtype}{int} force = value != defvalue;
01637     sds line = sdscatprintf(sdsempty(),\textcolor{stringliteral}{"%s %s"},option,
01638         value ? \textcolor{stringliteral}{"yes"} : \textcolor{stringliteral}{"no"});
01639 
01640     rewriteConfigRewriteLine(state,option,line,force);
01641 \}
01642 
01643 \textcolor{comment}{/* Rewrite a string option. */}
01644 \textcolor{keywordtype}{void} rewriteConfigStringOption(\textcolor{keyword}{struct} rewriteConfigState *state, \textcolor{keywordtype}{char} *option, \textcolor{keywordtype}{char} *value, \textcolor{keywordtype}{char} *
      defvalue) \{
01645     \textcolor{keywordtype}{int} force = 1;
01646     sds line;
01647 
01648     \textcolor{comment}{/* String options set to NULL need to be not present at all in the}
01649 \textcolor{comment}{     * configuration file to be set to NULL again at the next reboot. */}
01650     \textcolor{keywordflow}{if} (value == NULL) \{
01651         rewriteConfigMarkAsProcessed(state,option);
01652         \textcolor{keywordflow}{return};
01653     \}
01654 
01655     \textcolor{comment}{/* Set force to zero if the value is set to its default. */}
01656     \textcolor{keywordflow}{if} (defvalue && strcmp(value,defvalue) == 0) force = 0;
01657 
01658     line = sdsnew(option);
01659     line = sdscatlen(line, \textcolor{stringliteral}{" "}, 1);
01660     line = sdscatrepr(line, value, strlen(value));
01661 
01662     rewriteConfigRewriteLine(state,option,line,force);
01663 \}
01664 
01665 \textcolor{comment}{/* Rewrite a numerical (long long range) option. */}
01666 \textcolor{keywordtype}{void} rewriteConfigNumericalOption(\textcolor{keyword}{struct} rewriteConfigState *state, \textcolor{keywordtype}{char} *option, \textcolor{keywordtype}{long} \textcolor{keywordtype}{long} value, \textcolor{keywordtype}{
      long} \textcolor{keywordtype}{long} defvalue) \{
01667     \textcolor{keywordtype}{int} force = value != defvalue;
01668     sds line = sdscatprintf(sdsempty(),\textcolor{stringliteral}{"%s %lld"},option,value);
01669 
01670     rewriteConfigRewriteLine(state,option,line,force);
01671 \}
01672 
01673 \textcolor{comment}{/* Rewrite a octal option. */}
01674 \textcolor{keywordtype}{void} rewriteConfigOctalOption(\textcolor{keyword}{struct} rewriteConfigState *state, \textcolor{keywordtype}{char} *option, \textcolor{keywordtype}{int} value, \textcolor{keywordtype}{int} defvalue)
       \{
01675     \textcolor{keywordtype}{int} force = value != defvalue;
01676     sds line = sdscatprintf(sdsempty(),\textcolor{stringliteral}{"%s %o"},option,value);
01677 
01678     rewriteConfigRewriteLine(state,option,line,force);
01679 \}
01680 
01681 \textcolor{comment}{/* Rewrite an enumeration option. It takes as usually state and option name,}
01682 \textcolor{comment}{ * and in addition the enumeration array and the default value for the}
01683 \textcolor{comment}{ * option. */}
01684 \textcolor{keywordtype}{void} rewriteConfigEnumOption(\textcolor{keyword}{struct} rewriteConfigState *state, \textcolor{keywordtype}{char} *option, \textcolor{keywordtype}{int} value, configEnum *ce
      , \textcolor{keywordtype}{int} defval) \{
01685     sds line;
01686     \textcolor{keyword}{const} \textcolor{keywordtype}{char} *name = configEnumGetNameOrUnknown(ce,value);
01687     \textcolor{keywordtype}{int} force = value != defval;
01688 
01689     line = sdscatprintf(sdsempty(),\textcolor{stringliteral}{"%s %s"},option,name);
01690     rewriteConfigRewriteLine(state,option,line,force);
01691 \}
01692 
01693 \textcolor{comment}{/* Rewrite the syslog-facility option. */}
01694 \textcolor{keywordtype}{void} rewriteConfigSyslogfacilityOption(\textcolor{keyword}{struct} rewriteConfigState *state) \{
01695     \textcolor{keywordtype}{int} value = server.syslog\_facility;
01696     \textcolor{keywordtype}{int} force = value != LOG\_LOCAL0;
01697     \textcolor{keyword}{const} \textcolor{keywordtype}{char} *name = NULL, *option = \textcolor{stringliteral}{"syslog-facility"};
01698     sds line;
01699 
01700     name = configEnumGetNameOrUnknown(syslog\_facility\_enum,value);
01701     line = sdscatprintf(sdsempty(),\textcolor{stringliteral}{"%s %s"},option,name);
01702     rewriteConfigRewriteLine(state,option,line,force);
01703 \}
01704 
01705 \textcolor{comment}{/* Rewrite the save option. */}
01706 \textcolor{keywordtype}{void} rewriteConfigSaveOption(\textcolor{keyword}{struct} rewriteConfigState *state) \{
01707     \textcolor{keywordtype}{int} j;
01708     sds line;
01709 
01710     \textcolor{comment}{/* Note that if there are no save parameters at all, all the current}
01711 \textcolor{comment}{     * config line with "save" will be detected as orphaned and deleted,}
01712 \textcolor{comment}{     * resulting into no RDB persistence as expected. */}
01713     \textcolor{keywordflow}{for} (j = 0; j < server.saveparamslen; j++) \{
01714         line = sdscatprintf(sdsempty(),\textcolor{stringliteral}{"save %ld %d"},
01715             (\textcolor{keywordtype}{long}) server.saveparams[j].seconds, server.saveparams[j].changes);
01716         rewriteConfigRewriteLine(state,\textcolor{stringliteral}{"save"},line,1);
01717     \}
01718     \textcolor{comment}{/* Mark "save" as processed in case server.saveparamslen is zero. */}
01719     rewriteConfigMarkAsProcessed(state,\textcolor{stringliteral}{"save"});
01720 \}
01721 
01722 \textcolor{comment}{/* Rewrite the dir option, always using absolute paths.*/}
01723 \textcolor{keywordtype}{void} rewriteConfigDirOption(\textcolor{keyword}{struct} rewriteConfigState *state) \{
01724     \textcolor{keywordtype}{char} cwd[1024];
01725 
01726     \textcolor{keywordflow}{if} (getcwd(cwd,\textcolor{keyword}{sizeof}(cwd)) == NULL) \{
01727         rewriteConfigMarkAsProcessed(state,\textcolor{stringliteral}{"dir"});
01728         \textcolor{keywordflow}{return}; \textcolor{comment}{/* no rewrite on error. */}
01729     \}
01730     rewriteConfigStringOption(state,\textcolor{stringliteral}{"dir"},cwd,NULL);
01731 \}
01732 
01733 \textcolor{comment}{/* Rewrite the slaveof option. */}
01734 \textcolor{keywordtype}{void} rewriteConfigSlaveofOption(\textcolor{keyword}{struct} rewriteConfigState *state) \{
01735     \textcolor{keywordtype}{char} *option = \textcolor{stringliteral}{"slaveof"};
01736     sds line;
01737 
01738     \textcolor{comment}{/* If this is a master, we want all the slaveof config options}
01739 \textcolor{comment}{     * in the file to be removed. Note that if this is a cluster instance}
01740 \textcolor{comment}{     * we don't want a slaveof directive inside redis.conf. */}
01741     \textcolor{keywordflow}{if} (server.cluster\_enabled || server.masterhost == NULL) \{
01742         rewriteConfigMarkAsProcessed(state,\textcolor{stringliteral}{"slaveof"});
01743         \textcolor{keywordflow}{return};
01744     \}
01745     line = sdscatprintf(sdsempty(),\textcolor{stringliteral}{"%s %s %d"}, option,
01746         server.masterhost, server.masterport);
01747     rewriteConfigRewriteLine(state,option,line,1);
01748 \}
01749 
01750 \textcolor{comment}{/* Rewrite the notify-keyspace-events option. */}
01751 \textcolor{keywordtype}{void} rewriteConfigNotifykeyspaceeventsOption(\textcolor{keyword}{struct} rewriteConfigState *state) \{
01752     \textcolor{keywordtype}{int} force = server.notify\_keyspace\_events != 0;
01753     \textcolor{keywordtype}{char} *option = \textcolor{stringliteral}{"notify-keyspace-events"};
01754     sds line, flags;
01755 
01756     flags = keyspaceEventsFlagsToString(server.notify\_keyspace\_events);
01757     line = sdsnew(option);
01758     line = sdscatlen(line, \textcolor{stringliteral}{" "}, 1);
01759     line = sdscatrepr(line, flags, sdslen(flags));
01760     sdsfree(flags);
01761     rewriteConfigRewriteLine(state,option,line,force);
01762 \}
01763 
01764 \textcolor{comment}{/* Rewrite the client-output-buffer-limit option. */}
01765 \textcolor{keywordtype}{void} rewriteConfigClientoutputbufferlimitOption(\textcolor{keyword}{struct} rewriteConfigState *state) \{
01766     \textcolor{keywordtype}{int} j;
01767     \textcolor{keywordtype}{char} *option = \textcolor{stringliteral}{"client-output-buffer-limit"};
01768 
01769     \textcolor{keywordflow}{for} (j = 0; j < \hyperlink{server_8h_aea8f6f3fac3a68e35807eba109dbc501}{CLIENT\_TYPE\_OBUF\_COUNT}; j++) \{
01770         \textcolor{keywordtype}{int} force = (server.client\_obuf\_limits[j].hard\_limit\_bytes !=
01771                     clientBufferLimitsDefaults[j].hard\_limit\_bytes) ||
01772                     (server.client\_obuf\_limits[j].soft\_limit\_bytes !=
01773                     clientBufferLimitsDefaults[j].soft\_limit\_bytes) ||
01774                     (server.client\_obuf\_limits[j].soft\_limit\_seconds !=
01775                     clientBufferLimitsDefaults[j].soft\_limit\_seconds);
01776         sds line;
01777         \textcolor{keywordtype}{char} hard[64], soft[64];
01778 
01779         rewriteConfigFormatMemory(hard,\textcolor{keyword}{sizeof}(hard),
01780                 server.client\_obuf\_limits[j].hard\_limit\_bytes);
01781         rewriteConfigFormatMemory(soft,\textcolor{keyword}{sizeof}(soft),
01782                 server.client\_obuf\_limits[j].soft\_limit\_bytes);
01783 
01784         line = sdscatprintf(sdsempty(),\textcolor{stringliteral}{"%s %s %s %s %ld"},
01785                 option, getClientTypeName(j), hard, soft,
01786                 (\textcolor{keywordtype}{long}) server.client\_obuf\_limits[j].soft\_limit\_seconds);
01787         rewriteConfigRewriteLine(state,option,line,force);
01788     \}
01789 \}
01790 
01791 \textcolor{comment}{/* Rewrite the bind option. */}
01792 \textcolor{keywordtype}{void} rewriteConfigBindOption(\textcolor{keyword}{struct} rewriteConfigState *state) \{
01793     \textcolor{keywordtype}{int} force = 1;
01794     sds line, addresses;
01795     \textcolor{keywordtype}{char} *option = \textcolor{stringliteral}{"bind"};
01796 
01797     \textcolor{comment}{/* Nothing to rewrite if we don't have bind addresses. */}
01798     \textcolor{keywordflow}{if} (server.bindaddr\_count == 0) \{
01799         rewriteConfigMarkAsProcessed(state,option);
01800         \textcolor{keywordflow}{return};
01801     \}
01802 
01803     \textcolor{comment}{/* Rewrite as bind <addr1> <addr2> ... <addrN> */}
01804     addresses = sdsjoin(server.bindaddr,server.bindaddr\_count,\textcolor{stringliteral}{" "});
01805     line = sdsnew(option);
01806     line = sdscatlen(line, \textcolor{stringliteral}{" "}, 1);
01807     line = sdscatsds(line, addresses);
01808     sdsfree(addresses);
01809 
01810     rewriteConfigRewriteLine(state,option,line,force);
01811 \}
01812 
01813 \textcolor{comment}{/* Glue together the configuration lines in the current configuration}
01814 \textcolor{comment}{ * rewrite state into a single string, stripping multiple empty lines. */}
01815 sds rewriteConfigGetContentFromState(\textcolor{keyword}{struct} rewriteConfigState *state) \{
01816     sds content = sdsempty();
01817     \textcolor{keywordtype}{int} j, was\_empty = 0;
01818 
01819     \textcolor{keywordflow}{for} (j = 0; j < state->numlines; j++) \{
01820         \textcolor{comment}{/* Every cluster of empty lines is turned into a single empty line. */}
01821         \textcolor{keywordflow}{if} (sdslen(state->lines[j]) == 0) \{
01822             \textcolor{keywordflow}{if} (was\_empty) \textcolor{keywordflow}{continue};
01823             was\_empty = 1;
01824         \} \textcolor{keywordflow}{else} \{
01825             was\_empty = 0;
01826         \}
01827         content = sdscatsds(content,state->lines[j]);
01828         content = sdscatlen(content,\textcolor{stringliteral}{"\(\backslash\)n"},1);
01829     \}
01830     \textcolor{keywordflow}{return} content;
01831 \}
01832 
01833 \textcolor{comment}{/* Free the configuration rewrite state. */}
01834 \textcolor{keywordtype}{void} rewriteConfigReleaseState(\textcolor{keyword}{struct} rewriteConfigState *state) \{
01835     sdsfreesplitres(state->lines,state->numlines);
01836     dictRelease(state->option\_to\_line);
01837     dictRelease(state->rewritten);
01838     zfree(state);
01839 \}
01840 
01841 \textcolor{comment}{/* At the end of the rewrite process the state contains the remaining}
01842 \textcolor{comment}{ * map between "option name" => "lines in the original config file".}
01843 \textcolor{comment}{ * Lines used by the rewrite process were removed by the function}
01844 \textcolor{comment}{ * rewriteConfigRewriteLine(), all the other lines are "orphaned" and}
01845 \textcolor{comment}{ * should be replaced by empty lines.}
01846 \textcolor{comment}{ *}
01847 \textcolor{comment}{ * This function does just this, iterating all the option names and}
01848 \textcolor{comment}{ * blanking all the lines still associated. */}
01849 \textcolor{keywordtype}{void} rewriteConfigRemoveOrphaned(\textcolor{keyword}{struct} rewriteConfigState *state) \{
01850     dictIterator *di = dictGetIterator(state->option\_to\_line);
01851     dictEntry *de;
01852 
01853     \textcolor{keywordflow}{while}((de = dictNext(di)) != NULL) \{
01854         list *l = \hyperlink{dict_8h_ae8d2cc391873b2bea2b87c4f80f43120}{dictGetVal}(de);
01855         sds option = \hyperlink{dict_8h_a3271c334309904a3086deca94f96e46e}{dictGetKey}(de);
01856 
01857         \textcolor{comment}{/* Don't blank lines about options the rewrite process}
01858 \textcolor{comment}{         * don't understand. */}
01859         \textcolor{keywordflow}{if} (dictFind(state->rewritten,option) == NULL) \{
01860             serverLog(\hyperlink{server_8h_abcaffe365dee628fcf9fc90c69d534a1}{LL\_DEBUG},\textcolor{stringliteral}{"Not rewritten option: %s"}, option);
01861             \textcolor{keywordflow}{continue};
01862         \}
01863 
01864         \textcolor{keywordflow}{while}(\hyperlink{adlist_8h_afde0ab079f934670e82119b43120e94b}{listLength}(l)) \{
01865             listNode *ln = \hyperlink{adlist_8h_aa8dc514bbe217bb2e87c1c77cfa84690}{listFirst}(l);
01866             \textcolor{keywordtype}{int} linenum = (\textcolor{keywordtype}{long}) ln->value;
01867 
01868             sdsfree(state->lines[linenum]);
01869             state->lines[linenum] = sdsempty();
01870             listDelNode(l,ln);
01871         \}
01872     \}
01873     dictReleaseIterator(di);
01874 \}
01875 
01876 \textcolor{comment}{/* This function overwrites the old configuration file with the new content.}
01877 \textcolor{comment}{ *}
01878 \textcolor{comment}{ * 1) The old file length is obtained.}
01879 \textcolor{comment}{ * 2) If the new content is smaller, padding is added.}
01880 \textcolor{comment}{ * 3) A single write(2) call is used to replace the content of the file.}
01881 \textcolor{comment}{ * 4) Later the file is truncated to the length of the new content.}
01882 \textcolor{comment}{ *}
01883 \textcolor{comment}{ * This way we are sure the file is left in a consistent state even if the}
01884 \textcolor{comment}{ * process is stopped between any of the four operations.}
01885 \textcolor{comment}{ *}
01886 \textcolor{comment}{ * The function returns 0 on success, otherwise -1 is returned and errno}
01887 \textcolor{comment}{ * set accordingly. */}
01888 \textcolor{keywordtype}{int} rewriteConfigOverwriteFile(\textcolor{keywordtype}{char} *configfile, sds content) \{
01889     \textcolor{keywordtype}{int} retval = 0;
01890     \textcolor{keywordtype}{int} fd = open(configfile,O\_RDWR|O\_CREAT,0644);
01891     \textcolor{keywordtype}{int} content\_size = sdslen(content), padding = 0;
01892     \textcolor{keyword}{struct} stat sb;
01893     sds content\_padded;
01894 
01895     \textcolor{comment}{/* 1) Open the old file (or create a new one if it does not}
01896 \textcolor{comment}{     *    exist), get the size. */}
01897     \textcolor{keywordflow}{if} (fd == -1) \textcolor{keywordflow}{return} -1; \textcolor{comment}{/* errno set by open(). */}
01898     \textcolor{keywordflow}{if} (fstat(fd,&sb) == -1) \{
01899         close(fd);
01900         \textcolor{keywordflow}{return} -1; \textcolor{comment}{/* errno set by fstat(). */}
01901     \}
01902 
01903     \textcolor{comment}{/* 2) Pad the content at least match the old file size. */}
01904     content\_padded = sdsdup(content);
01905     \textcolor{keywordflow}{if} (content\_size < sb.st\_size) \{
01906         \textcolor{comment}{/* If the old file was bigger, pad the content with}
01907 \textcolor{comment}{         * a newline plus as many "#" chars as required. */}
01908         padding = sb.st\_size - content\_size;
01909         content\_padded = sdsgrowzero(content\_padded,sb.st\_size);
01910         content\_padded[content\_size] = \textcolor{stringliteral}{'\(\backslash\)n'};
01911         memset(content\_padded+content\_size+1,\textcolor{stringliteral}{'#'},padding-1);
01912     \}
01913 
01914     \textcolor{comment}{/* 3) Write the new content using a single write(2). */}
01915     \textcolor{keywordflow}{if} (write(fd,content\_padded,strlen(content\_padded)) == -1) \{
01916         retval = -1;
01917         \textcolor{keywordflow}{goto} cleanup;
01918     \}
01919 
01920     \textcolor{comment}{/* 4) Truncate the file to the right length if we used padding. */}
01921     \textcolor{keywordflow}{if} (padding) \{
01922         \textcolor{keywordflow}{if} (ftruncate(fd,content\_size) == -1) \{
01923             \textcolor{comment}{/* Non critical error... */}
01924         \}
01925     \}
01926 
01927 cleanup:
01928     sdsfree(content\_padded);
01929     close(fd);
01930     \textcolor{keywordflow}{return} retval;
01931 \}
01932 
01933 \textcolor{comment}{/* Rewrite the configuration file at "path".}
01934 \textcolor{comment}{ * If the configuration file already exists, we try at best to retain comments}
01935 \textcolor{comment}{ * and overall structure.}
01936 \textcolor{comment}{ *}
01937 \textcolor{comment}{ * Configuration parameters that are at their default value, unless already}
01938 \textcolor{comment}{ * explicitly included in the old configuration file, are not rewritten.}
01939 \textcolor{comment}{ *}
01940 \textcolor{comment}{ * On error -1 is returned and errno is set accordingly, otherwise 0. */}
01941 \textcolor{keywordtype}{int} rewriteConfig(\textcolor{keywordtype}{char} *path) \{
01942     \textcolor{keyword}{struct} rewriteConfigState *state;
01943     sds newcontent;
01944     \textcolor{keywordtype}{int} retval;
01945 
01946     \textcolor{comment}{/* Step 1: read the old config into our rewrite state. */}
01947     \textcolor{keywordflow}{if} ((state = rewriteConfigReadOldFile(path)) == NULL) \textcolor{keywordflow}{return} -1;
01948 
01949     \textcolor{comment}{/* Step 2: rewrite every single option, replacing or appending it inside}
01950 \textcolor{comment}{     * the rewrite state. */}
01951 
01952     rewriteConfigYesNoOption(state,\textcolor{stringliteral}{"daemonize"},server.daemonize,0);
01953     rewriteConfigStringOption(state,\textcolor{stringliteral}{"pidfile"},server.pidfile,
      \hyperlink{server_8h_ad0a549a4ce81a4436199706f3513bbc2}{CONFIG\_DEFAULT\_PID\_FILE});
01954     rewriteConfigNumericalOption(state,\textcolor{stringliteral}{"port"},server.port,
      \hyperlink{server_8h_afc9f3396e2da1194ef2ccc6ab97d4e3d}{CONFIG\_DEFAULT\_SERVER\_PORT});
01955     rewriteConfigNumericalOption(state,\textcolor{stringliteral}{"cluster-announce-port"},server.cluster\_announce\_port,
      \hyperlink{server_8h_ac55c8423c202c1f0b4e786eb70adefb3}{CONFIG\_DEFAULT\_CLUSTER\_ANNOUNCE\_PORT});
01956     rewriteConfigNumericalOption(state,\textcolor{stringliteral}{"cluster-announce-bus-port"},server.cluster\_announce\_bus\_port,
      \hyperlink{server_8h_a86d6a82bc81e718079728c3cb6c8c5b4}{CONFIG\_DEFAULT\_CLUSTER\_ANNOUNCE\_BUS\_PORT});
01957     rewriteConfigNumericalOption(state,\textcolor{stringliteral}{"tcp-backlog"},server.tcp\_backlog,
      \hyperlink{server_8h_ab85c155ec2652313a561af139fdb5575}{CONFIG\_DEFAULT\_TCP\_BACKLOG});
01958     rewriteConfigBindOption(state);
01959     rewriteConfigStringOption(state,\textcolor{stringliteral}{"unixsocket"},server.unixsocket,NULL);
01960     rewriteConfigOctalOption(state,\textcolor{stringliteral}{"unixsocketperm"},server.unixsocketperm,
      \hyperlink{server_8h_a486eb6d6b0e44a772877112dbd928494}{CONFIG\_DEFAULT\_UNIX\_SOCKET\_PERM});
01961     rewriteConfigNumericalOption(state,\textcolor{stringliteral}{"timeout"},server.maxidletime,
      \hyperlink{server_8h_a1d6ca2cad092805de3acd7b74876a323}{CONFIG\_DEFAULT\_CLIENT\_TIMEOUT});
01962     rewriteConfigNumericalOption(state,\textcolor{stringliteral}{"tcp-keepalive"},server.tcpkeepalive,
      \hyperlink{server_8h_a2c8d2290c3ac70d63ed2e62b11ab566b}{CONFIG\_DEFAULT\_TCP\_KEEPALIVE});
01963     rewriteConfigNumericalOption(state,\textcolor{stringliteral}{"slave-announce-port"},server.slave\_announce\_port,
      \hyperlink{server_8h_ac8ad217da6cfbdf399948aff4d3550ca}{CONFIG\_DEFAULT\_SLAVE\_ANNOUNCE\_PORT});
01964     rewriteConfigEnumOption(state,\textcolor{stringliteral}{"loglevel"},server.verbosity,loglevel\_enum,
      \hyperlink{server_8h_a407337e4d193cc8fc965938b7a247240}{CONFIG\_DEFAULT\_VERBOSITY});
01965     rewriteConfigStringOption(state,\textcolor{stringliteral}{"logfile"},server.logfile,
      \hyperlink{server_8h_a0698b50ff7fe51afd74cf20a72b75e1b}{CONFIG\_DEFAULT\_LOGFILE});
01966     rewriteConfigYesNoOption(state,\textcolor{stringliteral}{"syslog-enabled"},server.syslog\_enabled,
      \hyperlink{server_8h_a22c57e53d530d95ae346f13d6781a549}{CONFIG\_DEFAULT\_SYSLOG\_ENABLED});
01967     rewriteConfigStringOption(state,\textcolor{stringliteral}{"syslog-ident"},server.syslog\_ident,
      \hyperlink{server_8h_ac7414291a371fd3a2bad4d34e13f0d77}{CONFIG\_DEFAULT\_SYSLOG\_IDENT});
01968     rewriteConfigSyslogfacilityOption(state);
01969     rewriteConfigSaveOption(state);
01970     rewriteConfigNumericalOption(state,\textcolor{stringliteral}{"databases"},server.dbnum,
      \hyperlink{server_8h_abc5ff12d4e9b662f85d2cb11a0220926}{CONFIG\_DEFAULT\_DBNUM});
01971     rewriteConfigYesNoOption(state,\textcolor{stringliteral}{"stop-writes-on-bgsave-error"},server.stop\_writes\_on\_bgsave\_err,
      \hyperlink{server_8h_a050e337ffdb94f18e190cc6d6d851196}{CONFIG\_DEFAULT\_STOP\_WRITES\_ON\_BGSAVE\_ERROR});
01972     rewriteConfigYesNoOption(state,\textcolor{stringliteral}{"rdbcompression"},server.rdb\_compression,
      \hyperlink{server_8h_a250e4ab3a143ecbce2603ffaa3a29c0a}{CONFIG\_DEFAULT\_RDB\_COMPRESSION});
01973     rewriteConfigYesNoOption(state,\textcolor{stringliteral}{"rdbchecksum"},server.rdb\_checksum,
      \hyperlink{server_8h_a549382a72b7490f18a44f03e2dbe5568}{CONFIG\_DEFAULT\_RDB\_CHECKSUM});
01974     rewriteConfigStringOption(state,\textcolor{stringliteral}{"dbfilename"},server.rdb\_filename,
      \hyperlink{server_8h_af563e9454f9a1ef49de787e4fc66c448}{CONFIG\_DEFAULT\_RDB\_FILENAME});
01975     rewriteConfigDirOption(state);
01976     rewriteConfigSlaveofOption(state);
01977     rewriteConfigStringOption(state,\textcolor{stringliteral}{"slave-announce-ip"},server.slave\_announce\_ip,
      \hyperlink{server_8h_aca61db3dff4f6e864b3e49d3f087fb51}{CONFIG\_DEFAULT\_SLAVE\_ANNOUNCE\_IP});
01978     rewriteConfigStringOption(state,\textcolor{stringliteral}{"masterauth"},server.masterauth,NULL);
01979     rewriteConfigStringOption(state,\textcolor{stringliteral}{"cluster-announce-ip"},server.cluster\_announce\_ip,NULL);
01980     rewriteConfigYesNoOption(state,\textcolor{stringliteral}{"slave-serve-stale-data"},server.repl\_serve\_stale\_data,
      \hyperlink{server_8h_ab42b23884952f9887529b6efbf0d4ac6}{CONFIG\_DEFAULT\_SLAVE\_SERVE\_STALE\_DATA});
01981     rewriteConfigYesNoOption(state,\textcolor{stringliteral}{"slave-read-only"},server.repl\_slave\_ro,
      \hyperlink{server_8h_af9b93e225d47183c97bc1f86db1aff2a}{CONFIG\_DEFAULT\_SLAVE\_READ\_ONLY});
01982     rewriteConfigNumericalOption(state,\textcolor{stringliteral}{"repl-ping-slave-period"},server.repl\_ping\_slave\_period,
      \hyperlink{server_8h_a5496312872886690751d1e4a248026e9}{CONFIG\_DEFAULT\_REPL\_PING\_SLAVE\_PERIOD});
01983     rewriteConfigNumericalOption(state,\textcolor{stringliteral}{"repl-timeout"},server.repl\_timeout,
      \hyperlink{server_8h_a7608d2301c8447e2237ba173d8eef88e}{CONFIG\_DEFAULT\_REPL\_TIMEOUT});
01984     rewriteConfigBytesOption(state,\textcolor{stringliteral}{"repl-backlog-size"},server.repl\_backlog\_size,
      \hyperlink{server_8h_a6ac2fd3dd83df43a6b262bab091bc371}{CONFIG\_DEFAULT\_REPL\_BACKLOG\_SIZE});
01985     rewriteConfigBytesOption(state,\textcolor{stringliteral}{"repl-backlog-ttl"},server.repl\_backlog\_time\_limit,
      \hyperlink{server_8h_ac5c5c62f45277671484daad919338b5e}{CONFIG\_DEFAULT\_REPL\_BACKLOG\_TIME\_LIMIT});
01986     rewriteConfigYesNoOption(state,\textcolor{stringliteral}{"repl-disable-tcp-nodelay"},server.repl\_disable\_tcp\_nodelay,
      \hyperlink{server_8h_a27f51044a8a11ab99366a77bb3ea1e93}{CONFIG\_DEFAULT\_REPL\_DISABLE\_TCP\_NODELAY});
01987     rewriteConfigYesNoOption(state,\textcolor{stringliteral}{"repl-diskless-sync"},server.repl\_diskless\_sync,
      \hyperlink{server_8h_a08ebaf972da18ad58c71c615aa26c5cf}{CONFIG\_DEFAULT\_REPL\_DISKLESS\_SYNC});
01988     rewriteConfigNumericalOption(state,\textcolor{stringliteral}{"repl-diskless-sync-delay"},server.repl\_diskless\_sync\_delay,
      \hyperlink{server_8h_aee54cf0e2819c8b96136987f0f8ef0b8}{CONFIG\_DEFAULT\_REPL\_DISKLESS\_SYNC\_DELAY});
01989     rewriteConfigNumericalOption(state,\textcolor{stringliteral}{"slave-priority"},server.slave\_priority,
      \hyperlink{server_8h_a7effaf912f26a1eabe495e899d705fee}{CONFIG\_DEFAULT\_SLAVE\_PRIORITY});
01990     rewriteConfigNumericalOption(state,\textcolor{stringliteral}{"min-slaves-to-write"},server.repl\_min\_slaves\_to\_write,
      \hyperlink{server_8h_a68661cd596afb7595059264beee63dc7}{CONFIG\_DEFAULT\_MIN\_SLAVES\_TO\_WRITE});
01991     rewriteConfigNumericalOption(state,\textcolor{stringliteral}{"min-slaves-max-lag"},server.repl\_min\_slaves\_max\_lag,
      \hyperlink{server_8h_a547664770d2cec2d58d144a2f5afbbd8}{CONFIG\_DEFAULT\_MIN\_SLAVES\_MAX\_LAG});
01992     rewriteConfigStringOption(state,\textcolor{stringliteral}{"requirepass"},server.requirepass,NULL);
01993     rewriteConfigNumericalOption(state,\textcolor{stringliteral}{"maxclients"},server.maxclients,
      \hyperlink{server_8h_ab24065d7a9205264189681ab4e4d410e}{CONFIG\_DEFAULT\_MAX\_CLIENTS});
01994     rewriteConfigBytesOption(state,\textcolor{stringliteral}{"maxmemory"},server.maxmemory,
      \hyperlink{server_8h_a314eacfa28e22254ee8cc05f2b257281}{CONFIG\_DEFAULT\_MAXMEMORY});
01995     rewriteConfigEnumOption(state,\textcolor{stringliteral}{"maxmemory-policy"},server.maxmemory\_policy,maxmemory\_policy\_enum,
      \hyperlink{server_8h_a5b8590d1c7aa090e48b9506c0842d206}{CONFIG\_DEFAULT\_MAXMEMORY\_POLICY});
01996     rewriteConfigNumericalOption(state,\textcolor{stringliteral}{"maxmemory-samples"},server.maxmemory\_samples,
      \hyperlink{server_8h_a38e65004c240be8a04ab492731c7da50}{CONFIG\_DEFAULT\_MAXMEMORY\_SAMPLES});
01997     rewriteConfigNumericalOption(state,\textcolor{stringliteral}{"lfu-log-factor"},server.lfu\_log\_factor,
      \hyperlink{server_8h_ab343786c44a1885885a1ac254b724317}{CONFIG\_DEFAULT\_LFU\_LOG\_FACTOR});
01998     rewriteConfigNumericalOption(state,\textcolor{stringliteral}{"lfu-decay-time"},server.lfu\_decay\_time,
      \hyperlink{server_8h_a24a132a96a693133fc057a491080aebf}{CONFIG\_DEFAULT\_LFU\_DECAY\_TIME});
01999     rewriteConfigNumericalOption(state,\textcolor{stringliteral}{"active-defrag-threshold-lower"},server.
      active\_defrag\_threshold\_lower,\hyperlink{server_8h_a9d23ea1ff80f9db5faef6f5aca6f76aa}{CONFIG\_DEFAULT\_DEFRAG\_THRESHOLD\_LOWER});
02000     rewriteConfigNumericalOption(state,\textcolor{stringliteral}{"active-defrag-threshold-upper"},server.
      active\_defrag\_threshold\_upper,\hyperlink{server_8h_a75b8ce2fafb93ddeb96f0e5602c2bd0c}{CONFIG\_DEFAULT\_DEFRAG\_THRESHOLD\_UPPER});
02001     rewriteConfigBytesOption(state,\textcolor{stringliteral}{"active-defrag-ignore-bytes"},server.active\_defrag\_ignore\_bytes,
      \hyperlink{server_8h_aed98ddd341b643d52417b875418b2ecb}{CONFIG\_DEFAULT\_DEFRAG\_IGNORE\_BYTES});
02002     rewriteConfigNumericalOption(state,\textcolor{stringliteral}{"active-defrag-cycle-min"},server.active\_defrag\_cycle\_min,
      \hyperlink{server_8h_a5d49d5c9a11564577f7e78d6f52d9db5}{CONFIG\_DEFAULT\_DEFRAG\_CYCLE\_MIN});
02003     rewriteConfigNumericalOption(state,\textcolor{stringliteral}{"active-defrag-cycle-max"},server.active\_defrag\_cycle\_max,
      \hyperlink{server_8h_ac3f69c7e78a189639eab66a2b32753d0}{CONFIG\_DEFAULT\_DEFRAG\_CYCLE\_MAX});
02004     rewriteConfigYesNoOption(state,\textcolor{stringliteral}{"appendonly"},server.aof\_state != \hyperlink{server_8h_a5226306fbcebcb6d5d02e0fef3c213c2}{AOF\_OFF},0);
02005     rewriteConfigStringOption(state,\textcolor{stringliteral}{"appendfilename"},server.aof\_filename,
      \hyperlink{server_8h_af3bada72076c951a9d5959e73456635a}{CONFIG\_DEFAULT\_AOF\_FILENAME});
02006     rewriteConfigEnumOption(state,\textcolor{stringliteral}{"appendfsync"},server.\hyperlink{config_8h_af5994c643c434574580bb7816af82cad}{aof\_fsync},aof\_fsync\_enum,
      \hyperlink{server_8h_af07bcc4b15ed4f7aed3f6efcb483b75b}{CONFIG\_DEFAULT\_AOF\_FSYNC});
02007     rewriteConfigYesNoOption(state,\textcolor{stringliteral}{"no-appendfsync-on-rewrite"},server.aof\_no\_fsync\_on\_rewrite,
      \hyperlink{server_8h_a9b588e3803fff7fe515f20d7bc4aa8e6}{CONFIG\_DEFAULT\_AOF\_NO\_FSYNC\_ON\_REWRITE});
02008     rewriteConfigNumericalOption(state,\textcolor{stringliteral}{"auto-aof-rewrite-percentage"},server.aof\_rewrite\_perc,
      \hyperlink{server_8h_a85f5870a07f58d1679988f7eb84ca995}{AOF\_REWRITE\_PERC});
02009     rewriteConfigBytesOption(state,\textcolor{stringliteral}{"auto-aof-rewrite-min-size"},server.aof\_rewrite\_min\_size,
      \hyperlink{server_8h_a9b5a91047aa18eb5df52e99c97afab84}{AOF\_REWRITE\_MIN\_SIZE});
02010     rewriteConfigNumericalOption(state,\textcolor{stringliteral}{"lua-time-limit"},server.lua\_time\_limit,
      \hyperlink{server_8h_ab72fac70fbc902a7f106f4c710e08271}{LUA\_SCRIPT\_TIME\_LIMIT});
02011     rewriteConfigYesNoOption(state,\textcolor{stringliteral}{"cluster-enabled"},server.cluster\_enabled,0);
02012     rewriteConfigStringOption(state,\textcolor{stringliteral}{"cluster-config-file"},server.cluster\_configfile,
      \hyperlink{server_8h_a5b0c46fd63529819e2c0189003d72122}{CONFIG\_DEFAULT\_CLUSTER\_CONFIG\_FILE});
02013     rewriteConfigYesNoOption(state,\textcolor{stringliteral}{"cluster-require-full-coverage"},server.
      cluster\_require\_full\_coverage,\hyperlink{cluster_8h_aa27e3466414a1464e6f2721b8872827d}{CLUSTER\_DEFAULT\_REQUIRE\_FULL\_COVERAGE});
02014     rewriteConfigNumericalOption(state,\textcolor{stringliteral}{"cluster-node-timeout"},server.cluster\_node\_timeout,
      \hyperlink{cluster_8h_acb94b0516dcfb9814e13dfe97f3ad6b1}{CLUSTER\_DEFAULT\_NODE\_TIMEOUT});
02015     rewriteConfigNumericalOption(state,\textcolor{stringliteral}{"cluster-migration-barrier"},server.cluster\_migration\_barrier,
      \hyperlink{cluster_8h_a1895138f4125c5dce77e8fe28c9bd8d1}{CLUSTER\_DEFAULT\_MIGRATION\_BARRIER});
02016     rewriteConfigNumericalOption(state,\textcolor{stringliteral}{"cluster-slave-validity-factor"},server.
      cluster\_slave\_validity\_factor,\hyperlink{cluster_8h_a44b183827017eca27648d5991fc50b13}{CLUSTER\_DEFAULT\_SLAVE\_VALIDITY});
02017     rewriteConfigNumericalOption(state,\textcolor{stringliteral}{"slowlog-log-slower-than"},server.slowlog\_log\_slower\_than,
      \hyperlink{server_8h_a3cf317db9aeeba99be3654b11d3d0580}{CONFIG\_DEFAULT\_SLOWLOG\_LOG\_SLOWER\_THAN});
02018     rewriteConfigNumericalOption(state,\textcolor{stringliteral}{"latency-monitor-threshold"},server.latency\_monitor\_threshold,
      \hyperlink{server_8h_a20a7f934b2eceae8fdbb1ac112a783c3}{CONFIG\_DEFAULT\_LATENCY\_MONITOR\_THRESHOLD});
02019     rewriteConfigNumericalOption(state,\textcolor{stringliteral}{"slowlog-max-len"},server.slowlog\_max\_len,
      \hyperlink{server_8h_ada65a939812527070ed001e451d9bc54}{CONFIG\_DEFAULT\_SLOWLOG\_MAX\_LEN});
02020     rewriteConfigNotifykeyspaceeventsOption(state);
02021     rewriteConfigNumericalOption(state,\textcolor{stringliteral}{"hash-max-ziplist-entries"},server.hash\_max\_ziplist\_entries,
      \hyperlink{server_8h_a41a8473748a5eeafbd30b20f22177c51}{OBJ\_HASH\_MAX\_ZIPLIST\_ENTRIES});
02022     rewriteConfigNumericalOption(state,\textcolor{stringliteral}{"hash-max-ziplist-value"},server.hash\_max\_ziplist\_value,
      \hyperlink{server_8h_a63842e277a2ccef80f42cbae07c9f5d8}{OBJ\_HASH\_MAX\_ZIPLIST\_VALUE});
02023     rewriteConfigNumericalOption(state,\textcolor{stringliteral}{"list-max-ziplist-size"},server.list\_max\_ziplist\_size,
      \hyperlink{server_8h_a27c7e814708df2c7eed37fbc6ac0b7f1}{OBJ\_LIST\_MAX\_ZIPLIST\_SIZE});
02024     rewriteConfigNumericalOption(state,\textcolor{stringliteral}{"list-compress-depth"},server.list\_compress\_depth,
      \hyperlink{server_8h_a7b811522f7befdc10e69883f360e45b4}{OBJ\_LIST\_COMPRESS\_DEPTH});
02025     rewriteConfigNumericalOption(state,\textcolor{stringliteral}{"set-max-intset-entries"},server.set\_max\_intset\_entries,
      \hyperlink{server_8h_a333fe7f520eb6f33cd1c88e4691de3ed}{OBJ\_SET\_MAX\_INTSET\_ENTRIES});
02026     rewriteConfigNumericalOption(state,\textcolor{stringliteral}{"zset-max-ziplist-entries"},server.zset\_max\_ziplist\_entries,
      \hyperlink{server_8h_ac29d7218c448fac5b27039cf0d73fde2}{OBJ\_ZSET\_MAX\_ZIPLIST\_ENTRIES});
02027     rewriteConfigNumericalOption(state,\textcolor{stringliteral}{"zset-max-ziplist-value"},server.zset\_max\_ziplist\_value,
      \hyperlink{server_8h_a24b004e72489e83f721bdd334234aa49}{OBJ\_ZSET\_MAX\_ZIPLIST\_VALUE});
02028     rewriteConfigNumericalOption(state,\textcolor{stringliteral}{"hll-sparse-max-bytes"},server.hll\_sparse\_max\_bytes,
      \hyperlink{server_8h_a479f69398ffb0f86fdbb4fa03876bc69}{CONFIG\_DEFAULT\_HLL\_SPARSE\_MAX\_BYTES});
02029     rewriteConfigYesNoOption(state,\textcolor{stringliteral}{"activerehashing"},server.activerehashing,
      \hyperlink{server_8h_a147863f3b338d25f54e026d88a487010}{CONFIG\_DEFAULT\_ACTIVE\_REHASHING});
02030     rewriteConfigYesNoOption(state,\textcolor{stringliteral}{"activedefrag"},server.active\_defrag\_enabled,
      \hyperlink{server_8h_a7bc03a080189821c8c88b31027281d4b}{CONFIG\_DEFAULT\_ACTIVE\_DEFRAG});
02031     rewriteConfigYesNoOption(state,\textcolor{stringliteral}{"protected-mode"},server.protected\_mode,
      \hyperlink{server_8h_aa84cedc4d9e3da82d28324a85626a666}{CONFIG\_DEFAULT\_PROTECTED\_MODE});
02032     rewriteConfigClientoutputbufferlimitOption(state);
02033     rewriteConfigNumericalOption(state,\textcolor{stringliteral}{"hz"},server.hz,\hyperlink{server_8h_aa5a3b127e21d6bf089025d953c44678a}{CONFIG\_DEFAULT\_HZ});
02034     rewriteConfigYesNoOption(state,\textcolor{stringliteral}{"aof-rewrite-incremental-fsync"},server.
      aof\_rewrite\_incremental\_fsync,\hyperlink{server_8h_a356d1b1e39a75671cc55fdaf64be3a85}{CONFIG\_DEFAULT\_AOF\_REWRITE\_INCREMENTAL\_FSYNC});
02035     rewriteConfigYesNoOption(state,\textcolor{stringliteral}{"aof-load-truncated"},server.aof\_load\_truncated,
      \hyperlink{server_8h_a35b94be7201c7ad80e43f8aa214867b7}{CONFIG\_DEFAULT\_AOF\_LOAD\_TRUNCATED});
02036     rewriteConfigYesNoOption(state,\textcolor{stringliteral}{"aof-use-rdb-preamble"},server.aof\_use\_rdb\_preamble,
      \hyperlink{server_8h_a938328826b94d0e9bd07b225767cad43}{CONFIG\_DEFAULT\_AOF\_USE\_RDB\_PREAMBLE});
02037     rewriteConfigEnumOption(state,\textcolor{stringliteral}{"supervised"},server.supervised\_mode,supervised\_mode\_enum,
      \hyperlink{server_8h_a2a0d6ba64b419357e52a6473f48bc882}{SUPERVISED\_NONE});
02038     rewriteConfigYesNoOption(state,\textcolor{stringliteral}{"lazyfree-lazy-eviction"},server.lazyfree\_lazy\_eviction,
      \hyperlink{server_8h_aa6529c6ba7143b1ec4aa15d8a96b2154}{CONFIG\_DEFAULT\_LAZYFREE\_LAZY\_EVICTION});
02039     rewriteConfigYesNoOption(state,\textcolor{stringliteral}{"lazyfree-lazy-expire"},server.lazyfree\_lazy\_expire,
      \hyperlink{server_8h_a2e6080731ab6e81b19f1bfedf7b298f9}{CONFIG\_DEFAULT\_LAZYFREE\_LAZY\_EXPIRE});
02040     rewriteConfigYesNoOption(state,\textcolor{stringliteral}{"lazyfree-lazy-server-del"},server.lazyfree\_lazy\_server\_del,
      \hyperlink{server_8h_ac1f765315b576de4c0ea2beb7e37ae02}{CONFIG\_DEFAULT\_LAZYFREE\_LAZY\_SERVER\_DEL});
02041     rewriteConfigYesNoOption(state,\textcolor{stringliteral}{"slave-lazy-flush"},server.repl\_slave\_lazy\_flush,
      \hyperlink{server_8h_ace54c14c3b13acbf1d7a6d6e893cdfd3}{CONFIG\_DEFAULT\_SLAVE\_LAZY\_FLUSH});
02042 
02043     \textcolor{comment}{/* Rewrite Sentinel config if in Sentinel mode. */}
02044     \textcolor{keywordflow}{if} (server.sentinel\_mode) rewriteConfigSentinelOption(state);
02045 
02046     \textcolor{comment}{/* Step 3: remove all the orphaned lines in the old file, that is, lines}
02047 \textcolor{comment}{     * that were used by a config option and are no longer used, like in case}
02048 \textcolor{comment}{     * of multiple "save" options or duplicated options. */}
02049     rewriteConfigRemoveOrphaned(state);
02050 
02051     \textcolor{comment}{/* Step 4: generate a new configuration file from the modified state}
02052 \textcolor{comment}{     * and write it into the original file. */}
02053     newcontent = rewriteConfigGetContentFromState(state);
02054     retval = rewriteConfigOverwriteFile(server.configfile,newcontent);
02055 
02056     sdsfree(newcontent);
02057     rewriteConfigReleaseState(state);
02058     \textcolor{keywordflow}{return} retval;
02059 \}
02060 
02061 \textcolor{comment}{/*-----------------------------------------------------------------------------}
02062 \textcolor{comment}{ * CONFIG command entry point}
02063 \textcolor{comment}{ *----------------------------------------------------------------------------*/}
02064 
02065 \textcolor{keywordtype}{void} configCommand(\hyperlink{structclient}{client} *c) \{
02066     \textcolor{comment}{/* Only allow CONFIG GET while loading. */}
02067     \textcolor{keywordflow}{if} (server.loading && strcasecmp(c->argv[1]->ptr,\textcolor{stringliteral}{"get"})) \{
02068         addReplyError(c,\textcolor{stringliteral}{"Only CONFIG GET is allowed during loading"});
02069         \textcolor{keywordflow}{return};
02070     \}
02071 
02072     \textcolor{keywordflow}{if} (c->argc == 2 && !strcasecmp(c->argv[1]->ptr,\textcolor{stringliteral}{"help"})) \{
02073         \textcolor{keyword}{const} \textcolor{keywordtype}{char} *help[] = \{
02074 \textcolor{stringliteral}{"get <pattern> -- Return parameters matching the glob-like <pattern> and their values."},
02075 \textcolor{stringliteral}{"set <parameter> <value> -- Set parameter to value."},
02076 \textcolor{stringliteral}{"resetstat -- Reset statistics reported by INFO."},
02077 \textcolor{stringliteral}{"rewrite -- Rewrite the configuration file."},
02078 NULL
02079         \};
02080         addReplyHelp(c, help);
02081     \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(c->argv[1]->ptr,\textcolor{stringliteral}{"set"}) && c->argc == 4) \{
02082         configSetCommand(c);
02083     \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(c->argv[1]->ptr,\textcolor{stringliteral}{"get"}) && c->argc == 3) \{
02084         configGetCommand(c);
02085     \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(c->argv[1]->ptr,\textcolor{stringliteral}{"resetstat"}) && c->argc == 2) \{
02086         resetServerStats();
02087         resetCommandTableStats();
02088         addReply(c,shared.ok);
02089     \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(c->argv[1]->ptr,\textcolor{stringliteral}{"rewrite"}) && c->argc == 2) \{
02090         \textcolor{keywordflow}{if} (server.configfile == NULL) \{
02091             addReplyError(c,\textcolor{stringliteral}{"The server is running without a config file"});
02092             \textcolor{keywordflow}{return};
02093         \}
02094         \textcolor{keywordflow}{if} (rewriteConfig(server.configfile) == -1) \{
02095             serverLog(\hyperlink{server_8h_a31229b9334bba7d6be2a72970967a14b}{LL\_WARNING},\textcolor{stringliteral}{"CONFIG REWRITE failed: %s"}, strerror(errno));
02096             addReplyErrorFormat(c,\textcolor{stringliteral}{"Rewriting config file: %s"}, strerror(errno));
02097         \} \textcolor{keywordflow}{else} \{
02098             serverLog(\hyperlink{server_8h_a31229b9334bba7d6be2a72970967a14b}{LL\_WARNING},\textcolor{stringliteral}{"CONFIG REWRITE executed with success."});
02099             addReply(c,shared.ok);
02100         \}
02101     \} \textcolor{keywordflow}{else} \{
02102          addReplyErrorFormat(c, \textcolor{stringliteral}{"Unknown subcommand or wrong number of arguments for '%s'. Try CONFIG
       HELP"},
02103             (\textcolor{keywordtype}{char}*)c->argv[1]->ptr);
02104         \textcolor{keywordflow}{return};
02105     \}
02106 \}
\end{DoxyCode}
