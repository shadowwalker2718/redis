\hypertarget{sentinel_8c_source}{}\section{sentinel.\+c}
\label{sentinel_8c_source}\index{src/sentinel.\+c@{src/sentinel.\+c}}

\begin{DoxyCode}
00001 \textcolor{comment}{/* Redis Sentinel implementation}
00002 \textcolor{comment}{ *}
00003 \textcolor{comment}{ * Copyright (c) 2009-2012, Salvatore Sanfilippo <antirez at gmail dot com>}
00004 \textcolor{comment}{ * All rights reserved.}
00005 \textcolor{comment}{ *}
00006 \textcolor{comment}{ * Redistribution and use in source and binary forms, with or without}
00007 \textcolor{comment}{ * modification, are permitted provided that the following conditions are met:}
00008 \textcolor{comment}{ *}
00009 \textcolor{comment}{ *   * Redistributions of source code must retain the above copyright notice,}
00010 \textcolor{comment}{ *     this list of conditions and the following disclaimer.}
00011 \textcolor{comment}{ *   * Redistributions in binary form must reproduce the above copyright}
00012 \textcolor{comment}{ *     notice, this list of conditions and the following disclaimer in the}
00013 \textcolor{comment}{ *     documentation and/or other materials provided with the distribution.}
00014 \textcolor{comment}{ *   * Neither the name of Redis nor the names of its contributors may be used}
00015 \textcolor{comment}{ *     to endorse or promote products derived from this software without}
00016 \textcolor{comment}{ *     specific prior written permission.}
00017 \textcolor{comment}{ *}
00018 \textcolor{comment}{ * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"}
00019 \textcolor{comment}{ * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE}
00020 \textcolor{comment}{ * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE}
00021 \textcolor{comment}{ * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE}
00022 \textcolor{comment}{ * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR}
00023 \textcolor{comment}{ * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF}
00024 \textcolor{comment}{ * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS}
00025 \textcolor{comment}{ * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN}
00026 \textcolor{comment}{ * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)}
00027 \textcolor{comment}{ * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE}
00028 \textcolor{comment}{ * POSSIBILITY OF SUCH DAMAGE.}
00029 \textcolor{comment}{ */}
00030 
00031 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \hyperlink{server_8h}{"server.h"}
00032 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{"hiredis.h"}
00033 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{"async.h"}
00034 
00035 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{ctype}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00036 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{arpa}\textcolor{preprocessor}{/}\textcolor{preprocessor}{inet}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00037 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{sys}\textcolor{preprocessor}{/}\textcolor{preprocessor}{socket}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00038 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{sys}\textcolor{preprocessor}{/}\textcolor{preprocessor}{wait}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00039 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{fcntl}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00040 
00041 \textcolor{keyword}{extern} \textcolor{keywordtype}{char} **environ;
00042 
00043 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{REDIS\_SENTINEL\_PORT} 26379
00044 
00045 \textcolor{comment}{/* ======================== Sentinel global state =========================== */}
00046 
00047 \textcolor{comment}{/* Address object, used to describe an ip:port pair. */}
\Hypertarget{sentinel_8c_source_l00048}\hyperlink{structsentinelAddr}{00048} \textcolor{keyword}{typedef} \textcolor{keyword}{struct} \hyperlink{structsentinelAddr}{sentinelAddr} \{
00049     \textcolor{keywordtype}{char} *ip;
00050     \textcolor{keywordtype}{int} port;
00051 \} sentinelAddr;
00052 
00053 \textcolor{comment}{/* A Sentinel Redis Instance object is monitoring. */}
00054 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{SRI\_MASTER}  \textcolor{preprocessor}{(}1\textcolor{preprocessor}{<<}0\textcolor{preprocessor}{)}
00055 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{SRI\_SLAVE}   \textcolor{preprocessor}{(}1\textcolor{preprocessor}{<<}1\textcolor{preprocessor}{)}
00056 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{SRI\_SENTINEL} \textcolor{preprocessor}{(}1\textcolor{preprocessor}{<<}2\textcolor{preprocessor}{)}
00057 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{SRI\_S\_DOWN} \textcolor{preprocessor}{(}1\textcolor{preprocessor}{<<}3\textcolor{preprocessor}{)}   \textcolor{comment}{/* Subjectively down (no quorum). */}
00058 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{SRI\_O\_DOWN} \textcolor{preprocessor}{(}1\textcolor{preprocessor}{<<}4\textcolor{preprocessor}{)}   \textcolor{comment}{/* Objectively down (confirmed by others). */}
00059 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{SRI\_MASTER\_DOWN} \textcolor{preprocessor}{(}1\textcolor{preprocessor}{<<}5\textcolor{preprocessor}{)} \textcolor{comment}{/* A Sentinel with this flag set thinks that}
00060 \textcolor{comment}{                                   its master is down. */}
00061 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{SRI\_FAILOVER\_IN\_PROGRESS} \textcolor{preprocessor}{(}1\textcolor{preprocessor}{<<}6\textcolor{preprocessor}{)} \textcolor{comment}{/* Failover is in progress for}
00062 \textcolor{comment}{                                           this master. */}
00063 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{SRI\_PROMOTED} \textcolor{preprocessor}{(}1\textcolor{preprocessor}{<<}7\textcolor{preprocessor}{)}            \textcolor{comment}{/* Slave selected for promotion. */}
00064 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{SRI\_RECONF\_SENT} \textcolor{preprocessor}{(}1\textcolor{preprocessor}{<<}8\textcolor{preprocessor}{)}     \textcolor{comment}{/* SLAVEOF <newmaster> sent. */}
00065 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{SRI\_RECONF\_INPROG} \textcolor{preprocessor}{(}1\textcolor{preprocessor}{<<}9\textcolor{preprocessor}{)}   \textcolor{comment}{/* Slave synchronization in progress. */}
00066 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{SRI\_RECONF\_DONE} \textcolor{preprocessor}{(}1\textcolor{preprocessor}{<<}10\textcolor{preprocessor}{)}     \textcolor{comment}{/* Slave synchronized with new master. */}
00067 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{SRI\_FORCE\_FAILOVER} \textcolor{preprocessor}{(}1\textcolor{preprocessor}{<<}11\textcolor{preprocessor}{)}  \textcolor{comment}{/* Force failover with master up. */}
00068 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{SRI\_SCRIPT\_KILL\_SENT} \textcolor{preprocessor}{(}1\textcolor{preprocessor}{<<}12\textcolor{preprocessor}{)} \textcolor{comment}{/* SCRIPT KILL already sent on -BUSY */}
00069 
00070 \textcolor{comment}{/* Note: times are in milliseconds. */}
00071 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{SENTINEL\_INFO\_PERIOD} 10000
00072 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{SENTINEL\_PING\_PERIOD} 1000
00073 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{SENTINEL\_ASK\_PERIOD} 1000
00074 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{SENTINEL\_PUBLISH\_PERIOD} 2000
00075 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{SENTINEL\_DEFAULT\_DOWN\_AFTER} 30000
00076 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{SENTINEL\_HELLO\_CHANNEL} \textcolor{stringliteral}{"\_\_sentinel\_\_:hello"}
00077 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{SENTINEL\_TILT\_TRIGGER} 2000
00078 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{SENTINEL\_TILT\_PERIOD} \textcolor{preprocessor}{(}\hyperlink{sentinel_8c_a9e22409355fa7a4db7f3a43fbe2d9101}{SENTINEL\_PING\_PERIOD}\textcolor{preprocessor}{*}30\textcolor{preprocessor}{)}
00079 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{SENTINEL\_DEFAULT\_SLAVE\_PRIORITY} 100
00080 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{SENTINEL\_SLAVE\_RECONF\_TIMEOUT} 10000
00081 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{SENTINEL\_DEFAULT\_PARALLEL\_SYNCS} 1
00082 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{SENTINEL\_MIN\_LINK\_RECONNECT\_PERIOD} 15000
00083 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{SENTINEL\_DEFAULT\_FAILOVER\_TIMEOUT} \textcolor{preprocessor}{(}60\textcolor{preprocessor}{*}3\textcolor{preprocessor}{*}1000\textcolor{preprocessor}{)}
00084 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{SENTINEL\_MAX\_PENDING\_COMMANDS} 100
00085 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{SENTINEL\_ELECTION\_TIMEOUT} 10000
00086 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{SENTINEL\_MAX\_DESYNC} 1000
00087 
00088 \textcolor{comment}{/* Failover machine different states. */}
00089 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{SENTINEL\_FAILOVER\_STATE\_NONE} 0  \textcolor{comment}{/* No failover in progress. */}
00090 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{SENTINEL\_FAILOVER\_STATE\_WAIT\_START} 1  \textcolor{comment}{/* Wait for failover\_start\_time*/}
00091 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{SENTINEL\_FAILOVER\_STATE\_SELECT\_SLAVE} 2 \textcolor{comment}{/* Select slave to promote */}
00092 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{SENTINEL\_FAILOVER\_STATE\_SEND\_SLAVEOF\_NOONE} 3 \textcolor{comment}{/* Slave -> Master */}
00093 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{SENTINEL\_FAILOVER\_STATE\_WAIT\_PROMOTION} 4 \textcolor{comment}{/* Wait slave to change role */}
00094 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{SENTINEL\_FAILOVER\_STATE\_RECONF\_SLAVES} 5 \textcolor{comment}{/* SLAVEOF newmaster */}
00095 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{SENTINEL\_FAILOVER\_STATE\_UPDATE\_CONFIG} 6 \textcolor{comment}{/* Monitor promoted slave. */}
00096 
00097 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{SENTINEL\_MASTER\_LINK\_STATUS\_UP} 0
00098 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{SENTINEL\_MASTER\_LINK\_STATUS\_DOWN} 1
00099 
00100 \textcolor{comment}{/* Generic flags that can be used with different functions.}
00101 \textcolor{comment}{ * They use higher bits to avoid colliding with the function specific}
00102 \textcolor{comment}{ * flags. */}
00103 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{SENTINEL\_NO\_FLAGS} 0
00104 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{SENTINEL\_GENERATE\_EVENT} \textcolor{preprocessor}{(}1\textcolor{preprocessor}{<<}16\textcolor{preprocessor}{)}
00105 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{SENTINEL\_LEADER} \textcolor{preprocessor}{(}1\textcolor{preprocessor}{<<}17\textcolor{preprocessor}{)}
00106 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{SENTINEL\_OBSERVER} \textcolor{preprocessor}{(}1\textcolor{preprocessor}{<<}18\textcolor{preprocessor}{)}
00107 
00108 \textcolor{comment}{/* Script execution flags and limits. */}
00109 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{SENTINEL\_SCRIPT\_NONE} 0
00110 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{SENTINEL\_SCRIPT\_RUNNING} 1
00111 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{SENTINEL\_SCRIPT\_MAX\_QUEUE} 256
00112 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{SENTINEL\_SCRIPT\_MAX\_RUNNING} 16
00113 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{SENTINEL\_SCRIPT\_MAX\_RUNTIME} 60000 \textcolor{comment}{/* 60 seconds max exec time. */}
00114 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{SENTINEL\_SCRIPT\_MAX\_RETRY} 10
00115 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{SENTINEL\_SCRIPT\_RETRY\_DELAY} 30000 \textcolor{comment}{/* 30 seconds between retries. */}
00116 
00117 \textcolor{comment}{/* SENTINEL SIMULATE-FAILURE command flags. */}
00118 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{SENTINEL\_SIMFAILURE\_NONE} 0
00119 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{SENTINEL\_SIMFAILURE\_CRASH\_AFTER\_ELECTION} \textcolor{preprocessor}{(}1\textcolor{preprocessor}{<<}0\textcolor{preprocessor}{)}
00120 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{SENTINEL\_SIMFAILURE\_CRASH\_AFTER\_PROMOTION} \textcolor{preprocessor}{(}1\textcolor{preprocessor}{<<}1\textcolor{preprocessor}{)}
00121 
00122 \textcolor{comment}{/* The link to a sentinelRedisInstance. When we have the same set of Sentinels}
00123 \textcolor{comment}{ * monitoring many masters, we have different instances representing the}
00124 \textcolor{comment}{ * same Sentinels, one per master, and we need to share the hiredis connections}
00125 \textcolor{comment}{ * among them. Oherwise if 5 Sentinels are monitoring 100 masters we create}
00126 \textcolor{comment}{ * 500 outgoing connections instead of 5.}
00127 \textcolor{comment}{ *}
00128 \textcolor{comment}{ * So this structure represents a reference counted link in terms of the two}
00129 \textcolor{comment}{ * hiredis connections for commands and Pub/Sub, and the fields needed for}
00130 \textcolor{comment}{ * failure detection, since the ping/pong time are now local to the link: if}
00131 \textcolor{comment}{ * the link is available, the instance is avaialbe. This way we don't just}
00132 \textcolor{comment}{ * have 5 connections instead of 500, we also send 5 pings instead of 500.}
00133 \textcolor{comment}{ *}
00134 \textcolor{comment}{ * Links are shared only for Sentinels: master and slave instances have}
00135 \textcolor{comment}{ * a link with refcount = 1, always. */}
\Hypertarget{sentinel_8c_source_l00136}\hyperlink{structinstanceLink}{00136} \textcolor{keyword}{typedef} \textcolor{keyword}{struct} \hyperlink{structinstanceLink}{instanceLink} \{
00137     \textcolor{keywordtype}{int} refcount;          \textcolor{comment}{/* Number of sentinelRedisInstance owners. */}
00138     \textcolor{keywordtype}{int} disconnected;      \textcolor{comment}{/* Non-zero if we need to reconnect cc or pc. */}
00139     \textcolor{keywordtype}{int} pending\_commands;  \textcolor{comment}{/* Number of commands sent waiting for a reply. */}
00140     redisAsyncContext *cc; \textcolor{comment}{/* Hiredis context for commands. */}
00141     redisAsyncContext *pc; \textcolor{comment}{/* Hiredis context for Pub / Sub. */}
00142     mstime\_t cc\_conn\_time; \textcolor{comment}{/* cc connection time. */}
00143     mstime\_t pc\_conn\_time; \textcolor{comment}{/* pc connection time. */}
00144     mstime\_t pc\_last\_activity; \textcolor{comment}{/* Last time we received any message. */}
00145     mstime\_t last\_avail\_time; \textcolor{comment}{/* Last time the instance replied to ping with}
00146 \textcolor{comment}{                                 a reply we consider valid. */}
00147     mstime\_t act\_ping\_time;   \textcolor{comment}{/* Time at which the last pending ping (no pong}
00148 \textcolor{comment}{                                 received after it) was sent. This field is}
00149 \textcolor{comment}{                                 set to 0 when a pong is received, and set again}
00150 \textcolor{comment}{                                 to the current time if the value is 0 and a new}
00151 \textcolor{comment}{                                 ping is sent. */}
00152     mstime\_t last\_ping\_time;  \textcolor{comment}{/* Time at which we sent the last ping. This is}
00153 \textcolor{comment}{                                 only used to avoid sending too many pings}
00154 \textcolor{comment}{                                 during failure. Idle time is computed using}
00155 \textcolor{comment}{                                 the act\_ping\_time field. */}
00156     mstime\_t last\_pong\_time;  \textcolor{comment}{/* Last time the instance replied to ping,}
00157 \textcolor{comment}{                                 whatever the reply was. That's used to check}
00158 \textcolor{comment}{                                 if the link is idle and must be reconnected. */}
00159     mstime\_t last\_reconn\_time;  \textcolor{comment}{/* Last reconnection attempt performed when}
00160 \textcolor{comment}{                                   the link was down. */}
00161 \} instanceLink;
00162 
\Hypertarget{sentinel_8c_source_l00163}\hyperlink{structsentinelRedisInstance}{00163} \textcolor{keyword}{typedef} \textcolor{keyword}{struct} \hyperlink{structsentinelRedisInstance}{sentinelRedisInstance} \{
00164     \textcolor{keywordtype}{int} flags;      \textcolor{comment}{/* See SRI\_... defines */}
00165     \textcolor{keywordtype}{char} *name;     \textcolor{comment}{/* Master name from the point of view of this sentinel. */}
00166     \textcolor{keywordtype}{char} *runid;    \textcolor{comment}{/* Run ID of this instance, or unique ID if is a Sentinel.*/}
00167     uint64\_t config\_epoch;  \textcolor{comment}{/* Configuration epoch. */}
00168     sentinelAddr *addr; \textcolor{comment}{/* Master host. */}
00169     \hyperlink{structinstanceLink}{instanceLink} *link; \textcolor{comment}{/* Link to the instance, may be shared for Sentinels. */}
00170     mstime\_t last\_pub\_time;   \textcolor{comment}{/* Last time we sent hello via Pub/Sub. */}
00171     mstime\_t last\_hello\_time; \textcolor{comment}{/* Only used if SRI\_SENTINEL is set. Last time}
00172 \textcolor{comment}{                                 we received a hello from this Sentinel}
00173 \textcolor{comment}{                                 via Pub/Sub. */}
00174     mstime\_t last\_master\_down\_reply\_time; \textcolor{comment}{/* Time of last reply to}
00175 \textcolor{comment}{                                             SENTINEL is-master-down command. */}
00176     mstime\_t s\_down\_since\_time; \textcolor{comment}{/* Subjectively down since time. */}
00177     mstime\_t o\_down\_since\_time; \textcolor{comment}{/* Objectively down since time. */}
00178     mstime\_t down\_after\_period; \textcolor{comment}{/* Consider it down after that period. */}
00179     mstime\_t info\_refresh;  \textcolor{comment}{/* Time at which we received INFO output from it. */}
00180 
00181     \textcolor{comment}{/* Role and the first time we observed it.}
00182 \textcolor{comment}{     * This is useful in order to delay replacing what the instance reports}
00183 \textcolor{comment}{     * with our own configuration. We need to always wait some time in order}
00184 \textcolor{comment}{     * to give a chance to the leader to report the new configuration before}
00185 \textcolor{comment}{     * we do silly things. */}
00186     \textcolor{keywordtype}{int} role\_reported;
00187     mstime\_t role\_reported\_time;
00188     mstime\_t slave\_conf\_change\_time; \textcolor{comment}{/* Last time slave master addr changed. */}
00189 
00190     \textcolor{comment}{/* Master specific. */}
00191     dict *sentinels;    \textcolor{comment}{/* Other sentinels monitoring the same master. */}
00192     dict *slaves;       \textcolor{comment}{/* Slaves for this master instance. */}
00193     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} quorum;\textcolor{comment}{/* Number of sentinels that need to agree on failure. */}
00194     \textcolor{keywordtype}{int} parallel\_syncs; \textcolor{comment}{/* How many slaves to reconfigure at same time. */}
00195     \textcolor{keywordtype}{char} *auth\_pass;    \textcolor{comment}{/* Password to use for AUTH against master & slaves. */}
00196 
00197     \textcolor{comment}{/* Slave specific. */}
00198     mstime\_t master\_link\_down\_time; \textcolor{comment}{/* Slave replication link down time. */}
00199     \textcolor{keywordtype}{int} slave\_priority; \textcolor{comment}{/* Slave priority according to its INFO output. */}
00200     mstime\_t slave\_reconf\_sent\_time; \textcolor{comment}{/* Time at which we sent SLAVE OF <new> */}
00201     \textcolor{keyword}{struct} \hyperlink{structsentinelRedisInstance}{sentinelRedisInstance} *master; \textcolor{comment}{/* Master instance if it's slave. */}
00202     \textcolor{keywordtype}{char} *slave\_master\_host;    \textcolor{comment}{/* Master host as reported by INFO */}
00203     \textcolor{keywordtype}{int} slave\_master\_port;      \textcolor{comment}{/* Master port as reported by INFO */}
00204     \textcolor{keywordtype}{int} slave\_master\_link\_status; \textcolor{comment}{/* Master link status as reported by INFO */}
00205     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{long} \textcolor{keywordtype}{long} slave\_repl\_offset; \textcolor{comment}{/* Slave replication offset. */}
00206     \textcolor{comment}{/* Failover */}
00207     \textcolor{keywordtype}{char} *leader;       \textcolor{comment}{/* If this is a master instance, this is the runid of}
00208 \textcolor{comment}{                           the Sentinel that should perform the failover. If}
00209 \textcolor{comment}{                           this is a Sentinel, this is the runid of the Sentinel}
00210 \textcolor{comment}{                           that this Sentinel voted as leader. */}
00211     uint64\_t leader\_epoch; \textcolor{comment}{/* Epoch of the 'leader' field. */}
00212     uint64\_t failover\_epoch; \textcolor{comment}{/* Epoch of the currently started failover. */}
00213     \textcolor{keywordtype}{int} failover\_state; \textcolor{comment}{/* See SENTINEL\_FAILOVER\_STATE\_* defines. */}
00214     mstime\_t failover\_state\_change\_time;
00215     mstime\_t failover\_start\_time;   \textcolor{comment}{/* Last failover attempt start time. */}
00216     mstime\_t failover\_timeout;      \textcolor{comment}{/* Max time to refresh failover state. */}
00217     mstime\_t failover\_delay\_logged; \textcolor{comment}{/* For what failover\_start\_time value we}
00218 \textcolor{comment}{                                       logged the failover delay. */}
00219     \textcolor{keyword}{struct} \hyperlink{structsentinelRedisInstance}{sentinelRedisInstance} *promoted\_slave; \textcolor{comment}{/* Promoted slave instance. */}
00220     \textcolor{comment}{/* Scripts executed to notify admin or reconfigure clients: when they}
00221 \textcolor{comment}{     * are set to NULL no script is executed. */}
00222     \textcolor{keywordtype}{char} *notification\_script;
00223     \textcolor{keywordtype}{char} *client\_reconfig\_script;
00224     sds info; \textcolor{comment}{/* cached INFO output */}
00225 \} sentinelRedisInstance;
00226 
00227 \textcolor{comment}{/* Main state. */}
\Hypertarget{sentinel_8c_source_l00228}\hyperlink{structsentinelState}{00228} \textcolor{keyword}{struct} \hyperlink{structsentinelState}{sentinelState} \{
00229     \textcolor{keywordtype}{char} myid[\hyperlink{server_8h_aba6794fa3ee28f85165eaed93190f1df}{CONFIG\_RUN\_ID\_SIZE}+1]; \textcolor{comment}{/* This sentinel ID. */}
00230     uint64\_t current\_epoch;         \textcolor{comment}{/* Current epoch. */}
00231     dict *masters;      \textcolor{comment}{/* Dictionary of master sentinelRedisInstances.}
00232 \textcolor{comment}{                           Key is the instance name, value is the}
00233 \textcolor{comment}{                           sentinelRedisInstance structure pointer. */}
00234     \textcolor{keywordtype}{int} tilt;           \textcolor{comment}{/* Are we in TILT mode? */}
00235     \textcolor{keywordtype}{int} running\_scripts;    \textcolor{comment}{/* Number of scripts in execution right now. */}
00236     mstime\_t tilt\_start\_time;       \textcolor{comment}{/* When TITL started. */}
00237     mstime\_t previous\_time;         \textcolor{comment}{/* Last time we ran the time handler. */}
00238     list *scripts\_queue;            \textcolor{comment}{/* Queue of user scripts to execute. */}
00239     \textcolor{keywordtype}{char} *announce\_ip;  \textcolor{comment}{/* IP addr that is gossiped to other sentinels if}
00240 \textcolor{comment}{                           not NULL. */}
00241     \textcolor{keywordtype}{int} announce\_port;  \textcolor{comment}{/* Port that is gossiped to other sentinels if}
00242 \textcolor{comment}{                           non zero. */}
00243     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{long} simfailure\_flags; \textcolor{comment}{/* Failures simulation. */}
00244 \} sentinel;
00245 
00246 \textcolor{comment}{/* A script execution job. */}
\Hypertarget{sentinel_8c_source_l00247}\hyperlink{structsentinelScriptJob}{00247} \textcolor{keyword}{typedef} \textcolor{keyword}{struct} \hyperlink{structsentinelScriptJob}{sentinelScriptJob} \{
00248     \textcolor{keywordtype}{int} flags;              \textcolor{comment}{/* Script job flags: SENTINEL\_SCRIPT\_* */}
00249     \textcolor{keywordtype}{int} retry\_num;          \textcolor{comment}{/* Number of times we tried to execute it. */}
00250     \textcolor{keywordtype}{char} **argv;            \textcolor{comment}{/* Arguments to call the script. */}
00251     mstime\_t start\_time;    \textcolor{comment}{/* Script execution time if the script is running,}
00252 \textcolor{comment}{                               otherwise 0 if we are allowed to retry the}
00253 \textcolor{comment}{                               execution at any time. If the script is not}
00254 \textcolor{comment}{                               running and it's not 0, it means: do not run}
00255 \textcolor{comment}{                               before the specified time. */}
00256     pid\_t pid;              \textcolor{comment}{/* Script execution pid. */}
00257 \} sentinelScriptJob;
00258 
00259 \textcolor{comment}{/* ======================= hiredis ae.c adapters =============================}
00260 \textcolor{comment}{ * Note: this implementation is taken from hiredis/adapters/ae.h, however}
00261 \textcolor{comment}{ * we have our modified copy for Sentinel in order to use our allocator}
00262 \textcolor{comment}{ * and to have full control over how the adapter works. */}
00263 
\Hypertarget{sentinel_8c_source_l00264}\hyperlink{structredisAeEvents}{00264} \textcolor{keyword}{typedef} \textcolor{keyword}{struct} \hyperlink{structredisAeEvents}{redisAeEvents} \{
00265     redisAsyncContext *context;
00266     aeEventLoop *loop;
00267     \textcolor{keywordtype}{int} fd;
00268     \textcolor{keywordtype}{int} reading, writing;
00269 \} redisAeEvents;
00270 
00271 \textcolor{keyword}{static} \textcolor{keywordtype}{void} redisAeReadEvent(aeEventLoop *el, \textcolor{keywordtype}{int} fd, \textcolor{keywordtype}{void} *privdata, \textcolor{keywordtype}{int} mask) \{
00272     ((\textcolor{keywordtype}{void})el); ((\textcolor{keywordtype}{void})fd); ((\textcolor{keywordtype}{void})mask);
00273 
00274     \hyperlink{structredisAeEvents}{redisAeEvents} *e = (\hyperlink{structredisAeEvents}{redisAeEvents}*)privdata;
00275     redisAsyncHandleRead(e->context);
00276 \}
00277 
00278 \textcolor{keyword}{static} \textcolor{keywordtype}{void} redisAeWriteEvent(aeEventLoop *el, \textcolor{keywordtype}{int} fd, \textcolor{keywordtype}{void} *privdata, \textcolor{keywordtype}{int} mask) \{
00279     ((\textcolor{keywordtype}{void})el); ((\textcolor{keywordtype}{void})fd); ((\textcolor{keywordtype}{void})mask);
00280 
00281     \hyperlink{structredisAeEvents}{redisAeEvents} *e = (\hyperlink{structredisAeEvents}{redisAeEvents}*)privdata;
00282     redisAsyncHandleWrite(e->context);
00283 \}
00284 
00285 \textcolor{keyword}{static} \textcolor{keywordtype}{void} redisAeAddRead(\textcolor{keywordtype}{void} *privdata) \{
00286     \hyperlink{structredisAeEvents}{redisAeEvents} *e = (\hyperlink{structredisAeEvents}{redisAeEvents}*)privdata;
00287     aeEventLoop *loop = e->loop;
00288     \textcolor{keywordflow}{if} (!e->reading) \{
00289         e->reading = 1;
00290         aeCreateFileEvent(loop,e->fd,\hyperlink{ae_8h_a7a9a2162d007d09739955b4e55c65bf3}{AE\_READABLE},redisAeReadEvent,e);
00291     \}
00292 \}
00293 
00294 \textcolor{keyword}{static} \textcolor{keywordtype}{void} redisAeDelRead(\textcolor{keywordtype}{void} *privdata) \{
00295     \hyperlink{structredisAeEvents}{redisAeEvents} *e = (\hyperlink{structredisAeEvents}{redisAeEvents}*)privdata;
00296     aeEventLoop *loop = e->loop;
00297     \textcolor{keywordflow}{if} (e->reading) \{
00298         e->reading = 0;
00299         aeDeleteFileEvent(loop,e->fd,\hyperlink{ae_8h_a7a9a2162d007d09739955b4e55c65bf3}{AE\_READABLE});
00300     \}
00301 \}
00302 
00303 \textcolor{keyword}{static} \textcolor{keywordtype}{void} redisAeAddWrite(\textcolor{keywordtype}{void} *privdata) \{
00304     \hyperlink{structredisAeEvents}{redisAeEvents} *e = (\hyperlink{structredisAeEvents}{redisAeEvents}*)privdata;
00305     aeEventLoop *loop = e->loop;
00306     \textcolor{keywordflow}{if} (!e->writing) \{
00307         e->writing = 1;
00308         aeCreateFileEvent(loop,e->fd,\hyperlink{ae_8h_ab6bfb0366ccb6277112d132c2a2bf500}{AE\_WRITABLE},redisAeWriteEvent,e);
00309     \}
00310 \}
00311 
00312 \textcolor{keyword}{static} \textcolor{keywordtype}{void} redisAeDelWrite(\textcolor{keywordtype}{void} *privdata) \{
00313     \hyperlink{structredisAeEvents}{redisAeEvents} *e = (\hyperlink{structredisAeEvents}{redisAeEvents}*)privdata;
00314     aeEventLoop *loop = e->loop;
00315     \textcolor{keywordflow}{if} (e->writing) \{
00316         e->writing = 0;
00317         aeDeleteFileEvent(loop,e->fd,\hyperlink{ae_8h_ab6bfb0366ccb6277112d132c2a2bf500}{AE\_WRITABLE});
00318     \}
00319 \}
00320 
00321 \textcolor{keyword}{static} \textcolor{keywordtype}{void} redisAeCleanup(\textcolor{keywordtype}{void} *privdata) \{
00322     \hyperlink{structredisAeEvents}{redisAeEvents} *e = (\hyperlink{structredisAeEvents}{redisAeEvents}*)privdata;
00323     redisAeDelRead(privdata);
00324     redisAeDelWrite(privdata);
00325     zfree(e);
00326 \}
00327 
00328 \textcolor{keyword}{static} \textcolor{keywordtype}{int} redisAeAttach(aeEventLoop *loop, redisAsyncContext *ac) \{
00329     redisContext *c = &(ac->c);
00330     \hyperlink{structredisAeEvents}{redisAeEvents} *e;
00331 
00332     \textcolor{comment}{/* Nothing should be attached when something is already attached */}
00333     \textcolor{keywordflow}{if} (ac->ev.data != NULL)
00334         \textcolor{keywordflow}{return} \hyperlink{server_8h_af98ac28d5f4d23d7ed5985188e6fb7d1}{C\_ERR};
00335 
00336     \textcolor{comment}{/* Create container for context and r/w events */}
00337     e = (redisAeEvents*)zmalloc(\textcolor{keyword}{sizeof}(*e));
00338     e->context = ac;
00339     e->loop = loop;
00340     e->fd = c->fd;
00341     e->reading = e->writing = 0;
00342 
00343     \textcolor{comment}{/* Register functions to start/stop listening for events */}
00344     ac->ev.addRead = redisAeAddRead;
00345     ac->ev.delRead = redisAeDelRead;
00346     ac->ev.addWrite = redisAeAddWrite;
00347     ac->ev.delWrite = redisAeDelWrite;
00348     ac->ev.cleanup = redisAeCleanup;
00349     ac->ev.data = e;
00350 
00351     \textcolor{keywordflow}{return} \hyperlink{server_8h_a303769ef1065076e68731584e758d3e1}{C\_OK};
00352 \}
00353 
00354 \textcolor{comment}{/* ============================= Prototypes ================================= */}
00355 
00356 \textcolor{keywordtype}{void} sentinelLinkEstablishedCallback(\textcolor{keyword}{const} redisAsyncContext *c, \textcolor{keywordtype}{int} status);
00357 \textcolor{keywordtype}{void} sentinelDisconnectCallback(\textcolor{keyword}{const} redisAsyncContext *c, \textcolor{keywordtype}{int} status);
00358 \textcolor{keywordtype}{void} sentinelReceiveHelloMessages(redisAsyncContext *c, \textcolor{keywordtype}{void} *reply, \textcolor{keywordtype}{void} *privdata);
00359 sentinelRedisInstance *sentinelGetMasterByName(\textcolor{keywordtype}{char} *name);
00360 \textcolor{keywordtype}{char} *sentinelGetSubjectiveLeader(sentinelRedisInstance *master);
00361 \textcolor{keywordtype}{char} *sentinelGetObjectiveLeader(sentinelRedisInstance *master);
00362 \textcolor{keywordtype}{int} yesnotoi(\textcolor{keywordtype}{char} *s);
00363 \textcolor{keywordtype}{void} instanceLinkConnectionError(\textcolor{keyword}{const} redisAsyncContext *c);
00364 \textcolor{keyword}{const} \textcolor{keywordtype}{char} *sentinelRedisInstanceTypeStr(sentinelRedisInstance *ri);
00365 \textcolor{keywordtype}{void} sentinelAbortFailover(sentinelRedisInstance *ri);
00366 \textcolor{keywordtype}{void} sentinelEvent(\textcolor{keywordtype}{int} level, \textcolor{keywordtype}{char} *type, sentinelRedisInstance *ri, \textcolor{keyword}{const} \textcolor{keywordtype}{char} *fmt, ...);
00367 sentinelRedisInstance *sentinelSelectSlave(sentinelRedisInstance *master);
00368 \textcolor{keywordtype}{void} sentinelScheduleScriptExecution(\textcolor{keywordtype}{char} *path, ...);
00369 \textcolor{keywordtype}{void} sentinelStartFailover(sentinelRedisInstance *master);
00370 \textcolor{keywordtype}{void} sentinelDiscardReplyCallback(redisAsyncContext *c, \textcolor{keywordtype}{void} *reply, \textcolor{keywordtype}{void} *privdata);
00371 \textcolor{keywordtype}{int} sentinelSendSlaveOf(sentinelRedisInstance *ri, \textcolor{keywordtype}{char} *host, \textcolor{keywordtype}{int} port);
00372 \textcolor{keywordtype}{char} *sentinelVoteLeader(sentinelRedisInstance *master, uint64\_t req\_epoch, \textcolor{keywordtype}{char} *req\_runid, uint64\_t 
      *leader\_epoch);
00373 \textcolor{keywordtype}{void} sentinelFlushConfig(\textcolor{keywordtype}{void});
00374 \textcolor{keywordtype}{void} sentinelGenerateInitialMonitorEvents(\textcolor{keywordtype}{void});
00375 \textcolor{keywordtype}{int} sentinelSendPing(sentinelRedisInstance *ri);
00376 \textcolor{keywordtype}{int} sentinelForceHelloUpdateForMaster(sentinelRedisInstance *master);
00377 sentinelRedisInstance *getSentinelRedisInstanceByAddrAndRunID(dict *instances, \textcolor{keywordtype}{char} *ip, \textcolor{keywordtype}{int} port, \textcolor{keywordtype}{
      char} *runid);
00378 \textcolor{keywordtype}{void} sentinelSimFailureCrash(\textcolor{keywordtype}{void});
00379 
00380 \textcolor{comment}{/* ========================= Dictionary types =============================== */}
00381 
00382 uint64\_t dictSdsHash(\textcolor{keyword}{const} \textcolor{keywordtype}{void} *key);
00383 \textcolor{keywordtype}{int} dictSdsKeyCompare(\textcolor{keywordtype}{void} *privdata, \textcolor{keyword}{const} \textcolor{keywordtype}{void} *key1, \textcolor{keyword}{const} \textcolor{keywordtype}{void} *key2);
00384 \textcolor{keywordtype}{void} releaseSentinelRedisInstance(sentinelRedisInstance *ri);
00385 
00386 \textcolor{keywordtype}{void} dictInstancesValDestructor (\textcolor{keywordtype}{void} *privdata, \textcolor{keywordtype}{void} *obj) \{
00387     \hyperlink{server_8h_ae7c9dc8f13568a9c856573751f1ee1ec}{UNUSED}(privdata);
00388     releaseSentinelRedisInstance(obj);
00389 \}
00390 
00391 \textcolor{comment}{/* Instance name (sds) -> instance (sentinelRedisInstance pointer)}
00392 \textcolor{comment}{ *}
00393 \textcolor{comment}{ * also used for: sentinelRedisInstance->sentinels dictionary that maps}
00394 \textcolor{comment}{ * sentinels ip:port to last seen time in Pub/Sub hello message. */}
00395 dictType instancesDictType = \{
00396     dictSdsHash,               \textcolor{comment}{/* hash function */}
00397     NULL,                      \textcolor{comment}{/* key dup */}
00398     NULL,                      \textcolor{comment}{/* val dup */}
00399     dictSdsKeyCompare,         \textcolor{comment}{/* key compare */}
00400     NULL,                      \textcolor{comment}{/* key destructor */}
00401     dictInstancesValDestructor \textcolor{comment}{/* val destructor */}
00402 \};
00403 
00404 \textcolor{comment}{/* Instance runid (sds) -> votes (long casted to void*)}
00405 \textcolor{comment}{ *}
00406 \textcolor{comment}{ * This is useful into sentinelGetObjectiveLeader() function in order to}
00407 \textcolor{comment}{ * count the votes and understand who is the leader. */}
00408 dictType leaderVotesDictType = \{
00409     dictSdsHash,               \textcolor{comment}{/* hash function */}
00410     NULL,                      \textcolor{comment}{/* key dup */}
00411     NULL,                      \textcolor{comment}{/* val dup */}
00412     dictSdsKeyCompare,         \textcolor{comment}{/* key compare */}
00413     NULL,                      \textcolor{comment}{/* key destructor */}
00414     NULL                       \textcolor{comment}{/* val destructor */}
00415 \};
00416 
00417 \textcolor{comment}{/* =========================== Initialization =============================== */}
00418 
00419 \textcolor{keywordtype}{void} sentinelCommand(\hyperlink{structclient}{client} *c);
00420 \textcolor{keywordtype}{void} sentinelInfoCommand(\hyperlink{structclient}{client} *c);
00421 \textcolor{keywordtype}{void} sentinelSetCommand(\hyperlink{structclient}{client} *c);
00422 \textcolor{keywordtype}{void} sentinelPublishCommand(\hyperlink{structclient}{client} *c);
00423 \textcolor{keywordtype}{void} sentinelRoleCommand(\hyperlink{structclient}{client} *c);
00424 
00425 \textcolor{keyword}{struct} \hyperlink{structredisCommand}{redisCommand} sentinelcmds[] = \{
00426     \{\textcolor{stringliteral}{"ping"},pingCommand,1,\textcolor{stringliteral}{""},0,NULL,0,0,0,0,0\},
00427     \{\textcolor{stringliteral}{"sentinel"},sentinelCommand,-2,\textcolor{stringliteral}{""},0,NULL,0,0,0,0,0\},
00428     \{\textcolor{stringliteral}{"subscribe"},subscribeCommand,-2,\textcolor{stringliteral}{""},0,NULL,0,0,0,0,0\},
00429     \{\textcolor{stringliteral}{"unsubscribe"},unsubscribeCommand,-1,\textcolor{stringliteral}{""},0,NULL,0,0,0,0,0\},
00430     \{\textcolor{stringliteral}{"psubscribe"},psubscribeCommand,-2,\textcolor{stringliteral}{""},0,NULL,0,0,0,0,0\},
00431     \{\textcolor{stringliteral}{"punsubscribe"},punsubscribeCommand,-1,\textcolor{stringliteral}{""},0,NULL,0,0,0,0,0\},
00432     \{\textcolor{stringliteral}{"publish"},sentinelPublishCommand,3,\textcolor{stringliteral}{""},0,NULL,0,0,0,0,0\},
00433     \{\textcolor{stringliteral}{"info"},sentinelInfoCommand,-1,\textcolor{stringliteral}{""},0,NULL,0,0,0,0,0\},
00434     \{\textcolor{stringliteral}{"role"},sentinelRoleCommand,1,\textcolor{stringliteral}{"l"},0,NULL,0,0,0,0,0\},
00435     \{\textcolor{stringliteral}{"client"},clientCommand,-2,\textcolor{stringliteral}{"rs"},0,NULL,0,0,0,0,0\},
00436     \{\textcolor{stringliteral}{"shutdown"},shutdownCommand,-1,\textcolor{stringliteral}{""},0,NULL,0,0,0,0,0\}
00437 \};
00438 
00439 \textcolor{comment}{/* This function overwrites a few normal Redis config default with Sentinel}
00440 \textcolor{comment}{ * specific defaults. */}
00441 \textcolor{keywordtype}{void} initSentinelConfig(\textcolor{keywordtype}{void}) \{
00442     server.port = \hyperlink{sentinel_8c_a4c51b961e51b0dd04260eb860e641b2f}{REDIS\_SENTINEL\_PORT};
00443 \}
00444 
00445 \textcolor{comment}{/* Perform the Sentinel mode initialization. */}
00446 \textcolor{keywordtype}{void} initSentinel(\textcolor{keywordtype}{void}) \{
00447     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} j;
00448 
00449     \textcolor{comment}{/* Remove usual Redis commands from the command table, then just add}
00450 \textcolor{comment}{     * the SENTINEL command. */}
00451     dictEmpty(server.commands,NULL);
00452     \textcolor{keywordflow}{for} (j = 0; j < \textcolor{keyword}{sizeof}(sentinelcmds)/\textcolor{keyword}{sizeof}(sentinelcmds[0]); j++) \{
00453         \textcolor{keywordtype}{int} retval;
00454         \textcolor{keyword}{struct} \hyperlink{structredisCommand}{redisCommand} *cmd = sentinelcmds+j;
00455 
00456         retval = dictAdd(server.commands, sdsnew(cmd->name), cmd);
00457         \hyperlink{server_8h_a88114b5169b4c382df6b56506285e56a}{serverAssert}(retval == \hyperlink{dict_8h_a2afecbeab8f7efbc183048f52f6d17e5}{DICT\_OK});
00458     \}
00459 
00460     \textcolor{comment}{/* Initialize various data structures. */}
00461     sentinel.current\_epoch = 0;
00462     sentinel.masters = dictCreate(&instancesDictType,NULL);
00463     sentinel.tilt = 0;
00464     sentinel.tilt\_start\_time = 0;
00465     sentinel.previous\_time = mstime();
00466     sentinel.running\_scripts = 0;
00467     sentinel.scripts\_queue = listCreate();
00468     sentinel.announce\_ip = NULL;
00469     sentinel.announce\_port = 0;
00470     sentinel.simfailure\_flags = \hyperlink{sentinel_8c_a045e4b70a9044e6e62c9cf6aafff8d3f}{SENTINEL\_SIMFAILURE\_NONE};
00471     memset(sentinel.myid,0,\textcolor{keyword}{sizeof}(sentinel.myid));
00472 \}
00473 
00474 \textcolor{comment}{/* This function gets called when the server is in Sentinel mode, started,}
00475 \textcolor{comment}{ * loaded the configuration, and is ready for normal operations. */}
00476 \textcolor{keywordtype}{void} sentinelIsRunning(\textcolor{keywordtype}{void}) \{
00477     \textcolor{keywordtype}{int} j;
00478 
00479     \textcolor{keywordflow}{if} (server.configfile == NULL) \{
00480         serverLog(\hyperlink{server_8h_a31229b9334bba7d6be2a72970967a14b}{LL\_WARNING},
00481             \textcolor{stringliteral}{"Sentinel started without a config file. Exiting..."});
00482         exit(1);
00483     \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (access(server.configfile,W\_OK) == -1) \{
00484         serverLog(\hyperlink{server_8h_a31229b9334bba7d6be2a72970967a14b}{LL\_WARNING},
00485             \textcolor{stringliteral}{"Sentinel config file %s is not writable: %s. Exiting..."},
00486             server.configfile,strerror(errno));
00487         exit(1);
00488     \}
00489 
00490     \textcolor{comment}{/* If this Sentinel has yet no ID set in the configuration file, we}
00491 \textcolor{comment}{     * pick a random one and persist the config on disk. From now on this}
00492 \textcolor{comment}{     * will be this Sentinel ID across restarts. */}
00493     \textcolor{keywordflow}{for} (j = 0; j < \hyperlink{server_8h_aba6794fa3ee28f85165eaed93190f1df}{CONFIG\_RUN\_ID\_SIZE}; j++)
00494         \textcolor{keywordflow}{if} (sentinel.myid[j] != 0) \textcolor{keywordflow}{break};
00495 
00496     \textcolor{keywordflow}{if} (j == \hyperlink{server_8h_aba6794fa3ee28f85165eaed93190f1df}{CONFIG\_RUN\_ID\_SIZE}) \{
00497         \textcolor{comment}{/* Pick ID and presist the config. */}
00498         getRandomHexChars(sentinel.myid,\hyperlink{server_8h_aba6794fa3ee28f85165eaed93190f1df}{CONFIG\_RUN\_ID\_SIZE});
00499         sentinelFlushConfig();
00500     \}
00501 
00502     \textcolor{comment}{/* Log its ID to make debugging of issues simpler. */}
00503     serverLog(\hyperlink{server_8h_a31229b9334bba7d6be2a72970967a14b}{LL\_WARNING},\textcolor{stringliteral}{"Sentinel ID is %s"}, sentinel.myid);
00504 
00505     \textcolor{comment}{/* We want to generate a +monitor event for every configured master}
00506 \textcolor{comment}{     * at startup. */}
00507     sentinelGenerateInitialMonitorEvents();
00508 \}
00509 
00510 \textcolor{comment}{/* ============================== sentinelAddr ============================== */}
00511 
00512 \textcolor{comment}{/* Create a sentinelAddr object and return it on success.}
00513 \textcolor{comment}{ * On error NULL is returned and errno is set to:}
00514 \textcolor{comment}{ *  ENOENT: Can't resolve the hostname.}
00515 \textcolor{comment}{ *  EINVAL: Invalid port number.}
00516 \textcolor{comment}{ */}
00517 sentinelAddr *createSentinelAddr(\textcolor{keywordtype}{char} *hostname, \textcolor{keywordtype}{int} port) \{
00518     \textcolor{keywordtype}{char} ip[\hyperlink{server_8h_ad97c5405ed22a94e9fcc10fba577d6c0}{NET\_IP\_STR\_LEN}];
00519     sentinelAddr *sa;
00520 
00521     \textcolor{keywordflow}{if} (port < 0 || port > 65535) \{
00522         errno = EINVAL;
00523         \textcolor{keywordflow}{return} NULL;
00524     \}
00525     \textcolor{keywordflow}{if} (anetResolve(NULL,hostname,ip,\textcolor{keyword}{sizeof}(ip)) == \hyperlink{anet_8h_a0697b7774a7e0f4ef141839fe93536fe}{ANET\_ERR}) \{
00526         errno = ENOENT;
00527         \textcolor{keywordflow}{return} NULL;
00528     \}
00529     sa = zmalloc(\textcolor{keyword}{sizeof}(*sa));
00530     sa->ip = sdsnew(ip);
00531     sa->port = port;
00532     \textcolor{keywordflow}{return} sa;
00533 \}
00534 
00535 \textcolor{comment}{/* Return a duplicate of the source address. */}
00536 sentinelAddr *dupSentinelAddr(sentinelAddr *src) \{
00537     sentinelAddr *sa;
00538 
00539     sa = zmalloc(\textcolor{keyword}{sizeof}(*sa));
00540     sa->ip = sdsnew(src->ip);
00541     sa->port = src->port;
00542     \textcolor{keywordflow}{return} sa;
00543 \}
00544 
00545 \textcolor{comment}{/* Free a Sentinel address. Can't fail. */}
00546 \textcolor{keywordtype}{void} releaseSentinelAddr(sentinelAddr *sa) \{
00547     sdsfree(sa->ip);
00548     zfree(sa);
00549 \}
00550 
00551 \textcolor{comment}{/* Return non-zero if two addresses are equal. */}
00552 \textcolor{keywordtype}{int} sentinelAddrIsEqual(sentinelAddr *a, sentinelAddr *b) \{
00553     \textcolor{keywordflow}{return} a->port == b->port && !strcasecmp(a->ip,b->ip);
00554 \}
00555 
00556 \textcolor{comment}{/* =========================== Events notification ========================== */}
00557 
00558 \textcolor{comment}{/* Send an event to log, pub/sub, user notification script.}
00559 \textcolor{comment}{ *}
00560 \textcolor{comment}{ * 'level' is the log level for logging. Only LL\_WARNING events will trigger}
00561 \textcolor{comment}{ * the execution of the user notification script.}
00562 \textcolor{comment}{ *}
00563 \textcolor{comment}{ * 'type' is the message type, also used as a pub/sub channel name.}
00564 \textcolor{comment}{ *}
00565 \textcolor{comment}{ * 'ri', is the redis instance target of this event if applicable, and is}
00566 \textcolor{comment}{ * used to obtain the path of the notification script to execute.}
00567 \textcolor{comment}{ *}
00568 \textcolor{comment}{ * The remaining arguments are printf-alike.}
00569 \textcolor{comment}{ * If the format specifier starts with the two characters "%@" then ri is}
00570 \textcolor{comment}{ * not NULL, and the message is prefixed with an instance identifier in the}
00571 \textcolor{comment}{ * following format:}
00572 \textcolor{comment}{ *}
00573 \textcolor{comment}{ *  <instance type> <instance name> <ip> <port>}
00574 \textcolor{comment}{ *}
00575 \textcolor{comment}{ *  If the instance type is not master, than the additional string is}
00576 \textcolor{comment}{ *  added to specify the originating master:}
00577 \textcolor{comment}{ *}
00578 \textcolor{comment}{ *  @ <master name> <master ip> <master port>}
00579 \textcolor{comment}{ *}
00580 \textcolor{comment}{ *  Any other specifier after "%@" is processed by printf itself.}
00581 \textcolor{comment}{ */}
00582 \textcolor{keywordtype}{void} sentinelEvent(\textcolor{keywordtype}{int} level, \textcolor{keywordtype}{char} *type, sentinelRedisInstance *ri,
00583                    \textcolor{keyword}{const} \textcolor{keywordtype}{char} *fmt, ...) \{
00584     va\_list ap;
00585     \textcolor{keywordtype}{char} msg[\hyperlink{server_8h_a37cd05cbfd7fb52ad21d3a822cff2ee6}{LOG\_MAX\_LEN}];
00586     robj *channel, *payload;
00587 
00588     \textcolor{comment}{/* Handle %@ */}
00589     \textcolor{keywordflow}{if} (fmt[0] == \textcolor{stringliteral}{'%'} && fmt[1] == \textcolor{stringliteral}{'@'}) \{
00590         sentinelRedisInstance *master = (ri->flags & \hyperlink{sentinel_8c_a2ee83e5ff67b45746cd6a310f15334b2}{SRI\_MASTER}) ?
00591                                          NULL : ri->master;
00592 
00593         \textcolor{keywordflow}{if} (master) \{
00594             snprintf(msg, \textcolor{keyword}{sizeof}(msg), \textcolor{stringliteral}{"%s %s %s %d @ %s %s %d"},
00595                 sentinelRedisInstanceTypeStr(ri),
00596                 ri->name, ri->addr->ip, ri->addr->port,
00597                 master->name, master->addr->ip, master->addr->port);
00598         \} \textcolor{keywordflow}{else} \{
00599             snprintf(msg, \textcolor{keyword}{sizeof}(msg), \textcolor{stringliteral}{"%s %s %s %d"},
00600                 sentinelRedisInstanceTypeStr(ri),
00601                 ri->name, ri->addr->ip, ri->addr->port);
00602         \}
00603         fmt += 2;
00604     \} \textcolor{keywordflow}{else} \{
00605         msg[0] = \textcolor{stringliteral}{'\(\backslash\)0'};
00606     \}
00607 
00608     \textcolor{comment}{/* Use vsprintf for the rest of the formatting if any. */}
00609     \textcolor{keywordflow}{if} (fmt[0] != \textcolor{stringliteral}{'\(\backslash\)0'}) \{
00610         va\_start(ap, fmt);
00611         vsnprintf(msg+strlen(msg), \textcolor{keyword}{sizeof}(msg)-strlen(msg), fmt, ap);
00612         va\_end(ap);
00613     \}
00614 
00615     \textcolor{comment}{/* Log the message if the log level allows it to be logged. */}
00616     \textcolor{keywordflow}{if} (level >= server.verbosity)
00617         serverLog(level,\textcolor{stringliteral}{"%s %s"},type,msg);
00618 
00619     \textcolor{comment}{/* Publish the message via Pub/Sub if it's not a debugging one. */}
00620     \textcolor{keywordflow}{if} (level != \hyperlink{server_8h_abcaffe365dee628fcf9fc90c69d534a1}{LL\_DEBUG}) \{
00621         channel = createStringObject(type,strlen(type));
00622         payload = createStringObject(msg,strlen(msg));
00623         pubsubPublishMessage(channel,payload);
00624         decrRefCount(channel);
00625         decrRefCount(payload);
00626     \}
00627 
00628     \textcolor{comment}{/* Call the notification script if applicable. */}
00629     \textcolor{keywordflow}{if} (level == \hyperlink{server_8h_a31229b9334bba7d6be2a72970967a14b}{LL\_WARNING} && ri != NULL) \{
00630         sentinelRedisInstance *master = (ri->flags & \hyperlink{sentinel_8c_a2ee83e5ff67b45746cd6a310f15334b2}{SRI\_MASTER}) ?
00631                                          ri : ri->master;
00632         \textcolor{keywordflow}{if} (master && master->notification\_script) \{
00633             sentinelScheduleScriptExecution(master->notification\_script,
00634                 type,msg,NULL);
00635         \}
00636     \}
00637 \}
00638 
00639 \textcolor{comment}{/* This function is called only at startup and is used to generate a}
00640 \textcolor{comment}{ * +monitor event for every configured master. The same events are also}
00641 \textcolor{comment}{ * generated when a master to monitor is added at runtime via the}
00642 \textcolor{comment}{ * SENTINEL MONITOR command. */}
00643 \textcolor{keywordtype}{void} sentinelGenerateInitialMonitorEvents(\textcolor{keywordtype}{void}) \{
00644     dictIterator *di;
00645     dictEntry *de;
00646 
00647     di = dictGetIterator(sentinel.masters);
00648     \textcolor{keywordflow}{while}((de = dictNext(di)) != NULL) \{
00649         sentinelRedisInstance *ri = \hyperlink{dict_8h_ae8d2cc391873b2bea2b87c4f80f43120}{dictGetVal}(de);
00650         sentinelEvent(\hyperlink{server_8h_a31229b9334bba7d6be2a72970967a14b}{LL\_WARNING},\textcolor{stringliteral}{"+monitor"},ri,\textcolor{stringliteral}{"%@ quorum %d"},ri->quorum);
00651     \}
00652     dictReleaseIterator(di);
00653 \}
00654 
00655 \textcolor{comment}{/* ============================ script execution ============================ */}
00656 
00657 \textcolor{comment}{/* Release a script job structure and all the associated data. */}
00658 \textcolor{keywordtype}{void} sentinelReleaseScriptJob(sentinelScriptJob *sj) \{
00659     \textcolor{keywordtype}{int} j = 0;
00660 
00661     \textcolor{keywordflow}{while}(sj->argv[j]) sdsfree(sj->argv[j++]);
00662     zfree(sj->argv);
00663     zfree(sj);
00664 \}
00665 
00666 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{SENTINEL\_SCRIPT\_MAX\_ARGS} 16
00667 \textcolor{keywordtype}{void} sentinelScheduleScriptExecution(\textcolor{keywordtype}{char} *path, ...) \{
00668     va\_list ap;
00669     \textcolor{keywordtype}{char} *argv[\hyperlink{sentinel_8c_a9587f7bc164287b356887d67849bf658}{SENTINEL\_SCRIPT\_MAX\_ARGS}+1];
00670     \textcolor{keywordtype}{int} argc = 1;
00671     sentinelScriptJob *sj;
00672 
00673     va\_start(ap, path);
00674     \textcolor{keywordflow}{while}(argc < \hyperlink{sentinel_8c_a9587f7bc164287b356887d67849bf658}{SENTINEL\_SCRIPT\_MAX\_ARGS}) \{
00675         argv[argc] = va\_arg(ap,\textcolor{keywordtype}{char}*);
00676         \textcolor{keywordflow}{if} (!argv[argc]) \textcolor{keywordflow}{break};
00677         argv[argc] = sdsnew(argv[argc]); \textcolor{comment}{/* Copy the string. */}
00678         argc++;
00679     \}
00680     va\_end(ap);
00681     argv[0] = sdsnew(path);
00682 
00683     sj = zmalloc(\textcolor{keyword}{sizeof}(*sj));
00684     sj->flags = \hyperlink{sentinel_8c_a31022e5665e3f4a0a99254e5660e155a}{SENTINEL\_SCRIPT\_NONE};
00685     sj->retry\_num = 0;
00686     sj->argv = zmalloc(\textcolor{keyword}{sizeof}(\textcolor{keywordtype}{char}*)*(argc+1));
00687     sj->start\_time = 0;
00688     sj->pid = 0;
00689     memcpy(sj->argv,argv,\textcolor{keyword}{sizeof}(\textcolor{keywordtype}{char}*)*(argc+1));
00690 
00691     listAddNodeTail(sentinel.scripts\_queue,sj);
00692 
00693     \textcolor{comment}{/* Remove the oldest non running script if we already hit the limit. */}
00694     \textcolor{keywordflow}{if} (\hyperlink{adlist_8h_afde0ab079f934670e82119b43120e94b}{listLength}(sentinel.scripts\_queue) > 
      \hyperlink{sentinel_8c_a43203051dc0534d7c1a69ea7a4848333}{SENTINEL\_SCRIPT\_MAX\_QUEUE}) \{
00695         listNode *ln;
00696         listIter li;
00697 
00698         listRewind(sentinel.scripts\_queue,&li);
00699         \textcolor{keywordflow}{while} ((ln = listNext(&li)) != NULL) \{
00700             sj = ln->value;
00701 
00702             \textcolor{keywordflow}{if} (sj->flags & \hyperlink{sentinel_8c_a0211d42099c07769ec06cc0010f9b58e}{SENTINEL\_SCRIPT\_RUNNING}) \textcolor{keywordflow}{continue};
00703             \textcolor{comment}{/* The first node is the oldest as we add on tail. */}
00704             listDelNode(sentinel.scripts\_queue,ln);
00705             sentinelReleaseScriptJob(sj);
00706             \textcolor{keywordflow}{break};
00707         \}
00708         \hyperlink{server_8h_a88114b5169b4c382df6b56506285e56a}{serverAssert}(\hyperlink{adlist_8h_afde0ab079f934670e82119b43120e94b}{listLength}(sentinel.scripts\_queue) <=
00709                     \hyperlink{sentinel_8c_a43203051dc0534d7c1a69ea7a4848333}{SENTINEL\_SCRIPT\_MAX\_QUEUE});
00710     \}
00711 \}
00712 
00713 \textcolor{comment}{/* Lookup a script in the scripts queue via pid, and returns the list node}
00714 \textcolor{comment}{ * (so that we can easily remove it from the queue if needed). */}
00715 listNode *sentinelGetScriptListNodeByPid(pid\_t pid) \{
00716     listNode *ln;
00717     listIter li;
00718 
00719     listRewind(sentinel.scripts\_queue,&li);
00720     \textcolor{keywordflow}{while} ((ln = listNext(&li)) != NULL) \{
00721         sentinelScriptJob *sj = ln->value;
00722 
00723         \textcolor{keywordflow}{if} ((sj->flags & \hyperlink{sentinel_8c_a0211d42099c07769ec06cc0010f9b58e}{SENTINEL\_SCRIPT\_RUNNING}) && sj->pid == pid)
00724             \textcolor{keywordflow}{return} ln;
00725     \}
00726     \textcolor{keywordflow}{return} NULL;
00727 \}
00728 
00729 \textcolor{comment}{/* Run pending scripts if we are not already at max number of running}
00730 \textcolor{comment}{ * scripts. */}
00731 \textcolor{keywordtype}{void} sentinelRunPendingScripts(\textcolor{keywordtype}{void}) \{
00732     listNode *ln;
00733     listIter li;
00734     mstime\_t now = mstime();
00735 
00736     \textcolor{comment}{/* Find jobs that are not running and run them, from the top to the}
00737 \textcolor{comment}{     * tail of the queue, so we run older jobs first. */}
00738     listRewind(sentinel.scripts\_queue,&li);
00739     \textcolor{keywordflow}{while} (sentinel.running\_scripts < \hyperlink{sentinel_8c_ad05484edee559e8cb5e1ac3d72375f20}{SENTINEL\_SCRIPT\_MAX\_RUNNING} &&
00740            (ln = listNext(&li)) != NULL)
00741     \{
00742         sentinelScriptJob *sj = ln->value;
00743         pid\_t pid;
00744 
00745         \textcolor{comment}{/* Skip if already running. */}
00746         \textcolor{keywordflow}{if} (sj->flags & \hyperlink{sentinel_8c_a0211d42099c07769ec06cc0010f9b58e}{SENTINEL\_SCRIPT\_RUNNING}) \textcolor{keywordflow}{continue};
00747 
00748         \textcolor{comment}{/* Skip if it's a retry, but not enough time has elapsed. */}
00749         \textcolor{keywordflow}{if} (sj->start\_time && sj->start\_time > now) \textcolor{keywordflow}{continue};
00750 
00751         sj->flags |= \hyperlink{sentinel_8c_a0211d42099c07769ec06cc0010f9b58e}{SENTINEL\_SCRIPT\_RUNNING};
00752         sj->start\_time = mstime();
00753         sj->retry\_num++;
00754         pid = fork();
00755 
00756         \textcolor{keywordflow}{if} (pid == -1) \{
00757             \textcolor{comment}{/* Parent (fork error).}
00758 \textcolor{comment}{             * We report fork errors as signal 99, in order to unify the}
00759 \textcolor{comment}{             * reporting with other kind of errors. */}
00760             sentinelEvent(\hyperlink{server_8h_a31229b9334bba7d6be2a72970967a14b}{LL\_WARNING},\textcolor{stringliteral}{"-script-error"},NULL,
00761                           \textcolor{stringliteral}{"%s %d %d"}, sj->argv[0], 99, 0);
00762             sj->flags &= ~\hyperlink{sentinel_8c_a0211d42099c07769ec06cc0010f9b58e}{SENTINEL\_SCRIPT\_RUNNING};
00763             sj->pid = 0;
00764         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (pid == 0) \{
00765             \textcolor{comment}{/* Child */}
00766             execve(sj->argv[0],sj->argv,environ);
00767             \textcolor{comment}{/* If we are here an error occurred. */}
00768             \_exit(2); \textcolor{comment}{/* Don't retry execution. */}
00769         \} \textcolor{keywordflow}{else} \{
00770             sentinel.running\_scripts++;
00771             sj->pid = pid;
00772             sentinelEvent(\hyperlink{server_8h_abcaffe365dee628fcf9fc90c69d534a1}{LL\_DEBUG},\textcolor{stringliteral}{"+script-child"},NULL,\textcolor{stringliteral}{"%ld"},(\textcolor{keywordtype}{long})pid);
00773         \}
00774     \}
00775 \}
00776 
00777 \textcolor{comment}{/* How much to delay the execution of a script that we need to retry after}
00778 \textcolor{comment}{ * an error?}
00779 \textcolor{comment}{ *}
00780 \textcolor{comment}{ * We double the retry delay for every further retry we do. So for instance}
00781 \textcolor{comment}{ * if RETRY\_DELAY is set to 30 seconds and the max number of retries is 10}
00782 \textcolor{comment}{ * starting from the second attempt to execute the script the delays are:}
00783 \textcolor{comment}{ * 30 sec, 60 sec, 2 min, 4 min, 8 min, 16 min, 32 min, 64 min, 128 min. */}
00784 mstime\_t sentinelScriptRetryDelay(\textcolor{keywordtype}{int} retry\_num) \{
00785     mstime\_t delay = \hyperlink{sentinel_8c_a53c8edb17f50d35b3844cf0f0f61b71b}{SENTINEL\_SCRIPT\_RETRY\_DELAY};
00786 
00787     \textcolor{keywordflow}{while} (retry\_num-- > 1) delay *= 2;
00788     \textcolor{keywordflow}{return} delay;
00789 \}
00790 
00791 \textcolor{comment}{/* Check for scripts that terminated, and remove them from the queue if the}
00792 \textcolor{comment}{ * script terminated successfully. If instead the script was terminated by}
00793 \textcolor{comment}{ * a signal, or returned exit code "1", it is scheduled to run again if}
00794 \textcolor{comment}{ * the max number of retries did not already elapsed. */}
00795 \textcolor{keywordtype}{void} sentinelCollectTerminatedScripts(\textcolor{keywordtype}{void}) \{
00796     \textcolor{keywordtype}{int} statloc;
00797     pid\_t pid;
00798 
00799     \textcolor{keywordflow}{while} ((pid = wait3(&statloc,WNOHANG,NULL)) > 0) \{
00800         \textcolor{keywordtype}{int} exitcode = WEXITSTATUS(statloc);
00801         \textcolor{keywordtype}{int} bysignal = 0;
00802         listNode *ln;
00803         sentinelScriptJob *sj;
00804 
00805         \textcolor{keywordflow}{if} (WIFSIGNALED(statloc)) bysignal = WTERMSIG(statloc);
00806         sentinelEvent(\hyperlink{server_8h_abcaffe365dee628fcf9fc90c69d534a1}{LL\_DEBUG},\textcolor{stringliteral}{"-script-child"},NULL,\textcolor{stringliteral}{"%ld %d %d"},
00807             (\textcolor{keywordtype}{long})pid, exitcode, bysignal);
00808 
00809         ln = sentinelGetScriptListNodeByPid(pid);
00810         \textcolor{keywordflow}{if} (ln == NULL) \{
00811             serverLog(\hyperlink{server_8h_a31229b9334bba7d6be2a72970967a14b}{LL\_WARNING},\textcolor{stringliteral}{"wait3() returned a pid (%ld) we can't find in our scripts
       execution queue!"}, (\textcolor{keywordtype}{long})pid);
00812             \textcolor{keywordflow}{continue};
00813         \}
00814         sj = ln->value;
00815 
00816         \textcolor{comment}{/* If the script was terminated by a signal or returns an}
00817 \textcolor{comment}{         * exit code of "1" (that means: please retry), we reschedule it}
00818 \textcolor{comment}{         * if the max number of retries is not already reached. */}
00819         \textcolor{keywordflow}{if} ((bysignal || exitcode == 1) &&
00820             sj->retry\_num != \hyperlink{sentinel_8c_a38f813a1d1e8f88b2ca76c064c61b6aa}{SENTINEL\_SCRIPT\_MAX\_RETRY})
00821         \{
00822             sj->flags &= ~\hyperlink{sentinel_8c_a0211d42099c07769ec06cc0010f9b58e}{SENTINEL\_SCRIPT\_RUNNING};
00823             sj->pid = 0;
00824             sj->start\_time = mstime() +
00825                              sentinelScriptRetryDelay(sj->retry\_num);
00826         \} \textcolor{keywordflow}{else} \{
00827             \textcolor{comment}{/* Otherwise let's remove the script, but log the event if the}
00828 \textcolor{comment}{             * execution did not terminated in the best of the ways. */}
00829             \textcolor{keywordflow}{if} (bysignal || exitcode != 0) \{
00830                 sentinelEvent(\hyperlink{server_8h_a31229b9334bba7d6be2a72970967a14b}{LL\_WARNING},\textcolor{stringliteral}{"-script-error"},NULL,
00831                               \textcolor{stringliteral}{"%s %d %d"}, sj->argv[0], bysignal, exitcode);
00832             \}
00833             listDelNode(sentinel.scripts\_queue,ln);
00834             sentinelReleaseScriptJob(sj);
00835             sentinel.running\_scripts--;
00836         \}
00837     \}
00838 \}
00839 
00840 \textcolor{comment}{/* Kill scripts in timeout, they'll be collected by the}
00841 \textcolor{comment}{ * sentinelCollectTerminatedScripts() function. */}
00842 \textcolor{keywordtype}{void} sentinelKillTimedoutScripts(\textcolor{keywordtype}{void}) \{
00843     listNode *ln;
00844     listIter li;
00845     mstime\_t now = mstime();
00846 
00847     listRewind(sentinel.scripts\_queue,&li);
00848     \textcolor{keywordflow}{while} ((ln = listNext(&li)) != NULL) \{
00849         sentinelScriptJob *sj = ln->value;
00850 
00851         \textcolor{keywordflow}{if} (sj->flags & \hyperlink{sentinel_8c_a0211d42099c07769ec06cc0010f9b58e}{SENTINEL\_SCRIPT\_RUNNING} &&
00852             (now - sj->start\_time) > \hyperlink{sentinel_8c_ae8eb69271e56d5d14527c64cdeeaf678}{SENTINEL\_SCRIPT\_MAX\_RUNTIME})
00853         \{
00854             sentinelEvent(\hyperlink{server_8h_a31229b9334bba7d6be2a72970967a14b}{LL\_WARNING},\textcolor{stringliteral}{"-script-timeout"},NULL,\textcolor{stringliteral}{"%s %ld"},
00855                 sj->argv[0], (\textcolor{keywordtype}{long})sj->pid);
00856             kill(sj->pid,SIGKILL);
00857         \}
00858     \}
00859 \}
00860 
00861 \textcolor{comment}{/* Implements SENTINEL PENDING-SCRIPTS command. */}
00862 \textcolor{keywordtype}{void} sentinelPendingScriptsCommand(\hyperlink{structclient}{client} *c) \{
00863     listNode *ln;
00864     listIter li;
00865 
00866     addReplyMultiBulkLen(c,\hyperlink{adlist_8h_afde0ab079f934670e82119b43120e94b}{listLength}(sentinel.scripts\_queue));
00867     listRewind(sentinel.scripts\_queue,&li);
00868     \textcolor{keywordflow}{while} ((ln = listNext(&li)) != NULL) \{
00869         sentinelScriptJob *sj = ln->value;
00870         \textcolor{keywordtype}{int} j = 0;
00871 
00872         addReplyMultiBulkLen(c,10);
00873 
00874         addReplyBulkCString(c,\textcolor{stringliteral}{"argv"});
00875         \textcolor{keywordflow}{while} (sj->argv[j]) j++;
00876         addReplyMultiBulkLen(c,j);
00877         j = 0;
00878         \textcolor{keywordflow}{while} (sj->argv[j]) addReplyBulkCString(c,sj->argv[j++]);
00879 
00880         addReplyBulkCString(c,\textcolor{stringliteral}{"flags"});
00881         addReplyBulkCString(c,
00882             (sj->flags & \hyperlink{sentinel_8c_a0211d42099c07769ec06cc0010f9b58e}{SENTINEL\_SCRIPT\_RUNNING}) ? \textcolor{stringliteral}{"running"} : \textcolor{stringliteral}{"scheduled"});
00883 
00884         addReplyBulkCString(c,\textcolor{stringliteral}{"pid"});
00885         addReplyBulkLongLong(c,sj->pid);
00886 
00887         \textcolor{keywordflow}{if} (sj->flags & \hyperlink{sentinel_8c_a0211d42099c07769ec06cc0010f9b58e}{SENTINEL\_SCRIPT\_RUNNING}) \{
00888             addReplyBulkCString(c,\textcolor{stringliteral}{"run-time"});
00889             addReplyBulkLongLong(c,mstime() - sj->start\_time);
00890         \} \textcolor{keywordflow}{else} \{
00891             mstime\_t delay = sj->start\_time ? (sj->start\_time-mstime()) : 0;
00892             \textcolor{keywordflow}{if} (delay < 0) delay = 0;
00893             addReplyBulkCString(c,\textcolor{stringliteral}{"run-delay"});
00894             addReplyBulkLongLong(c,delay);
00895         \}
00896 
00897         addReplyBulkCString(c,\textcolor{stringliteral}{"retry-num"});
00898         addReplyBulkLongLong(c,sj->retry\_num);
00899     \}
00900 \}
00901 
00902 \textcolor{comment}{/* This function calls, if any, the client reconfiguration script with the}
00903 \textcolor{comment}{ * following parameters:}
00904 \textcolor{comment}{ *}
00905 \textcolor{comment}{ * <master-name> <role> <state> <from-ip> <from-port> <to-ip> <to-port>}
00906 \textcolor{comment}{ *}
00907 \textcolor{comment}{ * It is called every time a failover is performed.}
00908 \textcolor{comment}{ *}
00909 \textcolor{comment}{ * <state> is currently always "failover".}
00910 \textcolor{comment}{ * <role> is either "leader" or "observer".}
00911 \textcolor{comment}{ *}
00912 \textcolor{comment}{ * from/to fields are respectively master -> promoted slave addresses for}
00913 \textcolor{comment}{ * "start" and "end". */}
00914 \textcolor{keywordtype}{void} sentinelCallClientReconfScript(sentinelRedisInstance *master, \textcolor{keywordtype}{int} role, \textcolor{keywordtype}{char} *state, sentinelAddr
       *from, sentinelAddr *to) \{
00915     \textcolor{keywordtype}{char} fromport[32], toport[32];
00916 
00917     \textcolor{keywordflow}{if} (master->client\_reconfig\_script == NULL) \textcolor{keywordflow}{return};
00918     ll2string(fromport,\textcolor{keyword}{sizeof}(fromport),from->port);
00919     ll2string(toport,\textcolor{keyword}{sizeof}(toport),to->port);
00920     sentinelScheduleScriptExecution(master->client\_reconfig\_script,
00921         master->name,
00922         (role == \hyperlink{sentinel_8c_a896cefcd7c6cbd3467b2387ec944fffd}{SENTINEL\_LEADER}) ? \textcolor{stringliteral}{"leader"} : \textcolor{stringliteral}{"observer"},
00923         state, from->ip, fromport, to->ip, toport, NULL);
00924 \}
00925 
00926 \textcolor{comment}{/* =============================== instanceLink ============================= */}
00927 
00928 \textcolor{comment}{/* Create a not yet connected link object. */}
00929 \hyperlink{structinstanceLink}{instanceLink} *createInstanceLink(\textcolor{keywordtype}{void}) \{
00930     \hyperlink{structinstanceLink}{instanceLink} *link = zmalloc(\textcolor{keyword}{sizeof}(*link));
00931 
00932     link->refcount = 1;
00933     link->disconnected = 1;
00934     link->pending\_commands = 0;
00935     link->cc = NULL;
00936     link->pc = NULL;
00937     link->cc\_conn\_time = 0;
00938     link->pc\_conn\_time = 0;
00939     link->last\_reconn\_time = 0;
00940     link->pc\_last\_activity = 0;
00941     \textcolor{comment}{/* We set the act\_ping\_time to "now" even if we actually don't have yet}
00942 \textcolor{comment}{     * a connection with the node, nor we sent a ping.}
00943 \textcolor{comment}{     * This is useful to detect a timeout in case we'll not be able to connect}
00944 \textcolor{comment}{     * with the node at all. */}
00945     link->act\_ping\_time = mstime();
00946     link->last\_ping\_time = 0;
00947     link->last\_avail\_time = mstime();
00948     link->last\_pong\_time = mstime();
00949     \textcolor{keywordflow}{return} link;
00950 \}
00951 
00952 \textcolor{comment}{/* Disconnect an hiredis connection in the context of an instance link. */}
00953 \textcolor{keywordtype}{void} instanceLinkCloseConnection(\hyperlink{structinstanceLink}{instanceLink} *link, redisAsyncContext *c) \{
00954     \textcolor{keywordflow}{if} (c == NULL) \textcolor{keywordflow}{return};
00955 
00956     \textcolor{keywordflow}{if} (link->cc == c) \{
00957         link->cc = NULL;
00958         link->pending\_commands = 0;
00959     \}
00960     \textcolor{keywordflow}{if} (link->pc == c) link->pc = NULL;
00961     c->data = NULL;
00962     link->disconnected = 1;
00963     redisAsyncFree(c);
00964 \}
00965 
00966 \textcolor{comment}{/* Decrement the refcount of a link object, if it drops to zero, actually}
00967 \textcolor{comment}{ * free it and return NULL. Otherwise don't do anything and return the pointer}
00968 \textcolor{comment}{ * to the object.}
00969 \textcolor{comment}{ *}
00970 \textcolor{comment}{ * If we are not going to free the link and ri is not NULL, we rebind all the}
00971 \textcolor{comment}{ * pending requests in link->cc (hiredis connection for commands) to a}
00972 \textcolor{comment}{ * callback that will just ignore them. This is useful to avoid processing}
00973 \textcolor{comment}{ * replies for an instance that no longer exists. */}
00974 \hyperlink{structinstanceLink}{instanceLink} *releaseInstanceLink(\hyperlink{structinstanceLink}{instanceLink} *link, sentinelRedisInstance *
      ri)
00975 \{
00976     \hyperlink{server_8h_a88114b5169b4c382df6b56506285e56a}{serverAssert}(link->refcount > 0);
00977     link->refcount--;
00978     \textcolor{keywordflow}{if} (link->refcount != 0) \{
00979         \textcolor{keywordflow}{if} (ri && ri->link->cc) \{
00980             \textcolor{comment}{/* This instance may have pending callbacks in the hiredis async}
00981 \textcolor{comment}{             * context, having as 'privdata' the instance that we are going to}
00982 \textcolor{comment}{             * free. Let's rewrite the callback list, directly exploiting}
00983 \textcolor{comment}{             * hiredis internal data structures, in order to bind them with}
00984 \textcolor{comment}{             * a callback that will ignore the reply at all. */}
00985             redisCallback *cb;
00986             redisCallbackList *callbacks = &link->cc->replies;
00987 
00988             cb = callbacks->head;
00989             \textcolor{keywordflow}{while}(cb) \{
00990                 \textcolor{keywordflow}{if} (cb->privdata == ri) \{
00991                     cb->fn = sentinelDiscardReplyCallback;
00992                     cb->privdata = NULL; \textcolor{comment}{/* Not strictly needed. */}
00993                 \}
00994                 cb = cb->next;
00995             \}
00996         \}
00997         \textcolor{keywordflow}{return} link; \textcolor{comment}{/* Other active users. */}
00998     \}
00999 
01000     instanceLinkCloseConnection(link,link->cc);
01001     instanceLinkCloseConnection(link,link->pc);
01002     zfree(link);
01003     \textcolor{keywordflow}{return} NULL;
01004 \}
01005 
01006 \textcolor{comment}{/* This function will attempt to share the instance link we already have}
01007 \textcolor{comment}{ * for the same Sentinel in the context of a different master, with the}
01008 \textcolor{comment}{ * instance we are passing as argument.}
01009 \textcolor{comment}{ *}
01010 \textcolor{comment}{ * This way multiple Sentinel objects that refer all to the same physical}
01011 \textcolor{comment}{ * Sentinel instance but in the context of different masters will use}
01012 \textcolor{comment}{ * a single connection, will send a single PING per second for failure}
01013 \textcolor{comment}{ * detection and so forth.}
01014 \textcolor{comment}{ *}
01015 \textcolor{comment}{ * Return C\_OK if a matching Sentinel was found in the context of a}
01016 \textcolor{comment}{ * different master and sharing was performed. Otherwise C\_ERR}
01017 \textcolor{comment}{ * is returned. */}
01018 \textcolor{keywordtype}{int} sentinelTryConnectionSharing(sentinelRedisInstance *ri) \{
01019     \hyperlink{server_8h_a88114b5169b4c382df6b56506285e56a}{serverAssert}(ri->flags & \hyperlink{sentinel_8c_a8ed55207b2af5d2dd314c951ef253f64}{SRI\_SENTINEL});
01020     dictIterator *di;
01021     dictEntry *de;
01022 
01023     \textcolor{keywordflow}{if} (ri->runid == NULL) \textcolor{keywordflow}{return} \hyperlink{server_8h_af98ac28d5f4d23d7ed5985188e6fb7d1}{C\_ERR}; \textcolor{comment}{/* No way to identify it. */}
01024     \textcolor{keywordflow}{if} (ri->link->refcount > 1) \textcolor{keywordflow}{return} \hyperlink{server_8h_af98ac28d5f4d23d7ed5985188e6fb7d1}{C\_ERR}; \textcolor{comment}{/* Already shared. */}
01025 
01026     di = dictGetIterator(sentinel.masters);
01027     \textcolor{keywordflow}{while}((de = dictNext(di)) != NULL) \{
01028         sentinelRedisInstance *master = \hyperlink{dict_8h_ae8d2cc391873b2bea2b87c4f80f43120}{dictGetVal}(de), *match;
01029         \textcolor{comment}{/* We want to share with the same physical Sentinel referenced}
01030 \textcolor{comment}{         * in other masters, so skip our master. */}
01031         \textcolor{keywordflow}{if} (master == ri->master) \textcolor{keywordflow}{continue};
01032         match = getSentinelRedisInstanceByAddrAndRunID(master->sentinels,
01033                                                        NULL,0,ri->runid);
01034         \textcolor{keywordflow}{if} (match == NULL) \textcolor{keywordflow}{continue}; \textcolor{comment}{/* No match. */}
01035         \textcolor{keywordflow}{if} (match == ri) \textcolor{keywordflow}{continue}; \textcolor{comment}{/* Should never happen but... safer. */}
01036 
01037         \textcolor{comment}{/* We identified a matching Sentinel, great! Let's free our link}
01038 \textcolor{comment}{         * and use the one of the matching Sentinel. */}
01039         releaseInstanceLink(ri->link,NULL);
01040         ri->link = match->link;
01041         match->link->refcount++;
01042         \textcolor{keywordflow}{return} \hyperlink{server_8h_a303769ef1065076e68731584e758d3e1}{C\_OK};
01043     \}
01044     dictReleaseIterator(di);
01045     \textcolor{keywordflow}{return} \hyperlink{server_8h_af98ac28d5f4d23d7ed5985188e6fb7d1}{C\_ERR};
01046 \}
01047 
01048 \textcolor{comment}{/* When we detect a Sentinel to switch address (reporting a different IP/port}
01049 \textcolor{comment}{ * pair in Hello messages), let's update all the matching Sentinels in the}
01050 \textcolor{comment}{ * context of other masters as well and disconnect the links, so that everybody}
01051 \textcolor{comment}{ * will be updated.}
01052 \textcolor{comment}{ *}
01053 \textcolor{comment}{ * Return the number of updated Sentinel addresses. */}
01054 \textcolor{keywordtype}{int} sentinelUpdateSentinelAddressInAllMasters(sentinelRedisInstance *ri) \{
01055     \hyperlink{server_8h_a88114b5169b4c382df6b56506285e56a}{serverAssert}(ri->flags & \hyperlink{sentinel_8c_a8ed55207b2af5d2dd314c951ef253f64}{SRI\_SENTINEL});
01056     dictIterator *di;
01057     dictEntry *de;
01058     \textcolor{keywordtype}{int} reconfigured = 0;
01059 
01060     di = dictGetIterator(sentinel.masters);
01061     \textcolor{keywordflow}{while}((de = dictNext(di)) != NULL) \{
01062         sentinelRedisInstance *master = \hyperlink{dict_8h_ae8d2cc391873b2bea2b87c4f80f43120}{dictGetVal}(de), *match;
01063         match = getSentinelRedisInstanceByAddrAndRunID(master->sentinels,
01064                                                        NULL,0,ri->runid);
01065         \textcolor{comment}{/* If there is no match, this master does not know about this}
01066 \textcolor{comment}{         * Sentinel, try with the next one. */}
01067         \textcolor{keywordflow}{if} (match == NULL) \textcolor{keywordflow}{continue};
01068 
01069         \textcolor{comment}{/* Disconnect the old links if connected. */}
01070         \textcolor{keywordflow}{if} (match->link->cc != NULL)
01071             instanceLinkCloseConnection(match->link,match->link->cc);
01072         \textcolor{keywordflow}{if} (match->link->pc != NULL)
01073             instanceLinkCloseConnection(match->link,match->link->pc);
01074 
01075         \textcolor{keywordflow}{if} (match == ri) \textcolor{keywordflow}{continue}; \textcolor{comment}{/* Address already updated for it. */}
01076 
01077         \textcolor{comment}{/* Update the address of the matching Sentinel by copying the address}
01078 \textcolor{comment}{         * of the Sentinel object that received the address update. */}
01079         releaseSentinelAddr(match->addr);
01080         match->addr = dupSentinelAddr(ri->addr);
01081         reconfigured++;
01082     \}
01083     dictReleaseIterator(di);
01084     \textcolor{keywordflow}{if} (reconfigured)
01085         sentinelEvent(\hyperlink{server_8h_a8c54c191e436c7dd3012167212692401}{LL\_NOTICE},\textcolor{stringliteral}{"+sentinel-address-update"}, ri,
01086                     \textcolor{stringliteral}{"%@ %d additional matching instances"}, reconfigured);
01087     \textcolor{keywordflow}{return} reconfigured;
01088 \}
01089 
01090 \textcolor{comment}{/* This function is called when an hiredis connection reported an error.}
01091 \textcolor{comment}{ * We set it to NULL and mark the link as disconnected so that it will be}
01092 \textcolor{comment}{ * reconnected again.}
01093 \textcolor{comment}{ *}
01094 \textcolor{comment}{ * Note: we don't free the hiredis context as hiredis will do it for us}
01095 \textcolor{comment}{ * for async connections. */}
01096 \textcolor{keywordtype}{void} instanceLinkConnectionError(\textcolor{keyword}{const} redisAsyncContext *c) \{
01097     \hyperlink{structinstanceLink}{instanceLink} *link = c->data;
01098     \textcolor{keywordtype}{int} pubsub;
01099 
01100     \textcolor{keywordflow}{if} (!link) \textcolor{keywordflow}{return};
01101 
01102     pubsub = (link->pc == c);
01103     \textcolor{keywordflow}{if} (pubsub)
01104         link->pc = NULL;
01105     \textcolor{keywordflow}{else}
01106         link->cc = NULL;
01107     link->disconnected = 1;
01108 \}
01109 
01110 \textcolor{comment}{/* Hiredis connection established / disconnected callbacks. We need them}
01111 \textcolor{comment}{ * just to cleanup our link state. */}
01112 \textcolor{keywordtype}{void} sentinelLinkEstablishedCallback(\textcolor{keyword}{const} redisAsyncContext *c, \textcolor{keywordtype}{int} status) \{
01113     \textcolor{keywordflow}{if} (status != \hyperlink{server_8h_a303769ef1065076e68731584e758d3e1}{C\_OK}) instanceLinkConnectionError(c);
01114 \}
01115 
01116 \textcolor{keywordtype}{void} sentinelDisconnectCallback(\textcolor{keyword}{const} redisAsyncContext *c, \textcolor{keywordtype}{int} status) \{
01117     \hyperlink{server_8h_ae7c9dc8f13568a9c856573751f1ee1ec}{UNUSED}(status);
01118     instanceLinkConnectionError(c);
01119 \}
01120 
01121 \textcolor{comment}{/* ========================== sentinelRedisInstance ========================= */}
01122 
01123 \textcolor{comment}{/* Create a redis instance, the following fields must be populated by the}
01124 \textcolor{comment}{ * caller if needed:}
01125 \textcolor{comment}{ * runid: set to NULL but will be populated once INFO output is received.}
01126 \textcolor{comment}{ * info\_refresh: is set to 0 to mean that we never received INFO so far.}
01127 \textcolor{comment}{ *}
01128 \textcolor{comment}{ * If SRI\_MASTER is set into initial flags the instance is added to}
01129 \textcolor{comment}{ * sentinel.masters table.}
01130 \textcolor{comment}{ *}
01131 \textcolor{comment}{ * if SRI\_SLAVE or SRI\_SENTINEL is set then 'master' must be not NULL and the}
01132 \textcolor{comment}{ * instance is added into master->slaves or master->sentinels table.}
01133 \textcolor{comment}{ *}
01134 \textcolor{comment}{ * If the instance is a slave or sentinel, the name parameter is ignored and}
01135 \textcolor{comment}{ * is created automatically as hostname:port.}
01136 \textcolor{comment}{ *}
01137 \textcolor{comment}{ * The function fails if hostname can't be resolved or port is out of range.}
01138 \textcolor{comment}{ * When this happens NULL is returned and errno is set accordingly to the}
01139 \textcolor{comment}{ * createSentinelAddr() function.}
01140 \textcolor{comment}{ *}
01141 \textcolor{comment}{ * The function may also fail and return NULL with errno set to EBUSY if}
01142 \textcolor{comment}{ * a master with the same name, a slave with the same address, or a sentinel}
01143 \textcolor{comment}{ * with the same ID already exists. */}
01144 
01145 sentinelRedisInstance *createSentinelRedisInstance(\textcolor{keywordtype}{char} *name, \textcolor{keywordtype}{int} flags, \textcolor{keywordtype}{char} *hostname, \textcolor{keywordtype}{int} port, \textcolor{keywordtype}{
      int} quorum, sentinelRedisInstance *master) \{
01146     sentinelRedisInstance *ri;
01147     sentinelAddr *addr;
01148     dict *table = NULL;
01149     \textcolor{keywordtype}{char} slavename[\hyperlink{server_8h_a39a30f77e23c1994e70b6c9bc892dee9}{NET\_PEER\_ID\_LEN}], *sdsname;
01150 
01151     \hyperlink{server_8h_a88114b5169b4c382df6b56506285e56a}{serverAssert}(flags & (\hyperlink{sentinel_8c_a2ee83e5ff67b45746cd6a310f15334b2}{SRI\_MASTER}|\hyperlink{sentinel_8c_a4b9db21eda79d49bd9fdf2cf7b3178e8}{SRI\_SLAVE}|
      \hyperlink{sentinel_8c_a8ed55207b2af5d2dd314c951ef253f64}{SRI\_SENTINEL}));
01152     \hyperlink{server_8h_a88114b5169b4c382df6b56506285e56a}{serverAssert}((flags & \hyperlink{sentinel_8c_a2ee83e5ff67b45746cd6a310f15334b2}{SRI\_MASTER}) || master != NULL);
01153 
01154     \textcolor{comment}{/* Check address validity. */}
01155     addr = createSentinelAddr(hostname,port);
01156     \textcolor{keywordflow}{if} (addr == NULL) \textcolor{keywordflow}{return} NULL;
01157 
01158     \textcolor{comment}{/* For slaves use ip:port as name. */}
01159     \textcolor{keywordflow}{if} (flags & \hyperlink{sentinel_8c_a4b9db21eda79d49bd9fdf2cf7b3178e8}{SRI\_SLAVE}) \{
01160         anetFormatAddr(slavename, \textcolor{keyword}{sizeof}(slavename), hostname, port);
01161         name = slavename;
01162     \}
01163 
01164     \textcolor{comment}{/* Make sure the entry is not duplicated. This may happen when the same}
01165 \textcolor{comment}{     * name for a master is used multiple times inside the configuration or}
01166 \textcolor{comment}{     * if we try to add multiple times a slave or sentinel with same ip/port}
01167 \textcolor{comment}{     * to a master. */}
01168     \textcolor{keywordflow}{if} (flags & \hyperlink{sentinel_8c_a2ee83e5ff67b45746cd6a310f15334b2}{SRI\_MASTER}) table = sentinel.masters;
01169     \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (flags & \hyperlink{sentinel_8c_a4b9db21eda79d49bd9fdf2cf7b3178e8}{SRI\_SLAVE}) table = master->slaves;
01170     \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (flags & \hyperlink{sentinel_8c_a8ed55207b2af5d2dd314c951ef253f64}{SRI\_SENTINEL}) table = master->sentinels;
01171     sdsname = sdsnew(name);
01172     \textcolor{keywordflow}{if} (dictFind(table,sdsname)) \{
01173         releaseSentinelAddr(addr);
01174         sdsfree(sdsname);
01175         errno = EBUSY;
01176         \textcolor{keywordflow}{return} NULL;
01177     \}
01178 
01179     \textcolor{comment}{/* Create the instance object. */}
01180     ri = zmalloc(\textcolor{keyword}{sizeof}(*ri));
01181     \textcolor{comment}{/* Note that all the instances are started in the disconnected state,}
01182 \textcolor{comment}{     * the event loop will take care of connecting them. */}
01183     ri->flags = flags;
01184     ri->name = sdsname;
01185     ri->runid = NULL;
01186     ri->config\_epoch = 0;
01187     ri->addr = addr;
01188     ri->link = createInstanceLink();
01189     ri->last\_pub\_time = mstime();
01190     ri->last\_hello\_time = mstime();
01191     ri->last\_master\_down\_reply\_time = mstime();
01192     ri->s\_down\_since\_time = 0;
01193     ri->o\_down\_since\_time = 0;
01194     ri->down\_after\_period = master ? master->down\_after\_period :
01195                             \hyperlink{sentinel_8c_a8d75144bfd53c71ce519a97de5016857}{SENTINEL\_DEFAULT\_DOWN\_AFTER};
01196     ri->master\_link\_down\_time = 0;
01197     ri->auth\_pass = NULL;
01198     ri->slave\_priority = \hyperlink{sentinel_8c_ac0c5ae92e4f8b5f76ff6c31ed7ffe254}{SENTINEL\_DEFAULT\_SLAVE\_PRIORITY};
01199     ri->slave\_reconf\_sent\_time = 0;
01200     ri->slave\_master\_host = NULL;
01201     ri->slave\_master\_port = 0;
01202     ri->slave\_master\_link\_status = \hyperlink{sentinel_8c_af4e90431bc568a5b3be300ecebc064d6}{SENTINEL\_MASTER\_LINK\_STATUS\_DOWN};
01203     ri->slave\_repl\_offset = 0;
01204     ri->sentinels = dictCreate(&instancesDictType,NULL);
01205     ri->quorum = quorum;
01206     ri->parallel\_syncs = \hyperlink{sentinel_8c_a7cfe6cf48e367486681eb21e53c65dc9}{SENTINEL\_DEFAULT\_PARALLEL\_SYNCS};
01207     ri->master = master;
01208     ri->slaves = dictCreate(&instancesDictType,NULL);
01209     ri->info\_refresh = 0;
01210 
01211     \textcolor{comment}{/* Failover state. */}
01212     ri->leader = NULL;
01213     ri->leader\_epoch = 0;
01214     ri->failover\_epoch = 0;
01215     ri->failover\_state = \hyperlink{sentinel_8c_a23bad5aa23e7b1a930ad4aa535938efb}{SENTINEL\_FAILOVER\_STATE\_NONE};
01216     ri->failover\_state\_change\_time = 0;
01217     ri->failover\_start\_time = 0;
01218     ri->failover\_timeout = \hyperlink{sentinel_8c_a562b5124572b4d837a34b98c41ef391d}{SENTINEL\_DEFAULT\_FAILOVER\_TIMEOUT};
01219     ri->failover\_delay\_logged = 0;
01220     ri->promoted\_slave = NULL;
01221     ri->notification\_script = NULL;
01222     ri->client\_reconfig\_script = NULL;
01223     ri->info = NULL;
01224 
01225     \textcolor{comment}{/* Role */}
01226     ri->role\_reported = ri->flags & (\hyperlink{sentinel_8c_a2ee83e5ff67b45746cd6a310f15334b2}{SRI\_MASTER}|\hyperlink{sentinel_8c_a4b9db21eda79d49bd9fdf2cf7b3178e8}{SRI\_SLAVE});
01227     ri->role\_reported\_time = mstime();
01228     ri->slave\_conf\_change\_time = mstime();
01229 
01230     \textcolor{comment}{/* Add into the right table. */}
01231     dictAdd(table, ri->name, ri);
01232     \textcolor{keywordflow}{return} ri;
01233 \}
01234 
01235 \textcolor{comment}{/* Release this instance and all its slaves, sentinels, hiredis connections.}
01236 \textcolor{comment}{ * This function does not take care of unlinking the instance from the main}
01237 \textcolor{comment}{ * masters table (if it is a master) or from its master sentinels/slaves table}
01238 \textcolor{comment}{ * if it is a slave or sentinel. */}
01239 \textcolor{keywordtype}{void} releaseSentinelRedisInstance(sentinelRedisInstance *ri) \{
01240     \textcolor{comment}{/* Release all its slaves or sentinels if any. */}
01241     dictRelease(ri->sentinels);
01242     dictRelease(ri->slaves);
01243 
01244     \textcolor{comment}{/* Disconnect the instance. */}
01245     releaseInstanceLink(ri->link,ri);
01246 
01247     \textcolor{comment}{/* Free other resources. */}
01248     sdsfree(ri->name);
01249     sdsfree(ri->runid);
01250     sdsfree(ri->notification\_script);
01251     sdsfree(ri->client\_reconfig\_script);
01252     sdsfree(ri->slave\_master\_host);
01253     sdsfree(ri->leader);
01254     sdsfree(ri->auth\_pass);
01255     sdsfree(ri->info);
01256     releaseSentinelAddr(ri->addr);
01257 
01258     \textcolor{comment}{/* Clear state into the master if needed. */}
01259     \textcolor{keywordflow}{if} ((ri->flags & \hyperlink{sentinel_8c_a4b9db21eda79d49bd9fdf2cf7b3178e8}{SRI\_SLAVE}) && (ri->flags & \hyperlink{sentinel_8c_a6c6c019b1af48a9c0e9507422051c684}{SRI\_PROMOTED}) && ri->master)
01260         ri->master->promoted\_slave = NULL;
01261 
01262     zfree(ri);
01263 \}
01264 
01265 \textcolor{comment}{/* Lookup a slave in a master Redis instance, by ip and port. */}
01266 sentinelRedisInstance *sentinelRedisInstanceLookupSlave(
01267                 sentinelRedisInstance *ri, \textcolor{keywordtype}{char} *ip, \textcolor{keywordtype}{int} port)
01268 \{
01269     sds key;
01270     sentinelRedisInstance *slave;
01271     \textcolor{keywordtype}{char} buf[\hyperlink{server_8h_a39a30f77e23c1994e70b6c9bc892dee9}{NET\_PEER\_ID\_LEN}];
01272 
01273     \hyperlink{server_8h_a88114b5169b4c382df6b56506285e56a}{serverAssert}(ri->flags & \hyperlink{sentinel_8c_a2ee83e5ff67b45746cd6a310f15334b2}{SRI\_MASTER});
01274     anetFormatAddr(buf,\textcolor{keyword}{sizeof}(buf),ip,port);
01275     key = sdsnew(buf);
01276     slave = dictFetchValue(ri->slaves,key);
01277     sdsfree(key);
01278     \textcolor{keywordflow}{return} slave;
01279 \}
01280 
01281 \textcolor{comment}{/* Return the name of the type of the instance as a string. */}
01282 \textcolor{keyword}{const} \textcolor{keywordtype}{char} *sentinelRedisInstanceTypeStr(sentinelRedisInstance *ri) \{
01283     \textcolor{keywordflow}{if} (ri->flags & \hyperlink{sentinel_8c_a2ee83e5ff67b45746cd6a310f15334b2}{SRI\_MASTER}) \textcolor{keywordflow}{return} \textcolor{stringliteral}{"master"};
01284     \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (ri->flags & \hyperlink{sentinel_8c_a4b9db21eda79d49bd9fdf2cf7b3178e8}{SRI\_SLAVE}) \textcolor{keywordflow}{return} \textcolor{stringliteral}{"slave"};
01285     \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (ri->flags & \hyperlink{sentinel_8c_a8ed55207b2af5d2dd314c951ef253f64}{SRI\_SENTINEL}) \textcolor{keywordflow}{return} \textcolor{stringliteral}{"sentinel"};
01286     \textcolor{keywordflow}{else} \textcolor{keywordflow}{return} \textcolor{stringliteral}{"unknown"};
01287 \}
01288 
01289 \textcolor{comment}{/* This function remove the Sentinel with the specified ID from the}
01290 \textcolor{comment}{ * specified master.}
01291 \textcolor{comment}{ *}
01292 \textcolor{comment}{ * If "runid" is NULL the function returns ASAP.}
01293 \textcolor{comment}{ *}
01294 \textcolor{comment}{ * This function is useful because on Sentinels address switch, we want to}
01295 \textcolor{comment}{ * remove our old entry and add a new one for the same ID but with the new}
01296 \textcolor{comment}{ * address.}
01297 \textcolor{comment}{ *}
01298 \textcolor{comment}{ * The function returns 1 if the matching Sentinel was removed, otherwise}
01299 \textcolor{comment}{ * 0 if there was no Sentinel with this ID. */}
01300 \textcolor{keywordtype}{int} removeMatchingSentinelFromMaster(sentinelRedisInstance *master, \textcolor{keywordtype}{char} *runid) \{
01301     dictIterator *di;
01302     dictEntry *de;
01303     \textcolor{keywordtype}{int} removed = 0;
01304 
01305     \textcolor{keywordflow}{if} (runid == NULL) \textcolor{keywordflow}{return} 0;
01306 
01307     di = dictGetSafeIterator(master->sentinels);
01308     \textcolor{keywordflow}{while}((de = dictNext(di)) != NULL) \{
01309         sentinelRedisInstance *ri = \hyperlink{dict_8h_ae8d2cc391873b2bea2b87c4f80f43120}{dictGetVal}(de);
01310 
01311         \textcolor{keywordflow}{if} (ri->runid && strcmp(ri->runid,runid) == 0) \{
01312             dictDelete(master->sentinels,ri->name);
01313             removed++;
01314         \}
01315     \}
01316     dictReleaseIterator(di);
01317     \textcolor{keywordflow}{return} removed;
01318 \}
01319 
01320 \textcolor{comment}{/* Search an instance with the same runid, ip and port into a dictionary}
01321 \textcolor{comment}{ * of instances. Return NULL if not found, otherwise return the instance}
01322 \textcolor{comment}{ * pointer.}
01323 \textcolor{comment}{ *}
01324 \textcolor{comment}{ * runid or ip can be NULL. In such a case the search is performed only}
01325 \textcolor{comment}{ * by the non-NULL field. */}
01326 sentinelRedisInstance *getSentinelRedisInstanceByAddrAndRunID(dict *instances, \textcolor{keywordtype}{char} *ip, \textcolor{keywordtype}{int} port, \textcolor{keywordtype}{
      char} *runid) \{
01327     dictIterator *di;
01328     dictEntry *de;
01329     sentinelRedisInstance *instance = NULL;
01330 
01331     \hyperlink{server_8h_a88114b5169b4c382df6b56506285e56a}{serverAssert}(ip || runid);   \textcolor{comment}{/* User must pass at least one search param. */}
01332     di = dictGetIterator(instances);
01333     \textcolor{keywordflow}{while}((de = dictNext(di)) != NULL) \{
01334         sentinelRedisInstance *ri = \hyperlink{dict_8h_ae8d2cc391873b2bea2b87c4f80f43120}{dictGetVal}(de);
01335 
01336         \textcolor{keywordflow}{if} (runid && !ri->runid) \textcolor{keywordflow}{continue};
01337         \textcolor{keywordflow}{if} ((runid == NULL || strcmp(ri->runid, runid) == 0) &&
01338             (ip == NULL || (strcmp(ri->addr->ip, ip) == 0 &&
01339                             ri->addr->port == port)))
01340         \{
01341             instance = ri;
01342             \textcolor{keywordflow}{break};
01343         \}
01344     \}
01345     dictReleaseIterator(di);
01346     \textcolor{keywordflow}{return} instance;
01347 \}
01348 
01349 \textcolor{comment}{/* Master lookup by name */}
01350 sentinelRedisInstance *sentinelGetMasterByName(\textcolor{keywordtype}{char} *name) \{
01351     sentinelRedisInstance *ri;
01352     sds sdsname = sdsnew(name);
01353 
01354     ri = dictFetchValue(sentinel.masters,sdsname);
01355     sdsfree(sdsname);
01356     \textcolor{keywordflow}{return} ri;
01357 \}
01358 
01359 \textcolor{comment}{/* Add the specified flags to all the instances in the specified dictionary. */}
01360 \textcolor{keywordtype}{void} sentinelAddFlagsToDictOfRedisInstances(dict *instances, \textcolor{keywordtype}{int} flags) \{
01361     dictIterator *di;
01362     dictEntry *de;
01363 
01364     di = dictGetIterator(instances);
01365     \textcolor{keywordflow}{while}((de = dictNext(di)) != NULL) \{
01366         sentinelRedisInstance *ri = \hyperlink{dict_8h_ae8d2cc391873b2bea2b87c4f80f43120}{dictGetVal}(de);
01367         ri->flags |= flags;
01368     \}
01369     dictReleaseIterator(di);
01370 \}
01371 
01372 \textcolor{comment}{/* Remove the specified flags to all the instances in the specified}
01373 \textcolor{comment}{ * dictionary. */}
01374 \textcolor{keywordtype}{void} sentinelDelFlagsToDictOfRedisInstances(dict *instances, \textcolor{keywordtype}{int} flags) \{
01375     dictIterator *di;
01376     dictEntry *de;
01377 
01378     di = dictGetIterator(instances);
01379     \textcolor{keywordflow}{while}((de = dictNext(di)) != NULL) \{
01380         sentinelRedisInstance *ri = \hyperlink{dict_8h_ae8d2cc391873b2bea2b87c4f80f43120}{dictGetVal}(de);
01381         ri->flags &= ~flags;
01382     \}
01383     dictReleaseIterator(di);
01384 \}
01385 
01386 \textcolor{comment}{/* Reset the state of a monitored master:}
01387 \textcolor{comment}{ * 1) Remove all slaves.}
01388 \textcolor{comment}{ * 2) Remove all sentinels.}
01389 \textcolor{comment}{ * 3) Remove most of the flags resulting from runtime operations.}
01390 \textcolor{comment}{ * 4) Reset timers to their default value. For example after a reset it will be}
01391 \textcolor{comment}{ *    possible to failover again the same master ASAP, without waiting the}
01392 \textcolor{comment}{ *    failover timeout delay.}
01393 \textcolor{comment}{ * 5) In the process of doing this undo the failover if in progress.}
01394 \textcolor{comment}{ * 6) Disconnect the connections with the master (will reconnect automatically).}
01395 \textcolor{comment}{ */}
01396 
01397 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{SENTINEL\_RESET\_NO\_SENTINELS} \textcolor{preprocessor}{(}1\textcolor{preprocessor}{<<}0\textcolor{preprocessor}{)}
01398 \textcolor{keywordtype}{void} sentinelResetMaster(sentinelRedisInstance *ri, \textcolor{keywordtype}{int} flags) \{
01399     \hyperlink{server_8h_a88114b5169b4c382df6b56506285e56a}{serverAssert}(ri->flags & \hyperlink{sentinel_8c_a2ee83e5ff67b45746cd6a310f15334b2}{SRI\_MASTER});
01400     dictRelease(ri->slaves);
01401     ri->slaves = dictCreate(&instancesDictType,NULL);
01402     \textcolor{keywordflow}{if} (!(flags & \hyperlink{sentinel_8c_a7cb0584b0d2fb56e4bca40b6776ae9d6}{SENTINEL\_RESET\_NO\_SENTINELS})) \{
01403         dictRelease(ri->sentinels);
01404         ri->sentinels = dictCreate(&instancesDictType,NULL);
01405     \}
01406     instanceLinkCloseConnection(ri->link,ri->link->cc);
01407     instanceLinkCloseConnection(ri->link,ri->link->pc);
01408     ri->flags &= \hyperlink{sentinel_8c_a2ee83e5ff67b45746cd6a310f15334b2}{SRI\_MASTER};
01409     \textcolor{keywordflow}{if} (ri->leader) \{
01410         sdsfree(ri->leader);
01411         ri->leader = NULL;
01412     \}
01413     ri->failover\_state = \hyperlink{sentinel_8c_a23bad5aa23e7b1a930ad4aa535938efb}{SENTINEL\_FAILOVER\_STATE\_NONE};
01414     ri->failover\_state\_change\_time = 0;
01415     ri->failover\_start\_time = 0; \textcolor{comment}{/* We can failover again ASAP. */}
01416     ri->promoted\_slave = NULL;
01417     sdsfree(ri->runid);
01418     sdsfree(ri->slave\_master\_host);
01419     ri->runid = NULL;
01420     ri->slave\_master\_host = NULL;
01421     ri->link->act\_ping\_time = mstime();
01422     ri->link->last\_ping\_time = 0;
01423     ri->link->last\_avail\_time = mstime();
01424     ri->link->last\_pong\_time = mstime();
01425     ri->role\_reported\_time = mstime();
01426     ri->role\_reported = \hyperlink{sentinel_8c_a2ee83e5ff67b45746cd6a310f15334b2}{SRI\_MASTER};
01427     \textcolor{keywordflow}{if} (flags & \hyperlink{sentinel_8c_a824209bfd4f15f07b6555fb19d8ba328}{SENTINEL\_GENERATE\_EVENT})
01428         sentinelEvent(\hyperlink{server_8h_a31229b9334bba7d6be2a72970967a14b}{LL\_WARNING},\textcolor{stringliteral}{"+reset-master"},ri,\textcolor{stringliteral}{"%@"});
01429 \}
01430 
01431 \textcolor{comment}{/* Call sentinelResetMaster() on every master with a name matching the specified}
01432 \textcolor{comment}{ * pattern. */}
01433 \textcolor{keywordtype}{int} sentinelResetMastersByPattern(\textcolor{keywordtype}{char} *pattern, \textcolor{keywordtype}{int} flags) \{
01434     dictIterator *di;
01435     dictEntry *de;
01436     \textcolor{keywordtype}{int} reset = 0;
01437 
01438     di = dictGetIterator(sentinel.masters);
01439     \textcolor{keywordflow}{while}((de = dictNext(di)) != NULL) \{
01440         sentinelRedisInstance *ri = \hyperlink{dict_8h_ae8d2cc391873b2bea2b87c4f80f43120}{dictGetVal}(de);
01441 
01442         \textcolor{keywordflow}{if} (ri->name) \{
01443             \textcolor{keywordflow}{if} (stringmatch(pattern,ri->name,0)) \{
01444                 sentinelResetMaster(ri,flags);
01445                 reset++;
01446             \}
01447         \}
01448     \}
01449     dictReleaseIterator(di);
01450     \textcolor{keywordflow}{return} reset;
01451 \}
01452 
01453 \textcolor{comment}{/* Reset the specified master with sentinelResetMaster(), and also change}
01454 \textcolor{comment}{ * the ip:port address, but take the name of the instance unmodified.}
01455 \textcolor{comment}{ *}
01456 \textcolor{comment}{ * This is used to handle the +switch-master event.}
01457 \textcolor{comment}{ *}
01458 \textcolor{comment}{ * The function returns C\_ERR if the address can't be resolved for some}
01459 \textcolor{comment}{ * reason. Otherwise C\_OK is returned.  */}
01460 \textcolor{keywordtype}{int} sentinelResetMasterAndChangeAddress(sentinelRedisInstance *master, \textcolor{keywordtype}{char} *ip, \textcolor{keywordtype}{int} port) \{
01461     sentinelAddr *oldaddr, *newaddr;
01462     sentinelAddr **slaves = NULL;
01463     \textcolor{keywordtype}{int} numslaves = 0, j;
01464     dictIterator *di;
01465     dictEntry *de;
01466 
01467     newaddr = createSentinelAddr(ip,port);
01468     \textcolor{keywordflow}{if} (newaddr == NULL) \textcolor{keywordflow}{return} \hyperlink{server_8h_af98ac28d5f4d23d7ed5985188e6fb7d1}{C\_ERR};
01469 
01470     \textcolor{comment}{/* Make a list of slaves to add back after the reset.}
01471 \textcolor{comment}{     * Don't include the one having the address we are switching to. */}
01472     di = dictGetIterator(master->slaves);
01473     \textcolor{keywordflow}{while}((de = dictNext(di)) != NULL) \{
01474         sentinelRedisInstance *slave = \hyperlink{dict_8h_ae8d2cc391873b2bea2b87c4f80f43120}{dictGetVal}(de);
01475 
01476         \textcolor{keywordflow}{if} (sentinelAddrIsEqual(slave->addr,newaddr)) \textcolor{keywordflow}{continue};
01477         slaves = zrealloc(slaves,\textcolor{keyword}{sizeof}(sentinelAddr*)*(numslaves+1));
01478         slaves[numslaves++] = createSentinelAddr(slave->addr->ip,
01479                                                  slave->addr->port);
01480     \}
01481     dictReleaseIterator(di);
01482 
01483     \textcolor{comment}{/* If we are switching to a different address, include the old address}
01484 \textcolor{comment}{     * as a slave as well, so that we'll be able to sense / reconfigure}
01485 \textcolor{comment}{     * the old master. */}
01486     \textcolor{keywordflow}{if} (!sentinelAddrIsEqual(newaddr,master->addr)) \{
01487         slaves = zrealloc(slaves,\textcolor{keyword}{sizeof}(sentinelAddr*)*(numslaves+1));
01488         slaves[numslaves++] = createSentinelAddr(master->addr->ip,
01489                                                  master->addr->port);
01490     \}
01491 
01492     \textcolor{comment}{/* Reset and switch address. */}
01493     sentinelResetMaster(master,\hyperlink{sentinel_8c_a7cb0584b0d2fb56e4bca40b6776ae9d6}{SENTINEL\_RESET\_NO\_SENTINELS});
01494     oldaddr = master->addr;
01495     master->addr = newaddr;
01496     master->o\_down\_since\_time = 0;
01497     master->s\_down\_since\_time = 0;
01498 
01499     \textcolor{comment}{/* Add slaves back. */}
01500     \textcolor{keywordflow}{for} (j = 0; j < numslaves; j++) \{
01501         sentinelRedisInstance *slave;
01502 
01503         slave = createSentinelRedisInstance(NULL,\hyperlink{sentinel_8c_a4b9db21eda79d49bd9fdf2cf7b3178e8}{SRI\_SLAVE},slaves[j]->ip,
01504                     slaves[j]->port, master->quorum, master);
01505         releaseSentinelAddr(slaves[j]);
01506         \textcolor{keywordflow}{if} (slave) sentinelEvent(\hyperlink{server_8h_a8c54c191e436c7dd3012167212692401}{LL\_NOTICE},\textcolor{stringliteral}{"+slave"},slave,\textcolor{stringliteral}{"%@"});
01507     \}
01508     zfree(slaves);
01509 
01510     \textcolor{comment}{/* Release the old address at the end so we are safe even if the function}
01511 \textcolor{comment}{     * gets the master->addr->ip and master->addr->port as arguments. */}
01512     releaseSentinelAddr(oldaddr);
01513     sentinelFlushConfig();
01514     \textcolor{keywordflow}{return} \hyperlink{server_8h_a303769ef1065076e68731584e758d3e1}{C\_OK};
01515 \}
01516 
01517 \textcolor{comment}{/* Return non-zero if there was no SDOWN or ODOWN error associated to this}
01518 \textcolor{comment}{ * instance in the latest 'ms' milliseconds. */}
01519 \textcolor{keywordtype}{int} sentinelRedisInstanceNoDownFor(sentinelRedisInstance *ri, mstime\_t ms) \{
01520     mstime\_t most\_recent;
01521 
01522     most\_recent = ri->s\_down\_since\_time;
01523     \textcolor{keywordflow}{if} (ri->o\_down\_since\_time > most\_recent)
01524         most\_recent = ri->o\_down\_since\_time;
01525     \textcolor{keywordflow}{return} most\_recent == 0 || (mstime() - most\_recent) > ms;
01526 \}
01527 
01528 \textcolor{comment}{/* Return the current master address, that is, its address or the address}
01529 \textcolor{comment}{ * of the promoted slave if already operational. */}
01530 sentinelAddr *sentinelGetCurrentMasterAddress(sentinelRedisInstance *master) \{
01531     \textcolor{comment}{/* If we are failing over the master, and the state is already}
01532 \textcolor{comment}{     * SENTINEL\_FAILOVER\_STATE\_RECONF\_SLAVES or greater, it means that we}
01533 \textcolor{comment}{     * already have the new configuration epoch in the master, and the}
01534 \textcolor{comment}{     * slave acknowledged the configuration switch. Advertise the new}
01535 \textcolor{comment}{     * address. */}
01536     \textcolor{keywordflow}{if} ((master->flags & \hyperlink{sentinel_8c_a0546b63633196f09fcd90957243b0798}{SRI\_FAILOVER\_IN\_PROGRESS}) &&
01537         master->promoted\_slave &&
01538         master->failover\_state >= \hyperlink{sentinel_8c_a05b020edfa71eb4d24288e79637b57f5}{SENTINEL\_FAILOVER\_STATE\_RECONF\_SLAVES}
      )
01539     \{
01540         \textcolor{keywordflow}{return} master->promoted\_slave->addr;
01541     \} \textcolor{keywordflow}{else} \{
01542         \textcolor{keywordflow}{return} master->addr;
01543     \}
01544 \}
01545 
01546 \textcolor{comment}{/* This function sets the down\_after\_period field value in 'master' to all}
01547 \textcolor{comment}{ * the slaves and sentinel instances connected to this master. */}
01548 \textcolor{keywordtype}{void} sentinelPropagateDownAfterPeriod(sentinelRedisInstance *master) \{
01549     dictIterator *di;
01550     dictEntry *de;
01551     \textcolor{keywordtype}{int} j;
01552     dict *d[] = \{master->slaves, master->sentinels, NULL\};
01553 
01554     \textcolor{keywordflow}{for} (j = 0; d[j]; j++) \{
01555         di = dictGetIterator(d[j]);
01556         \textcolor{keywordflow}{while}((de = dictNext(di)) != NULL) \{
01557             sentinelRedisInstance *ri = \hyperlink{dict_8h_ae8d2cc391873b2bea2b87c4f80f43120}{dictGetVal}(de);
01558             ri->down\_after\_period = master->down\_after\_period;
01559         \}
01560         dictReleaseIterator(di);
01561     \}
01562 \}
01563 
01564 \textcolor{keywordtype}{char} *sentinelGetInstanceTypeString(sentinelRedisInstance *ri) \{
01565     \textcolor{keywordflow}{if} (ri->flags & \hyperlink{sentinel_8c_a2ee83e5ff67b45746cd6a310f15334b2}{SRI\_MASTER}) \textcolor{keywordflow}{return} \textcolor{stringliteral}{"master"};
01566     \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (ri->flags & \hyperlink{sentinel_8c_a4b9db21eda79d49bd9fdf2cf7b3178e8}{SRI\_SLAVE}) \textcolor{keywordflow}{return} \textcolor{stringliteral}{"slave"};
01567     \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (ri->flags & \hyperlink{sentinel_8c_a8ed55207b2af5d2dd314c951ef253f64}{SRI\_SENTINEL}) \textcolor{keywordflow}{return} \textcolor{stringliteral}{"sentinel"};
01568     \textcolor{keywordflow}{else} \textcolor{keywordflow}{return} \textcolor{stringliteral}{"unknown"};
01569 \}
01570 
01571 \textcolor{comment}{/* ============================ Config handling ============================= */}
01572 \textcolor{keywordtype}{char} *sentinelHandleConfiguration(\textcolor{keywordtype}{char} **argv, \textcolor{keywordtype}{int} argc) \{
01573     sentinelRedisInstance *ri;
01574 
01575     \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"monitor"}) && argc == 5) \{
01576         \textcolor{comment}{/* monitor <name> <host> <port> <quorum> */}
01577         \textcolor{keywordtype}{int} quorum = atoi(argv[4]);
01578 
01579         \textcolor{keywordflow}{if} (quorum <= 0) \textcolor{keywordflow}{return} \textcolor{stringliteral}{"Quorum must be 1 or greater."};
01580         \textcolor{keywordflow}{if} (createSentinelRedisInstance(argv[1],\hyperlink{sentinel_8c_a2ee83e5ff67b45746cd6a310f15334b2}{SRI\_MASTER},argv[2],
01581                                         atoi(argv[3]),quorum,NULL) == NULL)
01582         \{
01583             \textcolor{keywordflow}{switch}(errno) \{
01584             \textcolor{keywordflow}{case} EBUSY: \textcolor{keywordflow}{return} \textcolor{stringliteral}{"Duplicated master name."};
01585             \textcolor{keywordflow}{case} ENOENT: \textcolor{keywordflow}{return} \textcolor{stringliteral}{"Can't resolve master instance hostname."};
01586             \textcolor{keywordflow}{case} EINVAL: \textcolor{keywordflow}{return} \textcolor{stringliteral}{"Invalid port number"};
01587             \}
01588         \}
01589     \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"down-after-milliseconds"}) && argc == 3) \{
01590         \textcolor{comment}{/* down-after-milliseconds <name> <milliseconds> */}
01591         ri = sentinelGetMasterByName(argv[1]);
01592         \textcolor{keywordflow}{if} (!ri) \textcolor{keywordflow}{return} \textcolor{stringliteral}{"No such master with specified name."};
01593         ri->down\_after\_period = atoi(argv[2]);
01594         \textcolor{keywordflow}{if} (ri->down\_after\_period <= 0)
01595             \textcolor{keywordflow}{return} \textcolor{stringliteral}{"negative or zero time parameter."};
01596         sentinelPropagateDownAfterPeriod(ri);
01597     \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"failover-timeout"}) && argc == 3) \{
01598         \textcolor{comment}{/* failover-timeout <name> <milliseconds> */}
01599         ri = sentinelGetMasterByName(argv[1]);
01600         \textcolor{keywordflow}{if} (!ri) \textcolor{keywordflow}{return} \textcolor{stringliteral}{"No such master with specified name."};
01601         ri->failover\_timeout = atoi(argv[2]);
01602         \textcolor{keywordflow}{if} (ri->failover\_timeout <= 0)
01603             \textcolor{keywordflow}{return} \textcolor{stringliteral}{"negative or zero time parameter."};
01604    \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"parallel-syncs"}) && argc == 3) \{
01605         \textcolor{comment}{/* parallel-syncs <name> <milliseconds> */}
01606         ri = sentinelGetMasterByName(argv[1]);
01607         \textcolor{keywordflow}{if} (!ri) \textcolor{keywordflow}{return} \textcolor{stringliteral}{"No such master with specified name."};
01608         ri->parallel\_syncs = atoi(argv[2]);
01609    \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"notification-script"}) && argc == 3) \{
01610         \textcolor{comment}{/* notification-script <name> <path> */}
01611         ri = sentinelGetMasterByName(argv[1]);
01612         \textcolor{keywordflow}{if} (!ri) \textcolor{keywordflow}{return} \textcolor{stringliteral}{"No such master with specified name."};
01613         \textcolor{keywordflow}{if} (access(argv[2],X\_OK) == -1)
01614             \textcolor{keywordflow}{return} \textcolor{stringliteral}{"Notification script seems non existing or non executable."};
01615         ri->notification\_script = sdsnew(argv[2]);
01616    \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"client-reconfig-script"}) && argc == 3) \{
01617         \textcolor{comment}{/* client-reconfig-script <name> <path> */}
01618         ri = sentinelGetMasterByName(argv[1]);
01619         \textcolor{keywordflow}{if} (!ri) \textcolor{keywordflow}{return} \textcolor{stringliteral}{"No such master with specified name."};
01620         \textcolor{keywordflow}{if} (access(argv[2],X\_OK) == -1)
01621             \textcolor{keywordflow}{return} \textcolor{stringliteral}{"Client reconfiguration script seems non existing or "}
01622                    \textcolor{stringliteral}{"non executable."};
01623         ri->client\_reconfig\_script = sdsnew(argv[2]);
01624    \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"auth-pass"}) && argc == 3) \{
01625         \textcolor{comment}{/* auth-pass <name> <password> */}
01626         ri = sentinelGetMasterByName(argv[1]);
01627         \textcolor{keywordflow}{if} (!ri) \textcolor{keywordflow}{return} \textcolor{stringliteral}{"No such master with specified name."};
01628         ri->auth\_pass = sdsnew(argv[2]);
01629     \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"current-epoch"}) && argc == 2) \{
01630         \textcolor{comment}{/* current-epoch <epoch> */}
01631         \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{long} \textcolor{keywordtype}{long} current\_epoch = strtoull(argv[1],NULL,10);
01632         \textcolor{keywordflow}{if} (current\_epoch > sentinel.current\_epoch)
01633             sentinel.current\_epoch = current\_epoch;
01634     \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"myid"}) && argc == 2) \{
01635         \textcolor{keywordflow}{if} (strlen(argv[1]) != \hyperlink{server_8h_aba6794fa3ee28f85165eaed93190f1df}{CONFIG\_RUN\_ID\_SIZE})
01636             \textcolor{keywordflow}{return} \textcolor{stringliteral}{"Malformed Sentinel id in myid option."};
01637         memcpy(sentinel.myid,argv[1],\hyperlink{server_8h_aba6794fa3ee28f85165eaed93190f1df}{CONFIG\_RUN\_ID\_SIZE});
01638     \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"config-epoch"}) && argc == 3) \{
01639         \textcolor{comment}{/* config-epoch <name> <epoch> */}
01640         ri = sentinelGetMasterByName(argv[1]);
01641         \textcolor{keywordflow}{if} (!ri) \textcolor{keywordflow}{return} \textcolor{stringliteral}{"No such master with specified name."};
01642         ri->config\_epoch = strtoull(argv[2],NULL,10);
01643         \textcolor{comment}{/* The following update of current\_epoch is not really useful as}
01644 \textcolor{comment}{         * now the current epoch is persisted on the config file, but}
01645 \textcolor{comment}{         * we leave this check here for redundancy. */}
01646         \textcolor{keywordflow}{if} (ri->config\_epoch > sentinel.current\_epoch)
01647             sentinel.current\_epoch = ri->config\_epoch;
01648     \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"leader-epoch"}) && argc == 3) \{
01649         \textcolor{comment}{/* leader-epoch <name> <epoch> */}
01650         ri = sentinelGetMasterByName(argv[1]);
01651         \textcolor{keywordflow}{if} (!ri) \textcolor{keywordflow}{return} \textcolor{stringliteral}{"No such master with specified name."};
01652         ri->leader\_epoch = strtoull(argv[2],NULL,10);
01653     \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"known-slave"}) && argc == 4) \{
01654         sentinelRedisInstance *slave;
01655 
01656         \textcolor{comment}{/* known-slave <name> <ip> <port> */}
01657         ri = sentinelGetMasterByName(argv[1]);
01658         \textcolor{keywordflow}{if} (!ri) \textcolor{keywordflow}{return} \textcolor{stringliteral}{"No such master with specified name."};
01659         \textcolor{keywordflow}{if} ((slave = createSentinelRedisInstance(NULL,\hyperlink{sentinel_8c_a4b9db21eda79d49bd9fdf2cf7b3178e8}{SRI\_SLAVE},argv[2],
01660                     atoi(argv[3]), ri->quorum, ri)) == NULL)
01661         \{
01662             \textcolor{keywordflow}{return} \textcolor{stringliteral}{"Wrong hostname or port for slave."};
01663         \}
01664     \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"known-sentinel"}) &&
01665                (argc == 4 || argc == 5)) \{
01666         sentinelRedisInstance *si;
01667 
01668         \textcolor{keywordflow}{if} (argc == 5) \{ \textcolor{comment}{/* Ignore the old form without runid. */}
01669             \textcolor{comment}{/* known-sentinel <name> <ip> <port> [runid] */}
01670             ri = sentinelGetMasterByName(argv[1]);
01671             \textcolor{keywordflow}{if} (!ri) \textcolor{keywordflow}{return} \textcolor{stringliteral}{"No such master with specified name."};
01672             \textcolor{keywordflow}{if} ((si = createSentinelRedisInstance(argv[4],\hyperlink{sentinel_8c_a8ed55207b2af5d2dd314c951ef253f64}{SRI\_SENTINEL},argv[2],
01673                         atoi(argv[3]), ri->quorum, ri)) == NULL)
01674             \{
01675                 \textcolor{keywordflow}{return} \textcolor{stringliteral}{"Wrong hostname or port for sentinel."};
01676             \}
01677             si->runid = sdsnew(argv[4]);
01678             sentinelTryConnectionSharing(si);
01679         \}
01680     \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"announce-ip"}) && argc == 2) \{
01681         \textcolor{comment}{/* announce-ip <ip-address> */}
01682         \textcolor{keywordflow}{if} (strlen(argv[1]))
01683             sentinel.announce\_ip = sdsnew(argv[1]);
01684     \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(argv[0],\textcolor{stringliteral}{"announce-port"}) && argc == 2) \{
01685         \textcolor{comment}{/* announce-port <port> */}
01686         sentinel.announce\_port = atoi(argv[1]);
01687     \} \textcolor{keywordflow}{else} \{
01688         \textcolor{keywordflow}{return} \textcolor{stringliteral}{"Unrecognized sentinel configuration statement."};
01689     \}
01690     \textcolor{keywordflow}{return} NULL;
01691 \}
01692 
01693 \textcolor{comment}{/* Implements CONFIG REWRITE for "sentinel" option.}
01694 \textcolor{comment}{ * This is used not just to rewrite the configuration given by the user}
01695 \textcolor{comment}{ * (the configured masters) but also in order to retain the state of}
01696 \textcolor{comment}{ * Sentinel across restarts: config epoch of masters, associated slaves}
01697 \textcolor{comment}{ * and sentinel instances, and so forth. */}
01698 \textcolor{keywordtype}{void} rewriteConfigSentinelOption(\textcolor{keyword}{struct} rewriteConfigState *state) \{
01699     dictIterator *di, *di2;
01700     dictEntry *de;
01701     sds line;
01702 
01703     \textcolor{comment}{/* sentinel unique ID. */}
01704     line = sdscatprintf(sdsempty(), \textcolor{stringliteral}{"sentinel myid %s"}, sentinel.myid);
01705     rewriteConfigRewriteLine(state,\textcolor{stringliteral}{"sentinel"},line,1);
01706 
01707     \textcolor{comment}{/* For every master emit a "sentinel monitor" config entry. */}
01708     di = dictGetIterator(sentinel.masters);
01709     \textcolor{keywordflow}{while}((de = dictNext(di)) != NULL) \{
01710         sentinelRedisInstance *master, *ri;
01711         sentinelAddr *master\_addr;
01712 
01713         \textcolor{comment}{/* sentinel monitor */}
01714         master = \hyperlink{dict_8h_ae8d2cc391873b2bea2b87c4f80f43120}{dictGetVal}(de);
01715         master\_addr = sentinelGetCurrentMasterAddress(master);
01716         line = sdscatprintf(sdsempty(),\textcolor{stringliteral}{"sentinel monitor %s %s %d %d"},
01717             master->name, master\_addr->ip, master\_addr->port,
01718             master->quorum);
01719         rewriteConfigRewriteLine(state,\textcolor{stringliteral}{"sentinel"},line,1);
01720 
01721         \textcolor{comment}{/* sentinel down-after-milliseconds */}
01722         \textcolor{keywordflow}{if} (master->down\_after\_period != \hyperlink{sentinel_8c_a8d75144bfd53c71ce519a97de5016857}{SENTINEL\_DEFAULT\_DOWN\_AFTER}) \{
01723             line = sdscatprintf(sdsempty(),
01724                 \textcolor{stringliteral}{"sentinel down-after-milliseconds %s %ld"},
01725                 master->name, (\textcolor{keywordtype}{long}) master->down\_after\_period);
01726             rewriteConfigRewriteLine(state,\textcolor{stringliteral}{"sentinel"},line,1);
01727         \}
01728 
01729         \textcolor{comment}{/* sentinel failover-timeout */}
01730         \textcolor{keywordflow}{if} (master->failover\_timeout != \hyperlink{sentinel_8c_a562b5124572b4d837a34b98c41ef391d}{SENTINEL\_DEFAULT\_FAILOVER\_TIMEOUT}
      ) \{
01731             line = sdscatprintf(sdsempty(),
01732                 \textcolor{stringliteral}{"sentinel failover-timeout %s %ld"},
01733                 master->name, (\textcolor{keywordtype}{long}) master->failover\_timeout);
01734             rewriteConfigRewriteLine(state,\textcolor{stringliteral}{"sentinel"},line,1);
01735         \}
01736 
01737         \textcolor{comment}{/* sentinel parallel-syncs */}
01738         \textcolor{keywordflow}{if} (master->parallel\_syncs != \hyperlink{sentinel_8c_a7cfe6cf48e367486681eb21e53c65dc9}{SENTINEL\_DEFAULT\_PARALLEL\_SYNCS}) 
      \{
01739             line = sdscatprintf(sdsempty(),
01740                 \textcolor{stringliteral}{"sentinel parallel-syncs %s %d"},
01741                 master->name, master->parallel\_syncs);
01742             rewriteConfigRewriteLine(state,\textcolor{stringliteral}{"sentinel"},line,1);
01743         \}
01744 
01745         \textcolor{comment}{/* sentinel notification-script */}
01746         \textcolor{keywordflow}{if} (master->notification\_script) \{
01747             line = sdscatprintf(sdsempty(),
01748                 \textcolor{stringliteral}{"sentinel notification-script %s %s"},
01749                 master->name, master->notification\_script);
01750             rewriteConfigRewriteLine(state,\textcolor{stringliteral}{"sentinel"},line,1);
01751         \}
01752 
01753         \textcolor{comment}{/* sentinel client-reconfig-script */}
01754         \textcolor{keywordflow}{if} (master->client\_reconfig\_script) \{
01755             line = sdscatprintf(sdsempty(),
01756                 \textcolor{stringliteral}{"sentinel client-reconfig-script %s %s"},
01757                 master->name, master->client\_reconfig\_script);
01758             rewriteConfigRewriteLine(state,\textcolor{stringliteral}{"sentinel"},line,1);
01759         \}
01760 
01761         \textcolor{comment}{/* sentinel auth-pass */}
01762         \textcolor{keywordflow}{if} (master->auth\_pass) \{
01763             line = sdscatprintf(sdsempty(),
01764                 \textcolor{stringliteral}{"sentinel auth-pass %s %s"},
01765                 master->name, master->auth\_pass);
01766             rewriteConfigRewriteLine(state,\textcolor{stringliteral}{"sentinel"},line,1);
01767         \}
01768 
01769         \textcolor{comment}{/* sentinel config-epoch */}
01770         line = sdscatprintf(sdsempty(),
01771             \textcolor{stringliteral}{"sentinel config-epoch %s %llu"},
01772             master->name, (\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{long} \textcolor{keywordtype}{long}) master->config\_epoch);
01773         rewriteConfigRewriteLine(state,\textcolor{stringliteral}{"sentinel"},line,1);
01774 
01775         \textcolor{comment}{/* sentinel leader-epoch */}
01776         line = sdscatprintf(sdsempty(),
01777             \textcolor{stringliteral}{"sentinel leader-epoch %s %llu"},
01778             master->name, (\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{long} \textcolor{keywordtype}{long}) master->leader\_epoch);
01779         rewriteConfigRewriteLine(state,\textcolor{stringliteral}{"sentinel"},line,1);
01780 
01781         \textcolor{comment}{/* sentinel known-slave */}
01782         di2 = dictGetIterator(master->slaves);
01783         \textcolor{keywordflow}{while}((de = dictNext(di2)) != NULL) \{
01784             sentinelAddr *slave\_addr;
01785 
01786             ri = \hyperlink{dict_8h_ae8d2cc391873b2bea2b87c4f80f43120}{dictGetVal}(de);
01787             slave\_addr = ri->addr;
01788 
01789             \textcolor{comment}{/* If master\_addr (obtained using sentinelGetCurrentMasterAddress()}
01790 \textcolor{comment}{             * so it may be the address of the promoted slave) is equal to this}
01791 \textcolor{comment}{             * slave's address, a failover is in progress and the slave was}
01792 \textcolor{comment}{             * already successfully promoted. So as the address of this slave}
01793 \textcolor{comment}{             * we use the old master address instead. */}
01794             \textcolor{keywordflow}{if} (sentinelAddrIsEqual(slave\_addr,master\_addr))
01795                 slave\_addr = master->addr;
01796             line = sdscatprintf(sdsempty(),
01797                 \textcolor{stringliteral}{"sentinel known-slave %s %s %d"},
01798                 master->name, slave\_addr->ip, slave\_addr->port);
01799             rewriteConfigRewriteLine(state,\textcolor{stringliteral}{"sentinel"},line,1);
01800         \}
01801         dictReleaseIterator(di2);
01802 
01803         \textcolor{comment}{/* sentinel known-sentinel */}
01804         di2 = dictGetIterator(master->sentinels);
01805         \textcolor{keywordflow}{while}((de = dictNext(di2)) != NULL) \{
01806             ri = \hyperlink{dict_8h_ae8d2cc391873b2bea2b87c4f80f43120}{dictGetVal}(de);
01807             \textcolor{keywordflow}{if} (ri->runid == NULL) \textcolor{keywordflow}{continue};
01808             line = sdscatprintf(sdsempty(),
01809                 \textcolor{stringliteral}{"sentinel known-sentinel %s %s %d %s"},
01810                 master->name, ri->addr->ip, ri->addr->port, ri->runid);
01811             rewriteConfigRewriteLine(state,\textcolor{stringliteral}{"sentinel"},line,1);
01812         \}
01813         dictReleaseIterator(di2);
01814     \}
01815 
01816     \textcolor{comment}{/* sentinel current-epoch is a global state valid for all the masters. */}
01817     line = sdscatprintf(sdsempty(),
01818         \textcolor{stringliteral}{"sentinel current-epoch %llu"}, (\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{long} \textcolor{keywordtype}{long}) sentinel.current\_epoch);
01819     rewriteConfigRewriteLine(state,\textcolor{stringliteral}{"sentinel"},line,1);
01820 
01821     \textcolor{comment}{/* sentinel announce-ip. */}
01822     \textcolor{keywordflow}{if} (sentinel.announce\_ip) \{
01823         line = sdsnew(\textcolor{stringliteral}{"sentinel announce-ip "});
01824         line = sdscatrepr(line, sentinel.announce\_ip, sdslen(sentinel.announce\_ip));
01825         rewriteConfigRewriteLine(state,\textcolor{stringliteral}{"sentinel"},line,1);
01826     \}
01827 
01828     \textcolor{comment}{/* sentinel announce-port. */}
01829     \textcolor{keywordflow}{if} (sentinel.announce\_port) \{
01830         line = sdscatprintf(sdsempty(),\textcolor{stringliteral}{"sentinel announce-port %d"},
01831                             sentinel.announce\_port);
01832         rewriteConfigRewriteLine(state,\textcolor{stringliteral}{"sentinel"},line,1);
01833     \}
01834 
01835     dictReleaseIterator(di);
01836 \}
01837 
01838 \textcolor{comment}{/* This function uses the config rewriting Redis engine in order to persist}
01839 \textcolor{comment}{ * the state of the Sentinel in the current configuration file.}
01840 \textcolor{comment}{ *}
01841 \textcolor{comment}{ * Before returning the function calls fsync() against the generated}
01842 \textcolor{comment}{ * configuration file to make sure changes are committed to disk.}
01843 \textcolor{comment}{ *}
01844 \textcolor{comment}{ * On failure the function logs a warning on the Redis log. */}
01845 \textcolor{keywordtype}{void} sentinelFlushConfig(\textcolor{keywordtype}{void}) \{
01846     \textcolor{keywordtype}{int} fd = -1;
01847     \textcolor{keywordtype}{int} saved\_hz = server.hz;
01848     \textcolor{keywordtype}{int} rewrite\_status;
01849 
01850     server.hz = \hyperlink{server_8h_aa5a3b127e21d6bf089025d953c44678a}{CONFIG\_DEFAULT\_HZ};
01851     rewrite\_status = rewriteConfig(server.configfile);
01852     server.hz = saved\_hz;
01853 
01854     \textcolor{keywordflow}{if} (rewrite\_status == -1) \textcolor{keywordflow}{goto} werr;
01855     \textcolor{keywordflow}{if} ((fd = open(server.configfile,O\_RDONLY)) == -1) \textcolor{keywordflow}{goto} werr;
01856     \textcolor{keywordflow}{if} (fsync(fd) == -1) \textcolor{keywordflow}{goto} werr;
01857     \textcolor{keywordflow}{if} (close(fd) == EOF) \textcolor{keywordflow}{goto} werr;
01858     \textcolor{keywordflow}{return};
01859 
01860 werr:
01861     \textcolor{keywordflow}{if} (fd != -1) close(fd);
01862     serverLog(\hyperlink{server_8h_a31229b9334bba7d6be2a72970967a14b}{LL\_WARNING},\textcolor{stringliteral}{"WARNING: Sentinel was not able to save the new configuration on
       disk!!!: %s"}, strerror(errno));
01863 \}
01864 
01865 \textcolor{comment}{/* ====================== hiredis connection handling ======================= */}
01866 
01867 \textcolor{comment}{/* Send the AUTH command with the specified master password if needed.}
01868 \textcolor{comment}{ * Note that for slaves the password set for the master is used.}
01869 \textcolor{comment}{ *}
01870 \textcolor{comment}{ * We don't check at all if the command was successfully transmitted}
01871 \textcolor{comment}{ * to the instance as if it fails Sentinel will detect the instance down,}
01872 \textcolor{comment}{ * will disconnect and reconnect the link and so forth. */}
01873 \textcolor{keywordtype}{void} sentinelSendAuthIfNeeded(sentinelRedisInstance *ri, redisAsyncContext *c) \{
01874     \textcolor{keywordtype}{char} *auth\_pass = (ri->flags & \hyperlink{sentinel_8c_a2ee83e5ff67b45746cd6a310f15334b2}{SRI\_MASTER}) ? ri->auth\_pass :
01875                                                  ri->master->auth\_pass;
01876 
01877     \textcolor{keywordflow}{if} (auth\_pass) \{
01878         \textcolor{keywordflow}{if} (redisAsyncCommand(c, sentinelDiscardReplyCallback, ri, \textcolor{stringliteral}{"AUTH %s"},
01879             auth\_pass) == \hyperlink{server_8h_a303769ef1065076e68731584e758d3e1}{C\_OK}) ri->link->pending\_commands++;
01880     \}
01881 \}
01882 
01883 \textcolor{comment}{/* Use CLIENT SETNAME to name the connection in the Redis instance as}
01884 \textcolor{comment}{ * sentinel-<first\_8\_chars\_of\_runid>-<connection\_type>}
01885 \textcolor{comment}{ * The connection type is "cmd" or "pubsub" as specified by 'type'.}
01886 \textcolor{comment}{ *}
01887 \textcolor{comment}{ * This makes it possible to list all the sentinel instances connected}
01888 \textcolor{comment}{ * to a Redis servewr with CLIENT LIST, grepping for a specific name format. */}
01889 \textcolor{keywordtype}{void} sentinelSetClientName(sentinelRedisInstance *ri, redisAsyncContext *c, \textcolor{keywordtype}{char} *type) \{
01890     \textcolor{keywordtype}{char} name[64];
01891 
01892     snprintf(name,\textcolor{keyword}{sizeof}(name),\textcolor{stringliteral}{"sentinel-%.8s-%s"},sentinel.myid,type);
01893     \textcolor{keywordflow}{if} (redisAsyncCommand(c, sentinelDiscardReplyCallback, ri,
01894         \textcolor{stringliteral}{"CLIENT SETNAME %s"}, name) == \hyperlink{server_8h_a303769ef1065076e68731584e758d3e1}{C\_OK})
01895     \{
01896         ri->link->pending\_commands++;
01897     \}
01898 \}
01899 
01900 \textcolor{comment}{/* Create the async connections for the instance link if the link}
01901 \textcolor{comment}{ * is disconnected. Note that link->disconnected is true even if just}
01902 \textcolor{comment}{ * one of the two links (commands and pub/sub) is missing. */}
01903 \textcolor{keywordtype}{void} sentinelReconnectInstance(sentinelRedisInstance *ri) \{
01904     \textcolor{keywordflow}{if} (ri->link->disconnected == 0) \textcolor{keywordflow}{return};
01905     \textcolor{keywordflow}{if} (ri->addr->port == 0) \textcolor{keywordflow}{return}; \textcolor{comment}{/* port == 0 means invalid address. */}
01906     \hyperlink{structinstanceLink}{instanceLink} *link = ri->link;
01907     mstime\_t now = mstime();
01908 
01909     \textcolor{keywordflow}{if} (now - ri->link->last\_reconn\_time < \hyperlink{sentinel_8c_a9e22409355fa7a4db7f3a43fbe2d9101}{SENTINEL\_PING\_PERIOD}) \textcolor{keywordflow}{return};
01910     ri->link->last\_reconn\_time = now;
01911 
01912     \textcolor{comment}{/* Commands connection. */}
01913     \textcolor{keywordflow}{if} (link->cc == NULL) \{
01914         link->cc = redisAsyncConnectBind(ri->addr->ip,ri->addr->port,
      \hyperlink{server_8h_a53b900c09238a4ff78e0af9574335dfd}{NET\_FIRST\_BIND\_ADDR});
01915         \textcolor{keywordflow}{if} (link->cc->err) \{
01916             sentinelEvent(\hyperlink{server_8h_abcaffe365dee628fcf9fc90c69d534a1}{LL\_DEBUG},\textcolor{stringliteral}{"-cmd-link-reconnection"},ri,\textcolor{stringliteral}{"%@ #%s"},
01917                 link->cc->errstr);
01918             instanceLinkCloseConnection(link,link->cc);
01919         \} \textcolor{keywordflow}{else} \{
01920             link->pending\_commands = 0;
01921             link->cc\_conn\_time = mstime();
01922             link->cc->data = link;
01923             redisAeAttach(server.el,link->cc);
01924             redisAsyncSetConnectCallback(link->cc,
01925                     sentinelLinkEstablishedCallback);
01926             redisAsyncSetDisconnectCallback(link->cc,
01927                     sentinelDisconnectCallback);
01928             sentinelSendAuthIfNeeded(ri,link->cc);
01929             sentinelSetClientName(ri,link->cc,\textcolor{stringliteral}{"cmd"});
01930 
01931             \textcolor{comment}{/* Send a PING ASAP when reconnecting. */}
01932             sentinelSendPing(ri);
01933         \}
01934     \}
01935     \textcolor{comment}{/* Pub / Sub */}
01936     \textcolor{keywordflow}{if} ((ri->flags & (\hyperlink{sentinel_8c_a2ee83e5ff67b45746cd6a310f15334b2}{SRI\_MASTER}|\hyperlink{sentinel_8c_a4b9db21eda79d49bd9fdf2cf7b3178e8}{SRI\_SLAVE})) && link->pc == NULL) \{
01937         link->pc = redisAsyncConnectBind(ri->addr->ip,ri->addr->port,
      \hyperlink{server_8h_a53b900c09238a4ff78e0af9574335dfd}{NET\_FIRST\_BIND\_ADDR});
01938         \textcolor{keywordflow}{if} (link->pc->err) \{
01939             sentinelEvent(\hyperlink{server_8h_abcaffe365dee628fcf9fc90c69d534a1}{LL\_DEBUG},\textcolor{stringliteral}{"-pubsub-link-reconnection"},ri,\textcolor{stringliteral}{"%@ #%s"},
01940                 link->pc->errstr);
01941             instanceLinkCloseConnection(link,link->pc);
01942         \} \textcolor{keywordflow}{else} \{
01943             \textcolor{keywordtype}{int} retval;
01944 
01945             link->pc\_conn\_time = mstime();
01946             link->pc->data = link;
01947             redisAeAttach(server.el,link->pc);
01948             redisAsyncSetConnectCallback(link->pc,
01949                     sentinelLinkEstablishedCallback);
01950             redisAsyncSetDisconnectCallback(link->pc,
01951                     sentinelDisconnectCallback);
01952             sentinelSendAuthIfNeeded(ri,link->pc);
01953             sentinelSetClientName(ri,link->pc,\textcolor{stringliteral}{"pubsub"});
01954             \textcolor{comment}{/* Now we subscribe to the Sentinels "Hello" channel. */}
01955             retval = redisAsyncCommand(link->pc,
01956                 sentinelReceiveHelloMessages, ri, \textcolor{stringliteral}{"SUBSCRIBE %s"},
01957                     \hyperlink{sentinel_8c_aa57e3638aae4eec03d29f247b1611569}{SENTINEL\_HELLO\_CHANNEL});
01958             \textcolor{keywordflow}{if} (retval != \hyperlink{server_8h_a303769ef1065076e68731584e758d3e1}{C\_OK}) \{
01959                 \textcolor{comment}{/* If we can't subscribe, the Pub/Sub connection is useless}
01960 \textcolor{comment}{                 * and we can simply disconnect it and try again. */}
01961                 instanceLinkCloseConnection(link,link->pc);
01962                 \textcolor{keywordflow}{return};
01963             \}
01964         \}
01965     \}
01966     \textcolor{comment}{/* Clear the disconnected status only if we have both the connections}
01967 \textcolor{comment}{     * (or just the commands connection if this is a sentinel instance). */}
01968     \textcolor{keywordflow}{if} (link->cc && (ri->flags & \hyperlink{sentinel_8c_a8ed55207b2af5d2dd314c951ef253f64}{SRI\_SENTINEL} || link->pc))
01969         link->disconnected = 0;
01970 \}
01971 
01972 \textcolor{comment}{/* ======================== Redis instances pinging  ======================== */}
01973 
01974 \textcolor{comment}{/* Return true if master looks "sane", that is:}
01975 \textcolor{comment}{ * 1) It is actually a master in the current configuration.}
01976 \textcolor{comment}{ * 2) It reports itself as a master.}
01977 \textcolor{comment}{ * 3) It is not SDOWN or ODOWN.}
01978 \textcolor{comment}{ * 4) We obtained last INFO no more than two times the INFO period time ago. */}
01979 \textcolor{keywordtype}{int} sentinelMasterLooksSane(sentinelRedisInstance *master) \{
01980     \textcolor{keywordflow}{return}
01981         master->flags & \hyperlink{sentinel_8c_a2ee83e5ff67b45746cd6a310f15334b2}{SRI\_MASTER} &&
01982         master->role\_reported == \hyperlink{sentinel_8c_a2ee83e5ff67b45746cd6a310f15334b2}{SRI\_MASTER} &&
01983         (master->flags & (\hyperlink{sentinel_8c_a8e26596c8bde451c2dd9cecb2c3046d4}{SRI\_S\_DOWN}|\hyperlink{sentinel_8c_a3bbbca05543cd9d9f86d276e2c7c719c}{SRI\_O\_DOWN})) == 0 &&
01984         (mstime() - master->info\_refresh) < \hyperlink{sentinel_8c_ac6a2144aa06344ed8547176a4e3cfaa5}{SENTINEL\_INFO\_PERIOD}*2;
01985 \}
01986 
01987 \textcolor{comment}{/* Process the INFO output from masters. */}
01988 \textcolor{keywordtype}{void} sentinelRefreshInstanceInfo(sentinelRedisInstance *ri, \textcolor{keyword}{const} \textcolor{keywordtype}{char} *info) \{
01989     sds *lines;
01990     \textcolor{keywordtype}{int} numlines, j;
01991     \textcolor{keywordtype}{int} role = 0;
01992 
01993     \textcolor{comment}{/* cache full INFO output for instance */}
01994     sdsfree(ri->info);
01995     ri->info = sdsnew(info);
01996 
01997     \textcolor{comment}{/* The following fields must be reset to a given value in the case they}
01998 \textcolor{comment}{     * are not found at all in the INFO output. */}
01999     ri->master\_link\_down\_time = 0;
02000 
02001     \textcolor{comment}{/* Process line by line. */}
02002     lines = sdssplitlen(info,strlen(info),\textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"},2,&numlines);
02003     \textcolor{keywordflow}{for} (j = 0; j < numlines; j++) \{
02004         sentinelRedisInstance *slave;
02005         sds l = lines[j];
02006 
02007         \textcolor{comment}{/* run\_id:<40 hex chars>*/}
02008         \textcolor{keywordflow}{if} (sdslen(l) >= 47 && !memcmp(l,\textcolor{stringliteral}{"run\_id:"},7)) \{
02009             \textcolor{keywordflow}{if} (ri->runid == NULL) \{
02010                 ri->runid = sdsnewlen(l+7,40);
02011             \} \textcolor{keywordflow}{else} \{
02012                 \textcolor{keywordflow}{if} (strncmp(ri->runid,l+7,40) != 0) \{
02013                     sentinelEvent(\hyperlink{server_8h_a8c54c191e436c7dd3012167212692401}{LL\_NOTICE},\textcolor{stringliteral}{"+reboot"},ri,\textcolor{stringliteral}{"%@"});
02014                     sdsfree(ri->runid);
02015                     ri->runid = sdsnewlen(l+7,40);
02016                 \}
02017             \}
02018         \}
02019 
02020         \textcolor{comment}{/* old versions: slave0:<ip>,<port>,<state>}
02021 \textcolor{comment}{         * new versions: slave0:ip=127.0.0.1,port=9999,... */}
02022         \textcolor{keywordflow}{if} ((ri->flags & \hyperlink{sentinel_8c_a2ee83e5ff67b45746cd6a310f15334b2}{SRI\_MASTER}) &&
02023             sdslen(l) >= 7 &&
02024             !memcmp(l,\textcolor{stringliteral}{"slave"},5) && isdigit(l[5]))
02025         \{
02026             \textcolor{keywordtype}{char} *ip, *port, *end;
02027 
02028             \textcolor{keywordflow}{if} (strstr(l,\textcolor{stringliteral}{"ip="}) == NULL) \{
02029                 \textcolor{comment}{/* Old format. */}
02030                 ip = strchr(l,\textcolor{stringliteral}{':'}); \textcolor{keywordflow}{if} (!ip) \textcolor{keywordflow}{continue};
02031                 ip++; \textcolor{comment}{/* Now ip points to start of ip address. */}
02032                 port = strchr(ip,\textcolor{stringliteral}{','}); \textcolor{keywordflow}{if} (!port) \textcolor{keywordflow}{continue};
02033                 *port = \textcolor{stringliteral}{'\(\backslash\)0'}; \textcolor{comment}{/* nul term for easy access. */}
02034                 port++; \textcolor{comment}{/* Now port points to start of port number. */}
02035                 end = strchr(port,\textcolor{stringliteral}{','}); \textcolor{keywordflow}{if} (!end) \textcolor{keywordflow}{continue};
02036                 *end = \textcolor{stringliteral}{'\(\backslash\)0'}; \textcolor{comment}{/* nul term for easy access. */}
02037             \} \textcolor{keywordflow}{else} \{
02038                 \textcolor{comment}{/* New format. */}
02039                 ip = strstr(l,\textcolor{stringliteral}{"ip="}); \textcolor{keywordflow}{if} (!ip) \textcolor{keywordflow}{continue};
02040                 ip += 3; \textcolor{comment}{/* Now ip points to start of ip address. */}
02041                 port = strstr(l,\textcolor{stringliteral}{"port="}); \textcolor{keywordflow}{if} (!port) \textcolor{keywordflow}{continue};
02042                 port += 5; \textcolor{comment}{/* Now port points to start of port number. */}
02043                 \textcolor{comment}{/* Nul term both fields for easy access. */}
02044                 end = strchr(ip,\textcolor{stringliteral}{','}); \textcolor{keywordflow}{if} (end) *end = \textcolor{stringliteral}{'\(\backslash\)0'};
02045                 end = strchr(port,\textcolor{stringliteral}{','}); \textcolor{keywordflow}{if} (end) *end = \textcolor{stringliteral}{'\(\backslash\)0'};
02046             \}
02047 
02048             \textcolor{comment}{/* Check if we already have this slave into our table,}
02049 \textcolor{comment}{             * otherwise add it. */}
02050             \textcolor{keywordflow}{if} (sentinelRedisInstanceLookupSlave(ri,ip,atoi(port)) == NULL) \{
02051                 \textcolor{keywordflow}{if} ((slave = createSentinelRedisInstance(NULL,\hyperlink{sentinel_8c_a4b9db21eda79d49bd9fdf2cf7b3178e8}{SRI\_SLAVE},ip,
02052                             atoi(port), ri->quorum, ri)) != NULL)
02053                 \{
02054                     sentinelEvent(\hyperlink{server_8h_a8c54c191e436c7dd3012167212692401}{LL\_NOTICE},\textcolor{stringliteral}{"+slave"},slave,\textcolor{stringliteral}{"%@"});
02055                     sentinelFlushConfig();
02056                 \}
02057             \}
02058         \}
02059 
02060         \textcolor{comment}{/* master\_link\_down\_since\_seconds:<seconds> */}
02061         \textcolor{keywordflow}{if} (sdslen(l) >= 32 &&
02062             !memcmp(l,\textcolor{stringliteral}{"master\_link\_down\_since\_seconds"},30))
02063         \{
02064             ri->master\_link\_down\_time = strtoll(l+31,NULL,10)*1000;
02065         \}
02066 
02067         \textcolor{comment}{/* role:<role> */}
02068         \textcolor{keywordflow}{if} (!memcmp(l,\textcolor{stringliteral}{"role:master"},11)) role = \hyperlink{sentinel_8c_a2ee83e5ff67b45746cd6a310f15334b2}{SRI\_MASTER};
02069         \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!memcmp(l,\textcolor{stringliteral}{"role:slave"},10)) role = \hyperlink{sentinel_8c_a4b9db21eda79d49bd9fdf2cf7b3178e8}{SRI\_SLAVE};
02070 
02071         \textcolor{keywordflow}{if} (role == \hyperlink{sentinel_8c_a4b9db21eda79d49bd9fdf2cf7b3178e8}{SRI\_SLAVE}) \{
02072             \textcolor{comment}{/* master\_host:<host> */}
02073             \textcolor{keywordflow}{if} (sdslen(l) >= 12 && !memcmp(l,\textcolor{stringliteral}{"master\_host:"},12)) \{
02074                 \textcolor{keywordflow}{if} (ri->slave\_master\_host == NULL ||
02075                     strcasecmp(l+12,ri->slave\_master\_host))
02076                 \{
02077                     sdsfree(ri->slave\_master\_host);
02078                     ri->slave\_master\_host = sdsnew(l+12);
02079                     ri->slave\_conf\_change\_time = mstime();
02080                 \}
02081             \}
02082 
02083             \textcolor{comment}{/* master\_port:<port> */}
02084             \textcolor{keywordflow}{if} (sdslen(l) >= 12 && !memcmp(l,\textcolor{stringliteral}{"master\_port:"},12)) \{
02085                 \textcolor{keywordtype}{int} slave\_master\_port = atoi(l+12);
02086 
02087                 \textcolor{keywordflow}{if} (ri->slave\_master\_port != slave\_master\_port) \{
02088                     ri->slave\_master\_port = slave\_master\_port;
02089                     ri->slave\_conf\_change\_time = mstime();
02090                 \}
02091             \}
02092 
02093             \textcolor{comment}{/* master\_link\_status:<status> */}
02094             \textcolor{keywordflow}{if} (sdslen(l) >= 19 && !memcmp(l,\textcolor{stringliteral}{"master\_link\_status:"},19)) \{
02095                 ri->slave\_master\_link\_status =
02096                     (strcasecmp(l+19,\textcolor{stringliteral}{"up"}) == 0) ?
02097                     \hyperlink{sentinel_8c_a8dc7f6cce8e6299e2422b8c65ca16418}{SENTINEL\_MASTER\_LINK\_STATUS\_UP} :
02098                     \hyperlink{sentinel_8c_af4e90431bc568a5b3be300ecebc064d6}{SENTINEL\_MASTER\_LINK\_STATUS\_DOWN};
02099             \}
02100 
02101             \textcolor{comment}{/* slave\_priority:<priority> */}
02102             \textcolor{keywordflow}{if} (sdslen(l) >= 15 && !memcmp(l,\textcolor{stringliteral}{"slave\_priority:"},15))
02103                 ri->slave\_priority = atoi(l+15);
02104 
02105             \textcolor{comment}{/* slave\_repl\_offset:<offset> */}
02106             \textcolor{keywordflow}{if} (sdslen(l) >= 18 && !memcmp(l,\textcolor{stringliteral}{"slave\_repl\_offset:"},18))
02107                 ri->slave\_repl\_offset = strtoull(l+18,NULL,10);
02108         \}
02109     \}
02110     ri->info\_refresh = mstime();
02111     sdsfreesplitres(lines,numlines);
02112 
02113     \textcolor{comment}{/* ---------------------------- Acting half -----------------------------}
02114 \textcolor{comment}{     * Some things will not happen if sentinel.tilt is true, but some will}
02115 \textcolor{comment}{     * still be processed. */}
02116 
02117     \textcolor{comment}{/* Remember when the role changed. */}
02118     \textcolor{keywordflow}{if} (role != ri->role\_reported) \{
02119         ri->role\_reported\_time = mstime();
02120         ri->role\_reported = role;
02121         \textcolor{keywordflow}{if} (role == \hyperlink{sentinel_8c_a4b9db21eda79d49bd9fdf2cf7b3178e8}{SRI\_SLAVE}) ri->slave\_conf\_change\_time = mstime();
02122         \textcolor{comment}{/* Log the event with +role-change if the new role is coherent or}
02123 \textcolor{comment}{         * with -role-change if there is a mismatch with the current config. */}
02124         sentinelEvent(\hyperlink{server_8h_a479b60032f8da6d8ad72e1a9d0809950}{LL\_VERBOSE},
02125             ((ri->flags & (\hyperlink{sentinel_8c_a2ee83e5ff67b45746cd6a310f15334b2}{SRI\_MASTER}|\hyperlink{sentinel_8c_a4b9db21eda79d49bd9fdf2cf7b3178e8}{SRI\_SLAVE})) == role) ?
02126             \textcolor{stringliteral}{"+role-change"} : \textcolor{stringliteral}{"-role-change"},
02127             ri, \textcolor{stringliteral}{"%@ new reported role is %s"},
02128             role == \hyperlink{sentinel_8c_a2ee83e5ff67b45746cd6a310f15334b2}{SRI\_MASTER} ? \textcolor{stringliteral}{"master"} : \textcolor{stringliteral}{"slave"},
02129             ri->flags & \hyperlink{sentinel_8c_a2ee83e5ff67b45746cd6a310f15334b2}{SRI\_MASTER} ? \textcolor{stringliteral}{"master"} : \textcolor{stringliteral}{"slave"});
02130     \}
02131 
02132     \textcolor{comment}{/* None of the following conditions are processed when in tilt mode, so}
02133 \textcolor{comment}{     * return asap. */}
02134     \textcolor{keywordflow}{if} (sentinel.tilt) \textcolor{keywordflow}{return};
02135 
02136     \textcolor{comment}{/* Handle master -> slave role switch. */}
02137     \textcolor{keywordflow}{if} ((ri->flags & \hyperlink{sentinel_8c_a2ee83e5ff67b45746cd6a310f15334b2}{SRI\_MASTER}) && role == \hyperlink{sentinel_8c_a4b9db21eda79d49bd9fdf2cf7b3178e8}{SRI\_SLAVE}) \{
02138         \textcolor{comment}{/* Nothing to do, but masters claiming to be slaves are}
02139 \textcolor{comment}{         * considered to be unreachable by Sentinel, so eventually}
02140 \textcolor{comment}{         * a failover will be triggered. */}
02141     \}
02142 
02143     \textcolor{comment}{/* Handle slave -> master role switch. */}
02144     \textcolor{keywordflow}{if} ((ri->flags & \hyperlink{sentinel_8c_a4b9db21eda79d49bd9fdf2cf7b3178e8}{SRI\_SLAVE}) && role == \hyperlink{sentinel_8c_a2ee83e5ff67b45746cd6a310f15334b2}{SRI\_MASTER}) \{
02145         \textcolor{comment}{/* If this is a promoted slave we can change state to the}
02146 \textcolor{comment}{         * failover state machine. */}
02147         \textcolor{keywordflow}{if} ((ri->flags & \hyperlink{sentinel_8c_a6c6c019b1af48a9c0e9507422051c684}{SRI\_PROMOTED}) &&
02148             (ri->master->flags & \hyperlink{sentinel_8c_a0546b63633196f09fcd90957243b0798}{SRI\_FAILOVER\_IN\_PROGRESS}) &&
02149             (ri->master->failover\_state ==
02150                 \hyperlink{sentinel_8c_a49d9c64c03e76dcbf7728ad64dd99330}{SENTINEL\_FAILOVER\_STATE\_WAIT\_PROMOTION}))
02151         \{
02152             \textcolor{comment}{/* Now that we are sure the slave was reconfigured as a master}
02153 \textcolor{comment}{             * set the master configuration epoch to the epoch we won the}
02154 \textcolor{comment}{             * election to perform this failover. This will force the other}
02155 \textcolor{comment}{             * Sentinels to update their config (assuming there is not}
02156 \textcolor{comment}{             * a newer one already available). */}
02157             ri->master->config\_epoch = ri->master->failover\_epoch;
02158             ri->master->failover\_state = 
      \hyperlink{sentinel_8c_a05b020edfa71eb4d24288e79637b57f5}{SENTINEL\_FAILOVER\_STATE\_RECONF\_SLAVES};
02159             ri->master->failover\_state\_change\_time = mstime();
02160             sentinelFlushConfig();
02161             sentinelEvent(\hyperlink{server_8h_a31229b9334bba7d6be2a72970967a14b}{LL\_WARNING},\textcolor{stringliteral}{"+promoted-slave"},ri,\textcolor{stringliteral}{"%@"});
02162             \textcolor{keywordflow}{if} (sentinel.simfailure\_flags &
02163                 \hyperlink{sentinel_8c_a87a09f4dcf854cc0b26dc8dc328ab7c3}{SENTINEL\_SIMFAILURE\_CRASH\_AFTER\_PROMOTION})
02164                 sentinelSimFailureCrash();
02165             sentinelEvent(\hyperlink{server_8h_a31229b9334bba7d6be2a72970967a14b}{LL\_WARNING},\textcolor{stringliteral}{"+failover-state-reconf-slaves"},
02166                 ri->master,\textcolor{stringliteral}{"%@"});
02167             sentinelCallClientReconfScript(ri->master,\hyperlink{sentinel_8c_a896cefcd7c6cbd3467b2387ec944fffd}{SENTINEL\_LEADER},
02168                 \textcolor{stringliteral}{"start"},ri->master->addr,ri->addr);
02169             sentinelForceHelloUpdateForMaster(ri->master);
02170         \} \textcolor{keywordflow}{else} \{
02171             \textcolor{comment}{/* A slave turned into a master. We want to force our view and}
02172 \textcolor{comment}{             * reconfigure as slave. Wait some time after the change before}
02173 \textcolor{comment}{             * going forward, to receive new configs if any. */}
02174             mstime\_t wait\_time = \hyperlink{sentinel_8c_a062c8bab2521f90dac2df11cf77c3bf0}{SENTINEL\_PUBLISH\_PERIOD}*4;
02175 
02176             \textcolor{keywordflow}{if} (!(ri->flags & \hyperlink{sentinel_8c_a6c6c019b1af48a9c0e9507422051c684}{SRI\_PROMOTED}) &&
02177                  sentinelMasterLooksSane(ri->master) &&
02178                  sentinelRedisInstanceNoDownFor(ri,wait\_time) &&
02179                  mstime() - ri->role\_reported\_time > wait\_time)
02180             \{
02181                 \textcolor{keywordtype}{int} retval = sentinelSendSlaveOf(ri,
02182                         ri->master->addr->ip,
02183                         ri->master->addr->port);
02184                 \textcolor{keywordflow}{if} (retval == \hyperlink{server_8h_a303769ef1065076e68731584e758d3e1}{C\_OK})
02185                     sentinelEvent(\hyperlink{server_8h_a8c54c191e436c7dd3012167212692401}{LL\_NOTICE},\textcolor{stringliteral}{"+convert-to-slave"},ri,\textcolor{stringliteral}{"%@"});
02186             \}
02187         \}
02188     \}
02189 
02190     \textcolor{comment}{/* Handle slaves replicating to a different master address. */}
02191     \textcolor{keywordflow}{if} ((ri->flags & \hyperlink{sentinel_8c_a4b9db21eda79d49bd9fdf2cf7b3178e8}{SRI\_SLAVE}) &&
02192         role == \hyperlink{sentinel_8c_a4b9db21eda79d49bd9fdf2cf7b3178e8}{SRI\_SLAVE} &&
02193         (ri->slave\_master\_port != ri->master->addr->port ||
02194          strcasecmp(ri->slave\_master\_host,ri->master->addr->ip)))
02195     \{
02196         mstime\_t wait\_time = ri->master->failover\_timeout;
02197 
02198         \textcolor{comment}{/* Make sure the master is sane before reconfiguring this instance}
02199 \textcolor{comment}{         * into a slave. */}
02200         \textcolor{keywordflow}{if} (sentinelMasterLooksSane(ri->master) &&
02201             sentinelRedisInstanceNoDownFor(ri,wait\_time) &&
02202             mstime() - ri->slave\_conf\_change\_time > wait\_time)
02203         \{
02204             \textcolor{keywordtype}{int} retval = sentinelSendSlaveOf(ri,
02205                     ri->master->addr->ip,
02206                     ri->master->addr->port);
02207             \textcolor{keywordflow}{if} (retval == \hyperlink{server_8h_a303769ef1065076e68731584e758d3e1}{C\_OK})
02208                 sentinelEvent(\hyperlink{server_8h_a8c54c191e436c7dd3012167212692401}{LL\_NOTICE},\textcolor{stringliteral}{"+fix-slave-config"},ri,\textcolor{stringliteral}{"%@"});
02209         \}
02210     \}
02211 
02212     \textcolor{comment}{/* Detect if the slave that is in the process of being reconfigured}
02213 \textcolor{comment}{     * changed state. */}
02214     \textcolor{keywordflow}{if} ((ri->flags & \hyperlink{sentinel_8c_a4b9db21eda79d49bd9fdf2cf7b3178e8}{SRI\_SLAVE}) && role == \hyperlink{sentinel_8c_a4b9db21eda79d49bd9fdf2cf7b3178e8}{SRI\_SLAVE} &&
02215         (ri->flags & (\hyperlink{sentinel_8c_a9b307b68cb1615ead6aacb0de34910e6}{SRI\_RECONF\_SENT}|\hyperlink{sentinel_8c_a58c89f4aaa1bdfde4c25e3bb476c35aa}{SRI\_RECONF\_INPROG})))
02216     \{
02217         \textcolor{comment}{/* SRI\_RECONF\_SENT -> SRI\_RECONF\_INPROG. */}
02218         \textcolor{keywordflow}{if} ((ri->flags & \hyperlink{sentinel_8c_a9b307b68cb1615ead6aacb0de34910e6}{SRI\_RECONF\_SENT}) &&
02219             ri->slave\_master\_host &&
02220             strcmp(ri->slave\_master\_host,
02221                     ri->master->promoted\_slave->addr->ip) == 0 &&
02222             ri->slave\_master\_port == ri->master->promoted\_slave->addr->port)
02223         \{
02224             ri->flags &= ~\hyperlink{sentinel_8c_a9b307b68cb1615ead6aacb0de34910e6}{SRI\_RECONF\_SENT};
02225             ri->flags |= \hyperlink{sentinel_8c_a58c89f4aaa1bdfde4c25e3bb476c35aa}{SRI\_RECONF\_INPROG};
02226             sentinelEvent(\hyperlink{server_8h_a8c54c191e436c7dd3012167212692401}{LL\_NOTICE},\textcolor{stringliteral}{"+slave-reconf-inprog"},ri,\textcolor{stringliteral}{"%@"});
02227         \}
02228 
02229         \textcolor{comment}{/* SRI\_RECONF\_INPROG -> SRI\_RECONF\_DONE */}
02230         \textcolor{keywordflow}{if} ((ri->flags & \hyperlink{sentinel_8c_a58c89f4aaa1bdfde4c25e3bb476c35aa}{SRI\_RECONF\_INPROG}) &&
02231             ri->slave\_master\_link\_status == \hyperlink{sentinel_8c_a8dc7f6cce8e6299e2422b8c65ca16418}{SENTINEL\_MASTER\_LINK\_STATUS\_UP}
      )
02232         \{
02233             ri->flags &= ~\hyperlink{sentinel_8c_a58c89f4aaa1bdfde4c25e3bb476c35aa}{SRI\_RECONF\_INPROG};
02234             ri->flags |= \hyperlink{sentinel_8c_adb468d0a8c96c954b6af26aa670d7a11}{SRI\_RECONF\_DONE};
02235             sentinelEvent(\hyperlink{server_8h_a8c54c191e436c7dd3012167212692401}{LL\_NOTICE},\textcolor{stringliteral}{"+slave-reconf-done"},ri,\textcolor{stringliteral}{"%@"});
02236         \}
02237     \}
02238 \}
02239 
02240 \textcolor{keywordtype}{void} sentinelInfoReplyCallback(redisAsyncContext *c, \textcolor{keywordtype}{void} *reply, \textcolor{keywordtype}{void} *privdata) \{
02241     sentinelRedisInstance *ri = privdata;
02242     \hyperlink{structinstanceLink}{instanceLink} *link = c->data;
02243     redisReply *r;
02244 
02245     \textcolor{keywordflow}{if} (!reply || !link) \textcolor{keywordflow}{return};
02246     link->pending\_commands--;
02247     r = reply;
02248 
02249     \textcolor{keywordflow}{if} (r->type == REDIS\_REPLY\_STRING)
02250         sentinelRefreshInstanceInfo(ri,r->str);
02251 \}
02252 
02253 \textcolor{comment}{/* Just discard the reply. We use this when we are not monitoring the return}
02254 \textcolor{comment}{ * value of the command but its effects directly. */}
02255 \textcolor{keywordtype}{void} sentinelDiscardReplyCallback(redisAsyncContext *c, \textcolor{keywordtype}{void} *reply, \textcolor{keywordtype}{void} *privdata) \{
02256     \hyperlink{structinstanceLink}{instanceLink} *link = c->data;
02257     \hyperlink{server_8h_ae7c9dc8f13568a9c856573751f1ee1ec}{UNUSED}(reply);
02258     \hyperlink{server_8h_ae7c9dc8f13568a9c856573751f1ee1ec}{UNUSED}(privdata);
02259 
02260     \textcolor{keywordflow}{if} (link) link->pending\_commands--;
02261 \}
02262 
02263 \textcolor{keywordtype}{void} sentinelPingReplyCallback(redisAsyncContext *c, \textcolor{keywordtype}{void} *reply, \textcolor{keywordtype}{void} *privdata) \{
02264     sentinelRedisInstance *ri = privdata;
02265     \hyperlink{structinstanceLink}{instanceLink} *link = c->data;
02266     redisReply *r;
02267 
02268     \textcolor{keywordflow}{if} (!reply || !link) \textcolor{keywordflow}{return};
02269     link->pending\_commands--;
02270     r = reply;
02271 
02272     \textcolor{keywordflow}{if} (r->type == REDIS\_REPLY\_STATUS ||
02273         r->type == REDIS\_REPLY\_ERROR) \{
02274         \textcolor{comment}{/* Update the "instance available" field only if this is an}
02275 \textcolor{comment}{         * acceptable reply. */}
02276         \textcolor{keywordflow}{if} (strncmp(r->str,\textcolor{stringliteral}{"PONG"},4) == 0 ||
02277             strncmp(r->str,\textcolor{stringliteral}{"LOADING"},7) == 0 ||
02278             strncmp(r->str,\textcolor{stringliteral}{"MASTERDOWN"},10) == 0)
02279         \{
02280             link->last\_avail\_time = mstime();
02281             link->act\_ping\_time = 0; \textcolor{comment}{/* Flag the pong as received. */}
02282         \} \textcolor{keywordflow}{else} \{
02283             \textcolor{comment}{/* Send a SCRIPT KILL command if the instance appears to be}
02284 \textcolor{comment}{             * down because of a busy script. */}
02285             \textcolor{keywordflow}{if} (strncmp(r->str,\textcolor{stringliteral}{"BUSY"},4) == 0 &&
02286                 (ri->flags & \hyperlink{sentinel_8c_a8e26596c8bde451c2dd9cecb2c3046d4}{SRI\_S\_DOWN}) &&
02287                 !(ri->flags & \hyperlink{sentinel_8c_a8deaaf376eb76dcf5ab4ca652df3a52b}{SRI\_SCRIPT\_KILL\_SENT}))
02288             \{
02289                 \textcolor{keywordflow}{if} (redisAsyncCommand(ri->link->cc,
02290                         sentinelDiscardReplyCallback, ri,
02291                         \textcolor{stringliteral}{"SCRIPT KILL"}) == \hyperlink{server_8h_a303769ef1065076e68731584e758d3e1}{C\_OK})
02292                     ri->link->pending\_commands++;
02293                 ri->flags |= \hyperlink{sentinel_8c_a8deaaf376eb76dcf5ab4ca652df3a52b}{SRI\_SCRIPT\_KILL\_SENT};
02294             \}
02295         \}
02296     \}
02297     link->last\_pong\_time = mstime();
02298 \}
02299 
02300 \textcolor{comment}{/* This is called when we get the reply about the PUBLISH command we send}
02301 \textcolor{comment}{ * to the master to advertise this sentinel. */}
02302 \textcolor{keywordtype}{void} sentinelPublishReplyCallback(redisAsyncContext *c, \textcolor{keywordtype}{void} *reply, \textcolor{keywordtype}{void} *privdata) \{
02303     sentinelRedisInstance *ri = privdata;
02304     \hyperlink{structinstanceLink}{instanceLink} *link = c->data;
02305     redisReply *r;
02306 
02307     \textcolor{keywordflow}{if} (!reply || !link) \textcolor{keywordflow}{return};
02308     link->pending\_commands--;
02309     r = reply;
02310 
02311     \textcolor{comment}{/* Only update pub\_time if we actually published our message. Otherwise}
02312 \textcolor{comment}{     * we'll retry again in 100 milliseconds. */}
02313     \textcolor{keywordflow}{if} (r->type != REDIS\_REPLY\_ERROR)
02314         ri->last\_pub\_time = mstime();
02315 \}
02316 
02317 \textcolor{comment}{/* Process an hello message received via Pub/Sub in master or slave instance,}
02318 \textcolor{comment}{ * or sent directly to this sentinel via the (fake) PUBLISH command of Sentinel.}
02319 \textcolor{comment}{ *}
02320 \textcolor{comment}{ * If the master name specified in the message is not known, the message is}
02321 \textcolor{comment}{ * discarded. */}
02322 \textcolor{keywordtype}{void} sentinelProcessHelloMessage(\textcolor{keywordtype}{char} *hello, \textcolor{keywordtype}{int} hello\_len) \{
02323     \textcolor{comment}{/* Format is composed of 8 tokens:}
02324 \textcolor{comment}{     * 0=ip,1=port,2=runid,3=current\_epoch,4=master\_name,}
02325 \textcolor{comment}{     * 5=master\_ip,6=master\_port,7=master\_config\_epoch. */}
02326     \textcolor{keywordtype}{int} numtokens, port, removed, master\_port;
02327     uint64\_t current\_epoch, master\_config\_epoch;
02328     \textcolor{keywordtype}{char} **token = sdssplitlen(hello, hello\_len, \textcolor{stringliteral}{","}, 1, &numtokens);
02329     sentinelRedisInstance *si, *master;
02330 
02331     \textcolor{keywordflow}{if} (numtokens == 8) \{
02332         \textcolor{comment}{/* Obtain a reference to the master this hello message is about */}
02333         master = sentinelGetMasterByName(token[4]);
02334         \textcolor{keywordflow}{if} (!master) \textcolor{keywordflow}{goto} cleanup; \textcolor{comment}{/* Unknown master, skip the message. */}
02335 
02336         \textcolor{comment}{/* First, try to see if we already have this sentinel. */}
02337         port = atoi(token[1]);
02338         master\_port = atoi(token[6]);
02339         si = getSentinelRedisInstanceByAddrAndRunID(
02340                         master->sentinels,token[0],port,token[2]);
02341         current\_epoch = strtoull(token[3],NULL,10);
02342         master\_config\_epoch = strtoull(token[7],NULL,10);
02343 
02344         \textcolor{keywordflow}{if} (!si) \{
02345             \textcolor{comment}{/* If not, remove all the sentinels that have the same runid}
02346 \textcolor{comment}{             * because there was an address change, and add the same Sentinel}
02347 \textcolor{comment}{             * with the new address back. */}
02348             removed = removeMatchingSentinelFromMaster(master,token[2]);
02349             \textcolor{keywordflow}{if} (removed) \{
02350                 sentinelEvent(\hyperlink{server_8h_a8c54c191e436c7dd3012167212692401}{LL\_NOTICE},\textcolor{stringliteral}{"+sentinel-address-switch"},master,
02351                     \textcolor{stringliteral}{"%@ ip %s port %d for %s"}, token[0],port,token[2]);
02352             \} \textcolor{keywordflow}{else} \{
02353                 \textcolor{comment}{/* Check if there is another Sentinel with the same address this}
02354 \textcolor{comment}{                 * new one is reporting. What we do if this happens is to set its}
02355 \textcolor{comment}{                 * port to 0, to signal the address is invalid. We'll update it}
02356 \textcolor{comment}{                 * later if we get an HELLO message. */}
02357                 sentinelRedisInstance *other =
02358                     getSentinelRedisInstanceByAddrAndRunID(
02359                         master->sentinels, token[0],port,NULL);
02360                 \textcolor{keywordflow}{if} (other) \{
02361                     sentinelEvent(\hyperlink{server_8h_a8c54c191e436c7dd3012167212692401}{LL\_NOTICE},\textcolor{stringliteral}{"+sentinel-invalid-addr"},other,\textcolor{stringliteral}{"%@"});
02362                     other->addr->port = 0; \textcolor{comment}{/* It means: invalid address. */}
02363                     sentinelUpdateSentinelAddressInAllMasters(other);
02364                 \}
02365             \}
02366 
02367             \textcolor{comment}{/* Add the new sentinel. */}
02368             si = createSentinelRedisInstance(token[2],\hyperlink{sentinel_8c_a8ed55207b2af5d2dd314c951ef253f64}{SRI\_SENTINEL},
02369                             token[0],port,master->quorum,master);
02370 
02371             \textcolor{keywordflow}{if} (si) \{
02372                 \textcolor{keywordflow}{if} (!removed) sentinelEvent(\hyperlink{server_8h_a8c54c191e436c7dd3012167212692401}{LL\_NOTICE},\textcolor{stringliteral}{"+sentinel"},si,\textcolor{stringliteral}{"%@"});
02373                 \textcolor{comment}{/* The runid is NULL after a new instance creation and}
02374 \textcolor{comment}{                 * for Sentinels we don't have a later chance to fill it,}
02375 \textcolor{comment}{                 * so do it now. */}
02376                 si->runid = sdsnew(token[2]);
02377                 sentinelTryConnectionSharing(si);
02378                 \textcolor{keywordflow}{if} (removed) sentinelUpdateSentinelAddressInAllMasters(si);
02379                 sentinelFlushConfig();
02380             \}
02381         \}
02382 
02383         \textcolor{comment}{/* Update local current\_epoch if received current\_epoch is greater.*/}
02384         \textcolor{keywordflow}{if} (current\_epoch > sentinel.current\_epoch) \{
02385             sentinel.current\_epoch = current\_epoch;
02386             sentinelFlushConfig();
02387             sentinelEvent(\hyperlink{server_8h_a31229b9334bba7d6be2a72970967a14b}{LL\_WARNING},\textcolor{stringliteral}{"+new-epoch"},master,\textcolor{stringliteral}{"%llu"},
02388                 (\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{long} \textcolor{keywordtype}{long}) sentinel.current\_epoch);
02389         \}
02390 
02391         \textcolor{comment}{/* Update master info if received configuration is newer. */}
02392         \textcolor{keywordflow}{if} (si && master->config\_epoch < master\_config\_epoch) \{
02393             master->config\_epoch = master\_config\_epoch;
02394             \textcolor{keywordflow}{if} (master\_port != master->addr->port ||
02395                 strcmp(master->addr->ip, token[5]))
02396             \{
02397                 sentinelAddr *old\_addr;
02398 
02399                 sentinelEvent(\hyperlink{server_8h_a31229b9334bba7d6be2a72970967a14b}{LL\_WARNING},\textcolor{stringliteral}{"+config-update-from"},si,\textcolor{stringliteral}{"%@"});
02400                 sentinelEvent(\hyperlink{server_8h_a31229b9334bba7d6be2a72970967a14b}{LL\_WARNING},\textcolor{stringliteral}{"+switch-master"},
02401                     master,\textcolor{stringliteral}{"%s %s %d %s %d"},
02402                     master->name,
02403                     master->addr->ip, master->addr->port,
02404                     token[5], master\_port);
02405 
02406                 old\_addr = dupSentinelAddr(master->addr);
02407                 sentinelResetMasterAndChangeAddress(master, token[5], master\_port);
02408                 sentinelCallClientReconfScript(master,
02409                     \hyperlink{sentinel_8c_a762f7fd932aed99946bfca7456027296}{SENTINEL\_OBSERVER},\textcolor{stringliteral}{"start"},
02410                     old\_addr,master->addr);
02411                 releaseSentinelAddr(old\_addr);
02412             \}
02413         \}
02414 
02415         \textcolor{comment}{/* Update the state of the Sentinel. */}
02416         \textcolor{keywordflow}{if} (si) si->last\_hello\_time = mstime();
02417     \}
02418 
02419 cleanup:
02420     sdsfreesplitres(token,numtokens);
02421 \}
02422 
02423 
02424 \textcolor{comment}{/* This is our Pub/Sub callback for the Hello channel. It's useful in order}
02425 \textcolor{comment}{ * to discover other sentinels attached at the same master. */}
02426 \textcolor{keywordtype}{void} sentinelReceiveHelloMessages(redisAsyncContext *c, \textcolor{keywordtype}{void} *reply, \textcolor{keywordtype}{void} *privdata) \{
02427     sentinelRedisInstance *ri = privdata;
02428     redisReply *r;
02429     \hyperlink{server_8h_ae7c9dc8f13568a9c856573751f1ee1ec}{UNUSED}(c);
02430 
02431     \textcolor{keywordflow}{if} (!reply || !ri) \textcolor{keywordflow}{return};
02432     r = reply;
02433 
02434     \textcolor{comment}{/* Update the last activity in the pubsub channel. Note that since we}
02435 \textcolor{comment}{     * receive our messages as well this timestamp can be used to detect}
02436 \textcolor{comment}{     * if the link is probably disconnected even if it seems otherwise. */}
02437     ri->link->pc\_last\_activity = mstime();
02438 
02439     \textcolor{comment}{/* Sanity check in the reply we expect, so that the code that follows}
02440 \textcolor{comment}{     * can avoid to check for details. */}
02441     \textcolor{keywordflow}{if} (r->type != REDIS\_REPLY\_ARRAY ||
02442         r->elements != 3 ||
02443         r->element[0]->type != REDIS\_REPLY\_STRING ||
02444         r->element[1]->type != REDIS\_REPLY\_STRING ||
02445         r->element[2]->type != REDIS\_REPLY\_STRING ||
02446         strcmp(r->element[0]->str,\textcolor{stringliteral}{"message"}) != 0) \textcolor{keywordflow}{return};
02447 
02448     \textcolor{comment}{/* We are not interested in meeting ourselves */}
02449     \textcolor{keywordflow}{if} (strstr(r->element[2]->str,sentinel.myid) != NULL) \textcolor{keywordflow}{return};
02450 
02451     sentinelProcessHelloMessage(r->element[2]->str, r->element[2]->len);
02452 \}
02453 
02454 \textcolor{comment}{/* Send an "Hello" message via Pub/Sub to the specified 'ri' Redis}
02455 \textcolor{comment}{ * instance in order to broadcast the current configuraiton for this}
02456 \textcolor{comment}{ * master, and to advertise the existence of this Sentinel at the same time.}
02457 \textcolor{comment}{ *}
02458 \textcolor{comment}{ * The message has the following format:}
02459 \textcolor{comment}{ *}
02460 \textcolor{comment}{ * sentinel\_ip,sentinel\_port,sentinel\_runid,current\_epoch,}
02461 \textcolor{comment}{ * master\_name,master\_ip,master\_port,master\_config\_epoch.}
02462 \textcolor{comment}{ *}
02463 \textcolor{comment}{ * Returns C\_OK if the PUBLISH was queued correctly, otherwise}
02464 \textcolor{comment}{ * C\_ERR is returned. */}
02465 \textcolor{keywordtype}{int} sentinelSendHello(sentinelRedisInstance *ri) \{
02466     \textcolor{keywordtype}{char} ip[\hyperlink{server_8h_ad97c5405ed22a94e9fcc10fba577d6c0}{NET\_IP\_STR\_LEN}];
02467     \textcolor{keywordtype}{char} payload[\hyperlink{server_8h_ad97c5405ed22a94e9fcc10fba577d6c0}{NET\_IP\_STR\_LEN}+1024];
02468     \textcolor{keywordtype}{int} retval;
02469     \textcolor{keywordtype}{char} *announce\_ip;
02470     \textcolor{keywordtype}{int} announce\_port;
02471     sentinelRedisInstance *master = (ri->flags & \hyperlink{sentinel_8c_a2ee83e5ff67b45746cd6a310f15334b2}{SRI\_MASTER}) ? ri : ri->master;
02472     sentinelAddr *master\_addr = sentinelGetCurrentMasterAddress(master);
02473 
02474     \textcolor{keywordflow}{if} (ri->link->disconnected) \textcolor{keywordflow}{return} \hyperlink{server_8h_af98ac28d5f4d23d7ed5985188e6fb7d1}{C\_ERR};
02475 
02476     \textcolor{comment}{/* Use the specified announce address if specified, otherwise try to}
02477 \textcolor{comment}{     * obtain our own IP address. */}
02478     \textcolor{keywordflow}{if} (sentinel.announce\_ip) \{
02479         announce\_ip = sentinel.announce\_ip;
02480     \} \textcolor{keywordflow}{else} \{
02481         \textcolor{keywordflow}{if} (anetSockName(ri->link->cc->c.fd,ip,\textcolor{keyword}{sizeof}(ip),NULL) == -1)
02482             \textcolor{keywordflow}{return} \hyperlink{server_8h_af98ac28d5f4d23d7ed5985188e6fb7d1}{C\_ERR};
02483         announce\_ip = ip;
02484     \}
02485     announce\_port = sentinel.announce\_port ?
02486                     sentinel.announce\_port : server.port;
02487 
02488     \textcolor{comment}{/* Format and send the Hello message. */}
02489     snprintf(payload,\textcolor{keyword}{sizeof}(payload),
02490         \textcolor{stringliteral}{"%s,%d,%s,%llu,"} \textcolor{comment}{/* Info about this sentinel. */}
02491         \textcolor{stringliteral}{"%s,%s,%d,%llu"}, \textcolor{comment}{/* Info about current master. */}
02492         announce\_ip, announce\_port, sentinel.myid,
02493         (\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{long} \textcolor{keywordtype}{long}) sentinel.current\_epoch,
02494         \textcolor{comment}{/* --- */}
02495         master->name,master\_addr->ip,master\_addr->port,
02496         (\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{long} \textcolor{keywordtype}{long}) master->config\_epoch);
02497     retval = redisAsyncCommand(ri->link->cc,
02498         sentinelPublishReplyCallback, ri, \textcolor{stringliteral}{"PUBLISH %s %s"},
02499             \hyperlink{sentinel_8c_aa57e3638aae4eec03d29f247b1611569}{SENTINEL\_HELLO\_CHANNEL},payload);
02500     \textcolor{keywordflow}{if} (retval != \hyperlink{server_8h_a303769ef1065076e68731584e758d3e1}{C\_OK}) \textcolor{keywordflow}{return} \hyperlink{server_8h_af98ac28d5f4d23d7ed5985188e6fb7d1}{C\_ERR};
02501     ri->link->pending\_commands++;
02502     \textcolor{keywordflow}{return} \hyperlink{server_8h_a303769ef1065076e68731584e758d3e1}{C\_OK};
02503 \}
02504 
02505 \textcolor{comment}{/* Reset last\_pub\_time in all the instances in the specified dictionary}
02506 \textcolor{comment}{ * in order to force the delivery of an Hello update ASAP. */}
02507 \textcolor{keywordtype}{void} sentinelForceHelloUpdateDictOfRedisInstances(dict *instances) \{
02508     dictIterator *di;
02509     dictEntry *de;
02510 
02511     di = dictGetSafeIterator(instances);
02512     \textcolor{keywordflow}{while}((de = dictNext(di)) != NULL) \{
02513         sentinelRedisInstance *ri = \hyperlink{dict_8h_ae8d2cc391873b2bea2b87c4f80f43120}{dictGetVal}(de);
02514         \textcolor{keywordflow}{if} (ri->last\_pub\_time >= (\hyperlink{sentinel_8c_a062c8bab2521f90dac2df11cf77c3bf0}{SENTINEL\_PUBLISH\_PERIOD}+1))
02515             ri->last\_pub\_time -= (\hyperlink{sentinel_8c_a062c8bab2521f90dac2df11cf77c3bf0}{SENTINEL\_PUBLISH\_PERIOD}+1);
02516     \}
02517     dictReleaseIterator(di);
02518 \}
02519 
02520 \textcolor{comment}{/* This function forces the delivery of an "Hello" message (see}
02521 \textcolor{comment}{ * sentinelSendHello() top comment for further information) to all the Redis}
02522 \textcolor{comment}{ * and Sentinel instances related to the specified 'master'.}
02523 \textcolor{comment}{ *}
02524 \textcolor{comment}{ * It is technically not needed since we send an update to every instance}
02525 \textcolor{comment}{ * with a period of SENTINEL\_PUBLISH\_PERIOD milliseconds, however when a}
02526 \textcolor{comment}{ * Sentinel upgrades a configuration it is a good idea to deliever an update}
02527 \textcolor{comment}{ * to the other Sentinels ASAP. */}
02528 \textcolor{keywordtype}{int} sentinelForceHelloUpdateForMaster(sentinelRedisInstance *master) \{
02529     \textcolor{keywordflow}{if} (!(master->flags & \hyperlink{sentinel_8c_a2ee83e5ff67b45746cd6a310f15334b2}{SRI\_MASTER})) \textcolor{keywordflow}{return} \hyperlink{server_8h_af98ac28d5f4d23d7ed5985188e6fb7d1}{C\_ERR};
02530     \textcolor{keywordflow}{if} (master->last\_pub\_time >= (\hyperlink{sentinel_8c_a062c8bab2521f90dac2df11cf77c3bf0}{SENTINEL\_PUBLISH\_PERIOD}+1))
02531         master->last\_pub\_time -= (\hyperlink{sentinel_8c_a062c8bab2521f90dac2df11cf77c3bf0}{SENTINEL\_PUBLISH\_PERIOD}+1);
02532     sentinelForceHelloUpdateDictOfRedisInstances(master->sentinels);
02533     sentinelForceHelloUpdateDictOfRedisInstances(master->slaves);
02534     \textcolor{keywordflow}{return} \hyperlink{server_8h_a303769ef1065076e68731584e758d3e1}{C\_OK};
02535 \}
02536 
02537 \textcolor{comment}{/* Send a PING to the specified instance and refresh the act\_ping\_time}
02538 \textcolor{comment}{ * if it is zero (that is, if we received a pong for the previous ping).}
02539 \textcolor{comment}{ *}
02540 \textcolor{comment}{ * On error zero is returned, and we can't consider the PING command}
02541 \textcolor{comment}{ * queued in the connection. */}
02542 \textcolor{keywordtype}{int} sentinelSendPing(sentinelRedisInstance *ri) \{
02543     \textcolor{keywordtype}{int} retval = redisAsyncCommand(ri->link->cc,
02544         sentinelPingReplyCallback, ri, \textcolor{stringliteral}{"PING"});
02545     \textcolor{keywordflow}{if} (retval == \hyperlink{server_8h_a303769ef1065076e68731584e758d3e1}{C\_OK}) \{
02546         ri->link->pending\_commands++;
02547         ri->link->last\_ping\_time = mstime();
02548         \textcolor{comment}{/* We update the active ping time only if we received the pong for}
02549 \textcolor{comment}{         * the previous ping, otherwise we are technically waiting since the}
02550 \textcolor{comment}{         * first ping that did not received a reply. */}
02551         \textcolor{keywordflow}{if} (ri->link->act\_ping\_time == 0)
02552             ri->link->act\_ping\_time = ri->link->last\_ping\_time;
02553         \textcolor{keywordflow}{return} 1;
02554     \} \textcolor{keywordflow}{else} \{
02555         \textcolor{keywordflow}{return} 0;
02556     \}
02557 \}
02558 
02559 \textcolor{comment}{/* Send periodic PING, INFO, and PUBLISH to the Hello channel to}
02560 \textcolor{comment}{ * the specified master or slave instance. */}
02561 \textcolor{keywordtype}{void} sentinelSendPeriodicCommands(sentinelRedisInstance *ri) \{
02562     mstime\_t now = mstime();
02563     mstime\_t info\_period, ping\_period;
02564     \textcolor{keywordtype}{int} retval;
02565 
02566     \textcolor{comment}{/* Return ASAP if we have already a PING or INFO already pending, or}
02567 \textcolor{comment}{     * in the case the instance is not properly connected. */}
02568     \textcolor{keywordflow}{if} (ri->link->disconnected) \textcolor{keywordflow}{return};
02569 
02570     \textcolor{comment}{/* For INFO, PING, PUBLISH that are not critical commands to send we}
02571 \textcolor{comment}{     * also have a limit of SENTINEL\_MAX\_PENDING\_COMMANDS. We don't}
02572 \textcolor{comment}{     * want to use a lot of memory just because a link is not working}
02573 \textcolor{comment}{     * properly (note that anyway there is a redundant protection about this,}
02574 \textcolor{comment}{     * that is, the link will be disconnected and reconnected if a long}
02575 \textcolor{comment}{     * timeout condition is detected. */}
02576     \textcolor{keywordflow}{if} (ri->link->pending\_commands >=
02577         \hyperlink{sentinel_8c_a5555400e8b8c3a25d6a2ccc6db1cd411}{SENTINEL\_MAX\_PENDING\_COMMANDS} * ri->link->refcount) \textcolor{keywordflow}{return};
02578 
02579     \textcolor{comment}{/* If this is a slave of a master in O\_DOWN condition we start sending}
02580 \textcolor{comment}{     * it INFO every second, instead of the usual SENTINEL\_INFO\_PERIOD}
02581 \textcolor{comment}{     * period. In this state we want to closely monitor slaves in case they}
02582 \textcolor{comment}{     * are turned into masters by another Sentinel, or by the sysadmin.}
02583 \textcolor{comment}{     *}
02584 \textcolor{comment}{     * Similarly we monitor the INFO output more often if the slave reports}
02585 \textcolor{comment}{     * to be disconnected from the master, so that we can have a fresh}
02586 \textcolor{comment}{     * disconnection time figure. */}
02587     \textcolor{keywordflow}{if} ((ri->flags & \hyperlink{sentinel_8c_a4b9db21eda79d49bd9fdf2cf7b3178e8}{SRI\_SLAVE}) &&
02588         ((ri->master->flags & (\hyperlink{sentinel_8c_a3bbbca05543cd9d9f86d276e2c7c719c}{SRI\_O\_DOWN}|
      \hyperlink{sentinel_8c_a0546b63633196f09fcd90957243b0798}{SRI\_FAILOVER\_IN\_PROGRESS})) ||
02589          (ri->master\_link\_down\_time != 0)))
02590     \{
02591         info\_period = 1000;
02592     \} \textcolor{keywordflow}{else} \{
02593         info\_period = \hyperlink{sentinel_8c_ac6a2144aa06344ed8547176a4e3cfaa5}{SENTINEL\_INFO\_PERIOD};
02594     \}
02595 
02596     \textcolor{comment}{/* We ping instances every time the last received pong is older than}
02597 \textcolor{comment}{     * the configured 'down-after-milliseconds' time, but every second}
02598 \textcolor{comment}{     * anyway if 'down-after-milliseconds' is greater than 1 second. */}
02599     ping\_period = ri->down\_after\_period;
02600     \textcolor{keywordflow}{if} (ping\_period > \hyperlink{sentinel_8c_a9e22409355fa7a4db7f3a43fbe2d9101}{SENTINEL\_PING\_PERIOD}) ping\_period = 
      \hyperlink{sentinel_8c_a9e22409355fa7a4db7f3a43fbe2d9101}{SENTINEL\_PING\_PERIOD};
02601 
02602     \textcolor{keywordflow}{if} ((ri->flags & \hyperlink{sentinel_8c_a8ed55207b2af5d2dd314c951ef253f64}{SRI\_SENTINEL}) == 0 &&
02603         (ri->info\_refresh == 0 ||
02604         (now - ri->info\_refresh) > info\_period))
02605     \{
02606         \textcolor{comment}{/* Send INFO to masters and slaves, not sentinels. */}
02607         retval = redisAsyncCommand(ri->link->cc,
02608             sentinelInfoReplyCallback, ri, \textcolor{stringliteral}{"INFO"});
02609         \textcolor{keywordflow}{if} (retval == \hyperlink{server_8h_a303769ef1065076e68731584e758d3e1}{C\_OK}) ri->link->pending\_commands++;
02610     \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} ((now - ri->link->last\_pong\_time) > ping\_period &&
02611                (now - ri->link->last\_ping\_time) > ping\_period/2) \{
02612         \textcolor{comment}{/* Send PING to all the three kinds of instances. */}
02613         sentinelSendPing(ri);
02614     \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} ((now - ri->last\_pub\_time) > \hyperlink{sentinel_8c_a062c8bab2521f90dac2df11cf77c3bf0}{SENTINEL\_PUBLISH\_PERIOD}) \{
02615         \textcolor{comment}{/* PUBLISH hello messages to all the three kinds of instances. */}
02616         sentinelSendHello(ri);
02617     \}
02618 \}
02619 
02620 \textcolor{comment}{/* =========================== SENTINEL command ============================= */}
02621 
02622 \textcolor{keyword}{const} \textcolor{keywordtype}{char} *sentinelFailoverStateStr(\textcolor{keywordtype}{int} state) \{
02623     \textcolor{keywordflow}{switch}(state) \{
02624     \textcolor{keywordflow}{case} \hyperlink{sentinel_8c_a23bad5aa23e7b1a930ad4aa535938efb}{SENTINEL\_FAILOVER\_STATE\_NONE}: \textcolor{keywordflow}{return} \textcolor{stringliteral}{"none"};
02625     \textcolor{keywordflow}{case} \hyperlink{sentinel_8c_a83bf9fce7cbb7bf1b0723ced2d434366}{SENTINEL\_FAILOVER\_STATE\_WAIT\_START}: \textcolor{keywordflow}{return} \textcolor{stringliteral}{"wait\_start"};
02626     \textcolor{keywordflow}{case} \hyperlink{sentinel_8c_ab69af026a9f736ca81bfffd4eeada38f}{SENTINEL\_FAILOVER\_STATE\_SELECT\_SLAVE}: \textcolor{keywordflow}{return} \textcolor{stringliteral}{
      "select\_slave"};
02627     \textcolor{keywordflow}{case} \hyperlink{sentinel_8c_ac89d5b0fc38860b277528c7d3a854580}{SENTINEL\_FAILOVER\_STATE\_SEND\_SLAVEOF\_NOONE}: \textcolor{keywordflow}{return} \textcolor{stringliteral}{
      "send\_slaveof\_noone"};
02628     \textcolor{keywordflow}{case} \hyperlink{sentinel_8c_a49d9c64c03e76dcbf7728ad64dd99330}{SENTINEL\_FAILOVER\_STATE\_WAIT\_PROMOTION}: \textcolor{keywordflow}{return} \textcolor{stringliteral}{
      "wait\_promotion"};
02629     \textcolor{keywordflow}{case} \hyperlink{sentinel_8c_a05b020edfa71eb4d24288e79637b57f5}{SENTINEL\_FAILOVER\_STATE\_RECONF\_SLAVES}: \textcolor{keywordflow}{return} \textcolor{stringliteral}{
      "reconf\_slaves"};
02630     \textcolor{keywordflow}{case} \hyperlink{sentinel_8c_a2b6f5592dea88534b287c71e46181ed3}{SENTINEL\_FAILOVER\_STATE\_UPDATE\_CONFIG}: \textcolor{keywordflow}{return} \textcolor{stringliteral}{
      "update\_config"};
02631     \textcolor{keywordflow}{default}: \textcolor{keywordflow}{return} \textcolor{stringliteral}{"unknown"};
02632     \}
02633 \}
02634 
02635 \textcolor{comment}{/* Redis instance to Redis protocol representation. */}
02636 \textcolor{keywordtype}{void} addReplySentinelRedisInstance(\hyperlink{structclient}{client} *c, sentinelRedisInstance *ri) \{
02637     \textcolor{keywordtype}{char} *flags = sdsempty();
02638     \textcolor{keywordtype}{void} *mbl;
02639     \textcolor{keywordtype}{int} fields = 0;
02640 
02641     mbl = addDeferredMultiBulkLength(c);
02642 
02643     addReplyBulkCString(c,\textcolor{stringliteral}{"name"});
02644     addReplyBulkCString(c,ri->name);
02645     fields++;
02646 
02647     addReplyBulkCString(c,\textcolor{stringliteral}{"ip"});
02648     addReplyBulkCString(c,ri->addr->ip);
02649     fields++;
02650 
02651     addReplyBulkCString(c,\textcolor{stringliteral}{"port"});
02652     addReplyBulkLongLong(c,ri->addr->port);
02653     fields++;
02654 
02655     addReplyBulkCString(c,\textcolor{stringliteral}{"runid"});
02656     addReplyBulkCString(c,ri->runid ? ri->runid : \textcolor{stringliteral}{""});
02657     fields++;
02658 
02659     addReplyBulkCString(c,\textcolor{stringliteral}{"flags"});
02660     \textcolor{keywordflow}{if} (ri->flags & \hyperlink{sentinel_8c_a8e26596c8bde451c2dd9cecb2c3046d4}{SRI\_S\_DOWN}) flags = sdscat(flags,\textcolor{stringliteral}{"s\_down,"});
02661     \textcolor{keywordflow}{if} (ri->flags & \hyperlink{sentinel_8c_a3bbbca05543cd9d9f86d276e2c7c719c}{SRI\_O\_DOWN}) flags = sdscat(flags,\textcolor{stringliteral}{"o\_down,"});
02662     \textcolor{keywordflow}{if} (ri->flags & \hyperlink{sentinel_8c_a2ee83e5ff67b45746cd6a310f15334b2}{SRI\_MASTER}) flags = sdscat(flags,\textcolor{stringliteral}{"master,"});
02663     \textcolor{keywordflow}{if} (ri->flags & \hyperlink{sentinel_8c_a4b9db21eda79d49bd9fdf2cf7b3178e8}{SRI\_SLAVE}) flags = sdscat(flags,\textcolor{stringliteral}{"slave,"});
02664     \textcolor{keywordflow}{if} (ri->flags & \hyperlink{sentinel_8c_a8ed55207b2af5d2dd314c951ef253f64}{SRI\_SENTINEL}) flags = sdscat(flags,\textcolor{stringliteral}{"sentinel,"});
02665     \textcolor{keywordflow}{if} (ri->link->disconnected) flags = sdscat(flags,\textcolor{stringliteral}{"disconnected,"});
02666     \textcolor{keywordflow}{if} (ri->flags & \hyperlink{sentinel_8c_a80003592a6337bdc484182ff1d33e41c}{SRI\_MASTER\_DOWN}) flags = sdscat(flags,\textcolor{stringliteral}{"master\_down,"});
02667     \textcolor{keywordflow}{if} (ri->flags & \hyperlink{sentinel_8c_a0546b63633196f09fcd90957243b0798}{SRI\_FAILOVER\_IN\_PROGRESS})
02668         flags = sdscat(flags,\textcolor{stringliteral}{"failover\_in\_progress,"});
02669     \textcolor{keywordflow}{if} (ri->flags & \hyperlink{sentinel_8c_a6c6c019b1af48a9c0e9507422051c684}{SRI\_PROMOTED}) flags = sdscat(flags,\textcolor{stringliteral}{"promoted,"});
02670     \textcolor{keywordflow}{if} (ri->flags & \hyperlink{sentinel_8c_a9b307b68cb1615ead6aacb0de34910e6}{SRI\_RECONF\_SENT}) flags = sdscat(flags,\textcolor{stringliteral}{"reconf\_sent,"});
02671     \textcolor{keywordflow}{if} (ri->flags & \hyperlink{sentinel_8c_a58c89f4aaa1bdfde4c25e3bb476c35aa}{SRI\_RECONF\_INPROG}) flags = sdscat(flags,\textcolor{stringliteral}{"reconf\_inprog,"});
02672     \textcolor{keywordflow}{if} (ri->flags & \hyperlink{sentinel_8c_adb468d0a8c96c954b6af26aa670d7a11}{SRI\_RECONF\_DONE}) flags = sdscat(flags,\textcolor{stringliteral}{"reconf\_done,"});
02673 
02674     \textcolor{keywordflow}{if} (sdslen(flags) != 0) sdsrange(flags,0,-2); \textcolor{comment}{/* remove last "," */}
02675     addReplyBulkCString(c,flags);
02676     sdsfree(flags);
02677     fields++;
02678 
02679     addReplyBulkCString(c,\textcolor{stringliteral}{"link-pending-commands"});
02680     addReplyBulkLongLong(c,ri->link->pending\_commands);
02681     fields++;
02682 
02683     addReplyBulkCString(c,\textcolor{stringliteral}{"link-refcount"});
02684     addReplyBulkLongLong(c,ri->link->refcount);
02685     fields++;
02686 
02687     \textcolor{keywordflow}{if} (ri->flags & \hyperlink{sentinel_8c_a0546b63633196f09fcd90957243b0798}{SRI\_FAILOVER\_IN\_PROGRESS}) \{
02688         addReplyBulkCString(c,\textcolor{stringliteral}{"failover-state"});
02689         addReplyBulkCString(c,(\textcolor{keywordtype}{char}*)sentinelFailoverStateStr(ri->failover\_state));
02690         fields++;
02691     \}
02692 
02693     addReplyBulkCString(c,\textcolor{stringliteral}{"last-ping-sent"});
02694     addReplyBulkLongLong(c,
02695         ri->link->act\_ping\_time ? (mstime() - ri->link->act\_ping\_time) : 0);
02696     fields++;
02697 
02698     addReplyBulkCString(c,\textcolor{stringliteral}{"last-ok-ping-reply"});
02699     addReplyBulkLongLong(c,mstime() - ri->link->last\_avail\_time);
02700     fields++;
02701 
02702     addReplyBulkCString(c,\textcolor{stringliteral}{"last-ping-reply"});
02703     addReplyBulkLongLong(c,mstime() - ri->link->last\_pong\_time);
02704     fields++;
02705 
02706     \textcolor{keywordflow}{if} (ri->flags & \hyperlink{sentinel_8c_a8e26596c8bde451c2dd9cecb2c3046d4}{SRI\_S\_DOWN}) \{
02707         addReplyBulkCString(c,\textcolor{stringliteral}{"s-down-time"});
02708         addReplyBulkLongLong(c,mstime()-ri->s\_down\_since\_time);
02709         fields++;
02710     \}
02711 
02712     \textcolor{keywordflow}{if} (ri->flags & \hyperlink{sentinel_8c_a3bbbca05543cd9d9f86d276e2c7c719c}{SRI\_O\_DOWN}) \{
02713         addReplyBulkCString(c,\textcolor{stringliteral}{"o-down-time"});
02714         addReplyBulkLongLong(c,mstime()-ri->o\_down\_since\_time);
02715         fields++;
02716     \}
02717 
02718     addReplyBulkCString(c,\textcolor{stringliteral}{"down-after-milliseconds"});
02719     addReplyBulkLongLong(c,ri->down\_after\_period);
02720     fields++;
02721 
02722     \textcolor{comment}{/* Masters and Slaves */}
02723     \textcolor{keywordflow}{if} (ri->flags & (\hyperlink{sentinel_8c_a2ee83e5ff67b45746cd6a310f15334b2}{SRI\_MASTER}|\hyperlink{sentinel_8c_a4b9db21eda79d49bd9fdf2cf7b3178e8}{SRI\_SLAVE})) \{
02724         addReplyBulkCString(c,\textcolor{stringliteral}{"info-refresh"});
02725         addReplyBulkLongLong(c,mstime() - ri->info\_refresh);
02726         fields++;
02727 
02728         addReplyBulkCString(c,\textcolor{stringliteral}{"role-reported"});
02729         addReplyBulkCString(c, (ri->role\_reported == \hyperlink{sentinel_8c_a2ee83e5ff67b45746cd6a310f15334b2}{SRI\_MASTER}) ? \textcolor{stringliteral}{"master"} :
02730                                                                    \textcolor{stringliteral}{"slave"});
02731         fields++;
02732 
02733         addReplyBulkCString(c,\textcolor{stringliteral}{"role-reported-time"});
02734         addReplyBulkLongLong(c,mstime() - ri->role\_reported\_time);
02735         fields++;
02736     \}
02737 
02738     \textcolor{comment}{/* Only masters */}
02739     \textcolor{keywordflow}{if} (ri->flags & \hyperlink{sentinel_8c_a2ee83e5ff67b45746cd6a310f15334b2}{SRI\_MASTER}) \{
02740         addReplyBulkCString(c,\textcolor{stringliteral}{"config-epoch"});
02741         addReplyBulkLongLong(c,ri->config\_epoch);
02742         fields++;
02743 
02744         addReplyBulkCString(c,\textcolor{stringliteral}{"num-slaves"});
02745         addReplyBulkLongLong(c,\hyperlink{dict_8h_af193430dd3d5579a52b194512f72c1f0}{dictSize}(ri->slaves));
02746         fields++;
02747 
02748         addReplyBulkCString(c,\textcolor{stringliteral}{"num-other-sentinels"});
02749         addReplyBulkLongLong(c,\hyperlink{dict_8h_af193430dd3d5579a52b194512f72c1f0}{dictSize}(ri->sentinels));
02750         fields++;
02751 
02752         addReplyBulkCString(c,\textcolor{stringliteral}{"quorum"});
02753         addReplyBulkLongLong(c,ri->quorum);
02754         fields++;
02755 
02756         addReplyBulkCString(c,\textcolor{stringliteral}{"failover-timeout"});
02757         addReplyBulkLongLong(c,ri->failover\_timeout);
02758         fields++;
02759 
02760         addReplyBulkCString(c,\textcolor{stringliteral}{"parallel-syncs"});
02761         addReplyBulkLongLong(c,ri->parallel\_syncs);
02762         fields++;
02763 
02764         \textcolor{keywordflow}{if} (ri->notification\_script) \{
02765             addReplyBulkCString(c,\textcolor{stringliteral}{"notification-script"});
02766             addReplyBulkCString(c,ri->notification\_script);
02767             fields++;
02768         \}
02769 
02770         \textcolor{keywordflow}{if} (ri->client\_reconfig\_script) \{
02771             addReplyBulkCString(c,\textcolor{stringliteral}{"client-reconfig-script"});
02772             addReplyBulkCString(c,ri->client\_reconfig\_script);
02773             fields++;
02774         \}
02775     \}
02776 
02777     \textcolor{comment}{/* Only slaves */}
02778     \textcolor{keywordflow}{if} (ri->flags & \hyperlink{sentinel_8c_a4b9db21eda79d49bd9fdf2cf7b3178e8}{SRI\_SLAVE}) \{
02779         addReplyBulkCString(c,\textcolor{stringliteral}{"master-link-down-time"});
02780         addReplyBulkLongLong(c,ri->master\_link\_down\_time);
02781         fields++;
02782 
02783         addReplyBulkCString(c,\textcolor{stringliteral}{"master-link-status"});
02784         addReplyBulkCString(c,
02785             (ri->slave\_master\_link\_status == \hyperlink{sentinel_8c_a8dc7f6cce8e6299e2422b8c65ca16418}{SENTINEL\_MASTER\_LINK\_STATUS\_UP}
      ) ?
02786             \textcolor{stringliteral}{"ok"} : \textcolor{stringliteral}{"err"});
02787         fields++;
02788 
02789         addReplyBulkCString(c,\textcolor{stringliteral}{"master-host"});
02790         addReplyBulkCString(c,
02791             ri->slave\_master\_host ? ri->slave\_master\_host : \textcolor{stringliteral}{"?"});
02792         fields++;
02793 
02794         addReplyBulkCString(c,\textcolor{stringliteral}{"master-port"});
02795         addReplyBulkLongLong(c,ri->slave\_master\_port);
02796         fields++;
02797 
02798         addReplyBulkCString(c,\textcolor{stringliteral}{"slave-priority"});
02799         addReplyBulkLongLong(c,ri->slave\_priority);
02800         fields++;
02801 
02802         addReplyBulkCString(c,\textcolor{stringliteral}{"slave-repl-offset"});
02803         addReplyBulkLongLong(c,ri->slave\_repl\_offset);
02804         fields++;
02805     \}
02806 
02807     \textcolor{comment}{/* Only sentinels */}
02808     \textcolor{keywordflow}{if} (ri->flags & \hyperlink{sentinel_8c_a8ed55207b2af5d2dd314c951ef253f64}{SRI\_SENTINEL}) \{
02809         addReplyBulkCString(c,\textcolor{stringliteral}{"last-hello-message"});
02810         addReplyBulkLongLong(c,mstime() - ri->last\_hello\_time);
02811         fields++;
02812 
02813         addReplyBulkCString(c,\textcolor{stringliteral}{"voted-leader"});
02814         addReplyBulkCString(c,ri->leader ? ri->leader : \textcolor{stringliteral}{"?"});
02815         fields++;
02816 
02817         addReplyBulkCString(c,\textcolor{stringliteral}{"voted-leader-epoch"});
02818         addReplyBulkLongLong(c,ri->leader\_epoch);
02819         fields++;
02820     \}
02821 
02822     setDeferredMultiBulkLength(c,mbl,fields*2);
02823 \}
02824 
02825 \textcolor{comment}{/* Output a number of instances contained inside a dictionary as}
02826 \textcolor{comment}{ * Redis protocol. */}
02827 \textcolor{keywordtype}{void} addReplyDictOfRedisInstances(\hyperlink{structclient}{client} *c, dict *instances) \{
02828     dictIterator *di;
02829     dictEntry *de;
02830 
02831     di = dictGetIterator(instances);
02832     addReplyMultiBulkLen(c,\hyperlink{dict_8h_af193430dd3d5579a52b194512f72c1f0}{dictSize}(instances));
02833     \textcolor{keywordflow}{while}((de = dictNext(di)) != NULL) \{
02834         sentinelRedisInstance *ri = \hyperlink{dict_8h_ae8d2cc391873b2bea2b87c4f80f43120}{dictGetVal}(de);
02835 
02836         addReplySentinelRedisInstance(c,ri);
02837     \}
02838     dictReleaseIterator(di);
02839 \}
02840 
02841 \textcolor{comment}{/* Lookup the named master into sentinel.masters.}
02842 \textcolor{comment}{ * If the master is not found reply to the client with an error and returns}
02843 \textcolor{comment}{ * NULL. */}
02844 sentinelRedisInstance *sentinelGetMasterByNameOrReplyError(\hyperlink{structclient}{client} *c,
02845                         robj *name)
02846 \{
02847     sentinelRedisInstance *ri;
02848 
02849     ri = dictFetchValue(sentinel.masters,name->ptr);
02850     \textcolor{keywordflow}{if} (!ri) \{
02851         addReplyError(c,\textcolor{stringliteral}{"No such master with that name"});
02852         \textcolor{keywordflow}{return} NULL;
02853     \}
02854     \textcolor{keywordflow}{return} ri;
02855 \}
02856 
02857 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{SENTINEL\_ISQR\_OK} 0
02858 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{SENTINEL\_ISQR\_NOQUORUM} \textcolor{preprocessor}{(}1\textcolor{preprocessor}{<<}0\textcolor{preprocessor}{)}
02859 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{SENTINEL\_ISQR\_NOAUTH} \textcolor{preprocessor}{(}1\textcolor{preprocessor}{<<}1\textcolor{preprocessor}{)}
02860 \textcolor{keywordtype}{int} sentinelIsQuorumReachable(sentinelRedisInstance *master, \textcolor{keywordtype}{int} *usableptr) \{
02861     dictIterator *di;
02862     dictEntry *de;
02863     \textcolor{keywordtype}{int} usable = 1; \textcolor{comment}{/* Number of usable Sentinels. Init to 1 to count myself. */}
02864     \textcolor{keywordtype}{int} result = \hyperlink{sentinel_8c_a8d62015016e2a7110d1e75fcd4681e6a}{SENTINEL\_ISQR\_OK};
02865     \textcolor{keywordtype}{int} voters = \hyperlink{dict_8h_af193430dd3d5579a52b194512f72c1f0}{dictSize}(master->sentinels)+1; \textcolor{comment}{/* Known Sentinels + myself. */}
02866 
02867     di = dictGetIterator(master->sentinels);
02868     \textcolor{keywordflow}{while}((de = dictNext(di)) != NULL) \{
02869         sentinelRedisInstance *ri = \hyperlink{dict_8h_ae8d2cc391873b2bea2b87c4f80f43120}{dictGetVal}(de);
02870 
02871         \textcolor{keywordflow}{if} (ri->flags & (\hyperlink{sentinel_8c_a8e26596c8bde451c2dd9cecb2c3046d4}{SRI\_S\_DOWN}|\hyperlink{sentinel_8c_a3bbbca05543cd9d9f86d276e2c7c719c}{SRI\_O\_DOWN})) \textcolor{keywordflow}{continue};
02872         usable++;
02873     \}
02874     dictReleaseIterator(di);
02875 
02876     \textcolor{keywordflow}{if} (usable < (\textcolor{keywordtype}{int})master->quorum) result |= \hyperlink{sentinel_8c_a671f4068236e7849f994bb2b67c6ea73}{SENTINEL\_ISQR\_NOQUORUM};
02877     \textcolor{keywordflow}{if} (usable < voters/2+1) result |= \hyperlink{sentinel_8c_aa0ea85d4d4408c055dbc1e46cea1827a}{SENTINEL\_ISQR\_NOAUTH};
02878     \textcolor{keywordflow}{if} (usableptr) *usableptr = usable;
02879     \textcolor{keywordflow}{return} result;
02880 \}
02881 
02882 \textcolor{keywordtype}{void} sentinelCommand(\hyperlink{structclient}{client} *c) \{
02883     \textcolor{keywordflow}{if} (!strcasecmp(c->argv[1]->ptr,\textcolor{stringliteral}{"masters"})) \{
02884         \textcolor{comment}{/* SENTINEL MASTERS */}
02885         \textcolor{keywordflow}{if} (c->argc != 2) \textcolor{keywordflow}{goto} numargserr;
02886         addReplyDictOfRedisInstances(c,sentinel.masters);
02887     \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(c->argv[1]->ptr,\textcolor{stringliteral}{"master"})) \{
02888         \textcolor{comment}{/* SENTINEL MASTER <name> */}
02889         sentinelRedisInstance *ri;
02890 
02891         \textcolor{keywordflow}{if} (c->argc != 3) \textcolor{keywordflow}{goto} numargserr;
02892         \textcolor{keywordflow}{if} ((ri = sentinelGetMasterByNameOrReplyError(c,c->argv[2]))
02893             == NULL) \textcolor{keywordflow}{return};
02894         addReplySentinelRedisInstance(c,ri);
02895     \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(c->argv[1]->ptr,\textcolor{stringliteral}{"slaves"})) \{
02896         \textcolor{comment}{/* SENTINEL SLAVES <master-name> */}
02897         sentinelRedisInstance *ri;
02898 
02899         \textcolor{keywordflow}{if} (c->argc != 3) \textcolor{keywordflow}{goto} numargserr;
02900         \textcolor{keywordflow}{if} ((ri = sentinelGetMasterByNameOrReplyError(c,c->argv[2])) == NULL)
02901             \textcolor{keywordflow}{return};
02902         addReplyDictOfRedisInstances(c,ri->slaves);
02903     \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(c->argv[1]->ptr,\textcolor{stringliteral}{"sentinels"})) \{
02904         \textcolor{comment}{/* SENTINEL SENTINELS <master-name> */}
02905         sentinelRedisInstance *ri;
02906 
02907         \textcolor{keywordflow}{if} (c->argc != 3) \textcolor{keywordflow}{goto} numargserr;
02908         \textcolor{keywordflow}{if} ((ri = sentinelGetMasterByNameOrReplyError(c,c->argv[2])) == NULL)
02909             \textcolor{keywordflow}{return};
02910         addReplyDictOfRedisInstances(c,ri->sentinels);
02911     \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(c->argv[1]->ptr,\textcolor{stringliteral}{"is-master-down-by-addr"})) \{
02912         \textcolor{comment}{/* SENTINEL IS-MASTER-DOWN-BY-ADDR <ip> <port> <current-epoch> <runid>}
02913 \textcolor{comment}{         *}
02914 \textcolor{comment}{         * Arguments:}
02915 \textcolor{comment}{         *}
02916 \textcolor{comment}{         * ip and port are the ip and port of the master we want to be}
02917 \textcolor{comment}{         * checked by Sentinel. Note that the command will not check by}
02918 \textcolor{comment}{         * name but just by master, in theory different Sentinels may monitor}
02919 \textcolor{comment}{         * differnet masters with the same name.}
02920 \textcolor{comment}{         *}
02921 \textcolor{comment}{         * current-epoch is needed in order to understand if we are allowed}
02922 \textcolor{comment}{         * to vote for a failover leader or not. Each Sentinel can vote just}
02923 \textcolor{comment}{         * one time per epoch.}
02924 \textcolor{comment}{         *}
02925 \textcolor{comment}{         * runid is "*" if we are not seeking for a vote from the Sentinel}
02926 \textcolor{comment}{         * in order to elect the failover leader. Otherwise it is set to the}
02927 \textcolor{comment}{         * runid we want the Sentinel to vote if it did not already voted.}
02928 \textcolor{comment}{         */}
02929         sentinelRedisInstance *ri;
02930         \textcolor{keywordtype}{long} \textcolor{keywordtype}{long} req\_epoch;
02931         uint64\_t leader\_epoch = 0;
02932         \textcolor{keywordtype}{char} *leader = NULL;
02933         \textcolor{keywordtype}{long} port;
02934         \textcolor{keywordtype}{int} isdown = 0;
02935 
02936         \textcolor{keywordflow}{if} (c->argc != 6) \textcolor{keywordflow}{goto} numargserr;
02937         \textcolor{keywordflow}{if} (getLongFromObjectOrReply(c,c->argv[3],&port,NULL) != \hyperlink{server_8h_a303769ef1065076e68731584e758d3e1}{C\_OK} ||
02938             getLongLongFromObjectOrReply(c,c->argv[4],&req\_epoch,NULL)
02939                                                               != \hyperlink{server_8h_a303769ef1065076e68731584e758d3e1}{C\_OK})
02940             \textcolor{keywordflow}{return};
02941         ri = getSentinelRedisInstanceByAddrAndRunID(sentinel.masters,
02942             c->argv[2]->ptr,port,NULL);
02943 
02944         \textcolor{comment}{/* It exists? Is actually a master? Is subjectively down? It's down.}
02945 \textcolor{comment}{         * Note: if we are in tilt mode we always reply with "0". */}
02946         \textcolor{keywordflow}{if} (!sentinel.tilt && ri && (ri->flags & \hyperlink{sentinel_8c_a8e26596c8bde451c2dd9cecb2c3046d4}{SRI\_S\_DOWN}) &&
02947                                     (ri->flags & \hyperlink{sentinel_8c_a2ee83e5ff67b45746cd6a310f15334b2}{SRI\_MASTER}))
02948             isdown = 1;
02949 
02950         \textcolor{comment}{/* Vote for the master (or fetch the previous vote) if the request}
02951 \textcolor{comment}{         * includes a runid, otherwise the sender is not seeking for a vote. */}
02952         \textcolor{keywordflow}{if} (ri && ri->flags & \hyperlink{sentinel_8c_a2ee83e5ff67b45746cd6a310f15334b2}{SRI\_MASTER} && strcasecmp(c->argv[5]->ptr,\textcolor{stringliteral}{"*"})) \{
02953             leader = sentinelVoteLeader(ri,(uint64\_t)req\_epoch,
02954                                             c->argv[5]->ptr,
02955                                             &leader\_epoch);
02956         \}
02957 
02958         \textcolor{comment}{/* Reply with a three-elements multi-bulk reply:}
02959 \textcolor{comment}{         * down state, leader, vote epoch. */}
02960         addReplyMultiBulkLen(c,3);
02961         addReply(c, isdown ? shared.cone : shared.czero);
02962         addReplyBulkCString(c, leader ? leader : \textcolor{stringliteral}{"*"});
02963         addReplyLongLong(c, (\textcolor{keywordtype}{long} \textcolor{keywordtype}{long})leader\_epoch);
02964         \textcolor{keywordflow}{if} (leader) sdsfree(leader);
02965     \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(c->argv[1]->ptr,\textcolor{stringliteral}{"reset"})) \{
02966         \textcolor{comment}{/* SENTINEL RESET <pattern> */}
02967         \textcolor{keywordflow}{if} (c->argc != 3) \textcolor{keywordflow}{goto} numargserr;
02968         addReplyLongLong(c,sentinelResetMastersByPattern(c->argv[2]->ptr,
      \hyperlink{sentinel_8c_a824209bfd4f15f07b6555fb19d8ba328}{SENTINEL\_GENERATE\_EVENT}));
02969     \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(c->argv[1]->ptr,\textcolor{stringliteral}{"get-master-addr-by-name"})) \{
02970         \textcolor{comment}{/* SENTINEL GET-MASTER-ADDR-BY-NAME <master-name> */}
02971         sentinelRedisInstance *ri;
02972 
02973         \textcolor{keywordflow}{if} (c->argc != 3) \textcolor{keywordflow}{goto} numargserr;
02974         ri = sentinelGetMasterByName(c->argv[2]->ptr);
02975         \textcolor{keywordflow}{if} (ri == NULL) \{
02976             addReply(c,shared.nullmultibulk);
02977         \} \textcolor{keywordflow}{else} \{
02978             sentinelAddr *addr = sentinelGetCurrentMasterAddress(ri);
02979 
02980             addReplyMultiBulkLen(c,2);
02981             addReplyBulkCString(c,addr->ip);
02982             addReplyBulkLongLong(c,addr->port);
02983         \}
02984     \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(c->argv[1]->ptr,\textcolor{stringliteral}{"failover"})) \{
02985         \textcolor{comment}{/* SENTINEL FAILOVER <master-name> */}
02986         sentinelRedisInstance *ri;
02987 
02988         \textcolor{keywordflow}{if} (c->argc != 3) \textcolor{keywordflow}{goto} numargserr;
02989         \textcolor{keywordflow}{if} ((ri = sentinelGetMasterByNameOrReplyError(c,c->argv[2])) == NULL)
02990             \textcolor{keywordflow}{return};
02991         \textcolor{keywordflow}{if} (ri->flags & \hyperlink{sentinel_8c_a0546b63633196f09fcd90957243b0798}{SRI\_FAILOVER\_IN\_PROGRESS}) \{
02992             addReplySds(c,sdsnew(\textcolor{stringliteral}{"-INPROG Failover already in progress\(\backslash\)r\(\backslash\)n"}));
02993             \textcolor{keywordflow}{return};
02994         \}
02995         \textcolor{keywordflow}{if} (sentinelSelectSlave(ri) == NULL) \{
02996             addReplySds(c,sdsnew(\textcolor{stringliteral}{"-NOGOODSLAVE No suitable slave to promote\(\backslash\)r\(\backslash\)n"}));
02997             \textcolor{keywordflow}{return};
02998         \}
02999         serverLog(\hyperlink{server_8h_a31229b9334bba7d6be2a72970967a14b}{LL\_WARNING},\textcolor{stringliteral}{"Executing user requested FAILOVER of '%s'"},
03000             ri->name);
03001         sentinelStartFailover(ri);
03002         ri->flags |= \hyperlink{sentinel_8c_a9b13a255852e8097e4730cb495cdfd94}{SRI\_FORCE\_FAILOVER};
03003         addReply(c,shared.ok);
03004     \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(c->argv[1]->ptr,\textcolor{stringliteral}{"pending-scripts"})) \{
03005         \textcolor{comment}{/* SENTINEL PENDING-SCRIPTS */}
03006 
03007         \textcolor{keywordflow}{if} (c->argc != 2) \textcolor{keywordflow}{goto} numargserr;
03008         sentinelPendingScriptsCommand(c);
03009     \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(c->argv[1]->ptr,\textcolor{stringliteral}{"monitor"})) \{
03010         \textcolor{comment}{/* SENTINEL MONITOR <name> <ip> <port> <quorum> */}
03011         sentinelRedisInstance *ri;
03012         \textcolor{keywordtype}{long} quorum, port;
03013         \textcolor{keywordtype}{char} ip[\hyperlink{server_8h_ad97c5405ed22a94e9fcc10fba577d6c0}{NET\_IP\_STR\_LEN}];
03014 
03015         \textcolor{keywordflow}{if} (c->argc != 6) \textcolor{keywordflow}{goto} numargserr;
03016         \textcolor{keywordflow}{if} (getLongFromObjectOrReply(c,c->argv[5],&quorum,\textcolor{stringliteral}{"Invalid quorum"})
03017             != \hyperlink{server_8h_a303769ef1065076e68731584e758d3e1}{C\_OK}) \textcolor{keywordflow}{return};
03018         \textcolor{keywordflow}{if} (getLongFromObjectOrReply(c,c->argv[4],&port,\textcolor{stringliteral}{"Invalid port"})
03019             != \hyperlink{server_8h_a303769ef1065076e68731584e758d3e1}{C\_OK}) \textcolor{keywordflow}{return};
03020 
03021         \textcolor{keywordflow}{if} (quorum <= 0) \{
03022             addReplyError(c, \textcolor{stringliteral}{"Quorum must be 1 or greater."});
03023             \textcolor{keywordflow}{return};
03024         \}
03025 
03026         \textcolor{comment}{/* Make sure the IP field is actually a valid IP before passing it}
03027 \textcolor{comment}{         * to createSentinelRedisInstance(), otherwise we may trigger a}
03028 \textcolor{comment}{         * DNS lookup at runtime. */}
03029         \textcolor{keywordflow}{if} (anetResolveIP(NULL,c->argv[3]->ptr,ip,\textcolor{keyword}{sizeof}(ip)) == \hyperlink{anet_8h_a0697b7774a7e0f4ef141839fe93536fe}{ANET\_ERR}) \{
03030             addReplyError(c,\textcolor{stringliteral}{"Invalid IP address specified"});
03031             \textcolor{keywordflow}{return};
03032         \}
03033 
03034         \textcolor{comment}{/* Parameters are valid. Try to create the master instance. */}
03035         ri = createSentinelRedisInstance(c->argv[2]->ptr,\hyperlink{sentinel_8c_a2ee83e5ff67b45746cd6a310f15334b2}{SRI\_MASTER},
03036                 c->argv[3]->ptr,port,quorum,NULL);
03037         \textcolor{keywordflow}{if} (ri == NULL) \{
03038             \textcolor{keywordflow}{switch}(errno) \{
03039             \textcolor{keywordflow}{case} EBUSY:
03040                 addReplyError(c,\textcolor{stringliteral}{"Duplicated master name"});
03041                 \textcolor{keywordflow}{break};
03042             \textcolor{keywordflow}{case} EINVAL:
03043                 addReplyError(c,\textcolor{stringliteral}{"Invalid port number"});
03044                 \textcolor{keywordflow}{break};
03045             \textcolor{keywordflow}{default}:
03046                 addReplyError(c,\textcolor{stringliteral}{"Unspecified error adding the instance"});
03047                 \textcolor{keywordflow}{break};
03048             \}
03049         \} \textcolor{keywordflow}{else} \{
03050             sentinelFlushConfig();
03051             sentinelEvent(\hyperlink{server_8h_a31229b9334bba7d6be2a72970967a14b}{LL\_WARNING},\textcolor{stringliteral}{"+monitor"},ri,\textcolor{stringliteral}{"%@ quorum %d"},ri->quorum);
03052             addReply(c,shared.ok);
03053         \}
03054     \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(c->argv[1]->ptr,\textcolor{stringliteral}{"flushconfig"})) \{
03055         \textcolor{keywordflow}{if} (c->argc != 2) \textcolor{keywordflow}{goto} numargserr;
03056         sentinelFlushConfig();
03057         addReply(c,shared.ok);
03058         \textcolor{keywordflow}{return};
03059     \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(c->argv[1]->ptr,\textcolor{stringliteral}{"remove"})) \{
03060         \textcolor{comment}{/* SENTINEL REMOVE <name> */}
03061         sentinelRedisInstance *ri;
03062 
03063         \textcolor{keywordflow}{if} (c->argc != 3) \textcolor{keywordflow}{goto} numargserr;
03064         \textcolor{keywordflow}{if} ((ri = sentinelGetMasterByNameOrReplyError(c,c->argv[2]))
03065             == NULL) \textcolor{keywordflow}{return};
03066         sentinelEvent(\hyperlink{server_8h_a31229b9334bba7d6be2a72970967a14b}{LL\_WARNING},\textcolor{stringliteral}{"-monitor"},ri,\textcolor{stringliteral}{"%@"});
03067         dictDelete(sentinel.masters,c->argv[2]->ptr);
03068         sentinelFlushConfig();
03069         addReply(c,shared.ok);
03070     \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(c->argv[1]->ptr,\textcolor{stringliteral}{"ckquorum"})) \{
03071         \textcolor{comment}{/* SENTINEL CKQUORUM <name> */}
03072         sentinelRedisInstance *ri;
03073         \textcolor{keywordtype}{int} usable;
03074 
03075         \textcolor{keywordflow}{if} (c->argc != 3) \textcolor{keywordflow}{goto} numargserr;
03076         \textcolor{keywordflow}{if} ((ri = sentinelGetMasterByNameOrReplyError(c,c->argv[2]))
03077             == NULL) \textcolor{keywordflow}{return};
03078         \textcolor{keywordtype}{int} result = sentinelIsQuorumReachable(ri,&usable);
03079         \textcolor{keywordflow}{if} (result == \hyperlink{sentinel_8c_a8d62015016e2a7110d1e75fcd4681e6a}{SENTINEL\_ISQR\_OK}) \{
03080             addReplySds(c, sdscatfmt(sdsempty(),
03081                 \textcolor{stringliteral}{"+OK %i usable Sentinels. Quorum and failover authorization "}
03082                 \textcolor{stringliteral}{"can be reached\(\backslash\)r\(\backslash\)n"},usable));
03083         \} \textcolor{keywordflow}{else} \{
03084             sds e = sdscatfmt(sdsempty(),
03085                 \textcolor{stringliteral}{"-NOQUORUM %i usable Sentinels. "},usable);
03086             \textcolor{keywordflow}{if} (result & \hyperlink{sentinel_8c_a671f4068236e7849f994bb2b67c6ea73}{SENTINEL\_ISQR\_NOQUORUM})
03087                 e = sdscat(e,\textcolor{stringliteral}{"Not enough available Sentinels to reach the"}
03088                              \textcolor{stringliteral}{" specified quorum for this master"});
03089             \textcolor{keywordflow}{if} (result & \hyperlink{sentinel_8c_aa0ea85d4d4408c055dbc1e46cea1827a}{SENTINEL\_ISQR\_NOAUTH}) \{
03090                 \textcolor{keywordflow}{if} (result & \hyperlink{sentinel_8c_a671f4068236e7849f994bb2b67c6ea73}{SENTINEL\_ISQR\_NOQUORUM}) e = sdscat(e,\textcolor{stringliteral}{". "});
03091                 e = sdscat(e, \textcolor{stringliteral}{"Not enough available Sentinels to reach the"}
03092                               \textcolor{stringliteral}{" majority and authorize a failover"});
03093             \}
03094             e = sdscat(e,\textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"});
03095             addReplySds(c,e);
03096         \}
03097     \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(c->argv[1]->ptr,\textcolor{stringliteral}{"set"})) \{
03098         \textcolor{keywordflow}{if} (c->argc < 3 || c->argc % 2 == 0) \textcolor{keywordflow}{goto} numargserr;
03099         sentinelSetCommand(c);
03100     \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(c->argv[1]->ptr,\textcolor{stringliteral}{"info-cache"})) \{
03101         \textcolor{comment}{/* SENTINEL INFO-CACHE <name> */}
03102         \textcolor{keywordflow}{if} (c->argc < 2) \textcolor{keywordflow}{goto} numargserr;
03103         mstime\_t now = mstime();
03104 
03105         \textcolor{comment}{/* Create an ad-hoc dictionary type so that we can iterate}
03106 \textcolor{comment}{         * a dictionary composed of just the master groups the user}
03107 \textcolor{comment}{         * requested. */}
03108         dictType copy\_keeper = instancesDictType;
03109         copy\_keeper.valDestructor = NULL;
03110         dict *masters\_local = sentinel.masters;
03111         \textcolor{keywordflow}{if} (c->argc > 2) \{
03112             masters\_local = dictCreate(&copy\_keeper, NULL);
03113 
03114             \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 2; i < c->argc; i++) \{
03115                 sentinelRedisInstance *ri;
03116                 ri = sentinelGetMasterByName(c->argv[i]->ptr);
03117                 \textcolor{keywordflow}{if} (!ri) \textcolor{keywordflow}{continue}; \textcolor{comment}{/* ignore non-existing names */}
03118                 dictAdd(masters\_local, ri->name, ri);
03119             \}
03120         \}
03121 
03122         \textcolor{comment}{/* Reply format:}
03123 \textcolor{comment}{         *   1.) master name}
03124 \textcolor{comment}{         *   2.) 1.) info from master}
03125 \textcolor{comment}{         *       2.) info from replica}
03126 \textcolor{comment}{         *       ...}
03127 \textcolor{comment}{         *   3.) other master name}
03128 \textcolor{comment}{         *   ...}
03129 \textcolor{comment}{         */}
03130         addReplyMultiBulkLen(c,\hyperlink{dict_8h_af193430dd3d5579a52b194512f72c1f0}{dictSize}(masters\_local) * 2);
03131 
03132         dictIterator  *di;
03133         dictEntry *de;
03134         di = dictGetIterator(masters\_local);
03135         \textcolor{keywordflow}{while} ((de = dictNext(di)) != NULL) \{
03136             sentinelRedisInstance *ri = \hyperlink{dict_8h_ae8d2cc391873b2bea2b87c4f80f43120}{dictGetVal}(de);
03137             addReplyBulkCBuffer(c,ri->name,strlen(ri->name));
03138             addReplyMultiBulkLen(c,\hyperlink{dict_8h_af193430dd3d5579a52b194512f72c1f0}{dictSize}(ri->slaves) + 1); \textcolor{comment}{/* +1 for self */}
03139             addReplyMultiBulkLen(c,2);
03140             addReplyLongLong(c, now - ri->info\_refresh);
03141             \textcolor{keywordflow}{if} (ri->info)
03142                 addReplyBulkCBuffer(c,ri->info,sdslen(ri->info));
03143             \textcolor{keywordflow}{else}
03144                 addReply(c,shared.nullbulk);
03145 
03146             dictIterator *sdi;
03147             dictEntry *sde;
03148             sdi = dictGetIterator(ri->slaves);
03149             \textcolor{keywordflow}{while} ((sde = dictNext(sdi)) != NULL) \{
03150                 sentinelRedisInstance *sri = \hyperlink{dict_8h_ae8d2cc391873b2bea2b87c4f80f43120}{dictGetVal}(sde);
03151                 addReplyMultiBulkLen(c,2);
03152                 addReplyLongLong(c, now - sri->info\_refresh);
03153                 \textcolor{keywordflow}{if} (sri->info)
03154                     addReplyBulkCBuffer(c,sri->info,sdslen(sri->info));
03155                 \textcolor{keywordflow}{else}
03156                     addReply(c,shared.nullbulk);
03157             \}
03158             dictReleaseIterator(sdi);
03159         \}
03160         dictReleaseIterator(di);
03161         \textcolor{keywordflow}{if} (masters\_local != sentinel.masters) dictRelease(masters\_local);
03162     \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(c->argv[1]->ptr,\textcolor{stringliteral}{"simulate-failure"})) \{
03163         \textcolor{comment}{/* SENTINEL SIMULATE-FAILURE <flag> <flag> ... <flag> */}
03164         \textcolor{keywordtype}{int} j;
03165 
03166         sentinel.simfailure\_flags = \hyperlink{sentinel_8c_a045e4b70a9044e6e62c9cf6aafff8d3f}{SENTINEL\_SIMFAILURE\_NONE};
03167         \textcolor{keywordflow}{for} (j = 2; j < c->argc; j++) \{
03168             \textcolor{keywordflow}{if} (!strcasecmp(c->argv[j]->ptr,\textcolor{stringliteral}{"crash-after-election"})) \{
03169                 sentinel.simfailure\_flags |=
03170                     \hyperlink{sentinel_8c_a8549938b8489bb23679cf13b8d99997c}{SENTINEL\_SIMFAILURE\_CRASH\_AFTER\_ELECTION};
03171                 serverLog(\hyperlink{server_8h_a31229b9334bba7d6be2a72970967a14b}{LL\_WARNING},\textcolor{stringliteral}{"Failure simulation: this Sentinel "}
03172                     \textcolor{stringliteral}{"will crash after being successfully elected as failover "}
03173                     \textcolor{stringliteral}{"leader"});
03174             \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(c->argv[j]->ptr,\textcolor{stringliteral}{"crash-after-promotion"})) \{
03175                 sentinel.simfailure\_flags |=
03176                     \hyperlink{sentinel_8c_a87a09f4dcf854cc0b26dc8dc328ab7c3}{SENTINEL\_SIMFAILURE\_CRASH\_AFTER\_PROMOTION}
      ;
03177                 serverLog(\hyperlink{server_8h_a31229b9334bba7d6be2a72970967a14b}{LL\_WARNING},\textcolor{stringliteral}{"Failure simulation: this Sentinel "}
03178                     \textcolor{stringliteral}{"will crash after promoting the selected slave to master"});
03179             \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(c->argv[j]->ptr,\textcolor{stringliteral}{"help"})) \{
03180                 addReplyMultiBulkLen(c,2);
03181                 addReplyBulkCString(c,\textcolor{stringliteral}{"crash-after-election"});
03182                 addReplyBulkCString(c,\textcolor{stringliteral}{"crash-after-promotion"});
03183             \} \textcolor{keywordflow}{else} \{
03184                 addReplyError(c,\textcolor{stringliteral}{"Unknown failure simulation specified"});
03185                 \textcolor{keywordflow}{return};
03186             \}
03187         \}
03188         addReply(c,shared.ok);
03189     \} \textcolor{keywordflow}{else} \{
03190         addReplyErrorFormat(c,\textcolor{stringliteral}{"Unknown sentinel subcommand '%s'"},
03191                                (\textcolor{keywordtype}{char}*)c->argv[1]->ptr);
03192     \}
03193     \textcolor{keywordflow}{return};
03194 
03195 numargserr:
03196     addReplyErrorFormat(c,\textcolor{stringliteral}{"Wrong number of arguments for 'sentinel %s'"},
03197                           (\textcolor{keywordtype}{char}*)c->argv[1]->ptr);
03198 \}
03199 
03200 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{info\_section\_from\_redis}\textcolor{preprocessor}{(}\textcolor{preprocessor}{section\_name}\textcolor{preprocessor}{)} \textcolor{keywordflow}{do} \textcolor{preprocessor}{\{}
03201     \textcolor{keywordflow}{if} \textcolor{preprocessor}{(}\textcolor{preprocessor}{defsections} \textcolor{preprocessor}{||} \textcolor{preprocessor}{allsections} \textcolor{preprocessor}{||} \textcolor{preprocessor}{!}\textcolor{preprocessor}{strcasecmp}\textcolor{preprocessor}{(}\textcolor{preprocessor}{section}\textcolor{preprocessor}{,}\textcolor{preprocessor}{section\_name}\textcolor{preprocessor}{)}\textcolor{preprocessor}{)} \textcolor{preprocessor}{\{}
03202         \textcolor{preprocessor}{sds} \textcolor{preprocessor}{redissection}\textcolor{preprocessor}{;}
03203         \textcolor{keywordflow}{if} \textcolor{preprocessor}{(}\textcolor{preprocessor}{sections}\textcolor{preprocessor}{++}\textcolor{preprocessor}{)} \textcolor{preprocessor}{info} \textcolor{preprocessor}{=} \textcolor{preprocessor}{sdscat}\textcolor{preprocessor}{(}\textcolor{preprocessor}{info}\textcolor{preprocessor}{,}\textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}\textcolor{preprocessor}{)}\textcolor{preprocessor}{;}
03204         \textcolor{preprocessor}{redissection} \textcolor{preprocessor}{=} \textcolor{preprocessor}{genRedisInfoString}\textcolor{preprocessor}{(}\textcolor{preprocessor}{section\_name}\textcolor{preprocessor}{)}\textcolor{preprocessor}{;}
03205         \textcolor{preprocessor}{info} \textcolor{preprocessor}{=} \textcolor{preprocessor}{sdscatlen}\textcolor{preprocessor}{(}\textcolor{preprocessor}{info}\textcolor{preprocessor}{,}\textcolor{preprocessor}{redissection}\textcolor{preprocessor}{,}\textcolor{preprocessor}{sdslen}\textcolor{preprocessor}{(}\textcolor{preprocessor}{redissection}\textcolor{preprocessor}{)}\textcolor{preprocessor}{)}\textcolor{preprocessor}{;}
03206         \textcolor{preprocessor}{sdsfree}\textcolor{preprocessor}{(}\textcolor{preprocessor}{redissection}\textcolor{preprocessor}{)}\textcolor{preprocessor}{;}
03207     \textcolor{preprocessor}{\}} \textcolor{preprocessor}{\(\backslash\)}
03208 \textcolor{preprocessor}{\}}\textcolor{keywordflow}{while}\textcolor{preprocessor}{(}0\textcolor{preprocessor}{)}
03209 
03210 \textcolor{comment}{/* SENTINEL INFO [section] */}
03211 \textcolor{keywordtype}{void} sentinelInfoCommand(\hyperlink{structclient}{client} *c) \{
03212     \textcolor{keywordflow}{if} (c->argc > 2) \{
03213         addReply(c,shared.syntaxerr);
03214         \textcolor{keywordflow}{return};
03215     \}
03216 
03217     \textcolor{keywordtype}{int} defsections = 0, allsections = 0;
03218     \textcolor{keywordtype}{char} *section = c->argc == 2 ? c->argv[1]->ptr : NULL;
03219     \textcolor{keywordflow}{if} (section) \{
03220         allsections = !strcasecmp(section,\textcolor{stringliteral}{"all"});
03221         defsections = !strcasecmp(section,\textcolor{stringliteral}{"default"});
03222     \} \textcolor{keywordflow}{else} \{
03223         defsections = 1;
03224     \}
03225 
03226     \textcolor{keywordtype}{int} sections = 0;
03227     sds info = sdsempty();
03228 
03229     \hyperlink{sentinel_8c_a85a6933ebbf5e518c3767fcf950429b9}{info\_section\_from\_redis}(\textcolor{stringliteral}{"server"});
03230     \hyperlink{sentinel_8c_a85a6933ebbf5e518c3767fcf950429b9}{info\_section\_from\_redis}(\textcolor{stringliteral}{"clients"});
03231     \hyperlink{sentinel_8c_a85a6933ebbf5e518c3767fcf950429b9}{info\_section\_from\_redis}(\textcolor{stringliteral}{"cpu"});
03232     \hyperlink{sentinel_8c_a85a6933ebbf5e518c3767fcf950429b9}{info\_section\_from\_redis}(\textcolor{stringliteral}{"stats"});
03233 
03234     \textcolor{keywordflow}{if} (defsections || allsections || !strcasecmp(section,\textcolor{stringliteral}{"sentinel"})) \{
03235         dictIterator *di;
03236         dictEntry *de;
03237         \textcolor{keywordtype}{int} master\_id = 0;
03238 
03239         \textcolor{keywordflow}{if} (sections++) info = sdscat(info,\textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"});
03240         info = sdscatprintf(info,
03241             \textcolor{stringliteral}{"# Sentinel\(\backslash\)r\(\backslash\)n"}
03242             \textcolor{stringliteral}{"sentinel\_masters:%lu\(\backslash\)r\(\backslash\)n"}
03243             \textcolor{stringliteral}{"sentinel\_tilt:%d\(\backslash\)r\(\backslash\)n"}
03244             \textcolor{stringliteral}{"sentinel\_running\_scripts:%d\(\backslash\)r\(\backslash\)n"}
03245             \textcolor{stringliteral}{"sentinel\_scripts\_queue\_length:%ld\(\backslash\)r\(\backslash\)n"}
03246             \textcolor{stringliteral}{"sentinel\_simulate\_failure\_flags:%lu\(\backslash\)r\(\backslash\)n"},
03247             \hyperlink{dict_8h_af193430dd3d5579a52b194512f72c1f0}{dictSize}(sentinel.masters),
03248             sentinel.tilt,
03249             sentinel.running\_scripts,
03250             \hyperlink{adlist_8h_afde0ab079f934670e82119b43120e94b}{listLength}(sentinel.scripts\_queue),
03251             sentinel.simfailure\_flags);
03252 
03253         di = dictGetIterator(sentinel.masters);
03254         \textcolor{keywordflow}{while}((de = dictNext(di)) != NULL) \{
03255             sentinelRedisInstance *ri = \hyperlink{dict_8h_ae8d2cc391873b2bea2b87c4f80f43120}{dictGetVal}(de);
03256             \textcolor{keywordtype}{char} *status = \textcolor{stringliteral}{"ok"};
03257 
03258             \textcolor{keywordflow}{if} (ri->flags & \hyperlink{sentinel_8c_a3bbbca05543cd9d9f86d276e2c7c719c}{SRI\_O\_DOWN}) status = \textcolor{stringliteral}{"odown"};
03259             \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (ri->flags & \hyperlink{sentinel_8c_a8e26596c8bde451c2dd9cecb2c3046d4}{SRI\_S\_DOWN}) status = \textcolor{stringliteral}{"sdown"};
03260             info = sdscatprintf(info,
03261                 \textcolor{stringliteral}{"master%d:name=%s,status=%s,address=%s:%d,"}
03262                 \textcolor{stringliteral}{"slaves=%lu,sentinels=%lu\(\backslash\)r\(\backslash\)n"},
03263                 master\_id++, ri->name, status,
03264                 ri->addr->ip, ri->addr->port,
03265                 \hyperlink{dict_8h_af193430dd3d5579a52b194512f72c1f0}{dictSize}(ri->slaves),
03266                 \hyperlink{dict_8h_af193430dd3d5579a52b194512f72c1f0}{dictSize}(ri->sentinels)+1);
03267         \}
03268         dictReleaseIterator(di);
03269     \}
03270 
03271     addReplyBulkSds(c, info);
03272 \}
03273 
03274 \textcolor{comment}{/* Implements Sentinel verison of the ROLE command. The output is}
03275 \textcolor{comment}{ * "sentinel" and the list of currently monitored master names. */}
03276 \textcolor{keywordtype}{void} sentinelRoleCommand(\hyperlink{structclient}{client} *c) \{
03277     dictIterator *di;
03278     dictEntry *de;
03279 
03280     addReplyMultiBulkLen(c,2);
03281     addReplyBulkCBuffer(c,\textcolor{stringliteral}{"sentinel"},8);
03282     addReplyMultiBulkLen(c,\hyperlink{dict_8h_af193430dd3d5579a52b194512f72c1f0}{dictSize}(sentinel.masters));
03283 
03284     di = dictGetIterator(sentinel.masters);
03285     \textcolor{keywordflow}{while}((de = dictNext(di)) != NULL) \{
03286         sentinelRedisInstance *ri = \hyperlink{dict_8h_ae8d2cc391873b2bea2b87c4f80f43120}{dictGetVal}(de);
03287 
03288         addReplyBulkCString(c,ri->name);
03289     \}
03290     dictReleaseIterator(di);
03291 \}
03292 
03293 \textcolor{comment}{/* SENTINEL SET <mastername> [<option> <value> ...] */}
03294 \textcolor{keywordtype}{void} sentinelSetCommand(\hyperlink{structclient}{client} *c) \{
03295     sentinelRedisInstance *ri;
03296     \textcolor{keywordtype}{int} j, changes = 0;
03297     \textcolor{keywordtype}{char} *option, *value;
03298 
03299     \textcolor{keywordflow}{if} ((ri = sentinelGetMasterByNameOrReplyError(c,c->argv[2]))
03300         == NULL) \textcolor{keywordflow}{return};
03301 
03302     \textcolor{comment}{/* Process option - value pairs. */}
03303     \textcolor{keywordflow}{for} (j = 3; j < c->argc; j += 2) \{
03304         option = c->argv[j]->ptr;
03305         value = c->argv[j+1]->ptr;
03306         robj *o = c->argv[j+1];
03307         \textcolor{keywordtype}{long} \textcolor{keywordtype}{long} ll;
03308 
03309         \textcolor{keywordflow}{if} (!strcasecmp(option,\textcolor{stringliteral}{"down-after-milliseconds"})) \{
03310             \textcolor{comment}{/* down-after-millisecodns <milliseconds> */}
03311             \textcolor{keywordflow}{if} (getLongLongFromObject(o,&ll) == \hyperlink{server_8h_af98ac28d5f4d23d7ed5985188e6fb7d1}{C\_ERR} || ll <= 0)
03312                 \textcolor{keywordflow}{goto} badfmt;
03313             ri->down\_after\_period = ll;
03314             sentinelPropagateDownAfterPeriod(ri);
03315             changes++;
03316         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(option,\textcolor{stringliteral}{"failover-timeout"})) \{
03317             \textcolor{comment}{/* failover-timeout <milliseconds> */}
03318             \textcolor{keywordflow}{if} (getLongLongFromObject(o,&ll) == \hyperlink{server_8h_af98ac28d5f4d23d7ed5985188e6fb7d1}{C\_ERR} || ll <= 0)
03319                 \textcolor{keywordflow}{goto} badfmt;
03320             ri->failover\_timeout = ll;
03321             changes++;
03322        \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(option,\textcolor{stringliteral}{"parallel-syncs"})) \{
03323             \textcolor{comment}{/* parallel-syncs <milliseconds> */}
03324             \textcolor{keywordflow}{if} (getLongLongFromObject(o,&ll) == \hyperlink{server_8h_af98ac28d5f4d23d7ed5985188e6fb7d1}{C\_ERR} || ll <= 0)
03325                 \textcolor{keywordflow}{goto} badfmt;
03326             ri->parallel\_syncs = ll;
03327             changes++;
03328        \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(option,\textcolor{stringliteral}{"notification-script"})) \{
03329             \textcolor{comment}{/* notification-script <path> */}
03330             \textcolor{keywordflow}{if} (strlen(value) && access(value,X\_OK) == -1) \{
03331                 addReplyError(c,
03332                     \textcolor{stringliteral}{"Notification script seems non existing or non executable"});
03333                 \textcolor{keywordflow}{if} (changes) sentinelFlushConfig();
03334                 \textcolor{keywordflow}{return};
03335             \}
03336             sdsfree(ri->notification\_script);
03337             ri->notification\_script = strlen(value) ? sdsnew(value) : NULL;
03338             changes++;
03339        \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(option,\textcolor{stringliteral}{"client-reconfig-script"})) \{
03340             \textcolor{comment}{/* client-reconfig-script <path> */}
03341             \textcolor{keywordflow}{if} (strlen(value) && access(value,X\_OK) == -1) \{
03342                 addReplyError(c,
03343                     \textcolor{stringliteral}{"Client reconfiguration script seems non existing or "}
03344                     \textcolor{stringliteral}{"non executable"});
03345                 \textcolor{keywordflow}{if} (changes) sentinelFlushConfig();
03346                 \textcolor{keywordflow}{return};
03347             \}
03348             sdsfree(ri->client\_reconfig\_script);
03349             ri->client\_reconfig\_script = strlen(value) ? sdsnew(value) : NULL;
03350             changes++;
03351        \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(option,\textcolor{stringliteral}{"auth-pass"})) \{
03352             \textcolor{comment}{/* auth-pass <password> */}
03353             sdsfree(ri->auth\_pass);
03354             ri->auth\_pass = strlen(value) ? sdsnew(value) : NULL;
03355             changes++;
03356        \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcasecmp(option,\textcolor{stringliteral}{"quorum"})) \{
03357             \textcolor{comment}{/* quorum <count> */}
03358             \textcolor{keywordflow}{if} (getLongLongFromObject(o,&ll) == \hyperlink{server_8h_af98ac28d5f4d23d7ed5985188e6fb7d1}{C\_ERR} || ll <= 0)
03359                 \textcolor{keywordflow}{goto} badfmt;
03360             ri->quorum = ll;
03361             changes++;
03362         \} \textcolor{keywordflow}{else} \{
03363             addReplyErrorFormat(c,\textcolor{stringliteral}{"Unknown option '%s' for SENTINEL SET"},
03364                 option);
03365             \textcolor{keywordflow}{if} (changes) sentinelFlushConfig();
03366             \textcolor{keywordflow}{return};
03367         \}
03368         sentinelEvent(\hyperlink{server_8h_a31229b9334bba7d6be2a72970967a14b}{LL\_WARNING},\textcolor{stringliteral}{"+set"},ri,\textcolor{stringliteral}{"%@ %s %s"},option,value);
03369     \}
03370 
03371     \textcolor{keywordflow}{if} (changes) sentinelFlushConfig();
03372     addReply(c,shared.ok);
03373     \textcolor{keywordflow}{return};
03374 
03375 badfmt: \textcolor{comment}{/* Bad format errors */}
03376     \textcolor{keywordflow}{if} (changes) sentinelFlushConfig();
03377     addReplyErrorFormat(c,\textcolor{stringliteral}{"Invalid argument '%s' for SENTINEL SET '%s'"},
03378             value, option);
03379 \}
03380 
03381 \textcolor{comment}{/* Our fake PUBLISH command: it is actually useful only to receive hello messages}
03382 \textcolor{comment}{ * from the other sentinel instances, and publishing to a channel other than}
03383 \textcolor{comment}{ * SENTINEL\_HELLO\_CHANNEL is forbidden.}
03384 \textcolor{comment}{ *}
03385 \textcolor{comment}{ * Because we have a Sentinel PUBLISH, the code to send hello messages is the same}
03386 \textcolor{comment}{ * for all the three kind of instances: masters, slaves, sentinels. */}
03387 \textcolor{keywordtype}{void} sentinelPublishCommand(\hyperlink{structclient}{client} *c) \{
03388     \textcolor{keywordflow}{if} (strcmp(c->argv[1]->ptr,\hyperlink{sentinel_8c_aa57e3638aae4eec03d29f247b1611569}{SENTINEL\_HELLO\_CHANNEL})) \{
03389         addReplyError(c, \textcolor{stringliteral}{"Only HELLO messages are accepted by Sentinel instances."});
03390         \textcolor{keywordflow}{return};
03391     \}
03392     sentinelProcessHelloMessage(c->argv[2]->ptr,sdslen(c->argv[2]->ptr));
03393     addReplyLongLong(c,1);
03394 \}
03395 
03396 \textcolor{comment}{/* ===================== SENTINEL availability checks ======================= */}
03397 
03398 \textcolor{comment}{/* Is this instance down from our point of view? */}
03399 \textcolor{keywordtype}{void} sentinelCheckSubjectivelyDown(sentinelRedisInstance *ri) \{
03400     mstime\_t elapsed = 0;
03401 
03402     \textcolor{keywordflow}{if} (ri->link->act\_ping\_time)
03403         elapsed = mstime() - ri->link->act\_ping\_time;
03404     \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (ri->link->disconnected)
03405         elapsed = mstime() - ri->link->last\_avail\_time;
03406 
03407     \textcolor{comment}{/* Check if we are in need for a reconnection of one of the}
03408 \textcolor{comment}{     * links, because we are detecting low activity.}
03409 \textcolor{comment}{     *}
03410 \textcolor{comment}{     * 1) Check if the command link seems connected, was connected not less}
03411 \textcolor{comment}{     *    than SENTINEL\_MIN\_LINK\_RECONNECT\_PERIOD, but still we have a}
03412 \textcolor{comment}{     *    pending ping for more than half the timeout. */}
03413     \textcolor{keywordflow}{if} (ri->link->cc &&
03414         (mstime() - ri->link->cc\_conn\_time) >
03415         \hyperlink{sentinel_8c_a55d7c0bf374af4867e1baaf1fc0860c3}{SENTINEL\_MIN\_LINK\_RECONNECT\_PERIOD} &&
03416         ri->link->act\_ping\_time != 0 && \textcolor{comment}{/* Ther is a pending ping... */}
03417         \textcolor{comment}{/* The pending ping is delayed, and we did not received}
03418 \textcolor{comment}{         * error replies as well. */}
03419         (mstime() - ri->link->act\_ping\_time) > (ri->down\_after\_period/2) &&
03420         (mstime() - ri->link->last\_pong\_time) > (ri->down\_after\_period/2))
03421     \{
03422         instanceLinkCloseConnection(ri->link,ri->link->cc);
03423     \}
03424 
03425     \textcolor{comment}{/* 2) Check if the pubsub link seems connected, was connected not less}
03426 \textcolor{comment}{     *    than SENTINEL\_MIN\_LINK\_RECONNECT\_PERIOD, but still we have no}
03427 \textcolor{comment}{     *    activity in the Pub/Sub channel for more than}
03428 \textcolor{comment}{     *    SENTINEL\_PUBLISH\_PERIOD * 3.}
03429 \textcolor{comment}{     */}
03430     \textcolor{keywordflow}{if} (ri->link->pc &&
03431         (mstime() - ri->link->pc\_conn\_time) >
03432          \hyperlink{sentinel_8c_a55d7c0bf374af4867e1baaf1fc0860c3}{SENTINEL\_MIN\_LINK\_RECONNECT\_PERIOD} &&
03433         (mstime() - ri->link->pc\_last\_activity) > (\hyperlink{sentinel_8c_a062c8bab2521f90dac2df11cf77c3bf0}{SENTINEL\_PUBLISH\_PERIOD}*3))
03434     \{
03435         instanceLinkCloseConnection(ri->link,ri->link->pc);
03436     \}
03437 
03438     \textcolor{comment}{/* Update the SDOWN flag. We believe the instance is SDOWN if:}
03439 \textcolor{comment}{     *}
03440 \textcolor{comment}{     * 1) It is not replying.}
03441 \textcolor{comment}{     * 2) We believe it is a master, it reports to be a slave for enough time}
03442 \textcolor{comment}{     *    to meet the down\_after\_period, plus enough time to get two times}
03443 \textcolor{comment}{     *    INFO report from the instance. */}
03444     \textcolor{keywordflow}{if} (elapsed > ri->down\_after\_period ||
03445         (ri->flags & \hyperlink{sentinel_8c_a2ee83e5ff67b45746cd6a310f15334b2}{SRI\_MASTER} &&
03446          ri->role\_reported == \hyperlink{sentinel_8c_a4b9db21eda79d49bd9fdf2cf7b3178e8}{SRI\_SLAVE} &&
03447          mstime() - ri->role\_reported\_time >
03448           (ri->down\_after\_period+\hyperlink{sentinel_8c_ac6a2144aa06344ed8547176a4e3cfaa5}{SENTINEL\_INFO\_PERIOD}*2)))
03449     \{
03450         \textcolor{comment}{/* Is subjectively down */}
03451         \textcolor{keywordflow}{if} ((ri->flags & \hyperlink{sentinel_8c_a8e26596c8bde451c2dd9cecb2c3046d4}{SRI\_S\_DOWN}) == 0) \{
03452             sentinelEvent(\hyperlink{server_8h_a31229b9334bba7d6be2a72970967a14b}{LL\_WARNING},\textcolor{stringliteral}{"+sdown"},ri,\textcolor{stringliteral}{"%@"});
03453             ri->s\_down\_since\_time = mstime();
03454             ri->flags |= \hyperlink{sentinel_8c_a8e26596c8bde451c2dd9cecb2c3046d4}{SRI\_S\_DOWN};
03455         \}
03456     \} \textcolor{keywordflow}{else} \{
03457         \textcolor{comment}{/* Is subjectively up */}
03458         \textcolor{keywordflow}{if} (ri->flags & \hyperlink{sentinel_8c_a8e26596c8bde451c2dd9cecb2c3046d4}{SRI\_S\_DOWN}) \{
03459             sentinelEvent(\hyperlink{server_8h_a31229b9334bba7d6be2a72970967a14b}{LL\_WARNING},\textcolor{stringliteral}{"-sdown"},ri,\textcolor{stringliteral}{"%@"});
03460             ri->flags &= ~(\hyperlink{sentinel_8c_a8e26596c8bde451c2dd9cecb2c3046d4}{SRI\_S\_DOWN}|\hyperlink{sentinel_8c_a8deaaf376eb76dcf5ab4ca652df3a52b}{SRI\_SCRIPT\_KILL\_SENT});
03461         \}
03462     \}
03463 \}
03464 
03465 \textcolor{comment}{/* Is this instance down according to the configured quorum?}
03466 \textcolor{comment}{ *}
03467 \textcolor{comment}{ * Note that ODOWN is a weak quorum, it only means that enough Sentinels}
03468 \textcolor{comment}{ * reported in a given time range that the instance was not reachable.}
03469 \textcolor{comment}{ * However messages can be delayed so there are no strong guarantees about}
03470 \textcolor{comment}{ * N instances agreeing at the same time about the down state. */}
03471 \textcolor{keywordtype}{void} sentinelCheckObjectivelyDown(sentinelRedisInstance *master) \{
03472     dictIterator *di;
03473     dictEntry *de;
03474     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} quorum = 0, odown = 0;
03475 
03476     \textcolor{keywordflow}{if} (master->flags & \hyperlink{sentinel_8c_a8e26596c8bde451c2dd9cecb2c3046d4}{SRI\_S\_DOWN}) \{
03477         \textcolor{comment}{/* Is down for enough sentinels? */}
03478         quorum = 1; \textcolor{comment}{/* the current sentinel. */}
03479         \textcolor{comment}{/* Count all the other sentinels. */}
03480         di = dictGetIterator(master->sentinels);
03481         \textcolor{keywordflow}{while}((de = dictNext(di)) != NULL) \{
03482             sentinelRedisInstance *ri = \hyperlink{dict_8h_ae8d2cc391873b2bea2b87c4f80f43120}{dictGetVal}(de);
03483 
03484             \textcolor{keywordflow}{if} (ri->flags & \hyperlink{sentinel_8c_a80003592a6337bdc484182ff1d33e41c}{SRI\_MASTER\_DOWN}) quorum++;
03485         \}
03486         dictReleaseIterator(di);
03487         \textcolor{keywordflow}{if} (quorum >= master->quorum) odown = 1;
03488     \}
03489 
03490     \textcolor{comment}{/* Set the flag accordingly to the outcome. */}
03491     \textcolor{keywordflow}{if} (odown) \{
03492         \textcolor{keywordflow}{if} ((master->flags & \hyperlink{sentinel_8c_a3bbbca05543cd9d9f86d276e2c7c719c}{SRI\_O\_DOWN}) == 0) \{
03493             sentinelEvent(\hyperlink{server_8h_a31229b9334bba7d6be2a72970967a14b}{LL\_WARNING},\textcolor{stringliteral}{"+odown"},master,\textcolor{stringliteral}{"%@ #quorum %d/%d"},
03494                 quorum, master->quorum);
03495             master->flags |= \hyperlink{sentinel_8c_a3bbbca05543cd9d9f86d276e2c7c719c}{SRI\_O\_DOWN};
03496             master->o\_down\_since\_time = mstime();
03497         \}
03498     \} \textcolor{keywordflow}{else} \{
03499         \textcolor{keywordflow}{if} (master->flags & \hyperlink{sentinel_8c_a3bbbca05543cd9d9f86d276e2c7c719c}{SRI\_O\_DOWN}) \{
03500             sentinelEvent(\hyperlink{server_8h_a31229b9334bba7d6be2a72970967a14b}{LL\_WARNING},\textcolor{stringliteral}{"-odown"},master,\textcolor{stringliteral}{"%@"});
03501             master->flags &= ~\hyperlink{sentinel_8c_a3bbbca05543cd9d9f86d276e2c7c719c}{SRI\_O\_DOWN};
03502         \}
03503     \}
03504 \}
03505 
03506 \textcolor{comment}{/* Receive the SENTINEL is-master-down-by-addr reply, see the}
03507 \textcolor{comment}{ * sentinelAskMasterStateToOtherSentinels() function for more information. */}
03508 \textcolor{keywordtype}{void} sentinelReceiveIsMasterDownReply(redisAsyncContext *c, \textcolor{keywordtype}{void} *reply, \textcolor{keywordtype}{void} *privdata) \{
03509     sentinelRedisInstance *ri = privdata;
03510     \hyperlink{structinstanceLink}{instanceLink} *link = c->data;
03511     redisReply *r;
03512 
03513     \textcolor{keywordflow}{if} (!reply || !link) \textcolor{keywordflow}{return};
03514     link->pending\_commands--;
03515     r = reply;
03516 
03517     \textcolor{comment}{/* Ignore every error or unexpected reply.}
03518 \textcolor{comment}{     * Note that if the command returns an error for any reason we'll}
03519 \textcolor{comment}{     * end clearing the SRI\_MASTER\_DOWN flag for timeout anyway. */}
03520     \textcolor{keywordflow}{if} (r->type == REDIS\_REPLY\_ARRAY && r->elements == 3 &&
03521         r->element[0]->type == REDIS\_REPLY\_INTEGER &&
03522         r->element[1]->type == REDIS\_REPLY\_STRING &&
03523         r->element[2]->type == REDIS\_REPLY\_INTEGER)
03524     \{
03525         ri->last\_master\_down\_reply\_time = mstime();
03526         \textcolor{keywordflow}{if} (r->element[0]->integer == 1) \{
03527             ri->flags |= \hyperlink{sentinel_8c_a80003592a6337bdc484182ff1d33e41c}{SRI\_MASTER\_DOWN};
03528         \} \textcolor{keywordflow}{else} \{
03529             ri->flags &= ~\hyperlink{sentinel_8c_a80003592a6337bdc484182ff1d33e41c}{SRI\_MASTER\_DOWN};
03530         \}
03531         \textcolor{keywordflow}{if} (strcmp(r->element[1]->str,\textcolor{stringliteral}{"*"})) \{
03532             \textcolor{comment}{/* If the runid in the reply is not "*" the Sentinel actually}
03533 \textcolor{comment}{             * replied with a vote. */}
03534             sdsfree(ri->leader);
03535             \textcolor{keywordflow}{if} ((\textcolor{keywordtype}{long} \textcolor{keywordtype}{long})ri->leader\_epoch != r->element[2]->integer)
03536                 serverLog(\hyperlink{server_8h_a31229b9334bba7d6be2a72970967a14b}{LL\_WARNING},
03537                     \textcolor{stringliteral}{"%s voted for %s %llu"}, ri->name,
03538                     r->element[1]->str,
03539                     (\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{long} \textcolor{keywordtype}{long}) r->element[2]->integer);
03540             ri->leader = sdsnew(r->element[1]->str);
03541             ri->leader\_epoch = r->element[2]->integer;
03542         \}
03543     \}
03544 \}
03545 
03546 \textcolor{comment}{/* If we think the master is down, we start sending}
03547 \textcolor{comment}{ * SENTINEL IS-MASTER-DOWN-BY-ADDR requests to other sentinels}
03548 \textcolor{comment}{ * in order to get the replies that allow to reach the quorum}
03549 \textcolor{comment}{ * needed to mark the master in ODOWN state and trigger a failover. */}
03550 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{SENTINEL\_ASK\_FORCED} \textcolor{preprocessor}{(}1\textcolor{preprocessor}{<<}0\textcolor{preprocessor}{)}
03551 \textcolor{keywordtype}{void} sentinelAskMasterStateToOtherSentinels(sentinelRedisInstance *master, \textcolor{keywordtype}{int} flags) \{
03552     dictIterator *di;
03553     dictEntry *de;
03554 
03555     di = dictGetIterator(master->sentinels);
03556     \textcolor{keywordflow}{while}((de = dictNext(di)) != NULL) \{
03557         sentinelRedisInstance *ri = \hyperlink{dict_8h_ae8d2cc391873b2bea2b87c4f80f43120}{dictGetVal}(de);
03558         mstime\_t elapsed = mstime() - ri->last\_master\_down\_reply\_time;
03559         \textcolor{keywordtype}{char} port[32];
03560         \textcolor{keywordtype}{int} retval;
03561 
03562         \textcolor{comment}{/* If the master state from other sentinel is too old, we clear it. */}
03563         \textcolor{keywordflow}{if} (elapsed > \hyperlink{sentinel_8c_a37ec7767004d923e7163195f50373d80}{SENTINEL\_ASK\_PERIOD}*5) \{
03564             ri->flags &= ~\hyperlink{sentinel_8c_a80003592a6337bdc484182ff1d33e41c}{SRI\_MASTER\_DOWN};
03565             sdsfree(ri->leader);
03566             ri->leader = NULL;
03567         \}
03568 
03569         \textcolor{comment}{/* Only ask if master is down to other sentinels if:}
03570 \textcolor{comment}{         *}
03571 \textcolor{comment}{         * 1) We believe it is down, or there is a failover in progress.}
03572 \textcolor{comment}{         * 2) Sentinel is connected.}
03573 \textcolor{comment}{         * 3) We did not received the info within SENTINEL\_ASK\_PERIOD ms. */}
03574         \textcolor{keywordflow}{if} ((master->flags & \hyperlink{sentinel_8c_a8e26596c8bde451c2dd9cecb2c3046d4}{SRI\_S\_DOWN}) == 0) \textcolor{keywordflow}{continue};
03575         \textcolor{keywordflow}{if} (ri->link->disconnected) \textcolor{keywordflow}{continue};
03576         \textcolor{keywordflow}{if} (!(flags & \hyperlink{sentinel_8c_a166080e23b7691124260c5ea1b053380}{SENTINEL\_ASK\_FORCED}) &&
03577             mstime() - ri->last\_master\_down\_reply\_time < 
      \hyperlink{sentinel_8c_a37ec7767004d923e7163195f50373d80}{SENTINEL\_ASK\_PERIOD})
03578             \textcolor{keywordflow}{continue};
03579 
03580         \textcolor{comment}{/* Ask */}
03581         ll2string(port,\textcolor{keyword}{sizeof}(port),master->addr->port);
03582         retval = redisAsyncCommand(ri->link->cc,
03583                     sentinelReceiveIsMasterDownReply, ri,
03584                     \textcolor{stringliteral}{"SENTINEL is-master-down-by-addr %s %s %llu %s"},
03585                     master->addr->ip, port,
03586                     sentinel.current\_epoch,
03587                     (master->failover\_state > \hyperlink{sentinel_8c_a23bad5aa23e7b1a930ad4aa535938efb}{SENTINEL\_FAILOVER\_STATE\_NONE}
      ) ?
03588                     sentinel.myid : \textcolor{stringliteral}{"*"});
03589         \textcolor{keywordflow}{if} (retval == \hyperlink{server_8h_a303769ef1065076e68731584e758d3e1}{C\_OK}) ri->link->pending\_commands++;
03590     \}
03591     dictReleaseIterator(di);
03592 \}
03593 
03594 \textcolor{comment}{/* =============================== FAILOVER ================================= */}
03595 
03596 \textcolor{comment}{/* Crash because of user request via SENTINEL simulate-failure command. */}
03597 \textcolor{keywordtype}{void} sentinelSimFailureCrash(\textcolor{keywordtype}{void}) \{
03598     serverLog(\hyperlink{server_8h_a31229b9334bba7d6be2a72970967a14b}{LL\_WARNING},
03599         \textcolor{stringliteral}{"Sentinel CRASH because of SENTINEL simulate-failure"});
03600     exit(99);
03601 \}
03602 
03603 \textcolor{comment}{/* Vote for the sentinel with 'req\_runid' or return the old vote if already}
03604 \textcolor{comment}{ * voted for the specifed 'req\_epoch' or one greater.}
03605 \textcolor{comment}{ *}
03606 \textcolor{comment}{ * If a vote is not available returns NULL, otherwise return the Sentinel}
03607 \textcolor{comment}{ * runid and populate the leader\_epoch with the epoch of the vote. */}
03608 \textcolor{keywordtype}{char} *sentinelVoteLeader(sentinelRedisInstance *master, uint64\_t req\_epoch, \textcolor{keywordtype}{char} *req\_runid, uint64\_t 
      *leader\_epoch) \{
03609     \textcolor{keywordflow}{if} (req\_epoch > sentinel.current\_epoch) \{
03610         sentinel.current\_epoch = req\_epoch;
03611         sentinelFlushConfig();
03612         sentinelEvent(\hyperlink{server_8h_a31229b9334bba7d6be2a72970967a14b}{LL\_WARNING},\textcolor{stringliteral}{"+new-epoch"},master,\textcolor{stringliteral}{"%llu"},
03613             (\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{long} \textcolor{keywordtype}{long}) sentinel.current\_epoch);
03614     \}
03615 
03616     \textcolor{keywordflow}{if} (master->leader\_epoch < req\_epoch && sentinel.current\_epoch <= req\_epoch)
03617     \{
03618         sdsfree(master->leader);
03619         master->leader = sdsnew(req\_runid);
03620         master->leader\_epoch = sentinel.current\_epoch;
03621         sentinelFlushConfig();
03622         sentinelEvent(\hyperlink{server_8h_a31229b9334bba7d6be2a72970967a14b}{LL\_WARNING},\textcolor{stringliteral}{"+vote-for-leader"},master,\textcolor{stringliteral}{"%s %llu"},
03623             master->leader, (\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{long} \textcolor{keywordtype}{long}) master->leader\_epoch);
03624         \textcolor{comment}{/* If we did not voted for ourselves, set the master failover start}
03625 \textcolor{comment}{         * time to now, in order to force a delay before we can start a}
03626 \textcolor{comment}{         * failover for the same master. */}
03627         \textcolor{keywordflow}{if} (strcasecmp(master->leader,sentinel.myid))
03628             master->failover\_start\_time = mstime()+rand()%
      \hyperlink{sentinel_8c_aab501d7852d456a92670860045725d5b}{SENTINEL\_MAX\_DESYNC};
03629     \}
03630 
03631     *leader\_epoch = master->leader\_epoch;
03632     \textcolor{keywordflow}{return} master->leader ? sdsnew(master->leader) : NULL;
03633 \}
03634 
\Hypertarget{sentinel_8c_source_l03635}\hyperlink{structsentinelLeader}{03635} \textcolor{keyword}{struct} \hyperlink{structsentinelLeader}{sentinelLeader} \{
03636     \textcolor{keywordtype}{char} *runid;
03637     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{long} votes;
03638 \};
03639 
03640 \textcolor{comment}{/* Helper function for sentinelGetLeader, increment the counter}
03641 \textcolor{comment}{ * relative to the specified runid. */}
03642 \textcolor{keywordtype}{int} sentinelLeaderIncr(dict *counters, \textcolor{keywordtype}{char} *runid) \{
03643     dictEntry *existing, *de;
03644     uint64\_t oldval;
03645 
03646     de = dictAddRaw(counters,runid,&existing);
03647     \textcolor{keywordflow}{if} (existing) \{
03648         oldval = \hyperlink{dict_8h_ad65abe818fa141e537800699668a7f09}{dictGetUnsignedIntegerVal}(existing);
03649         \hyperlink{dict_8h_aa846a3c28ad69004259435fd44246e10}{dictSetUnsignedIntegerVal}(existing,oldval+1);
03650         \textcolor{keywordflow}{return} oldval+1;
03651     \} \textcolor{keywordflow}{else} \{
03652         \hyperlink{server_8h_a88114b5169b4c382df6b56506285e56a}{serverAssert}(de != NULL);
03653         \hyperlink{dict_8h_aa846a3c28ad69004259435fd44246e10}{dictSetUnsignedIntegerVal}(de,1);
03654         \textcolor{keywordflow}{return} 1;
03655     \}
03656 \}
03657 
03658 \textcolor{comment}{/* Scan all the Sentinels attached to this master to check if there}
03659 \textcolor{comment}{ * is a leader for the specified epoch.}
03660 \textcolor{comment}{ *}
03661 \textcolor{comment}{ * To be a leader for a given epoch, we should have the majority of}
03662 \textcolor{comment}{ * the Sentinels we know (ever seen since the last SENTINEL RESET) that}
03663 \textcolor{comment}{ * reported the same instance as leader for the same epoch. */}
03664 \textcolor{keywordtype}{char} *sentinelGetLeader(sentinelRedisInstance *master, uint64\_t epoch) \{
03665     dict *counters;
03666     dictIterator *di;
03667     dictEntry *de;
03668     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} voters = 0, voters\_quorum;
03669     \textcolor{keywordtype}{char} *myvote;
03670     \textcolor{keywordtype}{char} *winner = NULL;
03671     uint64\_t leader\_epoch;
03672     uint64\_t max\_votes = 0;
03673 
03674     \hyperlink{server_8h_a88114b5169b4c382df6b56506285e56a}{serverAssert}(master->flags & (\hyperlink{sentinel_8c_a3bbbca05543cd9d9f86d276e2c7c719c}{SRI\_O\_DOWN}|
      \hyperlink{sentinel_8c_a0546b63633196f09fcd90957243b0798}{SRI\_FAILOVER\_IN\_PROGRESS}));
03675     counters = dictCreate(&leaderVotesDictType,NULL);
03676 
03677     voters = \hyperlink{dict_8h_af193430dd3d5579a52b194512f72c1f0}{dictSize}(master->sentinels)+1; \textcolor{comment}{/* All the other sentinels and me.*/}
03678 
03679     \textcolor{comment}{/* Count other sentinels votes */}
03680     di = dictGetIterator(master->sentinels);
03681     \textcolor{keywordflow}{while}((de = dictNext(di)) != NULL) \{
03682         sentinelRedisInstance *ri = \hyperlink{dict_8h_ae8d2cc391873b2bea2b87c4f80f43120}{dictGetVal}(de);
03683         \textcolor{keywordflow}{if} (ri->leader != NULL && ri->leader\_epoch == sentinel.current\_epoch)
03684             sentinelLeaderIncr(counters,ri->leader);
03685     \}
03686     dictReleaseIterator(di);
03687 
03688     \textcolor{comment}{/* Check what's the winner. For the winner to win, it needs two conditions:}
03689 \textcolor{comment}{     * 1) Absolute majority between voters (50% + 1).}
03690 \textcolor{comment}{     * 2) And anyway at least master->quorum votes. */}
03691     di = dictGetIterator(counters);
03692     \textcolor{keywordflow}{while}((de = dictNext(di)) != NULL) \{
03693         uint64\_t votes = \hyperlink{dict_8h_ad65abe818fa141e537800699668a7f09}{dictGetUnsignedIntegerVal}(de);
03694 
03695         \textcolor{keywordflow}{if} (votes > max\_votes) \{
03696             max\_votes = votes;
03697             winner = \hyperlink{dict_8h_a3271c334309904a3086deca94f96e46e}{dictGetKey}(de);
03698         \}
03699     \}
03700     dictReleaseIterator(di);
03701 
03702     \textcolor{comment}{/* Count this Sentinel vote:}
03703 \textcolor{comment}{     * if this Sentinel did not voted yet, either vote for the most}
03704 \textcolor{comment}{     * common voted sentinel, or for itself if no vote exists at all. */}
03705     \textcolor{keywordflow}{if} (winner)
03706         myvote = sentinelVoteLeader(master,epoch,winner,&leader\_epoch);
03707     \textcolor{keywordflow}{else}
03708         myvote = sentinelVoteLeader(master,epoch,sentinel.myid,&leader\_epoch);
03709 
03710     \textcolor{keywordflow}{if} (myvote && leader\_epoch == epoch) \{
03711         uint64\_t votes = sentinelLeaderIncr(counters,myvote);
03712 
03713         \textcolor{keywordflow}{if} (votes > max\_votes) \{
03714             max\_votes = votes;
03715             winner = myvote;
03716         \}
03717     \}
03718 
03719     voters\_quorum = voters/2+1;
03720     \textcolor{keywordflow}{if} (winner && (max\_votes < voters\_quorum || max\_votes < master->quorum))
03721         winner = NULL;
03722 
03723     winner = winner ? sdsnew(winner) : NULL;
03724     sdsfree(myvote);
03725     dictRelease(counters);
03726     \textcolor{keywordflow}{return} winner;
03727 \}
03728 
03729 \textcolor{comment}{/* Send SLAVEOF to the specified instance, always followed by a}
03730 \textcolor{comment}{ * CONFIG REWRITE command in order to store the new configuration on disk}
03731 \textcolor{comment}{ * when possible (that is, if the Redis instance is recent enough to support}
03732 \textcolor{comment}{ * config rewriting, and if the server was started with a configuration file).}
03733 \textcolor{comment}{ *}
03734 \textcolor{comment}{ * If Host is NULL the function sends "SLAVEOF NO ONE".}
03735 \textcolor{comment}{ *}
03736 \textcolor{comment}{ * The command returns C\_OK if the SLAVEOF command was accepted for}
03737 \textcolor{comment}{ * (later) delivery otherwise C\_ERR. The command replies are just}
03738 \textcolor{comment}{ * discarded. */}
03739 \textcolor{keywordtype}{int} sentinelSendSlaveOf(sentinelRedisInstance *ri, \textcolor{keywordtype}{char} *host, \textcolor{keywordtype}{int} port) \{
03740     \textcolor{keywordtype}{char} portstr[32];
03741     \textcolor{keywordtype}{int} retval;
03742 
03743     ll2string(portstr,\textcolor{keyword}{sizeof}(portstr),port);
03744 
03745     \textcolor{comment}{/* If host is NULL we send SLAVEOF NO ONE that will turn the instance}
03746 \textcolor{comment}{     * into a master. */}
03747     \textcolor{keywordflow}{if} (host == NULL) \{
03748         host = \textcolor{stringliteral}{"NO"};
03749         memcpy(portstr,\textcolor{stringliteral}{"ONE"},4);
03750     \}
03751 
03752     \textcolor{comment}{/* In order to send SLAVEOF in a safe way, we send a transaction performing}
03753 \textcolor{comment}{     * the following tasks:}
03754 \textcolor{comment}{     * 1) Reconfigure the instance according to the specified host/port params.}
03755 \textcolor{comment}{     * 2) Rewrite the configuraiton.}
03756 \textcolor{comment}{     * 3) Disconnect all clients (but this one sending the commnad) in order}
03757 \textcolor{comment}{     *    to trigger the ask-master-on-reconnection protocol for connected}
03758 \textcolor{comment}{     *    clients.}
03759 \textcolor{comment}{     *}
03760 \textcolor{comment}{     * Note that we don't check the replies returned by commands, since we}
03761 \textcolor{comment}{     * will observe instead the effects in the next INFO output. */}
03762     retval = redisAsyncCommand(ri->link->cc,
03763         sentinelDiscardReplyCallback, ri, \textcolor{stringliteral}{"MULTI"});
03764     \textcolor{keywordflow}{if} (retval == \hyperlink{server_8h_af98ac28d5f4d23d7ed5985188e6fb7d1}{C\_ERR}) \textcolor{keywordflow}{return} retval;
03765     ri->link->pending\_commands++;
03766 
03767     retval = redisAsyncCommand(ri->link->cc,
03768         sentinelDiscardReplyCallback, ri, \textcolor{stringliteral}{"SLAVEOF %s %s"}, host, portstr);
03769     \textcolor{keywordflow}{if} (retval == \hyperlink{server_8h_af98ac28d5f4d23d7ed5985188e6fb7d1}{C\_ERR}) \textcolor{keywordflow}{return} retval;
03770     ri->link->pending\_commands++;
03771 
03772     retval = redisAsyncCommand(ri->link->cc,
03773         sentinelDiscardReplyCallback, ri, \textcolor{stringliteral}{"CONFIG REWRITE"});
03774     \textcolor{keywordflow}{if} (retval == \hyperlink{server_8h_af98ac28d5f4d23d7ed5985188e6fb7d1}{C\_ERR}) \textcolor{keywordflow}{return} retval;
03775     ri->link->pending\_commands++;
03776 
03777     \textcolor{comment}{/* CLIENT KILL TYPE <type> is only supported starting from Redis 2.8.12,}
03778 \textcolor{comment}{     * however sending it to an instance not understanding this command is not}
03779 \textcolor{comment}{     * an issue because CLIENT is variadic command, so Redis will not}
03780 \textcolor{comment}{     * recognized as a syntax error, and the transaction will not fail (but}
03781 \textcolor{comment}{     * only the unsupported command will fail). */}
03782     retval = redisAsyncCommand(ri->link->cc,
03783         sentinelDiscardReplyCallback, ri, \textcolor{stringliteral}{"CLIENT KILL TYPE normal"});
03784     \textcolor{keywordflow}{if} (retval == \hyperlink{server_8h_af98ac28d5f4d23d7ed5985188e6fb7d1}{C\_ERR}) \textcolor{keywordflow}{return} retval;
03785     ri->link->pending\_commands++;
03786 
03787     retval = redisAsyncCommand(ri->link->cc,
03788         sentinelDiscardReplyCallback, ri, \textcolor{stringliteral}{"EXEC"});
03789     \textcolor{keywordflow}{if} (retval == \hyperlink{server_8h_af98ac28d5f4d23d7ed5985188e6fb7d1}{C\_ERR}) \textcolor{keywordflow}{return} retval;
03790     ri->link->pending\_commands++;
03791 
03792     \textcolor{keywordflow}{return} \hyperlink{server_8h_a303769ef1065076e68731584e758d3e1}{C\_OK};
03793 \}
03794 
03795 \textcolor{comment}{/* Setup the master state to start a failover. */}
03796 \textcolor{keywordtype}{void} sentinelStartFailover(sentinelRedisInstance *master) \{
03797     \hyperlink{server_8h_a88114b5169b4c382df6b56506285e56a}{serverAssert}(master->flags & \hyperlink{sentinel_8c_a2ee83e5ff67b45746cd6a310f15334b2}{SRI\_MASTER});
03798 
03799     master->failover\_state = \hyperlink{sentinel_8c_a83bf9fce7cbb7bf1b0723ced2d434366}{SENTINEL\_FAILOVER\_STATE\_WAIT\_START};
03800     master->flags |= \hyperlink{sentinel_8c_a0546b63633196f09fcd90957243b0798}{SRI\_FAILOVER\_IN\_PROGRESS};
03801     master->failover\_epoch = ++sentinel.current\_epoch;
03802     sentinelEvent(\hyperlink{server_8h_a31229b9334bba7d6be2a72970967a14b}{LL\_WARNING},\textcolor{stringliteral}{"+new-epoch"},master,\textcolor{stringliteral}{"%llu"},
03803         (\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{long} \textcolor{keywordtype}{long}) sentinel.current\_epoch);
03804     sentinelEvent(\hyperlink{server_8h_a31229b9334bba7d6be2a72970967a14b}{LL\_WARNING},\textcolor{stringliteral}{"+try-failover"},master,\textcolor{stringliteral}{"%@"});
03805     master->failover\_start\_time = mstime()+rand()%\hyperlink{sentinel_8c_aab501d7852d456a92670860045725d5b}{SENTINEL\_MAX\_DESYNC};
03806     master->failover\_state\_change\_time = mstime();
03807 \}
03808 
03809 \textcolor{comment}{/* This function checks if there are the conditions to start the failover,}
03810 \textcolor{comment}{ * that is:}
03811 \textcolor{comment}{ *}
03812 \textcolor{comment}{ * 1) Master must be in ODOWN condition.}
03813 \textcolor{comment}{ * 2) No failover already in progress.}
03814 \textcolor{comment}{ * 3) No failover already attempted recently.}
03815 \textcolor{comment}{ *}
03816 \textcolor{comment}{ * We still don't know if we'll win the election so it is possible that we}
03817 \textcolor{comment}{ * start the failover but that we'll not be able to act.}
03818 \textcolor{comment}{ *}
03819 \textcolor{comment}{ * Return non-zero if a failover was started. */}
03820 \textcolor{keywordtype}{int} sentinelStartFailoverIfNeeded(sentinelRedisInstance *master) \{
03821     \textcolor{comment}{/* We can't failover if the master is not in O\_DOWN state. */}
03822     \textcolor{keywordflow}{if} (!(master->flags & \hyperlink{sentinel_8c_a3bbbca05543cd9d9f86d276e2c7c719c}{SRI\_O\_DOWN})) \textcolor{keywordflow}{return} 0;
03823 
03824     \textcolor{comment}{/* Failover already in progress? */}
03825     \textcolor{keywordflow}{if} (master->flags & \hyperlink{sentinel_8c_a0546b63633196f09fcd90957243b0798}{SRI\_FAILOVER\_IN\_PROGRESS}) \textcolor{keywordflow}{return} 0;
03826 
03827     \textcolor{comment}{/* Last failover attempt started too little time ago? */}
03828     \textcolor{keywordflow}{if} (mstime() - master->failover\_start\_time <
03829         master->failover\_timeout*2)
03830     \{
03831         \textcolor{keywordflow}{if} (master->failover\_delay\_logged != master->failover\_start\_time) \{
03832             time\_t clock = (master->failover\_start\_time +
03833                             master->failover\_timeout*2) / 1000;
03834             \textcolor{keywordtype}{char} ctimebuf[26];
03835 
03836             ctime\_r(&clock,ctimebuf);
03837             ctimebuf[24] = \textcolor{stringliteral}{'\(\backslash\)0'}; \textcolor{comment}{/* Remove newline. */}
03838             master->failover\_delay\_logged = master->failover\_start\_time;
03839             serverLog(\hyperlink{server_8h_a31229b9334bba7d6be2a72970967a14b}{LL\_WARNING},
03840                 \textcolor{stringliteral}{"Next failover delay: I will not start a failover before %s"},
03841                 ctimebuf);
03842         \}
03843         \textcolor{keywordflow}{return} 0;
03844     \}
03845 
03846     sentinelStartFailover(master);
03847     \textcolor{keywordflow}{return} 1;
03848 \}
03849 
03850 \textcolor{comment}{/* Select a suitable slave to promote. The current algorithm only uses}
03851 \textcolor{comment}{ * the following parameters:}
03852 \textcolor{comment}{ *}
03853 \textcolor{comment}{ * 1) None of the following conditions: S\_DOWN, O\_DOWN, DISCONNECTED.}
03854 \textcolor{comment}{ * 2) Last time the slave replied to ping no more than 5 times the PING period.}
03855 \textcolor{comment}{ * 3) info\_refresh not older than 3 times the INFO refresh period.}
03856 \textcolor{comment}{ * 4) master\_link\_down\_time no more than:}
03857 \textcolor{comment}{ *     (now - master->s\_down\_since\_time) + (master->down\_after\_period * 10).}
03858 \textcolor{comment}{ *    Basically since the master is down from our POV, the slave reports}
03859 \textcolor{comment}{ *    to be disconnected no more than 10 times the configured down-after-period.}
03860 \textcolor{comment}{ *    This is pretty much black magic but the idea is, the master was not}
03861 \textcolor{comment}{ *    available so the slave may be lagging, but not over a certain time.}
03862 \textcolor{comment}{ *    Anyway we'll select the best slave according to replication offset.}
03863 \textcolor{comment}{ * 5) Slave priority can't be zero, otherwise the slave is discarded.}
03864 \textcolor{comment}{ *}
03865 \textcolor{comment}{ * Among all the slaves matching the above conditions we select the slave}
03866 \textcolor{comment}{ * with, in order of sorting key:}
03867 \textcolor{comment}{ *}
03868 \textcolor{comment}{ * - lower slave\_priority.}
03869 \textcolor{comment}{ * - bigger processed replication offset.}
03870 \textcolor{comment}{ * - lexicographically smaller runid.}
03871 \textcolor{comment}{ *}
03872 \textcolor{comment}{ * Basically if runid is the same, the slave that processed more commands}
03873 \textcolor{comment}{ * from the master is selected.}
03874 \textcolor{comment}{ *}
03875 \textcolor{comment}{ * The function returns the pointer to the selected slave, otherwise}
03876 \textcolor{comment}{ * NULL if no suitable slave was found.}
03877 \textcolor{comment}{ */}
03878 
03879 \textcolor{comment}{/* Helper for sentinelSelectSlave(). This is used by qsort() in order to}
03880 \textcolor{comment}{ * sort suitable slaves in a "better first" order, to take the first of}
03881 \textcolor{comment}{ * the list. */}
03882 \textcolor{keywordtype}{int} compareSlavesForPromotion(\textcolor{keyword}{const} \textcolor{keywordtype}{void} *a, \textcolor{keyword}{const} \textcolor{keywordtype}{void} *b) \{
03883     sentinelRedisInstance **sa = (sentinelRedisInstance **)a,
03884                           **sb = (sentinelRedisInstance **)b;
03885     \textcolor{keywordtype}{char} *sa\_runid, *sb\_runid;
03886 
03887     \textcolor{keywordflow}{if} ((*sa)->slave\_priority != (*sb)->slave\_priority)
03888         \textcolor{keywordflow}{return} (*sa)->slave\_priority - (*sb)->slave\_priority;
03889 
03890     \textcolor{comment}{/* If priority is the same, select the slave with greater replication}
03891 \textcolor{comment}{     * offset (processed more data from the master). */}
03892     \textcolor{keywordflow}{if} ((*sa)->slave\_repl\_offset > (*sb)->slave\_repl\_offset) \{
03893         \textcolor{keywordflow}{return} -1; \textcolor{comment}{/* a < b */}
03894     \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} ((*sa)->slave\_repl\_offset < (*sb)->slave\_repl\_offset) \{
03895         \textcolor{keywordflow}{return} 1; \textcolor{comment}{/* a > b */}
03896     \}
03897 
03898     \textcolor{comment}{/* If the replication offset is the same select the slave with that has}
03899 \textcolor{comment}{     * the lexicographically smaller runid. Note that we try to handle runid}
03900 \textcolor{comment}{     * == NULL as there are old Redis versions that don't publish runid in}
03901 \textcolor{comment}{     * INFO. A NULL runid is considered bigger than any other runid. */}
03902     sa\_runid = (*sa)->runid;
03903     sb\_runid = (*sb)->runid;
03904     \textcolor{keywordflow}{if} (sa\_runid == NULL && sb\_runid == NULL) \textcolor{keywordflow}{return} 0;
03905     \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (sa\_runid == NULL) \textcolor{keywordflow}{return} 1;  \textcolor{comment}{/* a > b */}
03906     \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (sb\_runid == NULL) \textcolor{keywordflow}{return} -1; \textcolor{comment}{/* a < b */}
03907     \textcolor{keywordflow}{return} strcasecmp(sa\_runid, sb\_runid);
03908 \}
03909 
03910 sentinelRedisInstance *sentinelSelectSlave(sentinelRedisInstance *master) \{
03911     sentinelRedisInstance **instance =
03912         zmalloc(\textcolor{keyword}{sizeof}(instance[0])*\hyperlink{dict_8h_af193430dd3d5579a52b194512f72c1f0}{dictSize}(master->slaves));
03913     sentinelRedisInstance *selected = NULL;
03914     \textcolor{keywordtype}{int} instances = 0;
03915     dictIterator *di;
03916     dictEntry *de;
03917     mstime\_t max\_master\_down\_time = 0;
03918 
03919     \textcolor{keywordflow}{if} (master->flags & \hyperlink{sentinel_8c_a8e26596c8bde451c2dd9cecb2c3046d4}{SRI\_S\_DOWN})
03920         max\_master\_down\_time += mstime() - master->s\_down\_since\_time;
03921     max\_master\_down\_time += master->down\_after\_period * 10;
03922 
03923     di = dictGetIterator(master->slaves);
03924     \textcolor{keywordflow}{while}((de = dictNext(di)) != NULL) \{
03925         sentinelRedisInstance *slave = \hyperlink{dict_8h_ae8d2cc391873b2bea2b87c4f80f43120}{dictGetVal}(de);
03926         mstime\_t info\_validity\_time;
03927 
03928         \textcolor{keywordflow}{if} (slave->flags & (\hyperlink{sentinel_8c_a8e26596c8bde451c2dd9cecb2c3046d4}{SRI\_S\_DOWN}|\hyperlink{sentinel_8c_a3bbbca05543cd9d9f86d276e2c7c719c}{SRI\_O\_DOWN})) \textcolor{keywordflow}{continue};
03929         \textcolor{keywordflow}{if} (slave->link->disconnected) \textcolor{keywordflow}{continue};
03930         \textcolor{keywordflow}{if} (mstime() - slave->link->last\_avail\_time > \hyperlink{sentinel_8c_a9e22409355fa7a4db7f3a43fbe2d9101}{SENTINEL\_PING\_PERIOD}*5) \textcolor{keywordflow}{
      continue};
03931         \textcolor{keywordflow}{if} (slave->slave\_priority == 0) \textcolor{keywordflow}{continue};
03932 
03933         \textcolor{comment}{/* If the master is in SDOWN state we get INFO for slaves every second.}
03934 \textcolor{comment}{         * Otherwise we get it with the usual period so we need to account for}
03935 \textcolor{comment}{         * a larger delay. */}
03936         \textcolor{keywordflow}{if} (master->flags & \hyperlink{sentinel_8c_a8e26596c8bde451c2dd9cecb2c3046d4}{SRI\_S\_DOWN})
03937             info\_validity\_time = \hyperlink{sentinel_8c_a9e22409355fa7a4db7f3a43fbe2d9101}{SENTINEL\_PING\_PERIOD}*5;
03938         \textcolor{keywordflow}{else}
03939             info\_validity\_time = \hyperlink{sentinel_8c_ac6a2144aa06344ed8547176a4e3cfaa5}{SENTINEL\_INFO\_PERIOD}*3;
03940         \textcolor{keywordflow}{if} (mstime() - slave->info\_refresh > info\_validity\_time) \textcolor{keywordflow}{continue};
03941         \textcolor{keywordflow}{if} (slave->master\_link\_down\_time > max\_master\_down\_time) \textcolor{keywordflow}{continue};
03942         instance[instances++] = slave;
03943     \}
03944     dictReleaseIterator(di);
03945     \textcolor{keywordflow}{if} (instances) \{
03946         qsort(instance,instances,\textcolor{keyword}{sizeof}(sentinelRedisInstance*),
03947             compareSlavesForPromotion);
03948         selected = instance[0];
03949     \}
03950     zfree(instance);
03951     \textcolor{keywordflow}{return} selected;
03952 \}
03953 
03954 \textcolor{comment}{/* ---------------- Failover state machine implementation ------------------- */}
03955 \textcolor{keywordtype}{void} sentinelFailoverWaitStart(sentinelRedisInstance *ri) \{
03956     \textcolor{keywordtype}{char} *leader;
03957     \textcolor{keywordtype}{int} isleader;
03958 
03959     \textcolor{comment}{/* Check if we are the leader for the failover epoch. */}
03960     leader = sentinelGetLeader(ri, ri->failover\_epoch);
03961     isleader = leader && strcasecmp(leader,sentinel.myid) == 0;
03962     sdsfree(leader);
03963 
03964     \textcolor{comment}{/* If I'm not the leader, and it is not a forced failover via}
03965 \textcolor{comment}{     * SENTINEL FAILOVER, then I can't continue with the failover. */}
03966     \textcolor{keywordflow}{if} (!isleader && !(ri->flags & \hyperlink{sentinel_8c_a9b13a255852e8097e4730cb495cdfd94}{SRI\_FORCE\_FAILOVER})) \{
03967         \textcolor{keywordtype}{int} election\_timeout = \hyperlink{sentinel_8c_ac6683124f6ae873093919c7eb840ec94}{SENTINEL\_ELECTION\_TIMEOUT};
03968 
03969         \textcolor{comment}{/* The election timeout is the MIN between SENTINEL\_ELECTION\_TIMEOUT}
03970 \textcolor{comment}{         * and the configured failover timeout. */}
03971         \textcolor{keywordflow}{if} (election\_timeout > ri->failover\_timeout)
03972             election\_timeout = ri->failover\_timeout;
03973         \textcolor{comment}{/* Abort the failover if I'm not the leader after some time. */}
03974         \textcolor{keywordflow}{if} (mstime() - ri->failover\_start\_time > election\_timeout) \{
03975             sentinelEvent(\hyperlink{server_8h_a31229b9334bba7d6be2a72970967a14b}{LL\_WARNING},\textcolor{stringliteral}{"-failover-abort-not-elected"},ri,\textcolor{stringliteral}{"%@"});
03976             sentinelAbortFailover(ri);
03977         \}
03978         \textcolor{keywordflow}{return};
03979     \}
03980     sentinelEvent(\hyperlink{server_8h_a31229b9334bba7d6be2a72970967a14b}{LL\_WARNING},\textcolor{stringliteral}{"+elected-leader"},ri,\textcolor{stringliteral}{"%@"});
03981     \textcolor{keywordflow}{if} (sentinel.simfailure\_flags & 
      \hyperlink{sentinel_8c_a8549938b8489bb23679cf13b8d99997c}{SENTINEL\_SIMFAILURE\_CRASH\_AFTER\_ELECTION})
03982         sentinelSimFailureCrash();
03983     ri->failover\_state = \hyperlink{sentinel_8c_ab69af026a9f736ca81bfffd4eeada38f}{SENTINEL\_FAILOVER\_STATE\_SELECT\_SLAVE};
03984     ri->failover\_state\_change\_time = mstime();
03985     sentinelEvent(\hyperlink{server_8h_a31229b9334bba7d6be2a72970967a14b}{LL\_WARNING},\textcolor{stringliteral}{"+failover-state-select-slave"},ri,\textcolor{stringliteral}{"%@"});
03986 \}
03987 
03988 \textcolor{keywordtype}{void} sentinelFailoverSelectSlave(sentinelRedisInstance *ri) \{
03989     sentinelRedisInstance *slave = sentinelSelectSlave(ri);
03990 
03991     \textcolor{comment}{/* We don't handle the timeout in this state as the function aborts}
03992 \textcolor{comment}{     * the failover or go forward in the next state. */}
03993     \textcolor{keywordflow}{if} (slave == NULL) \{
03994         sentinelEvent(\hyperlink{server_8h_a31229b9334bba7d6be2a72970967a14b}{LL\_WARNING},\textcolor{stringliteral}{"-failover-abort-no-good-slave"},ri,\textcolor{stringliteral}{"%@"});
03995         sentinelAbortFailover(ri);
03996     \} \textcolor{keywordflow}{else} \{
03997         sentinelEvent(\hyperlink{server_8h_a31229b9334bba7d6be2a72970967a14b}{LL\_WARNING},\textcolor{stringliteral}{"+selected-slave"},slave,\textcolor{stringliteral}{"%@"});
03998         slave->flags |= \hyperlink{sentinel_8c_a6c6c019b1af48a9c0e9507422051c684}{SRI\_PROMOTED};
03999         ri->promoted\_slave = slave;
04000         ri->failover\_state = \hyperlink{sentinel_8c_ac89d5b0fc38860b277528c7d3a854580}{SENTINEL\_FAILOVER\_STATE\_SEND\_SLAVEOF\_NOONE}
      ;
04001         ri->failover\_state\_change\_time = mstime();
04002         sentinelEvent(\hyperlink{server_8h_a8c54c191e436c7dd3012167212692401}{LL\_NOTICE},\textcolor{stringliteral}{"+failover-state-send-slaveof-noone"},
04003             slave, \textcolor{stringliteral}{"%@"});
04004     \}
04005 \}
04006 
04007 \textcolor{keywordtype}{void} sentinelFailoverSendSlaveOfNoOne(sentinelRedisInstance *ri) \{
04008     \textcolor{keywordtype}{int} retval;
04009 
04010     \textcolor{comment}{/* We can't send the command to the promoted slave if it is now}
04011 \textcolor{comment}{     * disconnected. Retry again and again with this state until the timeout}
04012 \textcolor{comment}{     * is reached, then abort the failover. */}
04013     \textcolor{keywordflow}{if} (ri->promoted\_slave->link->disconnected) \{
04014         \textcolor{keywordflow}{if} (mstime() - ri->failover\_state\_change\_time > ri->failover\_timeout) \{
04015             sentinelEvent(\hyperlink{server_8h_a31229b9334bba7d6be2a72970967a14b}{LL\_WARNING},\textcolor{stringliteral}{"-failover-abort-slave-timeout"},ri,\textcolor{stringliteral}{"%@"});
04016             sentinelAbortFailover(ri);
04017         \}
04018         \textcolor{keywordflow}{return};
04019     \}
04020 
04021     \textcolor{comment}{/* Send SLAVEOF NO ONE command to turn the slave into a master.}
04022 \textcolor{comment}{     * We actually register a generic callback for this command as we don't}
04023 \textcolor{comment}{     * really care about the reply. We check if it worked indirectly observing}
04024 \textcolor{comment}{     * if INFO returns a different role (master instead of slave). */}
04025     retval = sentinelSendSlaveOf(ri->promoted\_slave,NULL,0);
04026     \textcolor{keywordflow}{if} (retval != \hyperlink{server_8h_a303769ef1065076e68731584e758d3e1}{C\_OK}) \textcolor{keywordflow}{return};
04027     sentinelEvent(\hyperlink{server_8h_a8c54c191e436c7dd3012167212692401}{LL\_NOTICE}, \textcolor{stringliteral}{"+failover-state-wait-promotion"},
04028         ri->promoted\_slave,\textcolor{stringliteral}{"%@"});
04029     ri->failover\_state = \hyperlink{sentinel_8c_a49d9c64c03e76dcbf7728ad64dd99330}{SENTINEL\_FAILOVER\_STATE\_WAIT\_PROMOTION};
04030     ri->failover\_state\_change\_time = mstime();
04031 \}
04032 
04033 \textcolor{comment}{/* We actually wait for promotion indirectly checking with INFO when the}
04034 \textcolor{comment}{ * slave turns into a master. */}
04035 \textcolor{keywordtype}{void} sentinelFailoverWaitPromotion(sentinelRedisInstance *ri) \{
04036     \textcolor{comment}{/* Just handle the timeout. Switching to the next state is handled}
04037 \textcolor{comment}{     * by the function parsing the INFO command of the promoted slave. */}
04038     \textcolor{keywordflow}{if} (mstime() - ri->failover\_state\_change\_time > ri->failover\_timeout) \{
04039         sentinelEvent(\hyperlink{server_8h_a31229b9334bba7d6be2a72970967a14b}{LL\_WARNING},\textcolor{stringliteral}{"-failover-abort-slave-timeout"},ri,\textcolor{stringliteral}{"%@"});
04040         sentinelAbortFailover(ri);
04041     \}
04042 \}
04043 
04044 \textcolor{keywordtype}{void} sentinelFailoverDetectEnd(sentinelRedisInstance *master) \{
04045     \textcolor{keywordtype}{int} not\_reconfigured = 0, timeout = 0;
04046     dictIterator *di;
04047     dictEntry *de;
04048     mstime\_t elapsed = mstime() - master->failover\_state\_change\_time;
04049 
04050     \textcolor{comment}{/* We can't consider failover finished if the promoted slave is}
04051 \textcolor{comment}{     * not reachable. */}
04052     \textcolor{keywordflow}{if} (master->promoted\_slave == NULL ||
04053         master->promoted\_slave->flags & \hyperlink{sentinel_8c_a8e26596c8bde451c2dd9cecb2c3046d4}{SRI\_S\_DOWN}) \textcolor{keywordflow}{return};
04054 
04055     \textcolor{comment}{/* The failover terminates once all the reachable slaves are properly}
04056 \textcolor{comment}{     * configured. */}
04057     di = dictGetIterator(master->slaves);
04058     \textcolor{keywordflow}{while}((de = dictNext(di)) != NULL) \{
04059         sentinelRedisInstance *slave = \hyperlink{dict_8h_ae8d2cc391873b2bea2b87c4f80f43120}{dictGetVal}(de);
04060 
04061         \textcolor{keywordflow}{if} (slave->flags & (\hyperlink{sentinel_8c_a6c6c019b1af48a9c0e9507422051c684}{SRI\_PROMOTED}|\hyperlink{sentinel_8c_adb468d0a8c96c954b6af26aa670d7a11}{SRI\_RECONF\_DONE})) \textcolor{keywordflow}{continue};
04062         \textcolor{keywordflow}{if} (slave->flags & \hyperlink{sentinel_8c_a8e26596c8bde451c2dd9cecb2c3046d4}{SRI\_S\_DOWN}) \textcolor{keywordflow}{continue};
04063         not\_reconfigured++;
04064     \}
04065     dictReleaseIterator(di);
04066 
04067     \textcolor{comment}{/* Force end of failover on timeout. */}
04068     \textcolor{keywordflow}{if} (elapsed > master->failover\_timeout) \{
04069         not\_reconfigured = 0;
04070         timeout = 1;
04071         sentinelEvent(\hyperlink{server_8h_a31229b9334bba7d6be2a72970967a14b}{LL\_WARNING},\textcolor{stringliteral}{"+failover-end-for-timeout"},master,\textcolor{stringliteral}{"%@"});
04072     \}
04073 
04074     \textcolor{keywordflow}{if} (not\_reconfigured == 0) \{
04075         sentinelEvent(\hyperlink{server_8h_a31229b9334bba7d6be2a72970967a14b}{LL\_WARNING},\textcolor{stringliteral}{"+failover-end"},master,\textcolor{stringliteral}{"%@"});
04076         master->failover\_state = \hyperlink{sentinel_8c_a2b6f5592dea88534b287c71e46181ed3}{SENTINEL\_FAILOVER\_STATE\_UPDATE\_CONFIG}
      ;
04077         master->failover\_state\_change\_time = mstime();
04078     \}
04079 
04080     \textcolor{comment}{/* If I'm the leader it is a good idea to send a best effort SLAVEOF}
04081 \textcolor{comment}{     * command to all the slaves still not reconfigured to replicate with}
04082 \textcolor{comment}{     * the new master. */}
04083     \textcolor{keywordflow}{if} (timeout) \{
04084         dictIterator *di;
04085         dictEntry *de;
04086 
04087         di = dictGetIterator(master->slaves);
04088         \textcolor{keywordflow}{while}((de = dictNext(di)) != NULL) \{
04089             sentinelRedisInstance *slave = \hyperlink{dict_8h_ae8d2cc391873b2bea2b87c4f80f43120}{dictGetVal}(de);
04090             \textcolor{keywordtype}{int} retval;
04091 
04092             \textcolor{keywordflow}{if} (slave->flags & (\hyperlink{sentinel_8c_adb468d0a8c96c954b6af26aa670d7a11}{SRI\_RECONF\_DONE}|
      \hyperlink{sentinel_8c_a9b307b68cb1615ead6aacb0de34910e6}{SRI\_RECONF\_SENT})) \textcolor{keywordflow}{continue};
04093             \textcolor{keywordflow}{if} (slave->link->disconnected) \textcolor{keywordflow}{continue};
04094 
04095             retval = sentinelSendSlaveOf(slave,
04096                     master->promoted\_slave->addr->ip,
04097                     master->promoted\_slave->addr->port);
04098             \textcolor{keywordflow}{if} (retval == \hyperlink{server_8h_a303769ef1065076e68731584e758d3e1}{C\_OK}) \{
04099                 sentinelEvent(\hyperlink{server_8h_a8c54c191e436c7dd3012167212692401}{LL\_NOTICE},\textcolor{stringliteral}{"+slave-reconf-sent-be"},slave,\textcolor{stringliteral}{"%@"});
04100                 slave->flags |= \hyperlink{sentinel_8c_a9b307b68cb1615ead6aacb0de34910e6}{SRI\_RECONF\_SENT};
04101             \}
04102         \}
04103         dictReleaseIterator(di);
04104     \}
04105 \}
04106 
04107 \textcolor{comment}{/* Send SLAVE OF <new master address> to all the remaining slaves that}
04108 \textcolor{comment}{ * still don't appear to have the configuration updated. */}
04109 \textcolor{keywordtype}{void} sentinelFailoverReconfNextSlave(sentinelRedisInstance *master) \{
04110     dictIterator *di;
04111     dictEntry *de;
04112     \textcolor{keywordtype}{int} in\_progress = 0;
04113 
04114     di = dictGetIterator(master->slaves);
04115     \textcolor{keywordflow}{while}((de = dictNext(di)) != NULL) \{
04116         sentinelRedisInstance *slave = \hyperlink{dict_8h_ae8d2cc391873b2bea2b87c4f80f43120}{dictGetVal}(de);
04117 
04118         \textcolor{keywordflow}{if} (slave->flags & (\hyperlink{sentinel_8c_a9b307b68cb1615ead6aacb0de34910e6}{SRI\_RECONF\_SENT}|
      \hyperlink{sentinel_8c_a58c89f4aaa1bdfde4c25e3bb476c35aa}{SRI\_RECONF\_INPROG}))
04119             in\_progress++;
04120     \}
04121     dictReleaseIterator(di);
04122 
04123     di = dictGetIterator(master->slaves);
04124     \textcolor{keywordflow}{while}(in\_progress < master->parallel\_syncs &&
04125           (de = dictNext(di)) != NULL)
04126     \{
04127         sentinelRedisInstance *slave = \hyperlink{dict_8h_ae8d2cc391873b2bea2b87c4f80f43120}{dictGetVal}(de);
04128         \textcolor{keywordtype}{int} retval;
04129 
04130         \textcolor{comment}{/* Skip the promoted slave, and already configured slaves. */}
04131         \textcolor{keywordflow}{if} (slave->flags & (\hyperlink{sentinel_8c_a6c6c019b1af48a9c0e9507422051c684}{SRI\_PROMOTED}|\hyperlink{sentinel_8c_adb468d0a8c96c954b6af26aa670d7a11}{SRI\_RECONF\_DONE})) \textcolor{keywordflow}{continue};
04132 
04133         \textcolor{comment}{/* If too much time elapsed without the slave moving forward to}
04134 \textcolor{comment}{         * the next state, consider it reconfigured even if it is not.}
04135 \textcolor{comment}{         * Sentinels will detect the slave as misconfigured and fix its}
04136 \textcolor{comment}{         * configuration later. */}
04137         \textcolor{keywordflow}{if} ((slave->flags & \hyperlink{sentinel_8c_a9b307b68cb1615ead6aacb0de34910e6}{SRI\_RECONF\_SENT}) &&
04138             (mstime() - slave->slave\_reconf\_sent\_time) >
04139             \hyperlink{sentinel_8c_a12c554c086559e7435c3d0ea9718aa39}{SENTINEL\_SLAVE\_RECONF\_TIMEOUT})
04140         \{
04141             sentinelEvent(\hyperlink{server_8h_a8c54c191e436c7dd3012167212692401}{LL\_NOTICE},\textcolor{stringliteral}{"-slave-reconf-sent-timeout"},slave,\textcolor{stringliteral}{"%@"});
04142             slave->flags &= ~\hyperlink{sentinel_8c_a9b307b68cb1615ead6aacb0de34910e6}{SRI\_RECONF\_SENT};
04143             slave->flags |= \hyperlink{sentinel_8c_adb468d0a8c96c954b6af26aa670d7a11}{SRI\_RECONF\_DONE};
04144         \}
04145 
04146         \textcolor{comment}{/* Nothing to do for instances that are disconnected or already}
04147 \textcolor{comment}{         * in RECONF\_SENT state. */}
04148         \textcolor{keywordflow}{if} (slave->flags & (\hyperlink{sentinel_8c_a9b307b68cb1615ead6aacb0de34910e6}{SRI\_RECONF\_SENT}|
      \hyperlink{sentinel_8c_a58c89f4aaa1bdfde4c25e3bb476c35aa}{SRI\_RECONF\_INPROG})) \textcolor{keywordflow}{continue};
04149         \textcolor{keywordflow}{if} (slave->link->disconnected) \textcolor{keywordflow}{continue};
04150 
04151         \textcolor{comment}{/* Send SLAVEOF <new master>. */}
04152         retval = sentinelSendSlaveOf(slave,
04153                 master->promoted\_slave->addr->ip,
04154                 master->promoted\_slave->addr->port);
04155         \textcolor{keywordflow}{if} (retval == \hyperlink{server_8h_a303769ef1065076e68731584e758d3e1}{C\_OK}) \{
04156             slave->flags |= \hyperlink{sentinel_8c_a9b307b68cb1615ead6aacb0de34910e6}{SRI\_RECONF\_SENT};
04157             slave->slave\_reconf\_sent\_time = mstime();
04158             sentinelEvent(\hyperlink{server_8h_a8c54c191e436c7dd3012167212692401}{LL\_NOTICE},\textcolor{stringliteral}{"+slave-reconf-sent"},slave,\textcolor{stringliteral}{"%@"});
04159             in\_progress++;
04160         \}
04161     \}
04162     dictReleaseIterator(di);
04163 
04164     \textcolor{comment}{/* Check if all the slaves are reconfigured and handle timeout. */}
04165     sentinelFailoverDetectEnd(master);
04166 \}
04167 
04168 \textcolor{comment}{/* This function is called when the slave is in}
04169 \textcolor{comment}{ * SENTINEL\_FAILOVER\_STATE\_UPDATE\_CONFIG state. In this state we need}
04170 \textcolor{comment}{ * to remove it from the master table and add the promoted slave instead. */}
04171 \textcolor{keywordtype}{void} sentinelFailoverSwitchToPromotedSlave(sentinelRedisInstance *master) \{
04172     sentinelRedisInstance *ref = master->promoted\_slave ?
04173                                  master->promoted\_slave : master;
04174 
04175     sentinelEvent(\hyperlink{server_8h_a31229b9334bba7d6be2a72970967a14b}{LL\_WARNING},\textcolor{stringliteral}{"+switch-master"},master,\textcolor{stringliteral}{"%s %s %d %s %d"},
04176         master->name, master->addr->ip, master->addr->port,
04177         ref->addr->ip, ref->addr->port);
04178 
04179     sentinelResetMasterAndChangeAddress(master,ref->addr->ip,ref->addr->port);
04180 \}
04181 
04182 \textcolor{keywordtype}{void} sentinelFailoverStateMachine(sentinelRedisInstance *ri) \{
04183     \hyperlink{server_8h_a88114b5169b4c382df6b56506285e56a}{serverAssert}(ri->flags & \hyperlink{sentinel_8c_a2ee83e5ff67b45746cd6a310f15334b2}{SRI\_MASTER});
04184 
04185     \textcolor{keywordflow}{if} (!(ri->flags & \hyperlink{sentinel_8c_a0546b63633196f09fcd90957243b0798}{SRI\_FAILOVER\_IN\_PROGRESS})) \textcolor{keywordflow}{return};
04186 
04187     \textcolor{keywordflow}{switch}(ri->failover\_state) \{
04188         \textcolor{keywordflow}{case} \hyperlink{sentinel_8c_a83bf9fce7cbb7bf1b0723ced2d434366}{SENTINEL\_FAILOVER\_STATE\_WAIT\_START}:
04189             sentinelFailoverWaitStart(ri);
04190             \textcolor{keywordflow}{break};
04191         \textcolor{keywordflow}{case} \hyperlink{sentinel_8c_ab69af026a9f736ca81bfffd4eeada38f}{SENTINEL\_FAILOVER\_STATE\_SELECT\_SLAVE}:
04192             sentinelFailoverSelectSlave(ri);
04193             \textcolor{keywordflow}{break};
04194         \textcolor{keywordflow}{case} \hyperlink{sentinel_8c_ac89d5b0fc38860b277528c7d3a854580}{SENTINEL\_FAILOVER\_STATE\_SEND\_SLAVEOF\_NOONE}:
04195             sentinelFailoverSendSlaveOfNoOne(ri);
04196             \textcolor{keywordflow}{break};
04197         \textcolor{keywordflow}{case} \hyperlink{sentinel_8c_a49d9c64c03e76dcbf7728ad64dd99330}{SENTINEL\_FAILOVER\_STATE\_WAIT\_PROMOTION}:
04198             sentinelFailoverWaitPromotion(ri);
04199             \textcolor{keywordflow}{break};
04200         \textcolor{keywordflow}{case} \hyperlink{sentinel_8c_a05b020edfa71eb4d24288e79637b57f5}{SENTINEL\_FAILOVER\_STATE\_RECONF\_SLAVES}:
04201             sentinelFailoverReconfNextSlave(ri);
04202             \textcolor{keywordflow}{break};
04203     \}
04204 \}
04205 
04206 \textcolor{comment}{/* Abort a failover in progress:}
04207 \textcolor{comment}{ *}
04208 \textcolor{comment}{ * This function can only be called before the promoted slave acknowledged}
04209 \textcolor{comment}{ * the slave -> master switch. Otherwise the failover can't be aborted and}
04210 \textcolor{comment}{ * will reach its end (possibly by timeout). */}
04211 \textcolor{keywordtype}{void} sentinelAbortFailover(sentinelRedisInstance *ri) \{
04212     \hyperlink{server_8h_a88114b5169b4c382df6b56506285e56a}{serverAssert}(ri->flags & \hyperlink{sentinel_8c_a0546b63633196f09fcd90957243b0798}{SRI\_FAILOVER\_IN\_PROGRESS});
04213     \hyperlink{server_8h_a88114b5169b4c382df6b56506285e56a}{serverAssert}(ri->failover\_state <= 
      \hyperlink{sentinel_8c_a49d9c64c03e76dcbf7728ad64dd99330}{SENTINEL\_FAILOVER\_STATE\_WAIT\_PROMOTION});
04214 
04215     ri->flags &= ~(\hyperlink{sentinel_8c_a0546b63633196f09fcd90957243b0798}{SRI\_FAILOVER\_IN\_PROGRESS}|
      \hyperlink{sentinel_8c_a9b13a255852e8097e4730cb495cdfd94}{SRI\_FORCE\_FAILOVER});
04216     ri->failover\_state = \hyperlink{sentinel_8c_a23bad5aa23e7b1a930ad4aa535938efb}{SENTINEL\_FAILOVER\_STATE\_NONE};
04217     ri->failover\_state\_change\_time = mstime();
04218     \textcolor{keywordflow}{if} (ri->promoted\_slave) \{
04219         ri->promoted\_slave->flags &= ~\hyperlink{sentinel_8c_a6c6c019b1af48a9c0e9507422051c684}{SRI\_PROMOTED};
04220         ri->promoted\_slave = NULL;
04221     \}
04222 \}
04223 
04224 \textcolor{comment}{/* ======================== SENTINEL timer handler ==========================}
04225 \textcolor{comment}{ * This is the "main" our Sentinel, being sentinel completely non blocking}
04226 \textcolor{comment}{ * in design. The function is called every second.}
04227 \textcolor{comment}{ * -------------------------------------------------------------------------- */}
04228 
04229 \textcolor{comment}{/* Perform scheduled operations for the specified Redis instance. */}
04230 \textcolor{keywordtype}{void} sentinelHandleRedisInstance(sentinelRedisInstance *ri) \{
04231     \textcolor{comment}{/* ========== MONITORING HALF ============ */}
04232     \textcolor{comment}{/* Every kind of instance */}
04233     sentinelReconnectInstance(ri);
04234     sentinelSendPeriodicCommands(ri);
04235 
04236     \textcolor{comment}{/* ============== ACTING HALF ============= */}
04237     \textcolor{comment}{/* We don't proceed with the acting half if we are in TILT mode.}
04238 \textcolor{comment}{     * TILT happens when we find something odd with the time, like a}
04239 \textcolor{comment}{     * sudden change in the clock. */}
04240     \textcolor{keywordflow}{if} (sentinel.tilt) \{
04241         \textcolor{keywordflow}{if} (mstime()-sentinel.tilt\_start\_time < \hyperlink{sentinel_8c_af2d8538f1bdf8d6e616675b143d54685}{SENTINEL\_TILT\_PERIOD}) \textcolor{keywordflow}{return};
04242         sentinel.tilt = 0;
04243         sentinelEvent(\hyperlink{server_8h_a31229b9334bba7d6be2a72970967a14b}{LL\_WARNING},\textcolor{stringliteral}{"-tilt"},NULL,\textcolor{stringliteral}{"#tilt mode exited"});
04244     \}
04245 
04246     \textcolor{comment}{/* Every kind of instance */}
04247     sentinelCheckSubjectivelyDown(ri);
04248 
04249     \textcolor{comment}{/* Masters and slaves */}
04250     \textcolor{keywordflow}{if} (ri->flags & (\hyperlink{sentinel_8c_a2ee83e5ff67b45746cd6a310f15334b2}{SRI\_MASTER}|\hyperlink{sentinel_8c_a4b9db21eda79d49bd9fdf2cf7b3178e8}{SRI\_SLAVE})) \{
04251         \textcolor{comment}{/* Nothing so far. */}
04252     \}
04253 
04254     \textcolor{comment}{/* Only masters */}
04255     \textcolor{keywordflow}{if} (ri->flags & \hyperlink{sentinel_8c_a2ee83e5ff67b45746cd6a310f15334b2}{SRI\_MASTER}) \{
04256         sentinelCheckObjectivelyDown(ri);
04257         \textcolor{keywordflow}{if} (sentinelStartFailoverIfNeeded(ri))
04258             sentinelAskMasterStateToOtherSentinels(ri,\hyperlink{sentinel_8c_a166080e23b7691124260c5ea1b053380}{SENTINEL\_ASK\_FORCED});
04259         sentinelFailoverStateMachine(ri);
04260         sentinelAskMasterStateToOtherSentinels(ri,\hyperlink{sentinel_8c_a4d5f3da6bf36b5daaa353968a5e133a3}{SENTINEL\_NO\_FLAGS});
04261     \}
04262 \}
04263 
04264 \textcolor{comment}{/* Perform scheduled operations for all the instances in the dictionary.}
04265 \textcolor{comment}{ * Recursively call the function against dictionaries of slaves. */}
04266 \textcolor{keywordtype}{void} sentinelHandleDictOfRedisInstances(dict *instances) \{
04267     dictIterator *di;
04268     dictEntry *de;
04269     sentinelRedisInstance *switch\_to\_promoted = NULL;
04270 
04271     \textcolor{comment}{/* There are a number of things we need to perform against every master. */}
04272     di = dictGetIterator(instances);
04273     \textcolor{keywordflow}{while}((de = dictNext(di)) != NULL) \{
04274         sentinelRedisInstance *ri = \hyperlink{dict_8h_ae8d2cc391873b2bea2b87c4f80f43120}{dictGetVal}(de);
04275 
04276         sentinelHandleRedisInstance(ri);
04277         \textcolor{keywordflow}{if} (ri->flags & \hyperlink{sentinel_8c_a2ee83e5ff67b45746cd6a310f15334b2}{SRI\_MASTER}) \{
04278             sentinelHandleDictOfRedisInstances(ri->slaves);
04279             sentinelHandleDictOfRedisInstances(ri->sentinels);
04280             \textcolor{keywordflow}{if} (ri->failover\_state == \hyperlink{sentinel_8c_a2b6f5592dea88534b287c71e46181ed3}{SENTINEL\_FAILOVER\_STATE\_UPDATE\_CONFIG}
      ) \{
04281                 switch\_to\_promoted = ri;
04282             \}
04283         \}
04284     \}
04285     \textcolor{keywordflow}{if} (switch\_to\_promoted)
04286         sentinelFailoverSwitchToPromotedSlave(switch\_to\_promoted);
04287     dictReleaseIterator(di);
04288 \}
04289 
04290 \textcolor{comment}{/* This function checks if we need to enter the TITL mode.}
04291 \textcolor{comment}{ *}
04292 \textcolor{comment}{ * The TILT mode is entered if we detect that between two invocations of the}
04293 \textcolor{comment}{ * timer interrupt, a negative amount of time, or too much time has passed.}
04294 \textcolor{comment}{ * Note that we expect that more or less just 100 milliseconds will pass}
04295 \textcolor{comment}{ * if everything is fine. However we'll see a negative number or a}
04296 \textcolor{comment}{ * difference bigger than SENTINEL\_TILT\_TRIGGER milliseconds if one of the}
04297 \textcolor{comment}{ * following conditions happen:}
04298 \textcolor{comment}{ *}
04299 \textcolor{comment}{ * 1) The Sentiel process for some time is blocked, for every kind of}
04300 \textcolor{comment}{ * random reason: the load is huge, the computer was frozen for some time}
04301 \textcolor{comment}{ * in I/O or alike, the process was stopped by a signal. Everything.}
04302 \textcolor{comment}{ * 2) The system clock was altered significantly.}
04303 \textcolor{comment}{ *}
04304 \textcolor{comment}{ * Under both this conditions we'll see everything as timed out and failing}
04305 \textcolor{comment}{ * without good reasons. Instead we enter the TILT mode and wait}
04306 \textcolor{comment}{ * for SENTINEL\_TILT\_PERIOD to elapse before starting to act again.}
04307 \textcolor{comment}{ *}
04308 \textcolor{comment}{ * During TILT time we still collect information, we just do not act. */}
04309 \textcolor{keywordtype}{void} sentinelCheckTiltCondition(\textcolor{keywordtype}{void}) \{
04310     mstime\_t now = mstime();
04311     mstime\_t delta = now - sentinel.previous\_time;
04312 
04313     \textcolor{keywordflow}{if} (delta < 0 || delta > \hyperlink{sentinel_8c_a717cd21c21357abdd371151e3d18c98a}{SENTINEL\_TILT\_TRIGGER}) \{
04314         sentinel.tilt = 1;
04315         sentinel.tilt\_start\_time = mstime();
04316         sentinelEvent(\hyperlink{server_8h_a31229b9334bba7d6be2a72970967a14b}{LL\_WARNING},\textcolor{stringliteral}{"+tilt"},NULL,\textcolor{stringliteral}{"#tilt mode entered"});
04317     \}
04318     sentinel.previous\_time = mstime();
04319 \}
04320 
04321 \textcolor{keywordtype}{void} sentinelTimer(\textcolor{keywordtype}{void}) \{
04322     sentinelCheckTiltCondition();
04323     sentinelHandleDictOfRedisInstances(sentinel.masters);
04324     sentinelRunPendingScripts();
04325     sentinelCollectTerminatedScripts();
04326     sentinelKillTimedoutScripts();
04327 
04328     \textcolor{comment}{/* We continuously change the frequency of the Redis "timer interrupt"}
04329 \textcolor{comment}{     * in order to desynchronize every Sentinel from every other.}
04330 \textcolor{comment}{     * This non-determinism avoids that Sentinels started at the same time}
04331 \textcolor{comment}{     * exactly continue to stay synchronized asking to be voted at the}
04332 \textcolor{comment}{     * same time again and again (resulting in nobody likely winning the}
04333 \textcolor{comment}{     * election because of split brain voting). */}
04334     server.hz = \hyperlink{server_8h_aa5a3b127e21d6bf089025d953c44678a}{CONFIG\_DEFAULT\_HZ} + rand() % 
      \hyperlink{server_8h_aa5a3b127e21d6bf089025d953c44678a}{CONFIG\_DEFAULT\_HZ};
04335 \}
\end{DoxyCode}
