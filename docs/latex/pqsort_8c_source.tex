\hypertarget{pqsort_8c_source}{}\section{pqsort.\+c}
\label{pqsort_8c_source}\index{src/pqsort.\+c@{src/pqsort.\+c}}

\begin{DoxyCode}
00001 \textcolor{comment}{/* The following is the NetBSD libc qsort implementation modified in order to}
00002 \textcolor{comment}{ * support partial sorting of ranges for Redis.}
00003 \textcolor{comment}{ *}
00004 \textcolor{comment}{ * Copyright(C) 2009-2012 Salvatore Sanfilippo. All rights reserved.}
00005 \textcolor{comment}{ *}
00006 \textcolor{comment}{ * The original copyright notice follows. */}
00007 
00008 
00009 \textcolor{comment}{/*  $NetBSD: qsort.c,v 1.19 2009/01/30 23:38:44 lukem Exp $ */}
00010 
00011 \textcolor{comment}{/*-}
00012 \textcolor{comment}{ * Copyright (c) 1992, 1993}
00013 \textcolor{comment}{ *  The Regents of the University of California.  All rights reserved.}
00014 \textcolor{comment}{ *}
00015 \textcolor{comment}{ * Redistribution and use in source and binary forms, with or without}
00016 \textcolor{comment}{ * modification, are permitted provided that the following conditions}
00017 \textcolor{comment}{ * are met:}
00018 \textcolor{comment}{ * 1. Redistributions of source code must retain the above copyright}
00019 \textcolor{comment}{ *    notice, this list of conditions and the following disclaimer.}
00020 \textcolor{comment}{ * 2. Redistributions in binary form must reproduce the above copyright}
00021 \textcolor{comment}{ *    notice, this list of conditions and the following disclaimer in the}
00022 \textcolor{comment}{ *    documentation and/or other materials provided with the distribution.}
00023 \textcolor{comment}{ * 3. Neither the name of the University nor the names of its contributors}
00024 \textcolor{comment}{ *    may be used to endorse or promote products derived from this software}
00025 \textcolor{comment}{ *    without specific prior written permission.}
00026 \textcolor{comment}{ *}
00027 \textcolor{comment}{ * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND}
00028 \textcolor{comment}{ * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE}
00029 \textcolor{comment}{ * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE}
00030 \textcolor{comment}{ * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE}
00031 \textcolor{comment}{ * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL}
00032 \textcolor{comment}{ * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS}
00033 \textcolor{comment}{ * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)}
00034 \textcolor{comment}{ * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT}
00035 \textcolor{comment}{ * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY}
00036 \textcolor{comment}{ * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF}
00037 \textcolor{comment}{ * SUCH DAMAGE.}
00038 \textcolor{comment}{ */}
00039 
00040 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{sys}\textcolor{preprocessor}{/}\textcolor{preprocessor}{types}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00041 
00042 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{errno}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00043 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{stdlib}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00044 
00045 \textcolor{keyword}{static} \textcolor{keyword}{inline} \textcolor{keywordtype}{char}  *med3 (\textcolor{keywordtype}{char} *, \textcolor{keywordtype}{char} *, \textcolor{keywordtype}{char} *,
00046     \textcolor{keywordtype}{int} (*)(\textcolor{keyword}{const} \textcolor{keywordtype}{void} *, \textcolor{keyword}{const} \textcolor{keywordtype}{void} *));
00047 \textcolor{keyword}{static} \textcolor{keyword}{inline} \textcolor{keywordtype}{void}   swapfunc (\textcolor{keywordtype}{char} *, \textcolor{keywordtype}{char} *, size\_t, \textcolor{keywordtype}{int});
00048 
00049 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{min}\textcolor{preprocessor}{(}\textcolor{preprocessor}{a}\textcolor{preprocessor}{,} \textcolor{preprocessor}{b}\textcolor{preprocessor}{)}   \textcolor{preprocessor}{(}\textcolor{preprocessor}{a}\textcolor{preprocessor}{)} \textcolor{preprocessor}{<} \textcolor{preprocessor}{(}\textcolor{preprocessor}{b}\textcolor{preprocessor}{)} \textcolor{preprocessor}{?} \textcolor{preprocessor}{a} \textcolor{preprocessor}{:} \textcolor{preprocessor}{b}
00050 
00051 \textcolor{comment}{/*}
00052 \textcolor{comment}{ * Qsort routine from Bentley & McIlroy's "Engineering a Sort Function".}
00053 \textcolor{comment}{ */}
00054 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{swapcode}\textcolor{preprocessor}{(}\textcolor{preprocessor}{TYPE}\textcolor{preprocessor}{,} \textcolor{preprocessor}{parmi}\textcolor{preprocessor}{,} \textcolor{preprocessor}{parmj}\textcolor{preprocessor}{,} \textcolor{preprocessor}{n}\textcolor{preprocessor}{)} \textcolor{preprocessor}{\{}
00055     \textcolor{preprocessor}{size\_t} \textcolor{preprocessor}{i} \textcolor{preprocessor}{=} \textcolor{preprocessor}{(}\textcolor{preprocessor}{n}\textcolor{preprocessor}{)} \textcolor{preprocessor}{/} \textcolor{keyword}{sizeof} \textcolor{preprocessor}{(}\textcolor{preprocessor}{TYPE}\textcolor{preprocessor}{)}\textcolor{preprocessor}{;}
00056     \textcolor{preprocessor}{TYPE} \textcolor{preprocessor}{*}\textcolor{preprocessor}{pi} \textcolor{preprocessor}{=} \textcolor{preprocessor}{(}\textcolor{preprocessor}{TYPE} \textcolor{preprocessor}{*}\textcolor{preprocessor}{)}\textcolor{preprocessor}{(}\textcolor{keywordtype}{void} \textcolor{preprocessor}{*}\textcolor{preprocessor}{)}\textcolor{preprocessor}{(}\textcolor{preprocessor}{parmi}\textcolor{preprocessor}{)}\textcolor{preprocessor}{;}
00057     \textcolor{preprocessor}{TYPE} \textcolor{preprocessor}{*}\textcolor{preprocessor}{pj} \textcolor{preprocessor}{=} \textcolor{preprocessor}{(}\textcolor{preprocessor}{TYPE} \textcolor{preprocessor}{*}\textcolor{preprocessor}{)}\textcolor{preprocessor}{(}\textcolor{keywordtype}{void} \textcolor{preprocessor}{*}\textcolor{preprocessor}{)}\textcolor{preprocessor}{(}\textcolor{preprocessor}{parmj}\textcolor{preprocessor}{)}\textcolor{preprocessor}{;}
00058     \textcolor{keywordflow}{do} \textcolor{preprocessor}{\{}
00059         \textcolor{preprocessor}{TYPE}    \textcolor{preprocessor}{t} \textcolor{preprocessor}{=} \textcolor{preprocessor}{*}\textcolor{preprocessor}{pi}\textcolor{preprocessor}{;}
00060         \textcolor{preprocessor}{*}\textcolor{preprocessor}{pi}\textcolor{preprocessor}{++} \textcolor{preprocessor}{=} \textcolor{preprocessor}{*}\textcolor{preprocessor}{pj}\textcolor{preprocessor}{;}
00061         \textcolor{preprocessor}{*}\textcolor{preprocessor}{pj}\textcolor{preprocessor}{++} \textcolor{preprocessor}{=} \textcolor{preprocessor}{t}\textcolor{preprocessor}{;}
00062         \textcolor{preprocessor}{\}} \textcolor{keywordflow}{while} \textcolor{preprocessor}{(}\textcolor{preprocessor}{--}\textcolor{preprocessor}{i} \textcolor{preprocessor}{>} 0\textcolor{preprocessor}{)}\textcolor{preprocessor}{;}              \textcolor{preprocessor}{\(\backslash\)}
00063 \textcolor{preprocessor}{\}}
00064 
00065 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{SWAPINIT}\textcolor{preprocessor}{(}\textcolor{preprocessor}{a}\textcolor{preprocessor}{,} \textcolor{preprocessor}{es}\textcolor{preprocessor}{)} \textcolor{preprocessor}{swaptype} \textcolor{preprocessor}{=} \textcolor{preprocessor}{(}\textcolor{preprocessor}{(}\textcolor{keywordtype}{char} \textcolor{preprocessor}{*}\textcolor{preprocessor}{)}\textcolor{preprocessor}{a} \textcolor{preprocessor}{-} \textcolor{preprocessor}{(}\textcolor{keywordtype}{char} \textcolor{preprocessor}{*}\textcolor{preprocessor}{)}0\textcolor{preprocessor}{)} \textcolor{preprocessor}{%} \textcolor{keyword}{sizeof}\textcolor{preprocessor}{(}\textcolor{keywordtype}{long}\textcolor{preprocessor}{)} \textcolor{preprocessor}{||}
00066     \textcolor{preprocessor}{es} \textcolor{preprocessor}{%} \textcolor{keyword}{sizeof}\textcolor{preprocessor}{(}\textcolor{keywordtype}{long}\textcolor{preprocessor}{)} \textcolor{preprocessor}{?} 2 \textcolor{preprocessor}{:} \textcolor{preprocessor}{es} \textcolor{preprocessor}{==} \textcolor{keyword}{sizeof}\textcolor{preprocessor}{(}\textcolor{keywordtype}{long}\textcolor{preprocessor}{)}\textcolor{preprocessor}{?} 0 \textcolor{preprocessor}{:} 1\textcolor{preprocessor}{;}
00067 
00068 \textcolor{keyword}{static} \textcolor{keyword}{inline} \textcolor{keywordtype}{void}
00069 swapfunc(\textcolor{keywordtype}{char} *a, \textcolor{keywordtype}{char} *b, size\_t n, \textcolor{keywordtype}{int} swaptype)
00070 \{
00071 
00072     \textcolor{keywordflow}{if} (swaptype <= 1)
00073         \hyperlink{pqsort_8c_a94e98b172e7b50dde8c112d1617d446d}{swapcode}(\textcolor{keywordtype}{long}, a, b, n)
00074     \textcolor{keywordflow}{else}
00075         \hyperlink{pqsort_8c_a94e98b172e7b50dde8c112d1617d446d}{swapcode}(\textcolor{keywordtype}{char}, a, b, n)
00076 \}
00077 
00078 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{swap}\textcolor{preprocessor}{(}\textcolor{preprocessor}{a}\textcolor{preprocessor}{,} \textcolor{preprocessor}{b}\textcolor{preprocessor}{)}
00079     \textcolor{keywordflow}{if} \textcolor{preprocessor}{(}\textcolor{preprocessor}{swaptype} \textcolor{preprocessor}{==} 0\textcolor{preprocessor}{)} \textcolor{preprocessor}{\{}
00080         \textcolor{keywordtype}{long} \textcolor{preprocessor}{t} \textcolor{preprocessor}{=} \textcolor{preprocessor}{*}\textcolor{preprocessor}{(}\textcolor{keywordtype}{long} \textcolor{preprocessor}{*}\textcolor{preprocessor}{)}\textcolor{preprocessor}{(}\textcolor{keywordtype}{void} \textcolor{preprocessor}{*}\textcolor{preprocessor}{)}\textcolor{preprocessor}{(}\textcolor{preprocessor}{a}\textcolor{preprocessor}{)}\textcolor{preprocessor}{;}
00081         \textcolor{preprocessor}{*}\textcolor{preprocessor}{(}\textcolor{keywordtype}{long} \textcolor{preprocessor}{*}\textcolor{preprocessor}{)}\textcolor{preprocessor}{(}\textcolor{keywordtype}{void} \textcolor{preprocessor}{*}\textcolor{preprocessor}{)}\textcolor{preprocessor}{(}\textcolor{preprocessor}{a}\textcolor{preprocessor}{)} \textcolor{preprocessor}{=} \textcolor{preprocessor}{*}\textcolor{preprocessor}{(}\textcolor{keywordtype}{long} \textcolor{preprocessor}{*}\textcolor{preprocessor}{)}\textcolor{preprocessor}{(}\textcolor{keywordtype}{void} \textcolor{preprocessor}{*}\textcolor{preprocessor}{)}\textcolor{preprocessor}{(}\textcolor{preprocessor}{b}\textcolor{preprocessor}{)}\textcolor{preprocessor}{;}
00082         \textcolor{preprocessor}{*}\textcolor{preprocessor}{(}\textcolor{keywordtype}{long} \textcolor{preprocessor}{*}\textcolor{preprocessor}{)}\textcolor{preprocessor}{(}\textcolor{keywordtype}{void} \textcolor{preprocessor}{*}\textcolor{preprocessor}{)}\textcolor{preprocessor}{(}\textcolor{preprocessor}{b}\textcolor{preprocessor}{)} \textcolor{preprocessor}{=} \textcolor{preprocessor}{t}\textcolor{preprocessor}{;}
00083     \textcolor{preprocessor}{\}} \textcolor{keywordflow}{else}
00084         \textcolor{preprocessor}{swapfunc}\textcolor{preprocessor}{(}\textcolor{preprocessor}{a}\textcolor{preprocessor}{,} \textcolor{preprocessor}{b}\textcolor{preprocessor}{,} \textcolor{preprocessor}{es}\textcolor{preprocessor}{,} \textcolor{preprocessor}{swaptype}\textcolor{preprocessor}{)}
00085 
00086 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{vecswap}\textcolor{preprocessor}{(}\textcolor{preprocessor}{a}\textcolor{preprocessor}{,} \textcolor{preprocessor}{b}\textcolor{preprocessor}{,} \textcolor{preprocessor}{n}\textcolor{preprocessor}{)} \textcolor{keywordflow}{if} \textcolor{preprocessor}{(}\textcolor{preprocessor}{(}\textcolor{preprocessor}{n}\textcolor{preprocessor}{)} \textcolor{preprocessor}{>} 0\textcolor{preprocessor}{)} \textcolor{preprocessor}{swapfunc}\textcolor{preprocessor}{(}\textcolor{preprocessor}{(}\textcolor{preprocessor}{a}\textcolor{preprocessor}{)}\textcolor{preprocessor}{,} \textcolor{preprocessor}{(}\textcolor{preprocessor}{b}\textcolor{preprocessor}{)}\textcolor{preprocessor}{,} \textcolor{preprocessor}{(}\textcolor{preprocessor}{size\_t}\textcolor{preprocessor}{)}\textcolor{preprocessor}{(}\textcolor{preprocessor}{n}\textcolor{preprocessor}{)}\textcolor{preprocessor}{,} \textcolor{preprocessor}{swaptype}\textcolor{preprocessor}{)}
00087 
00088 \textcolor{keyword}{static} \textcolor{keyword}{inline} \textcolor{keywordtype}{char} *
00089 med3(\textcolor{keywordtype}{char} *a, \textcolor{keywordtype}{char} *b, \textcolor{keywordtype}{char} *c,
00090     \textcolor{keywordtype}{int} (*cmp) (\textcolor{keyword}{const} \textcolor{keywordtype}{void} *, \textcolor{keyword}{const} \textcolor{keywordtype}{void} *))
00091 \{
00092 
00093     \textcolor{keywordflow}{return} cmp(a, b) < 0 ?
00094            (cmp(b, c) < 0 ? b : (cmp(a, c) < 0 ? c : a ))
00095               :(cmp(b, c) > 0 ? b : (cmp(a, c) < 0 ? a : c ));
00096 \}
00097 
00098 \textcolor{keyword}{static} \textcolor{keywordtype}{void}
00099 \_pqsort(\textcolor{keywordtype}{void} *a, size\_t n, size\_t es,
00100     \textcolor{keywordtype}{int} (*cmp) (\textcolor{keyword}{const} \textcolor{keywordtype}{void} *, \textcolor{keyword}{const} \textcolor{keywordtype}{void} *), \textcolor{keywordtype}{void} *lrange, \textcolor{keywordtype}{void} *rrange)
00101 \{
00102     \textcolor{keywordtype}{char} *pa, *pb, *pc, *pd, *pl, *pm, *pn;
00103     size\_t d, r;
00104     \textcolor{keywordtype}{int} swaptype, cmp\_result;
00105 
00106 loop:   \hyperlink{pqsort_8c_ae05386e947a28313dfc55049cbed825a}{SWAPINIT}(a, es);
00107     \textcolor{keywordflow}{if} (n < 7) \{
00108         \textcolor{keywordflow}{for} (pm = (\textcolor{keywordtype}{char} *) a + es; pm < (\textcolor{keywordtype}{char} *) a + n * es; pm += es)
00109             \textcolor{keywordflow}{for} (pl = pm; pl > (\textcolor{keywordtype}{char} *) a && cmp(pl - es, pl) > 0;
00110                  pl -= es)
00111                 \hyperlink{pqsort_8c_a3ca5ecd34b04d6a243c054ac3a57f68d}{swap}(pl, pl - es);
00112         \textcolor{keywordflow}{return};
00113     \}
00114     pm = (\textcolor{keywordtype}{char} *) a + (n / 2) * es;
00115     \textcolor{keywordflow}{if} (n > 7) \{
00116         pl = (\textcolor{keywordtype}{char} *) a;
00117         pn = (\textcolor{keywordtype}{char} *) a + (n - 1) * es;
00118         \textcolor{keywordflow}{if} (n > 40) \{
00119             d = (n / 8) * es;
00120             pl = med3(pl, pl + d, pl + 2 * d, cmp);
00121             pm = med3(pm - d, pm, pm + d, cmp);
00122             pn = med3(pn - 2 * d, pn - d, pn, cmp);
00123         \}
00124         pm = med3(pl, pm, pn, cmp);
00125     \}
00126     \hyperlink{pqsort_8c_a3ca5ecd34b04d6a243c054ac3a57f68d}{swap}(a, pm);
00127     pa = pb = (\textcolor{keywordtype}{char} *) a + es;
00128 
00129     pc = pd = (\textcolor{keywordtype}{char} *) a + (n - 1) * es;
00130     \textcolor{keywordflow}{for} (;;) \{
00131         \textcolor{keywordflow}{while} (pb <= pc && (cmp\_result = cmp(pb, a)) <= 0) \{
00132             \textcolor{keywordflow}{if} (cmp\_result == 0) \{
00133                 \hyperlink{pqsort_8c_a3ca5ecd34b04d6a243c054ac3a57f68d}{swap}(pa, pb);
00134                 pa += es;
00135             \}
00136             pb += es;
00137         \}
00138         \textcolor{keywordflow}{while} (pb <= pc && (cmp\_result = cmp(pc, a)) >= 0) \{
00139             \textcolor{keywordflow}{if} (cmp\_result == 0) \{
00140                 \hyperlink{pqsort_8c_a3ca5ecd34b04d6a243c054ac3a57f68d}{swap}(pc, pd);
00141                 pd -= es;
00142             \}
00143             pc -= es;
00144         \}
00145         \textcolor{keywordflow}{if} (pb > pc)
00146             \textcolor{keywordflow}{break};
00147         \hyperlink{pqsort_8c_a3ca5ecd34b04d6a243c054ac3a57f68d}{swap}(pb, pc);
00148         pb += es;
00149         pc -= es;
00150     \}
00151 
00152     pn = (\textcolor{keywordtype}{char} *) a + n * es;
00153     r = \hyperlink{pqsort_8c_ac6afabdc09a49a433ee19d8a9486056d}{min}(pa - (\textcolor{keywordtype}{char} *) a, pb - pa);
00154     \hyperlink{pqsort_8c_a584c607dc0b230ebfdde9a157887c6a9}{vecswap}(a, pb - r, r);
00155     r = \hyperlink{pqsort_8c_ac6afabdc09a49a433ee19d8a9486056d}{min}((size\_t)(pd - pc), pn - pd - es);
00156     \hyperlink{pqsort_8c_a584c607dc0b230ebfdde9a157887c6a9}{vecswap}(pb, pn - r, r);
00157     \textcolor{keywordflow}{if} ((r = pb - pa) > es) \{
00158                 \textcolor{keywordtype}{void} *\_l = a, *\_r = ((\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char}*)a)+r-1;
00159                 \textcolor{keywordflow}{if} (!((lrange < \_l && rrange < \_l) ||
00160                     (lrange > \_r && rrange > \_r)))
00161             \_pqsort(a, r / es, es, cmp, lrange, rrange);
00162         \}
00163     \textcolor{keywordflow}{if} ((r = pd - pc) > es) \{
00164                 \textcolor{keywordtype}{void} *\_l, *\_r;
00165 
00166         \textcolor{comment}{/* Iterate rather than recurse to save stack space */}
00167         a = pn - r;
00168         n = r / es;
00169 
00170                 \_l = a;
00171                 \_r = ((\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char}*)a)+r-1;
00172                 \textcolor{keywordflow}{if} (!((lrange < \_l && rrange < \_l) ||
00173                     (lrange > \_r && rrange > \_r)))
00174             \textcolor{keywordflow}{goto} loop;
00175     \}
00176 \textcolor{comment}{/*      qsort(pn - r, r / es, es, cmp);*/}
00177 \}
00178 
00179 \textcolor{keywordtype}{void}
00180 pqsort(\textcolor{keywordtype}{void} *a, size\_t n, size\_t es,
00181     \textcolor{keywordtype}{int} (*cmp) (\textcolor{keyword}{const} \textcolor{keywordtype}{void} *, \textcolor{keyword}{const} \textcolor{keywordtype}{void} *), size\_t lrange, size\_t rrange)
00182 \{
00183     \_pqsort(a,n,es,cmp,((\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char}*)a)+(lrange*es),
00184                        ((\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char}*)a)+((rrange+1)*es)-1);
00185 \}
\end{DoxyCode}
