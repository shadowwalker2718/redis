\hypertarget{bio_8c_source}{}\section{bio.\+c}
\label{bio_8c_source}\index{src/bio.\+c@{src/bio.\+c}}

\begin{DoxyCode}
00001 \textcolor{comment}{/* Background I/O service for Redis.}
00002 \textcolor{comment}{ *}
00003 \textcolor{comment}{ * This file implements operations that we need to perform in the background.}
00004 \textcolor{comment}{ * Currently there is only a single operation, that is a background close(2)}
00005 \textcolor{comment}{ * system call. This is needed as when the process is the last owner of a}
00006 \textcolor{comment}{ * reference to a file closing it means unlinking it, and the deletion of the}
00007 \textcolor{comment}{ * file is slow, blocking the server.}
00008 \textcolor{comment}{ *}
00009 \textcolor{comment}{ * In the future we'll either continue implementing new things we need or}
00010 \textcolor{comment}{ * we'll switch to libeio. However there are probably long term uses for this}
00011 \textcolor{comment}{ * file as we may want to put here Redis specific background tasks (for instance}
00012 \textcolor{comment}{ * it is not impossible that we'll need a non blocking FLUSHDB/FLUSHALL}
00013 \textcolor{comment}{ * implementation).}
00014 \textcolor{comment}{ *}
00015 \textcolor{comment}{ * DESIGN}
00016 \textcolor{comment}{ * ------}
00017 \textcolor{comment}{ *}
00018 \textcolor{comment}{ * The design is trivial, we have a structure representing a job to perform}
00019 \textcolor{comment}{ * and a different thread and job queue for every job type.}
00020 \textcolor{comment}{ * Every thread wait for new jobs in its queue, and process every job}
00021 \textcolor{comment}{ * sequentially.}
00022 \textcolor{comment}{ *}
00023 \textcolor{comment}{ * Jobs of the same type are guaranteed to be processed from the least}
00024 \textcolor{comment}{ * recently inserted to the most recently inserted (older jobs processed}
00025 \textcolor{comment}{ * first).}
00026 \textcolor{comment}{ *}
00027 \textcolor{comment}{ * Currently there is no way for the creator of the job to be notified about}
00028 \textcolor{comment}{ * the completion of the operation, this will only be added when/if needed.}
00029 \textcolor{comment}{ *}
00030 \textcolor{comment}{ * ----------------------------------------------------------------------------}
00031 \textcolor{comment}{ *}
00032 \textcolor{comment}{ * Copyright (c) 2009-2012, Salvatore Sanfilippo <antirez at gmail dot com>}
00033 \textcolor{comment}{ * All rights reserved.}
00034 \textcolor{comment}{ *}
00035 \textcolor{comment}{ * Redistribution and use in source and binary forms, with or without}
00036 \textcolor{comment}{ * modification, are permitted provided that the following conditions are met:}
00037 \textcolor{comment}{ *}
00038 \textcolor{comment}{ *   * Redistributions of source code must retain the above copyright notice,}
00039 \textcolor{comment}{ *     this list of conditions and the following disclaimer.}
00040 \textcolor{comment}{ *   * Redistributions in binary form must reproduce the above copyright}
00041 \textcolor{comment}{ *     notice, this list of conditions and the following disclaimer in the}
00042 \textcolor{comment}{ *     documentation and/or other materials provided with the distribution.}
00043 \textcolor{comment}{ *   * Neither the name of Redis nor the names of its contributors may be used}
00044 \textcolor{comment}{ *     to endorse or promote products derived from this software without}
00045 \textcolor{comment}{ *     specific prior written permission.}
00046 \textcolor{comment}{ *}
00047 \textcolor{comment}{ * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"}
00048 \textcolor{comment}{ * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE}
00049 \textcolor{comment}{ * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE}
00050 \textcolor{comment}{ * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE}
00051 \textcolor{comment}{ * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR}
00052 \textcolor{comment}{ * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF}
00053 \textcolor{comment}{ * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS}
00054 \textcolor{comment}{ * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN}
00055 \textcolor{comment}{ * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)}
00056 \textcolor{comment}{ * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE}
00057 \textcolor{comment}{ * POSSIBILITY OF SUCH DAMAGE.}
00058 \textcolor{comment}{ */}
00059 
00060 
00061 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \hyperlink{server_8h}{"server.h"}
00062 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \hyperlink{bio_8h}{"bio.h"}
00063 
00064 \textcolor{keyword}{static} pthread\_t bio\_threads[\hyperlink{bio_8h_a544b0595052937cbb10e0ffd1f56d163}{BIO\_NUM\_OPS}];
00065 \textcolor{keyword}{static} pthread\_mutex\_t bio\_mutex[\hyperlink{bio_8h_a544b0595052937cbb10e0ffd1f56d163}{BIO\_NUM\_OPS}];
00066 \textcolor{keyword}{static} pthread\_cond\_t bio\_newjob\_cond[\hyperlink{bio_8h_a544b0595052937cbb10e0ffd1f56d163}{BIO\_NUM\_OPS}];
00067 \textcolor{keyword}{static} pthread\_cond\_t bio\_step\_cond[\hyperlink{bio_8h_a544b0595052937cbb10e0ffd1f56d163}{BIO\_NUM\_OPS}];
00068 \textcolor{keyword}{static} list *bio\_jobs[\hyperlink{bio_8h_a544b0595052937cbb10e0ffd1f56d163}{BIO\_NUM\_OPS}];
00069 \textcolor{comment}{/* The following array is used to hold the number of pending jobs for every}
00070 \textcolor{comment}{ * OP type. This allows us to export the bioPendingJobsOfType() API that is}
00071 \textcolor{comment}{ * useful when the main thread wants to perform some operation that may involve}
00072 \textcolor{comment}{ * objects shared with the background thread. The main thread will just wait}
00073 \textcolor{comment}{ * that there are no longer jobs of this type to be executed before performing}
00074 \textcolor{comment}{ * the sensible operation. This data is also useful for reporting. */}
00075 \textcolor{keyword}{static} \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{long} \textcolor{keywordtype}{long} bio\_pending[\hyperlink{bio_8h_a544b0595052937cbb10e0ffd1f56d163}{BIO\_NUM\_OPS}];
00076 
00077 \textcolor{comment}{/* This structure represents a background Job. It is only used locally to this}
00078 \textcolor{comment}{ * file as the API does not expose the internals at all. */}
\Hypertarget{bio_8c_source_l00079}\hyperlink{structbio__job}{00079} \textcolor{keyword}{struct} \hyperlink{structbio__job}{bio\_job} \{
00080     time\_t time; \textcolor{comment}{/* Time at which the job was created. */}
00081     \textcolor{comment}{/* Job specific arguments pointers. If we need to pass more than three}
00082 \textcolor{comment}{     * arguments we can just pass a pointer to a structure or alike. */}
00083     \textcolor{keywordtype}{void} *arg1, *arg2, *arg3;
00084 \};
00085 
00086 \textcolor{keywordtype}{void} *bioProcessBackgroundJobs(\textcolor{keywordtype}{void} *arg);
00087 \textcolor{keywordtype}{void} lazyfreeFreeObjectFromBioThread(robj *o);
00088 \textcolor{keywordtype}{void} lazyfreeFreeDatabaseFromBioThread(dict *ht1, dict *ht2);
00089 \textcolor{keywordtype}{void} lazyfreeFreeSlotsMapFromBioThread(zskiplist *sl);
00090 
00091 \textcolor{comment}{/* Make sure we have enough stack to perform all the things we do in the}
00092 \textcolor{comment}{ * main thread. */}
00093 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{REDIS\_THREAD\_STACK\_SIZE} \textcolor{preprocessor}{(}1024\textcolor{preprocessor}{*}1024\textcolor{preprocessor}{*}4\textcolor{preprocessor}{)}
00094 
00095 \textcolor{comment}{/* Initialize the background system, spawning the thread. */}
00096 \textcolor{keywordtype}{void} bioInit(\textcolor{keywordtype}{void}) \{
00097     pthread\_attr\_t attr;
00098     pthread\_t thread;
00099     size\_t stacksize;
00100     \textcolor{keywordtype}{int} j;
00101 
00102     \textcolor{comment}{/* Initialization of state vars and objects */}
00103     \textcolor{keywordflow}{for} (j = 0; j < \hyperlink{bio_8h_a544b0595052937cbb10e0ffd1f56d163}{BIO\_NUM\_OPS}; j++) \{
00104         pthread\_mutex\_init(&bio\_mutex[j],NULL);
00105         pthread\_cond\_init(&bio\_newjob\_cond[j],NULL);
00106         pthread\_cond\_init(&bio\_step\_cond[j],NULL);
00107         bio\_jobs[j] = listCreate();
00108         bio\_pending[j] = 0;
00109     \}
00110 
00111     \textcolor{comment}{/* Set the stack size as by default it may be small in some system */}
00112     pthread\_attr\_init(&attr);
00113     pthread\_attr\_getstacksize(&attr,&stacksize);
00114     \textcolor{keywordflow}{if} (!stacksize) stacksize = 1; \textcolor{comment}{/* The world is full of Solaris Fixes */}
00115     \textcolor{keywordflow}{while} (stacksize < \hyperlink{bio_8c_ac3dda970d0fb733f6938ca417e59556c}{REDIS\_THREAD\_STACK\_SIZE}) stacksize *= 2;
00116     pthread\_attr\_setstacksize(&attr, stacksize);
00117 
00118     \textcolor{comment}{/* Ready to spawn our threads. We use the single argument the thread}
00119 \textcolor{comment}{     * function accepts in order to pass the job ID the thread is}
00120 \textcolor{comment}{     * responsible of. */}
00121     \textcolor{keywordflow}{for} (j = 0; j < \hyperlink{bio_8h_a544b0595052937cbb10e0ffd1f56d163}{BIO\_NUM\_OPS}; j++) \{
00122         \textcolor{keywordtype}{void} *arg = (\textcolor{keywordtype}{void}*)(\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{long}) j;
00123         \textcolor{keywordflow}{if} (pthread\_create(&thread,&attr,bioProcessBackgroundJobs,arg) != 0) \{
00124             serverLog(\hyperlink{server_8h_a31229b9334bba7d6be2a72970967a14b}{LL\_WARNING},\textcolor{stringliteral}{"Fatal: Can't initialize Background Jobs."});
00125             exit(1);
00126         \}
00127         bio\_threads[j] = thread;
00128     \}
00129 \}
00130 
00131 \textcolor{keywordtype}{void} bioCreateBackgroundJob(\textcolor{keywordtype}{int} type, \textcolor{keywordtype}{void} *arg1, \textcolor{keywordtype}{void} *arg2, \textcolor{keywordtype}{void} *arg3) \{
00132     \textcolor{keyword}{struct} \hyperlink{structbio__job}{bio\_job} *job = zmalloc(\textcolor{keyword}{sizeof}(*job));
00133 
00134     job->time = time(NULL);
00135     job->arg1 = arg1;
00136     job->arg2 = arg2;
00137     job->arg3 = arg3;
00138     pthread\_mutex\_lock(&bio\_mutex[type]);
00139     listAddNodeTail(bio\_jobs[type],job);
00140     bio\_pending[type]++;
00141     pthread\_cond\_signal(&bio\_newjob\_cond[type]);
00142     pthread\_mutex\_unlock(&bio\_mutex[type]);
00143 \}
00144 
00145 \textcolor{keywordtype}{void} *bioProcessBackgroundJobs(\textcolor{keywordtype}{void} *arg) \{
00146     \textcolor{keyword}{struct} \hyperlink{structbio__job}{bio\_job} *job;
00147     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{long} type = (\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{long}) arg;
00148     sigset\_t sigset;
00149 
00150     \textcolor{comment}{/* Check that the type is within the right interval. */}
00151     \textcolor{keywordflow}{if} (type >= \hyperlink{bio_8h_a544b0595052937cbb10e0ffd1f56d163}{BIO\_NUM\_OPS}) \{
00152         serverLog(\hyperlink{server_8h_a31229b9334bba7d6be2a72970967a14b}{LL\_WARNING},
00153             \textcolor{stringliteral}{"Warning: bio thread started with wrong type %lu"},type);
00154         \textcolor{keywordflow}{return} NULL;
00155     \}
00156 
00157     \textcolor{comment}{/* Make the thread killable at any time, so that bioKillThreads()}
00158 \textcolor{comment}{     * can work reliably. */}
00159     pthread\_setcancelstate(PTHREAD\_CANCEL\_ENABLE, NULL);
00160     pthread\_setcanceltype(PTHREAD\_CANCEL\_ASYNCHRONOUS, NULL);
00161 
00162     pthread\_mutex\_lock(&bio\_mutex[type]);
00163     \textcolor{comment}{/* Block SIGALRM so we are sure that only the main thread will}
00164 \textcolor{comment}{     * receive the watchdog signal. */}
00165     sigemptyset(&sigset);
00166     sigaddset(&sigset, SIGALRM);
00167     \textcolor{keywordflow}{if} (pthread\_sigmask(SIG\_BLOCK, &sigset, NULL))
00168         serverLog(\hyperlink{server_8h_a31229b9334bba7d6be2a72970967a14b}{LL\_WARNING},
00169             \textcolor{stringliteral}{"Warning: can't mask SIGALRM in bio.c thread: %s"}, strerror(errno));
00170 
00171     \textcolor{keywordflow}{while}(1) \{
00172         listNode *ln;
00173 
00174         \textcolor{comment}{/* The loop always starts with the lock hold. */}
00175         \textcolor{keywordflow}{if} (\hyperlink{adlist_8h_afde0ab079f934670e82119b43120e94b}{listLength}(bio\_jobs[type]) == 0) \{
00176             pthread\_cond\_wait(&bio\_newjob\_cond[type],&bio\_mutex[type]);
00177             \textcolor{keywordflow}{continue};
00178         \}
00179         \textcolor{comment}{/* Pop the job from the queue. */}
00180         ln = \hyperlink{adlist_8h_aa8dc514bbe217bb2e87c1c77cfa84690}{listFirst}(bio\_jobs[type]);
00181         job = ln->value;
00182         \textcolor{comment}{/* It is now possible to unlock the background system as we know have}
00183 \textcolor{comment}{         * a stand alone job structure to process.*/}
00184         pthread\_mutex\_unlock(&bio\_mutex[type]);
00185 
00186         \textcolor{comment}{/* Process the job accordingly to its type. */}
00187         \textcolor{keywordflow}{if} (type == \hyperlink{bio_8h_ac5890d1af5c5d32376c47ad6b83c2af4}{BIO\_CLOSE\_FILE}) \{
00188             close((\textcolor{keywordtype}{long})job->arg1);
00189         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (type == \hyperlink{bio_8h_a5d03c967316addafc61b7ed5d957984f}{BIO\_AOF\_FSYNC}) \{
00190             \hyperlink{config_8h_af5994c643c434574580bb7816af82cad}{aof\_fsync}((\textcolor{keywordtype}{long})job->arg1);
00191         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (type == \hyperlink{bio_8h_afdc82658b2e29c63afcdb2e808b8a510}{BIO\_LAZY\_FREE}) \{
00192             \textcolor{comment}{/* What we free changes depending on what arguments are set:}
00193 \textcolor{comment}{             * arg1 -> free the object at pointer.}
00194 \textcolor{comment}{             * arg2 & arg3 -> free two dictionaries (a Redis DB).}
00195 \textcolor{comment}{             * only arg3 -> free the skiplist. */}
00196             \textcolor{keywordflow}{if} (job->arg1)
00197                 lazyfreeFreeObjectFromBioThread(job->arg1);
00198             \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (job->arg2 && job->arg3)
00199                 lazyfreeFreeDatabaseFromBioThread(job->arg2,job->arg3);
00200             \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (job->arg3)
00201                 lazyfreeFreeSlotsMapFromBioThread(job->arg3);
00202         \} \textcolor{keywordflow}{else} \{
00203             \hyperlink{server_8h_a11cc378e7778a830b41240578de3b204}{serverPanic}(\textcolor{stringliteral}{"Wrong job type in bioProcessBackgroundJobs()."});
00204         \}
00205         zfree(job);
00206 
00207         \textcolor{comment}{/* Unblock threads blocked on bioWaitStepOfType() if any. */}
00208         pthread\_cond\_broadcast(&bio\_step\_cond[type]);
00209 
00210         \textcolor{comment}{/* Lock again before reiterating the loop, if there are no longer}
00211 \textcolor{comment}{         * jobs to process we'll block again in pthread\_cond\_wait(). */}
00212         pthread\_mutex\_lock(&bio\_mutex[type]);
00213         listDelNode(bio\_jobs[type],ln);
00214         bio\_pending[type]--;
00215     \}
00216 \}
00217 
00218 \textcolor{comment}{/* Return the number of pending jobs of the specified type. */}
00219 \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{long} \textcolor{keywordtype}{long} bioPendingJobsOfType(\textcolor{keywordtype}{int} type) \{
00220     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{long} \textcolor{keywordtype}{long} val;
00221     pthread\_mutex\_lock(&bio\_mutex[type]);
00222     val = bio\_pending[type];
00223     pthread\_mutex\_unlock(&bio\_mutex[type]);
00224     \textcolor{keywordflow}{return} val;
00225 \}
00226 
00227 \textcolor{comment}{/* If there are pending jobs for the specified type, the function blocks}
00228 \textcolor{comment}{ * and waits that the next job was processed. Otherwise the function}
00229 \textcolor{comment}{ * does not block and returns ASAP.}
00230 \textcolor{comment}{ *}
00231 \textcolor{comment}{ * The function returns the number of jobs still to process of the}
00232 \textcolor{comment}{ * requested type.}
00233 \textcolor{comment}{ *}
00234 \textcolor{comment}{ * This function is useful when from another thread, we want to wait}
00235 \textcolor{comment}{ * a bio.c thread to do more work in a blocking way.}
00236 \textcolor{comment}{ */}
00237 \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{long} \textcolor{keywordtype}{long} bioWaitStepOfType(\textcolor{keywordtype}{int} type) \{
00238     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{long} \textcolor{keywordtype}{long} val;
00239     pthread\_mutex\_lock(&bio\_mutex[type]);
00240     val = bio\_pending[type];
00241     \textcolor{keywordflow}{if} (val != 0) \{
00242         pthread\_cond\_wait(&bio\_step\_cond[type],&bio\_mutex[type]);
00243         val = bio\_pending[type];
00244     \}
00245     pthread\_mutex\_unlock(&bio\_mutex[type]);
00246     \textcolor{keywordflow}{return} val;
00247 \}
00248 
00249 \textcolor{comment}{/* Kill the running bio threads in an unclean way. This function should be}
00250 \textcolor{comment}{ * used only when it's critical to stop the threads for some reason.}
00251 \textcolor{comment}{ * Currently Redis does this only on crash (for instance on SIGSEGV) in order}
00252 \textcolor{comment}{ * to perform a fast memory check without other threads messing with memory. */}
00253 \textcolor{keywordtype}{void} bioKillThreads(\textcolor{keywordtype}{void}) \{
00254     \textcolor{keywordtype}{int} err, j;
00255 
00256     \textcolor{keywordflow}{for} (j = 0; j < \hyperlink{bio_8h_a544b0595052937cbb10e0ffd1f56d163}{BIO\_NUM\_OPS}; j++) \{
00257         \textcolor{keywordflow}{if} (pthread\_cancel(bio\_threads[j]) == 0) \{
00258             \textcolor{keywordflow}{if} ((err = pthread\_join(bio\_threads[j],NULL)) != 0) \{
00259                 serverLog(\hyperlink{server_8h_a31229b9334bba7d6be2a72970967a14b}{LL\_WARNING},
00260                     \textcolor{stringliteral}{"Bio thread for job type #%d can be joined: %s"},
00261                         j, strerror(err));
00262             \} \textcolor{keywordflow}{else} \{
00263                 serverLog(\hyperlink{server_8h_a31229b9334bba7d6be2a72970967a14b}{LL\_WARNING},
00264                     \textcolor{stringliteral}{"Bio thread for job type #%d terminated"},j);
00265             \}
00266         \}
00267     \}
00268 \}
\end{DoxyCode}
