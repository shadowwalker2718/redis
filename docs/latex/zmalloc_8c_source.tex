\hypertarget{zmalloc_8c_source}{}\section{zmalloc.\+c}
\label{zmalloc_8c_source}\index{src/zmalloc.\+c@{src/zmalloc.\+c}}

\begin{DoxyCode}
00001 \textcolor{comment}{/* zmalloc - total amount of allocated memory aware version of malloc()}
00002 \textcolor{comment}{ *}
00003 \textcolor{comment}{ * Copyright (c) 2009-2010, Salvatore Sanfilippo <antirez at gmail dot com>}
00004 \textcolor{comment}{ * All rights reserved.}
00005 \textcolor{comment}{ *}
00006 \textcolor{comment}{ * Redistribution and use in source and binary forms, with or without}
00007 \textcolor{comment}{ * modification, are permitted provided that the following conditions are met:}
00008 \textcolor{comment}{ *}
00009 \textcolor{comment}{ *   * Redistributions of source code must retain the above copyright notice,}
00010 \textcolor{comment}{ *     this list of conditions and the following disclaimer.}
00011 \textcolor{comment}{ *   * Redistributions in binary form must reproduce the above copyright}
00012 \textcolor{comment}{ *     notice, this list of conditions and the following disclaimer in the}
00013 \textcolor{comment}{ *     documentation and/or other materials provided with the distribution.}
00014 \textcolor{comment}{ *   * Neither the name of Redis nor the names of its contributors may be used}
00015 \textcolor{comment}{ *     to endorse or promote products derived from this software without}
00016 \textcolor{comment}{ *     specific prior written permission.}
00017 \textcolor{comment}{ *}
00018 \textcolor{comment}{ * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"}
00019 \textcolor{comment}{ * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE}
00020 \textcolor{comment}{ * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE}
00021 \textcolor{comment}{ * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE}
00022 \textcolor{comment}{ * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR}
00023 \textcolor{comment}{ * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF}
00024 \textcolor{comment}{ * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS}
00025 \textcolor{comment}{ * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN}
00026 \textcolor{comment}{ * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)}
00027 \textcolor{comment}{ * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE}
00028 \textcolor{comment}{ * POSSIBILITY OF SUCH DAMAGE.}
00029 \textcolor{comment}{ */}
00030 
00031 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{stdio}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00032 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{stdlib}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00033 
00034 \textcolor{comment}{/* This function provide us access to the original libc free(). This is useful}
00035 \textcolor{comment}{ * for instance to free results obtained by backtrace\_symbols(). We need}
00036 \textcolor{comment}{ * to define this function before including zmalloc.h that may shadow the}
00037 \textcolor{comment}{ * free implementation if we use jemalloc or another non standard allocator. */}
00038 \textcolor{keywordtype}{void} zlibc\_free(\textcolor{keywordtype}{void} *ptr) \{
00039     free(ptr);
00040 \}
00041 
00042 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{string}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00043 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{pthread}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00044 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \hyperlink{config_8h}{"config.h"}
00045 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \hyperlink{zmalloc_8h}{"zmalloc.h"}
00046 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \hyperlink{atomicvar_8h}{"atomicvar.h"}
00047 
00048 \textcolor{preprocessor}{#}\textcolor{preprocessor}{ifdef} \textcolor{preprocessor}{HAVE\_MALLOC\_SIZE}
00049 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{PREFIX\_SIZE} \textcolor{preprocessor}{(}0\textcolor{preprocessor}{)}
00050 \textcolor{preprocessor}{#}\textcolor{preprocessor}{else}
00051 \textcolor{preprocessor}{#}\textcolor{preprocessor}{if} \textcolor{preprocessor}{defined}\textcolor{preprocessor}{(}\textcolor{preprocessor}{\_\_sun}\textcolor{preprocessor}{)} \textcolor{preprocessor}{||} \textcolor{preprocessor}{defined}\textcolor{preprocessor}{(}\textcolor{preprocessor}{\_\_sparc}\textcolor{preprocessor}{)} \textcolor{preprocessor}{||} \textcolor{preprocessor}{defined}\textcolor{preprocessor}{(}\textcolor{preprocessor}{\_\_sparc\_\_}\textcolor{preprocessor}{)}
00052 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{PREFIX\_SIZE} \textcolor{preprocessor}{(}\textcolor{preprocessor}{sizeof}\textcolor{preprocessor}{(}\textcolor{preprocessor}{long} \textcolor{preprocessor}{long}\textcolor{preprocessor}{)}\textcolor{preprocessor}{)}
00053 \textcolor{preprocessor}{#}\textcolor{preprocessor}{else}
00054 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{PREFIX\_SIZE} \textcolor{preprocessor}{(}\textcolor{keyword}{sizeof}\textcolor{preprocessor}{(}\textcolor{preprocessor}{size\_t}\textcolor{preprocessor}{)}\textcolor{preprocessor}{)}
00055 \textcolor{preprocessor}{#}\textcolor{preprocessor}{endif}
00056 \textcolor{preprocessor}{#}\textcolor{preprocessor}{endif}
00057 
00058 \textcolor{comment}{/* Explicitly override malloc/free etc when using tcmalloc. */}
00059 \textcolor{preprocessor}{#}\textcolor{preprocessor}{if} \textcolor{preprocessor}{defined}\textcolor{preprocessor}{(}\textcolor{preprocessor}{USE\_TCMALLOC}\textcolor{preprocessor}{)}
00060 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{malloc}\textcolor{preprocessor}{(}\textcolor{preprocessor}{size}\textcolor{preprocessor}{)} \textcolor{preprocessor}{tc\_malloc}\textcolor{preprocessor}{(}\textcolor{preprocessor}{size}\textcolor{preprocessor}{)}
00061 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{calloc}\textcolor{preprocessor}{(}\textcolor{preprocessor}{count}\textcolor{preprocessor}{,}\textcolor{preprocessor}{size}\textcolor{preprocessor}{)} \textcolor{preprocessor}{tc\_calloc}\textcolor{preprocessor}{(}\textcolor{preprocessor}{count}\textcolor{preprocessor}{,}\textcolor{preprocessor}{size}\textcolor{preprocessor}{)}
00062 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{realloc}\textcolor{preprocessor}{(}\textcolor{preprocessor}{ptr}\textcolor{preprocessor}{,}\textcolor{preprocessor}{size}\textcolor{preprocessor}{)} \textcolor{preprocessor}{tc\_realloc}\textcolor{preprocessor}{(}\textcolor{preprocessor}{ptr}\textcolor{preprocessor}{,}\textcolor{preprocessor}{size}\textcolor{preprocessor}{)}
00063 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{free}\textcolor{preprocessor}{(}\textcolor{preprocessor}{ptr}\textcolor{preprocessor}{)} \textcolor{preprocessor}{tc\_free}\textcolor{preprocessor}{(}\textcolor{preprocessor}{ptr}\textcolor{preprocessor}{)}
00064 \textcolor{preprocessor}{#}\textcolor{preprocessor}{elif} \textcolor{preprocessor}{defined}\textcolor{preprocessor}{(}\textcolor{preprocessor}{USE\_JEMALLOC}\textcolor{preprocessor}{)}
00065 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{malloc}\textcolor{preprocessor}{(}\textcolor{preprocessor}{size}\textcolor{preprocessor}{)} \textcolor{preprocessor}{je\_malloc}\textcolor{preprocessor}{(}\textcolor{preprocessor}{size}\textcolor{preprocessor}{)}
00066 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{calloc}\textcolor{preprocessor}{(}\textcolor{preprocessor}{count}\textcolor{preprocessor}{,}\textcolor{preprocessor}{size}\textcolor{preprocessor}{)} \textcolor{preprocessor}{je\_calloc}\textcolor{preprocessor}{(}\textcolor{preprocessor}{count}\textcolor{preprocessor}{,}\textcolor{preprocessor}{size}\textcolor{preprocessor}{)}
00067 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{realloc}\textcolor{preprocessor}{(}\textcolor{preprocessor}{ptr}\textcolor{preprocessor}{,}\textcolor{preprocessor}{size}\textcolor{preprocessor}{)} \textcolor{preprocessor}{je\_realloc}\textcolor{preprocessor}{(}\textcolor{preprocessor}{ptr}\textcolor{preprocessor}{,}\textcolor{preprocessor}{size}\textcolor{preprocessor}{)}
00068 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{free}\textcolor{preprocessor}{(}\textcolor{preprocessor}{ptr}\textcolor{preprocessor}{)} \textcolor{preprocessor}{je\_free}\textcolor{preprocessor}{(}\textcolor{preprocessor}{ptr}\textcolor{preprocessor}{)}
00069 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{mallocx}\textcolor{preprocessor}{(}\textcolor{preprocessor}{size}\textcolor{preprocessor}{,}\textcolor{preprocessor}{flags}\textcolor{preprocessor}{)} \textcolor{preprocessor}{je\_mallocx}\textcolor{preprocessor}{(}\textcolor{preprocessor}{size}\textcolor{preprocessor}{,}\textcolor{preprocessor}{flags}\textcolor{preprocessor}{)}
00070 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{dallocx}\textcolor{preprocessor}{(}\textcolor{preprocessor}{ptr}\textcolor{preprocessor}{,}\textcolor{preprocessor}{flags}\textcolor{preprocessor}{)} \textcolor{preprocessor}{je\_dallocx}\textcolor{preprocessor}{(}\textcolor{preprocessor}{ptr}\textcolor{preprocessor}{,}\textcolor{preprocessor}{flags}\textcolor{preprocessor}{)}
00071 \textcolor{preprocessor}{#}\textcolor{preprocessor}{endif}
00072 
00073 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{update\_zmalloc\_stat\_alloc}\textcolor{preprocessor}{(}\textcolor{preprocessor}{\_\_n}\textcolor{preprocessor}{)} \textcolor{keywordflow}{do} \textcolor{preprocessor}{\{}
00074     \textcolor{preprocessor}{size\_t} \textcolor{preprocessor}{\_n} \textcolor{preprocessor}{=} \textcolor{preprocessor}{(}\textcolor{preprocessor}{\_\_n}\textcolor{preprocessor}{)}\textcolor{preprocessor}{;}
00075     \textcolor{keywordflow}{if} \textcolor{preprocessor}{(}\textcolor{preprocessor}{\_n}\textcolor{preprocessor}{&}\textcolor{preprocessor}{(}\textcolor{keyword}{sizeof}\textcolor{preprocessor}{(}\textcolor{keywordtype}{long}\textcolor{preprocessor}{)}\textcolor{preprocessor}{-}1\textcolor{preprocessor}{)}\textcolor{preprocessor}{)} \textcolor{preprocessor}{\_n} \textcolor{preprocessor}{+=} \textcolor{keyword}{sizeof}\textcolor{preprocessor}{(}\textcolor{keywordtype}{long}\textcolor{preprocessor}{)}\textcolor{preprocessor}{-}\textcolor{preprocessor}{(}\textcolor{preprocessor}{\_n}\textcolor{preprocessor}{&}\textcolor{preprocessor}{(}\textcolor{keyword}{sizeof}\textcolor{preprocessor}{(}\textcolor{keywordtype}{long}\textcolor{preprocessor}{)}\textcolor{preprocessor}{-}1\textcolor{preprocessor}{)}\textcolor{preprocessor}{)}\textcolor{preprocessor}{;}
00076     \hyperlink{atomicvar_8h_acb57163a8c3d3c29f38ad239ef0a9c2d}{atomicIncr}\textcolor{preprocessor}{(}\textcolor{preprocessor}{used\_memory}\textcolor{preprocessor}{,}\textcolor{preprocessor}{\_\_n}\textcolor{preprocessor}{)}\textcolor{preprocessor}{;} \textcolor{preprocessor}{\(\backslash\)}
00077 \textcolor{preprocessor}{\}}\textcolor{keywordflow}{while}\textcolor{preprocessor}{(}0\textcolor{preprocessor}{)}
00078 
00079 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{update\_zmalloc\_stat\_free}\textcolor{preprocessor}{(}\textcolor{preprocessor}{\_\_n}\textcolor{preprocessor}{)} \textcolor{keywordflow}{do} \textcolor{preprocessor}{\{}
00080     \textcolor{preprocessor}{size\_t} \textcolor{preprocessor}{\_n} \textcolor{preprocessor}{=} \textcolor{preprocessor}{(}\textcolor{preprocessor}{\_\_n}\textcolor{preprocessor}{)}\textcolor{preprocessor}{;}
00081     \textcolor{keywordflow}{if} \textcolor{preprocessor}{(}\textcolor{preprocessor}{\_n}\textcolor{preprocessor}{&}\textcolor{preprocessor}{(}\textcolor{keyword}{sizeof}\textcolor{preprocessor}{(}\textcolor{keywordtype}{long}\textcolor{preprocessor}{)}\textcolor{preprocessor}{-}1\textcolor{preprocessor}{)}\textcolor{preprocessor}{)} \textcolor{preprocessor}{\_n} \textcolor{preprocessor}{+=} \textcolor{keyword}{sizeof}\textcolor{preprocessor}{(}\textcolor{keywordtype}{long}\textcolor{preprocessor}{)}\textcolor{preprocessor}{-}\textcolor{preprocessor}{(}\textcolor{preprocessor}{\_n}\textcolor{preprocessor}{&}\textcolor{preprocessor}{(}\textcolor{keyword}{sizeof}\textcolor{preprocessor}{(}\textcolor{keywordtype}{long}\textcolor{preprocessor}{)}\textcolor{preprocessor}{-}1\textcolor{preprocessor}{)}\textcolor{preprocessor}{)}\textcolor{preprocessor}{;}
00082     \hyperlink{atomicvar_8h_ab416a5857f1cf1a6dee0310c39ea2036}{atomicDecr}\textcolor{preprocessor}{(}\textcolor{preprocessor}{used\_memory}\textcolor{preprocessor}{,}\textcolor{preprocessor}{\_\_n}\textcolor{preprocessor}{)}\textcolor{preprocessor}{;} \textcolor{preprocessor}{\(\backslash\)}
00083 \textcolor{preprocessor}{\}}\textcolor{keywordflow}{while}\textcolor{preprocessor}{(}0\textcolor{preprocessor}{)}
00084 
00085 \textcolor{keyword}{static} size\_t used\_memory = 0;
00086 pthread\_mutex\_t used\_memory\_mutex = PTHREAD\_MUTEX\_INITIALIZER;
00087 
00088 \textcolor{keyword}{static} \textcolor{keywordtype}{void} zmalloc\_default\_oom(size\_t size) \{
00089     fprintf(stderr, \textcolor{stringliteral}{"zmalloc: Out of memory trying to allocate %zu bytes\(\backslash\)n"},
00090         size);
00091     fflush(stderr);
00092     abort();
00093 \}
00094 
00095 \textcolor{keyword}{static} \textcolor{keywordtype}{void} (*zmalloc\_oom\_handler)(size\_t) = zmalloc\_default\_oom;
00096 
00097 \textcolor{keywordtype}{void} *zmalloc(size\_t size) \{
00098     \textcolor{keywordtype}{void} *ptr = malloc(size+\hyperlink{zmalloc_8c_abe208177340b58cb5096daabe07922d1}{PREFIX\_SIZE});
00099 
00100     \textcolor{keywordflow}{if} (!ptr) zmalloc\_oom\_handler(size);
00101 \textcolor{preprocessor}{#}\textcolor{preprocessor}{ifdef} \textcolor{preprocessor}{HAVE\_MALLOC\_SIZE}
00102     update\_zmalloc\_stat\_alloc(zmalloc\_size(ptr));
00103     \textcolor{keywordflow}{return} ptr;
00104 \textcolor{preprocessor}{#}\textcolor{preprocessor}{else}
00105     *((size\_t*)ptr) = size;
00106     \hyperlink{zmalloc_8c_adc62adb8ec66924b8eaf16c123e1eb9c}{update\_zmalloc\_stat\_alloc}(size+\hyperlink{zmalloc_8c_abe208177340b58cb5096daabe07922d1}{PREFIX\_SIZE});
00107     \textcolor{keywordflow}{return} (\textcolor{keywordtype}{char}*)ptr+\hyperlink{zmalloc_8c_abe208177340b58cb5096daabe07922d1}{PREFIX\_SIZE};
00108 \textcolor{preprocessor}{#}\textcolor{preprocessor}{endif}
00109 \}
00110 
00111 \textcolor{comment}{/* Allocation and free functions that bypass the thread cache}
00112 \textcolor{comment}{ * and go straight to the allocator arena bins.}
00113 \textcolor{comment}{ * Currently implemented only for jemalloc. Used for online defragmentation. */}
00114 \textcolor{preprocessor}{#}\textcolor{preprocessor}{ifdef} \textcolor{preprocessor}{HAVE\_DEFRAG}
00115 \textcolor{keywordtype}{void} *zmalloc\_no\_tcache(size\_t size) \{
00116     \textcolor{keywordtype}{void} *ptr = mallocx(size+PREFIX\_SIZE, MALLOCX\_TCACHE\_NONE);
00117     \textcolor{keywordflow}{if} (!ptr) zmalloc\_oom\_handler(size);
00118     update\_zmalloc\_stat\_alloc(zmalloc\_size(ptr));
00119     \textcolor{keywordflow}{return} ptr;
00120 \}
00121 
00122 \textcolor{keywordtype}{void} zfree\_no\_tcache(\textcolor{keywordtype}{void} *ptr) \{
00123     \textcolor{keywordflow}{if} (ptr == NULL) \textcolor{keywordflow}{return};
00124     update\_zmalloc\_stat\_free(zmalloc\_size(ptr));
00125     dallocx(ptr, MALLOCX\_TCACHE\_NONE);
00126 \}
00127 \textcolor{preprocessor}{#}\textcolor{preprocessor}{endif}
00128 
00129 \textcolor{keywordtype}{void} *zcalloc(size\_t size) \{
00130     \textcolor{keywordtype}{void} *ptr = calloc(1, size+\hyperlink{zmalloc_8c_abe208177340b58cb5096daabe07922d1}{PREFIX\_SIZE});
00131 
00132     \textcolor{keywordflow}{if} (!ptr) zmalloc\_oom\_handler(size);
00133 \textcolor{preprocessor}{#}\textcolor{preprocessor}{ifdef} \textcolor{preprocessor}{HAVE\_MALLOC\_SIZE}
00134     update\_zmalloc\_stat\_alloc(zmalloc\_size(ptr));
00135     \textcolor{keywordflow}{return} ptr;
00136 \textcolor{preprocessor}{#}\textcolor{preprocessor}{else}
00137     *((size\_t*)ptr) = size;
00138     \hyperlink{zmalloc_8c_adc62adb8ec66924b8eaf16c123e1eb9c}{update\_zmalloc\_stat\_alloc}(size+\hyperlink{zmalloc_8c_abe208177340b58cb5096daabe07922d1}{PREFIX\_SIZE});
00139     \textcolor{keywordflow}{return} (\textcolor{keywordtype}{char}*)ptr+\hyperlink{zmalloc_8c_abe208177340b58cb5096daabe07922d1}{PREFIX\_SIZE};
00140 \textcolor{preprocessor}{#}\textcolor{preprocessor}{endif}
00141 \}
00142 
00143 \textcolor{keywordtype}{void} *zrealloc(\textcolor{keywordtype}{void} *ptr, size\_t size) \{
00144 \textcolor{preprocessor}{#}\textcolor{preprocessor}{ifndef} \textcolor{preprocessor}{HAVE\_MALLOC\_SIZE}
00145     \textcolor{keywordtype}{void} *realptr;
00146 \textcolor{preprocessor}{#}\textcolor{preprocessor}{endif}
00147     size\_t oldsize;
00148     \textcolor{keywordtype}{void} *newptr;
00149 
00150     \textcolor{keywordflow}{if} (ptr == NULL) \textcolor{keywordflow}{return} zmalloc(size);
00151 \textcolor{preprocessor}{#}\textcolor{preprocessor}{ifdef} \textcolor{preprocessor}{HAVE\_MALLOC\_SIZE}
00152     oldsize = zmalloc\_size(ptr);
00153     newptr = realloc(ptr,size);
00154     \textcolor{keywordflow}{if} (!newptr) zmalloc\_oom\_handler(size);
00155 
00156     update\_zmalloc\_stat\_free(oldsize);
00157     update\_zmalloc\_stat\_alloc(zmalloc\_size(newptr));
00158     \textcolor{keywordflow}{return} newptr;
00159 \textcolor{preprocessor}{#}\textcolor{preprocessor}{else}
00160     realptr = (\textcolor{keywordtype}{char}*)ptr-\hyperlink{zmalloc_8c_abe208177340b58cb5096daabe07922d1}{PREFIX\_SIZE};
00161     oldsize = *((size\_t*)realptr);
00162     newptr = realloc(realptr,size+\hyperlink{zmalloc_8c_abe208177340b58cb5096daabe07922d1}{PREFIX\_SIZE});
00163     \textcolor{keywordflow}{if} (!newptr) zmalloc\_oom\_handler(size);
00164 
00165     *((size\_t*)newptr) = size;
00166     \hyperlink{zmalloc_8c_a9be7d44298f111e7d7f69abb0b41f391}{update\_zmalloc\_stat\_free}(oldsize);
00167     \hyperlink{zmalloc_8c_adc62adb8ec66924b8eaf16c123e1eb9c}{update\_zmalloc\_stat\_alloc}(size);
00168     \textcolor{keywordflow}{return} (\textcolor{keywordtype}{char}*)newptr+\hyperlink{zmalloc_8c_abe208177340b58cb5096daabe07922d1}{PREFIX\_SIZE};
00169 \textcolor{preprocessor}{#}\textcolor{preprocessor}{endif}
00170 \}
00171 
00172 \textcolor{comment}{/* Provide zmalloc\_size() for systems where this function is not provided by}
00173 \textcolor{comment}{ * malloc itself, given that in that case we store a header with this}
00174 \textcolor{comment}{ * information as the first bytes of every allocation. */}
00175 \textcolor{preprocessor}{#}\textcolor{preprocessor}{ifndef} \textcolor{preprocessor}{HAVE\_MALLOC\_SIZE}
00176 size\_t zmalloc\_size(\textcolor{keywordtype}{void} *ptr) \{
00177     \textcolor{keywordtype}{void} *realptr = (\textcolor{keywordtype}{char}*)ptr-\hyperlink{zmalloc_8c_abe208177340b58cb5096daabe07922d1}{PREFIX\_SIZE};
00178     size\_t size = *((size\_t*)realptr);
00179     \textcolor{comment}{/* Assume at least that all the allocations are padded at sizeof(long) by}
00180 \textcolor{comment}{     * the underlying allocator. */}
00181     \textcolor{keywordflow}{if} (size&(\textcolor{keyword}{sizeof}(\textcolor{keywordtype}{long})-1)) size += \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{long})-(size&(\textcolor{keyword}{sizeof}(\textcolor{keywordtype}{long})-1));
00182     \textcolor{keywordflow}{return} size+\hyperlink{zmalloc_8c_abe208177340b58cb5096daabe07922d1}{PREFIX\_SIZE};
00183 \}
00184 \textcolor{preprocessor}{#}\textcolor{preprocessor}{endif}
00185 
00186 \textcolor{keywordtype}{void} zfree(\textcolor{keywordtype}{void} *ptr) \{
00187 \textcolor{preprocessor}{#}\textcolor{preprocessor}{ifndef} \textcolor{preprocessor}{HAVE\_MALLOC\_SIZE}
00188     \textcolor{keywordtype}{void} *realptr;
00189     size\_t oldsize;
00190 \textcolor{preprocessor}{#}\textcolor{preprocessor}{endif}
00191 
00192     \textcolor{keywordflow}{if} (ptr == NULL) \textcolor{keywordflow}{return};
00193 \textcolor{preprocessor}{#}\textcolor{preprocessor}{ifdef} \textcolor{preprocessor}{HAVE\_MALLOC\_SIZE}
00194     update\_zmalloc\_stat\_free(zmalloc\_size(ptr));
00195     free(ptr);
00196 \textcolor{preprocessor}{#}\textcolor{preprocessor}{else}
00197     realptr = (\textcolor{keywordtype}{char}*)ptr-\hyperlink{zmalloc_8c_abe208177340b58cb5096daabe07922d1}{PREFIX\_SIZE};
00198     oldsize = *((size\_t*)realptr);
00199     \hyperlink{zmalloc_8c_a9be7d44298f111e7d7f69abb0b41f391}{update\_zmalloc\_stat\_free}(oldsize+\hyperlink{zmalloc_8c_abe208177340b58cb5096daabe07922d1}{PREFIX\_SIZE});
00200     free(realptr);
00201 \textcolor{preprocessor}{#}\textcolor{preprocessor}{endif}
00202 \}
00203 
00204 \textcolor{keywordtype}{char} *zstrdup(\textcolor{keyword}{const} \textcolor{keywordtype}{char} *s) \{
00205     size\_t l = strlen(s)+1;
00206     \textcolor{keywordtype}{char} *p = zmalloc(l);
00207 
00208     memcpy(p,s,l);
00209     \textcolor{keywordflow}{return} p;
00210 \}
00211 
00212 size\_t zmalloc\_used\_memory(\textcolor{keywordtype}{void}) \{
00213     size\_t um;
00214     \hyperlink{atomicvar_8h_a57b17e058ecff6871debb3d1d4f3031a}{atomicGet}(used\_memory,um);
00215     \textcolor{keywordflow}{return} um;
00216 \}
00217 
00218 \textcolor{keywordtype}{void} zmalloc\_set\_oom\_handler(\textcolor{keywordtype}{void} (*oom\_handler)(size\_t)) \{
00219     zmalloc\_oom\_handler = oom\_handler;
00220 \}
00221 
00222 \textcolor{comment}{/* Get the RSS information in an OS-specific way.}
00223 \textcolor{comment}{ *}
00224 \textcolor{comment}{ * WARNING: the function zmalloc\_get\_rss() is not designed to be fast}
00225 \textcolor{comment}{ * and may not be called in the busy loops where Redis tries to release}
00226 \textcolor{comment}{ * memory expiring or swapping out objects.}
00227 \textcolor{comment}{ *}
00228 \textcolor{comment}{ * For this kind of "fast RSS reporting" usages use instead the}
00229 \textcolor{comment}{ * function RedisEstimateRSS() that is a much faster (and less precise)}
00230 \textcolor{comment}{ * version of the function. */}
00231 
00232 \textcolor{preprocessor}{#}\textcolor{preprocessor}{if} \textcolor{preprocessor}{defined}\textcolor{preprocessor}{(}HAVE\_PROC\_STAT\textcolor{preprocessor}{)}
00233 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{unistd}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00234 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{sys}\textcolor{preprocessor}{/}\textcolor{preprocessor}{types}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00235 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{sys}\textcolor{preprocessor}{/}\textcolor{preprocessor}{stat}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00236 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{fcntl}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00237 
00238 size\_t zmalloc\_get\_rss(\textcolor{keywordtype}{void}) \{
00239     \textcolor{keywordtype}{int} page = sysconf(\_SC\_PAGESIZE);
00240     size\_t rss;
00241     \textcolor{keywordtype}{char} buf[4096];
00242     \textcolor{keywordtype}{char} filename[256];
00243     \textcolor{keywordtype}{int} fd, count;
00244     \textcolor{keywordtype}{char} *p, *x;
00245 
00246     snprintf(filename,256,\textcolor{stringliteral}{"/proc/%d/stat"},getpid());
00247     \textcolor{keywordflow}{if} ((fd = open(filename,O\_RDONLY)) == -1) \textcolor{keywordflow}{return} 0;
00248     \textcolor{keywordflow}{if} (read(fd,buf,4096) <= 0) \{
00249         close(fd);
00250         \textcolor{keywordflow}{return} 0;
00251     \}
00252     close(fd);
00253 
00254     p = buf;
00255     count = 23; \textcolor{comment}{/* RSS is the 24th field in /proc/<pid>/stat */}
00256     \textcolor{keywordflow}{while}(p && count--) \{
00257         p = strchr(p,\textcolor{stringliteral}{' '});
00258         \textcolor{keywordflow}{if} (p) p++;
00259     \}
00260     \textcolor{keywordflow}{if} (!p) \textcolor{keywordflow}{return} 0;
00261     x = strchr(p,\textcolor{stringliteral}{' '});
00262     \textcolor{keywordflow}{if} (!x) \textcolor{keywordflow}{return} 0;
00263     *x = \textcolor{stringliteral}{'\(\backslash\)0'};
00264 
00265     rss = strtoll(p,NULL,10);
00266     rss *= page;
00267     \textcolor{keywordflow}{return} rss;
00268 \}
00269 \textcolor{preprocessor}{#}\textcolor{preprocessor}{elif} \textcolor{preprocessor}{defined}\textcolor{preprocessor}{(}\textcolor{preprocessor}{HAVE\_TASKINFO}\textcolor{preprocessor}{)}
00270 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{unistd}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00271 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{stdio}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00272 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{stdlib}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00273 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{sys}\textcolor{preprocessor}{/}\textcolor{preprocessor}{types}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00274 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{sys}\textcolor{preprocessor}{/}\textcolor{preprocessor}{sysctl}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00275 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{mach}\textcolor{preprocessor}{/}\textcolor{preprocessor}{task}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00276 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{mach}\textcolor{preprocessor}{/}\textcolor{preprocessor}{mach\_init}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00277 
00278 size\_t zmalloc\_get\_rss(\textcolor{keywordtype}{void}) \{
00279     task\_t task = MACH\_PORT\_NULL;
00280     \textcolor{keyword}{struct} task\_basic\_info t\_info;
00281     mach\_msg\_type\_number\_t t\_info\_count = TASK\_BASIC\_INFO\_COUNT;
00282 
00283     \textcolor{keywordflow}{if} (task\_for\_pid(current\_task(), getpid(), &task) != KERN\_SUCCESS)
00284         \textcolor{keywordflow}{return} 0;
00285     task\_info(task, TASK\_BASIC\_INFO, (task\_info\_t)&t\_info, &t\_info\_count);
00286 
00287     \textcolor{keywordflow}{return} t\_info.resident\_size;
00288 \}
00289 \textcolor{preprocessor}{#}\textcolor{preprocessor}{else}
00290 size\_t zmalloc\_get\_rss(\textcolor{keywordtype}{void}) \{
00291     \textcolor{comment}{/* If we can't get the RSS in an OS-specific way for this system just}
00292 \textcolor{comment}{     * return the memory usage we estimated in zmalloc()..}
00293 \textcolor{comment}{     *}
00294 \textcolor{comment}{     * Fragmentation will appear to be always 1 (no fragmentation)}
00295 \textcolor{comment}{     * of course... */}
00296     \textcolor{keywordflow}{return} zmalloc\_used\_memory();
00297 \}
00298 \textcolor{preprocessor}{#}\textcolor{preprocessor}{endif}
00299 
00300 \textcolor{comment}{/* Fragmentation = RSS / allocated-bytes */}
00301 \textcolor{keywordtype}{float} zmalloc\_get\_fragmentation\_ratio(size\_t rss) \{
00302     \textcolor{keywordflow}{return} (\textcolor{keywordtype}{float})rss/zmalloc\_used\_memory();
00303 \}
00304 
00305 \textcolor{comment}{/* Get the sum of the specified field (converted form kb to bytes) in}
00306 \textcolor{comment}{ * /proc/self/smaps. The field must be specified with trailing ":" as it}
00307 \textcolor{comment}{ * apperas in the smaps output.}
00308 \textcolor{comment}{ *}
00309 \textcolor{comment}{ * If a pid is specified, the information is extracted for such a pid,}
00310 \textcolor{comment}{ * otherwise if pid is -1 the information is reported is about the}
00311 \textcolor{comment}{ * current process.}
00312 \textcolor{comment}{ *}
00313 \textcolor{comment}{ * Example: zmalloc\_get\_smap\_bytes\_by\_field("Rss:",-1);}
00314 \textcolor{comment}{ */}
00315 \textcolor{preprocessor}{#}\textcolor{preprocessor}{if} \textcolor{preprocessor}{defined}\textcolor{preprocessor}{(}HAVE\_PROC\_SMAPS\textcolor{preprocessor}{)}
00316 size\_t zmalloc\_get\_smap\_bytes\_by\_field(\textcolor{keywordtype}{char} *field, \textcolor{keywordtype}{long} pid) \{
00317     \textcolor{keywordtype}{char} line[1024];
00318     size\_t bytes = 0;
00319     \textcolor{keywordtype}{int} flen = strlen(field);
00320     FILE *fp;
00321 
00322     \textcolor{keywordflow}{if} (pid == -1) \{
00323         fp = fopen(\textcolor{stringliteral}{"/proc/self/smaps"},\textcolor{stringliteral}{"r"});
00324     \} \textcolor{keywordflow}{else} \{
00325         \textcolor{keywordtype}{char} filename[128];
00326         snprintf(filename,\textcolor{keyword}{sizeof}(filename),\textcolor{stringliteral}{"/proc/%ld/smaps"},pid);
00327         fp = fopen(filename,\textcolor{stringliteral}{"r"});
00328     \}
00329 
00330     \textcolor{keywordflow}{if} (!fp) \textcolor{keywordflow}{return} 0;
00331     \textcolor{keywordflow}{while}(fgets(line,\textcolor{keyword}{sizeof}(line),fp) != NULL) \{
00332         \textcolor{keywordflow}{if} (strncmp(line,field,flen) == 0) \{
00333             \textcolor{keywordtype}{char} *p = strchr(line,\textcolor{stringliteral}{'k'});
00334             \textcolor{keywordflow}{if} (p) \{
00335                 *p = \textcolor{stringliteral}{'\(\backslash\)0'};
00336                 bytes += strtol(line+flen,NULL,10) * 1024;
00337             \}
00338         \}
00339     \}
00340     fclose(fp);
00341     \textcolor{keywordflow}{return} bytes;
00342 \}
00343 \textcolor{preprocessor}{#}\textcolor{preprocessor}{else}
00344 size\_t zmalloc\_get\_smap\_bytes\_by\_field(\textcolor{keywordtype}{char} *field, \textcolor{keywordtype}{long} pid) \{
00345     ((\textcolor{keywordtype}{void}) field);
00346     ((\textcolor{keywordtype}{void}) pid);
00347     \textcolor{keywordflow}{return} 0;
00348 \}
00349 \textcolor{preprocessor}{#}\textcolor{preprocessor}{endif}
00350 
00351 size\_t zmalloc\_get\_private\_dirty(\textcolor{keywordtype}{long} pid) \{
00352     \textcolor{keywordflow}{return} zmalloc\_get\_smap\_bytes\_by\_field(\textcolor{stringliteral}{"Private\_Dirty:"},pid);
00353 \}
00354 
00355 \textcolor{comment}{/* Returns the size of physical memory (RAM) in bytes.}
00356 \textcolor{comment}{ * It looks ugly, but this is the cleanest way to achive cross platform results.}
00357 \textcolor{comment}{ * Cleaned up from:}
00358 \textcolor{comment}{ *}
00359 \textcolor{comment}{ * http://nadeausoftware.com/articles/2012/09/c\_c\_tip\_how\_get\_physical\_memory\_size\_system}
00360 \textcolor{comment}{ *}
00361 \textcolor{comment}{ * Note that this function:}
00362 \textcolor{comment}{ * 1) Was released under the following CC attribution license:}
00363 \textcolor{comment}{ *    http://creativecommons.org/licenses/by/3.0/deed.en\_US.}
00364 \textcolor{comment}{ * 2) Was originally implemented by David Robert Nadeau.}
00365 \textcolor{comment}{ * 3) Was modified for Redis by Matt Stancliff.}
00366 \textcolor{comment}{ * 4) This note exists in order to comply with the original license.}
00367 \textcolor{comment}{ */}
00368 size\_t zmalloc\_get\_memory\_size(\textcolor{keywordtype}{void}) \{
00369 \textcolor{preprocessor}{#}\textcolor{preprocessor}{if} \textcolor{preprocessor}{defined}\textcolor{preprocessor}{(}\_\_unix\_\_\textcolor{preprocessor}{)} \textcolor{preprocessor}{||} \textcolor{preprocessor}{defined}\textcolor{preprocessor}{(}\_\_unix\textcolor{preprocessor}{)} \textcolor{preprocessor}{||} \textcolor{preprocessor}{defined}\textcolor{preprocessor}{(}unix\textcolor{preprocessor}{)} \textcolor{preprocessor}{||}
00370     \textcolor{preprocessor}{(}\textcolor{preprocessor}{defined}\textcolor{preprocessor}{(}\textcolor{preprocessor}{\_\_APPLE\_\_}\textcolor{preprocessor}{)} \textcolor{preprocessor}{&&} \textcolor{preprocessor}{defined}\textcolor{preprocessor}{(}\textcolor{preprocessor}{\_\_MACH\_\_}\textcolor{preprocessor}{)}\textcolor{preprocessor}{)}
00371 \textcolor{preprocessor}{#}\textcolor{preprocessor}{if} \textcolor{preprocessor}{defined}\textcolor{preprocessor}{(}\textcolor{preprocessor}{CTL\_HW}\textcolor{preprocessor}{)} \textcolor{preprocessor}{&&} \textcolor{preprocessor}{(}\textcolor{preprocessor}{defined}\textcolor{preprocessor}{(}\textcolor{preprocessor}{HW\_MEMSIZE}\textcolor{preprocessor}{)} \textcolor{preprocessor}{||} \textcolor{preprocessor}{defined}\textcolor{preprocessor}{(}\textcolor{preprocessor}{HW\_PHYSMEM64}\textcolor{preprocessor}{)}\textcolor{preprocessor}{)}
00372     \textcolor{keywordtype}{int} mib[2];
00373     mib[0] = CTL\_HW;
00374 \textcolor{preprocessor}{#}\textcolor{preprocessor}{if} \textcolor{preprocessor}{defined}\textcolor{preprocessor}{(}\textcolor{preprocessor}{HW\_MEMSIZE}\textcolor{preprocessor}{)}
00375     mib[1] = HW\_MEMSIZE;            \textcolor{comment}{/* OSX. --------------------- */}
00376 \textcolor{preprocessor}{#}\textcolor{preprocessor}{elif} \textcolor{preprocessor}{defined}\textcolor{preprocessor}{(}\textcolor{preprocessor}{HW\_PHYSMEM64}\textcolor{preprocessor}{)}
00377     mib[1] = HW\_PHYSMEM64;          \textcolor{comment}{/* NetBSD, OpenBSD. --------- */}
00378 \textcolor{preprocessor}{#}\textcolor{preprocessor}{endif}
00379     int64\_t size = 0;               \textcolor{comment}{/* 64-bit */}
00380     size\_t len = \textcolor{keyword}{sizeof}(size);
00381     \textcolor{keywordflow}{if} (sysctl( mib, 2, &size, &len, NULL, 0) == 0)
00382         \textcolor{keywordflow}{return} (size\_t)size;
00383     \textcolor{keywordflow}{return} 0L;          \textcolor{comment}{/* Failed? */}
00384 
00385 \textcolor{preprocessor}{#}\textcolor{preprocessor}{elif} \textcolor{preprocessor}{defined}\textcolor{preprocessor}{(}\_SC\_PHYS\_PAGES\textcolor{preprocessor}{)} \textcolor{preprocessor}{&&} \textcolor{preprocessor}{defined}\textcolor{preprocessor}{(}\_SC\_PAGESIZE\textcolor{preprocessor}{)}
00386     \textcolor{comment}{/* FreeBSD, Linux, OpenBSD, and Solaris. -------------------- */}
00387     \textcolor{keywordflow}{return} (size\_t)sysconf(\_SC\_PHYS\_PAGES) * (size\_t)sysconf(\_SC\_PAGESIZE);
00388 
00389 \textcolor{preprocessor}{#}\textcolor{preprocessor}{elif} \textcolor{preprocessor}{defined}\textcolor{preprocessor}{(}\textcolor{preprocessor}{CTL\_HW}\textcolor{preprocessor}{)} \textcolor{preprocessor}{&&} \textcolor{preprocessor}{(}\textcolor{preprocessor}{defined}\textcolor{preprocessor}{(}\textcolor{preprocessor}{HW\_PHYSMEM}\textcolor{preprocessor}{)} \textcolor{preprocessor}{||} \textcolor{preprocessor}{defined}\textcolor{preprocessor}{(}\textcolor{preprocessor}{HW\_REALMEM}\textcolor{preprocessor}{)}\textcolor{preprocessor}{)}
00390     \textcolor{comment}{/* DragonFly BSD, FreeBSD, NetBSD, OpenBSD, and OSX. -------- */}
00391     \textcolor{keywordtype}{int} mib[2];
00392     mib[0] = CTL\_HW;
00393 \textcolor{preprocessor}{#}\textcolor{preprocessor}{if} \textcolor{preprocessor}{defined}\textcolor{preprocessor}{(}\textcolor{preprocessor}{HW\_REALMEM}\textcolor{preprocessor}{)}
00394     mib[1] = HW\_REALMEM;        \textcolor{comment}{/* FreeBSD. ----------------- */}
00395 \textcolor{preprocessor}{#}\textcolor{preprocessor}{elif} \textcolor{preprocessor}{defined}\textcolor{preprocessor}{(}\textcolor{preprocessor}{HW\_PYSMEM}\textcolor{preprocessor}{)}
00396     mib[1] = HW\_PHYSMEM;        \textcolor{comment}{/* Others. ------------------ */}
00397 \textcolor{preprocessor}{#}\textcolor{preprocessor}{endif}
00398     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} size = 0;      \textcolor{comment}{/* 32-bit */}
00399     size\_t len = \textcolor{keyword}{sizeof}(size);
00400     \textcolor{keywordflow}{if} (sysctl(mib, 2, &size, &len, NULL, 0) == 0)
00401         \textcolor{keywordflow}{return} (size\_t)size;
00402     \textcolor{keywordflow}{return} 0L;          \textcolor{comment}{/* Failed? */}
00403 \textcolor{preprocessor}{#}\textcolor{preprocessor}{else}
00404     \textcolor{keywordflow}{return} 0L;          \textcolor{comment}{/* Unknown method to get the data. */}
00405 \textcolor{preprocessor}{#}\textcolor{preprocessor}{endif}
00406 \textcolor{preprocessor}{#}\textcolor{preprocessor}{else}
00407     \textcolor{keywordflow}{return} 0L;          \textcolor{comment}{/* Unknown OS. */}
00408 \textcolor{preprocessor}{#}\textcolor{preprocessor}{endif}
00409 \}
\end{DoxyCode}
