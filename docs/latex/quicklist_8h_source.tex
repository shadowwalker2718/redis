\hypertarget{quicklist_8h_source}{}\section{quicklist.\+h}
\label{quicklist_8h_source}\index{src/quicklist.\+h@{src/quicklist.\+h}}

\begin{DoxyCode}
00001 \textcolor{comment}{/* quicklist.h - A generic doubly linked quicklist implementation}
00002 \textcolor{comment}{ *}
00003 \textcolor{comment}{ * Copyright (c) 2014, Matt Stancliff <matt@genges.com>}
00004 \textcolor{comment}{ * All rights reserved.}
00005 \textcolor{comment}{ *}
00006 \textcolor{comment}{ * Redistribution and use in source and binary forms, with or without}
00007 \textcolor{comment}{ * modification, are permitted provided that the following conditions are met:}
00008 \textcolor{comment}{ *}
00009 \textcolor{comment}{ *   * Redistributions of source code must retain the above copyright notice,}
00010 \textcolor{comment}{ *     this quicklist of conditions and the following disclaimer.}
00011 \textcolor{comment}{ *   * Redistributions in binary form must reproduce the above copyright}
00012 \textcolor{comment}{ *     notice, this quicklist of conditions and the following disclaimer in the}
00013 \textcolor{comment}{ *     documentation and/or other materials provided with the distribution.}
00014 \textcolor{comment}{ *   * Neither the name of Redis nor the names of its contributors may be used}
00015 \textcolor{comment}{ *     to endorse or promote products derived from this software without}
00016 \textcolor{comment}{ *     specific prior written permission.}
00017 \textcolor{comment}{ *}
00018 \textcolor{comment}{ * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"}
00019 \textcolor{comment}{ * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE}
00020 \textcolor{comment}{ * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE}
00021 \textcolor{comment}{ * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE}
00022 \textcolor{comment}{ * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR}
00023 \textcolor{comment}{ * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF}
00024 \textcolor{comment}{ * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS}
00025 \textcolor{comment}{ * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN}
00026 \textcolor{comment}{ * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)}
00027 \textcolor{comment}{ * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE}
00028 \textcolor{comment}{ * POSSIBILITY OF SUCH DAMAGE.}
00029 \textcolor{comment}{ */}
00030 
00031 \textcolor{preprocessor}{#}\textcolor{preprocessor}{ifndef} \textcolor{preprocessor}{\_\_QUICKLIST\_H\_\_}
00032 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{\_\_QUICKLIST\_H\_\_}
00033 
00034 \textcolor{comment}{/* Node, quicklist, and Iterator are the only data structures used currently. */}
00035 
00036 \textcolor{comment}{/* quicklistNode is a 32 byte struct describing a ziplist for a quicklist.}
00037 \textcolor{comment}{ * We use bit fields keep the quicklistNode at 32 bytes.}
00038 \textcolor{comment}{ * count: 16 bits, max 65536 (max zl bytes is 65k, so max count actually < 32k).}
00039 \textcolor{comment}{ * encoding: 2 bits, RAW=1, LZF=2.}
00040 \textcolor{comment}{ * container: 2 bits, NONE=1, ZIPLIST=2.}
00041 \textcolor{comment}{ * recompress: 1 bit, bool, true if node is temporarry decompressed for usage.}
00042 \textcolor{comment}{ * attempted\_compress: 1 bit, boolean, used for verifying during testing.}
00043 \textcolor{comment}{ * extra: 12 bits, free for future use; pads out the remainder of 32 bits */}
\Hypertarget{quicklist_8h_source_l00044}\hyperlink{structquicklistNode}{00044} \textcolor{keyword}{typedef} \textcolor{keyword}{struct} \hyperlink{structquicklistNode}{quicklistNode} \{
00045     \textcolor{keyword}{struct} \hyperlink{structquicklistNode}{quicklistNode} *prev;
00046     \textcolor{keyword}{struct} \hyperlink{structquicklistNode}{quicklistNode} *next;
00047     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char} *zl;
00048     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} sz;             \textcolor{comment}{/* ziplist size in bytes */}
00049     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} count : 16;     \textcolor{comment}{/* count of items in ziplist */}
00050     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} encoding : 2;   \textcolor{comment}{/* RAW==1 or LZF==2 */}
00051     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} container : 2;  \textcolor{comment}{/* NONE==1 or ZIPLIST==2 */}
00052     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} recompress : 1; \textcolor{comment}{/* was this node previous compressed? */}
00053     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} attempted\_compress : 1; \textcolor{comment}{/* node can't compress; too small */}
00054     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} extra : 10; \textcolor{comment}{/* more bits to steal for future usage */}
00055 \} quicklistNode;
00056 
00057 \textcolor{comment}{/* quicklistLZF is a 4+N byte struct holding 'sz' followed by 'compressed'.}
00058 \textcolor{comment}{ * 'sz' is byte length of 'compressed' field.}
00059 \textcolor{comment}{ * 'compressed' is LZF data with total (compressed) length 'sz'}
00060 \textcolor{comment}{ * NOTE: uncompressed length is stored in quicklistNode->sz.}
00061 \textcolor{comment}{ * When quicklistNode->zl is compressed, node->zl points to a quicklistLZF */}
\Hypertarget{quicklist_8h_source_l00062}\hyperlink{structquicklistLZF}{00062} \textcolor{keyword}{typedef} \textcolor{keyword}{struct} \hyperlink{structquicklistLZF}{quicklistLZF} \{
00063     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} sz; \textcolor{comment}{/* LZF size in bytes*/}
00064     \textcolor{keywordtype}{char} compressed[];
00065 \} quicklistLZF;
00066 
00067 \textcolor{comment}{/* quicklist is a 40 byte struct (on 64-bit systems) describing a quicklist.}
00068 \textcolor{comment}{ * 'count' is the number of total entries.}
00069 \textcolor{comment}{ * 'len' is the number of quicklist nodes.}
00070 \textcolor{comment}{ * 'compress' is: -1 if compression disabled, otherwise it's the number}
00071 \textcolor{comment}{ *                of quicklistNodes to leave uncompressed at ends of quicklist.}
00072 \textcolor{comment}{ * 'fill' is the user-requested (or default) fill factor. */}
\Hypertarget{quicklist_8h_source_l00073}\hyperlink{structquicklist}{00073} \textcolor{keyword}{typedef} \textcolor{keyword}{struct} \hyperlink{structquicklist}{quicklist} \{
00074     quicklistNode *head;
00075     quicklistNode *tail;
00076     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{long} count;        \textcolor{comment}{/* total count of all entries in all ziplists */}
00077     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{long} len;          \textcolor{comment}{/* number of quicklistNodes */}
00078     \textcolor{keywordtype}{int} fill : 16;              \textcolor{comment}{/* fill factor for individual nodes */}
00079     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} compress : 16; \textcolor{comment}{/* depth of end nodes not to compress;0=off */}
00080 \} quicklist;
00081 
\Hypertarget{quicklist_8h_source_l00082}\hyperlink{structquicklistIter}{00082} \textcolor{keyword}{typedef} \textcolor{keyword}{struct} \hyperlink{structquicklistIter}{quicklistIter} \{
00083     \textcolor{keyword}{const} quicklist *quicklist;
00084     quicklistNode *current;
00085     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char} *zi;
00086     \textcolor{keywordtype}{long} offset; \textcolor{comment}{/* offset in current ziplist */}
00087     \textcolor{keywordtype}{int} direction;
00088 \} quicklistIter;
00089 
\Hypertarget{quicklist_8h_source_l00090}\hyperlink{structquicklistEntry}{00090} \textcolor{keyword}{typedef} \textcolor{keyword}{struct} \hyperlink{structquicklistEntry}{quicklistEntry} \{
00091     \textcolor{keyword}{const} quicklist *quicklist;
00092     quicklistNode *node;
00093     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char} *zi;
00094     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char} *value;
00095     \textcolor{keywordtype}{long} \textcolor{keywordtype}{long} longval;
00096     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} sz;
00097     \textcolor{keywordtype}{int} offset;
00098 \} quicklistEntry;
00099 
00100 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{QUICKLIST\_HEAD} 0
00101 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{QUICKLIST\_TAIL} \textcolor{preprocessor}{-}1
00102 
00103 \textcolor{comment}{/* quicklist node encodings */}
00104 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{QUICKLIST\_NODE\_ENCODING\_RAW} 1
00105 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{QUICKLIST\_NODE\_ENCODING\_LZF} 2
00106 
00107 \textcolor{comment}{/* quicklist compression disable */}
00108 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{QUICKLIST\_NOCOMPRESS} 0
00109 
00110 \textcolor{comment}{/* quicklist container formats */}
00111 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{QUICKLIST\_NODE\_CONTAINER\_NONE} 1
00112 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{QUICKLIST\_NODE\_CONTAINER\_ZIPLIST} 2
00113 
00114 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{quicklistNodeIsCompressed}\textcolor{preprocessor}{(}\textcolor{preprocessor}{node}\textcolor{preprocessor}{)}
00115     \textcolor{preprocessor}{(}\textcolor{preprocessor}{(}\textcolor{preprocessor}{node}\textcolor{preprocessor}{)}\textcolor{preprocessor}{->}\textcolor{preprocessor}{encoding} \textcolor{preprocessor}{==} \hyperlink{quicklist_8h_a6ce238912d4049e020b686def25c9566}{QUICKLIST\_NODE\_ENCODING\_LZF}\textcolor{preprocessor}{)}
00116 
00117 \textcolor{comment}{/* Prototypes */}
00118 quicklist *quicklistCreate(\textcolor{keywordtype}{void});
00119 quicklist *quicklistNew(\textcolor{keywordtype}{int} fill, \textcolor{keywordtype}{int} compress);
00120 \textcolor{keywordtype}{void} quicklistSetCompressDepth(quicklist *quicklist, \textcolor{keywordtype}{int} depth);
00121 \textcolor{keywordtype}{void} quicklistSetFill(quicklist *quicklist, \textcolor{keywordtype}{int} fill);
00122 \textcolor{keywordtype}{void} quicklistSetOptions(quicklist *quicklist, \textcolor{keywordtype}{int} fill, \textcolor{keywordtype}{int} depth);
00123 \textcolor{keywordtype}{void} quicklistRelease(quicklist *quicklist);
00124 \textcolor{keywordtype}{int} quicklistPushHead(quicklist *quicklist, \textcolor{keywordtype}{void} *value, \textcolor{keyword}{const} size\_t sz);
00125 \textcolor{keywordtype}{int} quicklistPushTail(quicklist *quicklist, \textcolor{keywordtype}{void} *value, \textcolor{keyword}{const} size\_t sz);
00126 \textcolor{keywordtype}{void} quicklistPush(quicklist *quicklist, \textcolor{keywordtype}{void} *value, \textcolor{keyword}{const} size\_t sz,
00127                    \textcolor{keywordtype}{int} where);
00128 \textcolor{keywordtype}{void} quicklistAppendZiplist(quicklist *quicklist, \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char} *zl);
00129 quicklist *quicklistAppendValuesFromZiplist(quicklist *quicklist,
00130                                             \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char} *zl);
00131 quicklist *quicklistCreateFromZiplist(\textcolor{keywordtype}{int} fill, \textcolor{keywordtype}{int} compress,
00132                                       \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char} *zl);
00133 \textcolor{keywordtype}{void} quicklistInsertAfter(quicklist *quicklist, quicklistEntry *node,
00134                           \textcolor{keywordtype}{void} *value, \textcolor{keyword}{const} size\_t sz);
00135 \textcolor{keywordtype}{void} quicklistInsertBefore(quicklist *quicklist, quicklistEntry *node,
00136                            \textcolor{keywordtype}{void} *value, \textcolor{keyword}{const} size\_t sz);
00137 \textcolor{keywordtype}{void} quicklistDelEntry(quicklistIter *iter, quicklistEntry *entry);
00138 \textcolor{keywordtype}{int} quicklistReplaceAtIndex(quicklist *quicklist, \textcolor{keywordtype}{long} index, \textcolor{keywordtype}{void} *data,
00139                             \textcolor{keywordtype}{int} sz);
00140 \textcolor{keywordtype}{int} quicklistDelRange(quicklist *quicklist, \textcolor{keyword}{const} \textcolor{keywordtype}{long} start, \textcolor{keyword}{const} \textcolor{keywordtype}{long} stop);
00141 quicklistIter *quicklistGetIterator(\textcolor{keyword}{const} quicklist *quicklist, \textcolor{keywordtype}{int} direction);
00142 quicklistIter *quicklistGetIteratorAtIdx(\textcolor{keyword}{const} quicklist *quicklist,
00143                                          \textcolor{keywordtype}{int} direction, \textcolor{keyword}{const} \textcolor{keywordtype}{long} \textcolor{keywordtype}{long} idx);
00144 \textcolor{keywordtype}{int} quicklistNext(quicklistIter *iter, quicklistEntry *node);
00145 \textcolor{keywordtype}{void} quicklistReleaseIterator(quicklistIter *iter);
00146 quicklist *quicklistDup(quicklist *orig);
00147 \textcolor{keywordtype}{int} quicklistIndex(\textcolor{keyword}{const} quicklist *quicklist, \textcolor{keyword}{const} \textcolor{keywordtype}{long} \textcolor{keywordtype}{long} index,
00148                    quicklistEntry *entry);
00149 \textcolor{keywordtype}{void} quicklistRewind(quicklist *quicklist, quicklistIter *li);
00150 \textcolor{keywordtype}{void} quicklistRewindTail(quicklist *quicklist, quicklistIter *li);
00151 \textcolor{keywordtype}{void} quicklistRotate(quicklist *quicklist);
00152 \textcolor{keywordtype}{int} quicklistPopCustom(quicklist *quicklist, \textcolor{keywordtype}{int} where, \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char} **data,
00153                        \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} *sz, \textcolor{keywordtype}{long} \textcolor{keywordtype}{long} *sval,
00154                        \textcolor{keywordtype}{void} *(*saver)(\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char} *data, \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} sz));
00155 \textcolor{keywordtype}{int} quicklistPop(quicklist *quicklist, \textcolor{keywordtype}{int} where, \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char} **data,
00156                  \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} *sz, \textcolor{keywordtype}{long} \textcolor{keywordtype}{long} *slong);
00157 \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{long} quicklistCount(\textcolor{keyword}{const} quicklist *ql);
00158 \textcolor{keywordtype}{int} quicklistCompare(\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char} *p1, \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char} *p2, \textcolor{keywordtype}{int} p2\_len);
00159 size\_t quicklistGetLzf(\textcolor{keyword}{const} quicklistNode *node, \textcolor{keywordtype}{void} **data);
00160 
00161 \textcolor{preprocessor}{#}\textcolor{preprocessor}{ifdef} \textcolor{preprocessor}{REDIS\_TEST}
00162 \textcolor{keywordtype}{int} quicklistTest(\textcolor{keywordtype}{int} argc, \textcolor{keywordtype}{char} *argv[]);
00163 \textcolor{preprocessor}{#}\textcolor{preprocessor}{endif}
00164 
00165 \textcolor{comment}{/* Directions for iterators */}
00166 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{AL\_START\_HEAD} 0
00167 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{AL\_START\_TAIL} 1
00168 
00169 \textcolor{preprocessor}{#}\textcolor{preprocessor}{endif} \textcolor{comment}{/* \_\_QUICKLIST\_H\_\_ */}
\end{DoxyCode}
