\hypertarget{ae__epoll_8c_source}{}\section{ae\+\_\+epoll.\+c}
\label{ae__epoll_8c_source}\index{src/ae\+\_\+epoll.\+c@{src/ae\+\_\+epoll.\+c}}

\begin{DoxyCode}
00001 \textcolor{comment}{/* Linux epoll(2) based ae.c module}
00002 \textcolor{comment}{ *}
00003 \textcolor{comment}{ * Copyright (c) 2009-2012, Salvatore Sanfilippo <antirez at gmail dot com>}
00004 \textcolor{comment}{ * All rights reserved.}
00005 \textcolor{comment}{ *}
00006 \textcolor{comment}{ * Redistribution and use in source and binary forms, with or without}
00007 \textcolor{comment}{ * modification, are permitted provided that the following conditions are met:}
00008 \textcolor{comment}{ *}
00009 \textcolor{comment}{ *   * Redistributions of source code must retain the above copyright notice,}
00010 \textcolor{comment}{ *     this list of conditions and the following disclaimer.}
00011 \textcolor{comment}{ *   * Redistributions in binary form must reproduce the above copyright}
00012 \textcolor{comment}{ *     notice, this list of conditions and the following disclaimer in the}
00013 \textcolor{comment}{ *     documentation and/or other materials provided with the distribution.}
00014 \textcolor{comment}{ *   * Neither the name of Redis nor the names of its contributors may be used}
00015 \textcolor{comment}{ *     to endorse or promote products derived from this software without}
00016 \textcolor{comment}{ *     specific prior written permission.}
00017 \textcolor{comment}{ *}
00018 \textcolor{comment}{ * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"}
00019 \textcolor{comment}{ * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE}
00020 \textcolor{comment}{ * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE}
00021 \textcolor{comment}{ * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE}
00022 \textcolor{comment}{ * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR}
00023 \textcolor{comment}{ * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF}
00024 \textcolor{comment}{ * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS}
00025 \textcolor{comment}{ * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN}
00026 \textcolor{comment}{ * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)}
00027 \textcolor{comment}{ * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE}
00028 \textcolor{comment}{ * POSSIBILITY OF SUCH DAMAGE.}
00029 \textcolor{comment}{ */}
00030 
00031 
00032 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{sys}\textcolor{preprocessor}{/}\textcolor{preprocessor}{epoll}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00033 
\Hypertarget{ae__epoll_8c_source_l00034}\hyperlink{structaeApiState}{00034} \textcolor{keyword}{typedef} \textcolor{keyword}{struct} \hyperlink{structaeApiState}{aeApiState} \{
00035     \textcolor{keywordtype}{int} epfd;
00036     \textcolor{keyword}{struct} epoll\_event *events;
00037 \} aeApiState;
00038 
00039 \textcolor{keyword}{static} \textcolor{keywordtype}{int} aeApiCreate(aeEventLoop *eventLoop) \{
00040     aeApiState *state = zmalloc(\textcolor{keyword}{sizeof}(aeApiState));
00041 
00042     \textcolor{keywordflow}{if} (!state) \textcolor{keywordflow}{return} -1;
00043     state->events = zmalloc(\textcolor{keyword}{sizeof}(\textcolor{keyword}{struct} epoll\_event)*eventLoop->setsize);
00044     \textcolor{keywordflow}{if} (!state->events) \{
00045         zfree(state);
00046         \textcolor{keywordflow}{return} -1;
00047     \}
00048     state->epfd = epoll\_create(1024); \textcolor{comment}{/* 1024 is just a hint for the kernel */}
00049     \textcolor{keywordflow}{if} (state->epfd == -1) \{
00050         zfree(state->events);
00051         zfree(state);
00052         \textcolor{keywordflow}{return} -1;
00053     \}
00054     eventLoop->apidata = state;
00055     \textcolor{keywordflow}{return} 0;
00056 \}
00057 
00058 \textcolor{keyword}{static} \textcolor{keywordtype}{int} aeApiResize(aeEventLoop *eventLoop, \textcolor{keywordtype}{int} setsize) \{
00059     aeApiState *state = eventLoop->apidata;
00060 
00061     state->events = zrealloc(state->events, \textcolor{keyword}{sizeof}(\textcolor{keyword}{struct} epoll\_event)*setsize);
00062     \textcolor{keywordflow}{return} 0;
00063 \}
00064 
00065 \textcolor{keyword}{static} \textcolor{keywordtype}{void} aeApiFree(aeEventLoop *eventLoop) \{
00066     aeApiState *state = eventLoop->apidata;
00067 
00068     close(state->epfd);
00069     zfree(state->events);
00070     zfree(state);
00071 \}
00072 
00073 \textcolor{keyword}{static} \textcolor{keywordtype}{int} aeApiAddEvent(aeEventLoop *eventLoop, \textcolor{keywordtype}{int} fd, \textcolor{keywordtype}{int} mask) \{
00074     aeApiState *state = eventLoop->apidata;
00075     \textcolor{keyword}{struct} epoll\_event ee = \{0\}; \textcolor{comment}{/* avoid valgrind warning */}
00076     \textcolor{comment}{/* If the fd was already monitored for some event, we need a MOD}
00077 \textcolor{comment}{     * operation. Otherwise we need an ADD operation. */}
00078     \textcolor{keywordtype}{int} op = eventLoop->events[fd].mask == AE\_NONE ?
00079             EPOLL\_CTL\_ADD : EPOLL\_CTL\_MOD;
00080 
00081     ee.events = 0;
00082     mask |= eventLoop->events[fd].mask; \textcolor{comment}{/* Merge old events */}
00083     \textcolor{keywordflow}{if} (mask & AE\_READABLE) ee.events |= EPOLLIN;
00084     \textcolor{keywordflow}{if} (mask & AE\_WRITABLE) ee.events |= EPOLLOUT;
00085     ee.data.fd = fd;
00086     \textcolor{keywordflow}{if} (epoll\_ctl(state->epfd,op,fd,&ee) == -1) \textcolor{keywordflow}{return} -1;
00087     \textcolor{keywordflow}{return} 0;
00088 \}
00089 
00090 \textcolor{keyword}{static} \textcolor{keywordtype}{void} aeApiDelEvent(aeEventLoop *eventLoop, \textcolor{keywordtype}{int} fd, \textcolor{keywordtype}{int} delmask) \{
00091     aeApiState *state = eventLoop->apidata;
00092     \textcolor{keyword}{struct} epoll\_event ee = \{0\}; \textcolor{comment}{/* avoid valgrind warning */}
00093     \textcolor{keywordtype}{int} mask = eventLoop->events[fd].mask & (~delmask);
00094 
00095     ee.events = 0;
00096     \textcolor{keywordflow}{if} (mask & AE\_READABLE) ee.events |= EPOLLIN;
00097     \textcolor{keywordflow}{if} (mask & AE\_WRITABLE) ee.events |= EPOLLOUT;
00098     ee.data.fd = fd;
00099     \textcolor{keywordflow}{if} (mask != AE\_NONE) \{
00100         epoll\_ctl(state->epfd,EPOLL\_CTL\_MOD,fd,&ee);
00101     \} \textcolor{keywordflow}{else} \{
00102         \textcolor{comment}{/* Note, Kernel < 2.6.9 requires a non null event pointer even for}
00103 \textcolor{comment}{         * EPOLL\_CTL\_DEL. */}
00104         epoll\_ctl(state->epfd,EPOLL\_CTL\_DEL,fd,&ee);
00105     \}
00106 \}
00107 
00108 \textcolor{keyword}{static} \textcolor{keywordtype}{int} aeApiPoll(aeEventLoop *eventLoop, \textcolor{keyword}{struct} timeval *tvp) \{
00109     aeApiState *state = eventLoop->apidata;
00110     \textcolor{keywordtype}{int} retval, numevents = 0;
00111 
00112     retval = epoll\_wait(state->epfd,state->events,eventLoop->setsize,
00113             tvp ? (tvp->tv\_sec*1000 + tvp->tv\_usec/1000) : -1);
00114     \textcolor{keywordflow}{if} (retval > 0) \{
00115         \textcolor{keywordtype}{int} j;
00116 
00117         numevents = retval;
00118         \textcolor{keywordflow}{for} (j = 0; j < numevents; j++) \{
00119             \textcolor{keywordtype}{int} mask = 0;
00120             \textcolor{keyword}{struct} epoll\_event *e = state->events+j;
00121 
00122             \textcolor{keywordflow}{if} (e->events & EPOLLIN) mask |= AE\_READABLE;
00123             \textcolor{keywordflow}{if} (e->events & EPOLLOUT) mask |= AE\_WRITABLE;
00124             \textcolor{keywordflow}{if} (e->events & EPOLLERR) mask |= AE\_WRITABLE;
00125             \textcolor{keywordflow}{if} (e->events & EPOLLHUP) mask |= AE\_WRITABLE;
00126             eventLoop->fired[j].fd = e->data.fd;
00127             eventLoop->fired[j].mask = mask;
00128         \}
00129     \}
00130     \textcolor{keywordflow}{return} numevents;
00131 \}
00132 
00133 \textcolor{keyword}{static} \textcolor{keywordtype}{char} *aeApiName(\textcolor{keywordtype}{void}) \{
00134     \textcolor{keywordflow}{return} \textcolor{stringliteral}{"epoll"};
00135 \}
\end{DoxyCode}
