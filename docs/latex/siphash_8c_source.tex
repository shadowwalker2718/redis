\hypertarget{siphash_8c_source}{}\section{siphash.\+c}
\label{siphash_8c_source}\index{src/siphash.\+c@{src/siphash.\+c}}

\begin{DoxyCode}
00001 \textcolor{comment}{/*}
00002 \textcolor{comment}{   SipHash reference C implementation}
00003 \textcolor{comment}{}
00004 \textcolor{comment}{   Copyright (c) 2012-2016 Jean-Philippe Aumasson}
00005 \textcolor{comment}{   <jeanphilippe.aumasson@gmail.com>}
00006 \textcolor{comment}{   Copyright (c) 2012-2014 Daniel J. Bernstein <djb@cr.yp.to>}
00007 \textcolor{comment}{   Copyright (c) 2017 Salvatore Sanfilippo <antirez@gmail.com>}
00008 \textcolor{comment}{}
00009 \textcolor{comment}{   To the extent possible under law, the author(s) have dedicated all copyright}
00010 \textcolor{comment}{   and related and neighboring rights to this software to the public domain}
00011 \textcolor{comment}{   worldwide. This software is distributed without any warranty.}
00012 \textcolor{comment}{}
00013 \textcolor{comment}{   You should have received a copy of the CC0 Public Domain Dedication along}
00014 \textcolor{comment}{   with this software. If not, see}
00015 \textcolor{comment}{   <http://creativecommons.org/publicdomain/zero/1.0/>.}
00016 \textcolor{comment}{}
00017 \textcolor{comment}{   ----------------------------------------------------------------------------}
00018 \textcolor{comment}{}
00019 \textcolor{comment}{   This version was modified by Salvatore Sanfilippo <antirez@gmail.com>}
00020 \textcolor{comment}{   in the following ways:}
00021 \textcolor{comment}{}
00022 \textcolor{comment}{   1. We use SipHash 1-2. This is not believed to be as strong as the}
00023 \textcolor{comment}{      suggested 2-4 variant, but AFAIK there are not trivial attacks}
00024 \textcolor{comment}{      against this reduced-rounds version, and it runs at the same speed}
00025 \textcolor{comment}{      as Murmurhash2 that we used previously, why the 2-4 variant slowed}
00026 \textcolor{comment}{      down Redis by a 4% figure more or less.}
00027 \textcolor{comment}{   2. Hard-code rounds in the hope the compiler can optimize it more}
00028 \textcolor{comment}{      in this raw from. Anyway we always want the standard 2-4 variant.}
00029 \textcolor{comment}{   3. Modify the prototype and implementation so that the function directly}
00030 \textcolor{comment}{      returns an uint64\_t value, the hash itself, instead of receiving an}
00031 \textcolor{comment}{      output buffer. This also means that the output size is set to 8 bytes}
00032 \textcolor{comment}{      and the 16 bytes output code handling was removed.}
00033 \textcolor{comment}{   4. Provide a case insensitive variant to be used when hashing strings that}
00034 \textcolor{comment}{      must be considered identical by the hash table regardless of the case.}
00035 \textcolor{comment}{      If we don't have directly a case insensitive hash function, we need to}
00036 \textcolor{comment}{      perform a text transformation in some temporary buffer, which is costly.}
00037 \textcolor{comment}{   5. Remove debugging code.}
00038 \textcolor{comment}{   6. Modified the original test.c file to be a stand-alone function testing}
00039 \textcolor{comment}{      the function in the new form (returing an uint64\_t) using just the}
00040 \textcolor{comment}{      relevant test vector.}
00041 \textcolor{comment}{ */}
00042 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{assert}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00043 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{stdint}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00044 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{stdio}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00045 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{string}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00046 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{ctype}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00047 
00048 \textcolor{comment}{/* Fast tolower() alike function that does not care about locale}
00049 \textcolor{comment}{ * but just returns a-z insetad of A-Z. */}
00050 \textcolor{keywordtype}{int} siptlw(\textcolor{keywordtype}{int} c) \{
00051     \textcolor{keywordflow}{if} (c >= \textcolor{stringliteral}{'A'} && c <= \textcolor{stringliteral}{'Z'}) \{
00052         \textcolor{keywordflow}{return} c+(\textcolor{stringliteral}{'a'}-\textcolor{stringliteral}{'A'});
00053     \} \textcolor{keywordflow}{else} \{
00054         \textcolor{keywordflow}{return} c;
00055     \}
00056 \}
00057 
00058 \textcolor{comment}{/* Test of the CPU is Little Endian and supports not aligned accesses.}
00059 \textcolor{comment}{ * Two interesting conditions to speedup the function that happen to be}
00060 \textcolor{comment}{ * in most of x86 servers. */}
00061 \textcolor{preprocessor}{#}\textcolor{preprocessor}{if} \textcolor{preprocessor}{defined}\textcolor{preprocessor}{(}\textcolor{preprocessor}{\_\_X86\_64\_\_}\textcolor{preprocessor}{)} \textcolor{preprocessor}{||} \textcolor{preprocessor}{defined}\textcolor{preprocessor}{(}\_\_x86\_64\_\_\textcolor{preprocessor}{)} \textcolor{preprocessor}{||} \textcolor{preprocessor}{defined} \textcolor{preprocessor}{(}\textcolor{preprocessor}{\_\_i386\_\_}\textcolor{preprocessor}{)}
00062 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{UNALIGNED\_LE\_CPU}
00063 \textcolor{preprocessor}{#}\textcolor{preprocessor}{endif}
00064 
00065 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{ROTL}\textcolor{preprocessor}{(}\textcolor{preprocessor}{x}\textcolor{preprocessor}{,} \textcolor{preprocessor}{b}\textcolor{preprocessor}{)} \textcolor{preprocessor}{(}\textcolor{preprocessor}{uint64\_t}\textcolor{preprocessor}{)}\textcolor{preprocessor}{(}\textcolor{preprocessor}{(}\textcolor{preprocessor}{(}\textcolor{preprocessor}{x}\textcolor{preprocessor}{)} \textcolor{preprocessor}{<<} \textcolor{preprocessor}{(}\textcolor{preprocessor}{b}\textcolor{preprocessor}{)}\textcolor{preprocessor}{)} \textcolor{preprocessor}{|} \textcolor{preprocessor}{(}\textcolor{preprocessor}{(}\textcolor{preprocessor}{x}\textcolor{preprocessor}{)} \textcolor{preprocessor}{>>} \textcolor{preprocessor}{(}64 \textcolor{preprocessor}{-} \textcolor{preprocessor}{(}\textcolor{preprocessor}{b}\textcolor{preprocessor}{)}\textcolor{preprocessor}{)}\textcolor{preprocessor}{)}\textcolor{preprocessor}{)}
00066 
00067 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{U32TO8\_LE}\textcolor{preprocessor}{(}\textcolor{preprocessor}{p}\textcolor{preprocessor}{,} \textcolor{preprocessor}{v}\textcolor{preprocessor}{)}
00068     \textcolor{preprocessor}{(}\textcolor{preprocessor}{p}\textcolor{preprocessor}{)}\textcolor{preprocessor}{[}0\textcolor{preprocessor}{]} \textcolor{preprocessor}{=} \textcolor{preprocessor}{(}\textcolor{preprocessor}{uint8\_t}\textcolor{preprocessor}{)}\textcolor{preprocessor}{(}\textcolor{preprocessor}{(}\textcolor{preprocessor}{v}\textcolor{preprocessor}{)}\textcolor{preprocessor}{)}\textcolor{preprocessor}{;}
00069     \textcolor{preprocessor}{(}\textcolor{preprocessor}{p}\textcolor{preprocessor}{)}\textcolor{preprocessor}{[}1\textcolor{preprocessor}{]} \textcolor{preprocessor}{=} \textcolor{preprocessor}{(}\textcolor{preprocessor}{uint8\_t}\textcolor{preprocessor}{)}\textcolor{preprocessor}{(}\textcolor{preprocessor}{(}\textcolor{preprocessor}{v}\textcolor{preprocessor}{)} \textcolor{preprocessor}{>>} 8\textcolor{preprocessor}{)}\textcolor{preprocessor}{;}
00070     \textcolor{preprocessor}{(}\textcolor{preprocessor}{p}\textcolor{preprocessor}{)}\textcolor{preprocessor}{[}2\textcolor{preprocessor}{]} \textcolor{preprocessor}{=} \textcolor{preprocessor}{(}\textcolor{preprocessor}{uint8\_t}\textcolor{preprocessor}{)}\textcolor{preprocessor}{(}\textcolor{preprocessor}{(}\textcolor{preprocessor}{v}\textcolor{preprocessor}{)} \textcolor{preprocessor}{>>} 16\textcolor{preprocessor}{)}\textcolor{preprocessor}{;}
00071     \textcolor{preprocessor}{(}\textcolor{preprocessor}{p}\textcolor{preprocessor}{)}\textcolor{preprocessor}{[}3\textcolor{preprocessor}{]} \textcolor{preprocessor}{=} \textcolor{preprocessor}{(}\textcolor{preprocessor}{uint8\_t}\textcolor{preprocessor}{)}\textcolor{preprocessor}{(}\textcolor{preprocessor}{(}\textcolor{preprocessor}{v}\textcolor{preprocessor}{)} \textcolor{preprocessor}{>>} 24\textcolor{preprocessor}{)}\textcolor{preprocessor}{;}
00072 
00073 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{U64TO8\_LE}\textcolor{preprocessor}{(}\textcolor{preprocessor}{p}\textcolor{preprocessor}{,} \textcolor{preprocessor}{v}\textcolor{preprocessor}{)}
00074     \hyperlink{siphash_8c_a08af2fb25b17973248d8cc16f9aa7c46}{U32TO8\_LE}\textcolor{preprocessor}{(}\textcolor{preprocessor}{(}\textcolor{preprocessor}{p}\textcolor{preprocessor}{)}\textcolor{preprocessor}{,} \textcolor{preprocessor}{(}\textcolor{preprocessor}{uint32\_t}\textcolor{preprocessor}{)}\textcolor{preprocessor}{(}\textcolor{preprocessor}{(}\textcolor{preprocessor}{v}\textcolor{preprocessor}{)}\textcolor{preprocessor}{)}\textcolor{preprocessor}{)}\textcolor{preprocessor}{;}
00075     \hyperlink{siphash_8c_a08af2fb25b17973248d8cc16f9aa7c46}{U32TO8\_LE}\textcolor{preprocessor}{(}\textcolor{preprocessor}{(}\textcolor{preprocessor}{p}\textcolor{preprocessor}{)} \textcolor{preprocessor}{+} 4\textcolor{preprocessor}{,} \textcolor{preprocessor}{(}\textcolor{preprocessor}{uint32\_t}\textcolor{preprocessor}{)}\textcolor{preprocessor}{(}\textcolor{preprocessor}{(}\textcolor{preprocessor}{v}\textcolor{preprocessor}{)} \textcolor{preprocessor}{>>} 32\textcolor{preprocessor}{)}\textcolor{preprocessor}{)}\textcolor{preprocessor}{;}
00076 
00077 \textcolor{preprocessor}{#}\textcolor{preprocessor}{ifdef} UNALIGNED\_LE\_CPU
00078 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{U8TO64\_LE}\textcolor{preprocessor}{(}\textcolor{preprocessor}{p}\textcolor{preprocessor}{)} \textcolor{preprocessor}{(}\textcolor{preprocessor}{*}\textcolor{preprocessor}{(}\textcolor{preprocessor}{(}\textcolor{preprocessor}{uint64\_t}\textcolor{preprocessor}{*}\textcolor{preprocessor}{)}\textcolor{preprocessor}{(}\textcolor{preprocessor}{p}\textcolor{preprocessor}{)}\textcolor{preprocessor}{)}\textcolor{preprocessor}{)}
00079 \textcolor{preprocessor}{#}\textcolor{preprocessor}{else}
00080 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{U8TO64\_LE}\textcolor{preprocessor}{(}\textcolor{preprocessor}{p}\textcolor{preprocessor}{)}
00081     \textcolor{preprocessor}{(}\textcolor{preprocessor}{(}\textcolor{preprocessor}{(}\textcolor{preprocessor}{uint64\_t}\textcolor{preprocessor}{)}\textcolor{preprocessor}{(}\textcolor{preprocessor}{(}\textcolor{preprocessor}{p}\textcolor{preprocessor}{)}\textcolor{preprocessor}{[}0\textcolor{preprocessor}{]}\textcolor{preprocessor}{)}\textcolor{preprocessor}{)} \textcolor{preprocessor}{|} \textcolor{preprocessor}{(}\textcolor{preprocessor}{(}\textcolor{preprocessor}{uint64\_t}\textcolor{preprocessor}{)}\textcolor{preprocessor}{(}\textcolor{preprocessor}{(}\textcolor{preprocessor}{p}\textcolor{preprocessor}{)}\textcolor{preprocessor}{[}1\textcolor{preprocessor}{]}\textcolor{preprocessor}{)} \textcolor{preprocessor}{<<} 8\textcolor{preprocessor}{)} \textcolor{preprocessor}{|}
00082      \textcolor{preprocessor}{(}\textcolor{preprocessor}{(}\textcolor{preprocessor}{uint64\_t}\textcolor{preprocessor}{)}\textcolor{preprocessor}{(}\textcolor{preprocessor}{(}\textcolor{preprocessor}{p}\textcolor{preprocessor}{)}\textcolor{preprocessor}{[}2\textcolor{preprocessor}{]}\textcolor{preprocessor}{)} \textcolor{preprocessor}{<<} 16\textcolor{preprocessor}{)} \textcolor{preprocessor}{|} \textcolor{preprocessor}{(}\textcolor{preprocessor}{(}\textcolor{preprocessor}{uint64\_t}\textcolor{preprocessor}{)}\textcolor{preprocessor}{(}\textcolor{preprocessor}{(}\textcolor{preprocessor}{p}\textcolor{preprocessor}{)}\textcolor{preprocessor}{[}3\textcolor{preprocessor}{]}\textcolor{preprocessor}{)} \textcolor{preprocessor}{<<} 24\textcolor{preprocessor}{)} \textcolor{preprocessor}{|}
00083      \textcolor{preprocessor}{(}\textcolor{preprocessor}{(}\textcolor{preprocessor}{uint64\_t}\textcolor{preprocessor}{)}\textcolor{preprocessor}{(}\textcolor{preprocessor}{(}\textcolor{preprocessor}{p}\textcolor{preprocessor}{)}\textcolor{preprocessor}{[}4\textcolor{preprocessor}{]}\textcolor{preprocessor}{)} \textcolor{preprocessor}{<<} 32\textcolor{preprocessor}{)} \textcolor{preprocessor}{|} \textcolor{preprocessor}{(}\textcolor{preprocessor}{(}\textcolor{preprocessor}{uint64\_t}\textcolor{preprocessor}{)}\textcolor{preprocessor}{(}\textcolor{preprocessor}{(}\textcolor{preprocessor}{p}\textcolor{preprocessor}{)}\textcolor{preprocessor}{[}5\textcolor{preprocessor}{]}\textcolor{preprocessor}{)} \textcolor{preprocessor}{<<} 40\textcolor{preprocessor}{)} \textcolor{preprocessor}{|}
00084      \textcolor{preprocessor}{(}\textcolor{preprocessor}{(}\textcolor{preprocessor}{uint64\_t}\textcolor{preprocessor}{)}\textcolor{preprocessor}{(}\textcolor{preprocessor}{(}\textcolor{preprocessor}{p}\textcolor{preprocessor}{)}\textcolor{preprocessor}{[}6\textcolor{preprocessor}{]}\textcolor{preprocessor}{)} \textcolor{preprocessor}{<<} 48\textcolor{preprocessor}{)} \textcolor{preprocessor}{|} \textcolor{preprocessor}{(}\textcolor{preprocessor}{(}\textcolor{preprocessor}{uint64\_t}\textcolor{preprocessor}{)}\textcolor{preprocessor}{(}\textcolor{preprocessor}{(}\textcolor{preprocessor}{p}\textcolor{preprocessor}{)}\textcolor{preprocessor}{[}7\textcolor{preprocessor}{]}\textcolor{preprocessor}{)} \textcolor{preprocessor}{<<} 56\textcolor{preprocessor}{)}\textcolor{preprocessor}{)}
00085 \textcolor{preprocessor}{#}\textcolor{preprocessor}{endif}
00086 
00087 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{U8TO64\_LE\_NOCASE}\textcolor{preprocessor}{(}\textcolor{preprocessor}{p}\textcolor{preprocessor}{)}
00088     \textcolor{preprocessor}{(}\textcolor{preprocessor}{(}\textcolor{preprocessor}{(}\textcolor{preprocessor}{uint64\_t}\textcolor{preprocessor}{)}\textcolor{preprocessor}{(}\textcolor{preprocessor}{siptlw}\textcolor{preprocessor}{(}\textcolor{preprocessor}{(}\textcolor{preprocessor}{p}\textcolor{preprocessor}{)}\textcolor{preprocessor}{[}0\textcolor{preprocessor}{]}\textcolor{preprocessor}{)}\textcolor{preprocessor}{)}\textcolor{preprocessor}{)} \textcolor{preprocessor}{|}
00089      \textcolor{preprocessor}{(}\textcolor{preprocessor}{(}\textcolor{preprocessor}{uint64\_t}\textcolor{preprocessor}{)}\textcolor{preprocessor}{(}\textcolor{preprocessor}{siptlw}\textcolor{preprocessor}{(}\textcolor{preprocessor}{(}\textcolor{preprocessor}{p}\textcolor{preprocessor}{)}\textcolor{preprocessor}{[}1\textcolor{preprocessor}{]}\textcolor{preprocessor}{)}\textcolor{preprocessor}{)} \textcolor{preprocessor}{<<} 8\textcolor{preprocessor}{)} \textcolor{preprocessor}{|}
00090      \textcolor{preprocessor}{(}\textcolor{preprocessor}{(}\textcolor{preprocessor}{uint64\_t}\textcolor{preprocessor}{)}\textcolor{preprocessor}{(}\textcolor{preprocessor}{siptlw}\textcolor{preprocessor}{(}\textcolor{preprocessor}{(}\textcolor{preprocessor}{p}\textcolor{preprocessor}{)}\textcolor{preprocessor}{[}2\textcolor{preprocessor}{]}\textcolor{preprocessor}{)}\textcolor{preprocessor}{)} \textcolor{preprocessor}{<<} 16\textcolor{preprocessor}{)} \textcolor{preprocessor}{|}
00091      \textcolor{preprocessor}{(}\textcolor{preprocessor}{(}\textcolor{preprocessor}{uint64\_t}\textcolor{preprocessor}{)}\textcolor{preprocessor}{(}\textcolor{preprocessor}{siptlw}\textcolor{preprocessor}{(}\textcolor{preprocessor}{(}\textcolor{preprocessor}{p}\textcolor{preprocessor}{)}\textcolor{preprocessor}{[}3\textcolor{preprocessor}{]}\textcolor{preprocessor}{)}\textcolor{preprocessor}{)} \textcolor{preprocessor}{<<} 24\textcolor{preprocessor}{)} \textcolor{preprocessor}{|}
00092      \textcolor{preprocessor}{(}\textcolor{preprocessor}{(}\textcolor{preprocessor}{uint64\_t}\textcolor{preprocessor}{)}\textcolor{preprocessor}{(}\textcolor{preprocessor}{siptlw}\textcolor{preprocessor}{(}\textcolor{preprocessor}{(}\textcolor{preprocessor}{p}\textcolor{preprocessor}{)}\textcolor{preprocessor}{[}4\textcolor{preprocessor}{]}\textcolor{preprocessor}{)}\textcolor{preprocessor}{)} \textcolor{preprocessor}{<<} 32\textcolor{preprocessor}{)} \textcolor{preprocessor}{|}
00093      \textcolor{preprocessor}{(}\textcolor{preprocessor}{(}\textcolor{preprocessor}{uint64\_t}\textcolor{preprocessor}{)}\textcolor{preprocessor}{(}\textcolor{preprocessor}{siptlw}\textcolor{preprocessor}{(}\textcolor{preprocessor}{(}\textcolor{preprocessor}{p}\textcolor{preprocessor}{)}\textcolor{preprocessor}{[}5\textcolor{preprocessor}{]}\textcolor{preprocessor}{)}\textcolor{preprocessor}{)} \textcolor{preprocessor}{<<} 40\textcolor{preprocessor}{)} \textcolor{preprocessor}{|}
00094      \textcolor{preprocessor}{(}\textcolor{preprocessor}{(}\textcolor{preprocessor}{uint64\_t}\textcolor{preprocessor}{)}\textcolor{preprocessor}{(}\textcolor{preprocessor}{siptlw}\textcolor{preprocessor}{(}\textcolor{preprocessor}{(}\textcolor{preprocessor}{p}\textcolor{preprocessor}{)}\textcolor{preprocessor}{[}6\textcolor{preprocessor}{]}\textcolor{preprocessor}{)}\textcolor{preprocessor}{)} \textcolor{preprocessor}{<<} 48\textcolor{preprocessor}{)} \textcolor{preprocessor}{|}
00095      \textcolor{preprocessor}{(}\textcolor{preprocessor}{(}\textcolor{preprocessor}{uint64\_t}\textcolor{preprocessor}{)}\textcolor{preprocessor}{(}\textcolor{preprocessor}{siptlw}\textcolor{preprocessor}{(}\textcolor{preprocessor}{(}\textcolor{preprocessor}{p}\textcolor{preprocessor}{)}\textcolor{preprocessor}{[}7\textcolor{preprocessor}{]}\textcolor{preprocessor}{)}\textcolor{preprocessor}{)} \textcolor{preprocessor}{<<} 56\textcolor{preprocessor}{)}\textcolor{preprocessor}{)}
00096 
00097 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{SIPROUND}
00098     \textcolor{keywordflow}{do} \textcolor{preprocessor}{\{}
00099         \textcolor{preprocessor}{v0} \textcolor{preprocessor}{+=} \textcolor{preprocessor}{v1}\textcolor{preprocessor}{;}
00100         \textcolor{preprocessor}{v1} \textcolor{preprocessor}{=} \hyperlink{siphash_8c_addd42b95ef425979d1d0dca095dec800}{ROTL}\textcolor{preprocessor}{(}\textcolor{preprocessor}{v1}\textcolor{preprocessor}{,} 13\textcolor{preprocessor}{)}\textcolor{preprocessor}{;}
00101         \textcolor{preprocessor}{v1} \textcolor{preprocessor}{^=} \textcolor{preprocessor}{v0}\textcolor{preprocessor}{;}
00102         \textcolor{preprocessor}{v0} \textcolor{preprocessor}{=} \hyperlink{siphash_8c_addd42b95ef425979d1d0dca095dec800}{ROTL}\textcolor{preprocessor}{(}\textcolor{preprocessor}{v0}\textcolor{preprocessor}{,} 32\textcolor{preprocessor}{)}\textcolor{preprocessor}{;}
00103         \textcolor{preprocessor}{v2} \textcolor{preprocessor}{+=} \textcolor{preprocessor}{v3}\textcolor{preprocessor}{;}
00104         \textcolor{preprocessor}{v3} \textcolor{preprocessor}{=} \hyperlink{siphash_8c_addd42b95ef425979d1d0dca095dec800}{ROTL}\textcolor{preprocessor}{(}\textcolor{preprocessor}{v3}\textcolor{preprocessor}{,} 16\textcolor{preprocessor}{)}\textcolor{preprocessor}{;}
00105         \textcolor{preprocessor}{v3} \textcolor{preprocessor}{^=} \textcolor{preprocessor}{v2}\textcolor{preprocessor}{;}
00106         \textcolor{preprocessor}{v0} \textcolor{preprocessor}{+=} \textcolor{preprocessor}{v3}\textcolor{preprocessor}{;}
00107         \textcolor{preprocessor}{v3} \textcolor{preprocessor}{=} \hyperlink{siphash_8c_addd42b95ef425979d1d0dca095dec800}{ROTL}\textcolor{preprocessor}{(}\textcolor{preprocessor}{v3}\textcolor{preprocessor}{,} 21\textcolor{preprocessor}{)}\textcolor{preprocessor}{;}
00108         \textcolor{preprocessor}{v3} \textcolor{preprocessor}{^=} \textcolor{preprocessor}{v0}\textcolor{preprocessor}{;}
00109         \textcolor{preprocessor}{v2} \textcolor{preprocessor}{+=} \textcolor{preprocessor}{v1}\textcolor{preprocessor}{;}
00110         \textcolor{preprocessor}{v1} \textcolor{preprocessor}{=} \hyperlink{siphash_8c_addd42b95ef425979d1d0dca095dec800}{ROTL}\textcolor{preprocessor}{(}\textcolor{preprocessor}{v1}\textcolor{preprocessor}{,} 17\textcolor{preprocessor}{)}\textcolor{preprocessor}{;}
00111         \textcolor{preprocessor}{v1} \textcolor{preprocessor}{^=} \textcolor{preprocessor}{v2}\textcolor{preprocessor}{;}
00112         \textcolor{preprocessor}{v2} \textcolor{preprocessor}{=} \hyperlink{siphash_8c_addd42b95ef425979d1d0dca095dec800}{ROTL}\textcolor{preprocessor}{(}\textcolor{preprocessor}{v2}\textcolor{preprocessor}{,} 32\textcolor{preprocessor}{)}\textcolor{preprocessor}{;}
00113     \textcolor{preprocessor}{\}} \textcolor{keywordflow}{while} \textcolor{preprocessor}{(}0\textcolor{preprocessor}{)}
00114 
00115 uint64\_t siphash(\textcolor{keyword}{const} uint8\_t *in, \textcolor{keyword}{const} size\_t inlen, \textcolor{keyword}{const} uint8\_t *k) \{
00116 \textcolor{preprocessor}{#}\textcolor{preprocessor}{ifndef} UNALIGNED\_LE\_CPU
00117     uint64\_t hash;
00118     uint8\_t *out = (uint8\_t*) &hash;
00119 \textcolor{preprocessor}{#}\textcolor{preprocessor}{endif}
00120     uint64\_t v0 = 0x736f6d6570736575ULL;
00121     uint64\_t v1 = 0x646f72616e646f6dULL;
00122     uint64\_t v2 = 0x6c7967656e657261ULL;
00123     uint64\_t v3 = 0x7465646279746573ULL;
00124     uint64\_t k0 = \hyperlink{siphash_8c_a1de2481f51a86cbfa0b7d0cdd4d68a69}{U8TO64\_LE}(k);
00125     uint64\_t k1 = \hyperlink{siphash_8c_a1de2481f51a86cbfa0b7d0cdd4d68a69}{U8TO64\_LE}(k + 8);
00126     uint64\_t m;
00127     \textcolor{keyword}{const} uint8\_t *end = in + inlen - (inlen % \textcolor{keyword}{sizeof}(uint64\_t));
00128     \textcolor{keyword}{const} \textcolor{keywordtype}{int} left = inlen & 7;
00129     uint64\_t b = ((uint64\_t)inlen) << 56;
00130     v3 ^= k1;
00131     v2 ^= k0;
00132     v1 ^= k1;
00133     v0 ^= k0;
00134 
00135     \textcolor{keywordflow}{for} (; in != end; in += 8) \{
00136         m = \hyperlink{siphash_8c_a1de2481f51a86cbfa0b7d0cdd4d68a69}{U8TO64\_LE}(in);
00137         v3 ^= m;
00138 
00139         \hyperlink{siphash_8c_abd545ba6d36990ee5903ff4d0e6edecf}{SIPROUND};
00140 
00141         v0 ^= m;
00142     \}
00143 
00144     \textcolor{keywordflow}{switch} (left) \{
00145     \textcolor{keywordflow}{case} 7: b |= ((uint64\_t)in[6]) << 48;
00146     \textcolor{keywordflow}{case} 6: b |= ((uint64\_t)in[5]) << 40;
00147     \textcolor{keywordflow}{case} 5: b |= ((uint64\_t)in[4]) << 32;
00148     \textcolor{keywordflow}{case} 4: b |= ((uint64\_t)in[3]) << 24;
00149     \textcolor{keywordflow}{case} 3: b |= ((uint64\_t)in[2]) << 16;
00150     \textcolor{keywordflow}{case} 2: b |= ((uint64\_t)in[1]) << 8;
00151     \textcolor{keywordflow}{case} 1: b |= ((uint64\_t)in[0]); \textcolor{keywordflow}{break};
00152     \textcolor{keywordflow}{case} 0: \textcolor{keywordflow}{break};
00153     \}
00154 
00155     v3 ^= b;
00156 
00157     \hyperlink{siphash_8c_abd545ba6d36990ee5903ff4d0e6edecf}{SIPROUND};
00158 
00159     v0 ^= b;
00160     v2 ^= 0xff;
00161 
00162     \hyperlink{siphash_8c_abd545ba6d36990ee5903ff4d0e6edecf}{SIPROUND};
00163     \hyperlink{siphash_8c_abd545ba6d36990ee5903ff4d0e6edecf}{SIPROUND};
00164 
00165     b = v0 ^ v1 ^ v2 ^ v3;
00166 \textcolor{preprocessor}{#}\textcolor{preprocessor}{ifndef} UNALIGNED\_LE\_CPU
00167     U64TO8\_LE(out, b);
00168     \textcolor{keywordflow}{return} hash;
00169 \textcolor{preprocessor}{#}\textcolor{preprocessor}{else}
00170     \textcolor{keywordflow}{return} b;
00171 \textcolor{preprocessor}{#}\textcolor{preprocessor}{endif}
00172 \}
00173 
00174 uint64\_t siphash\_nocase(\textcolor{keyword}{const} uint8\_t *in, \textcolor{keyword}{const} size\_t inlen, \textcolor{keyword}{const} uint8\_t *k)
00175 \{
00176 \textcolor{preprocessor}{#}\textcolor{preprocessor}{ifndef} UNALIGNED\_LE\_CPU
00177     uint64\_t hash;
00178     uint8\_t *out = (uint8\_t*) &hash;
00179 \textcolor{preprocessor}{#}\textcolor{preprocessor}{endif}
00180     uint64\_t v0 = 0x736f6d6570736575ULL;
00181     uint64\_t v1 = 0x646f72616e646f6dULL;
00182     uint64\_t v2 = 0x6c7967656e657261ULL;
00183     uint64\_t v3 = 0x7465646279746573ULL;
00184     uint64\_t k0 = \hyperlink{siphash_8c_a1de2481f51a86cbfa0b7d0cdd4d68a69}{U8TO64\_LE}(k);
00185     uint64\_t k1 = \hyperlink{siphash_8c_a1de2481f51a86cbfa0b7d0cdd4d68a69}{U8TO64\_LE}(k + 8);
00186     uint64\_t m;
00187     \textcolor{keyword}{const} uint8\_t *end = in + inlen - (inlen % \textcolor{keyword}{sizeof}(uint64\_t));
00188     \textcolor{keyword}{const} \textcolor{keywordtype}{int} left = inlen & 7;
00189     uint64\_t b = ((uint64\_t)inlen) << 56;
00190     v3 ^= k1;
00191     v2 ^= k0;
00192     v1 ^= k1;
00193     v0 ^= k0;
00194 
00195     \textcolor{keywordflow}{for} (; in != end; in += 8) \{
00196         m = \hyperlink{siphash_8c_a8682efbe353b9e5b9a5c014e5a3809ec}{U8TO64\_LE\_NOCASE}(in);
00197         v3 ^= m;
00198 
00199         \hyperlink{siphash_8c_abd545ba6d36990ee5903ff4d0e6edecf}{SIPROUND};
00200 
00201         v0 ^= m;
00202     \}
00203 
00204     \textcolor{keywordflow}{switch} (left) \{
00205     \textcolor{keywordflow}{case} 7: b |= ((uint64\_t)siptlw(in[6])) << 48;
00206     \textcolor{keywordflow}{case} 6: b |= ((uint64\_t)siptlw(in[5])) << 40;
00207     \textcolor{keywordflow}{case} 5: b |= ((uint64\_t)siptlw(in[4])) << 32;
00208     \textcolor{keywordflow}{case} 4: b |= ((uint64\_t)siptlw(in[3])) << 24;
00209     \textcolor{keywordflow}{case} 3: b |= ((uint64\_t)siptlw(in[2])) << 16;
00210     \textcolor{keywordflow}{case} 2: b |= ((uint64\_t)siptlw(in[1])) << 8;
00211     \textcolor{keywordflow}{case} 1: b |= ((uint64\_t)siptlw(in[0])); \textcolor{keywordflow}{break};
00212     \textcolor{keywordflow}{case} 0: \textcolor{keywordflow}{break};
00213     \}
00214 
00215     v3 ^= b;
00216 
00217     \hyperlink{siphash_8c_abd545ba6d36990ee5903ff4d0e6edecf}{SIPROUND};
00218 
00219     v0 ^= b;
00220     v2 ^= 0xff;
00221 
00222     \hyperlink{siphash_8c_abd545ba6d36990ee5903ff4d0e6edecf}{SIPROUND};
00223     \hyperlink{siphash_8c_abd545ba6d36990ee5903ff4d0e6edecf}{SIPROUND};
00224 
00225     b = v0 ^ v1 ^ v2 ^ v3;
00226 \textcolor{preprocessor}{#}\textcolor{preprocessor}{ifndef} UNALIGNED\_LE\_CPU
00227     U64TO8\_LE(out, b);
00228     \textcolor{keywordflow}{return} hash;
00229 \textcolor{preprocessor}{#}\textcolor{preprocessor}{else}
00230     \textcolor{keywordflow}{return} b;
00231 \textcolor{preprocessor}{#}\textcolor{preprocessor}{endif}
00232 \}
00233 
00234 
00235 \textcolor{comment}{/* --------------------------------- TEST ------------------------------------ */}
00236 
00237 \textcolor{preprocessor}{#}\textcolor{preprocessor}{ifdef} \textcolor{preprocessor}{SIPHASH\_TEST}
00238 
00239 \textcolor{keyword}{const} uint8\_t vectors\_sip64[64][8] = \{
00240     \{ 0x31, 0x0e, 0x0e, 0xdd, 0x47, 0xdb, 0x6f, 0x72, \},
00241     \{ 0xfd, 0x67, 0xdc, 0x93, 0xc5, 0x39, 0xf8, 0x74, \},
00242     \{ 0x5a, 0x4f, 0xa9, 0xd9, 0x09, 0x80, 0x6c, 0x0d, \},
00243     \{ 0x2d, 0x7e, 0xfb, 0xd7, 0x96, 0x66, 0x67, 0x85, \},
00244     \{ 0xb7, 0x87, 0x71, 0x27, 0xe0, 0x94, 0x27, 0xcf, \},
00245     \{ 0x8d, 0xa6, 0x99, 0xcd, 0x64, 0x55, 0x76, 0x18, \},
00246     \{ 0xce, 0xe3, 0xfe, 0x58, 0x6e, 0x46, 0xc9, 0xcb, \},
00247     \{ 0x37, 0xd1, 0x01, 0x8b, 0xf5, 0x00, 0x02, 0xab, \},
00248     \{ 0x62, 0x24, 0x93, 0x9a, 0x79, 0xf5, 0xf5, 0x93, \},
00249     \{ 0xb0, 0xe4, 0xa9, 0x0b, 0xdf, 0x82, 0x00, 0x9e, \},
00250     \{ 0xf3, 0xb9, 0xdd, 0x94, 0xc5, 0xbb, 0x5d, 0x7a, \},
00251     \{ 0xa7, 0xad, 0x6b, 0x22, 0x46, 0x2f, 0xb3, 0xf4, \},
00252     \{ 0xfb, 0xe5, 0x0e, 0x86, 0xbc, 0x8f, 0x1e, 0x75, \},
00253     \{ 0x90, 0x3d, 0x84, 0xc0, 0x27, 0x56, 0xea, 0x14, \},
00254     \{ 0xee, 0xf2, 0x7a, 0x8e, 0x90, 0xca, 0x23, 0xf7, \},
00255     \{ 0xe5, 0x45, 0xbe, 0x49, 0x61, 0xca, 0x29, 0xa1, \},
00256     \{ 0xdb, 0x9b, 0xc2, 0x57, 0x7f, 0xcc, 0x2a, 0x3f, \},
00257     \{ 0x94, 0x47, 0xbe, 0x2c, 0xf5, 0xe9, 0x9a, 0x69, \},
00258     \{ 0x9c, 0xd3, 0x8d, 0x96, 0xf0, 0xb3, 0xc1, 0x4b, \},
00259     \{ 0xbd, 0x61, 0x79, 0xa7, 0x1d, 0xc9, 0x6d, 0xbb, \},
00260     \{ 0x98, 0xee, 0xa2, 0x1a, 0xf2, 0x5c, 0xd6, 0xbe, \},
00261     \{ 0xc7, 0x67, 0x3b, 0x2e, 0xb0, 0xcb, 0xf2, 0xd0, \},
00262     \{ 0x88, 0x3e, 0xa3, 0xe3, 0x95, 0x67, 0x53, 0x93, \},
00263     \{ 0xc8, 0xce, 0x5c, 0xcd, 0x8c, 0x03, 0x0c, 0xa8, \},
00264     \{ 0x94, 0xaf, 0x49, 0xf6, 0xc6, 0x50, 0xad, 0xb8, \},
00265     \{ 0xea, 0xb8, 0x85, 0x8a, 0xde, 0x92, 0xe1, 0xbc, \},
00266     \{ 0xf3, 0x15, 0xbb, 0x5b, 0xb8, 0x35, 0xd8, 0x17, \},
00267     \{ 0xad, 0xcf, 0x6b, 0x07, 0x63, 0x61, 0x2e, 0x2f, \},
00268     \{ 0xa5, 0xc9, 0x1d, 0xa7, 0xac, 0xaa, 0x4d, 0xde, \},
00269     \{ 0x71, 0x65, 0x95, 0x87, 0x66, 0x50, 0xa2, 0xa6, \},
00270     \{ 0x28, 0xef, 0x49, 0x5c, 0x53, 0xa3, 0x87, 0xad, \},
00271     \{ 0x42, 0xc3, 0x41, 0xd8, 0xfa, 0x92, 0xd8, 0x32, \},
00272     \{ 0xce, 0x7c, 0xf2, 0x72, 0x2f, 0x51, 0x27, 0x71, \},
00273     \{ 0xe3, 0x78, 0x59, 0xf9, 0x46, 0x23, 0xf3, 0xa7, \},
00274     \{ 0x38, 0x12, 0x05, 0xbb, 0x1a, 0xb0, 0xe0, 0x12, \},
00275     \{ 0xae, 0x97, 0xa1, 0x0f, 0xd4, 0x34, 0xe0, 0x15, \},
00276     \{ 0xb4, 0xa3, 0x15, 0x08, 0xbe, 0xff, 0x4d, 0x31, \},
00277     \{ 0x81, 0x39, 0x62, 0x29, 0xf0, 0x90, 0x79, 0x02, \},
00278     \{ 0x4d, 0x0c, 0xf4, 0x9e, 0xe5, 0xd4, 0xdc, 0xca, \},
00279     \{ 0x5c, 0x73, 0x33, 0x6a, 0x76, 0xd8, 0xbf, 0x9a, \},
00280     \{ 0xd0, 0xa7, 0x04, 0x53, 0x6b, 0xa9, 0x3e, 0x0e, \},
00281     \{ 0x92, 0x59, 0x58, 0xfc, 0xd6, 0x42, 0x0c, 0xad, \},
00282     \{ 0xa9, 0x15, 0xc2, 0x9b, 0xc8, 0x06, 0x73, 0x18, \},
00283     \{ 0x95, 0x2b, 0x79, 0xf3, 0xbc, 0x0a, 0xa6, 0xd4, \},
00284     \{ 0xf2, 0x1d, 0xf2, 0xe4, 0x1d, 0x45, 0x35, 0xf9, \},
00285     \{ 0x87, 0x57, 0x75, 0x19, 0x04, 0x8f, 0x53, 0xa9, \},
00286     \{ 0x10, 0xa5, 0x6c, 0xf5, 0xdf, 0xcd, 0x9a, 0xdb, \},
00287     \{ 0xeb, 0x75, 0x09, 0x5c, 0xcd, 0x98, 0x6c, 0xd0, \},
00288     \{ 0x51, 0xa9, 0xcb, 0x9e, 0xcb, 0xa3, 0x12, 0xe6, \},
00289     \{ 0x96, 0xaf, 0xad, 0xfc, 0x2c, 0xe6, 0x66, 0xc7, \},
00290     \{ 0x72, 0xfe, 0x52, 0x97, 0x5a, 0x43, 0x64, 0xee, \},
00291     \{ 0x5a, 0x16, 0x45, 0xb2, 0x76, 0xd5, 0x92, 0xa1, \},
00292     \{ 0xb2, 0x74, 0xcb, 0x8e, 0xbf, 0x87, 0x87, 0x0a, \},
00293     \{ 0x6f, 0x9b, 0xb4, 0x20, 0x3d, 0xe7, 0xb3, 0x81, \},
00294     \{ 0xea, 0xec, 0xb2, 0xa3, 0x0b, 0x22, 0xa8, 0x7f, \},
00295     \{ 0x99, 0x24, 0xa4, 0x3c, 0xc1, 0x31, 0x57, 0x24, \},
00296     \{ 0xbd, 0x83, 0x8d, 0x3a, 0xaf, 0xbf, 0x8d, 0xb7, \},
00297     \{ 0x0b, 0x1a, 0x2a, 0x32, 0x65, 0xd5, 0x1a, 0xea, \},
00298     \{ 0x13, 0x50, 0x79, 0xa3, 0x23, 0x1c, 0xe6, 0x60, \},
00299     \{ 0x93, 0x2b, 0x28, 0x46, 0xe4, 0xd7, 0x06, 0x66, \},
00300     \{ 0xe1, 0x91, 0x5f, 0x5c, 0xb1, 0xec, 0xa4, 0x6c, \},
00301     \{ 0xf3, 0x25, 0x96, 0x5c, 0xa1, 0x6d, 0x62, 0x9f, \},
00302     \{ 0x57, 0x5f, 0xf2, 0x8e, 0x60, 0x38, 0x1b, 0xe5, \},
00303     \{ 0x72, 0x45, 0x06, 0xeb, 0x4c, 0x32, 0x8a, 0x95, \},
00304 \};
00305 
00306 
00307 \textcolor{comment}{/* Test siphash using a test vector. Returns 0 if the function passed}
00308 \textcolor{comment}{ * all the tests, otherwise 1 is returned.}
00309 \textcolor{comment}{ *}
00310 \textcolor{comment}{ * IMPORTANT: The test vector is for SipHash 2-4. Before running}
00311 \textcolor{comment}{ * the test revert back the siphash() function to 2-4 rounds since}
00312 \textcolor{comment}{ * now it uses 1-2 rounds. */}
00313 \textcolor{keywordtype}{int} siphash\_test(\textcolor{keywordtype}{void}) \{
00314     uint8\_t in[64], k[16];
00315     \textcolor{keywordtype}{int} i;
00316     \textcolor{keywordtype}{int} fails = 0;
00317 
00318     \textcolor{keywordflow}{for} (i = 0; i < 16; ++i)
00319         k[i] = i;
00320 
00321     \textcolor{keywordflow}{for} (i = 0; i < 64; ++i) \{
00322         in[i] = i;
00323         uint64\_t hash = siphash(in, i, k);
00324         \textcolor{keyword}{const} uint8\_t *v = NULL;
00325         v = (uint8\_t *)vectors\_sip64;
00326         \textcolor{keywordflow}{if} (memcmp(&hash, v + (i * 8), 8)) \{
00327             \textcolor{comment}{/* printf("fail for %d bytes\(\backslash\)n", i); */}
00328             fails++;
00329         \}
00330     \}
00331 
00332     \textcolor{comment}{/* Run a few basic tests with the case insensitive version. */}
00333     uint64\_t h1, h2;
00334     h1 = siphash((uint8\_t*)\textcolor{stringliteral}{"hello world"},11,(uint8\_t*)\textcolor{stringliteral}{"1234567812345678"});
00335     h2 = siphash\_nocase((uint8\_t*)\textcolor{stringliteral}{"hello world"},11,(uint8\_t*)\textcolor{stringliteral}{"1234567812345678"});
00336     \textcolor{keywordflow}{if} (h1 != h2) fails++;
00337 
00338     h1 = siphash((uint8\_t*)\textcolor{stringliteral}{"hello world"},11,(uint8\_t*)\textcolor{stringliteral}{"1234567812345678"});
00339     h2 = siphash\_nocase((uint8\_t*)\textcolor{stringliteral}{"HELLO world"},11,(uint8\_t*)\textcolor{stringliteral}{"1234567812345678"});
00340     \textcolor{keywordflow}{if} (h1 != h2) fails++;
00341 
00342     h1 = siphash((uint8\_t*)\textcolor{stringliteral}{"HELLO world"},11,(uint8\_t*)\textcolor{stringliteral}{"1234567812345678"});
00343     h2 = siphash\_nocase((uint8\_t*)\textcolor{stringliteral}{"HELLO world"},11,(uint8\_t*)\textcolor{stringliteral}{"1234567812345678"});
00344     \textcolor{keywordflow}{if} (h1 == h2) fails++;
00345 
00346     \textcolor{keywordflow}{if} (!fails) \textcolor{keywordflow}{return} 0;
00347     \textcolor{keywordflow}{return} 1;
00348 \}
00349 
00350 \textcolor{keywordtype}{int} main(\textcolor{keywordtype}{void}) \{
00351     \textcolor{keywordflow}{if} (siphash\_test() == 0) \{
00352         printf(\textcolor{stringliteral}{"SipHash test: OK\(\backslash\)n"});
00353         \textcolor{keywordflow}{return} 0;
00354     \} \textcolor{keywordflow}{else} \{
00355         printf(\textcolor{stringliteral}{"SipHash test: FAILED\(\backslash\)n"});
00356         \textcolor{keywordflow}{return} 1;
00357     \}
00358 \}
00359 
00360 \textcolor{preprocessor}{#}\textcolor{preprocessor}{endif}
\end{DoxyCode}
