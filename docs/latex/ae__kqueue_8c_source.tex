\hypertarget{ae__kqueue_8c_source}{}\section{ae\+\_\+kqueue.\+c}
\label{ae__kqueue_8c_source}\index{src/ae\+\_\+kqueue.\+c@{src/ae\+\_\+kqueue.\+c}}

\begin{DoxyCode}
00001 \textcolor{comment}{/* Kqueue(2)-based ae.c module}
00002 \textcolor{comment}{ *}
00003 \textcolor{comment}{ * Copyright (C) 2009 Harish Mallipeddi - harish.mallipeddi@gmail.com}
00004 \textcolor{comment}{ * All rights reserved.}
00005 \textcolor{comment}{ *}
00006 \textcolor{comment}{ * Redistribution and use in source and binary forms, with or without}
00007 \textcolor{comment}{ * modification, are permitted provided that the following conditions are met:}
00008 \textcolor{comment}{ *}
00009 \textcolor{comment}{ *   * Redistributions of source code must retain the above copyright notice,}
00010 \textcolor{comment}{ *     this list of conditions and the following disclaimer.}
00011 \textcolor{comment}{ *   * Redistributions in binary form must reproduce the above copyright}
00012 \textcolor{comment}{ *     notice, this list of conditions and the following disclaimer in the}
00013 \textcolor{comment}{ *     documentation and/or other materials provided with the distribution.}
00014 \textcolor{comment}{ *   * Neither the name of Redis nor the names of its contributors may be used}
00015 \textcolor{comment}{ *     to endorse or promote products derived from this software without}
00016 \textcolor{comment}{ *     specific prior written permission.}
00017 \textcolor{comment}{ *}
00018 \textcolor{comment}{ * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"}
00019 \textcolor{comment}{ * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE}
00020 \textcolor{comment}{ * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE}
00021 \textcolor{comment}{ * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE}
00022 \textcolor{comment}{ * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR}
00023 \textcolor{comment}{ * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF}
00024 \textcolor{comment}{ * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS}
00025 \textcolor{comment}{ * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN}
00026 \textcolor{comment}{ * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)}
00027 \textcolor{comment}{ * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE}
00028 \textcolor{comment}{ * POSSIBILITY OF SUCH DAMAGE.}
00029 \textcolor{comment}{ */}
00030 
00031 
00032 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{sys}\textcolor{preprocessor}{/}\textcolor{preprocessor}{types}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00033 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{sys}\textcolor{preprocessor}{/}\textcolor{preprocessor}{event}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00034 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{sys}\textcolor{preprocessor}{/}\textcolor{preprocessor}{time}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00035 
00036 \textcolor{keyword}{typedef} \textcolor{keyword}{struct} \hyperlink{structaeApiState}{aeApiState} \{
00037     \textcolor{keywordtype}{int} kqfd;
00038     \textcolor{keyword}{struct} kevent *events;
00039 \} aeApiState;
00040 
00041 \textcolor{keyword}{static} \textcolor{keywordtype}{int} aeApiCreate(aeEventLoop *eventLoop) \{
00042     aeApiState *state = zmalloc(\textcolor{keyword}{sizeof}(aeApiState));
00043 
00044     \textcolor{keywordflow}{if} (!state) \textcolor{keywordflow}{return} -1;
00045     state->events = zmalloc(\textcolor{keyword}{sizeof}(\textcolor{keyword}{struct} kevent)*eventLoop->setsize);
00046     \textcolor{keywordflow}{if} (!state->events) \{
00047         zfree(state);
00048         \textcolor{keywordflow}{return} -1;
00049     \}
00050     state->kqfd = kqueue();
00051     \textcolor{keywordflow}{if} (state->kqfd == -1) \{
00052         zfree(state->events);
00053         zfree(state);
00054         \textcolor{keywordflow}{return} -1;
00055     \}
00056     eventLoop->apidata = state;
00057     \textcolor{keywordflow}{return} 0;
00058 \}
00059 
00060 \textcolor{keyword}{static} \textcolor{keywordtype}{int} aeApiResize(aeEventLoop *eventLoop, \textcolor{keywordtype}{int} setsize) \{
00061     aeApiState *state = eventLoop->apidata;
00062 
00063     state->events = zrealloc(state->events, \textcolor{keyword}{sizeof}(\textcolor{keyword}{struct} kevent)*setsize);
00064     \textcolor{keywordflow}{return} 0;
00065 \}
00066 
00067 \textcolor{keyword}{static} \textcolor{keywordtype}{void} aeApiFree(aeEventLoop *eventLoop) \{
00068     aeApiState *state = eventLoop->apidata;
00069 
00070     close(state->kqfd);
00071     zfree(state->events);
00072     zfree(state);
00073 \}
00074 
00075 \textcolor{keyword}{static} \textcolor{keywordtype}{int} aeApiAddEvent(aeEventLoop *eventLoop, \textcolor{keywordtype}{int} fd, \textcolor{keywordtype}{int} mask) \{
00076     aeApiState *state = eventLoop->apidata;
00077     \textcolor{keyword}{struct} kevent ke;
00078 
00079     \textcolor{keywordflow}{if} (mask & AE\_READABLE) \{
00080         EV\_SET(&ke, fd, EVFILT\_READ, EV\_ADD, 0, 0, NULL);
00081         \textcolor{keywordflow}{if} (kevent(state->kqfd, &ke, 1, NULL, 0, NULL) == -1) \textcolor{keywordflow}{return} -1;
00082     \}
00083     \textcolor{keywordflow}{if} (mask & AE\_WRITABLE) \{
00084         EV\_SET(&ke, fd, EVFILT\_WRITE, EV\_ADD, 0, 0, NULL);
00085         \textcolor{keywordflow}{if} (kevent(state->kqfd, &ke, 1, NULL, 0, NULL) == -1) \textcolor{keywordflow}{return} -1;
00086     \}
00087     \textcolor{keywordflow}{return} 0;
00088 \}
00089 
00090 \textcolor{keyword}{static} \textcolor{keywordtype}{void} aeApiDelEvent(aeEventLoop *eventLoop, \textcolor{keywordtype}{int} fd, \textcolor{keywordtype}{int} mask) \{
00091     aeApiState *state = eventLoop->apidata;
00092     \textcolor{keyword}{struct} kevent ke;
00093 
00094     \textcolor{keywordflow}{if} (mask & AE\_READABLE) \{
00095         EV\_SET(&ke, fd, EVFILT\_READ, EV\_DELETE, 0, 0, NULL);
00096         kevent(state->kqfd, &ke, 1, NULL, 0, NULL);
00097     \}
00098     \textcolor{keywordflow}{if} (mask & AE\_WRITABLE) \{
00099         EV\_SET(&ke, fd, EVFILT\_WRITE, EV\_DELETE, 0, 0, NULL);
00100         kevent(state->kqfd, &ke, 1, NULL, 0, NULL);
00101     \}
00102 \}
00103 
00104 \textcolor{keyword}{static} \textcolor{keywordtype}{int} aeApiPoll(aeEventLoop *eventLoop, \textcolor{keyword}{struct} timeval *tvp) \{
00105     aeApiState *state = eventLoop->apidata;
00106     \textcolor{keywordtype}{int} retval, numevents = 0;
00107 
00108     \textcolor{keywordflow}{if} (tvp != NULL) \{
00109         \textcolor{keyword}{struct} timespec timeout;
00110         timeout.tv\_sec = tvp->tv\_sec;
00111         timeout.tv\_nsec = tvp->tv\_usec * 1000;
00112         retval = kevent(state->kqfd, NULL, 0, state->events, eventLoop->setsize,
00113                         &timeout);
00114     \} \textcolor{keywordflow}{else} \{
00115         retval = kevent(state->kqfd, NULL, 0, state->events, eventLoop->setsize,
00116                         NULL);
00117     \}
00118 
00119     \textcolor{keywordflow}{if} (retval > 0) \{
00120         \textcolor{keywordtype}{int} j;
00121 
00122         numevents = retval;
00123         \textcolor{keywordflow}{for}(j = 0; j < numevents; j++) \{
00124             \textcolor{keywordtype}{int} mask = 0;
00125             \textcolor{keyword}{struct} kevent *e = state->events+j;
00126 
00127             \textcolor{keywordflow}{if} (e->filter == EVFILT\_READ) mask |= AE\_READABLE;
00128             \textcolor{keywordflow}{if} (e->filter == EVFILT\_WRITE) mask |= AE\_WRITABLE;
00129             eventLoop->fired[j].fd = e->ident;
00130             eventLoop->fired[j].mask = mask;
00131         \}
00132     \}
00133     \textcolor{keywordflow}{return} numevents;
00134 \}
00135 
00136 \textcolor{keyword}{static} \textcolor{keywordtype}{char} *aeApiName(\textcolor{keywordtype}{void}) \{
00137     \textcolor{keywordflow}{return} \textcolor{stringliteral}{"kqueue"};
00138 \}
\end{DoxyCode}
