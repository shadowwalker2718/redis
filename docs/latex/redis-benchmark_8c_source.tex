\hypertarget{redis-benchmark_8c_source}{}\section{redis-\/benchmark.c}
\label{redis-benchmark_8c_source}\index{src/redis-\/benchmark.\+c@{src/redis-\/benchmark.\+c}}

\begin{DoxyCode}
00001 \textcolor{comment}{/* Redis benchmark utility.}
00002 \textcolor{comment}{ *}
00003 \textcolor{comment}{ * Copyright (c) 2009-2012, Salvatore Sanfilippo <antirez at gmail dot com>}
00004 \textcolor{comment}{ * All rights reserved.}
00005 \textcolor{comment}{ *}
00006 \textcolor{comment}{ * Redistribution and use in source and binary forms, with or without}
00007 \textcolor{comment}{ * modification, are permitted provided that the following conditions are met:}
00008 \textcolor{comment}{ *}
00009 \textcolor{comment}{ *   * Redistributions of source code must retain the above copyright notice,}
00010 \textcolor{comment}{ *     this list of conditions and the following disclaimer.}
00011 \textcolor{comment}{ *   * Redistributions in binary form must reproduce the above copyright}
00012 \textcolor{comment}{ *     notice, this list of conditions and the following disclaimer in the}
00013 \textcolor{comment}{ *     documentation and/or other materials provided with the distribution.}
00014 \textcolor{comment}{ *   * Neither the name of Redis nor the names of its contributors may be used}
00015 \textcolor{comment}{ *     to endorse or promote products derived from this software without}
00016 \textcolor{comment}{ *     specific prior written permission.}
00017 \textcolor{comment}{ *}
00018 \textcolor{comment}{ * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"}
00019 \textcolor{comment}{ * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE}
00020 \textcolor{comment}{ * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE}
00021 \textcolor{comment}{ * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE}
00022 \textcolor{comment}{ * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR}
00023 \textcolor{comment}{ * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF}
00024 \textcolor{comment}{ * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS}
00025 \textcolor{comment}{ * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN}
00026 \textcolor{comment}{ * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)}
00027 \textcolor{comment}{ * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE}
00028 \textcolor{comment}{ * POSSIBILITY OF SUCH DAMAGE.}
00029 \textcolor{comment}{ */}
00030 
00031 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \hyperlink{fmacros_8h}{"fmacros.h"}
00032 
00033 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{stdio}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00034 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{string}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00035 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{stdlib}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00036 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{unistd}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00037 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{errno}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00038 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{time}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00039 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{sys}\textcolor{preprocessor}{/}\textcolor{preprocessor}{time}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00040 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{signal}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00041 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{assert}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00042 
00043 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{sds}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>} \textcolor{comment}{/* Use hiredis sds. */}
00044 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \hyperlink{ae_8h}{"ae.h"}
00045 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{"hiredis.h"}
00046 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \hyperlink{adlist_8h}{"adlist.h"}
00047 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \hyperlink{zmalloc_8h}{"zmalloc.h"}
00048 
00049 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{UNUSED}\textcolor{preprocessor}{(}\textcolor{preprocessor}{V}\textcolor{preprocessor}{)} \textcolor{preprocessor}{(}\textcolor{preprocessor}{(}\textcolor{keywordtype}{void}\textcolor{preprocessor}{)} \textcolor{preprocessor}{V}\textcolor{preprocessor}{)}
00050 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{RANDPTR\_INITIAL\_SIZE} 8
00051 
00052 \textcolor{keyword}{static} \textcolor{keyword}{struct} config \{
00053     aeEventLoop *el;
00054     \textcolor{keyword}{const} \textcolor{keywordtype}{char} *hostip;
00055     \textcolor{keywordtype}{int} hostport;
00056     \textcolor{keyword}{const} \textcolor{keywordtype}{char} *hostsocket;
00057     \textcolor{keywordtype}{int} numclients;
00058     \textcolor{keywordtype}{int} liveclients;
00059     \textcolor{keywordtype}{int} requests;
00060     \textcolor{keywordtype}{int} requests\_issued;
00061     \textcolor{keywordtype}{int} requests\_finished;
00062     \textcolor{keywordtype}{int} keysize;
00063     \textcolor{keywordtype}{int} datasize;
00064     \textcolor{keywordtype}{int} randomkeys;
00065     \textcolor{keywordtype}{int} randomkeys\_keyspacelen;
00066     \textcolor{keywordtype}{int} keepalive;
00067     \textcolor{keywordtype}{int} pipeline;
00068     \textcolor{keywordtype}{int} showerrors;
00069     \textcolor{keywordtype}{long} \textcolor{keywordtype}{long} start;
00070     \textcolor{keywordtype}{long} \textcolor{keywordtype}{long} totlatency;
00071     \textcolor{keywordtype}{long} \textcolor{keywordtype}{long} *latency;
00072     \textcolor{keyword}{const} \textcolor{keywordtype}{char} *title;
00073     list *clients;
00074     \textcolor{keywordtype}{int} quiet;
00075     \textcolor{keywordtype}{int} csv;
00076     \textcolor{keywordtype}{int} loop;
00077     \textcolor{keywordtype}{int} idlemode;
00078     \textcolor{keywordtype}{int} dbnum;
00079     sds dbnumstr;
00080     \textcolor{keywordtype}{char} *tests;
00081     \textcolor{keywordtype}{char} *auth;
00082 \} config;
00083 
\Hypertarget{redis-benchmark_8c_source_l00084}\hyperlink{struct__client}{00084} \textcolor{keyword}{typedef} \textcolor{keyword}{struct} \hyperlink{struct__client}{\_client} \{
00085     redisContext *context;
00086     sds obuf;
00087     \textcolor{keywordtype}{char} **randptr;         \textcolor{comment}{/* Pointers to :rand: strings inside the command buf */}
00088     size\_t randlen;         \textcolor{comment}{/* Number of pointers in client->randptr */}
00089     size\_t randfree;        \textcolor{comment}{/* Number of unused pointers in client->randptr */}
00090     size\_t written;         \textcolor{comment}{/* Bytes of 'obuf' already written */}
00091     \textcolor{keywordtype}{long} \textcolor{keywordtype}{long} start;        \textcolor{comment}{/* Start time of a request */}
00092     \textcolor{keywordtype}{long} \textcolor{keywordtype}{long} latency;      \textcolor{comment}{/* Request latency */}
00093     \textcolor{keywordtype}{int} pending;            \textcolor{comment}{/* Number of pending requests (replies to consume) */}
00094     \textcolor{keywordtype}{int} prefix\_pending;     \textcolor{comment}{/* If non-zero, number of pending prefix commands. Commands}
00095 \textcolor{comment}{                               such as auth and select are prefixed to the pipeline of}
00096 \textcolor{comment}{                               benchmark commands and discarded after the first send. */}
00097     \textcolor{keywordtype}{int} prefixlen;          \textcolor{comment}{/* Size in bytes of the pending prefix commands */}
00098 \} *client;
00099 
00100 \textcolor{comment}{/* Prototypes */}
00101 \textcolor{keyword}{static} \textcolor{keywordtype}{void} writeHandler(aeEventLoop *el, \textcolor{keywordtype}{int} fd, \textcolor{keywordtype}{void} *privdata, \textcolor{keywordtype}{int} mask);
00102 \textcolor{keyword}{static} \textcolor{keywordtype}{void} createMissingClients(client c);
00103 
00104 \textcolor{comment}{/* Implementation */}
00105 \textcolor{keyword}{static} \textcolor{keywordtype}{long} \textcolor{keywordtype}{long} ustime(\textcolor{keywordtype}{void}) \{
00106     \textcolor{keyword}{struct} timeval tv;
00107     \textcolor{keywordtype}{long} \textcolor{keywordtype}{long} ust;
00108 
00109     gettimeofday(&tv, NULL);
00110     ust = ((\textcolor{keywordtype}{long})tv.tv\_sec)*1000000;
00111     ust += tv.tv\_usec;
00112     \textcolor{keywordflow}{return} ust;
00113 \}
00114 
00115 \textcolor{keyword}{static} \textcolor{keywordtype}{long} \textcolor{keywordtype}{long} mstime(\textcolor{keywordtype}{void}) \{
00116     \textcolor{keyword}{struct} timeval tv;
00117     \textcolor{keywordtype}{long} \textcolor{keywordtype}{long} mst;
00118 
00119     gettimeofday(&tv, NULL);
00120     mst = ((\textcolor{keywordtype}{long} \textcolor{keywordtype}{long})tv.tv\_sec)*1000;
00121     mst += tv.tv\_usec/1000;
00122     \textcolor{keywordflow}{return} mst;
00123 \}
00124 
00125 \textcolor{keyword}{static} \textcolor{keywordtype}{void} freeClient(client c) \{
00126     listNode *ln;
00127     aeDeleteFileEvent(config.el,c->context->fd,\hyperlink{ae_8h_ab6bfb0366ccb6277112d132c2a2bf500}{AE\_WRITABLE});
00128     aeDeleteFileEvent(config.el,c->context->fd,\hyperlink{ae_8h_a7a9a2162d007d09739955b4e55c65bf3}{AE\_READABLE});
00129     redisFree(c->context);
00130     sdsfree(c->obuf);
00131     zfree(c->randptr);
00132     zfree(c);
00133     config.liveclients--;
00134     ln = listSearchKey(config.clients,c);
00135     \hyperlink{redisassert_8h_a993abaa2c168852c1592879472938781}{assert}(ln != NULL);
00136     listDelNode(config.clients,ln);
00137 \}
00138 
00139 \textcolor{keyword}{static} \textcolor{keywordtype}{void} freeAllClients(\textcolor{keywordtype}{void}) \{
00140     listNode *ln = config.clients->head, *next;
00141 
00142     \textcolor{keywordflow}{while}(ln) \{
00143         next = ln->next;
00144         freeClient(ln->value);
00145         ln = next;
00146     \}
00147 \}
00148 
00149 \textcolor{keyword}{static} \textcolor{keywordtype}{void} resetClient(client c) \{
00150     aeDeleteFileEvent(config.el,c->context->fd,\hyperlink{ae_8h_ab6bfb0366ccb6277112d132c2a2bf500}{AE\_WRITABLE});
00151     aeDeleteFileEvent(config.el,c->context->fd,\hyperlink{ae_8h_a7a9a2162d007d09739955b4e55c65bf3}{AE\_READABLE});
00152     aeCreateFileEvent(config.el,c->context->fd,\hyperlink{ae_8h_ab6bfb0366ccb6277112d132c2a2bf500}{AE\_WRITABLE},writeHandler,c);
00153     c->written = 0;
00154     c->pending = config.pipeline;
00155 \}
00156 
00157 \textcolor{keyword}{static} \textcolor{keywordtype}{void} randomizeClientKey(client c) \{
00158     size\_t i;
00159 
00160     \textcolor{keywordflow}{for} (i = 0; i < c->randlen; i++) \{
00161         \textcolor{keywordtype}{char} *p = c->randptr[i]+11;
00162         size\_t r = random() % config.randomkeys\_keyspacelen;
00163         size\_t j;
00164 
00165         \textcolor{keywordflow}{for} (j = 0; j < 12; j++) \{
00166             *p = \textcolor{stringliteral}{'0'}+r%10;
00167             r/=10;
00168             p--;
00169         \}
00170     \}
00171 \}
00172 
00173 \textcolor{keyword}{static} \textcolor{keywordtype}{void} clientDone(client c) \{
00174     \textcolor{keywordflow}{if} (config.requests\_finished == config.requests) \{
00175         freeClient(c);
00176         aeStop(config.el);
00177         \textcolor{keywordflow}{return};
00178     \}
00179     \textcolor{keywordflow}{if} (config.keepalive) \{
00180         resetClient(c);
00181     \} \textcolor{keywordflow}{else} \{
00182         config.liveclients--;
00183         createMissingClients(c);
00184         config.liveclients++;
00185         freeClient(c);
00186     \}
00187 \}
00188 
00189 \textcolor{keyword}{static} \textcolor{keywordtype}{void} readHandler(aeEventLoop *el, \textcolor{keywordtype}{int} fd, \textcolor{keywordtype}{void} *privdata, \textcolor{keywordtype}{int} mask) \{
00190     client c = privdata;
00191     \textcolor{keywordtype}{void} *reply = NULL;
00192     \hyperlink{server_8h_ae7c9dc8f13568a9c856573751f1ee1ec}{UNUSED}(el);
00193     \hyperlink{server_8h_ae7c9dc8f13568a9c856573751f1ee1ec}{UNUSED}(fd);
00194     \hyperlink{server_8h_ae7c9dc8f13568a9c856573751f1ee1ec}{UNUSED}(mask);
00195 
00196     \textcolor{comment}{/* Calculate latency only for the first read event. This means that the}
00197 \textcolor{comment}{     * server already sent the reply and we need to parse it. Parsing overhead}
00198 \textcolor{comment}{     * is not part of the latency, so calculate it only once, here. */}
00199     \textcolor{keywordflow}{if} (c->latency < 0) c->latency = ustime()-(c->start);
00200 
00201     \textcolor{keywordflow}{if} (redisBufferRead(c->context) != REDIS\_OK) \{
00202         fprintf(stderr,\textcolor{stringliteral}{"Error: %s\(\backslash\)n"},c->context->errstr);
00203         exit(1);
00204     \} \textcolor{keywordflow}{else} \{
00205         \textcolor{keywordflow}{while}(c->pending) \{
00206             \textcolor{keywordflow}{if} (redisGetReply(c->context,&reply) != REDIS\_OK) \{
00207                 fprintf(stderr,\textcolor{stringliteral}{"Error: %s\(\backslash\)n"},c->context->errstr);
00208                 exit(1);
00209             \}
00210             \textcolor{keywordflow}{if} (reply != NULL) \{
00211                 \textcolor{keywordflow}{if} (reply == (\textcolor{keywordtype}{void}*)REDIS\_REPLY\_ERROR) \{
00212                     fprintf(stderr,\textcolor{stringliteral}{"Unexpected error reply, exiting...\(\backslash\)n"});
00213                     exit(1);
00214                 \}
00215 
00216                 \textcolor{keywordflow}{if} (config.showerrors) \{
00217                     \textcolor{keyword}{static} time\_t lasterr\_time = 0;
00218                     time\_t now = time(NULL);
00219                     redisReply *r = reply;
00220                     \textcolor{keywordflow}{if} (r->type == REDIS\_REPLY\_ERROR && lasterr\_time != now) \{
00221                         lasterr\_time = now;
00222                         printf(\textcolor{stringliteral}{"Error from server: %s\(\backslash\)n"}, r->str);
00223                     \}
00224                 \}
00225 
00226                 freeReplyObject(reply);
00227                 \textcolor{comment}{/* This is an OK for prefix commands such as auth and select.*/}
00228                 \textcolor{keywordflow}{if} (c->prefix\_pending > 0) \{
00229                     c->prefix\_pending--;
00230                     c->pending--;
00231                     \textcolor{comment}{/* Discard prefix commands on first response.*/}
00232                     \textcolor{keywordflow}{if} (c->prefixlen > 0) \{
00233                         size\_t j;
00234                         sdsrange(c->obuf, c->prefixlen, -1);
00235                         \textcolor{comment}{/* We also need to fix the pointers to the strings}
00236 \textcolor{comment}{                        * we need to randomize. */}
00237                         \textcolor{keywordflow}{for} (j = 0; j < c->randlen; j++)
00238                             c->randptr[j] -= c->prefixlen;
00239                         c->prefixlen = 0;
00240                     \}
00241                     \textcolor{keywordflow}{continue};
00242                 \}
00243 
00244                 \textcolor{keywordflow}{if} (config.requests\_finished < config.requests)
00245                     config.latency[config.requests\_finished++] = c->latency;
00246                 c->pending--;
00247                 \textcolor{keywordflow}{if} (c->pending == 0) \{
00248                     clientDone(c);
00249                     \textcolor{keywordflow}{break};
00250                 \}
00251             \} \textcolor{keywordflow}{else} \{
00252                 \textcolor{keywordflow}{break};
00253             \}
00254         \}
00255     \}
00256 \}
00257 
00258 \textcolor{keyword}{static} \textcolor{keywordtype}{void} writeHandler(aeEventLoop *el, \textcolor{keywordtype}{int} fd, \textcolor{keywordtype}{void} *privdata, \textcolor{keywordtype}{int} mask) \{
00259     client c = privdata;
00260     \hyperlink{server_8h_ae7c9dc8f13568a9c856573751f1ee1ec}{UNUSED}(el);
00261     \hyperlink{server_8h_ae7c9dc8f13568a9c856573751f1ee1ec}{UNUSED}(fd);
00262     \hyperlink{server_8h_ae7c9dc8f13568a9c856573751f1ee1ec}{UNUSED}(mask);
00263 
00264     \textcolor{comment}{/* Initialize request when nothing was written. */}
00265     \textcolor{keywordflow}{if} (c->written == 0) \{
00266         \textcolor{comment}{/* Enforce upper bound to number of requests. */}
00267         \textcolor{keywordflow}{if} (config.requests\_issued++ >= config.requests) \{
00268             freeClient(c);
00269             \textcolor{keywordflow}{return};
00270         \}
00271 
00272         \textcolor{comment}{/* Really initialize: randomize keys and set start time. */}
00273         \textcolor{keywordflow}{if} (config.randomkeys) randomizeClientKey(c);
00274         c->start = ustime();
00275         c->latency = -1;
00276     \}
00277 
00278     \textcolor{keywordflow}{if} (sdslen(c->obuf) > c->written) \{
00279         \textcolor{keywordtype}{void} *ptr = c->obuf+c->written;
00280         ssize\_t nwritten = write(c->context->fd,ptr,sdslen(c->obuf)-c->written);
00281         \textcolor{keywordflow}{if} (nwritten == -1) \{
00282             \textcolor{keywordflow}{if} (errno != EPIPE)
00283                 fprintf(stderr, \textcolor{stringliteral}{"Writing to socket: %s\(\backslash\)n"}, strerror(errno));
00284             freeClient(c);
00285             \textcolor{keywordflow}{return};
00286         \}
00287         c->written += nwritten;
00288         \textcolor{keywordflow}{if} (sdslen(c->obuf) == c->written) \{
00289             aeDeleteFileEvent(config.el,c->context->fd,\hyperlink{ae_8h_ab6bfb0366ccb6277112d132c2a2bf500}{AE\_WRITABLE});
00290             aeCreateFileEvent(config.el,c->context->fd,\hyperlink{ae_8h_a7a9a2162d007d09739955b4e55c65bf3}{AE\_READABLE},readHandler,c);
00291         \}
00292     \}
00293 \}
00294 
00295 \textcolor{comment}{/* Create a benchmark client, configured to send the command passed as 'cmd' of}
00296 \textcolor{comment}{ * 'len' bytes.}
00297 \textcolor{comment}{ *}
00298 \textcolor{comment}{ * The command is copied N times in the client output buffer (that is reused}
00299 \textcolor{comment}{ * again and again to send the request to the server) accordingly to the configured}
00300 \textcolor{comment}{ * pipeline size.}
00301 \textcolor{comment}{ *}
00302 \textcolor{comment}{ * Also an initial SELECT command is prepended in order to make sure the right}
00303 \textcolor{comment}{ * database is selected, if needed. The initial SELECT will be discarded as soon}
00304 \textcolor{comment}{ * as the first reply is received.}
00305 \textcolor{comment}{ *}
00306 \textcolor{comment}{ * To create a client from scratch, the 'from' pointer is set to NULL. If instead}
00307 \textcolor{comment}{ * we want to create a client using another client as reference, the 'from' pointer}
00308 \textcolor{comment}{ * points to the client to use as reference. In such a case the following}
00309 \textcolor{comment}{ * information is take from the 'from' client:}
00310 \textcolor{comment}{ *}
00311 \textcolor{comment}{ * 1) The command line to use.}
00312 \textcolor{comment}{ * 2) The offsets of the \_\_rand\_int\_\_ elements inside the command line, used}
00313 \textcolor{comment}{ *    for arguments randomization.}
00314 \textcolor{comment}{ *}
00315 \textcolor{comment}{ * Even when cloning another client, prefix commands are applied if needed.*/}
00316 \textcolor{keyword}{static} client createClient(\textcolor{keywordtype}{char} *cmd, size\_t len, client from) \{
00317     \textcolor{keywordtype}{int} j;
00318     client c = zmalloc(\textcolor{keyword}{sizeof}(\textcolor{keyword}{struct} \_client));
00319 
00320     \textcolor{keywordflow}{if} (config.hostsocket == NULL) \{
00321         c->context = redisConnectNonBlock(config.hostip,config.hostport);
00322     \} \textcolor{keywordflow}{else} \{
00323         c->context = redisConnectUnixNonBlock(config.hostsocket);
00324     \}
00325     \textcolor{keywordflow}{if} (c->context->err) \{
00326         fprintf(stderr,\textcolor{stringliteral}{"Could not connect to Redis at "});
00327         \textcolor{keywordflow}{if} (config.hostsocket == NULL)
00328             fprintf(stderr,\textcolor{stringliteral}{"%s:%d: %s\(\backslash\)n"},config.hostip,config.hostport,c->context->errstr);
00329         \textcolor{keywordflow}{else}
00330             fprintf(stderr,\textcolor{stringliteral}{"%s: %s\(\backslash\)n"},config.hostsocket,c->context->errstr);
00331         exit(1);
00332     \}
00333     \textcolor{comment}{/* Suppress hiredis cleanup of unused buffers for max speed. */}
00334     c->context->reader->maxbuf = 0;
00335 
00336     \textcolor{comment}{/* Build the request buffer:}
00337 \textcolor{comment}{     * Queue N requests accordingly to the pipeline size, or simply clone}
00338 \textcolor{comment}{     * the example client buffer. */}
00339     c->obuf = sdsempty();
00340     \textcolor{comment}{/* Prefix the request buffer with AUTH and/or SELECT commands, if applicable.}
00341 \textcolor{comment}{     * These commands are discarded after the first response, so if the client is}
00342 \textcolor{comment}{     * reused the commands will not be used again. */}
00343     c->prefix\_pending = 0;
00344     \textcolor{keywordflow}{if} (config.auth) \{
00345         \textcolor{keywordtype}{char} *buf = NULL;
00346         \textcolor{keywordtype}{int} len = redisFormatCommand(&buf, \textcolor{stringliteral}{"AUTH %s"}, config.auth);
00347         c->obuf = sdscatlen(c->obuf, buf, len);
00348         free(buf);
00349         c->prefix\_pending++;
00350     \}
00351 
00352     \textcolor{comment}{/* If a DB number different than zero is selected, prefix our request}
00353 \textcolor{comment}{     * buffer with the SELECT command, that will be discarded the first}
00354 \textcolor{comment}{     * time the replies are received, so if the client is reused the}
00355 \textcolor{comment}{     * SELECT command will not be used again. */}
00356     \textcolor{keywordflow}{if} (config.dbnum != 0) \{
00357         c->obuf = sdscatprintf(c->obuf,\textcolor{stringliteral}{"*2\(\backslash\)r\(\backslash\)n$6\(\backslash\)r\(\backslash\)nSELECT\(\backslash\)r\(\backslash\)n$%d\(\backslash\)r\(\backslash\)n%s\(\backslash\)r\(\backslash\)n"},
00358             (\textcolor{keywordtype}{int})sdslen(config.dbnumstr),config.dbnumstr);
00359         c->prefix\_pending++;
00360     \}
00361     c->prefixlen = sdslen(c->obuf);
00362     \textcolor{comment}{/* Append the request itself. */}
00363     \textcolor{keywordflow}{if} (from) \{
00364         c->obuf = sdscatlen(c->obuf,
00365             from->obuf+from->prefixlen,
00366             sdslen(from->obuf)-from->prefixlen);
00367     \} \textcolor{keywordflow}{else} \{
00368         \textcolor{keywordflow}{for} (j = 0; j < config.pipeline; j++)
00369             c->obuf = sdscatlen(c->obuf,cmd,len);
00370     \}
00371 
00372     c->written = 0;
00373     c->pending = config.pipeline+c->prefix\_pending;
00374     c->randptr = NULL;
00375     c->randlen = 0;
00376 
00377     \textcolor{comment}{/* Find substrings in the output buffer that need to be randomized. */}
00378     \textcolor{keywordflow}{if} (config.randomkeys) \{
00379         \textcolor{keywordflow}{if} (from) \{
00380             c->randlen = from->randlen;
00381             c->randfree = 0;
00382             c->randptr = zmalloc(\textcolor{keyword}{sizeof}(\textcolor{keywordtype}{char}*)*c->randlen);
00383             \textcolor{comment}{/* copy the offsets. */}
00384             \textcolor{keywordflow}{for} (j = 0; j < (\textcolor{keywordtype}{int})c->randlen; j++) \{
00385                 c->randptr[j] = c->obuf + (from->randptr[j]-from->obuf);
00386                 \textcolor{comment}{/* Adjust for the different select prefix length. */}
00387                 c->randptr[j] += c->prefixlen - from->prefixlen;
00388             \}
00389         \} \textcolor{keywordflow}{else} \{
00390             \textcolor{keywordtype}{char} *p = c->obuf;
00391 
00392             c->randlen = 0;
00393             c->randfree = \hyperlink{redis-benchmark_8c_aa36f1f87a96374eb350895416fc1affe}{RANDPTR\_INITIAL\_SIZE};
00394             c->randptr = zmalloc(\textcolor{keyword}{sizeof}(\textcolor{keywordtype}{char}*)*c->randfree);
00395             \textcolor{keywordflow}{while} ((p = strstr(p,\textcolor{stringliteral}{"\_\_rand\_int\_\_"})) != NULL) \{
00396                 \textcolor{keywordflow}{if} (c->randfree == 0) \{
00397                     c->randptr = zrealloc(c->randptr,\textcolor{keyword}{sizeof}(\textcolor{keywordtype}{char}*)*c->randlen*2);
00398                     c->randfree += c->randlen;
00399                 \}
00400                 c->randptr[c->randlen++] = p;
00401                 c->randfree--;
00402                 p += 12; \textcolor{comment}{/* 12 is strlen("\_\_rand\_int\_\_). */}
00403             \}
00404         \}
00405     \}
00406     \textcolor{keywordflow}{if} (config.idlemode == 0)
00407         aeCreateFileEvent(config.el,c->context->fd,\hyperlink{ae_8h_ab6bfb0366ccb6277112d132c2a2bf500}{AE\_WRITABLE},writeHandler,c);
00408     listAddNodeTail(config.clients,c);
00409     config.liveclients++;
00410     \textcolor{keywordflow}{return} c;
00411 \}
00412 
00413 \textcolor{keyword}{static} \textcolor{keywordtype}{void} createMissingClients(client c) \{
00414     \textcolor{keywordtype}{int} n = 0;
00415 
00416     \textcolor{keywordflow}{while}(config.liveclients < config.numclients) \{
00417         createClient(NULL,0,c);
00418 
00419         \textcolor{comment}{/* Listen backlog is quite limited on most systems */}
00420         \textcolor{keywordflow}{if} (++n > 64) \{
00421             usleep(50000);
00422             n = 0;
00423         \}
00424     \}
00425 \}
00426 
00427 \textcolor{keyword}{static} \textcolor{keywordtype}{int} compareLatency(\textcolor{keyword}{const} \textcolor{keywordtype}{void} *a, \textcolor{keyword}{const} \textcolor{keywordtype}{void} *b) \{
00428     \textcolor{keywordflow}{return} (*(\textcolor{keywordtype}{long} \textcolor{keywordtype}{long}*)a)-(*(\textcolor{keywordtype}{long} \textcolor{keywordtype}{long}*)b);
00429 \}
00430 
00431 \textcolor{keyword}{static} \textcolor{keywordtype}{void} showLatencyReport(\textcolor{keywordtype}{void}) \{
00432     \textcolor{keywordtype}{int} i, curlat = 0;
00433     \textcolor{keywordtype}{float} perc, reqpersec;
00434 
00435     reqpersec = (\textcolor{keywordtype}{float})config.requests\_finished/((\textcolor{keywordtype}{float})config.totlatency/1000);
00436     \textcolor{keywordflow}{if} (!config.quiet && !config.csv) \{
00437         printf(\textcolor{stringliteral}{"====== %s ======\(\backslash\)n"}, config.title);
00438         printf(\textcolor{stringliteral}{"  %d requests completed in %.2f seconds\(\backslash\)n"}, config.requests\_finished,
00439             (\textcolor{keywordtype}{float})config.totlatency/1000);
00440         printf(\textcolor{stringliteral}{"  %d parallel clients\(\backslash\)n"}, config.numclients);
00441         printf(\textcolor{stringliteral}{"  %d bytes payload\(\backslash\)n"}, config.datasize);
00442         printf(\textcolor{stringliteral}{"  keep alive: %d\(\backslash\)n"}, config.keepalive);
00443         printf(\textcolor{stringliteral}{"\(\backslash\)n"});
00444 
00445         qsort(config.latency,config.requests,\textcolor{keyword}{sizeof}(\textcolor{keywordtype}{long} \textcolor{keywordtype}{long}),compareLatency);
00446         \textcolor{keywordflow}{for} (i = 0; i < config.requests; i++) \{
00447             \textcolor{keywordflow}{if} (config.latency[i]/1000 != curlat || i == (config.requests-1)) \{
00448                 curlat = config.latency[i]/1000;
00449                 perc = ((\textcolor{keywordtype}{float})(i+1)*100)/config.requests;
00450                 printf(\textcolor{stringliteral}{"%.2f%% <= %d milliseconds\(\backslash\)n"}, perc, curlat);
00451             \}
00452         \}
00453         printf(\textcolor{stringliteral}{"%.2f requests per second\(\backslash\)n\(\backslash\)n"}, reqpersec);
00454     \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (config.csv) \{
00455         printf(\textcolor{stringliteral}{"\(\backslash\)"%s\(\backslash\)",\(\backslash\)"%.2f\(\backslash\)"\(\backslash\)n"}, config.title, reqpersec);
00456     \} \textcolor{keywordflow}{else} \{
00457         printf(\textcolor{stringliteral}{"%s: %.2f requests per second\(\backslash\)n"}, config.title, reqpersec);
00458     \}
00459 \}
00460 
00461 \textcolor{keyword}{static} \textcolor{keywordtype}{void} benchmark(\textcolor{keywordtype}{char} *title, \textcolor{keywordtype}{char} *cmd, \textcolor{keywordtype}{int} len) \{
00462     client c;
00463 
00464     config.title = title;
00465     config.requests\_issued = 0;
00466     config.requests\_finished = 0;
00467 
00468     c = createClient(cmd,len,NULL);
00469     createMissingClients(c);
00470 
00471     config.start = mstime();
00472     aeMain(config.el);
00473     config.totlatency = mstime()-config.start;
00474 
00475     showLatencyReport();
00476     freeAllClients();
00477 \}
00478 
00479 \textcolor{comment}{/* Returns number of consumed options. */}
00480 \textcolor{keywordtype}{int} parseOptions(\textcolor{keywordtype}{int} argc, \textcolor{keyword}{const} \textcolor{keywordtype}{char} **argv) \{
00481     \textcolor{keywordtype}{int} i;
00482     \textcolor{keywordtype}{int} lastarg;
00483     \textcolor{keywordtype}{int} exit\_status = 1;
00484 
00485     \textcolor{keywordflow}{for} (i = 1; i < argc; i++) \{
00486         lastarg = (i == (argc-1));
00487 
00488         \textcolor{keywordflow}{if} (!strcmp(argv[i],\textcolor{stringliteral}{"-c"})) \{
00489             \textcolor{keywordflow}{if} (lastarg) \textcolor{keywordflow}{goto} invalid;
00490             config.numclients = atoi(argv[++i]);
00491         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcmp(argv[i],\textcolor{stringliteral}{"-n"})) \{
00492             \textcolor{keywordflow}{if} (lastarg) \textcolor{keywordflow}{goto} invalid;
00493             config.requests = atoi(argv[++i]);
00494         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcmp(argv[i],\textcolor{stringliteral}{"-k"})) \{
00495             \textcolor{keywordflow}{if} (lastarg) \textcolor{keywordflow}{goto} invalid;
00496             config.keepalive = atoi(argv[++i]);
00497         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcmp(argv[i],\textcolor{stringliteral}{"-h"})) \{
00498             \textcolor{keywordflow}{if} (lastarg) \textcolor{keywordflow}{goto} invalid;
00499             config.hostip = strdup(argv[++i]);
00500         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcmp(argv[i],\textcolor{stringliteral}{"-p"})) \{
00501             \textcolor{keywordflow}{if} (lastarg) \textcolor{keywordflow}{goto} invalid;
00502             config.hostport = atoi(argv[++i]);
00503         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcmp(argv[i],\textcolor{stringliteral}{"-s"})) \{
00504             \textcolor{keywordflow}{if} (lastarg) \textcolor{keywordflow}{goto} invalid;
00505             config.hostsocket = strdup(argv[++i]);
00506         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcmp(argv[i],\textcolor{stringliteral}{"-a"}) ) \{
00507             \textcolor{keywordflow}{if} (lastarg) \textcolor{keywordflow}{goto} invalid;
00508             config.auth = strdup(argv[++i]);
00509         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcmp(argv[i],\textcolor{stringliteral}{"-d"})) \{
00510             \textcolor{keywordflow}{if} (lastarg) \textcolor{keywordflow}{goto} invalid;
00511             config.datasize = atoi(argv[++i]);
00512             \textcolor{keywordflow}{if} (config.datasize < 1) config.datasize=1;
00513             \textcolor{keywordflow}{if} (config.datasize > 1024*1024*1024) config.datasize = 1024*1024*1024;
00514         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcmp(argv[i],\textcolor{stringliteral}{"-P"})) \{
00515             \textcolor{keywordflow}{if} (lastarg) \textcolor{keywordflow}{goto} invalid;
00516             config.pipeline = atoi(argv[++i]);
00517             \textcolor{keywordflow}{if} (config.pipeline <= 0) config.pipeline=1;
00518         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcmp(argv[i],\textcolor{stringliteral}{"-r"})) \{
00519             \textcolor{keywordflow}{if} (lastarg) \textcolor{keywordflow}{goto} invalid;
00520             config.randomkeys = 1;
00521             config.randomkeys\_keyspacelen = atoi(argv[++i]);
00522             \textcolor{keywordflow}{if} (config.randomkeys\_keyspacelen < 0)
00523                 config.randomkeys\_keyspacelen = 0;
00524         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcmp(argv[i],\textcolor{stringliteral}{"-q"})) \{
00525             config.quiet = 1;
00526         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcmp(argv[i],\textcolor{stringliteral}{"--csv"})) \{
00527             config.csv = 1;
00528         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcmp(argv[i],\textcolor{stringliteral}{"-l"})) \{
00529             config.loop = 1;
00530         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcmp(argv[i],\textcolor{stringliteral}{"-I"})) \{
00531             config.idlemode = 1;
00532         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcmp(argv[i],\textcolor{stringliteral}{"-e"})) \{
00533             config.showerrors = 1;
00534         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcmp(argv[i],\textcolor{stringliteral}{"-t"})) \{
00535             \textcolor{keywordflow}{if} (lastarg) \textcolor{keywordflow}{goto} invalid;
00536             \textcolor{comment}{/* We get the list of tests to run as a string in the form}
00537 \textcolor{comment}{             * get,set,lrange,...,test\_N. Then we add a comma before and}
00538 \textcolor{comment}{             * after the string in order to make sure that searching}
00539 \textcolor{comment}{             * for ",testname," will always get a match if the test is}
00540 \textcolor{comment}{             * enabled. */}
00541             config.tests = sdsnew(\textcolor{stringliteral}{","});
00542             config.tests = sdscat(config.tests,(\textcolor{keywordtype}{char}*)argv[++i]);
00543             config.tests = sdscat(config.tests,\textcolor{stringliteral}{","});
00544             sdstolower(config.tests);
00545         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcmp(argv[i],\textcolor{stringliteral}{"--dbnum"})) \{
00546             \textcolor{keywordflow}{if} (lastarg) \textcolor{keywordflow}{goto} invalid;
00547             config.dbnum = atoi(argv[++i]);
00548             config.dbnumstr = sdsfromlonglong(config.dbnum);
00549         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!strcmp(argv[i],\textcolor{stringliteral}{"--help"})) \{
00550             exit\_status = 0;
00551             \textcolor{keywordflow}{goto} usage;
00552         \} \textcolor{keywordflow}{else} \{
00553             \textcolor{comment}{/* Assume the user meant to provide an option when the arg starts}
00554 \textcolor{comment}{             * with a dash. We're done otherwise and should use the remainder}
00555 \textcolor{comment}{             * as the command and arguments for running the benchmark. */}
00556             \textcolor{keywordflow}{if} (argv[i][0] == \textcolor{stringliteral}{'-'}) \textcolor{keywordflow}{goto} invalid;
00557             \textcolor{keywordflow}{return} i;
00558         \}
00559     \}
00560 
00561     \textcolor{keywordflow}{return} i;
00562 
00563 invalid:
00564     printf(\textcolor{stringliteral}{"Invalid option \(\backslash\)"%s\(\backslash\)" or option argument missing\(\backslash\)n\(\backslash\)n"},argv[i]);
00565 
00566 usage:
00567     printf(
00568 \textcolor{stringliteral}{"Usage: redis-benchmark [-h <host>] [-p <port>] [-c <clients>] [-n <requests>] [-k <boolean>]\(\backslash\)n\(\backslash\)n"}
00569 \textcolor{stringliteral}{" -h <hostname>      Server hostname (default 127.0.0.1)\(\backslash\)n"}
00570 \textcolor{stringliteral}{" -p <port>          Server port (default 6379)\(\backslash\)n"}
00571 \textcolor{stringliteral}{" -s <socket>        Server socket (overrides host and port)\(\backslash\)n"}
00572 \textcolor{stringliteral}{" -a <password>      Password for Redis Auth\(\backslash\)n"}
00573 \textcolor{stringliteral}{" -c <clients>       Number of parallel connections (default 50)\(\backslash\)n"}
00574 \textcolor{stringliteral}{" -n <requests>      Total number of requests (default 100000)\(\backslash\)n"}
00575 \textcolor{stringliteral}{" -d <size>          Data size of SET/GET value in bytes (default 3)\(\backslash\)n"}
00576 \textcolor{stringliteral}{" --dbnum <db>       SELECT the specified db number (default 0)\(\backslash\)n"}
00577 \textcolor{stringliteral}{" -k <boolean>       1=keep alive 0=reconnect (default 1)\(\backslash\)n"}
00578 \textcolor{stringliteral}{" -r <keyspacelen>   Use random keys for SET/GET/INCR, random values for SADD\(\backslash\)n"}
00579 \textcolor{stringliteral}{"  Using this option the benchmark will expand the string \_\_rand\_int\_\_\(\backslash\)n"}
00580 \textcolor{stringliteral}{"  inside an argument with a 12 digits number in the specified range\(\backslash\)n"}
00581 \textcolor{stringliteral}{"  from 0 to keyspacelen-1. The substitution changes every time a command\(\backslash\)n"}
00582 \textcolor{stringliteral}{"  is executed. Default tests use this to hit random keys in the\(\backslash\)n"}
00583 \textcolor{stringliteral}{"  specified range.\(\backslash\)n"}
00584 \textcolor{stringliteral}{" -P <numreq>        Pipeline <numreq> requests. Default 1 (no pipeline).\(\backslash\)n"}
00585 \textcolor{stringliteral}{" -e                 If server replies with errors, show them on stdout.\(\backslash\)n"}
00586 \textcolor{stringliteral}{"                    (no more than 1 error per second is displayed)\(\backslash\)n"}
00587 \textcolor{stringliteral}{" -q                 Quiet. Just show query/sec values\(\backslash\)n"}
00588 \textcolor{stringliteral}{" --csv              Output in CSV format\(\backslash\)n"}
00589 \textcolor{stringliteral}{" -l                 Loop. Run the tests forever\(\backslash\)n"}
00590 \textcolor{stringliteral}{" -t <tests>         Only run the comma separated list of tests. The test\(\backslash\)n"}
00591 \textcolor{stringliteral}{"                    names are the same as the ones produced as output.\(\backslash\)n"}
00592 \textcolor{stringliteral}{" -I                 Idle mode. Just open N idle connections and wait.\(\backslash\)n\(\backslash\)n"}
00593 \textcolor{stringliteral}{"Examples:\(\backslash\)n\(\backslash\)n"}
00594 \textcolor{stringliteral}{" Run the benchmark with the default configuration against 127.0.0.1:6379:\(\backslash\)n"}
00595 \textcolor{stringliteral}{"   $ redis-benchmark\(\backslash\)n\(\backslash\)n"}
00596 \textcolor{stringliteral}{" Use 20 parallel clients, for a total of 100k requests, against 192.168.1.1:\(\backslash\)n"}
00597 \textcolor{stringliteral}{"   $ redis-benchmark -h 192.168.1.1 -p 6379 -n 100000 -c 20\(\backslash\)n\(\backslash\)n"}
00598 \textcolor{stringliteral}{" Fill 127.0.0.1:6379 with about 1 million keys only using the SET test:\(\backslash\)n"}
00599 \textcolor{stringliteral}{"   $ redis-benchmark -t set -n 1000000 -r 100000000\(\backslash\)n\(\backslash\)n"}
00600 \textcolor{stringliteral}{" Benchmark 127.0.0.1:6379 for a few commands producing CSV output:\(\backslash\)n"}
00601 \textcolor{stringliteral}{"   $ redis-benchmark -t ping,set,get -n 100000 --csv\(\backslash\)n\(\backslash\)n"}
00602 \textcolor{stringliteral}{" Benchmark a specific command line:\(\backslash\)n"}
00603 \textcolor{stringliteral}{"   $ redis-benchmark -r 10000 -n 10000 eval 'return redis.call(\(\backslash\)"ping\(\backslash\)")' 0\(\backslash\)n\(\backslash\)n"}
00604 \textcolor{stringliteral}{" Fill a list with 10000 random elements:\(\backslash\)n"}
00605 \textcolor{stringliteral}{"   $ redis-benchmark -r 10000 -n 10000 lpush mylist \_\_rand\_int\_\_\(\backslash\)n\(\backslash\)n"}
00606 \textcolor{stringliteral}{" On user specified command lines \_\_rand\_int\_\_ is replaced with a random integer\(\backslash\)n"}
00607 \textcolor{stringliteral}{" with a range of values selected by the -r option.\(\backslash\)n"}
00608     );
00609     exit(exit\_status);
00610 \}
00611 
00612 \textcolor{keywordtype}{int} showThroughput(\textcolor{keyword}{struct} \hyperlink{structaeEventLoop}{aeEventLoop} *eventLoop, \textcolor{keywordtype}{long} \textcolor{keywordtype}{long} id, \textcolor{keywordtype}{void} *clientData) \{
00613     \hyperlink{server_8h_ae7c9dc8f13568a9c856573751f1ee1ec}{UNUSED}(eventLoop);
00614     \hyperlink{server_8h_ae7c9dc8f13568a9c856573751f1ee1ec}{UNUSED}(id);
00615     \hyperlink{server_8h_ae7c9dc8f13568a9c856573751f1ee1ec}{UNUSED}(clientData);
00616 
00617     \textcolor{keywordflow}{if} (config.liveclients == 0) \{
00618         fprintf(stderr,\textcolor{stringliteral}{"All clients disconnected... aborting.\(\backslash\)n"});
00619         exit(1);
00620     \}
00621     \textcolor{keywordflow}{if} (config.csv) \textcolor{keywordflow}{return} 250;
00622     \textcolor{keywordflow}{if} (config.idlemode == 1) \{
00623         printf(\textcolor{stringliteral}{"clients: %d\(\backslash\)r"}, config.liveclients);
00624         fflush(stdout);
00625     \textcolor{keywordflow}{return} 250;
00626     \}
00627     \textcolor{keywordtype}{float} dt = (\textcolor{keywordtype}{float})(mstime()-config.start)/1000.0;
00628     \textcolor{keywordtype}{float} rps = (\textcolor{keywordtype}{float})config.requests\_finished/dt;
00629     printf(\textcolor{stringliteral}{"%s: %.2f\(\backslash\)r"}, config.title, rps);
00630     fflush(stdout);
00631     \textcolor{keywordflow}{return} 250; \textcolor{comment}{/* every 250ms */}
00632 \}
00633 
00634 \textcolor{comment}{/* Return true if the named test was selected using the -t command line}
00635 \textcolor{comment}{ * switch, or if all the tests are selected (no -t passed by user). */}
00636 \textcolor{keywordtype}{int} test\_is\_selected(\textcolor{keywordtype}{char} *name) \{
00637     \textcolor{keywordtype}{char} buf[256];
00638     \textcolor{keywordtype}{int} l = strlen(name);
00639 
00640     \textcolor{keywordflow}{if} (config.tests == NULL) \textcolor{keywordflow}{return} 1;
00641     buf[0] = \textcolor{stringliteral}{','};
00642     memcpy(buf+1,name,l);
00643     buf[l+1] = \textcolor{stringliteral}{','};
00644     buf[l+2] = \textcolor{stringliteral}{'\(\backslash\)0'};
00645     \textcolor{keywordflow}{return} strstr(config.tests,buf) != NULL;
00646 \}
00647 
00648 \textcolor{keywordtype}{int} main(\textcolor{keywordtype}{int} argc, \textcolor{keyword}{const} \textcolor{keywordtype}{char} **argv) \{
00649     \textcolor{keywordtype}{int} i;
00650     \textcolor{keywordtype}{char} *data, *cmd;
00651     \textcolor{keywordtype}{int} len;
00652 
00653     client c;
00654 
00655     srandom(time(NULL));
00656     signal(SIGHUP, SIG\_IGN);
00657     signal(SIGPIPE, SIG\_IGN);
00658 
00659     config.numclients = 50;
00660     config.requests = 100000;
00661     config.liveclients = 0;
00662     config.el = aeCreateEventLoop(1024*10);
00663     aeCreateTimeEvent(config.el,1,showThroughput,NULL,NULL);
00664     config.keepalive = 1;
00665     config.datasize = 3;
00666     config.pipeline = 1;
00667     config.showerrors = 0;
00668     config.randomkeys = 0;
00669     config.randomkeys\_keyspacelen = 0;
00670     config.quiet = 0;
00671     config.csv = 0;
00672     config.loop = 0;
00673     config.idlemode = 0;
00674     config.latency = NULL;
00675     config.clients = listCreate();
00676     config.hostip = \textcolor{stringliteral}{"127.0.0.1"};
00677     config.hostport = 6379;
00678     config.hostsocket = NULL;
00679     config.tests = NULL;
00680     config.dbnum = 0;
00681     config.auth = NULL;
00682 
00683     i = parseOptions(argc,argv);
00684     argc -= i;
00685     argv += i;
00686 
00687     config.latency = zmalloc(\textcolor{keyword}{sizeof}(\textcolor{keywordtype}{long} \textcolor{keywordtype}{long})*config.requests);
00688 
00689     \textcolor{keywordflow}{if} (config.keepalive == 0) \{
00690         printf(\textcolor{stringliteral}{"WARNING: keepalive disabled, you probably need 'echo 1 >
       /proc/sys/net/ipv4/tcp\_tw\_reuse' for Linux and 'sudo sysctl -w net.inet.tcp.msl=1000' for Mac OS X in order to use a lot of
       clients/requests\(\backslash\)n"});
00691     \}
00692 
00693     \textcolor{keywordflow}{if} (config.idlemode) \{
00694         printf(\textcolor{stringliteral}{"Creating %d idle connections and waiting forever (Ctrl+C when done)\(\backslash\)n"}, config.
      numclients);
00695         c = createClient(\textcolor{stringliteral}{""},0,NULL); \textcolor{comment}{/* will never receive a reply */}
00696         createMissingClients(c);
00697         aeMain(config.el);
00698         \textcolor{comment}{/* and will wait for every */}
00699     \}
00700 
00701     \textcolor{comment}{/* Run benchmark with command in the remainder of the arguments. */}
00702     \textcolor{keywordflow}{if} (argc) \{
00703         sds title = sdsnew(argv[0]);
00704         \textcolor{keywordflow}{for} (i = 1; i < argc; i++) \{
00705             title = sdscatlen(title, \textcolor{stringliteral}{" "}, 1);
00706             title = sdscatlen(title, (\textcolor{keywordtype}{char}*)argv[i], strlen(argv[i]));
00707         \}
00708 
00709         \textcolor{keywordflow}{do} \{
00710             len = redisFormatCommandArgv(&cmd,argc,argv,NULL);
00711             benchmark(title,cmd,len);
00712             free(cmd);
00713         \} \textcolor{keywordflow}{while}(config.loop);
00714 
00715         \textcolor{keywordflow}{return} 0;
00716     \}
00717 
00718     \textcolor{comment}{/* Run default benchmark suite. */}
00719     data = zmalloc(config.datasize+1);
00720     \textcolor{keywordflow}{do} \{
00721         memset(data,\textcolor{stringliteral}{'x'},config.datasize);
00722         data[config.datasize] = \textcolor{stringliteral}{'\(\backslash\)0'};
00723 
00724         \textcolor{keywordflow}{if} (test\_is\_selected(\textcolor{stringliteral}{"ping\_inline"}) || test\_is\_selected(\textcolor{stringliteral}{"ping"}))
00725             benchmark(\textcolor{stringliteral}{"PING\_INLINE"},\textcolor{stringliteral}{"PING\(\backslash\)r\(\backslash\)n"},6);
00726 
00727         \textcolor{keywordflow}{if} (test\_is\_selected(\textcolor{stringliteral}{"ping\_mbulk"}) || test\_is\_selected(\textcolor{stringliteral}{"ping"})) \{
00728             len = redisFormatCommand(&cmd,\textcolor{stringliteral}{"PING"});
00729             benchmark(\textcolor{stringliteral}{"PING\_BULK"},cmd,len);
00730             free(cmd);
00731         \}
00732 
00733         \textcolor{keywordflow}{if} (test\_is\_selected(\textcolor{stringliteral}{"set"})) \{
00734             len = redisFormatCommand(&cmd,\textcolor{stringliteral}{"SET key:\_\_rand\_int\_\_ %s"},data);
00735             benchmark(\textcolor{stringliteral}{"SET"},cmd,len);
00736             free(cmd);
00737         \}
00738 
00739         \textcolor{keywordflow}{if} (test\_is\_selected(\textcolor{stringliteral}{"get"})) \{
00740             len = redisFormatCommand(&cmd,\textcolor{stringliteral}{"GET key:\_\_rand\_int\_\_"});
00741             benchmark(\textcolor{stringliteral}{"GET"},cmd,len);
00742             free(cmd);
00743         \}
00744 
00745         \textcolor{keywordflow}{if} (test\_is\_selected(\textcolor{stringliteral}{"incr"})) \{
00746             len = redisFormatCommand(&cmd,\textcolor{stringliteral}{"INCR counter:\_\_rand\_int\_\_"});
00747             benchmark(\textcolor{stringliteral}{"INCR"},cmd,len);
00748             free(cmd);
00749         \}
00750 
00751         \textcolor{keywordflow}{if} (test\_is\_selected(\textcolor{stringliteral}{"lpush"})) \{
00752             len = redisFormatCommand(&cmd,\textcolor{stringliteral}{"LPUSH mylist %s"},data);
00753             benchmark(\textcolor{stringliteral}{"LPUSH"},cmd,len);
00754             free(cmd);
00755         \}
00756 
00757         \textcolor{keywordflow}{if} (test\_is\_selected(\textcolor{stringliteral}{"rpush"})) \{
00758             len = redisFormatCommand(&cmd,\textcolor{stringliteral}{"RPUSH mylist %s"},data);
00759             benchmark(\textcolor{stringliteral}{"RPUSH"},cmd,len);
00760             free(cmd);
00761         \}
00762 
00763         \textcolor{keywordflow}{if} (test\_is\_selected(\textcolor{stringliteral}{"lpop"})) \{
00764             len = redisFormatCommand(&cmd,\textcolor{stringliteral}{"LPOP mylist"});
00765             benchmark(\textcolor{stringliteral}{"LPOP"},cmd,len);
00766             free(cmd);
00767         \}
00768 
00769         \textcolor{keywordflow}{if} (test\_is\_selected(\textcolor{stringliteral}{"rpop"})) \{
00770             len = redisFormatCommand(&cmd,\textcolor{stringliteral}{"RPOP mylist"});
00771             benchmark(\textcolor{stringliteral}{"RPOP"},cmd,len);
00772             free(cmd);
00773         \}
00774 
00775         \textcolor{keywordflow}{if} (test\_is\_selected(\textcolor{stringliteral}{"sadd"})) \{
00776             len = redisFormatCommand(&cmd,
00777                 \textcolor{stringliteral}{"SADD myset element:\_\_rand\_int\_\_"});
00778             benchmark(\textcolor{stringliteral}{"SADD"},cmd,len);
00779             free(cmd);
00780         \}
00781 
00782         \textcolor{keywordflow}{if} (test\_is\_selected(\textcolor{stringliteral}{"hset"})) \{
00783             len = redisFormatCommand(&cmd,
00784                 \textcolor{stringliteral}{"HSET myset:\_\_rand\_int\_\_ element:\_\_rand\_int\_\_ %s"},data);
00785             benchmark(\textcolor{stringliteral}{"HSET"},cmd,len);
00786             free(cmd);
00787         \}
00788 
00789         \textcolor{keywordflow}{if} (test\_is\_selected(\textcolor{stringliteral}{"spop"})) \{
00790             len = redisFormatCommand(&cmd,\textcolor{stringliteral}{"SPOP myset"});
00791             benchmark(\textcolor{stringliteral}{"SPOP"},cmd,len);
00792             free(cmd);
00793         \}
00794 
00795         \textcolor{keywordflow}{if} (test\_is\_selected(\textcolor{stringliteral}{"lrange"}) ||
00796             test\_is\_selected(\textcolor{stringliteral}{"lrange\_100"}) ||
00797             test\_is\_selected(\textcolor{stringliteral}{"lrange\_300"}) ||
00798             test\_is\_selected(\textcolor{stringliteral}{"lrange\_500"}) ||
00799             test\_is\_selected(\textcolor{stringliteral}{"lrange\_600"}))
00800         \{
00801             len = redisFormatCommand(&cmd,\textcolor{stringliteral}{"LPUSH mylist %s"},data);
00802             benchmark(\textcolor{stringliteral}{"LPUSH (needed to benchmark LRANGE)"},cmd,len);
00803             free(cmd);
00804         \}
00805 
00806         \textcolor{keywordflow}{if} (test\_is\_selected(\textcolor{stringliteral}{"lrange"}) || test\_is\_selected(\textcolor{stringliteral}{"lrange\_100"})) \{
00807             len = redisFormatCommand(&cmd,\textcolor{stringliteral}{"LRANGE mylist 0 99"});
00808             benchmark(\textcolor{stringliteral}{"LRANGE\_100 (first 100 elements)"},cmd,len);
00809             free(cmd);
00810         \}
00811 
00812         \textcolor{keywordflow}{if} (test\_is\_selected(\textcolor{stringliteral}{"lrange"}) || test\_is\_selected(\textcolor{stringliteral}{"lrange\_300"})) \{
00813             len = redisFormatCommand(&cmd,\textcolor{stringliteral}{"LRANGE mylist 0 299"});
00814             benchmark(\textcolor{stringliteral}{"LRANGE\_300 (first 300 elements)"},cmd,len);
00815             free(cmd);
00816         \}
00817 
00818         \textcolor{keywordflow}{if} (test\_is\_selected(\textcolor{stringliteral}{"lrange"}) || test\_is\_selected(\textcolor{stringliteral}{"lrange\_500"})) \{
00819             len = redisFormatCommand(&cmd,\textcolor{stringliteral}{"LRANGE mylist 0 449"});
00820             benchmark(\textcolor{stringliteral}{"LRANGE\_500 (first 450 elements)"},cmd,len);
00821             free(cmd);
00822         \}
00823 
00824         \textcolor{keywordflow}{if} (test\_is\_selected(\textcolor{stringliteral}{"lrange"}) || test\_is\_selected(\textcolor{stringliteral}{"lrange\_600"})) \{
00825             len = redisFormatCommand(&cmd,\textcolor{stringliteral}{"LRANGE mylist 0 599"});
00826             benchmark(\textcolor{stringliteral}{"LRANGE\_600 (first 600 elements)"},cmd,len);
00827             free(cmd);
00828         \}
00829 
00830         \textcolor{keywordflow}{if} (test\_is\_selected(\textcolor{stringliteral}{"mset"})) \{
00831             \textcolor{keyword}{const} \textcolor{keywordtype}{char} *argv[21];
00832             argv[0] = \textcolor{stringliteral}{"MSET"};
00833             \textcolor{keywordflow}{for} (i = 1; i < 21; i += 2) \{
00834                 argv[i] = \textcolor{stringliteral}{"key:\_\_rand\_int\_\_"};
00835                 argv[i+1] = data;
00836             \}
00837             len = redisFormatCommandArgv(&cmd,21,argv,NULL);
00838             benchmark(\textcolor{stringliteral}{"MSET (10 keys)"},cmd,len);
00839             free(cmd);
00840         \}
00841 
00842         \textcolor{keywordflow}{if} (!config.csv) printf(\textcolor{stringliteral}{"\(\backslash\)n"});
00843     \} \textcolor{keywordflow}{while}(config.loop);
00844 
00845     \textcolor{keywordflow}{return} 0;
00846 \}
\end{DoxyCode}
