\hypertarget{ae__select_8c_source}{}\section{ae\+\_\+select.\+c}
\label{ae__select_8c_source}\index{src/ae\+\_\+select.\+c@{src/ae\+\_\+select.\+c}}

\begin{DoxyCode}
00001 \textcolor{comment}{/* Select()-based ae.c module.}
00002 \textcolor{comment}{ *}
00003 \textcolor{comment}{ * Copyright (c) 2009-2012, Salvatore Sanfilippo <antirez at gmail dot com>}
00004 \textcolor{comment}{ * All rights reserved.}
00005 \textcolor{comment}{ *}
00006 \textcolor{comment}{ * Redistribution and use in source and binary forms, with or without}
00007 \textcolor{comment}{ * modification, are permitted provided that the following conditions are met:}
00008 \textcolor{comment}{ *}
00009 \textcolor{comment}{ *   * Redistributions of source code must retain the above copyright notice,}
00010 \textcolor{comment}{ *     this list of conditions and the following disclaimer.}
00011 \textcolor{comment}{ *   * Redistributions in binary form must reproduce the above copyright}
00012 \textcolor{comment}{ *     notice, this list of conditions and the following disclaimer in the}
00013 \textcolor{comment}{ *     documentation and/or other materials provided with the distribution.}
00014 \textcolor{comment}{ *   * Neither the name of Redis nor the names of its contributors may be used}
00015 \textcolor{comment}{ *     to endorse or promote products derived from this software without}
00016 \textcolor{comment}{ *     specific prior written permission.}
00017 \textcolor{comment}{ *}
00018 \textcolor{comment}{ * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"}
00019 \textcolor{comment}{ * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE}
00020 \textcolor{comment}{ * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE}
00021 \textcolor{comment}{ * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE}
00022 \textcolor{comment}{ * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR}
00023 \textcolor{comment}{ * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF}
00024 \textcolor{comment}{ * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS}
00025 \textcolor{comment}{ * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN}
00026 \textcolor{comment}{ * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)}
00027 \textcolor{comment}{ * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE}
00028 \textcolor{comment}{ * POSSIBILITY OF SUCH DAMAGE.}
00029 \textcolor{comment}{ */}
00030 
00031 
00032 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{sys}\textcolor{preprocessor}{/}\textcolor{preprocessor}{select}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00033 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{string}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00034 
00035 \textcolor{keyword}{typedef} \textcolor{keyword}{struct} \hyperlink{structaeApiState}{aeApiState} \{
00036     fd\_set rfds, wfds;
00037     \textcolor{comment}{/* We need to have a copy of the fd sets as it's not safe to reuse}
00038 \textcolor{comment}{     * FD sets after select(). */}
00039     fd\_set \_rfds, \_wfds;
00040 \} aeApiState;
00041 
00042 \textcolor{keyword}{static} \textcolor{keywordtype}{int} aeApiCreate(aeEventLoop *eventLoop) \{
00043     aeApiState *state = zmalloc(\textcolor{keyword}{sizeof}(aeApiState));
00044 
00045     \textcolor{keywordflow}{if} (!state) \textcolor{keywordflow}{return} -1;
00046     FD\_ZERO(&state->rfds);
00047     FD\_ZERO(&state->wfds);
00048     eventLoop->apidata = state;
00049     \textcolor{keywordflow}{return} 0;
00050 \}
00051 
00052 \textcolor{keyword}{static} \textcolor{keywordtype}{int} aeApiResize(aeEventLoop *eventLoop, \textcolor{keywordtype}{int} setsize) \{
00053     \textcolor{comment}{/* Just ensure we have enough room in the fd\_set type. */}
00054     \textcolor{keywordflow}{if} (setsize >= FD\_SETSIZE) \textcolor{keywordflow}{return} -1;
00055     \textcolor{keywordflow}{return} 0;
00056 \}
00057 
00058 \textcolor{keyword}{static} \textcolor{keywordtype}{void} aeApiFree(aeEventLoop *eventLoop) \{
00059     zfree(eventLoop->apidata);
00060 \}
00061 
00062 \textcolor{keyword}{static} \textcolor{keywordtype}{int} aeApiAddEvent(aeEventLoop *eventLoop, \textcolor{keywordtype}{int} fd, \textcolor{keywordtype}{int} mask) \{
00063     aeApiState *state = eventLoop->apidata;
00064 
00065     \textcolor{keywordflow}{if} (mask & AE\_READABLE) FD\_SET(fd,&state->rfds);
00066     \textcolor{keywordflow}{if} (mask & AE\_WRITABLE) FD\_SET(fd,&state->wfds);
00067     \textcolor{keywordflow}{return} 0;
00068 \}
00069 
00070 \textcolor{keyword}{static} \textcolor{keywordtype}{void} aeApiDelEvent(aeEventLoop *eventLoop, \textcolor{keywordtype}{int} fd, \textcolor{keywordtype}{int} mask) \{
00071     aeApiState *state = eventLoop->apidata;
00072 
00073     \textcolor{keywordflow}{if} (mask & AE\_READABLE) FD\_CLR(fd,&state->rfds);
00074     \textcolor{keywordflow}{if} (mask & AE\_WRITABLE) FD\_CLR(fd,&state->wfds);
00075 \}
00076 
00077 \textcolor{keyword}{static} \textcolor{keywordtype}{int} aeApiPoll(aeEventLoop *eventLoop, \textcolor{keyword}{struct} timeval *tvp) \{
00078     aeApiState *state = eventLoop->apidata;
00079     \textcolor{keywordtype}{int} retval, j, numevents = 0;
00080 
00081     memcpy(&state->\_rfds,&state->rfds,\textcolor{keyword}{sizeof}(fd\_set));
00082     memcpy(&state->\_wfds,&state->wfds,\textcolor{keyword}{sizeof}(fd\_set));
00083 
00084     retval = select(eventLoop->maxfd+1,
00085                 &state->\_rfds,&state->\_wfds,NULL,tvp);
00086     \textcolor{keywordflow}{if} (retval > 0) \{
00087         \textcolor{keywordflow}{for} (j = 0; j <= eventLoop->maxfd; j++) \{
00088             \textcolor{keywordtype}{int} mask = 0;
00089             aeFileEvent *fe = &eventLoop->events[j];
00090 
00091             \textcolor{keywordflow}{if} (fe->mask == AE\_NONE) \textcolor{keywordflow}{continue};
00092             \textcolor{keywordflow}{if} (fe->mask & AE\_READABLE && FD\_ISSET(j,&state->\_rfds))
00093                 mask |= AE\_READABLE;
00094             \textcolor{keywordflow}{if} (fe->mask & AE\_WRITABLE && FD\_ISSET(j,&state->\_wfds))
00095                 mask |= AE\_WRITABLE;
00096             eventLoop->fired[numevents].fd = j;
00097             eventLoop->fired[numevents].mask = mask;
00098             numevents++;
00099         \}
00100     \}
00101     \textcolor{keywordflow}{return} numevents;
00102 \}
00103 
00104 \textcolor{keyword}{static} \textcolor{keywordtype}{char} *aeApiName(\textcolor{keywordtype}{void}) \{
00105     \textcolor{keywordflow}{return} \textcolor{stringliteral}{"select"};
00106 \}
\end{DoxyCode}
