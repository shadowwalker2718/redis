\hypertarget{lzf__d_8c_source}{}\section{lzf\+\_\+d.\+c}
\label{lzf__d_8c_source}\index{src/lzf\+\_\+d.\+c@{src/lzf\+\_\+d.\+c}}

\begin{DoxyCode}
00001 \textcolor{comment}{/*}
00002 \textcolor{comment}{ * Copyright (c) 2000-2010 Marc Alexander Lehmann <schmorp@schmorp.de>}
00003 \textcolor{comment}{ *}
00004 \textcolor{comment}{ * Redistribution and use in source and binary forms, with or without modifica-}
00005 \textcolor{comment}{ * tion, are permitted provided that the following conditions are met:}
00006 \textcolor{comment}{ *}
00007 \textcolor{comment}{ *   1.  Redistributions of source code must retain the above copyright notice,}
00008 \textcolor{comment}{ *       this list of conditions and the following disclaimer.}
00009 \textcolor{comment}{ *}
00010 \textcolor{comment}{ *   2.  Redistributions in binary form must reproduce the above copyright}
00011 \textcolor{comment}{ *       notice, this list of conditions and the following disclaimer in the}
00012 \textcolor{comment}{ *       documentation and/or other materials provided with the distribution.}
00013 \textcolor{comment}{ *}
00014 \textcolor{comment}{ * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR IMPLIED}
00015 \textcolor{comment}{ * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MER-}
00016 \textcolor{comment}{ * CHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  IN NO}
00017 \textcolor{comment}{ * EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPE-}
00018 \textcolor{comment}{ * CIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,}
00019 \textcolor{comment}{ * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS;}
00020 \textcolor{comment}{ * OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,}
00021 \textcolor{comment}{ * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTH-}
00022 \textcolor{comment}{ * ERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED}
00023 \textcolor{comment}{ * OF THE POSSIBILITY OF SUCH DAMAGE.}
00024 \textcolor{comment}{ *}
00025 \textcolor{comment}{ * Alternatively, the contents of this file may be used under the terms of}
00026 \textcolor{comment}{ * the GNU General Public License ("GPL") version 2 or any later version,}
00027 \textcolor{comment}{ * in which case the provisions of the GPL are applicable instead of}
00028 \textcolor{comment}{ * the above. If you wish to allow the use of your version of this file}
00029 \textcolor{comment}{ * only under the terms of the GPL and not to allow others to use your}
00030 \textcolor{comment}{ * version of this file under the BSD license, indicate your decision}
00031 \textcolor{comment}{ * by deleting the provisions above and replace them with the notice}
00032 \textcolor{comment}{ * and other provisions required by the GPL. If you do not delete the}
00033 \textcolor{comment}{ * provisions above, a recipient may use your version of this file under}
00034 \textcolor{comment}{ * either the BSD or the GPL.}
00035 \textcolor{comment}{ */}
00036 
00037 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \hyperlink{lzfP_8h}{"lzfP.h"}
00038 
00039 \textcolor{preprocessor}{#}\textcolor{preprocessor}{if} \hyperlink{lzfP_8h_ab79b1248963e926daff345624578d082}{AVOID\_ERRNO}
00040 \textcolor{preprocessor}{#} \textcolor{preprocessor}{define} \textcolor{preprocessor}{SET\_ERRNO}\textcolor{preprocessor}{(}\textcolor{preprocessor}{n}\textcolor{preprocessor}{)}
00041 \textcolor{preprocessor}{#}\textcolor{preprocessor}{else}
00042 \textcolor{preprocessor}{#} \textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{errno}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00043 \textcolor{preprocessor}{#} \textcolor{preprocessor}{define} \textcolor{preprocessor}{SET\_ERRNO}\textcolor{preprocessor}{(}\textcolor{preprocessor}{n}\textcolor{preprocessor}{)} errno \textcolor{preprocessor}{=} \textcolor{preprocessor}{(}\textcolor{preprocessor}{n}\textcolor{preprocessor}{)}
00044 \textcolor{preprocessor}{#}\textcolor{preprocessor}{endif}
00045 
00046 \textcolor{preprocessor}{#}\textcolor{preprocessor}{if} \textcolor{preprocessor}{USE\_REP\_MOVSB} \textcolor{comment}{/* small win on amd, big loss on intel */}
00047 \textcolor{preprocessor}{#}\textcolor{preprocessor}{if} \textcolor{preprocessor}{(}\textcolor{preprocessor}{\_\_i386} \textcolor{preprocessor}{||} \textcolor{preprocessor}{\_\_amd64}\textcolor{preprocessor}{)} \textcolor{preprocessor}{&&} \textcolor{preprocessor}{\_\_GNUC\_\_} \textcolor{preprocessor}{>=} 3
00048 \textcolor{preprocessor}{#} \textcolor{preprocessor}{define} \textcolor{preprocessor}{lzf\_movsb}\textcolor{preprocessor}{(}\textcolor{preprocessor}{dst}\textcolor{preprocessor}{,} \textcolor{preprocessor}{src}\textcolor{preprocessor}{,} \textcolor{preprocessor}{len}\textcolor{preprocessor}{)}
00049    \textcolor{preprocessor}{asm} \textcolor{preprocessor}{(}\textcolor{stringliteral}{"rep movsb"}
00050         \textcolor{preprocessor}{:} \textcolor{stringliteral}{"=D"} \textcolor{preprocessor}{(}\textcolor{preprocessor}{dst}\textcolor{preprocessor}{)}\textcolor{preprocessor}{,} \textcolor{stringliteral}{"=S"} \textcolor{preprocessor}{(}\textcolor{preprocessor}{src}\textcolor{preprocessor}{)}\textcolor{preprocessor}{,} \textcolor{stringliteral}{"=c"} \textcolor{preprocessor}{(}\textcolor{preprocessor}{len}\textcolor{preprocessor}{)}
00051         \textcolor{preprocessor}{:}  \textcolor{stringliteral}{"0"} \textcolor{preprocessor}{(}\textcolor{preprocessor}{dst}\textcolor{preprocessor}{)}\textcolor{preprocessor}{,}  \textcolor{stringliteral}{"1"} \textcolor{preprocessor}{(}\textcolor{preprocessor}{src}\textcolor{preprocessor}{)}\textcolor{preprocessor}{,}  \textcolor{stringliteral}{"2"} \textcolor{preprocessor}{(}\textcolor{preprocessor}{len}\textcolor{preprocessor}{)}\textcolor{preprocessor}{)}\textcolor{preprocessor}{;}
00052 \textcolor{preprocessor}{#}\textcolor{preprocessor}{endif}
00053 \textcolor{preprocessor}{#}\textcolor{preprocessor}{endif}
00054 
00055 \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int}
00056 lzf\_decompress (\textcolor{keyword}{const} \textcolor{keywordtype}{void} *\textcolor{keyword}{const} in\_data,  \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} in\_len,
00057                 \textcolor{keywordtype}{void}             *out\_data, \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} out\_len)
00058 \{
00059   u8 \textcolor{keyword}{const} *ip = (\textcolor{keyword}{const} u8 *)in\_data;
00060   u8       *op = (u8 *)out\_data;
00061   u8 \textcolor{keyword}{const} *\textcolor{keyword}{const} in\_end  = ip + in\_len;
00062   u8       *\textcolor{keyword}{const} out\_end = op + out\_len;
00063 
00064   \textcolor{keywordflow}{do}
00065     \{
00066       \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} ctrl = *ip++;
00067 
00068       \textcolor{keywordflow}{if} (ctrl < (1 << 5)) \textcolor{comment}{/* literal run */}
00069         \{
00070           ctrl++;
00071 
00072           \textcolor{keywordflow}{if} (op + ctrl > out\_end)
00073             \{
00074               \hyperlink{lzf__d_8c_a9539a5281f41104073dfbcb2ebf35f9d}{SET\_ERRNO} (E2BIG);
00075               \textcolor{keywordflow}{return} 0;
00076             \}
00077 
00078 \textcolor{preprocessor}{#}\textcolor{preprocessor}{if} \hyperlink{lzfP_8h_a1a4fde3dbdd8e8f920a325f551fcfd94}{CHECK\_INPUT}
00079           \textcolor{keywordflow}{if} (ip + ctrl > in\_end)
00080             \{
00081               \hyperlink{lzf__d_8c_a9539a5281f41104073dfbcb2ebf35f9d}{SET\_ERRNO} (EINVAL);
00082               \textcolor{keywordflow}{return} 0;
00083             \}
00084 \textcolor{preprocessor}{#}\textcolor{preprocessor}{endif}
00085 
00086 \textcolor{preprocessor}{#}\textcolor{preprocessor}{ifdef} \textcolor{preprocessor}{lzf\_movsb}
00087           lzf\_movsb (op, ip, ctrl);
00088 \textcolor{preprocessor}{#}\textcolor{preprocessor}{else}
00089           \textcolor{keywordflow}{switch} (ctrl)
00090             \{
00091               \textcolor{keywordflow}{case} 32: *op++ = *ip++; \textcolor{keywordflow}{case} 31: *op++ = *ip++; \textcolor{keywordflow}{case} 30: *op++ = *ip++; \textcolor{keywordflow}{case} 29: *op++ =
       *ip++;
00092               \textcolor{keywordflow}{case} 28: *op++ = *ip++; \textcolor{keywordflow}{case} 27: *op++ = *ip++; \textcolor{keywordflow}{case} 26: *op++ = *ip++; \textcolor{keywordflow}{case} 25: *op++ =
       *ip++;
00093               \textcolor{keywordflow}{case} 24: *op++ = *ip++; \textcolor{keywordflow}{case} 23: *op++ = *ip++; \textcolor{keywordflow}{case} 22: *op++ = *ip++; \textcolor{keywordflow}{case} 21: *op++ =
       *ip++;
00094               \textcolor{keywordflow}{case} 20: *op++ = *ip++; \textcolor{keywordflow}{case} 19: *op++ = *ip++; \textcolor{keywordflow}{case} 18: *op++ = *ip++; \textcolor{keywordflow}{case} 17: *op++ =
       *ip++;
00095               \textcolor{keywordflow}{case} 16: *op++ = *ip++; \textcolor{keywordflow}{case} 15: *op++ = *ip++; \textcolor{keywordflow}{case} 14: *op++ = *ip++; \textcolor{keywordflow}{case} 13: *op++ =
       *ip++;
00096               \textcolor{keywordflow}{case} 12: *op++ = *ip++; \textcolor{keywordflow}{case} 11: *op++ = *ip++; \textcolor{keywordflow}{case} 10: *op++ = *ip++; \textcolor{keywordflow}{case}  9: *op++ =
       *ip++;
00097               \textcolor{keywordflow}{case}  8: *op++ = *ip++; \textcolor{keywordflow}{case}  7: *op++ = *ip++; \textcolor{keywordflow}{case}  6: *op++ = *ip++; \textcolor{keywordflow}{case}  5: *op++ =
       *ip++;
00098               \textcolor{keywordflow}{case}  4: *op++ = *ip++; \textcolor{keywordflow}{case}  3: *op++ = *ip++; \textcolor{keywordflow}{case}  2: *op++ = *ip++; \textcolor{keywordflow}{case}  1: *op++ =
       *ip++;
00099             \}
00100 \textcolor{preprocessor}{#}\textcolor{preprocessor}{endif}
00101         \}
00102       \textcolor{keywordflow}{else} \textcolor{comment}{/* back reference */}
00103         \{
00104           \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} len = ctrl >> 5;
00105 
00106           u8 *ref = op - ((ctrl & 0x1f) << 8) - 1;
00107 
00108 \textcolor{preprocessor}{#}\textcolor{preprocessor}{if} \hyperlink{lzfP_8h_a1a4fde3dbdd8e8f920a325f551fcfd94}{CHECK\_INPUT}
00109           \textcolor{keywordflow}{if} (ip >= in\_end)
00110             \{
00111               \hyperlink{lzf__d_8c_a9539a5281f41104073dfbcb2ebf35f9d}{SET\_ERRNO} (EINVAL);
00112               \textcolor{keywordflow}{return} 0;
00113             \}
00114 \textcolor{preprocessor}{#}\textcolor{preprocessor}{endif}
00115           \textcolor{keywordflow}{if} (len == 7)
00116             \{
00117               len += *ip++;
00118 \textcolor{preprocessor}{#}\textcolor{preprocessor}{if} \hyperlink{lzfP_8h_a1a4fde3dbdd8e8f920a325f551fcfd94}{CHECK\_INPUT}
00119               \textcolor{keywordflow}{if} (ip >= in\_end)
00120                 \{
00121                   \hyperlink{lzf__d_8c_a9539a5281f41104073dfbcb2ebf35f9d}{SET\_ERRNO} (EINVAL);
00122                   \textcolor{keywordflow}{return} 0;
00123                 \}
00124 \textcolor{preprocessor}{#}\textcolor{preprocessor}{endif}
00125             \}
00126 
00127           ref -= *ip++;
00128 
00129           \textcolor{keywordflow}{if} (op + len + 2 > out\_end)
00130             \{
00131               \hyperlink{lzf__d_8c_a9539a5281f41104073dfbcb2ebf35f9d}{SET\_ERRNO} (E2BIG);
00132               \textcolor{keywordflow}{return} 0;
00133             \}
00134 
00135           \textcolor{keywordflow}{if} (ref < (u8 *)out\_data)
00136             \{
00137               \hyperlink{lzf__d_8c_a9539a5281f41104073dfbcb2ebf35f9d}{SET\_ERRNO} (EINVAL);
00138               \textcolor{keywordflow}{return} 0;
00139             \}
00140 
00141 \textcolor{preprocessor}{#}\textcolor{preprocessor}{ifdef} \textcolor{preprocessor}{lzf\_movsb}
00142           len += 2;
00143           lzf\_movsb (op, ref, len);
00144 \textcolor{preprocessor}{#}\textcolor{preprocessor}{else}
00145           \textcolor{keywordflow}{switch} (len)
00146             \{
00147               \textcolor{keywordflow}{default}:
00148                 len += 2;
00149 
00150                 \textcolor{keywordflow}{if} (op >= ref + len)
00151                   \{
00152                     \textcolor{comment}{/* disjunct areas */}
00153                     memcpy (op, ref, len);
00154                     op += len;
00155                   \}
00156                 \textcolor{keywordflow}{else}
00157                   \{
00158                     \textcolor{comment}{/* overlapping, use octte by octte copying */}
00159                     \textcolor{keywordflow}{do}
00160                       *op++ = *ref++;
00161                     \textcolor{keywordflow}{while} (--len);
00162                   \}
00163 
00164                 \textcolor{keywordflow}{break};
00165 
00166               \textcolor{keywordflow}{case} 9: *op++ = *ref++;
00167               \textcolor{keywordflow}{case} 8: *op++ = *ref++;
00168               \textcolor{keywordflow}{case} 7: *op++ = *ref++;
00169               \textcolor{keywordflow}{case} 6: *op++ = *ref++;
00170               \textcolor{keywordflow}{case} 5: *op++ = *ref++;
00171               \textcolor{keywordflow}{case} 4: *op++ = *ref++;
00172               \textcolor{keywordflow}{case} 3: *op++ = *ref++;
00173               \textcolor{keywordflow}{case} 2: *op++ = *ref++;
00174               \textcolor{keywordflow}{case} 1: *op++ = *ref++;
00175               \textcolor{keywordflow}{case} 0: *op++ = *ref++; \textcolor{comment}{/* two octets more */}
00176                       *op++ = *ref++;
00177             \}
00178 \textcolor{preprocessor}{#}\textcolor{preprocessor}{endif}
00179         \}
00180     \}
00181   \textcolor{keywordflow}{while} (ip < in\_end);
00182 
00183   \textcolor{keywordflow}{return} op - (u8 *)out\_data;
00184 \}
\end{DoxyCode}
