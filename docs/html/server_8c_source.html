<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Redis-Quant365: src/server.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Redis-Quant365
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('server_8c_source.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">server.c</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment"> * Copyright (c) 2009-2016, Salvatore Sanfilippo &lt;antirez at gmail dot com&gt;</span></div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment"> * All rights reserved.</span></div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment"> * Redistribution and use in source and binary forms, with or without</span></div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment"> * modification, are permitted provided that the following conditions are met:</span></div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment"> *   * Redistributions of source code must retain the above copyright notice,</span></div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment"> *     this list of conditions and the following disclaimer.</span></div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment"> *   * Redistributions in binary form must reproduce the above copyright</span></div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment"> *     notice, this list of conditions and the following disclaimer in the</span></div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment"> *     documentation and/or other materials provided with the distribution.</span></div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment"> *   * Neither the name of Redis nor the names of its contributors may be used</span></div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="comment"> *     to endorse or promote products derived from this software without</span></div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="comment"> *     specific prior written permission.</span></div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="comment"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot;</span></div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="comment"> * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span></div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="comment"> * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span></div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="comment"> * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE</span></div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="comment"> * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR</span></div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="comment"> * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF</span></div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="comment"> * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS</span></div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="comment"> * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN</span></div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="comment"> * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)</span></div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="comment"> * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE</span></div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="comment"> * POSSIBILITY OF SUCH DAMAGE.</span></div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;</div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">include</span> <a class="code" href="server_8h.html">&quot;server.h&quot;</a></div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">include</span> <a class="code" href="cluster_8h.html">&quot;cluster.h&quot;</a></div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">include</span> <a class="code" href="slowlog_8h.html">&quot;slowlog.h&quot;</a></div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">include</span> <a class="code" href="bio_8h.html">&quot;bio.h&quot;</a></div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">include</span> <a class="code" href="latency_8h.html">&quot;latency.h&quot;</a></div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">include</span> <a class="code" href="atomicvar_8h.html">&quot;atomicvar.h&quot;</a></div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;</div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">include</span> <span class="preprocessor">&lt;</span><span class="preprocessor">time</span><span class="preprocessor">.</span><span class="preprocessor">h</span><span class="preprocessor">&gt;</span></div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">include</span> <span class="preprocessor">&lt;</span><span class="preprocessor">signal</span><span class="preprocessor">.</span><span class="preprocessor">h</span><span class="preprocessor">&gt;</span></div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">include</span> <span class="preprocessor">&lt;</span><span class="preprocessor">sys</span><span class="preprocessor">/</span><span class="preprocessor">wait</span><span class="preprocessor">.</span><span class="preprocessor">h</span><span class="preprocessor">&gt;</span></div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">include</span> <span class="preprocessor">&lt;</span><span class="preprocessor">errno</span><span class="preprocessor">.</span><span class="preprocessor">h</span><span class="preprocessor">&gt;</span></div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">include</span> <span class="preprocessor">&lt;</span><span class="preprocessor">assert</span><span class="preprocessor">.</span><span class="preprocessor">h</span><span class="preprocessor">&gt;</span></div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">include</span> <span class="preprocessor">&lt;</span><span class="preprocessor">ctype</span><span class="preprocessor">.</span><span class="preprocessor">h</span><span class="preprocessor">&gt;</span></div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">include</span> <span class="preprocessor">&lt;</span><span class="preprocessor">stdarg</span><span class="preprocessor">.</span><span class="preprocessor">h</span><span class="preprocessor">&gt;</span></div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">include</span> <span class="preprocessor">&lt;</span><span class="preprocessor">arpa</span><span class="preprocessor">/</span><span class="preprocessor">inet</span><span class="preprocessor">.</span><span class="preprocessor">h</span><span class="preprocessor">&gt;</span></div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">include</span> <span class="preprocessor">&lt;</span><span class="preprocessor">sys</span><span class="preprocessor">/</span><span class="preprocessor">stat</span><span class="preprocessor">.</span><span class="preprocessor">h</span><span class="preprocessor">&gt;</span></div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">include</span> <span class="preprocessor">&lt;</span><span class="preprocessor">fcntl</span><span class="preprocessor">.</span><span class="preprocessor">h</span><span class="preprocessor">&gt;</span></div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">include</span> <span class="preprocessor">&lt;</span><span class="preprocessor">sys</span><span class="preprocessor">/</span><span class="preprocessor">time</span><span class="preprocessor">.</span><span class="preprocessor">h</span><span class="preprocessor">&gt;</span></div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">include</span> <span class="preprocessor">&lt;</span><span class="preprocessor">sys</span><span class="preprocessor">/</span><span class="preprocessor">resource</span><span class="preprocessor">.</span><span class="preprocessor">h</span><span class="preprocessor">&gt;</span></div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">include</span> <span class="preprocessor">&lt;</span><span class="preprocessor">sys</span><span class="preprocessor">/</span><span class="preprocessor">uio</span><span class="preprocessor">.</span><span class="preprocessor">h</span><span class="preprocessor">&gt;</span></div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">include</span> <span class="preprocessor">&lt;</span><span class="preprocessor">sys</span><span class="preprocessor">/</span><span class="preprocessor">un</span><span class="preprocessor">.</span><span class="preprocessor">h</span><span class="preprocessor">&gt;</span></div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">include</span> <span class="preprocessor">&lt;</span><span class="preprocessor">limits</span><span class="preprocessor">.</span><span class="preprocessor">h</span><span class="preprocessor">&gt;</span></div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">include</span> <span class="preprocessor">&lt;</span><span class="keywordtype">float</span><span class="preprocessor">.</span><span class="preprocessor">h</span><span class="preprocessor">&gt;</span></div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">include</span> <span class="preprocessor">&lt;</span><span class="preprocessor">math</span><span class="preprocessor">.</span><span class="preprocessor">h</span><span class="preprocessor">&gt;</span></div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">include</span> <span class="preprocessor">&lt;</span><span class="preprocessor">sys</span><span class="preprocessor">/</span><span class="preprocessor">resource</span><span class="preprocessor">.</span><span class="preprocessor">h</span><span class="preprocessor">&gt;</span></div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">include</span> <span class="preprocessor">&lt;</span><span class="preprocessor">sys</span><span class="preprocessor">/</span><span class="preprocessor">utsname</span><span class="preprocessor">.</span><span class="preprocessor">h</span><span class="preprocessor">&gt;</span></div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">include</span> <span class="preprocessor">&lt;</span><span class="preprocessor">locale</span><span class="preprocessor">.</span><span class="preprocessor">h</span><span class="preprocessor">&gt;</span></div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">include</span> <span class="preprocessor">&lt;</span><span class="preprocessor">sys</span><span class="preprocessor">/</span><span class="preprocessor">socket</span><span class="preprocessor">.</span><span class="preprocessor">h</span><span class="preprocessor">&gt;</span></div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;</div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;<span class="comment">/* Our shared &quot;common&quot; objects */</span></div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;</div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;<span class="keyword">struct</span> <a class="code" href="structsharedObjectsStruct.html">sharedObjectsStruct</a> shared;</div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;</div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;<span class="comment">/* Global vars that are actually used as constants. The following double</span></div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;<span class="comment"> * values are used for double on-disk serialization, and are initialized</span></div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;<span class="comment"> * at runtime to avoid strange compiler optimizations. */</span></div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;</div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;<span class="keywordtype">double</span> R_Zero, R_PosInf, R_NegInf, R_Nan;</div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;</div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;<span class="comment">/*================================= Globals ================================= */</span></div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;</div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;<span class="comment">/* Global vars */</span></div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;<span class="keyword">struct</span> <a class="code" href="structredisServer.html">redisServer</a> server; <span class="comment">/* Server global state */</span></div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;<span class="keyword">volatile</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> lru_clock; <span class="comment">/* Server global current LRU time. */</span></div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;</div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;<span class="comment">/* Our command table.</span></div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;<span class="comment"> * Every entry is composed of the following fields:</span></div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;<span class="comment"> * name: a string representing the command name.</span></div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;<span class="comment"> * function: pointer to the C function implementing the command.</span></div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;<span class="comment"> * arity: number of arguments, it is possible to use -N to say &gt;= N</span></div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;<span class="comment"> * sflags: command flags as string. See below for a table of flags.</span></div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;<span class="comment"> * flags: flags as bitmask. Computed by Redis using the &#39;sflags&#39; field.</span></div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;<span class="comment"> * get_keys_proc: an optional function to get key arguments from a command.</span></div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;<span class="comment"> *                This is only used when the following three fields are not</span></div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;<span class="comment"> *                enough to specify what arguments are keys.</span></div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;<span class="comment"> * first_key_index: first argument that is a key</span></div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;<span class="comment"> * last_key_index: last argument that is a key</span></div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;<span class="comment"> * key_step: step to get all the keys from first to last argument. For instance</span></div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;<span class="comment"> *           in MSET the step is two since arguments are key,val,key,val,...</span></div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;<span class="comment"> * microseconds: microseconds of total execution time for this command.</span></div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;<span class="comment"> * calls: total number of calls of this command.</span></div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;<span class="comment"> * The flags, microseconds and calls fields are computed by Redis and should</span></div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;<span class="comment"> * always be set to zero.</span></div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;<span class="comment"> * Command flags are expressed using strings where every character represents</span></div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;<span class="comment"> * a flag. Later the populateCommandTable() function will take care of</span></div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;<span class="comment"> * populating the real &#39;flags&#39; field using this characters.</span></div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;<span class="comment"> * This is the meaning of the flags:</span></div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;<span class="comment"> * w: write command (may modify the key space).</span></div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;<span class="comment"> * r: read command  (will never modify the key space).</span></div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;<span class="comment"> * m: may increase memory usage once called. Don&#39;t allow if out of memory.</span></div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;<span class="comment"> * a: admin command, like SAVE or SHUTDOWN.</span></div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;<span class="comment"> * p: Pub/Sub related command.</span></div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;<span class="comment"> * f: force replication of this command, regardless of server.dirty.</span></div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;<span class="comment"> * s: command not allowed in scripts.</span></div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;<span class="comment"> * R: random command. Command is not deterministic, that is, the same command</span></div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;<span class="comment"> *    with the same arguments, with the same key space, may have different</span></div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;<span class="comment"> *    results. For instance SPOP and RANDOMKEY are two random commands.</span></div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;<span class="comment"> * S: Sort command output array if called from script, so that the output</span></div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;<span class="comment"> *    is deterministic.</span></div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;<span class="comment"> * l: Allow command while loading the database.</span></div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;<span class="comment"> * t: Allow command while a slave has stale data but is not allowed to</span></div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;<span class="comment"> *    server this data. Normally no command is accepted in this condition</span></div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;<span class="comment"> *    but just a few.</span></div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;<span class="comment"> * M: Do not automatically propagate the command on MONITOR.</span></div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;<span class="comment"> * k: Perform an implicit ASKING for this command, so the command will be</span></div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;<span class="comment"> *    accepted in cluster mode if the slot is marked as &#39;importing&#39;.</span></div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;<span class="comment"> * F: Fast command: O(1) or O(log(N)) command that should never delay</span></div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;<span class="comment"> *    its execution as long as the kernel scheduler is giving us time.</span></div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;<span class="comment"> *    Note that commands that may trigger a DEL as a side effect (like SET)</span></div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;<span class="comment"> *    are not fast commands.</span></div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;<span class="keyword">struct</span> <a class="code" href="structredisCommand.html">redisCommand</a> redisCommandTable[] = {</div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;    {<span class="stringliteral">&quot;module&quot;</span>,moduleCommand,-2,<span class="stringliteral">&quot;as&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;    {<span class="stringliteral">&quot;get&quot;</span>,getCommand,2,<span class="stringliteral">&quot;rF&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;    {<span class="stringliteral">&quot;set&quot;</span>,setCommand,-3,<span class="stringliteral">&quot;wm&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;    {<span class="stringliteral">&quot;setnx&quot;</span>,setnxCommand,3,<span class="stringliteral">&quot;wmF&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;    {<span class="stringliteral">&quot;setex&quot;</span>,setexCommand,4,<span class="stringliteral">&quot;wm&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;    {<span class="stringliteral">&quot;psetex&quot;</span>,psetexCommand,4,<span class="stringliteral">&quot;wm&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;    {<span class="stringliteral">&quot;append&quot;</span>,appendCommand,3,<span class="stringliteral">&quot;wm&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;    {<span class="stringliteral">&quot;strlen&quot;</span>,strlenCommand,2,<span class="stringliteral">&quot;rF&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;    {<span class="stringliteral">&quot;del&quot;</span>,delCommand,-2,<span class="stringliteral">&quot;w&quot;</span>,0,NULL,1,-1,1,0,0},</div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;    {<span class="stringliteral">&quot;unlink&quot;</span>,unlinkCommand,-2,<span class="stringliteral">&quot;wF&quot;</span>,0,NULL,1,-1,1,0,0},</div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;    {<span class="stringliteral">&quot;exists&quot;</span>,existsCommand,-2,<span class="stringliteral">&quot;rF&quot;</span>,0,NULL,1,-1,1,0,0},</div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;    {<span class="stringliteral">&quot;setbit&quot;</span>,setbitCommand,4,<span class="stringliteral">&quot;wm&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;    {<span class="stringliteral">&quot;getbit&quot;</span>,getbitCommand,3,<span class="stringliteral">&quot;rF&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;    {<span class="stringliteral">&quot;bitfield&quot;</span>,bitfieldCommand,-2,<span class="stringliteral">&quot;wm&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;    {<span class="stringliteral">&quot;setrange&quot;</span>,setrangeCommand,4,<span class="stringliteral">&quot;wm&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;    {<span class="stringliteral">&quot;getrange&quot;</span>,getrangeCommand,4,<span class="stringliteral">&quot;r&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;    {<span class="stringliteral">&quot;substr&quot;</span>,getrangeCommand,4,<span class="stringliteral">&quot;r&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;    {<span class="stringliteral">&quot;incr&quot;</span>,incrCommand,2,<span class="stringliteral">&quot;wmF&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;    {<span class="stringliteral">&quot;decr&quot;</span>,decrCommand,2,<span class="stringliteral">&quot;wmF&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;    {<span class="stringliteral">&quot;mget&quot;</span>,mgetCommand,-2,<span class="stringliteral">&quot;rF&quot;</span>,0,NULL,1,-1,1,0,0},</div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;    {<span class="stringliteral">&quot;rpush&quot;</span>,rpushCommand,-3,<span class="stringliteral">&quot;wmF&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;    {<span class="stringliteral">&quot;lpush&quot;</span>,lpushCommand,-3,<span class="stringliteral">&quot;wmF&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;    {<span class="stringliteral">&quot;rpushx&quot;</span>,rpushxCommand,-3,<span class="stringliteral">&quot;wmF&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;    {<span class="stringliteral">&quot;lpushx&quot;</span>,lpushxCommand,-3,<span class="stringliteral">&quot;wmF&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;    {<span class="stringliteral">&quot;linsert&quot;</span>,linsertCommand,5,<span class="stringliteral">&quot;wm&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;    {<span class="stringliteral">&quot;rpop&quot;</span>,rpopCommand,2,<span class="stringliteral">&quot;wF&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;    {<span class="stringliteral">&quot;lpop&quot;</span>,lpopCommand,2,<span class="stringliteral">&quot;wF&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;    {<span class="stringliteral">&quot;brpop&quot;</span>,brpopCommand,-3,<span class="stringliteral">&quot;ws&quot;</span>,0,NULL,1,-2,1,0,0},</div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;    {<span class="stringliteral">&quot;brpoplpush&quot;</span>,brpoplpushCommand,4,<span class="stringliteral">&quot;wms&quot;</span>,0,NULL,1,2,1,0,0},</div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;    {<span class="stringliteral">&quot;blpop&quot;</span>,blpopCommand,-3,<span class="stringliteral">&quot;ws&quot;</span>,0,NULL,1,-2,1,0,0},</div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;    {<span class="stringliteral">&quot;llen&quot;</span>,llenCommand,2,<span class="stringliteral">&quot;rF&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;    {<span class="stringliteral">&quot;lindex&quot;</span>,lindexCommand,3,<span class="stringliteral">&quot;r&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;    {<span class="stringliteral">&quot;lset&quot;</span>,lsetCommand,4,<span class="stringliteral">&quot;wm&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;    {<span class="stringliteral">&quot;lrange&quot;</span>,lrangeCommand,4,<span class="stringliteral">&quot;r&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;    {<span class="stringliteral">&quot;ltrim&quot;</span>,ltrimCommand,4,<span class="stringliteral">&quot;w&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;    {<span class="stringliteral">&quot;lrem&quot;</span>,lremCommand,4,<span class="stringliteral">&quot;w&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;    {<span class="stringliteral">&quot;rpoplpush&quot;</span>,rpoplpushCommand,3,<span class="stringliteral">&quot;wm&quot;</span>,0,NULL,1,2,1,0,0},</div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;    {<span class="stringliteral">&quot;sadd&quot;</span>,saddCommand,-3,<span class="stringliteral">&quot;wmF&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;    {<span class="stringliteral">&quot;srem&quot;</span>,sremCommand,-3,<span class="stringliteral">&quot;wF&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;    {<span class="stringliteral">&quot;smove&quot;</span>,smoveCommand,4,<span class="stringliteral">&quot;wF&quot;</span>,0,NULL,1,2,1,0,0},</div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;    {<span class="stringliteral">&quot;sismember&quot;</span>,sismemberCommand,3,<span class="stringliteral">&quot;rF&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;    {<span class="stringliteral">&quot;scard&quot;</span>,scardCommand,2,<span class="stringliteral">&quot;rF&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;    {<span class="stringliteral">&quot;spop&quot;</span>,spopCommand,-2,<span class="stringliteral">&quot;wRF&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;    {<span class="stringliteral">&quot;srandmember&quot;</span>,srandmemberCommand,-2,<span class="stringliteral">&quot;rR&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;    {<span class="stringliteral">&quot;sinter&quot;</span>,sinterCommand,-2,<span class="stringliteral">&quot;rS&quot;</span>,0,NULL,1,-1,1,0,0},</div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;    {<span class="stringliteral">&quot;sinterstore&quot;</span>,sinterstoreCommand,-3,<span class="stringliteral">&quot;wm&quot;</span>,0,NULL,1,-1,1,0,0},</div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;    {<span class="stringliteral">&quot;sunion&quot;</span>,sunionCommand,-2,<span class="stringliteral">&quot;rS&quot;</span>,0,NULL,1,-1,1,0,0},</div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;    {<span class="stringliteral">&quot;sunionstore&quot;</span>,sunionstoreCommand,-3,<span class="stringliteral">&quot;wm&quot;</span>,0,NULL,1,-1,1,0,0},</div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;    {<span class="stringliteral">&quot;sdiff&quot;</span>,sdiffCommand,-2,<span class="stringliteral">&quot;rS&quot;</span>,0,NULL,1,-1,1,0,0},</div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;    {<span class="stringliteral">&quot;sdiffstore&quot;</span>,sdiffstoreCommand,-3,<span class="stringliteral">&quot;wm&quot;</span>,0,NULL,1,-1,1,0,0},</div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;    {<span class="stringliteral">&quot;smembers&quot;</span>,sinterCommand,2,<span class="stringliteral">&quot;rS&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;    {<span class="stringliteral">&quot;sscan&quot;</span>,sscanCommand,-3,<span class="stringliteral">&quot;rR&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;    {<span class="stringliteral">&quot;zadd&quot;</span>,zaddCommand,-4,<span class="stringliteral">&quot;wmF&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;    {<span class="stringliteral">&quot;zincrby&quot;</span>,zincrbyCommand,4,<span class="stringliteral">&quot;wmF&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;    {<span class="stringliteral">&quot;zrem&quot;</span>,zremCommand,-3,<span class="stringliteral">&quot;wF&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;    {<span class="stringliteral">&quot;zremrangebyscore&quot;</span>,zremrangebyscoreCommand,4,<span class="stringliteral">&quot;w&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;    {<span class="stringliteral">&quot;zremrangebyrank&quot;</span>,zremrangebyrankCommand,4,<span class="stringliteral">&quot;w&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;    {<span class="stringliteral">&quot;zremrangebylex&quot;</span>,zremrangebylexCommand,4,<span class="stringliteral">&quot;w&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;    {<span class="stringliteral">&quot;zunionstore&quot;</span>,zunionstoreCommand,-4,<span class="stringliteral">&quot;wm&quot;</span>,0,zunionInterGetKeys,0,0,0,0,0},</div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;    {<span class="stringliteral">&quot;zinterstore&quot;</span>,zinterstoreCommand,-4,<span class="stringliteral">&quot;wm&quot;</span>,0,zunionInterGetKeys,0,0,0,0,0},</div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;    {<span class="stringliteral">&quot;zrange&quot;</span>,zrangeCommand,-4,<span class="stringliteral">&quot;r&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;    {<span class="stringliteral">&quot;zrangebyscore&quot;</span>,zrangebyscoreCommand,-4,<span class="stringliteral">&quot;r&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;    {<span class="stringliteral">&quot;zrevrangebyscore&quot;</span>,zrevrangebyscoreCommand,-4,<span class="stringliteral">&quot;r&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;    {<span class="stringliteral">&quot;zrangebylex&quot;</span>,zrangebylexCommand,-4,<span class="stringliteral">&quot;r&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;    {<span class="stringliteral">&quot;zrevrangebylex&quot;</span>,zrevrangebylexCommand,-4,<span class="stringliteral">&quot;r&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;    {<span class="stringliteral">&quot;zcount&quot;</span>,zcountCommand,4,<span class="stringliteral">&quot;rF&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;    {<span class="stringliteral">&quot;zlexcount&quot;</span>,zlexcountCommand,4,<span class="stringliteral">&quot;rF&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;    {<span class="stringliteral">&quot;zrevrange&quot;</span>,zrevrangeCommand,-4,<span class="stringliteral">&quot;r&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;    {<span class="stringliteral">&quot;zcard&quot;</span>,zcardCommand,2,<span class="stringliteral">&quot;rF&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;    {<span class="stringliteral">&quot;zscore&quot;</span>,zscoreCommand,3,<span class="stringliteral">&quot;rF&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;    {<span class="stringliteral">&quot;zrank&quot;</span>,zrankCommand,3,<span class="stringliteral">&quot;rF&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;    {<span class="stringliteral">&quot;zrevrank&quot;</span>,zrevrankCommand,3,<span class="stringliteral">&quot;rF&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;    {<span class="stringliteral">&quot;zscan&quot;</span>,zscanCommand,-3,<span class="stringliteral">&quot;rR&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;    {<span class="stringliteral">&quot;hset&quot;</span>,hsetCommand,-4,<span class="stringliteral">&quot;wmF&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;    {<span class="stringliteral">&quot;hsetnx&quot;</span>,hsetnxCommand,4,<span class="stringliteral">&quot;wmF&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;    {<span class="stringliteral">&quot;hget&quot;</span>,hgetCommand,3,<span class="stringliteral">&quot;rF&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;    {<span class="stringliteral">&quot;hmset&quot;</span>,hsetCommand,-4,<span class="stringliteral">&quot;wmF&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;    {<span class="stringliteral">&quot;hmget&quot;</span>,hmgetCommand,-3,<span class="stringliteral">&quot;rF&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;    {<span class="stringliteral">&quot;hincrby&quot;</span>,hincrbyCommand,4,<span class="stringliteral">&quot;wmF&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;    {<span class="stringliteral">&quot;hincrbyfloat&quot;</span>,hincrbyfloatCommand,4,<span class="stringliteral">&quot;wmF&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;    {<span class="stringliteral">&quot;hdel&quot;</span>,hdelCommand,-3,<span class="stringliteral">&quot;wF&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;    {<span class="stringliteral">&quot;hlen&quot;</span>,hlenCommand,2,<span class="stringliteral">&quot;rF&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;    {<span class="stringliteral">&quot;hstrlen&quot;</span>,hstrlenCommand,3,<span class="stringliteral">&quot;rF&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;    {<span class="stringliteral">&quot;hkeys&quot;</span>,hkeysCommand,2,<span class="stringliteral">&quot;rS&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;    {<span class="stringliteral">&quot;hvals&quot;</span>,hvalsCommand,2,<span class="stringliteral">&quot;rS&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;    {<span class="stringliteral">&quot;hgetall&quot;</span>,hgetallCommand,2,<span class="stringliteral">&quot;r&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;    {<span class="stringliteral">&quot;hexists&quot;</span>,hexistsCommand,3,<span class="stringliteral">&quot;rF&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;    {<span class="stringliteral">&quot;hscan&quot;</span>,hscanCommand,-3,<span class="stringliteral">&quot;rR&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;    {<span class="stringliteral">&quot;incrby&quot;</span>,incrbyCommand,3,<span class="stringliteral">&quot;wmF&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;    {<span class="stringliteral">&quot;decrby&quot;</span>,decrbyCommand,3,<span class="stringliteral">&quot;wmF&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;    {<span class="stringliteral">&quot;incrbyfloat&quot;</span>,incrbyfloatCommand,3,<span class="stringliteral">&quot;wmF&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;    {<span class="stringliteral">&quot;getset&quot;</span>,getsetCommand,3,<span class="stringliteral">&quot;wm&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;    {<span class="stringliteral">&quot;mset&quot;</span>,msetCommand,-3,<span class="stringliteral">&quot;wm&quot;</span>,0,NULL,1,-1,2,0,0},</div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;    {<span class="stringliteral">&quot;msetnx&quot;</span>,msetnxCommand,-3,<span class="stringliteral">&quot;wm&quot;</span>,0,NULL,1,-1,2,0,0},</div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;    {<span class="stringliteral">&quot;randomkey&quot;</span>,randomkeyCommand,1,<span class="stringliteral">&quot;rR&quot;</span>,0,NULL,0,0,0,0,0},</div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;    {<span class="stringliteral">&quot;select&quot;</span>,selectCommand,2,<span class="stringliteral">&quot;lF&quot;</span>,0,NULL,0,0,0,0,0},</div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;    {<span class="stringliteral">&quot;swapdb&quot;</span>,swapdbCommand,3,<span class="stringliteral">&quot;wF&quot;</span>,0,NULL,0,0,0,0,0},</div><div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;    {<span class="stringliteral">&quot;move&quot;</span>,moveCommand,3,<span class="stringliteral">&quot;wF&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;    {<span class="stringliteral">&quot;rename&quot;</span>,renameCommand,3,<span class="stringliteral">&quot;w&quot;</span>,0,NULL,1,2,1,0,0},</div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;    {<span class="stringliteral">&quot;renamenx&quot;</span>,renamenxCommand,3,<span class="stringliteral">&quot;wF&quot;</span>,0,NULL,1,2,1,0,0},</div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;    {<span class="stringliteral">&quot;expire&quot;</span>,expireCommand,3,<span class="stringliteral">&quot;wF&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;    {<span class="stringliteral">&quot;expireat&quot;</span>,expireatCommand,3,<span class="stringliteral">&quot;wF&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;    {<span class="stringliteral">&quot;pexpire&quot;</span>,pexpireCommand,3,<span class="stringliteral">&quot;wF&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;    {<span class="stringliteral">&quot;pexpireat&quot;</span>,pexpireatCommand,3,<span class="stringliteral">&quot;wF&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;    {<span class="stringliteral">&quot;keys&quot;</span>,keysCommand,2,<span class="stringliteral">&quot;rS&quot;</span>,0,NULL,0,0,0,0,0},</div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;    {<span class="stringliteral">&quot;scan&quot;</span>,scanCommand,-2,<span class="stringliteral">&quot;rR&quot;</span>,0,NULL,0,0,0,0,0},</div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;    {<span class="stringliteral">&quot;dbsize&quot;</span>,dbsizeCommand,1,<span class="stringliteral">&quot;rF&quot;</span>,0,NULL,0,0,0,0,0},</div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;    {<span class="stringliteral">&quot;auth&quot;</span>,authCommand,2,<span class="stringliteral">&quot;sltF&quot;</span>,0,NULL,0,0,0,0,0},</div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;    {<span class="stringliteral">&quot;ping&quot;</span>,pingCommand,-1,<span class="stringliteral">&quot;tF&quot;</span>,0,NULL,0,0,0,0,0},</div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;    {<span class="stringliteral">&quot;echo&quot;</span>,echoCommand,2,<span class="stringliteral">&quot;F&quot;</span>,0,NULL,0,0,0,0,0},</div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;    {<span class="stringliteral">&quot;save&quot;</span>,saveCommand,1,<span class="stringliteral">&quot;as&quot;</span>,0,NULL,0,0,0,0,0},</div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;    {<span class="stringliteral">&quot;bgsave&quot;</span>,bgsaveCommand,-1,<span class="stringliteral">&quot;a&quot;</span>,0,NULL,0,0,0,0,0},</div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;    {<span class="stringliteral">&quot;bgrewriteaof&quot;</span>,bgrewriteaofCommand,1,<span class="stringliteral">&quot;a&quot;</span>,0,NULL,0,0,0,0,0},</div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;    {<span class="stringliteral">&quot;shutdown&quot;</span>,shutdownCommand,-1,<span class="stringliteral">&quot;alt&quot;</span>,0,NULL,0,0,0,0,0},</div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;    {<span class="stringliteral">&quot;lastsave&quot;</span>,lastsaveCommand,1,<span class="stringliteral">&quot;RF&quot;</span>,0,NULL,0,0,0,0,0},</div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;    {<span class="stringliteral">&quot;type&quot;</span>,typeCommand,2,<span class="stringliteral">&quot;rF&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;    {<span class="stringliteral">&quot;multi&quot;</span>,multiCommand,1,<span class="stringliteral">&quot;sF&quot;</span>,0,NULL,0,0,0,0,0},</div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;    {<span class="stringliteral">&quot;exec&quot;</span>,execCommand,1,<span class="stringliteral">&quot;sM&quot;</span>,0,NULL,0,0,0,0,0},</div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;    {<span class="stringliteral">&quot;discard&quot;</span>,discardCommand,1,<span class="stringliteral">&quot;sF&quot;</span>,0,NULL,0,0,0,0,0},</div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;    {<span class="stringliteral">&quot;sync&quot;</span>,syncCommand,1,<span class="stringliteral">&quot;ars&quot;</span>,0,NULL,0,0,0,0,0},</div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;    {<span class="stringliteral">&quot;psync&quot;</span>,syncCommand,3,<span class="stringliteral">&quot;ars&quot;</span>,0,NULL,0,0,0,0,0},</div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;    {<span class="stringliteral">&quot;replconf&quot;</span>,replconfCommand,-1,<span class="stringliteral">&quot;aslt&quot;</span>,0,NULL,0,0,0,0,0},</div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;    {<span class="stringliteral">&quot;flushdb&quot;</span>,flushdbCommand,-1,<span class="stringliteral">&quot;w&quot;</span>,0,NULL,0,0,0,0,0},</div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;    {<span class="stringliteral">&quot;flushall&quot;</span>,flushallCommand,-1,<span class="stringliteral">&quot;w&quot;</span>,0,NULL,0,0,0,0,0},</div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;    {<span class="stringliteral">&quot;sort&quot;</span>,sortCommand,-2,<span class="stringliteral">&quot;wm&quot;</span>,0,sortGetKeys,1,1,1,0,0},</div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;    {<span class="stringliteral">&quot;info&quot;</span>,infoCommand,-1,<span class="stringliteral">&quot;lt&quot;</span>,0,NULL,0,0,0,0,0},</div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;    {<span class="stringliteral">&quot;monitor&quot;</span>,monitorCommand,1,<span class="stringliteral">&quot;as&quot;</span>,0,NULL,0,0,0,0,0},</div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;    {<span class="stringliteral">&quot;ttl&quot;</span>,ttlCommand,2,<span class="stringliteral">&quot;rF&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;    {<span class="stringliteral">&quot;touch&quot;</span>,touchCommand,-2,<span class="stringliteral">&quot;rF&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;    {<span class="stringliteral">&quot;pttl&quot;</span>,pttlCommand,2,<span class="stringliteral">&quot;rF&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;    {<span class="stringliteral">&quot;persist&quot;</span>,persistCommand,2,<span class="stringliteral">&quot;wF&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;    {<span class="stringliteral">&quot;slaveof&quot;</span>,slaveofCommand,3,<span class="stringliteral">&quot;ast&quot;</span>,0,NULL,0,0,0,0,0},</div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;    {<span class="stringliteral">&quot;role&quot;</span>,roleCommand,1,<span class="stringliteral">&quot;lst&quot;</span>,0,NULL,0,0,0,0,0},</div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;    {<span class="stringliteral">&quot;debug&quot;</span>,debugCommand,-2,<span class="stringliteral">&quot;as&quot;</span>,0,NULL,0,0,0,0,0},</div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;    {<span class="stringliteral">&quot;config&quot;</span>,configCommand,-2,<span class="stringliteral">&quot;lat&quot;</span>,0,NULL,0,0,0,0,0},</div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;    {<span class="stringliteral">&quot;subscribe&quot;</span>,subscribeCommand,-2,<span class="stringliteral">&quot;pslt&quot;</span>,0,NULL,0,0,0,0,0},</div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;    {<span class="stringliteral">&quot;unsubscribe&quot;</span>,unsubscribeCommand,-1,<span class="stringliteral">&quot;pslt&quot;</span>,0,NULL,0,0,0,0,0},</div><div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;    {<span class="stringliteral">&quot;psubscribe&quot;</span>,psubscribeCommand,-2,<span class="stringliteral">&quot;pslt&quot;</span>,0,NULL,0,0,0,0,0},</div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;    {<span class="stringliteral">&quot;punsubscribe&quot;</span>,punsubscribeCommand,-1,<span class="stringliteral">&quot;pslt&quot;</span>,0,NULL,0,0,0,0,0},</div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;    {<span class="stringliteral">&quot;publish&quot;</span>,publishCommand,3,<span class="stringliteral">&quot;pltF&quot;</span>,0,NULL,0,0,0,0,0},</div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;    {<span class="stringliteral">&quot;pubsub&quot;</span>,pubsubCommand,-2,<span class="stringliteral">&quot;pltR&quot;</span>,0,NULL,0,0,0,0,0},</div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;    {<span class="stringliteral">&quot;watch&quot;</span>,watchCommand,-2,<span class="stringliteral">&quot;sF&quot;</span>,0,NULL,1,-1,1,0,0},</div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;    {<span class="stringliteral">&quot;unwatch&quot;</span>,unwatchCommand,1,<span class="stringliteral">&quot;sF&quot;</span>,0,NULL,0,0,0,0,0},</div><div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;    {<span class="stringliteral">&quot;cluster&quot;</span>,clusterCommand,-2,<span class="stringliteral">&quot;a&quot;</span>,0,NULL,0,0,0,0,0},</div><div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;    {<span class="stringliteral">&quot;restore&quot;</span>,restoreCommand,-4,<span class="stringliteral">&quot;wm&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;    {<span class="stringliteral">&quot;restore-asking&quot;</span>,restoreCommand,-4,<span class="stringliteral">&quot;wmk&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;    {<span class="stringliteral">&quot;migrate&quot;</span>,migrateCommand,-6,<span class="stringliteral">&quot;w&quot;</span>,0,migrateGetKeys,0,0,0,0,0},</div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;    {<span class="stringliteral">&quot;asking&quot;</span>,askingCommand,1,<span class="stringliteral">&quot;F&quot;</span>,0,NULL,0,0,0,0,0},</div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;    {<span class="stringliteral">&quot;readonly&quot;</span>,readonlyCommand,1,<span class="stringliteral">&quot;F&quot;</span>,0,NULL,0,0,0,0,0},</div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;    {<span class="stringliteral">&quot;readwrite&quot;</span>,readwriteCommand,1,<span class="stringliteral">&quot;F&quot;</span>,0,NULL,0,0,0,0,0},</div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;    {<span class="stringliteral">&quot;dump&quot;</span>,dumpCommand,2,<span class="stringliteral">&quot;r&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;    {<span class="stringliteral">&quot;object&quot;</span>,objectCommand,-2,<span class="stringliteral">&quot;r&quot;</span>,0,NULL,2,2,2,0,0},</div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;    {<span class="stringliteral">&quot;memory&quot;</span>,memoryCommand,-2,<span class="stringliteral">&quot;r&quot;</span>,0,NULL,0,0,0,0,0},</div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;    {<span class="stringliteral">&quot;client&quot;</span>,clientCommand,-2,<span class="stringliteral">&quot;as&quot;</span>,0,NULL,0,0,0,0,0},</div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;    {<span class="stringliteral">&quot;eval&quot;</span>,evalCommand,-3,<span class="stringliteral">&quot;s&quot;</span>,0,evalGetKeys,0,0,0,0,0},</div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;    {<span class="stringliteral">&quot;evalsha&quot;</span>,evalShaCommand,-3,<span class="stringliteral">&quot;s&quot;</span>,0,evalGetKeys,0,0,0,0,0},</div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;    {<span class="stringliteral">&quot;slowlog&quot;</span>,slowlogCommand,-2,<span class="stringliteral">&quot;a&quot;</span>,0,NULL,0,0,0,0,0},</div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;    {<span class="stringliteral">&quot;script&quot;</span>,scriptCommand,-2,<span class="stringliteral">&quot;s&quot;</span>,0,NULL,0,0,0,0,0},</div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;    {<span class="stringliteral">&quot;time&quot;</span>,timeCommand,1,<span class="stringliteral">&quot;RF&quot;</span>,0,NULL,0,0,0,0,0},</div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;    {<span class="stringliteral">&quot;bitop&quot;</span>,bitopCommand,-4,<span class="stringliteral">&quot;wm&quot;</span>,0,NULL,2,-1,1,0,0},</div><div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;    {<span class="stringliteral">&quot;bitcount&quot;</span>,bitcountCommand,-2,<span class="stringliteral">&quot;r&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;    {<span class="stringliteral">&quot;bitpos&quot;</span>,bitposCommand,-3,<span class="stringliteral">&quot;r&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;    {<span class="stringliteral">&quot;wait&quot;</span>,waitCommand,3,<span class="stringliteral">&quot;s&quot;</span>,0,NULL,0,0,0,0,0},</div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;    {<span class="stringliteral">&quot;command&quot;</span>,commandCommand,0,<span class="stringliteral">&quot;lt&quot;</span>,0,NULL,0,0,0,0,0},</div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;    {<span class="stringliteral">&quot;geoadd&quot;</span>,geoaddCommand,-5,<span class="stringliteral">&quot;wm&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;    {<span class="stringliteral">&quot;georadius&quot;</span>,georadiusCommand,-6,<span class="stringliteral">&quot;w&quot;</span>,0,georadiusGetKeys,1,1,1,0,0},</div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;    {<span class="stringliteral">&quot;georadius_ro&quot;</span>,georadiusroCommand,-6,<span class="stringliteral">&quot;r&quot;</span>,0,georadiusGetKeys,1,1,1,0,0},</div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;    {<span class="stringliteral">&quot;georadiusbymember&quot;</span>,georadiusbymemberCommand,-5,<span class="stringliteral">&quot;w&quot;</span>,0,georadiusGetKeys,1,1,1,0,0},</div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;    {<span class="stringliteral">&quot;georadiusbymember_ro&quot;</span>,georadiusbymemberroCommand,-5,<span class="stringliteral">&quot;r&quot;</span>,0,georadiusGetKeys,1,1,1,0,0},</div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;    {<span class="stringliteral">&quot;geohash&quot;</span>,geohashCommand,-2,<span class="stringliteral">&quot;r&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;    {<span class="stringliteral">&quot;geopos&quot;</span>,geoposCommand,-2,<span class="stringliteral">&quot;r&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;    {<span class="stringliteral">&quot;geodist&quot;</span>,geodistCommand,-4,<span class="stringliteral">&quot;r&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;    {<span class="stringliteral">&quot;pfselftest&quot;</span>,pfselftestCommand,1,<span class="stringliteral">&quot;a&quot;</span>,0,NULL,0,0,0,0,0},</div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;    {<span class="stringliteral">&quot;pfadd&quot;</span>,pfaddCommand,-2,<span class="stringliteral">&quot;wmF&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;    {<span class="stringliteral">&quot;pfcount&quot;</span>,pfcountCommand,-2,<span class="stringliteral">&quot;r&quot;</span>,0,NULL,1,-1,1,0,0},</div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;    {<span class="stringliteral">&quot;pfmerge&quot;</span>,pfmergeCommand,-2,<span class="stringliteral">&quot;wm&quot;</span>,0,NULL,1,-1,1,0,0},</div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;    {<span class="stringliteral">&quot;pfdebug&quot;</span>,pfdebugCommand,-3,<span class="stringliteral">&quot;w&quot;</span>,0,NULL,0,0,0,0,0},</div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;    {<span class="stringliteral">&quot;xadd&quot;</span>,xaddCommand,-5,<span class="stringliteral">&quot;wmF&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;    {<span class="stringliteral">&quot;xrange&quot;</span>,xrangeCommand,-4,<span class="stringliteral">&quot;r&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;    {<span class="stringliteral">&quot;xrevrange&quot;</span>,xrevrangeCommand,-4,<span class="stringliteral">&quot;r&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;    {<span class="stringliteral">&quot;xlen&quot;</span>,xlenCommand,2,<span class="stringliteral">&quot;rF&quot;</span>,0,NULL,1,1,1,0,0},</div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;    {<span class="stringliteral">&quot;xread&quot;</span>,xreadCommand,-3,<span class="stringliteral">&quot;rs&quot;</span>,0,xreadGetKeys,1,1,1,0,0},</div><div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;    {<span class="stringliteral">&quot;post&quot;</span>,securityWarningCommand,-1,<span class="stringliteral">&quot;lt&quot;</span>,0,NULL,0,0,0,0,0},</div><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;    {<span class="stringliteral">&quot;host:&quot;</span>,securityWarningCommand,-1,<span class="stringliteral">&quot;lt&quot;</span>,0,NULL,0,0,0,0,0},</div><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;    {<span class="stringliteral">&quot;latency&quot;</span>,latencyCommand,-2,<span class="stringliteral">&quot;aslt&quot;</span>,0,NULL,0,0,0,0,0}</div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;};</div><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;</div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;<span class="comment">/*============================ Utility functions ============================ */</span></div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;</div><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;<span class="comment">/* Low level logging. To use only for very big messages, otherwise</span></div><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;<span class="comment"> * serverLog() is to prefer. */</span></div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;<span class="keywordtype">void</span> serverLogRaw(<span class="keywordtype">int</span> level, <span class="keyword">const</span> <span class="keywordtype">char</span> *msg) {</div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">int</span> syslogLevelMap[] = { LOG_DEBUG, LOG_INFO, LOG_NOTICE, LOG_WARNING };</div><div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">char</span> *c = <span class="stringliteral">&quot;.-*#&quot;</span>;</div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;    FILE *fp;</div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;    <span class="keywordtype">char</span> buf[64];</div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;    <span class="keywordtype">int</span> rawmode = (level &amp; <a class="code" href="server_8h.html#a6b3768a4d2dfb3ac580b8d999baa9350">LL_RAW</a>);</div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;    <span class="keywordtype">int</span> log_to_stdout = server.logfile[0] == <span class="stringliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;</div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;    level &amp;= 0xff; <span class="comment">/* clear flags */</span></div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;    <span class="keywordflow">if</span> (level &lt; server.verbosity) <span class="keywordflow">return</span>;</div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;</div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;    fp = log_to_stdout ? stdout : fopen(server.logfile,<span class="stringliteral">&quot;a&quot;</span>);</div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;    <span class="keywordflow">if</span> (!fp) <span class="keywordflow">return</span>;</div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;</div><div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;    <span class="keywordflow">if</span> (rawmode) {</div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;        fprintf(fp,<span class="stringliteral">&quot;%s&quot;</span>,msg);</div><div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;        <span class="keywordtype">int</span> off;</div><div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;        <span class="keyword">struct</span> timeval tv;</div><div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;        <span class="keywordtype">int</span> role_char;</div><div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;        pid_t pid = getpid();</div><div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;</div><div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;        gettimeofday(&amp;tv,NULL);</div><div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;        off = strftime(buf,<span class="keyword">sizeof</span>(buf),<span class="stringliteral">&quot;%d %b %H:%M:%S.&quot;</span>,localtime(&amp;tv.tv_sec));</div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;        snprintf(buf+off,<span class="keyword">sizeof</span>(buf)-off,<span class="stringliteral">&quot;%03d&quot;</span>,(<span class="keywordtype">int</span>)tv.tv_usec/1000);</div><div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;        <span class="keywordflow">if</span> (server.sentinel_mode) {</div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;            role_char = <span class="stringliteral">&#39;X&#39;</span>; <span class="comment">/* Sentinel. */</span></div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pid != server.pid) {</div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;            role_char = <span class="stringliteral">&#39;C&#39;</span>; <span class="comment">/* RDB / AOF writing child. */</span></div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;        } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;            role_char = (server.masterhost ? <span class="stringliteral">&#39;S&#39;</span>:<span class="stringliteral">&#39;M&#39;</span>); <span class="comment">/* Slave or Master. */</span></div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;        }</div><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;        fprintf(fp,<span class="stringliteral">&quot;%d:%c %s %c %s\n&quot;</span>,</div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;            (<span class="keywordtype">int</span>)getpid(),role_char, buf,c[level],msg);</div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;    }</div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;    fflush(fp);</div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;</div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;    <span class="keywordflow">if</span> (!log_to_stdout) fclose(fp);</div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;    <span class="keywordflow">if</span> (server.syslog_enabled) syslog(syslogLevelMap[level], <span class="stringliteral">&quot;%s&quot;</span>, msg);</div><div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;}</div><div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;</div><div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;<span class="comment">/* Like serverLogRaw() but with printf-alike support. This is the function that</span></div><div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;<span class="comment"> * is used across the code. The raw version is only used in order to dump</span></div><div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;<span class="comment"> * the INFO output on crash. */</span></div><div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;<span class="keywordtype">void</span> serverLog(<span class="keywordtype">int</span> level, <span class="keyword">const</span> <span class="keywordtype">char</span> *fmt, ...) {</div><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;    va_list ap;</div><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;    <span class="keywordtype">char</span> msg[<a class="code" href="server_8h.html#a37cd05cbfd7fb52ad21d3a822cff2ee6">LOG_MAX_LEN</a>];</div><div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;</div><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;    <span class="keywordflow">if</span> ((level&amp;0xff) &lt; server.verbosity) <span class="keywordflow">return</span>;</div><div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;</div><div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;    va_start(ap, fmt);</div><div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;    vsnprintf(msg, <span class="keyword">sizeof</span>(msg), fmt, ap);</div><div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;    va_end(ap);</div><div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;</div><div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;    serverLogRaw(level,msg);</div><div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;}</div><div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;</div><div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;<span class="comment">/* Log a fixed message without printf-alike capabilities, in a way that is</span></div><div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;<span class="comment"> * safe to call from a signal handler.</span></div><div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;<span class="comment"> * We actually use this only for signals that are not fatal from the point</span></div><div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;<span class="comment"> * of view of Redis. Signals that are going to kill the server anyway and</span></div><div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;<span class="comment"> * where we need printf-alike features are served by serverLog(). */</span></div><div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;<span class="keywordtype">void</span> serverLogFromHandler(<span class="keywordtype">int</span> level, <span class="keyword">const</span> <span class="keywordtype">char</span> *msg) {</div><div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;    <span class="keywordtype">int</span> fd;</div><div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;    <span class="keywordtype">int</span> log_to_stdout = server.logfile[0] == <span class="stringliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;    <span class="keywordtype">char</span> buf[64];</div><div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;</div><div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;    <span class="keywordflow">if</span> ((level&amp;0xff) &lt; server.verbosity || (log_to_stdout &amp;&amp; server.daemonize))</div><div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;    fd = log_to_stdout ? STDOUT_FILENO :</div><div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;                         open(server.logfile, O_APPEND|O_CREAT|O_WRONLY, 0644);</div><div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;    <span class="keywordflow">if</span> (fd == -1) <span class="keywordflow">return</span>;</div><div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;    ll2string(buf,<span class="keyword">sizeof</span>(buf),getpid());</div><div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;    <span class="keywordflow">if</span> (write(fd,buf,strlen(buf)) == -1) <span class="keywordflow">goto</span> err;</div><div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;    <span class="keywordflow">if</span> (write(fd,<span class="stringliteral">&quot;:signal-handler (&quot;</span>,17) == -1) <span class="keywordflow">goto</span> err;</div><div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;    ll2string(buf,<span class="keyword">sizeof</span>(buf),time(NULL));</div><div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;    <span class="keywordflow">if</span> (write(fd,buf,strlen(buf)) == -1) <span class="keywordflow">goto</span> err;</div><div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;    <span class="keywordflow">if</span> (write(fd,<span class="stringliteral">&quot;) &quot;</span>,2) == -1) <span class="keywordflow">goto</span> err;</div><div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;    <span class="keywordflow">if</span> (write(fd,msg,strlen(msg)) == -1) <span class="keywordflow">goto</span> err;</div><div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;    <span class="keywordflow">if</span> (write(fd,<span class="stringliteral">&quot;\n&quot;</span>,1) == -1) <span class="keywordflow">goto</span> err;</div><div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;err:</div><div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;    <span class="keywordflow">if</span> (!log_to_stdout) close(fd);</div><div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;}</div><div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;</div><div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;<span class="comment">/* Return the UNIX time in microseconds */</span></div><div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;<span class="keywordtype">long</span> <span class="keywordtype">long</span> ustime(<span class="keywordtype">void</span>) {</div><div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;    <span class="keyword">struct</span> timeval tv;</div><div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;    <span class="keywordtype">long</span> <span class="keywordtype">long</span> ust;</div><div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;</div><div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;    gettimeofday(&amp;tv, NULL);</div><div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;    ust = ((<span class="keywordtype">long</span> <span class="keywordtype">long</span>)tv.tv_sec)*1000000;</div><div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;    ust += tv.tv_usec;</div><div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;    <span class="keywordflow">return</span> ust;</div><div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;}</div><div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;</div><div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;<span class="comment">/* Return the UNIX time in milliseconds */</span></div><div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;mstime_t mstime(<span class="keywordtype">void</span>) {</div><div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;    <span class="keywordflow">return</span> ustime()/1000;</div><div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;}</div><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;</div><div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;<span class="comment">/* After an RDB dump or AOF rewrite we exit from children using _exit() instead of</span></div><div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;<span class="comment"> * exit(), because the latter may interact with the same file objects used by</span></div><div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;<span class="comment"> * the parent process. However if we are testing the coverage normal exit() is</span></div><div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;<span class="comment"> * used in order to obtain the right coverage information. */</span></div><div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;<span class="keywordtype">void</span> exitFromChild(<span class="keywordtype">int</span> retcode) {</div><div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">ifdef</span> <span class="preprocessor">COVERAGE_TEST</span></div><div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;    exit(retcode);</div><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">else</span></div><div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;    _exit(retcode);</div><div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">endif</span></div><div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;}</div><div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;</div><div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;<span class="comment">/*====================== Hash table type implementation  ==================== */</span></div><div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;</div><div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;<span class="comment">/* This is a hash table type that uses the SDS dynamic strings library as</span></div><div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;<span class="comment"> * keys and redis objects as values (objects can hold SDS strings,</span></div><div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;<span class="comment"> * lists, sets). */</span></div><div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;</div><div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;<span class="keywordtype">void</span> dictVanillaFree(<span class="keywordtype">void</span> *privdata, <span class="keywordtype">void</span> *val)</div><div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;{</div><div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;    <a class="code" href="dict_8h.html#aa077e877a37a7dc65056290a2c9760da">DICT_NOTUSED</a>(privdata);</div><div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;    zfree(val);</div><div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;}</div><div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;</div><div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;<span class="keywordtype">void</span> dictListDestructor(<span class="keywordtype">void</span> *privdata, <span class="keywordtype">void</span> *val)</div><div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;{</div><div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;    <a class="code" href="dict_8h.html#aa077e877a37a7dc65056290a2c9760da">DICT_NOTUSED</a>(privdata);</div><div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;    listRelease((list*)val);</div><div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;}</div><div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;</div><div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;<span class="keywordtype">int</span> dictSdsKeyCompare(<span class="keywordtype">void</span> *privdata, <span class="keyword">const</span> <span class="keywordtype">void</span> *key1,</div><div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;        <span class="keyword">const</span> <span class="keywordtype">void</span> *key2)</div><div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;{</div><div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;    <span class="keywordtype">int</span> l1,l2;</div><div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;    <a class="code" href="dict_8h.html#aa077e877a37a7dc65056290a2c9760da">DICT_NOTUSED</a>(privdata);</div><div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;</div><div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;    l1 = sdslen((sds)key1);</div><div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;    l2 = sdslen((sds)key2);</div><div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;    <span class="keywordflow">if</span> (l1 != l2) <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;    <span class="keywordflow">return</span> memcmp(key1, key2, l1) == 0;</div><div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;}</div><div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;</div><div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;<span class="comment">/* A case insensitive version used for the command lookup table and other</span></div><div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;<span class="comment"> * places where case insensitive non binary-safe comparison is needed. */</span></div><div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;<span class="keywordtype">int</span> dictSdsKeyCaseCompare(<span class="keywordtype">void</span> *privdata, <span class="keyword">const</span> <span class="keywordtype">void</span> *key1,</div><div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;        <span class="keyword">const</span> <span class="keywordtype">void</span> *key2)</div><div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;{</div><div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;    <a class="code" href="dict_8h.html#aa077e877a37a7dc65056290a2c9760da">DICT_NOTUSED</a>(privdata);</div><div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;</div><div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;    <span class="keywordflow">return</span> strcasecmp(key1, key2) == 0;</div><div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;}</div><div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;</div><div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;<span class="keywordtype">void</span> dictObjectDestructor(<span class="keywordtype">void</span> *privdata, <span class="keywordtype">void</span> *val)</div><div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;{</div><div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;    <a class="code" href="dict_8h.html#aa077e877a37a7dc65056290a2c9760da">DICT_NOTUSED</a>(privdata);</div><div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;</div><div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;    <span class="keywordflow">if</span> (val == NULL) <span class="keywordflow">return</span>; <span class="comment">/* Lazy freeing will set value to NULL. */</span></div><div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;    decrRefCount(val);</div><div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;}</div><div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;</div><div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;<span class="keywordtype">void</span> dictSdsDestructor(<span class="keywordtype">void</span> *privdata, <span class="keywordtype">void</span> *val)</div><div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;{</div><div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;    <a class="code" href="dict_8h.html#aa077e877a37a7dc65056290a2c9760da">DICT_NOTUSED</a>(privdata);</div><div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;</div><div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;    sdsfree(val);</div><div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;}</div><div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;</div><div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;<span class="keywordtype">int</span> dictObjKeyCompare(<span class="keywordtype">void</span> *privdata, <span class="keyword">const</span> <span class="keywordtype">void</span> *key1,</div><div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;        <span class="keyword">const</span> <span class="keywordtype">void</span> *key2)</div><div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;{</div><div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;    <span class="keyword">const</span> robj *o1 = key1, *o2 = key2;</div><div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;    <span class="keywordflow">return</span> dictSdsKeyCompare(privdata,o1-&gt;ptr,o2-&gt;ptr);</div><div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;}</div><div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;</div><div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;uint64_t dictObjHash(<span class="keyword">const</span> <span class="keywordtype">void</span> *key) {</div><div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;    <span class="keyword">const</span> robj *o = key;</div><div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;    <span class="keywordflow">return</span> dictGenHashFunction(o-&gt;ptr, sdslen((sds)o-&gt;ptr));</div><div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;}</div><div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;</div><div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;uint64_t dictSdsHash(<span class="keyword">const</span> <span class="keywordtype">void</span> *key) {</div><div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;    <span class="keywordflow">return</span> dictGenHashFunction((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)key, sdslen((<span class="keywordtype">char</span>*)key));</div><div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;}</div><div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;</div><div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;uint64_t dictSdsCaseHash(<span class="keyword">const</span> <span class="keywordtype">void</span> *key) {</div><div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;    <span class="keywordflow">return</span> dictGenCaseHashFunction((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)key, sdslen((<span class="keywordtype">char</span>*)key));</div><div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;}</div><div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;</div><div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;<span class="keywordtype">int</span> dictEncObjKeyCompare(<span class="keywordtype">void</span> *privdata, <span class="keyword">const</span> <span class="keywordtype">void</span> *key1,</div><div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;        <span class="keyword">const</span> <span class="keywordtype">void</span> *key2)</div><div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;{</div><div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;    robj *o1 = (robj*) key1, *o2 = (robj*) key2;</div><div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;    <span class="keywordtype">int</span> cmp;</div><div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;</div><div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;    <span class="keywordflow">if</span> (o1-&gt;encoding == <a class="code" href="server_8h.html#ae934cf008a0be0ef009c92c2d006a816">OBJ_ENCODING_INT</a> &amp;&amp;</div><div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;        o2-&gt;encoding == <a class="code" href="server_8h.html#ae934cf008a0be0ef009c92c2d006a816">OBJ_ENCODING_INT</a>)</div><div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;            <span class="keywordflow">return</span> o1-&gt;ptr == o2-&gt;ptr;</div><div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;</div><div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;    o1 = getDecodedObject(o1);</div><div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;    o2 = getDecodedObject(o2);</div><div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;    cmp = dictSdsKeyCompare(privdata,o1-&gt;ptr,o2-&gt;ptr);</div><div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;    decrRefCount(o1);</div><div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;    decrRefCount(o2);</div><div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;    <span class="keywordflow">return</span> cmp;</div><div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;}</div><div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;</div><div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;uint64_t dictEncObjHash(<span class="keyword">const</span> <span class="keywordtype">void</span> *key) {</div><div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;    robj *o = (robj*) key;</div><div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;</div><div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="server_8h.html#afcfb5bd97af52d1dbce331745cae030c">sdsEncodedObject</a>(o)) {</div><div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;        <span class="keywordflow">return</span> dictGenHashFunction(o-&gt;ptr, sdslen((sds)o-&gt;ptr));</div><div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;        <span class="keywordflow">if</span> (o-&gt;encoding == <a class="code" href="server_8h.html#ae934cf008a0be0ef009c92c2d006a816">OBJ_ENCODING_INT</a>) {</div><div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;            <span class="keywordtype">char</span> buf[32];</div><div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;            <span class="keywordtype">int</span> len;</div><div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;</div><div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;            len = ll2string(buf,32,(<span class="keywordtype">long</span>)o-&gt;ptr);</div><div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;            <span class="keywordflow">return</span> dictGenHashFunction((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)buf, len);</div><div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;        } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;            uint64_t hash;</div><div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;</div><div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;            o = getDecodedObject(o);</div><div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;            hash = dictGenHashFunction(o-&gt;ptr, sdslen((sds)o-&gt;ptr));</div><div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;            decrRefCount(o);</div><div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;            <span class="keywordflow">return</span> hash;</div><div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;        }</div><div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;    }</div><div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;}</div><div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;</div><div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;<span class="comment">/* Generic hash table type where keys are Redis Objects, Values</span></div><div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;<span class="comment"> * dummy pointers. */</span></div><div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;dictType objectKeyPointerValueDictType = {</div><div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;    dictEncObjHash,            <span class="comment">/* hash function */</span></div><div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;    NULL,                      <span class="comment">/* key dup */</span></div><div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;    NULL,                      <span class="comment">/* val dup */</span></div><div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;    dictEncObjKeyCompare,      <span class="comment">/* key compare */</span></div><div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;    dictObjectDestructor,      <span class="comment">/* key destructor */</span></div><div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;    NULL                       <span class="comment">/* val destructor */</span></div><div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;};</div><div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;</div><div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;<span class="comment">/* Like objectKeyPointerValueDictType(), but values can be destroyed, if</span></div><div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;<span class="comment"> * not NULL, calling zfree(). */</span></div><div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;dictType objectKeyHeapPointerValueDictType = {</div><div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;    dictEncObjHash,            <span class="comment">/* hash function */</span></div><div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;    NULL,                      <span class="comment">/* key dup */</span></div><div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;    NULL,                      <span class="comment">/* val dup */</span></div><div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;    dictEncObjKeyCompare,      <span class="comment">/* key compare */</span></div><div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;    dictObjectDestructor,      <span class="comment">/* key destructor */</span></div><div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;    dictVanillaFree            <span class="comment">/* val destructor */</span></div><div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;};</div><div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;</div><div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;<span class="comment">/* Set dictionary type. Keys are SDS strings, values are ot used. */</span></div><div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;dictType setDictType = {</div><div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;    dictSdsHash,               <span class="comment">/* hash function */</span></div><div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;    NULL,                      <span class="comment">/* key dup */</span></div><div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;    NULL,                      <span class="comment">/* val dup */</span></div><div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;    dictSdsKeyCompare,         <span class="comment">/* key compare */</span></div><div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;    dictSdsDestructor,         <span class="comment">/* key destructor */</span></div><div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;    NULL                       <span class="comment">/* val destructor */</span></div><div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;};</div><div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;</div><div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;<span class="comment">/* Sorted sets hash (note: a skiplist is used in addition to the hash table) */</span></div><div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;dictType zsetDictType = {</div><div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;    dictSdsHash,               <span class="comment">/* hash function */</span></div><div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;    NULL,                      <span class="comment">/* key dup */</span></div><div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;    NULL,                      <span class="comment">/* val dup */</span></div><div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;    dictSdsKeyCompare,         <span class="comment">/* key compare */</span></div><div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;    NULL,                      <span class="comment">/* Note: SDS string shared &amp; freed by skiplist */</span></div><div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;    NULL                       <span class="comment">/* val destructor */</span></div><div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;};</div><div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;</div><div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;<span class="comment">/* Db-&gt;dict, keys are sds strings, vals are Redis objects. */</span></div><div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;dictType dbDictType = {</div><div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;    dictSdsHash,                <span class="comment">/* hash function */</span></div><div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;    NULL,                       <span class="comment">/* key dup */</span></div><div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;    NULL,                       <span class="comment">/* val dup */</span></div><div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;    dictSdsKeyCompare,          <span class="comment">/* key compare */</span></div><div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;    dictSdsDestructor,          <span class="comment">/* key destructor */</span></div><div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;    dictObjectDestructor   <span class="comment">/* val destructor */</span></div><div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;};</div><div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;</div><div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;<span class="comment">/* server.lua_scripts sha (as sds string) -&gt; scripts (as robj) cache. */</span></div><div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;dictType shaScriptObjectDictType = {</div><div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;    dictSdsCaseHash,            <span class="comment">/* hash function */</span></div><div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;    NULL,                       <span class="comment">/* key dup */</span></div><div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;    NULL,                       <span class="comment">/* val dup */</span></div><div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;    dictSdsKeyCaseCompare,      <span class="comment">/* key compare */</span></div><div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;    dictSdsDestructor,          <span class="comment">/* key destructor */</span></div><div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;    dictObjectDestructor        <span class="comment">/* val destructor */</span></div><div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;};</div><div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;</div><div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;<span class="comment">/* Db-&gt;expires */</span></div><div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;dictType keyptrDictType = {</div><div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;    dictSdsHash,                <span class="comment">/* hash function */</span></div><div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;    NULL,                       <span class="comment">/* key dup */</span></div><div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;    NULL,                       <span class="comment">/* val dup */</span></div><div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;    dictSdsKeyCompare,          <span class="comment">/* key compare */</span></div><div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;    NULL,                       <span class="comment">/* key destructor */</span></div><div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;    NULL                        <span class="comment">/* val destructor */</span></div><div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;};</div><div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;</div><div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;<span class="comment">/* Command table. sds string -&gt; command struct pointer. */</span></div><div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;dictType commandTableDictType = {</div><div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;    dictSdsCaseHash,            <span class="comment">/* hash function */</span></div><div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;    NULL,                       <span class="comment">/* key dup */</span></div><div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;    NULL,                       <span class="comment">/* val dup */</span></div><div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;    dictSdsKeyCaseCompare,      <span class="comment">/* key compare */</span></div><div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;    dictSdsDestructor,          <span class="comment">/* key destructor */</span></div><div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;    NULL                        <span class="comment">/* val destructor */</span></div><div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;};</div><div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;</div><div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;<span class="comment">/* Hash type hash table (note that small hashes are represented with ziplists) */</span></div><div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;dictType hashDictType = {</div><div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;    dictSdsHash,                <span class="comment">/* hash function */</span></div><div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;    NULL,                       <span class="comment">/* key dup */</span></div><div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;    NULL,                       <span class="comment">/* val dup */</span></div><div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;    dictSdsKeyCompare,          <span class="comment">/* key compare */</span></div><div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;    dictSdsDestructor,          <span class="comment">/* key destructor */</span></div><div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;    dictSdsDestructor           <span class="comment">/* val destructor */</span></div><div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;};</div><div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;</div><div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;<span class="comment">/* Keylist hash table type has unencoded redis objects as keys and</span></div><div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;<span class="comment"> * lists as values. It&#39;s used for blocking operations (BLPOP) and to</span></div><div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;<span class="comment"> * map swapped keys to a list of clients waiting for this keys to be loaded. */</span></div><div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;dictType keylistDictType = {</div><div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;    dictObjHash,                <span class="comment">/* hash function */</span></div><div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;    NULL,                       <span class="comment">/* key dup */</span></div><div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;    NULL,                       <span class="comment">/* val dup */</span></div><div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;    dictObjKeyCompare,          <span class="comment">/* key compare */</span></div><div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;    dictObjectDestructor,       <span class="comment">/* key destructor */</span></div><div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;    dictListDestructor          <span class="comment">/* val destructor */</span></div><div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;};</div><div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;</div><div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;<span class="comment">/* Cluster nodes hash table, mapping nodes addresses 1.2.3.4:6379 to</span></div><div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;<span class="comment"> * clusterNode structures. */</span></div><div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;dictType clusterNodesDictType = {</div><div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;    dictSdsHash,                <span class="comment">/* hash function */</span></div><div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;    NULL,                       <span class="comment">/* key dup */</span></div><div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;    NULL,                       <span class="comment">/* val dup */</span></div><div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;    dictSdsKeyCompare,          <span class="comment">/* key compare */</span></div><div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;    dictSdsDestructor,          <span class="comment">/* key destructor */</span></div><div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;    NULL                        <span class="comment">/* val destructor */</span></div><div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;};</div><div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;</div><div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;<span class="comment">/* Cluster re-addition blacklist. This maps node IDs to the time</span></div><div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;<span class="comment"> * we can re-add this node. The goal is to avoid readding a removed</span></div><div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;<span class="comment"> * node for some time. */</span></div><div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;dictType clusterNodesBlackListDictType = {</div><div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;    dictSdsCaseHash,            <span class="comment">/* hash function */</span></div><div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;    NULL,                       <span class="comment">/* key dup */</span></div><div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;    NULL,                       <span class="comment">/* val dup */</span></div><div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;    dictSdsKeyCaseCompare,      <span class="comment">/* key compare */</span></div><div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;    dictSdsDestructor,          <span class="comment">/* key destructor */</span></div><div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;    NULL                        <span class="comment">/* val destructor */</span></div><div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;};</div><div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;</div><div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;<span class="comment">/* Cluster re-addition blacklist. This maps node IDs to the time</span></div><div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;<span class="comment"> * we can re-add this node. The goal is to avoid readding a removed</span></div><div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;<span class="comment"> * node for some time. */</span></div><div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;dictType modulesDictType = {</div><div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;    dictSdsCaseHash,            <span class="comment">/* hash function */</span></div><div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;    NULL,                       <span class="comment">/* key dup */</span></div><div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;    NULL,                       <span class="comment">/* val dup */</span></div><div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;    dictSdsKeyCaseCompare,      <span class="comment">/* key compare */</span></div><div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;    dictSdsDestructor,          <span class="comment">/* key destructor */</span></div><div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;    NULL                        <span class="comment">/* val destructor */</span></div><div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;};</div><div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;</div><div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;<span class="comment">/* Migrate cache dict type. */</span></div><div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;dictType migrateCacheDictType = {</div><div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;    dictSdsHash,                <span class="comment">/* hash function */</span></div><div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;    NULL,                       <span class="comment">/* key dup */</span></div><div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;    NULL,                       <span class="comment">/* val dup */</span></div><div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;    dictSdsKeyCompare,          <span class="comment">/* key compare */</span></div><div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;    dictSdsDestructor,          <span class="comment">/* key destructor */</span></div><div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;    NULL                        <span class="comment">/* val destructor */</span></div><div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;};</div><div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;</div><div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;<span class="comment">/* Replication cached script dict (server.repl_scriptcache_dict).</span></div><div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;<span class="comment"> * Keys are sds SHA1 strings, while values are not used at all in the current</span></div><div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;<span class="comment"> * implementation. */</span></div><div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;dictType replScriptCacheDictType = {</div><div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;    dictSdsCaseHash,            <span class="comment">/* hash function */</span></div><div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;    NULL,                       <span class="comment">/* key dup */</span></div><div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;    NULL,                       <span class="comment">/* val dup */</span></div><div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;    dictSdsKeyCaseCompare,      <span class="comment">/* key compare */</span></div><div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;    dictSdsDestructor,          <span class="comment">/* key destructor */</span></div><div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;    NULL                        <span class="comment">/* val destructor */</span></div><div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;};</div><div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;</div><div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;<span class="keywordtype">int</span> htNeedsResize(dict *dict) {</div><div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;    <span class="keywordtype">long</span> <span class="keywordtype">long</span> size, used;</div><div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;</div><div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;    size = <a class="code" href="dict_8h.html#aca9596be4bcc2caa07c17dd8cebcceec">dictSlots</a>(dict);</div><div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;    used = <a class="code" href="dict_8h.html#af193430dd3d5579a52b194512f72c1f0">dictSize</a>(dict);</div><div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;    <span class="keywordflow">return</span> (size &gt; <a class="code" href="dict_8h.html#aff97c19d1616cf2c697573ee3f515692">DICT_HT_INITIAL_SIZE</a> &amp;&amp;</div><div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;            (used*100/size &lt; <a class="code" href="server_8h.html#aab8d0fb9427699c23cdbeb524f875562">HASHTABLE_MIN_FILL</a>));</div><div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;}</div><div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;</div><div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;<span class="comment">/* If the percentage of used slots in the HT reaches HASHTABLE_MIN_FILL</span></div><div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;<span class="comment"> * we resize the hash table to save memory */</span></div><div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;<span class="keywordtype">void</span> tryResizeHashTables(<span class="keywordtype">int</span> dbid) {</div><div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;    <span class="keywordflow">if</span> (htNeedsResize(server.db[dbid].dict))</div><div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;        dictResize(server.db[dbid].dict);</div><div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;    <span class="keywordflow">if</span> (htNeedsResize(server.db[dbid].expires))</div><div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;        dictResize(server.db[dbid].expires);</div><div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;}</div><div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;</div><div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;<span class="comment">/* Our hash table implementation performs rehashing incrementally while</span></div><div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;<span class="comment"> * we write/read from the hash table. Still if the server is idle, the hash</span></div><div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;<span class="comment"> * table will use two tables for a long time. So we try to use 1 millisecond</span></div><div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;<span class="comment"> * of CPU time at every call of this function to perform some rehahsing.</span></div><div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;<span class="comment"> * The function returns 1 if some rehashing was performed, otherwise 0</span></div><div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;<span class="comment"> * is returned. */</span></div><div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;<span class="keywordtype">int</span> incrementallyRehash(<span class="keywordtype">int</span> dbid) {</div><div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;    <span class="comment">/* Keys dictionary */</span></div><div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="dict_8h.html#aa6e4917a6a32fdf47180e03ed8969e02">dictIsRehashing</a>(server.db[dbid].dict)) {</div><div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;        dictRehashMilliseconds(server.db[dbid].dict,1);</div><div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;        <span class="keywordflow">return</span> 1; <span class="comment">/* already used our millisecond for this loop... */</span></div><div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;    }</div><div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;    <span class="comment">/* Expires */</span></div><div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="dict_8h.html#aa6e4917a6a32fdf47180e03ed8969e02">dictIsRehashing</a>(server.db[dbid].expires)) {</div><div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;        dictRehashMilliseconds(server.db[dbid].expires,1);</div><div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;        <span class="keywordflow">return</span> 1; <span class="comment">/* already used our millisecond for this loop... */</span></div><div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;    }</div><div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;    <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;}</div><div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;</div><div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;<span class="comment">/* This function is called once a background process of some kind terminates,</span></div><div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;<span class="comment"> * as we want to avoid resizing the hash tables when there is a child in order</span></div><div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;<span class="comment"> * to play well with copy-on-write (otherwise when a resize happens lots of</span></div><div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;<span class="comment"> * memory pages are copied). The goal of this function is to update the ability</span></div><div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;<span class="comment"> * for dict.c to resize the hash tables accordingly to the fact we have o not</span></div><div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;<span class="comment"> * running childs. */</span></div><div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;<span class="keywordtype">void</span> updateDictResizePolicy(<span class="keywordtype">void</span>) {</div><div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;    <span class="keywordflow">if</span> (server.rdb_child_pid == -1 &amp;&amp; server.aof_child_pid == -1)</div><div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;        dictEnableResize();</div><div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;        dictDisableResize();</div><div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;}</div><div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;</div><div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;<span class="comment">/* ======================= Cron: called every 100 ms ======================== */</span></div><div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;</div><div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;<span class="comment">/* Add a sample to the operations per second array of samples. */</span></div><div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;<span class="keywordtype">void</span> trackInstantaneousMetric(<span class="keywordtype">int</span> metric, <span class="keywordtype">long</span> <span class="keywordtype">long</span> current_reading) {</div><div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;    <span class="keywordtype">long</span> <span class="keywordtype">long</span> t = mstime() - server.inst_metric[metric].last_sample_time;</div><div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;    <span class="keywordtype">long</span> <span class="keywordtype">long</span> ops = current_reading -</div><div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;                    server.inst_metric[metric].last_sample_count;</div><div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;    <span class="keywordtype">long</span> <span class="keywordtype">long</span> ops_sec;</div><div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;</div><div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;    ops_sec = t &gt; 0 ? (ops*1000/t) : 0;</div><div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;</div><div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;    server.inst_metric[metric].samples[server.inst_metric[metric].idx] =</div><div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;        ops_sec;</div><div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;    server.inst_metric[metric].idx++;</div><div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;    server.inst_metric[metric].idx %= <a class="code" href="server_8h.html#a225a9e35f2cb8aa663571625bc59a533">STATS_METRIC_SAMPLES</a>;</div><div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;    server.inst_metric[metric].last_sample_time = mstime();</div><div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;    server.inst_metric[metric].last_sample_count = current_reading;</div><div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;}</div><div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;</div><div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;<span class="comment">/* Return the mean of all the samples. */</span></div><div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;<span class="keywordtype">long</span> <span class="keywordtype">long</span> getInstantaneousMetric(<span class="keywordtype">int</span> metric) {</div><div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;    <span class="keywordtype">int</span> j;</div><div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;    <span class="keywordtype">long</span> <span class="keywordtype">long</span> sum = 0;</div><div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;</div><div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;    <span class="keywordflow">for</span> (j = 0; j &lt; <a class="code" href="server_8h.html#a225a9e35f2cb8aa663571625bc59a533">STATS_METRIC_SAMPLES</a>; j++)</div><div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;        sum += server.inst_metric[metric].samples[j];</div><div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;    <span class="keywordflow">return</span> sum / <a class="code" href="server_8h.html#a225a9e35f2cb8aa663571625bc59a533">STATS_METRIC_SAMPLES</a>;</div><div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;}</div><div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;</div><div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;<span class="comment">/* Check for timeouts. Returns non-zero if the client was terminated.</span></div><div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;<span class="comment"> * The function gets the current time in milliseconds as argument since</span></div><div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;<span class="comment"> * it gets called multiple times in a loop, so calling gettimeofday() for</span></div><div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;<span class="comment"> * each iteration would be costly without any actual gain. */</span></div><div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;<span class="keywordtype">int</span> clientsCronHandleTimeout(<a class="code" href="structclient.html">client</a> *c, mstime_t now_ms) {</div><div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;    time_t now = now_ms/1000;</div><div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;</div><div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;    <span class="keywordflow">if</span> (server.maxidletime &amp;&amp;</div><div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;        !(c-&gt;flags &amp; <a class="code" href="server_8h.html#ae9f6995948253652bc9454d79a72f4a7">CLIENT_SLAVE</a>) &amp;&amp;    <span class="comment">/* no timeout for slaves */</span></div><div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;        !(c-&gt;flags &amp; <a class="code" href="server_8h.html#a3d8f0cc8d0653ee2b6dafb454292c069">CLIENT_MASTER</a>) &amp;&amp;   <span class="comment">/* no timeout for masters */</span></div><div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;        !(c-&gt;flags &amp; <a class="code" href="server_8h.html#a503ad979164a52f0f5e2a63e4c7da3a0">CLIENT_BLOCKED</a>) &amp;&amp;  <span class="comment">/* no timeout for BLPOP */</span></div><div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;        !(c-&gt;flags &amp; <a class="code" href="server_8h.html#a20f2f5380db97cd09013118ffc9411cc">CLIENT_PUBSUB</a>) &amp;&amp;   <span class="comment">/* no timeout for Pub/Sub clients */</span></div><div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;        (now - c-&gt;lastinteraction &gt; server.maxidletime))</div><div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;    {</div><div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;        serverLog(<a class="code" href="server_8h.html#a479b60032f8da6d8ad72e1a9d0809950">LL_VERBOSE</a>,<span class="stringliteral">&quot;Closing idle client&quot;</span>);</div><div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;        freeClient(c);</div><div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;        <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (c-&gt;flags &amp; <a class="code" href="server_8h.html#a503ad979164a52f0f5e2a63e4c7da3a0">CLIENT_BLOCKED</a>) {</div><div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;        <span class="comment">/* Blocked OPS timeout is handled with milliseconds resolution.</span></div><div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;<span class="comment">         * However note that the actual resolution is limited by</span></div><div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;<span class="comment">         * server.hz. */</span></div><div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;</div><div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;        <span class="keywordflow">if</span> (c-&gt;bpop.timeout != 0 &amp;&amp; c-&gt;bpop.timeout &lt; now_ms) {</div><div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;            <span class="comment">/* Handle blocking operation specific timeout. */</span></div><div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;            replyToBlockedClientTimedOut(c);</div><div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;            unblockClient(c);</div><div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (server.cluster_enabled) {</div><div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;            <span class="comment">/* Cluster: handle unblock &amp; redirect of clients blocked</span></div><div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;<span class="comment">             * into keys no longer served by this server. */</span></div><div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;            <span class="keywordflow">if</span> (clusterRedirectBlockedClientIfNeeded(c))</div><div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;                unblockClient(c);</div><div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;        }</div><div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;    }</div><div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;    <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;}</div><div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;</div><div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;<span class="comment">/* The client query buffer is an sds.c string that can end with a lot of</span></div><div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;<span class="comment"> * free space not used, this function reclaims space if needed.</span></div><div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;<span class="comment"> * The function always returns 0 as it never terminates the client. */</span></div><div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;<span class="keywordtype">int</span> clientsCronResizeQueryBuffer(<a class="code" href="structclient.html">client</a> *c) {</div><div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;    size_t querybuf_size = sdsAllocSize(c-&gt;querybuf);</div><div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;    time_t idletime = server.unixtime - c-&gt;lastinteraction;</div><div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;</div><div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;    <span class="comment">/* There are two conditions to resize the query buffer:</span></div><div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;<span class="comment">     * 1) Query buffer is &gt; BIG_ARG and too big for latest peak.</span></div><div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;<span class="comment">     * 2) Client is inactive and the buffer is bigger than 1k. */</span></div><div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;    <span class="keywordflow">if</span> (((querybuf_size &gt; <a class="code" href="server_8h.html#afb6bccf6f1ac66b1d563330ab499fb32">PROTO_MBULK_BIG_ARG</a>) &amp;&amp;</div><div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;         (querybuf_size/(c-&gt;querybuf_peak+1)) &gt; 2) ||</div><div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;         (querybuf_size &gt; 1024 &amp;&amp; idletime &gt; 2))</div><div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;    {</div><div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;        <span class="comment">/* Only resize the query buffer if it is actually wasting space. */</span></div><div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;        <span class="keywordflow">if</span> (sdsavail(c-&gt;querybuf) &gt; 1024) {</div><div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;            c-&gt;querybuf = sdsRemoveFreeSpace(c-&gt;querybuf);</div><div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;        }</div><div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;    }</div><div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;    <span class="comment">/* Reset the peak again to capture the peak memory usage in the next</span></div><div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;<span class="comment">     * cycle. */</span></div><div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;    c-&gt;querybuf_peak = 0;</div><div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;    <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;}</div><div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;</div><div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">define</span> <span class="preprocessor">CLIENTS_CRON_MIN_ITERATIONS</span> 5</div><div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;<span class="keywordtype">void</span> clientsCron(<span class="keywordtype">void</span>) {</div><div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;    <span class="comment">/* Make sure to process at least numclients/server.hz of clients</span></div><div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;<span class="comment">     * per call. Since this function is called server.hz times per second</span></div><div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;<span class="comment">     * we are sure that in the worst case we process all the clients in 1</span></div><div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;<span class="comment">     * second. */</span></div><div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;    <span class="keywordtype">int</span> numclients = <a class="code" href="adlist_8h.html#afde0ab079f934670e82119b43120e94b">listLength</a>(server.clients);</div><div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;    <span class="keywordtype">int</span> iterations = numclients/server.hz;</div><div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;    mstime_t now = mstime();</div><div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;</div><div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;    <span class="comment">/* Process at least a few clients while we are at it, even if we need</span></div><div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;<span class="comment">     * to process less than CLIENTS_CRON_MIN_ITERATIONS to meet our contract</span></div><div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;<span class="comment">     * of processing each client once per second. */</span></div><div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;    <span class="keywordflow">if</span> (iterations &lt; <a class="code" href="server_8c.html#a79785342d159d7e8dc4547ffb330835d">CLIENTS_CRON_MIN_ITERATIONS</a>)</div><div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;        iterations = (numclients &lt; <a class="code" href="server_8c.html#a79785342d159d7e8dc4547ffb330835d">CLIENTS_CRON_MIN_ITERATIONS</a>) ?</div><div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;                     numclients : <a class="code" href="server_8c.html#a79785342d159d7e8dc4547ffb330835d">CLIENTS_CRON_MIN_ITERATIONS</a>;</div><div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;</div><div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;    <span class="keywordflow">while</span>(<a class="code" href="adlist_8h.html#afde0ab079f934670e82119b43120e94b">listLength</a>(server.clients) &amp;&amp; iterations--) {</div><div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;        <a class="code" href="structclient.html">client</a> *c;</div><div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;        listNode *head;</div><div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;</div><div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;        <span class="comment">/* Rotate the list, take the current head, process.</span></div><div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;<span class="comment">         * This way if the client must be removed from the list it&#39;s the</span></div><div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;<span class="comment">         * first element and we don&#39;t incur into O(N) computation. */</span></div><div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;        listRotate(server.clients);</div><div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;        head = <a class="code" href="adlist_8h.html#aa8dc514bbe217bb2e87c1c77cfa84690">listFirst</a>(server.clients);</div><div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;        c = <a class="code" href="adlist_8h.html#af84cae230e7180ebcda1e2736fce9f65">listNodeValue</a>(head);</div><div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;        <span class="comment">/* The following functions do different service checks on the client.</span></div><div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;<span class="comment">         * The protocol is that they return non-zero if the client was</span></div><div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;<span class="comment">         * terminated. */</span></div><div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;        <span class="keywordflow">if</span> (clientsCronHandleTimeout(c,now)) <span class="keywordflow">continue</span>;</div><div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;        <span class="keywordflow">if</span> (clientsCronResizeQueryBuffer(c)) <span class="keywordflow">continue</span>;</div><div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;    }</div><div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;}</div><div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;</div><div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;<span class="comment">/* This function handles &#39;background&#39; operations we are required to do</span></div><div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;<span class="comment"> * incrementally in Redis databases, such as active key expiring, resizing,</span></div><div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;<span class="comment"> * rehashing. */</span></div><div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;<span class="keywordtype">void</span> databasesCron(<span class="keywordtype">void</span>) {</div><div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;    <span class="comment">/* Expire keys by random sampling. Not required for slaves</span></div><div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;<span class="comment">     * as master will synthesize DELs for us. */</span></div><div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;    <span class="keywordflow">if</span> (server.active_expire_enabled &amp;&amp; server.masterhost == NULL) {</div><div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;        activeExpireCycle(<a class="code" href="server_8h.html#a62e5b6ba358ddcdef709e107e4d24744">ACTIVE_EXPIRE_CYCLE_SLOW</a>);</div><div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (server.masterhost != NULL) {</div><div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;        expireSlaveKeys();</div><div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;    }</div><div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;</div><div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;    <span class="comment">/* Defrag keys gradually. */</span></div><div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;    <span class="keywordflow">if</span> (server.active_defrag_enabled)</div><div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;        activeDefragCycle();</div><div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;</div><div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;    <span class="comment">/* Perform hash tables rehashing if needed, but only if there are no</span></div><div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;<span class="comment">     * other processes saving the DB on disk. Otherwise rehashing is bad</span></div><div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;<span class="comment">     * as will cause a lot of copy-on-write of memory pages. */</span></div><div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;    <span class="keywordflow">if</span> (server.rdb_child_pid == -1 &amp;&amp; server.aof_child_pid == -1) {</div><div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;        <span class="comment">/* We use global counters so if we stop the computation at a given</span></div><div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;<span class="comment">         * DB we&#39;ll be able to start from the successive in the next</span></div><div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;<span class="comment">         * cron loop iteration. */</span></div><div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;        <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> resize_db = 0;</div><div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;        <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> rehash_db = 0;</div><div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;        <span class="keywordtype">int</span> dbs_per_call = <a class="code" href="server_8h.html#aaab0790ee1a625276dce078a9dbbe075">CRON_DBS_PER_CALL</a>;</div><div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;        <span class="keywordtype">int</span> j;</div><div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;</div><div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;        <span class="comment">/* Don&#39;t test more DBs than we have. */</span></div><div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;        <span class="keywordflow">if</span> (dbs_per_call &gt; server.dbnum) dbs_per_call = server.dbnum;</div><div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;</div><div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;        <span class="comment">/* Resize */</span></div><div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;        <span class="keywordflow">for</span> (j = 0; j &lt; dbs_per_call; j++) {</div><div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;            tryResizeHashTables(resize_db % server.dbnum);</div><div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;            resize_db++;</div><div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;        }</div><div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;</div><div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;        <span class="comment">/* Rehash */</span></div><div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;        <span class="keywordflow">if</span> (server.activerehashing) {</div><div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;            <span class="keywordflow">for</span> (j = 0; j &lt; dbs_per_call; j++) {</div><div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;                <span class="keywordtype">int</span> work_done = incrementallyRehash(rehash_db);</div><div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;                <span class="keywordflow">if</span> (work_done) {</div><div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;                    <span class="comment">/* If the function did some work, stop here, we&#39;ll do</span></div><div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;<span class="comment">                     * more at the next cron loop. */</span></div><div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;                    <span class="keywordflow">break</span>;</div><div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;                } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;                    <span class="comment">/* If this db didn&#39;t need rehash, we&#39;ll try the next one. */</span></div><div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;                    rehash_db++;</div><div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;                    rehash_db %= server.dbnum;</div><div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;                }</div><div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;            }</div><div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;        }</div><div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;    }</div><div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;}</div><div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;</div><div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;<span class="comment">/* We take a cached value of the unix time in the global state because with</span></div><div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;<span class="comment"> * virtual memory and aging there is to store the current time in objects at</span></div><div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;<span class="comment"> * every object access, and accuracy is not needed. To access a global var is</span></div><div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;<span class="comment"> * a lot faster than calling time(NULL) */</span></div><div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;<span class="keywordtype">void</span> updateCachedTime(<span class="keywordtype">void</span>) {</div><div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;    time_t unixtime = time(NULL);</div><div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;    <a class="code" href="atomicvar_8h.html#a0f02b5846dcf4ed3669ecf771c512d12">atomicSet</a>(server.unixtime,unixtime);</div><div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;    server.mstime = mstime();</div><div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;}</div><div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;</div><div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;<span class="comment">/* This is our timer interrupt, called server.hz times per second.</span></div><div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;<span class="comment"> * Here is where we do a number of things that need to be done asynchronously.</span></div><div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;<span class="comment"> * For instance:</span></div><div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;<span class="comment"> * - Active expired keys collection (it is also performed in a lazy way on</span></div><div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;<span class="comment"> *   lookup).</span></div><div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;<span class="comment"> * - Software watchdog.</span></div><div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;<span class="comment"> * - Update some statistic.</span></div><div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;<span class="comment"> * - Incremental rehashing of the DBs hash tables.</span></div><div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;<span class="comment"> * - Triggering BGSAVE / AOF rewrite, and handling of terminated children.</span></div><div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;<span class="comment"> * - Clients timeout of different kinds.</span></div><div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;<span class="comment"> * - Replication reconnection.</span></div><div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;<span class="comment"> * - Many more...</span></div><div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;<span class="comment"> * Everything directly called here will be called server.hz times per second,</span></div><div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;<span class="comment"> * so in order to throttle execution of things we want to do less frequently</span></div><div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;<span class="comment"> * a macro is used: run_with_period(milliseconds) { .... }</span></div><div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;</div><div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;<span class="keywordtype">int</span> serverCron(<span class="keyword">struct</span> <a class="code" href="structaeEventLoop.html">aeEventLoop</a> *eventLoop, <span class="keywordtype">long</span> <span class="keywordtype">long</span> id, <span class="keywordtype">void</span> *clientData) {</div><div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;    <span class="keywordtype">int</span> j;</div><div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;    <a class="code" href="server_8h.html#ae7c9dc8f13568a9c856573751f1ee1ec">UNUSED</a>(eventLoop);</div><div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;    <a class="code" href="server_8h.html#ae7c9dc8f13568a9c856573751f1ee1ec">UNUSED</a>(id);</div><div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;    <a class="code" href="server_8h.html#ae7c9dc8f13568a9c856573751f1ee1ec">UNUSED</a>(clientData);</div><div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;</div><div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;    <span class="comment">/* Software watchdog: deliver the SIGALRM that will reach the signal</span></div><div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;<span class="comment">     * handler if we don&#39;t return here fast enough. */</span></div><div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;    <span class="keywordflow">if</span> (server.watchdog_period) watchdogScheduleSignal(server.watchdog_period);</div><div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;</div><div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;    <span class="comment">/* Update the time cache. */</span></div><div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;    updateCachedTime();</div><div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;</div><div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;    <a class="code" href="server_8h.html#aeb204872adbaabc0bd56c64f562b7928">run_with_period</a>(100) {</div><div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;        trackInstantaneousMetric(<a class="code" href="server_8h.html#ac8d50898802f96b76479bc975e1bbbf3">STATS_METRIC_COMMAND</a>,server.stat_numcommands);</div><div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;        trackInstantaneousMetric(<a class="code" href="server_8h.html#a6d217560ae714ab8d0cc21832b210e0b">STATS_METRIC_NET_INPUT</a>,</div><div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;                server.stat_net_input_bytes);</div><div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;        trackInstantaneousMetric(<a class="code" href="server_8h.html#a3885f356f3a4cef22eb96fbfcc406333">STATS_METRIC_NET_OUTPUT</a>,</div><div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;                server.stat_net_output_bytes);</div><div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;    }</div><div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;</div><div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;    <span class="comment">/* We have just LRU_BITS bits per object for LRU information.</span></div><div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;<span class="comment">     * So we use an (eventually wrapping) LRU clock.</span></div><div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160;<span class="comment">     *</span></div><div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;<span class="comment">     * Note that even if the counter wraps it&#39;s not a big problem,</span></div><div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;<span class="comment">     * everything will still work but some object will appear younger</span></div><div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;<span class="comment">     * to Redis. However for this to happen a given object should never be</span></div><div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;<span class="comment">     * touched for all the time needed to the counter to wrap, which is</span></div><div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;<span class="comment">     * not likely.</span></div><div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;<span class="comment">     *</span></div><div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;<span class="comment">     * Note that you can change the resolution altering the</span></div><div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;<span class="comment">     * LRU_CLOCK_RESOLUTION define. */</span></div><div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> lruclock = getLRUClock();</div><div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;    <a class="code" href="atomicvar_8h.html#a0f02b5846dcf4ed3669ecf771c512d12">atomicSet</a>(server.lruclock,lruclock);</div><div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;</div><div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;    <span class="comment">/* Record the max memory used since the server was started. */</span></div><div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;    <span class="keywordflow">if</span> (zmalloc_used_memory() &gt; server.stat_peak_memory)</div><div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;        server.stat_peak_memory = zmalloc_used_memory();</div><div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;</div><div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;    <span class="comment">/* Sample the RSS here since this is a relatively slow call. */</span></div><div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;    server.resident_set_size = zmalloc_get_rss();</div><div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;</div><div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;    <span class="comment">/* We received a SIGTERM, shutting down here in a safe way, as it is</span></div><div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;<span class="comment">     * not ok doing so inside the signal handler. */</span></div><div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;    <span class="keywordflow">if</span> (server.shutdown_asap) {</div><div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;        <span class="keywordflow">if</span> (prepareForShutdown(<a class="code" href="server_8h.html#a077401d3a9f810d535c00725ef6c6532">SHUTDOWN_NOFLAGS</a>) == <a class="code" href="server_8h.html#a303769ef1065076e68731584e758d3e1">C_OK</a>) exit(0);</div><div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;        serverLog(<a class="code" href="server_8h.html#a31229b9334bba7d6be2a72970967a14b">LL_WARNING</a>,<span class="stringliteral">&quot;SIGTERM received but errors trying to shut down the server, check the logs for more information&quot;</span>);</div><div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;        server.shutdown_asap = 0;</div><div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;    }</div><div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;</div><div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;    <span class="comment">/* Show some info about non-empty databases */</span></div><div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;    <a class="code" href="server_8h.html#aeb204872adbaabc0bd56c64f562b7928">run_with_period</a>(5000) {</div><div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;        <span class="keywordflow">for</span> (j = 0; j &lt; server.dbnum; j++) {</div><div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;            <span class="keywordtype">long</span> <span class="keywordtype">long</span> size, used, vkeys;</div><div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;</div><div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;            size = <a class="code" href="dict_8h.html#aca9596be4bcc2caa07c17dd8cebcceec">dictSlots</a>(server.db[j].dict);</div><div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;            used = <a class="code" href="dict_8h.html#af193430dd3d5579a52b194512f72c1f0">dictSize</a>(server.db[j].dict);</div><div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;            vkeys = <a class="code" href="dict_8h.html#af193430dd3d5579a52b194512f72c1f0">dictSize</a>(server.db[j].expires);</div><div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;            <span class="keywordflow">if</span> (used || vkeys) {</div><div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;                serverLog(<a class="code" href="server_8h.html#a479b60032f8da6d8ad72e1a9d0809950">LL_VERBOSE</a>,<span class="stringliteral">&quot;DB %d: %lld keys (%lld volatile) in %lld slots HT.&quot;</span>,j,used,vkeys,size);</div><div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;                <span class="comment">/* dictPrintStats(server.dict); */</span></div><div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;            }</div><div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;        }</div><div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;    }</div><div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;</div><div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;    <span class="comment">/* Show information about connected clients */</span></div><div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;    <span class="keywordflow">if</span> (!server.sentinel_mode) {</div><div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;        <a class="code" href="server_8h.html#aeb204872adbaabc0bd56c64f562b7928">run_with_period</a>(5000) {</div><div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;            serverLog(<a class="code" href="server_8h.html#a479b60032f8da6d8ad72e1a9d0809950">LL_VERBOSE</a>,</div><div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;                <span class="stringliteral">&quot;%lu clients connected (%lu slaves), %zu bytes in use&quot;</span>,</div><div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;                <a class="code" href="adlist_8h.html#afde0ab079f934670e82119b43120e94b">listLength</a>(server.clients)-<a class="code" href="adlist_8h.html#afde0ab079f934670e82119b43120e94b">listLength</a>(server.slaves),</div><div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;                <a class="code" href="adlist_8h.html#afde0ab079f934670e82119b43120e94b">listLength</a>(server.slaves),</div><div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;                zmalloc_used_memory());</div><div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;        }</div><div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;    }</div><div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;</div><div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;    <span class="comment">/* We need to do a few operations on clients asynchronously. */</span></div><div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;    clientsCron();</div><div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;</div><div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;    <span class="comment">/* Handle background operations on Redis databases. */</span></div><div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;    databasesCron();</div><div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;</div><div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;    <span class="comment">/* Start a scheduled AOF rewrite if this was requested by the user while</span></div><div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;<span class="comment">     * a BGSAVE was in progress. */</span></div><div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;    <span class="keywordflow">if</span> (server.rdb_child_pid == -1 &amp;&amp; server.aof_child_pid == -1 &amp;&amp;</div><div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;        server.aof_rewrite_scheduled)</div><div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;    {</div><div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;        rewriteAppendOnlyFileBackground();</div><div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;    }</div><div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;</div><div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;    <span class="comment">/* Check if a background saving or AOF rewrite in progress terminated. */</span></div><div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;    <span class="keywordflow">if</span> (server.rdb_child_pid != -1 || server.aof_child_pid != -1 ||</div><div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;        ldbPendingChildren())</div><div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;    {</div><div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;        <span class="keywordtype">int</span> statloc;</div><div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;        pid_t pid;</div><div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;</div><div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;        <span class="keywordflow">if</span> ((pid = wait3(&amp;statloc,WNOHANG,NULL)) != 0) {</div><div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;            <span class="keywordtype">int</span> exitcode = WEXITSTATUS(statloc);</div><div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;            <span class="keywordtype">int</span> bysignal = 0;</div><div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;</div><div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160;            <span class="keywordflow">if</span> (WIFSIGNALED(statloc)) bysignal = WTERMSIG(statloc);</div><div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;</div><div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;            <span class="keywordflow">if</span> (pid == -1) {</div><div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;                serverLog(<a class="code" href="server_8h.html#a31229b9334bba7d6be2a72970967a14b">LL_WARNING</a>,<span class="stringliteral">&quot;wait3() returned an error: %s. &quot;</span></div><div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;                    <span class="stringliteral">&quot;rdb_child_pid = %d, aof_child_pid = %d&quot;</span>,</div><div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160;                    strerror(errno),</div><div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;                    (<span class="keywordtype">int</span>) server.rdb_child_pid,</div><div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;                    (<span class="keywordtype">int</span>) server.aof_child_pid);</div><div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pid == server.rdb_child_pid) {</div><div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;                backgroundSaveDoneHandler(exitcode,bysignal);</div><div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;                <span class="keywordflow">if</span> (!bysignal &amp;&amp; exitcode == 0) receiveChildInfo();</div><div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pid == server.aof_child_pid) {</div><div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;                backgroundRewriteDoneHandler(exitcode,bysignal);</div><div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;                <span class="keywordflow">if</span> (!bysignal &amp;&amp; exitcode == 0) receiveChildInfo();</div><div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;                <span class="keywordflow">if</span> (!ldbRemoveChild(pid)) {</div><div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;                    serverLog(<a class="code" href="server_8h.html#a31229b9334bba7d6be2a72970967a14b">LL_WARNING</a>,</div><div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;                        <span class="stringliteral">&quot;Warning, detected child with unmatched pid: %ld&quot;</span>,</div><div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160;                        (<span class="keywordtype">long</span>)pid);</div><div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;                }</div><div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;            }</div><div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160;            updateDictResizePolicy();</div><div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;            closeChildInfoPipe();</div><div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;        }</div><div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;        <span class="comment">/* If there is not a background saving/rewrite in progress check if</span></div><div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;<span class="comment">         * we have to save/rewrite now */</span></div><div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160;         <span class="keywordflow">for</span> (j = 0; j &lt; server.saveparamslen; j++) {</div><div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;            <span class="keyword">struct</span> <a class="code" href="structsaveparam.html">saveparam</a> *sp = server.saveparams+j;</div><div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;</div><div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;            <span class="comment">/* Save if we reached the given amount of changes,</span></div><div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;<span class="comment">             * the given amount of seconds, and if the latest bgsave was</span></div><div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;<span class="comment">             * successful or if, in case of an error, at least</span></div><div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;<span class="comment">             * CONFIG_BGSAVE_RETRY_DELAY seconds already elapsed. */</span></div><div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;            <span class="keywordflow">if</span> (server.dirty &gt;= sp-&gt;changes &amp;&amp;</div><div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;                server.unixtime-server.lastsave &gt; sp-&gt;seconds &amp;&amp;</div><div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;                (server.unixtime-server.lastbgsave_try &gt;</div><div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160;                 <a class="code" href="server_8h.html#a27e00ebd25c04beef22fabf61ea0b5ea">CONFIG_BGSAVE_RETRY_DELAY</a> ||</div><div class="line"><a name="l01110"></a><span class="lineno"> 1110</span>&#160;                 server.lastbgsave_status == <a class="code" href="server_8h.html#a303769ef1065076e68731584e758d3e1">C_OK</a>))</div><div class="line"><a name="l01111"></a><span class="lineno"> 1111</span>&#160;            {</div><div class="line"><a name="l01112"></a><span class="lineno"> 1112</span>&#160;                serverLog(<a class="code" href="server_8h.html#a8c54c191e436c7dd3012167212692401">LL_NOTICE</a>,<span class="stringliteral">&quot;%d changes in %d seconds. Saving...&quot;</span>,</div><div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160;                    sp-&gt;changes, (<span class="keywordtype">int</span>)sp-&gt;seconds);</div><div class="line"><a name="l01114"></a><span class="lineno"> 1114</span>&#160;                rdbSaveInfo rsi, *rsiptr;</div><div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;                rsiptr = rdbPopulateSaveInfo(&amp;rsi);</div><div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160;                rdbSaveBackground(server.rdb_filename,rsiptr);</div><div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;                <span class="keywordflow">break</span>;</div><div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160;            }</div><div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160;         }</div><div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;</div><div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;         <span class="comment">/* Trigger an AOF rewrite if needed */</span></div><div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;         <span class="keywordflow">if</span> (server.rdb_child_pid == -1 &amp;&amp;</div><div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160;             server.aof_child_pid == -1 &amp;&amp;</div><div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;             server.aof_rewrite_perc &amp;&amp;</div><div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;             server.aof_current_size &gt; server.aof_rewrite_min_size)</div><div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160;         {</div><div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;            <span class="keywordtype">long</span> <span class="keywordtype">long</span> base = server.aof_rewrite_base_size ?</div><div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160;                            server.aof_rewrite_base_size : 1;</div><div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;            <span class="keywordtype">long</span> <span class="keywordtype">long</span> growth = (server.aof_current_size*100/base) - 100;</div><div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;            <span class="keywordflow">if</span> (growth &gt;= server.aof_rewrite_perc) {</div><div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160;                serverLog(<a class="code" href="server_8h.html#a8c54c191e436c7dd3012167212692401">LL_NOTICE</a>,<span class="stringliteral">&quot;Starting automatic rewriting of AOF on %lld%% growth&quot;</span>,growth);</div><div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;                rewriteAppendOnlyFileBackground();</div><div class="line"><a name="l01133"></a><span class="lineno"> 1133</span>&#160;            }</div><div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160;         }</div><div class="line"><a name="l01135"></a><span class="lineno"> 1135</span>&#160;    }</div><div class="line"><a name="l01136"></a><span class="lineno"> 1136</span>&#160;</div><div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160;</div><div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160;    <span class="comment">/* AOF postponed flush: Try at every cron cycle if the slow fsync</span></div><div class="line"><a name="l01139"></a><span class="lineno"> 1139</span>&#160;<span class="comment">     * completed. */</span></div><div class="line"><a name="l01140"></a><span class="lineno"> 1140</span>&#160;    <span class="keywordflow">if</span> (server.aof_flush_postponed_start) flushAppendOnlyFile(0);</div><div class="line"><a name="l01141"></a><span class="lineno"> 1141</span>&#160;</div><div class="line"><a name="l01142"></a><span class="lineno"> 1142</span>&#160;    <span class="comment">/* AOF write errors: in this case we have a buffer to flush as well and</span></div><div class="line"><a name="l01143"></a><span class="lineno"> 1143</span>&#160;<span class="comment">     * clear the AOF error in case of success to make the DB writable again,</span></div><div class="line"><a name="l01144"></a><span class="lineno"> 1144</span>&#160;<span class="comment">     * however to try every second is enough in case of &#39;hz&#39; is set to</span></div><div class="line"><a name="l01145"></a><span class="lineno"> 1145</span>&#160;<span class="comment">     * an higher frequency. */</span></div><div class="line"><a name="l01146"></a><span class="lineno"> 1146</span>&#160;    <a class="code" href="server_8h.html#aeb204872adbaabc0bd56c64f562b7928">run_with_period</a>(1000) {</div><div class="line"><a name="l01147"></a><span class="lineno"> 1147</span>&#160;        <span class="keywordflow">if</span> (server.aof_last_write_status == <a class="code" href="server_8h.html#af98ac28d5f4d23d7ed5985188e6fb7d1">C_ERR</a>)</div><div class="line"><a name="l01148"></a><span class="lineno"> 1148</span>&#160;            flushAppendOnlyFile(0);</div><div class="line"><a name="l01149"></a><span class="lineno"> 1149</span>&#160;    }</div><div class="line"><a name="l01150"></a><span class="lineno"> 1150</span>&#160;</div><div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160;    <span class="comment">/* Close clients that need to be closed asynchronous */</span></div><div class="line"><a name="l01152"></a><span class="lineno"> 1152</span>&#160;    freeClientsInAsyncFreeQueue();</div><div class="line"><a name="l01153"></a><span class="lineno"> 1153</span>&#160;</div><div class="line"><a name="l01154"></a><span class="lineno"> 1154</span>&#160;    <span class="comment">/* Clear the paused clients flag if needed. */</span></div><div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160;    clientsArePaused(); <span class="comment">/* Don&#39;t check return value, just use the side effect.*/</span></div><div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160;</div><div class="line"><a name="l01157"></a><span class="lineno"> 1157</span>&#160;    <span class="comment">/* Replication cron function -- used to reconnect to master,</span></div><div class="line"><a name="l01158"></a><span class="lineno"> 1158</span>&#160;<span class="comment">     * detect transfer failures, start background RDB transfers and so forth. */</span></div><div class="line"><a name="l01159"></a><span class="lineno"> 1159</span>&#160;    <a class="code" href="server_8h.html#aeb204872adbaabc0bd56c64f562b7928">run_with_period</a>(1000) replicationCron();</div><div class="line"><a name="l01160"></a><span class="lineno"> 1160</span>&#160;</div><div class="line"><a name="l01161"></a><span class="lineno"> 1161</span>&#160;    <span class="comment">/* Run the Redis Cluster cron. */</span></div><div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160;    <a class="code" href="server_8h.html#aeb204872adbaabc0bd56c64f562b7928">run_with_period</a>(100) {</div><div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160;        <span class="keywordflow">if</span> (server.cluster_enabled) clusterCron();</div><div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160;    }</div><div class="line"><a name="l01165"></a><span class="lineno"> 1165</span>&#160;</div><div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160;    <span class="comment">/* Run the Sentinel timer if we are in sentinel mode. */</span></div><div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;    <a class="code" href="server_8h.html#aeb204872adbaabc0bd56c64f562b7928">run_with_period</a>(100) {</div><div class="line"><a name="l01168"></a><span class="lineno"> 1168</span>&#160;        <span class="keywordflow">if</span> (server.sentinel_mode) sentinelTimer();</div><div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160;    }</div><div class="line"><a name="l01170"></a><span class="lineno"> 1170</span>&#160;</div><div class="line"><a name="l01171"></a><span class="lineno"> 1171</span>&#160;    <span class="comment">/* Cleanup expired MIGRATE cached sockets. */</span></div><div class="line"><a name="l01172"></a><span class="lineno"> 1172</span>&#160;    <a class="code" href="server_8h.html#aeb204872adbaabc0bd56c64f562b7928">run_with_period</a>(1000) {</div><div class="line"><a name="l01173"></a><span class="lineno"> 1173</span>&#160;        migrateCloseTimedoutSockets();</div><div class="line"><a name="l01174"></a><span class="lineno"> 1174</span>&#160;    }</div><div class="line"><a name="l01175"></a><span class="lineno"> 1175</span>&#160;</div><div class="line"><a name="l01176"></a><span class="lineno"> 1176</span>&#160;    <span class="comment">/* Start a scheduled BGSAVE if the corresponding flag is set. This is</span></div><div class="line"><a name="l01177"></a><span class="lineno"> 1177</span>&#160;<span class="comment">     * useful when we are forced to postpone a BGSAVE because an AOF</span></div><div class="line"><a name="l01178"></a><span class="lineno"> 1178</span>&#160;<span class="comment">     * rewrite is in progress.</span></div><div class="line"><a name="l01179"></a><span class="lineno"> 1179</span>&#160;<span class="comment">     *</span></div><div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160;<span class="comment">     * Note: this code must be after the replicationCron() call above so</span></div><div class="line"><a name="l01181"></a><span class="lineno"> 1181</span>&#160;<span class="comment">     * make sure when refactoring this file to keep this order. This is useful</span></div><div class="line"><a name="l01182"></a><span class="lineno"> 1182</span>&#160;<span class="comment">     * because we want to give priority to RDB savings for replication. */</span></div><div class="line"><a name="l01183"></a><span class="lineno"> 1183</span>&#160;    <span class="keywordflow">if</span> (server.rdb_child_pid == -1 &amp;&amp; server.aof_child_pid == -1 &amp;&amp;</div><div class="line"><a name="l01184"></a><span class="lineno"> 1184</span>&#160;        server.rdb_bgsave_scheduled &amp;&amp;</div><div class="line"><a name="l01185"></a><span class="lineno"> 1185</span>&#160;        (server.unixtime-server.lastbgsave_try &gt; <a class="code" href="server_8h.html#a27e00ebd25c04beef22fabf61ea0b5ea">CONFIG_BGSAVE_RETRY_DELAY</a> ||</div><div class="line"><a name="l01186"></a><span class="lineno"> 1186</span>&#160;         server.lastbgsave_status == <a class="code" href="server_8h.html#a303769ef1065076e68731584e758d3e1">C_OK</a>))</div><div class="line"><a name="l01187"></a><span class="lineno"> 1187</span>&#160;    {</div><div class="line"><a name="l01188"></a><span class="lineno"> 1188</span>&#160;        rdbSaveInfo rsi, *rsiptr;</div><div class="line"><a name="l01189"></a><span class="lineno"> 1189</span>&#160;        rsiptr = rdbPopulateSaveInfo(&amp;rsi);</div><div class="line"><a name="l01190"></a><span class="lineno"> 1190</span>&#160;        <span class="keywordflow">if</span> (rdbSaveBackground(server.rdb_filename,rsiptr) == <a class="code" href="server_8h.html#a303769ef1065076e68731584e758d3e1">C_OK</a>)</div><div class="line"><a name="l01191"></a><span class="lineno"> 1191</span>&#160;            server.rdb_bgsave_scheduled = 0;</div><div class="line"><a name="l01192"></a><span class="lineno"> 1192</span>&#160;    }</div><div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160;</div><div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160;    server.cronloops++;</div><div class="line"><a name="l01195"></a><span class="lineno"> 1195</span>&#160;    <span class="keywordflow">return</span> 1000/server.hz;</div><div class="line"><a name="l01196"></a><span class="lineno"> 1196</span>&#160;}</div><div class="line"><a name="l01197"></a><span class="lineno"> 1197</span>&#160;</div><div class="line"><a name="l01198"></a><span class="lineno"> 1198</span>&#160;<span class="comment">/* This function gets called every time Redis is entering the</span></div><div class="line"><a name="l01199"></a><span class="lineno"> 1199</span>&#160;<span class="comment"> * main loop of the event driven library, that is, before to sleep</span></div><div class="line"><a name="l01200"></a><span class="lineno"> 1200</span>&#160;<span class="comment"> * for ready file descriptors. */</span></div><div class="line"><a name="l01201"></a><span class="lineno"> 1201</span>&#160;<span class="keywordtype">void</span> beforeSleep(<span class="keyword">struct</span> <a class="code" href="structaeEventLoop.html">aeEventLoop</a> *eventLoop) {</div><div class="line"><a name="l01202"></a><span class="lineno"> 1202</span>&#160;    <a class="code" href="server_8h.html#ae7c9dc8f13568a9c856573751f1ee1ec">UNUSED</a>(eventLoop);</div><div class="line"><a name="l01203"></a><span class="lineno"> 1203</span>&#160;</div><div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160;    <span class="comment">/* Call the Redis Cluster before sleep function. Note that this function</span></div><div class="line"><a name="l01205"></a><span class="lineno"> 1205</span>&#160;<span class="comment">     * may change the state of Redis Cluster (from ok to fail or vice versa),</span></div><div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160;<span class="comment">     * so it&#39;s a good idea to call it before serving the unblocked clients</span></div><div class="line"><a name="l01207"></a><span class="lineno"> 1207</span>&#160;<span class="comment">     * later in this function. */</span></div><div class="line"><a name="l01208"></a><span class="lineno"> 1208</span>&#160;    <span class="keywordflow">if</span> (server.cluster_enabled) clusterBeforeSleep();</div><div class="line"><a name="l01209"></a><span class="lineno"> 1209</span>&#160;</div><div class="line"><a name="l01210"></a><span class="lineno"> 1210</span>&#160;    <span class="comment">/* Run a fast expire cycle (the called function will return</span></div><div class="line"><a name="l01211"></a><span class="lineno"> 1211</span>&#160;<span class="comment">     * ASAP if a fast cycle is not needed). */</span></div><div class="line"><a name="l01212"></a><span class="lineno"> 1212</span>&#160;    <span class="keywordflow">if</span> (server.active_expire_enabled &amp;&amp; server.masterhost == NULL)</div><div class="line"><a name="l01213"></a><span class="lineno"> 1213</span>&#160;        activeExpireCycle(<a class="code" href="server_8h.html#ae265e849da28d7e7793659e45579ee11">ACTIVE_EXPIRE_CYCLE_FAST</a>);</div><div class="line"><a name="l01214"></a><span class="lineno"> 1214</span>&#160;</div><div class="line"><a name="l01215"></a><span class="lineno"> 1215</span>&#160;    <span class="comment">/* Send all the slaves an ACK request if at least one client blocked</span></div><div class="line"><a name="l01216"></a><span class="lineno"> 1216</span>&#160;<span class="comment">     * during the previous event loop iteration. */</span></div><div class="line"><a name="l01217"></a><span class="lineno"> 1217</span>&#160;    <span class="keywordflow">if</span> (server.get_ack_from_slaves) {</div><div class="line"><a name="l01218"></a><span class="lineno"> 1218</span>&#160;        robj *argv[3];</div><div class="line"><a name="l01219"></a><span class="lineno"> 1219</span>&#160;</div><div class="line"><a name="l01220"></a><span class="lineno"> 1220</span>&#160;        argv[0] = createStringObject(<span class="stringliteral">&quot;REPLCONF&quot;</span>,8);</div><div class="line"><a name="l01221"></a><span class="lineno"> 1221</span>&#160;        argv[1] = createStringObject(<span class="stringliteral">&quot;GETACK&quot;</span>,6);</div><div class="line"><a name="l01222"></a><span class="lineno"> 1222</span>&#160;        argv[2] = createStringObject(<span class="stringliteral">&quot;*&quot;</span>,1); <span class="comment">/* Not used argument. */</span></div><div class="line"><a name="l01223"></a><span class="lineno"> 1223</span>&#160;        replicationFeedSlaves(server.slaves, server.slaveseldb, argv, 3);</div><div class="line"><a name="l01224"></a><span class="lineno"> 1224</span>&#160;        decrRefCount(argv[0]);</div><div class="line"><a name="l01225"></a><span class="lineno"> 1225</span>&#160;        decrRefCount(argv[1]);</div><div class="line"><a name="l01226"></a><span class="lineno"> 1226</span>&#160;        decrRefCount(argv[2]);</div><div class="line"><a name="l01227"></a><span class="lineno"> 1227</span>&#160;        server.get_ack_from_slaves = 0;</div><div class="line"><a name="l01228"></a><span class="lineno"> 1228</span>&#160;    }</div><div class="line"><a name="l01229"></a><span class="lineno"> 1229</span>&#160;</div><div class="line"><a name="l01230"></a><span class="lineno"> 1230</span>&#160;    <span class="comment">/* Unblock all the clients blocked for synchronous replication</span></div><div class="line"><a name="l01231"></a><span class="lineno"> 1231</span>&#160;<span class="comment">     * in WAIT. */</span></div><div class="line"><a name="l01232"></a><span class="lineno"> 1232</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="adlist_8h.html#afde0ab079f934670e82119b43120e94b">listLength</a>(server.clients_waiting_acks))</div><div class="line"><a name="l01233"></a><span class="lineno"> 1233</span>&#160;        processClientsWaitingReplicas();</div><div class="line"><a name="l01234"></a><span class="lineno"> 1234</span>&#160;</div><div class="line"><a name="l01235"></a><span class="lineno"> 1235</span>&#160;    <span class="comment">/* Check if there are clients unblocked by modules that implement</span></div><div class="line"><a name="l01236"></a><span class="lineno"> 1236</span>&#160;<span class="comment">     * blocking commands. */</span></div><div class="line"><a name="l01237"></a><span class="lineno"> 1237</span>&#160;    moduleHandleBlockedClients();</div><div class="line"><a name="l01238"></a><span class="lineno"> 1238</span>&#160;</div><div class="line"><a name="l01239"></a><span class="lineno"> 1239</span>&#160;    <span class="comment">/* Try to process pending commands for clients that were just unblocked. */</span></div><div class="line"><a name="l01240"></a><span class="lineno"> 1240</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="adlist_8h.html#afde0ab079f934670e82119b43120e94b">listLength</a>(server.unblocked_clients))</div><div class="line"><a name="l01241"></a><span class="lineno"> 1241</span>&#160;        processUnblockedClients();</div><div class="line"><a name="l01242"></a><span class="lineno"> 1242</span>&#160;</div><div class="line"><a name="l01243"></a><span class="lineno"> 1243</span>&#160;    <span class="comment">/* Write the AOF buffer on disk */</span></div><div class="line"><a name="l01244"></a><span class="lineno"> 1244</span>&#160;    flushAppendOnlyFile(0);</div><div class="line"><a name="l01245"></a><span class="lineno"> 1245</span>&#160;</div><div class="line"><a name="l01246"></a><span class="lineno"> 1246</span>&#160;    <span class="comment">/* Handle writes with pending output buffers. */</span></div><div class="line"><a name="l01247"></a><span class="lineno"> 1247</span>&#160;    handleClientsWithPendingWrites();</div><div class="line"><a name="l01248"></a><span class="lineno"> 1248</span>&#160;</div><div class="line"><a name="l01249"></a><span class="lineno"> 1249</span>&#160;    <span class="comment">/* Before we are going to sleep, let the threads access the dataset by</span></div><div class="line"><a name="l01250"></a><span class="lineno"> 1250</span>&#160;<span class="comment">     * releasing the GIL. Redis main thread will not touch anything at this</span></div><div class="line"><a name="l01251"></a><span class="lineno"> 1251</span>&#160;<span class="comment">     * time. */</span></div><div class="line"><a name="l01252"></a><span class="lineno"> 1252</span>&#160;    <span class="keywordflow">if</span> (moduleCount()) moduleReleaseGIL();</div><div class="line"><a name="l01253"></a><span class="lineno"> 1253</span>&#160;}</div><div class="line"><a name="l01254"></a><span class="lineno"> 1254</span>&#160;</div><div class="line"><a name="l01255"></a><span class="lineno"> 1255</span>&#160;<span class="comment">/* This function is called immadiately after the event loop multiplexing</span></div><div class="line"><a name="l01256"></a><span class="lineno"> 1256</span>&#160;<span class="comment"> * API returned, and the control is going to soon return to Redis by invoking</span></div><div class="line"><a name="l01257"></a><span class="lineno"> 1257</span>&#160;<span class="comment"> * the different events callbacks. */</span></div><div class="line"><a name="l01258"></a><span class="lineno"> 1258</span>&#160;<span class="keywordtype">void</span> afterSleep(<span class="keyword">struct</span> <a class="code" href="structaeEventLoop.html">aeEventLoop</a> *eventLoop) {</div><div class="line"><a name="l01259"></a><span class="lineno"> 1259</span>&#160;    <a class="code" href="server_8h.html#ae7c9dc8f13568a9c856573751f1ee1ec">UNUSED</a>(eventLoop);</div><div class="line"><a name="l01260"></a><span class="lineno"> 1260</span>&#160;    <span class="keywordflow">if</span> (moduleCount()) moduleAcquireGIL();</div><div class="line"><a name="l01261"></a><span class="lineno"> 1261</span>&#160;}</div><div class="line"><a name="l01262"></a><span class="lineno"> 1262</span>&#160;</div><div class="line"><a name="l01263"></a><span class="lineno"> 1263</span>&#160;<span class="comment">/* =========================== Server initialization ======================== */</span></div><div class="line"><a name="l01264"></a><span class="lineno"> 1264</span>&#160;</div><div class="line"><a name="l01265"></a><span class="lineno"> 1265</span>&#160;<span class="keywordtype">void</span> createSharedObjects(<span class="keywordtype">void</span>) {</div><div class="line"><a name="l01266"></a><span class="lineno"> 1266</span>&#160;    <span class="keywordtype">int</span> j;</div><div class="line"><a name="l01267"></a><span class="lineno"> 1267</span>&#160;</div><div class="line"><a name="l01268"></a><span class="lineno"> 1268</span>&#160;    shared.crlf = createObject(<a class="code" href="server_8h.html#a65236ea160f69cdef33ec942092af88f">OBJ_STRING</a>,sdsnew(<span class="stringliteral">&quot;\r\n&quot;</span>));</div><div class="line"><a name="l01269"></a><span class="lineno"> 1269</span>&#160;    shared.ok = createObject(<a class="code" href="server_8h.html#a65236ea160f69cdef33ec942092af88f">OBJ_STRING</a>,sdsnew(<span class="stringliteral">&quot;+OK\r\n&quot;</span>));</div><div class="line"><a name="l01270"></a><span class="lineno"> 1270</span>&#160;    shared.err = createObject(<a class="code" href="server_8h.html#a65236ea160f69cdef33ec942092af88f">OBJ_STRING</a>,sdsnew(<span class="stringliteral">&quot;-ERR\r\n&quot;</span>));</div><div class="line"><a name="l01271"></a><span class="lineno"> 1271</span>&#160;    shared.emptybulk = createObject(<a class="code" href="server_8h.html#a65236ea160f69cdef33ec942092af88f">OBJ_STRING</a>,sdsnew(<span class="stringliteral">&quot;$0\r\n\r\n&quot;</span>));</div><div class="line"><a name="l01272"></a><span class="lineno"> 1272</span>&#160;    shared.czero = createObject(<a class="code" href="server_8h.html#a65236ea160f69cdef33ec942092af88f">OBJ_STRING</a>,sdsnew(<span class="stringliteral">&quot;:0\r\n&quot;</span>));</div><div class="line"><a name="l01273"></a><span class="lineno"> 1273</span>&#160;    shared.cone = createObject(<a class="code" href="server_8h.html#a65236ea160f69cdef33ec942092af88f">OBJ_STRING</a>,sdsnew(<span class="stringliteral">&quot;:1\r\n&quot;</span>));</div><div class="line"><a name="l01274"></a><span class="lineno"> 1274</span>&#160;    shared.cnegone = createObject(<a class="code" href="server_8h.html#a65236ea160f69cdef33ec942092af88f">OBJ_STRING</a>,sdsnew(<span class="stringliteral">&quot;:-1\r\n&quot;</span>));</div><div class="line"><a name="l01275"></a><span class="lineno"> 1275</span>&#160;    shared.nullbulk = createObject(<a class="code" href="server_8h.html#a65236ea160f69cdef33ec942092af88f">OBJ_STRING</a>,sdsnew(<span class="stringliteral">&quot;$-1\r\n&quot;</span>));</div><div class="line"><a name="l01276"></a><span class="lineno"> 1276</span>&#160;    shared.nullmultibulk = createObject(<a class="code" href="server_8h.html#a65236ea160f69cdef33ec942092af88f">OBJ_STRING</a>,sdsnew(<span class="stringliteral">&quot;*-1\r\n&quot;</span>));</div><div class="line"><a name="l01277"></a><span class="lineno"> 1277</span>&#160;    shared.emptymultibulk = createObject(<a class="code" href="server_8h.html#a65236ea160f69cdef33ec942092af88f">OBJ_STRING</a>,sdsnew(<span class="stringliteral">&quot;*0\r\n&quot;</span>));</div><div class="line"><a name="l01278"></a><span class="lineno"> 1278</span>&#160;    shared.pong = createObject(<a class="code" href="server_8h.html#a65236ea160f69cdef33ec942092af88f">OBJ_STRING</a>,sdsnew(<span class="stringliteral">&quot;+PONG\r\n&quot;</span>));</div><div class="line"><a name="l01279"></a><span class="lineno"> 1279</span>&#160;    shared.queued = createObject(<a class="code" href="server_8h.html#a65236ea160f69cdef33ec942092af88f">OBJ_STRING</a>,sdsnew(<span class="stringliteral">&quot;+QUEUED\r\n&quot;</span>));</div><div class="line"><a name="l01280"></a><span class="lineno"> 1280</span>&#160;    shared.emptyscan = createObject(<a class="code" href="server_8h.html#a65236ea160f69cdef33ec942092af88f">OBJ_STRING</a>,sdsnew(<span class="stringliteral">&quot;*2\r\n$1\r\n0\r\n*0\r\n&quot;</span>));</div><div class="line"><a name="l01281"></a><span class="lineno"> 1281</span>&#160;    shared.wrongtypeerr = createObject(<a class="code" href="server_8h.html#a65236ea160f69cdef33ec942092af88f">OBJ_STRING</a>,sdsnew(</div><div class="line"><a name="l01282"></a><span class="lineno"> 1282</span>&#160;        <span class="stringliteral">&quot;-WRONGTYPE Operation against a key holding the wrong kind of value\r\n&quot;</span>));</div><div class="line"><a name="l01283"></a><span class="lineno"> 1283</span>&#160;    shared.nokeyerr = createObject(<a class="code" href="server_8h.html#a65236ea160f69cdef33ec942092af88f">OBJ_STRING</a>,sdsnew(</div><div class="line"><a name="l01284"></a><span class="lineno"> 1284</span>&#160;        <span class="stringliteral">&quot;-ERR no such key\r\n&quot;</span>));</div><div class="line"><a name="l01285"></a><span class="lineno"> 1285</span>&#160;    shared.syntaxerr = createObject(<a class="code" href="server_8h.html#a65236ea160f69cdef33ec942092af88f">OBJ_STRING</a>,sdsnew(</div><div class="line"><a name="l01286"></a><span class="lineno"> 1286</span>&#160;        <span class="stringliteral">&quot;-ERR syntax error\r\n&quot;</span>));</div><div class="line"><a name="l01287"></a><span class="lineno"> 1287</span>&#160;    shared.sameobjecterr = createObject(<a class="code" href="server_8h.html#a65236ea160f69cdef33ec942092af88f">OBJ_STRING</a>,sdsnew(</div><div class="line"><a name="l01288"></a><span class="lineno"> 1288</span>&#160;        <span class="stringliteral">&quot;-ERR source and destination objects are the same\r\n&quot;</span>));</div><div class="line"><a name="l01289"></a><span class="lineno"> 1289</span>&#160;    shared.outofrangeerr = createObject(<a class="code" href="server_8h.html#a65236ea160f69cdef33ec942092af88f">OBJ_STRING</a>,sdsnew(</div><div class="line"><a name="l01290"></a><span class="lineno"> 1290</span>&#160;        <span class="stringliteral">&quot;-ERR index out of range\r\n&quot;</span>));</div><div class="line"><a name="l01291"></a><span class="lineno"> 1291</span>&#160;    shared.noscripterr = createObject(<a class="code" href="server_8h.html#a65236ea160f69cdef33ec942092af88f">OBJ_STRING</a>,sdsnew(</div><div class="line"><a name="l01292"></a><span class="lineno"> 1292</span>&#160;        <span class="stringliteral">&quot;-NOSCRIPT No matching script. Please use EVAL.\r\n&quot;</span>));</div><div class="line"><a name="l01293"></a><span class="lineno"> 1293</span>&#160;    shared.loadingerr = createObject(<a class="code" href="server_8h.html#a65236ea160f69cdef33ec942092af88f">OBJ_STRING</a>,sdsnew(</div><div class="line"><a name="l01294"></a><span class="lineno"> 1294</span>&#160;        <span class="stringliteral">&quot;-LOADING Redis is loading the dataset in memory\r\n&quot;</span>));</div><div class="line"><a name="l01295"></a><span class="lineno"> 1295</span>&#160;    shared.slowscripterr = createObject(<a class="code" href="server_8h.html#a65236ea160f69cdef33ec942092af88f">OBJ_STRING</a>,sdsnew(</div><div class="line"><a name="l01296"></a><span class="lineno"> 1296</span>&#160;        <span class="stringliteral">&quot;-BUSY Redis is busy running a script. You can only call SCRIPT KILL or SHUTDOWN NOSAVE.\r\n&quot;</span>));</div><div class="line"><a name="l01297"></a><span class="lineno"> 1297</span>&#160;    shared.masterdownerr = createObject(<a class="code" href="server_8h.html#a65236ea160f69cdef33ec942092af88f">OBJ_STRING</a>,sdsnew(</div><div class="line"><a name="l01298"></a><span class="lineno"> 1298</span>&#160;        <span class="stringliteral">&quot;-MASTERDOWN Link with MASTER is down and slave-serve-stale-data is set to &#39;no&#39;.\r\n&quot;</span>));</div><div class="line"><a name="l01299"></a><span class="lineno"> 1299</span>&#160;    shared.bgsaveerr = createObject(<a class="code" href="server_8h.html#a65236ea160f69cdef33ec942092af88f">OBJ_STRING</a>,sdsnew(</div><div class="line"><a name="l01300"></a><span class="lineno"> 1300</span>&#160;        <span class="stringliteral">&quot;-MISCONF Redis is configured to save RDB snapshots, but it is currently not able to persist on disk. Commands that may modify the data set are disabled, because this instance is configured to report errors during writes if RDB snapshotting fails (stop-writes-on-bgsave-error option). Please check the Redis logs for details about the RDB error.\r\n&quot;</span>));</div><div class="line"><a name="l01301"></a><span class="lineno"> 1301</span>&#160;    shared.roslaveerr = createObject(<a class="code" href="server_8h.html#a65236ea160f69cdef33ec942092af88f">OBJ_STRING</a>,sdsnew(</div><div class="line"><a name="l01302"></a><span class="lineno"> 1302</span>&#160;        <span class="stringliteral">&quot;-READONLY You can&#39;t write against a read only slave.\r\n&quot;</span>));</div><div class="line"><a name="l01303"></a><span class="lineno"> 1303</span>&#160;    shared.noautherr = createObject(<a class="code" href="server_8h.html#a65236ea160f69cdef33ec942092af88f">OBJ_STRING</a>,sdsnew(</div><div class="line"><a name="l01304"></a><span class="lineno"> 1304</span>&#160;        <span class="stringliteral">&quot;-NOAUTH Authentication required.\r\n&quot;</span>));</div><div class="line"><a name="l01305"></a><span class="lineno"> 1305</span>&#160;    shared.oomerr = createObject(<a class="code" href="server_8h.html#a65236ea160f69cdef33ec942092af88f">OBJ_STRING</a>,sdsnew(</div><div class="line"><a name="l01306"></a><span class="lineno"> 1306</span>&#160;        <span class="stringliteral">&quot;-OOM command not allowed when used memory &gt; &#39;maxmemory&#39;.\r\n&quot;</span>));</div><div class="line"><a name="l01307"></a><span class="lineno"> 1307</span>&#160;    shared.execaborterr = createObject(<a class="code" href="server_8h.html#a65236ea160f69cdef33ec942092af88f">OBJ_STRING</a>,sdsnew(</div><div class="line"><a name="l01308"></a><span class="lineno"> 1308</span>&#160;        <span class="stringliteral">&quot;-EXECABORT Transaction discarded because of previous errors.\r\n&quot;</span>));</div><div class="line"><a name="l01309"></a><span class="lineno"> 1309</span>&#160;    shared.noreplicaserr = createObject(<a class="code" href="server_8h.html#a65236ea160f69cdef33ec942092af88f">OBJ_STRING</a>,sdsnew(</div><div class="line"><a name="l01310"></a><span class="lineno"> 1310</span>&#160;        <span class="stringliteral">&quot;-NOREPLICAS Not enough good slaves to write.\r\n&quot;</span>));</div><div class="line"><a name="l01311"></a><span class="lineno"> 1311</span>&#160;    shared.busykeyerr = createObject(<a class="code" href="server_8h.html#a65236ea160f69cdef33ec942092af88f">OBJ_STRING</a>,sdsnew(</div><div class="line"><a name="l01312"></a><span class="lineno"> 1312</span>&#160;        <span class="stringliteral">&quot;-BUSYKEY Target key name already exists.\r\n&quot;</span>));</div><div class="line"><a name="l01313"></a><span class="lineno"> 1313</span>&#160;    shared.space = createObject(<a class="code" href="server_8h.html#a65236ea160f69cdef33ec942092af88f">OBJ_STRING</a>,sdsnew(<span class="stringliteral">&quot; &quot;</span>));</div><div class="line"><a name="l01314"></a><span class="lineno"> 1314</span>&#160;    shared.colon = createObject(<a class="code" href="server_8h.html#a65236ea160f69cdef33ec942092af88f">OBJ_STRING</a>,sdsnew(<span class="stringliteral">&quot;:&quot;</span>));</div><div class="line"><a name="l01315"></a><span class="lineno"> 1315</span>&#160;    shared.plus = createObject(<a class="code" href="server_8h.html#a65236ea160f69cdef33ec942092af88f">OBJ_STRING</a>,sdsnew(<span class="stringliteral">&quot;+&quot;</span>));</div><div class="line"><a name="l01316"></a><span class="lineno"> 1316</span>&#160;</div><div class="line"><a name="l01317"></a><span class="lineno"> 1317</span>&#160;    <span class="keywordflow">for</span> (j = 0; j &lt; <a class="code" href="server_8h.html#a950a6acbe9809f9e3dc541e8175b7b44">PROTO_SHARED_SELECT_CMDS</a>; j++) {</div><div class="line"><a name="l01318"></a><span class="lineno"> 1318</span>&#160;        <span class="keywordtype">char</span> dictid_str[64];</div><div class="line"><a name="l01319"></a><span class="lineno"> 1319</span>&#160;        <span class="keywordtype">int</span> dictid_len;</div><div class="line"><a name="l01320"></a><span class="lineno"> 1320</span>&#160;</div><div class="line"><a name="l01321"></a><span class="lineno"> 1321</span>&#160;        dictid_len = ll2string(dictid_str,<span class="keyword">sizeof</span>(dictid_str),j);</div><div class="line"><a name="l01322"></a><span class="lineno"> 1322</span>&#160;        shared.select[j] = createObject(<a class="code" href="server_8h.html#a65236ea160f69cdef33ec942092af88f">OBJ_STRING</a>,</div><div class="line"><a name="l01323"></a><span class="lineno"> 1323</span>&#160;            sdscatprintf(sdsempty(),</div><div class="line"><a name="l01324"></a><span class="lineno"> 1324</span>&#160;                <span class="stringliteral">&quot;*2\r\n$6\r\nSELECT\r\n$%d\r\n%s\r\n&quot;</span>,</div><div class="line"><a name="l01325"></a><span class="lineno"> 1325</span>&#160;                dictid_len, dictid_str));</div><div class="line"><a name="l01326"></a><span class="lineno"> 1326</span>&#160;    }</div><div class="line"><a name="l01327"></a><span class="lineno"> 1327</span>&#160;    shared.messagebulk = createStringObject(<span class="stringliteral">&quot;$7\r\nmessage\r\n&quot;</span>,13);</div><div class="line"><a name="l01328"></a><span class="lineno"> 1328</span>&#160;    shared.pmessagebulk = createStringObject(<span class="stringliteral">&quot;$8\r\npmessage\r\n&quot;</span>,14);</div><div class="line"><a name="l01329"></a><span class="lineno"> 1329</span>&#160;    shared.subscribebulk = createStringObject(<span class="stringliteral">&quot;$9\r\nsubscribe\r\n&quot;</span>,15);</div><div class="line"><a name="l01330"></a><span class="lineno"> 1330</span>&#160;    shared.unsubscribebulk = createStringObject(<span class="stringliteral">&quot;$11\r\nunsubscribe\r\n&quot;</span>,18);</div><div class="line"><a name="l01331"></a><span class="lineno"> 1331</span>&#160;    shared.psubscribebulk = createStringObject(<span class="stringliteral">&quot;$10\r\npsubscribe\r\n&quot;</span>,17);</div><div class="line"><a name="l01332"></a><span class="lineno"> 1332</span>&#160;    shared.punsubscribebulk = createStringObject(<span class="stringliteral">&quot;$12\r\npunsubscribe\r\n&quot;</span>,19);</div><div class="line"><a name="l01333"></a><span class="lineno"> 1333</span>&#160;    shared.del = createStringObject(<span class="stringliteral">&quot;DEL&quot;</span>,3);</div><div class="line"><a name="l01334"></a><span class="lineno"> 1334</span>&#160;    shared.unlink = createStringObject(<span class="stringliteral">&quot;UNLINK&quot;</span>,6);</div><div class="line"><a name="l01335"></a><span class="lineno"> 1335</span>&#160;    shared.rpop = createStringObject(<span class="stringliteral">&quot;RPOP&quot;</span>,4);</div><div class="line"><a name="l01336"></a><span class="lineno"> 1336</span>&#160;    shared.lpop = createStringObject(<span class="stringliteral">&quot;LPOP&quot;</span>,4);</div><div class="line"><a name="l01337"></a><span class="lineno"> 1337</span>&#160;    shared.lpush = createStringObject(<span class="stringliteral">&quot;LPUSH&quot;</span>,5);</div><div class="line"><a name="l01338"></a><span class="lineno"> 1338</span>&#160;    <span class="keywordflow">for</span> (j = 0; j &lt; <a class="code" href="server_8h.html#a311fc8b18b93af94e1ad418f1386b519">OBJ_SHARED_INTEGERS</a>; j++) {</div><div class="line"><a name="l01339"></a><span class="lineno"> 1339</span>&#160;        shared.integers[j] =</div><div class="line"><a name="l01340"></a><span class="lineno"> 1340</span>&#160;            makeObjectShared(createObject(<a class="code" href="server_8h.html#a65236ea160f69cdef33ec942092af88f">OBJ_STRING</a>,(<span class="keywordtype">void</span>*)(<span class="keywordtype">long</span>)j));</div><div class="line"><a name="l01341"></a><span class="lineno"> 1341</span>&#160;        shared.integers[j]-&gt;encoding = <a class="code" href="server_8h.html#ae934cf008a0be0ef009c92c2d006a816">OBJ_ENCODING_INT</a>;</div><div class="line"><a name="l01342"></a><span class="lineno"> 1342</span>&#160;    }</div><div class="line"><a name="l01343"></a><span class="lineno"> 1343</span>&#160;    <span class="keywordflow">for</span> (j = 0; j &lt; <a class="code" href="server_8h.html#aff2f6e62c729d3f8b119d761818be317">OBJ_SHARED_BULKHDR_LEN</a>; j++) {</div><div class="line"><a name="l01344"></a><span class="lineno"> 1344</span>&#160;        shared.mbulkhdr[j] = createObject(<a class="code" href="server_8h.html#a65236ea160f69cdef33ec942092af88f">OBJ_STRING</a>,</div><div class="line"><a name="l01345"></a><span class="lineno"> 1345</span>&#160;            sdscatprintf(sdsempty(),<span class="stringliteral">&quot;*%d\r\n&quot;</span>,j));</div><div class="line"><a name="l01346"></a><span class="lineno"> 1346</span>&#160;        shared.bulkhdr[j] = createObject(<a class="code" href="server_8h.html#a65236ea160f69cdef33ec942092af88f">OBJ_STRING</a>,</div><div class="line"><a name="l01347"></a><span class="lineno"> 1347</span>&#160;            sdscatprintf(sdsempty(),<span class="stringliteral">&quot;$%d\r\n&quot;</span>,j));</div><div class="line"><a name="l01348"></a><span class="lineno"> 1348</span>&#160;    }</div><div class="line"><a name="l01349"></a><span class="lineno"> 1349</span>&#160;    <span class="comment">/* The following two shared objects, minstring and maxstrings, are not</span></div><div class="line"><a name="l01350"></a><span class="lineno"> 1350</span>&#160;<span class="comment">     * actually used for their value but as a special object meaning</span></div><div class="line"><a name="l01351"></a><span class="lineno"> 1351</span>&#160;<span class="comment">     * respectively the minimum possible string and the maximum possible</span></div><div class="line"><a name="l01352"></a><span class="lineno"> 1352</span>&#160;<span class="comment">     * string in string comparisons for the ZRANGEBYLEX command. */</span></div><div class="line"><a name="l01353"></a><span class="lineno"> 1353</span>&#160;    shared.minstring = sdsnew(<span class="stringliteral">&quot;minstring&quot;</span>);</div><div class="line"><a name="l01354"></a><span class="lineno"> 1354</span>&#160;    shared.maxstring = sdsnew(<span class="stringliteral">&quot;maxstring&quot;</span>);</div><div class="line"><a name="l01355"></a><span class="lineno"> 1355</span>&#160;}</div><div class="line"><a name="l01356"></a><span class="lineno"> 1356</span>&#160;</div><div class="line"><a name="l01357"></a><span class="lineno"> 1357</span>&#160;<span class="keywordtype">void</span> initServerConfig(<span class="keywordtype">void</span>) {</div><div class="line"><a name="l01358"></a><span class="lineno"> 1358</span>&#160;    <span class="keywordtype">int</span> j;</div><div class="line"><a name="l01359"></a><span class="lineno"> 1359</span>&#160;</div><div class="line"><a name="l01360"></a><span class="lineno"> 1360</span>&#160;    pthread_mutex_init(&amp;server.next_client_id_mutex,NULL);</div><div class="line"><a name="l01361"></a><span class="lineno"> 1361</span>&#160;    pthread_mutex_init(&amp;server.lruclock_mutex,NULL);</div><div class="line"><a name="l01362"></a><span class="lineno"> 1362</span>&#160;    pthread_mutex_init(&amp;server.unixtime_mutex,NULL);</div><div class="line"><a name="l01363"></a><span class="lineno"> 1363</span>&#160;</div><div class="line"><a name="l01364"></a><span class="lineno"> 1364</span>&#160;    getRandomHexChars(server.runid,<a class="code" href="server_8h.html#aba6794fa3ee28f85165eaed93190f1df">CONFIG_RUN_ID_SIZE</a>);</div><div class="line"><a name="l01365"></a><span class="lineno"> 1365</span>&#160;    server.runid[<a class="code" href="server_8h.html#aba6794fa3ee28f85165eaed93190f1df">CONFIG_RUN_ID_SIZE</a>] = <span class="stringliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l01366"></a><span class="lineno"> 1366</span>&#160;    changeReplicationId();</div><div class="line"><a name="l01367"></a><span class="lineno"> 1367</span>&#160;    clearReplicationId2();</div><div class="line"><a name="l01368"></a><span class="lineno"> 1368</span>&#160;    server.configfile = NULL;</div><div class="line"><a name="l01369"></a><span class="lineno"> 1369</span>&#160;    server.executable = NULL;</div><div class="line"><a name="l01370"></a><span class="lineno"> 1370</span>&#160;    server.hz = <a class="code" href="server_8h.html#aa5a3b127e21d6bf089025d953c44678a">CONFIG_DEFAULT_HZ</a>;</div><div class="line"><a name="l01371"></a><span class="lineno"> 1371</span>&#160;    server.arch_bits = (<span class="keyword">sizeof</span>(<span class="keywordtype">long</span>) == 8) ? 64 : 32;</div><div class="line"><a name="l01372"></a><span class="lineno"> 1372</span>&#160;    server.port = <a class="code" href="server_8h.html#afc9f3396e2da1194ef2ccc6ab97d4e3d">CONFIG_DEFAULT_SERVER_PORT</a>;</div><div class="line"><a name="l01373"></a><span class="lineno"> 1373</span>&#160;    server.tcp_backlog = <a class="code" href="server_8h.html#ab85c155ec2652313a561af139fdb5575">CONFIG_DEFAULT_TCP_BACKLOG</a>;</div><div class="line"><a name="l01374"></a><span class="lineno"> 1374</span>&#160;    server.bindaddr_count = 0;</div><div class="line"><a name="l01375"></a><span class="lineno"> 1375</span>&#160;    server.unixsocket = NULL;</div><div class="line"><a name="l01376"></a><span class="lineno"> 1376</span>&#160;    server.unixsocketperm = <a class="code" href="server_8h.html#a486eb6d6b0e44a772877112dbd928494">CONFIG_DEFAULT_UNIX_SOCKET_PERM</a>;</div><div class="line"><a name="l01377"></a><span class="lineno"> 1377</span>&#160;    server.ipfd_count = 0;</div><div class="line"><a name="l01378"></a><span class="lineno"> 1378</span>&#160;    server.sofd = -1;</div><div class="line"><a name="l01379"></a><span class="lineno"> 1379</span>&#160;    server.protected_mode = <a class="code" href="server_8h.html#aa84cedc4d9e3da82d28324a85626a666">CONFIG_DEFAULT_PROTECTED_MODE</a>;</div><div class="line"><a name="l01380"></a><span class="lineno"> 1380</span>&#160;    server.dbnum = <a class="code" href="server_8h.html#abc5ff12d4e9b662f85d2cb11a0220926">CONFIG_DEFAULT_DBNUM</a>;</div><div class="line"><a name="l01381"></a><span class="lineno"> 1381</span>&#160;    server.verbosity = <a class="code" href="server_8h.html#a407337e4d193cc8fc965938b7a247240">CONFIG_DEFAULT_VERBOSITY</a>;</div><div class="line"><a name="l01382"></a><span class="lineno"> 1382</span>&#160;    server.maxidletime = <a class="code" href="server_8h.html#a1d6ca2cad092805de3acd7b74876a323">CONFIG_DEFAULT_CLIENT_TIMEOUT</a>;</div><div class="line"><a name="l01383"></a><span class="lineno"> 1383</span>&#160;    server.tcpkeepalive = <a class="code" href="server_8h.html#a2c8d2290c3ac70d63ed2e62b11ab566b">CONFIG_DEFAULT_TCP_KEEPALIVE</a>;</div><div class="line"><a name="l01384"></a><span class="lineno"> 1384</span>&#160;    server.active_expire_enabled = 1;</div><div class="line"><a name="l01385"></a><span class="lineno"> 1385</span>&#160;    server.active_defrag_enabled = <a class="code" href="server_8h.html#a7bc03a080189821c8c88b31027281d4b">CONFIG_DEFAULT_ACTIVE_DEFRAG</a>;</div><div class="line"><a name="l01386"></a><span class="lineno"> 1386</span>&#160;    server.active_defrag_ignore_bytes = <a class="code" href="server_8h.html#aed98ddd341b643d52417b875418b2ecb">CONFIG_DEFAULT_DEFRAG_IGNORE_BYTES</a>;</div><div class="line"><a name="l01387"></a><span class="lineno"> 1387</span>&#160;    server.active_defrag_threshold_lower = <a class="code" href="server_8h.html#a9d23ea1ff80f9db5faef6f5aca6f76aa">CONFIG_DEFAULT_DEFRAG_THRESHOLD_LOWER</a>;</div><div class="line"><a name="l01388"></a><span class="lineno"> 1388</span>&#160;    server.active_defrag_threshold_upper = <a class="code" href="server_8h.html#a75b8ce2fafb93ddeb96f0e5602c2bd0c">CONFIG_DEFAULT_DEFRAG_THRESHOLD_UPPER</a>;</div><div class="line"><a name="l01389"></a><span class="lineno"> 1389</span>&#160;    server.active_defrag_cycle_min = <a class="code" href="server_8h.html#a5d49d5c9a11564577f7e78d6f52d9db5">CONFIG_DEFAULT_DEFRAG_CYCLE_MIN</a>;</div><div class="line"><a name="l01390"></a><span class="lineno"> 1390</span>&#160;    server.active_defrag_cycle_max = <a class="code" href="server_8h.html#ac3f69c7e78a189639eab66a2b32753d0">CONFIG_DEFAULT_DEFRAG_CYCLE_MAX</a>;</div><div class="line"><a name="l01391"></a><span class="lineno"> 1391</span>&#160;    server.client_max_querybuf_len = <a class="code" href="server_8h.html#a395f766c5962e4ee2da01dee43600f7a">PROTO_MAX_QUERYBUF_LEN</a>;</div><div class="line"><a name="l01392"></a><span class="lineno"> 1392</span>&#160;    server.saveparams = NULL;</div><div class="line"><a name="l01393"></a><span class="lineno"> 1393</span>&#160;    server.loading = 0;</div><div class="line"><a name="l01394"></a><span class="lineno"> 1394</span>&#160;    server.logfile = zstrdup(<a class="code" href="server_8h.html#a0698b50ff7fe51afd74cf20a72b75e1b">CONFIG_DEFAULT_LOGFILE</a>);</div><div class="line"><a name="l01395"></a><span class="lineno"> 1395</span>&#160;    server.syslog_enabled = <a class="code" href="server_8h.html#a22c57e53d530d95ae346f13d6781a549">CONFIG_DEFAULT_SYSLOG_ENABLED</a>;</div><div class="line"><a name="l01396"></a><span class="lineno"> 1396</span>&#160;    server.syslog_ident = zstrdup(<a class="code" href="server_8h.html#ac7414291a371fd3a2bad4d34e13f0d77">CONFIG_DEFAULT_SYSLOG_IDENT</a>);</div><div class="line"><a name="l01397"></a><span class="lineno"> 1397</span>&#160;    server.syslog_facility = LOG_LOCAL0;</div><div class="line"><a name="l01398"></a><span class="lineno"> 1398</span>&#160;    server.daemonize = <a class="code" href="server_8h.html#a1783425a4095949ab8b23ae4cbe0e576">CONFIG_DEFAULT_DAEMONIZE</a>;</div><div class="line"><a name="l01399"></a><span class="lineno"> 1399</span>&#160;    server.supervised = 0;</div><div class="line"><a name="l01400"></a><span class="lineno"> 1400</span>&#160;    server.supervised_mode = <a class="code" href="server_8h.html#a2a0d6ba64b419357e52a6473f48bc882">SUPERVISED_NONE</a>;</div><div class="line"><a name="l01401"></a><span class="lineno"> 1401</span>&#160;    server.aof_state = <a class="code" href="server_8h.html#a5226306fbcebcb6d5d02e0fef3c213c2">AOF_OFF</a>;</div><div class="line"><a name="l01402"></a><span class="lineno"> 1402</span>&#160;    server.<a class="code" href="config_8h.html#af5994c643c434574580bb7816af82cad">aof_fsync</a> = <a class="code" href="server_8h.html#af07bcc4b15ed4f7aed3f6efcb483b75b">CONFIG_DEFAULT_AOF_FSYNC</a>;</div><div class="line"><a name="l01403"></a><span class="lineno"> 1403</span>&#160;    server.aof_no_fsync_on_rewrite = <a class="code" href="server_8h.html#a9b588e3803fff7fe515f20d7bc4aa8e6">CONFIG_DEFAULT_AOF_NO_FSYNC_ON_REWRITE</a>;</div><div class="line"><a name="l01404"></a><span class="lineno"> 1404</span>&#160;    server.aof_rewrite_perc = <a class="code" href="server_8h.html#a85f5870a07f58d1679988f7eb84ca995">AOF_REWRITE_PERC</a>;</div><div class="line"><a name="l01405"></a><span class="lineno"> 1405</span>&#160;    server.aof_rewrite_min_size = <a class="code" href="server_8h.html#a9b5a91047aa18eb5df52e99c97afab84">AOF_REWRITE_MIN_SIZE</a>;</div><div class="line"><a name="l01406"></a><span class="lineno"> 1406</span>&#160;    server.aof_rewrite_base_size = 0;</div><div class="line"><a name="l01407"></a><span class="lineno"> 1407</span>&#160;    server.aof_rewrite_scheduled = 0;</div><div class="line"><a name="l01408"></a><span class="lineno"> 1408</span>&#160;    server.aof_last_fsync = time(NULL);</div><div class="line"><a name="l01409"></a><span class="lineno"> 1409</span>&#160;    server.aof_rewrite_time_last = -1;</div><div class="line"><a name="l01410"></a><span class="lineno"> 1410</span>&#160;    server.aof_rewrite_time_start = -1;</div><div class="line"><a name="l01411"></a><span class="lineno"> 1411</span>&#160;    server.aof_lastbgrewrite_status = <a class="code" href="server_8h.html#a303769ef1065076e68731584e758d3e1">C_OK</a>;</div><div class="line"><a name="l01412"></a><span class="lineno"> 1412</span>&#160;    server.aof_delayed_fsync = 0;</div><div class="line"><a name="l01413"></a><span class="lineno"> 1413</span>&#160;    server.aof_fd = -1;</div><div class="line"><a name="l01414"></a><span class="lineno"> 1414</span>&#160;    server.aof_selected_db = -1; <span class="comment">/* Make sure the first time will not match */</span></div><div class="line"><a name="l01415"></a><span class="lineno"> 1415</span>&#160;    server.aof_flush_postponed_start = 0;</div><div class="line"><a name="l01416"></a><span class="lineno"> 1416</span>&#160;    server.aof_rewrite_incremental_fsync = <a class="code" href="server_8h.html#a356d1b1e39a75671cc55fdaf64be3a85">CONFIG_DEFAULT_AOF_REWRITE_INCREMENTAL_FSYNC</a>;</div><div class="line"><a name="l01417"></a><span class="lineno"> 1417</span>&#160;    server.aof_load_truncated = <a class="code" href="server_8h.html#a35b94be7201c7ad80e43f8aa214867b7">CONFIG_DEFAULT_AOF_LOAD_TRUNCATED</a>;</div><div class="line"><a name="l01418"></a><span class="lineno"> 1418</span>&#160;    server.aof_use_rdb_preamble = <a class="code" href="server_8h.html#a938328826b94d0e9bd07b225767cad43">CONFIG_DEFAULT_AOF_USE_RDB_PREAMBLE</a>;</div><div class="line"><a name="l01419"></a><span class="lineno"> 1419</span>&#160;    server.pidfile = NULL;</div><div class="line"><a name="l01420"></a><span class="lineno"> 1420</span>&#160;    server.rdb_filename = zstrdup(<a class="code" href="server_8h.html#af563e9454f9a1ef49de787e4fc66c448">CONFIG_DEFAULT_RDB_FILENAME</a>);</div><div class="line"><a name="l01421"></a><span class="lineno"> 1421</span>&#160;    server.aof_filename = zstrdup(<a class="code" href="server_8h.html#af3bada72076c951a9d5959e73456635a">CONFIG_DEFAULT_AOF_FILENAME</a>);</div><div class="line"><a name="l01422"></a><span class="lineno"> 1422</span>&#160;    server.requirepass = NULL;</div><div class="line"><a name="l01423"></a><span class="lineno"> 1423</span>&#160;    server.rdb_compression = <a class="code" href="server_8h.html#a250e4ab3a143ecbce2603ffaa3a29c0a">CONFIG_DEFAULT_RDB_COMPRESSION</a>;</div><div class="line"><a name="l01424"></a><span class="lineno"> 1424</span>&#160;    server.rdb_checksum = <a class="code" href="server_8h.html#a549382a72b7490f18a44f03e2dbe5568">CONFIG_DEFAULT_RDB_CHECKSUM</a>;</div><div class="line"><a name="l01425"></a><span class="lineno"> 1425</span>&#160;    server.stop_writes_on_bgsave_err = <a class="code" href="server_8h.html#a050e337ffdb94f18e190cc6d6d851196">CONFIG_DEFAULT_STOP_WRITES_ON_BGSAVE_ERROR</a>;</div><div class="line"><a name="l01426"></a><span class="lineno"> 1426</span>&#160;    server.activerehashing = <a class="code" href="server_8h.html#a147863f3b338d25f54e026d88a487010">CONFIG_DEFAULT_ACTIVE_REHASHING</a>;</div><div class="line"><a name="l01427"></a><span class="lineno"> 1427</span>&#160;    server.active_defrag_running = 0;</div><div class="line"><a name="l01428"></a><span class="lineno"> 1428</span>&#160;    server.notify_keyspace_events = 0;</div><div class="line"><a name="l01429"></a><span class="lineno"> 1429</span>&#160;    server.maxclients = <a class="code" href="server_8h.html#ab24065d7a9205264189681ab4e4d410e">CONFIG_DEFAULT_MAX_CLIENTS</a>;</div><div class="line"><a name="l01430"></a><span class="lineno"> 1430</span>&#160;    server.blocked_clients = 0;</div><div class="line"><a name="l01431"></a><span class="lineno"> 1431</span>&#160;    memset(server.blocked_clients_by_type,0,</div><div class="line"><a name="l01432"></a><span class="lineno"> 1432</span>&#160;           <span class="keyword">sizeof</span>(server.blocked_clients_by_type));</div><div class="line"><a name="l01433"></a><span class="lineno"> 1433</span>&#160;    server.maxmemory = <a class="code" href="server_8h.html#a314eacfa28e22254ee8cc05f2b257281">CONFIG_DEFAULT_MAXMEMORY</a>;</div><div class="line"><a name="l01434"></a><span class="lineno"> 1434</span>&#160;    server.maxmemory_policy = <a class="code" href="server_8h.html#a5b8590d1c7aa090e48b9506c0842d206">CONFIG_DEFAULT_MAXMEMORY_POLICY</a>;</div><div class="line"><a name="l01435"></a><span class="lineno"> 1435</span>&#160;    server.maxmemory_samples = <a class="code" href="server_8h.html#a38e65004c240be8a04ab492731c7da50">CONFIG_DEFAULT_MAXMEMORY_SAMPLES</a>;</div><div class="line"><a name="l01436"></a><span class="lineno"> 1436</span>&#160;    server.lfu_log_factor = <a class="code" href="server_8h.html#ab343786c44a1885885a1ac254b724317">CONFIG_DEFAULT_LFU_LOG_FACTOR</a>;</div><div class="line"><a name="l01437"></a><span class="lineno"> 1437</span>&#160;    server.lfu_decay_time = <a class="code" href="server_8h.html#a24a132a96a693133fc057a491080aebf">CONFIG_DEFAULT_LFU_DECAY_TIME</a>;</div><div class="line"><a name="l01438"></a><span class="lineno"> 1438</span>&#160;    server.hash_max_ziplist_entries = <a class="code" href="server_8h.html#a41a8473748a5eeafbd30b20f22177c51">OBJ_HASH_MAX_ZIPLIST_ENTRIES</a>;</div><div class="line"><a name="l01439"></a><span class="lineno"> 1439</span>&#160;    server.hash_max_ziplist_value = <a class="code" href="server_8h.html#a63842e277a2ccef80f42cbae07c9f5d8">OBJ_HASH_MAX_ZIPLIST_VALUE</a>;</div><div class="line"><a name="l01440"></a><span class="lineno"> 1440</span>&#160;    server.list_max_ziplist_size = <a class="code" href="server_8h.html#a27c7e814708df2c7eed37fbc6ac0b7f1">OBJ_LIST_MAX_ZIPLIST_SIZE</a>;</div><div class="line"><a name="l01441"></a><span class="lineno"> 1441</span>&#160;    server.list_compress_depth = <a class="code" href="server_8h.html#a7b811522f7befdc10e69883f360e45b4">OBJ_LIST_COMPRESS_DEPTH</a>;</div><div class="line"><a name="l01442"></a><span class="lineno"> 1442</span>&#160;    server.set_max_intset_entries = <a class="code" href="server_8h.html#a333fe7f520eb6f33cd1c88e4691de3ed">OBJ_SET_MAX_INTSET_ENTRIES</a>;</div><div class="line"><a name="l01443"></a><span class="lineno"> 1443</span>&#160;    server.zset_max_ziplist_entries = <a class="code" href="server_8h.html#ac29d7218c448fac5b27039cf0d73fde2">OBJ_ZSET_MAX_ZIPLIST_ENTRIES</a>;</div><div class="line"><a name="l01444"></a><span class="lineno"> 1444</span>&#160;    server.zset_max_ziplist_value = <a class="code" href="server_8h.html#a24b004e72489e83f721bdd334234aa49">OBJ_ZSET_MAX_ZIPLIST_VALUE</a>;</div><div class="line"><a name="l01445"></a><span class="lineno"> 1445</span>&#160;    server.hll_sparse_max_bytes = <a class="code" href="server_8h.html#a479f69398ffb0f86fdbb4fa03876bc69">CONFIG_DEFAULT_HLL_SPARSE_MAX_BYTES</a>;</div><div class="line"><a name="l01446"></a><span class="lineno"> 1446</span>&#160;    server.shutdown_asap = 0;</div><div class="line"><a name="l01447"></a><span class="lineno"> 1447</span>&#160;    server.cluster_enabled = 0;</div><div class="line"><a name="l01448"></a><span class="lineno"> 1448</span>&#160;    server.cluster_node_timeout = <a class="code" href="cluster_8h.html#acb94b0516dcfb9814e13dfe97f3ad6b1">CLUSTER_DEFAULT_NODE_TIMEOUT</a>;</div><div class="line"><a name="l01449"></a><span class="lineno"> 1449</span>&#160;    server.cluster_migration_barrier = <a class="code" href="cluster_8h.html#a1895138f4125c5dce77e8fe28c9bd8d1">CLUSTER_DEFAULT_MIGRATION_BARRIER</a>;</div><div class="line"><a name="l01450"></a><span class="lineno"> 1450</span>&#160;    server.cluster_slave_validity_factor = <a class="code" href="cluster_8h.html#a44b183827017eca27648d5991fc50b13">CLUSTER_DEFAULT_SLAVE_VALIDITY</a>;</div><div class="line"><a name="l01451"></a><span class="lineno"> 1451</span>&#160;    server.cluster_require_full_coverage = <a class="code" href="cluster_8h.html#aa27e3466414a1464e6f2721b8872827d">CLUSTER_DEFAULT_REQUIRE_FULL_COVERAGE</a>;</div><div class="line"><a name="l01452"></a><span class="lineno"> 1452</span>&#160;    server.cluster_configfile = zstrdup(<a class="code" href="server_8h.html#a5b0c46fd63529819e2c0189003d72122">CONFIG_DEFAULT_CLUSTER_CONFIG_FILE</a>);</div><div class="line"><a name="l01453"></a><span class="lineno"> 1453</span>&#160;    server.cluster_announce_ip = <a class="code" href="server_8h.html#a0b8729bdfd537311480f4c3bb3a20905">CONFIG_DEFAULT_CLUSTER_ANNOUNCE_IP</a>;</div><div class="line"><a name="l01454"></a><span class="lineno"> 1454</span>&#160;    server.cluster_announce_port = <a class="code" href="server_8h.html#ac55c8423c202c1f0b4e786eb70adefb3">CONFIG_DEFAULT_CLUSTER_ANNOUNCE_PORT</a>;</div><div class="line"><a name="l01455"></a><span class="lineno"> 1455</span>&#160;    server.cluster_announce_bus_port = <a class="code" href="server_8h.html#a86d6a82bc81e718079728c3cb6c8c5b4">CONFIG_DEFAULT_CLUSTER_ANNOUNCE_BUS_PORT</a>;</div><div class="line"><a name="l01456"></a><span class="lineno"> 1456</span>&#160;    server.migrate_cached_sockets = dictCreate(&amp;migrateCacheDictType,NULL);</div><div class="line"><a name="l01457"></a><span class="lineno"> 1457</span>&#160;    server.next_client_id = 1; <span class="comment">/* Client IDs, start from 1 .*/</span></div><div class="line"><a name="l01458"></a><span class="lineno"> 1458</span>&#160;    server.loading_process_events_interval_bytes = (1024*1024*2);</div><div class="line"><a name="l01459"></a><span class="lineno"> 1459</span>&#160;    server.lazyfree_lazy_eviction = <a class="code" href="server_8h.html#aa6529c6ba7143b1ec4aa15d8a96b2154">CONFIG_DEFAULT_LAZYFREE_LAZY_EVICTION</a>;</div><div class="line"><a name="l01460"></a><span class="lineno"> 1460</span>&#160;    server.lazyfree_lazy_expire = <a class="code" href="server_8h.html#a2e6080731ab6e81b19f1bfedf7b298f9">CONFIG_DEFAULT_LAZYFREE_LAZY_EXPIRE</a>;</div><div class="line"><a name="l01461"></a><span class="lineno"> 1461</span>&#160;    server.lazyfree_lazy_server_del = <a class="code" href="server_8h.html#ac1f765315b576de4c0ea2beb7e37ae02">CONFIG_DEFAULT_LAZYFREE_LAZY_SERVER_DEL</a>;</div><div class="line"><a name="l01462"></a><span class="lineno"> 1462</span>&#160;    server.always_show_logo = <a class="code" href="server_8h.html#a0f350070473d6d89bcd365ea4ff361cb">CONFIG_DEFAULT_ALWAYS_SHOW_LOGO</a>;</div><div class="line"><a name="l01463"></a><span class="lineno"> 1463</span>&#160;    server.lua_time_limit = <a class="code" href="server_8h.html#ab72fac70fbc902a7f106f4c710e08271">LUA_SCRIPT_TIME_LIMIT</a>;</div><div class="line"><a name="l01464"></a><span class="lineno"> 1464</span>&#160;</div><div class="line"><a name="l01465"></a><span class="lineno"> 1465</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> lruclock = getLRUClock();</div><div class="line"><a name="l01466"></a><span class="lineno"> 1466</span>&#160;    <a class="code" href="atomicvar_8h.html#a0f02b5846dcf4ed3669ecf771c512d12">atomicSet</a>(server.lruclock,lruclock);</div><div class="line"><a name="l01467"></a><span class="lineno"> 1467</span>&#160;    resetServerSaveParams();</div><div class="line"><a name="l01468"></a><span class="lineno"> 1468</span>&#160;</div><div class="line"><a name="l01469"></a><span class="lineno"> 1469</span>&#160;    appendServerSaveParams(60*60,1);  <span class="comment">/* save after 1 hour and 1 change */</span></div><div class="line"><a name="l01470"></a><span class="lineno"> 1470</span>&#160;    appendServerSaveParams(300,100);  <span class="comment">/* save after 5 minutes and 100 changes */</span></div><div class="line"><a name="l01471"></a><span class="lineno"> 1471</span>&#160;    appendServerSaveParams(60,10000); <span class="comment">/* save after 1 minute and 10000 changes */</span></div><div class="line"><a name="l01472"></a><span class="lineno"> 1472</span>&#160;</div><div class="line"><a name="l01473"></a><span class="lineno"> 1473</span>&#160;    <span class="comment">/* Replication related */</span></div><div class="line"><a name="l01474"></a><span class="lineno"> 1474</span>&#160;    server.masterauth = NULL;</div><div class="line"><a name="l01475"></a><span class="lineno"> 1475</span>&#160;    server.masterhost = NULL;</div><div class="line"><a name="l01476"></a><span class="lineno"> 1476</span>&#160;    server.masterport = 6379;</div><div class="line"><a name="l01477"></a><span class="lineno"> 1477</span>&#160;    server.master = NULL;</div><div class="line"><a name="l01478"></a><span class="lineno"> 1478</span>&#160;    server.cached_master = NULL;</div><div class="line"><a name="l01479"></a><span class="lineno"> 1479</span>&#160;    server.master_initial_offset = -1;</div><div class="line"><a name="l01480"></a><span class="lineno"> 1480</span>&#160;    server.repl_state = <a class="code" href="server_8h.html#a256b9506e551eaa7417f75f8fa9ed901">REPL_STATE_NONE</a>;</div><div class="line"><a name="l01481"></a><span class="lineno"> 1481</span>&#160;    server.repl_syncio_timeout = <a class="code" href="server_8h.html#a68ad9c6e5f817d58fa51c1b2e88e83e0">CONFIG_REPL_SYNCIO_TIMEOUT</a>;</div><div class="line"><a name="l01482"></a><span class="lineno"> 1482</span>&#160;    server.repl_serve_stale_data = <a class="code" href="server_8h.html#ab42b23884952f9887529b6efbf0d4ac6">CONFIG_DEFAULT_SLAVE_SERVE_STALE_DATA</a>;</div><div class="line"><a name="l01483"></a><span class="lineno"> 1483</span>&#160;    server.repl_slave_ro = <a class="code" href="server_8h.html#af9b93e225d47183c97bc1f86db1aff2a">CONFIG_DEFAULT_SLAVE_READ_ONLY</a>;</div><div class="line"><a name="l01484"></a><span class="lineno"> 1484</span>&#160;    server.repl_slave_lazy_flush = <a class="code" href="server_8h.html#ace54c14c3b13acbf1d7a6d6e893cdfd3">CONFIG_DEFAULT_SLAVE_LAZY_FLUSH</a>;</div><div class="line"><a name="l01485"></a><span class="lineno"> 1485</span>&#160;    server.repl_down_since = 0; <span class="comment">/* Never connected, repl is down since EVER. */</span></div><div class="line"><a name="l01486"></a><span class="lineno"> 1486</span>&#160;    server.repl_disable_tcp_nodelay = <a class="code" href="server_8h.html#a27f51044a8a11ab99366a77bb3ea1e93">CONFIG_DEFAULT_REPL_DISABLE_TCP_NODELAY</a>;</div><div class="line"><a name="l01487"></a><span class="lineno"> 1487</span>&#160;    server.repl_diskless_sync = <a class="code" href="server_8h.html#a08ebaf972da18ad58c71c615aa26c5cf">CONFIG_DEFAULT_REPL_DISKLESS_SYNC</a>;</div><div class="line"><a name="l01488"></a><span class="lineno"> 1488</span>&#160;    server.repl_diskless_sync_delay = <a class="code" href="server_8h.html#aee54cf0e2819c8b96136987f0f8ef0b8">CONFIG_DEFAULT_REPL_DISKLESS_SYNC_DELAY</a>;</div><div class="line"><a name="l01489"></a><span class="lineno"> 1489</span>&#160;    server.repl_ping_slave_period = <a class="code" href="server_8h.html#a5496312872886690751d1e4a248026e9">CONFIG_DEFAULT_REPL_PING_SLAVE_PERIOD</a>;</div><div class="line"><a name="l01490"></a><span class="lineno"> 1490</span>&#160;    server.repl_timeout = <a class="code" href="server_8h.html#a7608d2301c8447e2237ba173d8eef88e">CONFIG_DEFAULT_REPL_TIMEOUT</a>;</div><div class="line"><a name="l01491"></a><span class="lineno"> 1491</span>&#160;    server.repl_min_slaves_to_write = <a class="code" href="server_8h.html#a68661cd596afb7595059264beee63dc7">CONFIG_DEFAULT_MIN_SLAVES_TO_WRITE</a>;</div><div class="line"><a name="l01492"></a><span class="lineno"> 1492</span>&#160;    server.repl_min_slaves_max_lag = <a class="code" href="server_8h.html#a547664770d2cec2d58d144a2f5afbbd8">CONFIG_DEFAULT_MIN_SLAVES_MAX_LAG</a>;</div><div class="line"><a name="l01493"></a><span class="lineno"> 1493</span>&#160;    server.slave_priority = <a class="code" href="server_8h.html#a7effaf912f26a1eabe495e899d705fee">CONFIG_DEFAULT_SLAVE_PRIORITY</a>;</div><div class="line"><a name="l01494"></a><span class="lineno"> 1494</span>&#160;    server.slave_announce_ip = <a class="code" href="server_8h.html#aca61db3dff4f6e864b3e49d3f087fb51">CONFIG_DEFAULT_SLAVE_ANNOUNCE_IP</a>;</div><div class="line"><a name="l01495"></a><span class="lineno"> 1495</span>&#160;    server.slave_announce_port = <a class="code" href="server_8h.html#ac8ad217da6cfbdf399948aff4d3550ca">CONFIG_DEFAULT_SLAVE_ANNOUNCE_PORT</a>;</div><div class="line"><a name="l01496"></a><span class="lineno"> 1496</span>&#160;    server.master_repl_offset = 0;</div><div class="line"><a name="l01497"></a><span class="lineno"> 1497</span>&#160;</div><div class="line"><a name="l01498"></a><span class="lineno"> 1498</span>&#160;    <span class="comment">/* Replication partial resync backlog */</span></div><div class="line"><a name="l01499"></a><span class="lineno"> 1499</span>&#160;    server.repl_backlog = NULL;</div><div class="line"><a name="l01500"></a><span class="lineno"> 1500</span>&#160;    server.repl_backlog_size = <a class="code" href="server_8h.html#a6ac2fd3dd83df43a6b262bab091bc371">CONFIG_DEFAULT_REPL_BACKLOG_SIZE</a>;</div><div class="line"><a name="l01501"></a><span class="lineno"> 1501</span>&#160;    server.repl_backlog_histlen = 0;</div><div class="line"><a name="l01502"></a><span class="lineno"> 1502</span>&#160;    server.repl_backlog_idx = 0;</div><div class="line"><a name="l01503"></a><span class="lineno"> 1503</span>&#160;    server.repl_backlog_off = 0;</div><div class="line"><a name="l01504"></a><span class="lineno"> 1504</span>&#160;    server.repl_backlog_time_limit = <a class="code" href="server_8h.html#ac5c5c62f45277671484daad919338b5e">CONFIG_DEFAULT_REPL_BACKLOG_TIME_LIMIT</a>;</div><div class="line"><a name="l01505"></a><span class="lineno"> 1505</span>&#160;    server.repl_no_slaves_since = time(NULL);</div><div class="line"><a name="l01506"></a><span class="lineno"> 1506</span>&#160;</div><div class="line"><a name="l01507"></a><span class="lineno"> 1507</span>&#160;    <span class="comment">/* Client output buffer limits */</span></div><div class="line"><a name="l01508"></a><span class="lineno"> 1508</span>&#160;    <span class="keywordflow">for</span> (j = 0; j &lt; <a class="code" href="server_8h.html#aea8f6f3fac3a68e35807eba109dbc501">CLIENT_TYPE_OBUF_COUNT</a>; j++)</div><div class="line"><a name="l01509"></a><span class="lineno"> 1509</span>&#160;        server.client_obuf_limits[j] = clientBufferLimitsDefaults[j];</div><div class="line"><a name="l01510"></a><span class="lineno"> 1510</span>&#160;</div><div class="line"><a name="l01511"></a><span class="lineno"> 1511</span>&#160;    <span class="comment">/* Double constants initialization */</span></div><div class="line"><a name="l01512"></a><span class="lineno"> 1512</span>&#160;    R_Zero = 0.0;</div><div class="line"><a name="l01513"></a><span class="lineno"> 1513</span>&#160;    R_PosInf = 1.0/R_Zero;</div><div class="line"><a name="l01514"></a><span class="lineno"> 1514</span>&#160;    R_NegInf = -1.0/R_Zero;</div><div class="line"><a name="l01515"></a><span class="lineno"> 1515</span>&#160;    R_Nan = R_Zero/R_Zero;</div><div class="line"><a name="l01516"></a><span class="lineno"> 1516</span>&#160;</div><div class="line"><a name="l01517"></a><span class="lineno"> 1517</span>&#160;    <span class="comment">/* Command table -- we initiialize it here as it is part of the</span></div><div class="line"><a name="l01518"></a><span class="lineno"> 1518</span>&#160;<span class="comment">     * initial configuration, since command names may be changed via</span></div><div class="line"><a name="l01519"></a><span class="lineno"> 1519</span>&#160;<span class="comment">     * redis.conf using the rename-command directive. */</span></div><div class="line"><a name="l01520"></a><span class="lineno"> 1520</span>&#160;    server.commands = dictCreate(&amp;commandTableDictType,NULL);</div><div class="line"><a name="l01521"></a><span class="lineno"> 1521</span>&#160;    server.orig_commands = dictCreate(&amp;commandTableDictType,NULL);</div><div class="line"><a name="l01522"></a><span class="lineno"> 1522</span>&#160;    populateCommandTable();</div><div class="line"><a name="l01523"></a><span class="lineno"> 1523</span>&#160;    server.delCommand = lookupCommandByCString(<span class="stringliteral">&quot;del&quot;</span>);</div><div class="line"><a name="l01524"></a><span class="lineno"> 1524</span>&#160;    server.multiCommand = lookupCommandByCString(<span class="stringliteral">&quot;multi&quot;</span>);</div><div class="line"><a name="l01525"></a><span class="lineno"> 1525</span>&#160;    server.lpushCommand = lookupCommandByCString(<span class="stringliteral">&quot;lpush&quot;</span>);</div><div class="line"><a name="l01526"></a><span class="lineno"> 1526</span>&#160;    server.lpopCommand = lookupCommandByCString(<span class="stringliteral">&quot;lpop&quot;</span>);</div><div class="line"><a name="l01527"></a><span class="lineno"> 1527</span>&#160;    server.rpopCommand = lookupCommandByCString(<span class="stringliteral">&quot;rpop&quot;</span>);</div><div class="line"><a name="l01528"></a><span class="lineno"> 1528</span>&#160;    server.sremCommand = lookupCommandByCString(<span class="stringliteral">&quot;srem&quot;</span>);</div><div class="line"><a name="l01529"></a><span class="lineno"> 1529</span>&#160;    server.execCommand = lookupCommandByCString(<span class="stringliteral">&quot;exec&quot;</span>);</div><div class="line"><a name="l01530"></a><span class="lineno"> 1530</span>&#160;    server.expireCommand = lookupCommandByCString(<span class="stringliteral">&quot;expire&quot;</span>);</div><div class="line"><a name="l01531"></a><span class="lineno"> 1531</span>&#160;    server.pexpireCommand = lookupCommandByCString(<span class="stringliteral">&quot;pexpire&quot;</span>);</div><div class="line"><a name="l01532"></a><span class="lineno"> 1532</span>&#160;</div><div class="line"><a name="l01533"></a><span class="lineno"> 1533</span>&#160;    <span class="comment">/* Slow log */</span></div><div class="line"><a name="l01534"></a><span class="lineno"> 1534</span>&#160;    server.slowlog_log_slower_than = <a class="code" href="server_8h.html#a3cf317db9aeeba99be3654b11d3d0580">CONFIG_DEFAULT_SLOWLOG_LOG_SLOWER_THAN</a>;</div><div class="line"><a name="l01535"></a><span class="lineno"> 1535</span>&#160;    server.slowlog_max_len = <a class="code" href="server_8h.html#ada65a939812527070ed001e451d9bc54">CONFIG_DEFAULT_SLOWLOG_MAX_LEN</a>;</div><div class="line"><a name="l01536"></a><span class="lineno"> 1536</span>&#160;</div><div class="line"><a name="l01537"></a><span class="lineno"> 1537</span>&#160;    <span class="comment">/* Latency monitor */</span></div><div class="line"><a name="l01538"></a><span class="lineno"> 1538</span>&#160;    server.latency_monitor_threshold = <a class="code" href="server_8h.html#a20a7f934b2eceae8fdbb1ac112a783c3">CONFIG_DEFAULT_LATENCY_MONITOR_THRESHOLD</a>;</div><div class="line"><a name="l01539"></a><span class="lineno"> 1539</span>&#160;</div><div class="line"><a name="l01540"></a><span class="lineno"> 1540</span>&#160;    <span class="comment">/* Debugging */</span></div><div class="line"><a name="l01541"></a><span class="lineno"> 1541</span>&#160;    server.assert_failed = <span class="stringliteral">&quot;&lt;no assertion failed&gt;&quot;</span>;</div><div class="line"><a name="l01542"></a><span class="lineno"> 1542</span>&#160;    server.assert_file = <span class="stringliteral">&quot;&lt;no file&gt;&quot;</span>;</div><div class="line"><a name="l01543"></a><span class="lineno"> 1543</span>&#160;    server.assert_line = 0;</div><div class="line"><a name="l01544"></a><span class="lineno"> 1544</span>&#160;    server.bug_report_start = 0;</div><div class="line"><a name="l01545"></a><span class="lineno"> 1545</span>&#160;    server.watchdog_period = 0;</div><div class="line"><a name="l01546"></a><span class="lineno"> 1546</span>&#160;}</div><div class="line"><a name="l01547"></a><span class="lineno"> 1547</span>&#160;</div><div class="line"><a name="l01548"></a><span class="lineno"> 1548</span>&#160;<span class="keyword">extern</span> <span class="keywordtype">char</span> **environ;</div><div class="line"><a name="l01549"></a><span class="lineno"> 1549</span>&#160;</div><div class="line"><a name="l01550"></a><span class="lineno"> 1550</span>&#160;<span class="comment">/* Restart the server, executing the same executable that started this</span></div><div class="line"><a name="l01551"></a><span class="lineno"> 1551</span>&#160;<span class="comment"> * instance, with the same arguments and configuration file.</span></div><div class="line"><a name="l01552"></a><span class="lineno"> 1552</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l01553"></a><span class="lineno"> 1553</span>&#160;<span class="comment"> * The function is designed to directly call execve() so that the new</span></div><div class="line"><a name="l01554"></a><span class="lineno"> 1554</span>&#160;<span class="comment"> * server instance will retain the PID of the previous one.</span></div><div class="line"><a name="l01555"></a><span class="lineno"> 1555</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l01556"></a><span class="lineno"> 1556</span>&#160;<span class="comment"> * The list of flags, that may be bitwise ORed together, alter the</span></div><div class="line"><a name="l01557"></a><span class="lineno"> 1557</span>&#160;<span class="comment"> * behavior of this function:</span></div><div class="line"><a name="l01558"></a><span class="lineno"> 1558</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l01559"></a><span class="lineno"> 1559</span>&#160;<span class="comment"> * RESTART_SERVER_NONE              No flags.</span></div><div class="line"><a name="l01560"></a><span class="lineno"> 1560</span>&#160;<span class="comment"> * RESTART_SERVER_GRACEFULLY        Do a proper shutdown before restarting.</span></div><div class="line"><a name="l01561"></a><span class="lineno"> 1561</span>&#160;<span class="comment"> * RESTART_SERVER_CONFIG_REWRITE    Rewrite the config file before restarting.</span></div><div class="line"><a name="l01562"></a><span class="lineno"> 1562</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l01563"></a><span class="lineno"> 1563</span>&#160;<span class="comment"> * On success the function does not return, because the process turns into</span></div><div class="line"><a name="l01564"></a><span class="lineno"> 1564</span>&#160;<span class="comment"> * a different process. On error C_ERR is returned. */</span></div><div class="line"><a name="l01565"></a><span class="lineno"> 1565</span>&#160;<span class="keywordtype">int</span> restartServer(<span class="keywordtype">int</span> flags, mstime_t delay) {</div><div class="line"><a name="l01566"></a><span class="lineno"> 1566</span>&#160;    <span class="keywordtype">int</span> j;</div><div class="line"><a name="l01567"></a><span class="lineno"> 1567</span>&#160;</div><div class="line"><a name="l01568"></a><span class="lineno"> 1568</span>&#160;    <span class="comment">/* Check if we still have accesses to the executable that started this</span></div><div class="line"><a name="l01569"></a><span class="lineno"> 1569</span>&#160;<span class="comment">     * server instance. */</span></div><div class="line"><a name="l01570"></a><span class="lineno"> 1570</span>&#160;    <span class="keywordflow">if</span> (access(server.executable,X_OK) == -1) {</div><div class="line"><a name="l01571"></a><span class="lineno"> 1571</span>&#160;        serverLog(<a class="code" href="server_8h.html#a31229b9334bba7d6be2a72970967a14b">LL_WARNING</a>,<span class="stringliteral">&quot;Can&#39;t restart: this process has no &quot;</span></div><div class="line"><a name="l01572"></a><span class="lineno"> 1572</span>&#160;                             <span class="stringliteral">&quot;permissions to execute %s&quot;</span>, server.executable);</div><div class="line"><a name="l01573"></a><span class="lineno"> 1573</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="server_8h.html#af98ac28d5f4d23d7ed5985188e6fb7d1">C_ERR</a>;</div><div class="line"><a name="l01574"></a><span class="lineno"> 1574</span>&#160;    }</div><div class="line"><a name="l01575"></a><span class="lineno"> 1575</span>&#160;</div><div class="line"><a name="l01576"></a><span class="lineno"> 1576</span>&#160;    <span class="comment">/* Config rewriting. */</span></div><div class="line"><a name="l01577"></a><span class="lineno"> 1577</span>&#160;    <span class="keywordflow">if</span> (flags &amp; <a class="code" href="server_8h.html#a57b24bdd0dc4a156941789096e9e1f44">RESTART_SERVER_CONFIG_REWRITE</a> &amp;&amp;</div><div class="line"><a name="l01578"></a><span class="lineno"> 1578</span>&#160;        server.configfile &amp;&amp;</div><div class="line"><a name="l01579"></a><span class="lineno"> 1579</span>&#160;        rewriteConfig(server.configfile) == -1)</div><div class="line"><a name="l01580"></a><span class="lineno"> 1580</span>&#160;    {</div><div class="line"><a name="l01581"></a><span class="lineno"> 1581</span>&#160;        serverLog(<a class="code" href="server_8h.html#a31229b9334bba7d6be2a72970967a14b">LL_WARNING</a>,<span class="stringliteral">&quot;Can&#39;t restart: configuration rewrite process &quot;</span></div><div class="line"><a name="l01582"></a><span class="lineno"> 1582</span>&#160;                             <span class="stringliteral">&quot;failed&quot;</span>);</div><div class="line"><a name="l01583"></a><span class="lineno"> 1583</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="server_8h.html#af98ac28d5f4d23d7ed5985188e6fb7d1">C_ERR</a>;</div><div class="line"><a name="l01584"></a><span class="lineno"> 1584</span>&#160;    }</div><div class="line"><a name="l01585"></a><span class="lineno"> 1585</span>&#160;</div><div class="line"><a name="l01586"></a><span class="lineno"> 1586</span>&#160;    <span class="comment">/* Perform a proper shutdown. */</span></div><div class="line"><a name="l01587"></a><span class="lineno"> 1587</span>&#160;    <span class="keywordflow">if</span> (flags &amp; <a class="code" href="server_8h.html#af951fdb3aa8efbce7cde83e8a31fff6a">RESTART_SERVER_GRACEFULLY</a> &amp;&amp;</div><div class="line"><a name="l01588"></a><span class="lineno"> 1588</span>&#160;        prepareForShutdown(<a class="code" href="server_8h.html#a077401d3a9f810d535c00725ef6c6532">SHUTDOWN_NOFLAGS</a>) != <a class="code" href="server_8h.html#a303769ef1065076e68731584e758d3e1">C_OK</a>)</div><div class="line"><a name="l01589"></a><span class="lineno"> 1589</span>&#160;    {</div><div class="line"><a name="l01590"></a><span class="lineno"> 1590</span>&#160;        serverLog(<a class="code" href="server_8h.html#a31229b9334bba7d6be2a72970967a14b">LL_WARNING</a>,<span class="stringliteral">&quot;Can&#39;t restart: error preparing for shutdown&quot;</span>);</div><div class="line"><a name="l01591"></a><span class="lineno"> 1591</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="server_8h.html#af98ac28d5f4d23d7ed5985188e6fb7d1">C_ERR</a>;</div><div class="line"><a name="l01592"></a><span class="lineno"> 1592</span>&#160;    }</div><div class="line"><a name="l01593"></a><span class="lineno"> 1593</span>&#160;</div><div class="line"><a name="l01594"></a><span class="lineno"> 1594</span>&#160;    <span class="comment">/* Close all file descriptors, with the exception of stdin, stdout, strerr</span></div><div class="line"><a name="l01595"></a><span class="lineno"> 1595</span>&#160;<span class="comment">     * which are useful if we restart a Redis server which is not daemonized. */</span></div><div class="line"><a name="l01596"></a><span class="lineno"> 1596</span>&#160;    <span class="keywordflow">for</span> (j = 3; j &lt; (<span class="keywordtype">int</span>)server.maxclients + 1024; j++) {</div><div class="line"><a name="l01597"></a><span class="lineno"> 1597</span>&#160;        <span class="comment">/* Test the descriptor validity before closing it, otherwise</span></div><div class="line"><a name="l01598"></a><span class="lineno"> 1598</span>&#160;<span class="comment">         * Valgrind issues a warning on close(). */</span></div><div class="line"><a name="l01599"></a><span class="lineno"> 1599</span>&#160;        <span class="keywordflow">if</span> (fcntl(j,F_GETFD) != -1) close(j);</div><div class="line"><a name="l01600"></a><span class="lineno"> 1600</span>&#160;    }</div><div class="line"><a name="l01601"></a><span class="lineno"> 1601</span>&#160;</div><div class="line"><a name="l01602"></a><span class="lineno"> 1602</span>&#160;    <span class="comment">/* Execute the server with the original command line. */</span></div><div class="line"><a name="l01603"></a><span class="lineno"> 1603</span>&#160;    <span class="keywordflow">if</span> (delay) usleep(delay*1000);</div><div class="line"><a name="l01604"></a><span class="lineno"> 1604</span>&#160;    zfree(server.exec_argv[0]);</div><div class="line"><a name="l01605"></a><span class="lineno"> 1605</span>&#160;    server.exec_argv[0] = zstrdup(server.executable);</div><div class="line"><a name="l01606"></a><span class="lineno"> 1606</span>&#160;    execve(server.executable,server.exec_argv,environ);</div><div class="line"><a name="l01607"></a><span class="lineno"> 1607</span>&#160;</div><div class="line"><a name="l01608"></a><span class="lineno"> 1608</span>&#160;    <span class="comment">/* If an error occurred here, there is nothing we can do, but exit. */</span></div><div class="line"><a name="l01609"></a><span class="lineno"> 1609</span>&#160;    _exit(1);</div><div class="line"><a name="l01610"></a><span class="lineno"> 1610</span>&#160;</div><div class="line"><a name="l01611"></a><span class="lineno"> 1611</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="server_8h.html#af98ac28d5f4d23d7ed5985188e6fb7d1">C_ERR</a>; <span class="comment">/* Never reached. */</span></div><div class="line"><a name="l01612"></a><span class="lineno"> 1612</span>&#160;}</div><div class="line"><a name="l01613"></a><span class="lineno"> 1613</span>&#160;</div><div class="line"><a name="l01614"></a><span class="lineno"> 1614</span>&#160;<span class="comment">/* This function will try to raise the max number of open files accordingly to</span></div><div class="line"><a name="l01615"></a><span class="lineno"> 1615</span>&#160;<span class="comment"> * the configured max number of clients. It also reserves a number of file</span></div><div class="line"><a name="l01616"></a><span class="lineno"> 1616</span>&#160;<span class="comment"> * descriptors (CONFIG_MIN_RESERVED_FDS) for extra operations of</span></div><div class="line"><a name="l01617"></a><span class="lineno"> 1617</span>&#160;<span class="comment"> * persistence, listening sockets, log files and so forth.</span></div><div class="line"><a name="l01618"></a><span class="lineno"> 1618</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l01619"></a><span class="lineno"> 1619</span>&#160;<span class="comment"> * If it will not be possible to set the limit accordingly to the configured</span></div><div class="line"><a name="l01620"></a><span class="lineno"> 1620</span>&#160;<span class="comment"> * max number of clients, the function will do the reverse setting</span></div><div class="line"><a name="l01621"></a><span class="lineno"> 1621</span>&#160;<span class="comment"> * server.maxclients to the value that we can actually handle. */</span></div><div class="line"><a name="l01622"></a><span class="lineno"> 1622</span>&#160;<span class="keywordtype">void</span> adjustOpenFilesLimit(<span class="keywordtype">void</span>) {</div><div class="line"><a name="l01623"></a><span class="lineno"> 1623</span>&#160;    rlim_t maxfiles = server.maxclients+<a class="code" href="server_8h.html#abcea50457e3de849eab11d0ba5d81d08">CONFIG_MIN_RESERVED_FDS</a>;</div><div class="line"><a name="l01624"></a><span class="lineno"> 1624</span>&#160;    <span class="keyword">struct</span> rlimit limit;</div><div class="line"><a name="l01625"></a><span class="lineno"> 1625</span>&#160;</div><div class="line"><a name="l01626"></a><span class="lineno"> 1626</span>&#160;    <span class="keywordflow">if</span> (getrlimit(RLIMIT_NOFILE,&amp;limit) == -1) {</div><div class="line"><a name="l01627"></a><span class="lineno"> 1627</span>&#160;        serverLog(<a class="code" href="server_8h.html#a31229b9334bba7d6be2a72970967a14b">LL_WARNING</a>,<span class="stringliteral">&quot;Unable to obtain the current NOFILE limit (%s), assuming 1024 and setting the max clients configuration accordingly.&quot;</span>,</div><div class="line"><a name="l01628"></a><span class="lineno"> 1628</span>&#160;            strerror(errno));</div><div class="line"><a name="l01629"></a><span class="lineno"> 1629</span>&#160;        server.maxclients = 1024-<a class="code" href="server_8h.html#abcea50457e3de849eab11d0ba5d81d08">CONFIG_MIN_RESERVED_FDS</a>;</div><div class="line"><a name="l01630"></a><span class="lineno"> 1630</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l01631"></a><span class="lineno"> 1631</span>&#160;        rlim_t oldlimit = limit.rlim_cur;</div><div class="line"><a name="l01632"></a><span class="lineno"> 1632</span>&#160;</div><div class="line"><a name="l01633"></a><span class="lineno"> 1633</span>&#160;        <span class="comment">/* Set the max number of files if the current limit is not enough</span></div><div class="line"><a name="l01634"></a><span class="lineno"> 1634</span>&#160;<span class="comment">         * for our needs. */</span></div><div class="line"><a name="l01635"></a><span class="lineno"> 1635</span>&#160;        <span class="keywordflow">if</span> (oldlimit &lt; maxfiles) {</div><div class="line"><a name="l01636"></a><span class="lineno"> 1636</span>&#160;            rlim_t bestlimit;</div><div class="line"><a name="l01637"></a><span class="lineno"> 1637</span>&#160;            <span class="keywordtype">int</span> setrlimit_error = 0;</div><div class="line"><a name="l01638"></a><span class="lineno"> 1638</span>&#160;</div><div class="line"><a name="l01639"></a><span class="lineno"> 1639</span>&#160;            <span class="comment">/* Try to set the file limit to match &#39;maxfiles&#39; or at least</span></div><div class="line"><a name="l01640"></a><span class="lineno"> 1640</span>&#160;<span class="comment">             * to the higher value supported less than maxfiles. */</span></div><div class="line"><a name="l01641"></a><span class="lineno"> 1641</span>&#160;            bestlimit = maxfiles;</div><div class="line"><a name="l01642"></a><span class="lineno"> 1642</span>&#160;            <span class="keywordflow">while</span>(bestlimit &gt; oldlimit) {</div><div class="line"><a name="l01643"></a><span class="lineno"> 1643</span>&#160;                rlim_t decr_step = 16;</div><div class="line"><a name="l01644"></a><span class="lineno"> 1644</span>&#160;</div><div class="line"><a name="l01645"></a><span class="lineno"> 1645</span>&#160;                limit.rlim_cur = bestlimit;</div><div class="line"><a name="l01646"></a><span class="lineno"> 1646</span>&#160;                limit.rlim_max = bestlimit;</div><div class="line"><a name="l01647"></a><span class="lineno"> 1647</span>&#160;                <span class="keywordflow">if</span> (setrlimit(RLIMIT_NOFILE,&amp;limit) != -1) <span class="keywordflow">break</span>;</div><div class="line"><a name="l01648"></a><span class="lineno"> 1648</span>&#160;                setrlimit_error = errno;</div><div class="line"><a name="l01649"></a><span class="lineno"> 1649</span>&#160;</div><div class="line"><a name="l01650"></a><span class="lineno"> 1650</span>&#160;                <span class="comment">/* We failed to set file limit to &#39;bestlimit&#39;. Try with a</span></div><div class="line"><a name="l01651"></a><span class="lineno"> 1651</span>&#160;<span class="comment">                 * smaller limit decrementing by a few FDs per iteration. */</span></div><div class="line"><a name="l01652"></a><span class="lineno"> 1652</span>&#160;                <span class="keywordflow">if</span> (bestlimit &lt; decr_step) <span class="keywordflow">break</span>;</div><div class="line"><a name="l01653"></a><span class="lineno"> 1653</span>&#160;                bestlimit -= decr_step;</div><div class="line"><a name="l01654"></a><span class="lineno"> 1654</span>&#160;            }</div><div class="line"><a name="l01655"></a><span class="lineno"> 1655</span>&#160;</div><div class="line"><a name="l01656"></a><span class="lineno"> 1656</span>&#160;            <span class="comment">/* Assume that the limit we get initially is still valid if</span></div><div class="line"><a name="l01657"></a><span class="lineno"> 1657</span>&#160;<span class="comment">             * our last try was even lower. */</span></div><div class="line"><a name="l01658"></a><span class="lineno"> 1658</span>&#160;            <span class="keywordflow">if</span> (bestlimit &lt; oldlimit) bestlimit = oldlimit;</div><div class="line"><a name="l01659"></a><span class="lineno"> 1659</span>&#160;</div><div class="line"><a name="l01660"></a><span class="lineno"> 1660</span>&#160;            <span class="keywordflow">if</span> (bestlimit &lt; maxfiles) {</div><div class="line"><a name="l01661"></a><span class="lineno"> 1661</span>&#160;                <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> old_maxclients = server.maxclients;</div><div class="line"><a name="l01662"></a><span class="lineno"> 1662</span>&#160;                server.maxclients = bestlimit-<a class="code" href="server_8h.html#abcea50457e3de849eab11d0ba5d81d08">CONFIG_MIN_RESERVED_FDS</a>;</div><div class="line"><a name="l01663"></a><span class="lineno"> 1663</span>&#160;                <span class="comment">/* maxclients is unsigned so may overflow: in order</span></div><div class="line"><a name="l01664"></a><span class="lineno"> 1664</span>&#160;<span class="comment">                 * to check if maxclients is now logically less than 1</span></div><div class="line"><a name="l01665"></a><span class="lineno"> 1665</span>&#160;<span class="comment">                 * we test indirectly via bestlimit. */</span></div><div class="line"><a name="l01666"></a><span class="lineno"> 1666</span>&#160;                <span class="keywordflow">if</span> (bestlimit &lt;= <a class="code" href="server_8h.html#abcea50457e3de849eab11d0ba5d81d08">CONFIG_MIN_RESERVED_FDS</a>) {</div><div class="line"><a name="l01667"></a><span class="lineno"> 1667</span>&#160;                    serverLog(<a class="code" href="server_8h.html#a31229b9334bba7d6be2a72970967a14b">LL_WARNING</a>,<span class="stringliteral">&quot;Your current &#39;ulimit -n&#39; &quot;</span></div><div class="line"><a name="l01668"></a><span class="lineno"> 1668</span>&#160;                        <span class="stringliteral">&quot;of %llu is not enough for the server to start. &quot;</span></div><div class="line"><a name="l01669"></a><span class="lineno"> 1669</span>&#160;                        <span class="stringliteral">&quot;Please increase your open file limit to at least &quot;</span></div><div class="line"><a name="l01670"></a><span class="lineno"> 1670</span>&#160;                        <span class="stringliteral">&quot;%llu. Exiting.&quot;</span>,</div><div class="line"><a name="l01671"></a><span class="lineno"> 1671</span>&#160;                        (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span>) oldlimit,</div><div class="line"><a name="l01672"></a><span class="lineno"> 1672</span>&#160;                        (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span>) maxfiles);</div><div class="line"><a name="l01673"></a><span class="lineno"> 1673</span>&#160;                    exit(1);</div><div class="line"><a name="l01674"></a><span class="lineno"> 1674</span>&#160;                }</div><div class="line"><a name="l01675"></a><span class="lineno"> 1675</span>&#160;                serverLog(<a class="code" href="server_8h.html#a31229b9334bba7d6be2a72970967a14b">LL_WARNING</a>,<span class="stringliteral">&quot;You requested maxclients of %d &quot;</span></div><div class="line"><a name="l01676"></a><span class="lineno"> 1676</span>&#160;                    <span class="stringliteral">&quot;requiring at least %llu max file descriptors.&quot;</span>,</div><div class="line"><a name="l01677"></a><span class="lineno"> 1677</span>&#160;                    old_maxclients,</div><div class="line"><a name="l01678"></a><span class="lineno"> 1678</span>&#160;                    (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span>) maxfiles);</div><div class="line"><a name="l01679"></a><span class="lineno"> 1679</span>&#160;                serverLog(<a class="code" href="server_8h.html#a31229b9334bba7d6be2a72970967a14b">LL_WARNING</a>,<span class="stringliteral">&quot;Server can&#39;t set maximum open files &quot;</span></div><div class="line"><a name="l01680"></a><span class="lineno"> 1680</span>&#160;                    <span class="stringliteral">&quot;to %llu because of OS error: %s.&quot;</span>,</div><div class="line"><a name="l01681"></a><span class="lineno"> 1681</span>&#160;                    (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span>) maxfiles, strerror(setrlimit_error));</div><div class="line"><a name="l01682"></a><span class="lineno"> 1682</span>&#160;                serverLog(<a class="code" href="server_8h.html#a31229b9334bba7d6be2a72970967a14b">LL_WARNING</a>,<span class="stringliteral">&quot;Current maximum open files is %llu. &quot;</span></div><div class="line"><a name="l01683"></a><span class="lineno"> 1683</span>&#160;                    <span class="stringliteral">&quot;maxclients has been reduced to %d to compensate for &quot;</span></div><div class="line"><a name="l01684"></a><span class="lineno"> 1684</span>&#160;                    <span class="stringliteral">&quot;low ulimit. &quot;</span></div><div class="line"><a name="l01685"></a><span class="lineno"> 1685</span>&#160;                    <span class="stringliteral">&quot;If you need higher maxclients increase &#39;ulimit -n&#39;.&quot;</span>,</div><div class="line"><a name="l01686"></a><span class="lineno"> 1686</span>&#160;                    (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span>) bestlimit, server.maxclients);</div><div class="line"><a name="l01687"></a><span class="lineno"> 1687</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l01688"></a><span class="lineno"> 1688</span>&#160;                serverLog(<a class="code" href="server_8h.html#a8c54c191e436c7dd3012167212692401">LL_NOTICE</a>,<span class="stringliteral">&quot;Increased maximum number of open files &quot;</span></div><div class="line"><a name="l01689"></a><span class="lineno"> 1689</span>&#160;                    <span class="stringliteral">&quot;to %llu (it was originally set to %llu).&quot;</span>,</div><div class="line"><a name="l01690"></a><span class="lineno"> 1690</span>&#160;                    (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span>) maxfiles,</div><div class="line"><a name="l01691"></a><span class="lineno"> 1691</span>&#160;                    (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span>) oldlimit);</div><div class="line"><a name="l01692"></a><span class="lineno"> 1692</span>&#160;            }</div><div class="line"><a name="l01693"></a><span class="lineno"> 1693</span>&#160;        }</div><div class="line"><a name="l01694"></a><span class="lineno"> 1694</span>&#160;    }</div><div class="line"><a name="l01695"></a><span class="lineno"> 1695</span>&#160;}</div><div class="line"><a name="l01696"></a><span class="lineno"> 1696</span>&#160;</div><div class="line"><a name="l01697"></a><span class="lineno"> 1697</span>&#160;<span class="comment">/* Check that server.tcp_backlog can be actually enforced in Linux according</span></div><div class="line"><a name="l01698"></a><span class="lineno"> 1698</span>&#160;<span class="comment"> * to the value of /proc/sys/net/core/somaxconn, or warn about it. */</span></div><div class="line"><a name="l01699"></a><span class="lineno"> 1699</span>&#160;<span class="keywordtype">void</span> checkTcpBacklogSettings(<span class="keywordtype">void</span>) {</div><div class="line"><a name="l01700"></a><span class="lineno"> 1700</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">ifdef</span> HAVE_PROC_SOMAXCONN</div><div class="line"><a name="l01701"></a><span class="lineno"> 1701</span>&#160;    FILE *fp = fopen(<span class="stringliteral">&quot;/proc/sys/net/core/somaxconn&quot;</span>,<span class="stringliteral">&quot;r&quot;</span>);</div><div class="line"><a name="l01702"></a><span class="lineno"> 1702</span>&#160;    <span class="keywordtype">char</span> buf[1024];</div><div class="line"><a name="l01703"></a><span class="lineno"> 1703</span>&#160;    <span class="keywordflow">if</span> (!fp) <span class="keywordflow">return</span>;</div><div class="line"><a name="l01704"></a><span class="lineno"> 1704</span>&#160;    <span class="keywordflow">if</span> (fgets(buf,<span class="keyword">sizeof</span>(buf),fp) != NULL) {</div><div class="line"><a name="l01705"></a><span class="lineno"> 1705</span>&#160;        <span class="keywordtype">int</span> somaxconn = atoi(buf);</div><div class="line"><a name="l01706"></a><span class="lineno"> 1706</span>&#160;        <span class="keywordflow">if</span> (somaxconn &gt; 0 &amp;&amp; somaxconn &lt; server.tcp_backlog) {</div><div class="line"><a name="l01707"></a><span class="lineno"> 1707</span>&#160;            serverLog(<a class="code" href="server_8h.html#a31229b9334bba7d6be2a72970967a14b">LL_WARNING</a>,<span class="stringliteral">&quot;WARNING: The TCP backlog setting of %d cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of %d.&quot;</span>, server.tcp_backlog, somaxconn);</div><div class="line"><a name="l01708"></a><span class="lineno"> 1708</span>&#160;        }</div><div class="line"><a name="l01709"></a><span class="lineno"> 1709</span>&#160;    }</div><div class="line"><a name="l01710"></a><span class="lineno"> 1710</span>&#160;    fclose(fp);</div><div class="line"><a name="l01711"></a><span class="lineno"> 1711</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">endif</span></div><div class="line"><a name="l01712"></a><span class="lineno"> 1712</span>&#160;}</div><div class="line"><a name="l01713"></a><span class="lineno"> 1713</span>&#160;</div><div class="line"><a name="l01714"></a><span class="lineno"> 1714</span>&#160;<span class="comment">/* Initialize a set of file descriptors to listen to the specified &#39;port&#39;</span></div><div class="line"><a name="l01715"></a><span class="lineno"> 1715</span>&#160;<span class="comment"> * binding the addresses specified in the Redis server configuration.</span></div><div class="line"><a name="l01716"></a><span class="lineno"> 1716</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l01717"></a><span class="lineno"> 1717</span>&#160;<span class="comment"> * The listening file descriptors are stored in the integer array &#39;fds&#39;</span></div><div class="line"><a name="l01718"></a><span class="lineno"> 1718</span>&#160;<span class="comment"> * and their number is set in &#39;*count&#39;.</span></div><div class="line"><a name="l01719"></a><span class="lineno"> 1719</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l01720"></a><span class="lineno"> 1720</span>&#160;<span class="comment"> * The addresses to bind are specified in the global server.bindaddr array</span></div><div class="line"><a name="l01721"></a><span class="lineno"> 1721</span>&#160;<span class="comment"> * and their number is server.bindaddr_count. If the server configuration</span></div><div class="line"><a name="l01722"></a><span class="lineno"> 1722</span>&#160;<span class="comment"> * contains no specific addresses to bind, this function will try to</span></div><div class="line"><a name="l01723"></a><span class="lineno"> 1723</span>&#160;<span class="comment"> * bind * (all addresses) for both the IPv4 and IPv6 protocols.</span></div><div class="line"><a name="l01724"></a><span class="lineno"> 1724</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l01725"></a><span class="lineno"> 1725</span>&#160;<span class="comment"> * On success the function returns C_OK.</span></div><div class="line"><a name="l01726"></a><span class="lineno"> 1726</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l01727"></a><span class="lineno"> 1727</span>&#160;<span class="comment"> * On error the function returns C_ERR. For the function to be on</span></div><div class="line"><a name="l01728"></a><span class="lineno"> 1728</span>&#160;<span class="comment"> * error, at least one of the server.bindaddr addresses was</span></div><div class="line"><a name="l01729"></a><span class="lineno"> 1729</span>&#160;<span class="comment"> * impossible to bind, or no bind addresses were specified in the server</span></div><div class="line"><a name="l01730"></a><span class="lineno"> 1730</span>&#160;<span class="comment"> * configuration but the function is not able to bind * for at least</span></div><div class="line"><a name="l01731"></a><span class="lineno"> 1731</span>&#160;<span class="comment"> * one of the IPv4 or IPv6 protocols. */</span></div><div class="line"><a name="l01732"></a><span class="lineno"> 1732</span>&#160;<span class="keywordtype">int</span> listenToPort(<span class="keywordtype">int</span> port, <span class="keywordtype">int</span> *fds, <span class="keywordtype">int</span> *count) {</div><div class="line"><a name="l01733"></a><span class="lineno"> 1733</span>&#160;    <span class="keywordtype">int</span> j;</div><div class="line"><a name="l01734"></a><span class="lineno"> 1734</span>&#160;</div><div class="line"><a name="l01735"></a><span class="lineno"> 1735</span>&#160;    <span class="comment">/* Force binding of 0.0.0.0 if no bind address is specified, always</span></div><div class="line"><a name="l01736"></a><span class="lineno"> 1736</span>&#160;<span class="comment">     * entering the loop if j == 0. */</span></div><div class="line"><a name="l01737"></a><span class="lineno"> 1737</span>&#160;    <span class="keywordflow">if</span> (server.bindaddr_count == 0) server.bindaddr[0] = NULL;</div><div class="line"><a name="l01738"></a><span class="lineno"> 1738</span>&#160;    <span class="keywordflow">for</span> (j = 0; j &lt; server.bindaddr_count || j == 0; j++) {</div><div class="line"><a name="l01739"></a><span class="lineno"> 1739</span>&#160;        <span class="keywordflow">if</span> (server.bindaddr[j] == NULL) {</div><div class="line"><a name="l01740"></a><span class="lineno"> 1740</span>&#160;            <span class="keywordtype">int</span> unsupported = 0;</div><div class="line"><a name="l01741"></a><span class="lineno"> 1741</span>&#160;            <span class="comment">/* Bind * for both IPv6 and IPv4, we enter here only if</span></div><div class="line"><a name="l01742"></a><span class="lineno"> 1742</span>&#160;<span class="comment">             * server.bindaddr_count == 0. */</span></div><div class="line"><a name="l01743"></a><span class="lineno"> 1743</span>&#160;            fds[*count] = anetTcp6Server(server.neterr,port,NULL,</div><div class="line"><a name="l01744"></a><span class="lineno"> 1744</span>&#160;                server.tcp_backlog);</div><div class="line"><a name="l01745"></a><span class="lineno"> 1745</span>&#160;            <span class="keywordflow">if</span> (fds[*count] != <a class="code" href="anet_8h.html#a0697b7774a7e0f4ef141839fe93536fe">ANET_ERR</a>) {</div><div class="line"><a name="l01746"></a><span class="lineno"> 1746</span>&#160;                anetNonBlock(NULL,fds[*count]);</div><div class="line"><a name="l01747"></a><span class="lineno"> 1747</span>&#160;                (*count)++;</div><div class="line"><a name="l01748"></a><span class="lineno"> 1748</span>&#160;            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (errno == EAFNOSUPPORT) {</div><div class="line"><a name="l01749"></a><span class="lineno"> 1749</span>&#160;                unsupported++;</div><div class="line"><a name="l01750"></a><span class="lineno"> 1750</span>&#160;                serverLog(<a class="code" href="server_8h.html#a31229b9334bba7d6be2a72970967a14b">LL_WARNING</a>,<span class="stringliteral">&quot;Not listening to IPv6: unsupproted&quot;</span>);</div><div class="line"><a name="l01751"></a><span class="lineno"> 1751</span>&#160;            }</div><div class="line"><a name="l01752"></a><span class="lineno"> 1752</span>&#160;</div><div class="line"><a name="l01753"></a><span class="lineno"> 1753</span>&#160;            <span class="keywordflow">if</span> (*count == 1 || unsupported) {</div><div class="line"><a name="l01754"></a><span class="lineno"> 1754</span>&#160;                <span class="comment">/* Bind the IPv4 address as well. */</span></div><div class="line"><a name="l01755"></a><span class="lineno"> 1755</span>&#160;                fds[*count] = anetTcpServer(server.neterr,port,NULL,</div><div class="line"><a name="l01756"></a><span class="lineno"> 1756</span>&#160;                    server.tcp_backlog);</div><div class="line"><a name="l01757"></a><span class="lineno"> 1757</span>&#160;                <span class="keywordflow">if</span> (fds[*count] != <a class="code" href="anet_8h.html#a0697b7774a7e0f4ef141839fe93536fe">ANET_ERR</a>) {</div><div class="line"><a name="l01758"></a><span class="lineno"> 1758</span>&#160;                    anetNonBlock(NULL,fds[*count]);</div><div class="line"><a name="l01759"></a><span class="lineno"> 1759</span>&#160;                    (*count)++;</div><div class="line"><a name="l01760"></a><span class="lineno"> 1760</span>&#160;                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (errno == EAFNOSUPPORT) {</div><div class="line"><a name="l01761"></a><span class="lineno"> 1761</span>&#160;                    unsupported++;</div><div class="line"><a name="l01762"></a><span class="lineno"> 1762</span>&#160;                    serverLog(<a class="code" href="server_8h.html#a31229b9334bba7d6be2a72970967a14b">LL_WARNING</a>,<span class="stringliteral">&quot;Not listening to IPv4: unsupproted&quot;</span>);</div><div class="line"><a name="l01763"></a><span class="lineno"> 1763</span>&#160;                }</div><div class="line"><a name="l01764"></a><span class="lineno"> 1764</span>&#160;            }</div><div class="line"><a name="l01765"></a><span class="lineno"> 1765</span>&#160;            <span class="comment">/* Exit the loop if we were able to bind * on IPv4 and IPv6,</span></div><div class="line"><a name="l01766"></a><span class="lineno"> 1766</span>&#160;<span class="comment">             * otherwise fds[*count] will be ANET_ERR and we&#39;ll print an</span></div><div class="line"><a name="l01767"></a><span class="lineno"> 1767</span>&#160;<span class="comment">             * error and return to the caller with an error. */</span></div><div class="line"><a name="l01768"></a><span class="lineno"> 1768</span>&#160;            <span class="keywordflow">if</span> (*count + unsupported == 2) <span class="keywordflow">break</span>;</div><div class="line"><a name="l01769"></a><span class="lineno"> 1769</span>&#160;        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strchr(server.bindaddr[j],<span class="stringliteral">&#39;:&#39;</span>)) {</div><div class="line"><a name="l01770"></a><span class="lineno"> 1770</span>&#160;            <span class="comment">/* Bind IPv6 address. */</span></div><div class="line"><a name="l01771"></a><span class="lineno"> 1771</span>&#160;            fds[*count] = anetTcp6Server(server.neterr,port,server.bindaddr[j],</div><div class="line"><a name="l01772"></a><span class="lineno"> 1772</span>&#160;                server.tcp_backlog);</div><div class="line"><a name="l01773"></a><span class="lineno"> 1773</span>&#160;        } <span class="keywordflow">else</span> {</div><div class="line"><a name="l01774"></a><span class="lineno"> 1774</span>&#160;            <span class="comment">/* Bind IPv4 address. */</span></div><div class="line"><a name="l01775"></a><span class="lineno"> 1775</span>&#160;            fds[*count] = anetTcpServer(server.neterr,port,server.bindaddr[j],</div><div class="line"><a name="l01776"></a><span class="lineno"> 1776</span>&#160;                server.tcp_backlog);</div><div class="line"><a name="l01777"></a><span class="lineno"> 1777</span>&#160;        }</div><div class="line"><a name="l01778"></a><span class="lineno"> 1778</span>&#160;        <span class="keywordflow">if</span> (fds[*count] == <a class="code" href="anet_8h.html#a0697b7774a7e0f4ef141839fe93536fe">ANET_ERR</a>) {</div><div class="line"><a name="l01779"></a><span class="lineno"> 1779</span>&#160;            serverLog(<a class="code" href="server_8h.html#a31229b9334bba7d6be2a72970967a14b">LL_WARNING</a>,</div><div class="line"><a name="l01780"></a><span class="lineno"> 1780</span>&#160;                <span class="stringliteral">&quot;Creating Server TCP listening socket %s:%d: %s&quot;</span>,</div><div class="line"><a name="l01781"></a><span class="lineno"> 1781</span>&#160;                server.bindaddr[j] ? server.bindaddr[j] : <span class="stringliteral">&quot;*&quot;</span>,</div><div class="line"><a name="l01782"></a><span class="lineno"> 1782</span>&#160;                port, server.neterr);</div><div class="line"><a name="l01783"></a><span class="lineno"> 1783</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="server_8h.html#af98ac28d5f4d23d7ed5985188e6fb7d1">C_ERR</a>;</div><div class="line"><a name="l01784"></a><span class="lineno"> 1784</span>&#160;        }</div><div class="line"><a name="l01785"></a><span class="lineno"> 1785</span>&#160;        anetNonBlock(NULL,fds[*count]);</div><div class="line"><a name="l01786"></a><span class="lineno"> 1786</span>&#160;        (*count)++;</div><div class="line"><a name="l01787"></a><span class="lineno"> 1787</span>&#160;    }</div><div class="line"><a name="l01788"></a><span class="lineno"> 1788</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="server_8h.html#a303769ef1065076e68731584e758d3e1">C_OK</a>;</div><div class="line"><a name="l01789"></a><span class="lineno"> 1789</span>&#160;}</div><div class="line"><a name="l01790"></a><span class="lineno"> 1790</span>&#160;</div><div class="line"><a name="l01791"></a><span class="lineno"> 1791</span>&#160;<span class="comment">/* Resets the stats that we expose via INFO or other means that we want</span></div><div class="line"><a name="l01792"></a><span class="lineno"> 1792</span>&#160;<span class="comment"> * to reset via CONFIG RESETSTAT. The function is also used in order to</span></div><div class="line"><a name="l01793"></a><span class="lineno"> 1793</span>&#160;<span class="comment"> * initialize these fields in initServer() at server startup. */</span></div><div class="line"><a name="l01794"></a><span class="lineno"> 1794</span>&#160;<span class="keywordtype">void</span> resetServerStats(<span class="keywordtype">void</span>) {</div><div class="line"><a name="l01795"></a><span class="lineno"> 1795</span>&#160;    <span class="keywordtype">int</span> j;</div><div class="line"><a name="l01796"></a><span class="lineno"> 1796</span>&#160;</div><div class="line"><a name="l01797"></a><span class="lineno"> 1797</span>&#160;    server.stat_numcommands = 0;</div><div class="line"><a name="l01798"></a><span class="lineno"> 1798</span>&#160;    server.stat_numconnections = 0;</div><div class="line"><a name="l01799"></a><span class="lineno"> 1799</span>&#160;    server.stat_expiredkeys = 0;</div><div class="line"><a name="l01800"></a><span class="lineno"> 1800</span>&#160;    server.stat_evictedkeys = 0;</div><div class="line"><a name="l01801"></a><span class="lineno"> 1801</span>&#160;    server.stat_keyspace_misses = 0;</div><div class="line"><a name="l01802"></a><span class="lineno"> 1802</span>&#160;    server.stat_keyspace_hits = 0;</div><div class="line"><a name="l01803"></a><span class="lineno"> 1803</span>&#160;    server.stat_active_defrag_hits = 0;</div><div class="line"><a name="l01804"></a><span class="lineno"> 1804</span>&#160;    server.stat_active_defrag_misses = 0;</div><div class="line"><a name="l01805"></a><span class="lineno"> 1805</span>&#160;    server.stat_active_defrag_key_hits = 0;</div><div class="line"><a name="l01806"></a><span class="lineno"> 1806</span>&#160;    server.stat_active_defrag_key_misses = 0;</div><div class="line"><a name="l01807"></a><span class="lineno"> 1807</span>&#160;    server.stat_fork_time = 0;</div><div class="line"><a name="l01808"></a><span class="lineno"> 1808</span>&#160;    server.stat_fork_rate = 0;</div><div class="line"><a name="l01809"></a><span class="lineno"> 1809</span>&#160;    server.stat_rejected_conn = 0;</div><div class="line"><a name="l01810"></a><span class="lineno"> 1810</span>&#160;    server.stat_sync_full = 0;</div><div class="line"><a name="l01811"></a><span class="lineno"> 1811</span>&#160;    server.stat_sync_partial_ok = 0;</div><div class="line"><a name="l01812"></a><span class="lineno"> 1812</span>&#160;    server.stat_sync_partial_err = 0;</div><div class="line"><a name="l01813"></a><span class="lineno"> 1813</span>&#160;    <span class="keywordflow">for</span> (j = 0; j &lt; <a class="code" href="server_8h.html#ad9e350cb5eeb396592d0d80f70e6e040">STATS_METRIC_COUNT</a>; j++) {</div><div class="line"><a name="l01814"></a><span class="lineno"> 1814</span>&#160;        server.inst_metric[j].idx = 0;</div><div class="line"><a name="l01815"></a><span class="lineno"> 1815</span>&#160;        server.inst_metric[j].last_sample_time = mstime();</div><div class="line"><a name="l01816"></a><span class="lineno"> 1816</span>&#160;        server.inst_metric[j].last_sample_count = 0;</div><div class="line"><a name="l01817"></a><span class="lineno"> 1817</span>&#160;        memset(server.inst_metric[j].samples,0,</div><div class="line"><a name="l01818"></a><span class="lineno"> 1818</span>&#160;            <span class="keyword">sizeof</span>(server.inst_metric[j].samples));</div><div class="line"><a name="l01819"></a><span class="lineno"> 1819</span>&#160;    }</div><div class="line"><a name="l01820"></a><span class="lineno"> 1820</span>&#160;    server.stat_net_input_bytes = 0;</div><div class="line"><a name="l01821"></a><span class="lineno"> 1821</span>&#160;    server.stat_net_output_bytes = 0;</div><div class="line"><a name="l01822"></a><span class="lineno"> 1822</span>&#160;    server.aof_delayed_fsync = 0;</div><div class="line"><a name="l01823"></a><span class="lineno"> 1823</span>&#160;}</div><div class="line"><a name="l01824"></a><span class="lineno"> 1824</span>&#160;</div><div class="line"><a name="l01825"></a><span class="lineno"> 1825</span>&#160;<span class="keywordtype">void</span> initServer(<span class="keywordtype">void</span>) {</div><div class="line"><a name="l01826"></a><span class="lineno"> 1826</span>&#160;    <span class="keywordtype">int</span> j;</div><div class="line"><a name="l01827"></a><span class="lineno"> 1827</span>&#160;</div><div class="line"><a name="l01828"></a><span class="lineno"> 1828</span>&#160;    signal(SIGHUP, SIG_IGN);</div><div class="line"><a name="l01829"></a><span class="lineno"> 1829</span>&#160;    signal(SIGPIPE, SIG_IGN);</div><div class="line"><a name="l01830"></a><span class="lineno"> 1830</span>&#160;    setupSignalHandlers();</div><div class="line"><a name="l01831"></a><span class="lineno"> 1831</span>&#160;</div><div class="line"><a name="l01832"></a><span class="lineno"> 1832</span>&#160;    <span class="keywordflow">if</span> (server.syslog_enabled) {</div><div class="line"><a name="l01833"></a><span class="lineno"> 1833</span>&#160;        openlog(server.syslog_ident, LOG_PID | LOG_NDELAY | LOG_NOWAIT,</div><div class="line"><a name="l01834"></a><span class="lineno"> 1834</span>&#160;            server.syslog_facility);</div><div class="line"><a name="l01835"></a><span class="lineno"> 1835</span>&#160;    }</div><div class="line"><a name="l01836"></a><span class="lineno"> 1836</span>&#160;</div><div class="line"><a name="l01837"></a><span class="lineno"> 1837</span>&#160;    server.pid = getpid();</div><div class="line"><a name="l01838"></a><span class="lineno"> 1838</span>&#160;    server.current_client = NULL;</div><div class="line"><a name="l01839"></a><span class="lineno"> 1839</span>&#160;    server.clients = listCreate();</div><div class="line"><a name="l01840"></a><span class="lineno"> 1840</span>&#160;    server.clients_to_close = listCreate();</div><div class="line"><a name="l01841"></a><span class="lineno"> 1841</span>&#160;    server.slaves = listCreate();</div><div class="line"><a name="l01842"></a><span class="lineno"> 1842</span>&#160;    server.monitors = listCreate();</div><div class="line"><a name="l01843"></a><span class="lineno"> 1843</span>&#160;    server.clients_pending_write = listCreate();</div><div class="line"><a name="l01844"></a><span class="lineno"> 1844</span>&#160;    server.slaveseldb = -1; <span class="comment">/* Force to emit the first SELECT command. */</span></div><div class="line"><a name="l01845"></a><span class="lineno"> 1845</span>&#160;    server.unblocked_clients = listCreate();</div><div class="line"><a name="l01846"></a><span class="lineno"> 1846</span>&#160;    server.ready_keys = listCreate();</div><div class="line"><a name="l01847"></a><span class="lineno"> 1847</span>&#160;    server.clients_waiting_acks = listCreate();</div><div class="line"><a name="l01848"></a><span class="lineno"> 1848</span>&#160;    server.get_ack_from_slaves = 0;</div><div class="line"><a name="l01849"></a><span class="lineno"> 1849</span>&#160;    server.clients_paused = 0;</div><div class="line"><a name="l01850"></a><span class="lineno"> 1850</span>&#160;    server.system_memory_size = zmalloc_get_memory_size();</div><div class="line"><a name="l01851"></a><span class="lineno"> 1851</span>&#160;</div><div class="line"><a name="l01852"></a><span class="lineno"> 1852</span>&#160;    createSharedObjects();</div><div class="line"><a name="l01853"></a><span class="lineno"> 1853</span>&#160;    adjustOpenFilesLimit();</div><div class="line"><a name="l01854"></a><span class="lineno"> 1854</span>&#160;    server.el = aeCreateEventLoop(server.maxclients+<a class="code" href="server_8h.html#a6725c1ff5b6a17f930627263f484d107">CONFIG_FDSET_INCR</a>);</div><div class="line"><a name="l01855"></a><span class="lineno"> 1855</span>&#160;    <span class="keywordflow">if</span> (server.el == NULL) {</div><div class="line"><a name="l01856"></a><span class="lineno"> 1856</span>&#160;        serverLog(<a class="code" href="server_8h.html#a31229b9334bba7d6be2a72970967a14b">LL_WARNING</a>,</div><div class="line"><a name="l01857"></a><span class="lineno"> 1857</span>&#160;            <span class="stringliteral">&quot;Failed creating the event loop. Error message: &#39;%s&#39;&quot;</span>,</div><div class="line"><a name="l01858"></a><span class="lineno"> 1858</span>&#160;            strerror(errno));</div><div class="line"><a name="l01859"></a><span class="lineno"> 1859</span>&#160;        exit(1);</div><div class="line"><a name="l01860"></a><span class="lineno"> 1860</span>&#160;    }</div><div class="line"><a name="l01861"></a><span class="lineno"> 1861</span>&#160;    server.db = zmalloc(<span class="keyword">sizeof</span>(redisDb)*server.dbnum);</div><div class="line"><a name="l01862"></a><span class="lineno"> 1862</span>&#160;</div><div class="line"><a name="l01863"></a><span class="lineno"> 1863</span>&#160;    <span class="comment">/* Open the TCP listening socket for the user commands. */</span></div><div class="line"><a name="l01864"></a><span class="lineno"> 1864</span>&#160;    <span class="keywordflow">if</span> (server.port != 0 &amp;&amp;</div><div class="line"><a name="l01865"></a><span class="lineno"> 1865</span>&#160;        listenToPort(server.port,server.ipfd,&amp;server.ipfd_count) == <a class="code" href="server_8h.html#af98ac28d5f4d23d7ed5985188e6fb7d1">C_ERR</a>)</div><div class="line"><a name="l01866"></a><span class="lineno"> 1866</span>&#160;        exit(1);</div><div class="line"><a name="l01867"></a><span class="lineno"> 1867</span>&#160;</div><div class="line"><a name="l01868"></a><span class="lineno"> 1868</span>&#160;    <span class="comment">/* Open the listening Unix domain socket. */</span></div><div class="line"><a name="l01869"></a><span class="lineno"> 1869</span>&#160;    <span class="keywordflow">if</span> (server.unixsocket != NULL) {</div><div class="line"><a name="l01870"></a><span class="lineno"> 1870</span>&#160;        unlink(server.unixsocket); <span class="comment">/* don&#39;t care if this fails */</span></div><div class="line"><a name="l01871"></a><span class="lineno"> 1871</span>&#160;        server.sofd = anetUnixServer(server.neterr,server.unixsocket,</div><div class="line"><a name="l01872"></a><span class="lineno"> 1872</span>&#160;            server.unixsocketperm, server.tcp_backlog);</div><div class="line"><a name="l01873"></a><span class="lineno"> 1873</span>&#160;        <span class="keywordflow">if</span> (server.sofd == <a class="code" href="anet_8h.html#a0697b7774a7e0f4ef141839fe93536fe">ANET_ERR</a>) {</div><div class="line"><a name="l01874"></a><span class="lineno"> 1874</span>&#160;            serverLog(<a class="code" href="server_8h.html#a31229b9334bba7d6be2a72970967a14b">LL_WARNING</a>, <span class="stringliteral">&quot;Opening Unix socket: %s&quot;</span>, server.neterr);</div><div class="line"><a name="l01875"></a><span class="lineno"> 1875</span>&#160;            exit(1);</div><div class="line"><a name="l01876"></a><span class="lineno"> 1876</span>&#160;        }</div><div class="line"><a name="l01877"></a><span class="lineno"> 1877</span>&#160;        anetNonBlock(NULL,server.sofd);</div><div class="line"><a name="l01878"></a><span class="lineno"> 1878</span>&#160;    }</div><div class="line"><a name="l01879"></a><span class="lineno"> 1879</span>&#160;</div><div class="line"><a name="l01880"></a><span class="lineno"> 1880</span>&#160;    <span class="comment">/* Abort if there are no listening sockets at all. */</span></div><div class="line"><a name="l01881"></a><span class="lineno"> 1881</span>&#160;    <span class="keywordflow">if</span> (server.ipfd_count == 0 &amp;&amp; server.sofd &lt; 0) {</div><div class="line"><a name="l01882"></a><span class="lineno"> 1882</span>&#160;        serverLog(<a class="code" href="server_8h.html#a31229b9334bba7d6be2a72970967a14b">LL_WARNING</a>, <span class="stringliteral">&quot;Configured to not listen anywhere, exiting.&quot;</span>);</div><div class="line"><a name="l01883"></a><span class="lineno"> 1883</span>&#160;        exit(1);</div><div class="line"><a name="l01884"></a><span class="lineno"> 1884</span>&#160;    }</div><div class="line"><a name="l01885"></a><span class="lineno"> 1885</span>&#160;</div><div class="line"><a name="l01886"></a><span class="lineno"> 1886</span>&#160;    <span class="comment">/* Create the Redis databases, and initialize other internal state. */</span></div><div class="line"><a name="l01887"></a><span class="lineno"> 1887</span>&#160;    <span class="keywordflow">for</span> (j = 0; j &lt; server.dbnum; j++) {</div><div class="line"><a name="l01888"></a><span class="lineno"> 1888</span>&#160;        server.db[j].dict = dictCreate(&amp;dbDictType,NULL);</div><div class="line"><a name="l01889"></a><span class="lineno"> 1889</span>&#160;        server.db[j].expires = dictCreate(&amp;keyptrDictType,NULL);</div><div class="line"><a name="l01890"></a><span class="lineno"> 1890</span>&#160;        server.db[j].blocking_keys = dictCreate(&amp;keylistDictType,NULL);</div><div class="line"><a name="l01891"></a><span class="lineno"> 1891</span>&#160;        server.db[j].ready_keys = dictCreate(&amp;objectKeyPointerValueDictType,NULL);</div><div class="line"><a name="l01892"></a><span class="lineno"> 1892</span>&#160;        server.db[j].watched_keys = dictCreate(&amp;keylistDictType,NULL);</div><div class="line"><a name="l01893"></a><span class="lineno"> 1893</span>&#160;        server.db[j].id = j;</div><div class="line"><a name="l01894"></a><span class="lineno"> 1894</span>&#160;        server.db[j].avg_ttl = 0;</div><div class="line"><a name="l01895"></a><span class="lineno"> 1895</span>&#160;    }</div><div class="line"><a name="l01896"></a><span class="lineno"> 1896</span>&#160;    evictionPoolAlloc(); <span class="comment">/* Initialize the LRU keys pool. */</span></div><div class="line"><a name="l01897"></a><span class="lineno"> 1897</span>&#160;    server.pubsub_channels = dictCreate(&amp;keylistDictType,NULL);</div><div class="line"><a name="l01898"></a><span class="lineno"> 1898</span>&#160;    server.pubsub_patterns = listCreate();</div><div class="line"><a name="l01899"></a><span class="lineno"> 1899</span>&#160;    <a class="code" href="adlist_8h.html#a648e4a2d20decff3182a72a608b0b8f2">listSetFreeMethod</a>(server.pubsub_patterns,freePubsubPattern);</div><div class="line"><a name="l01900"></a><span class="lineno"> 1900</span>&#160;    <a class="code" href="adlist_8h.html#a3dac429a545f8def9a2bf9077eb66ddc">listSetMatchMethod</a>(server.pubsub_patterns,listMatchPubsubPattern);</div><div class="line"><a name="l01901"></a><span class="lineno"> 1901</span>&#160;    server.cronloops = 0;</div><div class="line"><a name="l01902"></a><span class="lineno"> 1902</span>&#160;    server.rdb_child_pid = -1;</div><div class="line"><a name="l01903"></a><span class="lineno"> 1903</span>&#160;    server.aof_child_pid = -1;</div><div class="line"><a name="l01904"></a><span class="lineno"> 1904</span>&#160;    server.rdb_child_type = <a class="code" href="server_8h.html#acfd6e0670ac08e8f4c13f33c8a2c6b5e">RDB_CHILD_TYPE_NONE</a>;</div><div class="line"><a name="l01905"></a><span class="lineno"> 1905</span>&#160;    server.rdb_bgsave_scheduled = 0;</div><div class="line"><a name="l01906"></a><span class="lineno"> 1906</span>&#160;    server.child_info_pipe[0] = -1;</div><div class="line"><a name="l01907"></a><span class="lineno"> 1907</span>&#160;    server.child_info_pipe[1] = -1;</div><div class="line"><a name="l01908"></a><span class="lineno"> 1908</span>&#160;    server.child_info_data.magic = 0;</div><div class="line"><a name="l01909"></a><span class="lineno"> 1909</span>&#160;    aofRewriteBufferReset();</div><div class="line"><a name="l01910"></a><span class="lineno"> 1910</span>&#160;    server.aof_buf = sdsempty();</div><div class="line"><a name="l01911"></a><span class="lineno"> 1911</span>&#160;    server.lastsave = time(NULL); <span class="comment">/* At startup we consider the DB saved. */</span></div><div class="line"><a name="l01912"></a><span class="lineno"> 1912</span>&#160;    server.lastbgsave_try = 0;    <span class="comment">/* At startup we never tried to BGSAVE. */</span></div><div class="line"><a name="l01913"></a><span class="lineno"> 1913</span>&#160;    server.rdb_save_time_last = -1;</div><div class="line"><a name="l01914"></a><span class="lineno"> 1914</span>&#160;    server.rdb_save_time_start = -1;</div><div class="line"><a name="l01915"></a><span class="lineno"> 1915</span>&#160;    server.dirty = 0;</div><div class="line"><a name="l01916"></a><span class="lineno"> 1916</span>&#160;    resetServerStats();</div><div class="line"><a name="l01917"></a><span class="lineno"> 1917</span>&#160;    <span class="comment">/* A few stats we don&#39;t want to reset: server startup time, and peak mem. */</span></div><div class="line"><a name="l01918"></a><span class="lineno"> 1918</span>&#160;    server.stat_starttime = time(NULL);</div><div class="line"><a name="l01919"></a><span class="lineno"> 1919</span>&#160;    server.stat_peak_memory = 0;</div><div class="line"><a name="l01920"></a><span class="lineno"> 1920</span>&#160;    server.stat_rdb_cow_bytes = 0;</div><div class="line"><a name="l01921"></a><span class="lineno"> 1921</span>&#160;    server.stat_aof_cow_bytes = 0;</div><div class="line"><a name="l01922"></a><span class="lineno"> 1922</span>&#160;    server.resident_set_size = 0;</div><div class="line"><a name="l01923"></a><span class="lineno"> 1923</span>&#160;    server.lastbgsave_status = <a class="code" href="server_8h.html#a303769ef1065076e68731584e758d3e1">C_OK</a>;</div><div class="line"><a name="l01924"></a><span class="lineno"> 1924</span>&#160;    server.aof_last_write_status = <a class="code" href="server_8h.html#a303769ef1065076e68731584e758d3e1">C_OK</a>;</div><div class="line"><a name="l01925"></a><span class="lineno"> 1925</span>&#160;    server.aof_last_write_errno = 0;</div><div class="line"><a name="l01926"></a><span class="lineno"> 1926</span>&#160;    server.repl_good_slaves_count = 0;</div><div class="line"><a name="l01927"></a><span class="lineno"> 1927</span>&#160;    updateCachedTime();</div><div class="line"><a name="l01928"></a><span class="lineno"> 1928</span>&#160;</div><div class="line"><a name="l01929"></a><span class="lineno"> 1929</span>&#160;    <span class="comment">/* Create the timer callback, this is our way to process many background</span></div><div class="line"><a name="l01930"></a><span class="lineno"> 1930</span>&#160;<span class="comment">     * operations incrementally, like clients timeout, eviction of unaccessed</span></div><div class="line"><a name="l01931"></a><span class="lineno"> 1931</span>&#160;<span class="comment">     * expired keys and so forth. */</span></div><div class="line"><a name="l01932"></a><span class="lineno"> 1932</span>&#160;    <span class="keywordflow">if</span> (aeCreateTimeEvent(server.el, 1, serverCron, NULL, NULL) == <a class="code" href="ae_8h.html#aa16dcf7effdf8f8df97f51b1cb51a9df">AE_ERR</a>) {</div><div class="line"><a name="l01933"></a><span class="lineno"> 1933</span>&#160;        <a class="code" href="server_8h.html#a11cc378e7778a830b41240578de3b204">serverPanic</a>(<span class="stringliteral">&quot;Can&#39;t create event loop timers.&quot;</span>);</div><div class="line"><a name="l01934"></a><span class="lineno"> 1934</span>&#160;        exit(1);</div><div class="line"><a name="l01935"></a><span class="lineno"> 1935</span>&#160;    }</div><div class="line"><a name="l01936"></a><span class="lineno"> 1936</span>&#160;</div><div class="line"><a name="l01937"></a><span class="lineno"> 1937</span>&#160;    <span class="comment">/* Create an event handler for accepting new connections in TCP and Unix</span></div><div class="line"><a name="l01938"></a><span class="lineno"> 1938</span>&#160;<span class="comment">     * domain sockets. */</span></div><div class="line"><a name="l01939"></a><span class="lineno"> 1939</span>&#160;    <span class="keywordflow">for</span> (j = 0; j &lt; server.ipfd_count; j++) {</div><div class="line"><a name="l01940"></a><span class="lineno"> 1940</span>&#160;        <span class="keywordflow">if</span> (aeCreateFileEvent(server.el, server.ipfd[j], <a class="code" href="ae_8h.html#a7a9a2162d007d09739955b4e55c65bf3">AE_READABLE</a>,</div><div class="line"><a name="l01941"></a><span class="lineno"> 1941</span>&#160;            acceptTcpHandler,NULL) == <a class="code" href="ae_8h.html#aa16dcf7effdf8f8df97f51b1cb51a9df">AE_ERR</a>)</div><div class="line"><a name="l01942"></a><span class="lineno"> 1942</span>&#160;            {</div><div class="line"><a name="l01943"></a><span class="lineno"> 1943</span>&#160;                <a class="code" href="server_8h.html#a11cc378e7778a830b41240578de3b204">serverPanic</a>(</div><div class="line"><a name="l01944"></a><span class="lineno"> 1944</span>&#160;                    <span class="stringliteral">&quot;Unrecoverable error creating server.ipfd file event.&quot;</span>);</div><div class="line"><a name="l01945"></a><span class="lineno"> 1945</span>&#160;            }</div><div class="line"><a name="l01946"></a><span class="lineno"> 1946</span>&#160;    }</div><div class="line"><a name="l01947"></a><span class="lineno"> 1947</span>&#160;    <span class="keywordflow">if</span> (server.sofd &gt; 0 &amp;&amp; aeCreateFileEvent(server.el,server.sofd,<a class="code" href="ae_8h.html#a7a9a2162d007d09739955b4e55c65bf3">AE_READABLE</a>,</div><div class="line"><a name="l01948"></a><span class="lineno"> 1948</span>&#160;        acceptUnixHandler,NULL) == <a class="code" href="ae_8h.html#aa16dcf7effdf8f8df97f51b1cb51a9df">AE_ERR</a>) <a class="code" href="server_8h.html#a11cc378e7778a830b41240578de3b204">serverPanic</a>(<span class="stringliteral">&quot;Unrecoverable error creating server.sofd file event.&quot;</span>);</div><div class="line"><a name="l01949"></a><span class="lineno"> 1949</span>&#160;</div><div class="line"><a name="l01950"></a><span class="lineno"> 1950</span>&#160;</div><div class="line"><a name="l01951"></a><span class="lineno"> 1951</span>&#160;    <span class="comment">/* Register a readable event for the pipe used to awake the event loop</span></div><div class="line"><a name="l01952"></a><span class="lineno"> 1952</span>&#160;<span class="comment">     * when a blocked client in a module needs attention. */</span></div><div class="line"><a name="l01953"></a><span class="lineno"> 1953</span>&#160;    <span class="keywordflow">if</span> (aeCreateFileEvent(server.el, server.module_blocked_pipe[0], <a class="code" href="ae_8h.html#a7a9a2162d007d09739955b4e55c65bf3">AE_READABLE</a>,</div><div class="line"><a name="l01954"></a><span class="lineno"> 1954</span>&#160;        moduleBlockedClientPipeReadable,NULL) == <a class="code" href="ae_8h.html#aa16dcf7effdf8f8df97f51b1cb51a9df">AE_ERR</a>) {</div><div class="line"><a name="l01955"></a><span class="lineno"> 1955</span>&#160;            <a class="code" href="server_8h.html#a11cc378e7778a830b41240578de3b204">serverPanic</a>(</div><div class="line"><a name="l01956"></a><span class="lineno"> 1956</span>&#160;                <span class="stringliteral">&quot;Error registering the readable event for the module &quot;</span></div><div class="line"><a name="l01957"></a><span class="lineno"> 1957</span>&#160;                <span class="stringliteral">&quot;blocked clients subsystem.&quot;</span>);</div><div class="line"><a name="l01958"></a><span class="lineno"> 1958</span>&#160;    }</div><div class="line"><a name="l01959"></a><span class="lineno"> 1959</span>&#160;</div><div class="line"><a name="l01960"></a><span class="lineno"> 1960</span>&#160;    <span class="comment">/* Open the AOF file if needed. */</span></div><div class="line"><a name="l01961"></a><span class="lineno"> 1961</span>&#160;    <span class="keywordflow">if</span> (server.aof_state == <a class="code" href="server_8h.html#af6b151c9dced28e94c19479197113a83">AOF_ON</a>) {</div><div class="line"><a name="l01962"></a><span class="lineno"> 1962</span>&#160;        server.aof_fd = open(server.aof_filename,</div><div class="line"><a name="l01963"></a><span class="lineno"> 1963</span>&#160;                               O_WRONLY|O_APPEND|O_CREAT,0644);</div><div class="line"><a name="l01964"></a><span class="lineno"> 1964</span>&#160;        <span class="keywordflow">if</span> (server.aof_fd == -1) {</div><div class="line"><a name="l01965"></a><span class="lineno"> 1965</span>&#160;            serverLog(<a class="code" href="server_8h.html#a31229b9334bba7d6be2a72970967a14b">LL_WARNING</a>, <span class="stringliteral">&quot;Can&#39;t open the append-only file: %s&quot;</span>,</div><div class="line"><a name="l01966"></a><span class="lineno"> 1966</span>&#160;                strerror(errno));</div><div class="line"><a name="l01967"></a><span class="lineno"> 1967</span>&#160;            exit(1);</div><div class="line"><a name="l01968"></a><span class="lineno"> 1968</span>&#160;        }</div><div class="line"><a name="l01969"></a><span class="lineno"> 1969</span>&#160;    }</div><div class="line"><a name="l01970"></a><span class="lineno"> 1970</span>&#160;</div><div class="line"><a name="l01971"></a><span class="lineno"> 1971</span>&#160;    <span class="comment">/* 32 bit instances are limited to 4GB of address space, so if there is</span></div><div class="line"><a name="l01972"></a><span class="lineno"> 1972</span>&#160;<span class="comment">     * no explicit limit in the user provided configuration we set a limit</span></div><div class="line"><a name="l01973"></a><span class="lineno"> 1973</span>&#160;<span class="comment">     * at 3 GB using maxmemory with &#39;noeviction&#39; policy&#39;. This avoids</span></div><div class="line"><a name="l01974"></a><span class="lineno"> 1974</span>&#160;<span class="comment">     * useless crashes of the Redis instance for out of memory. */</span></div><div class="line"><a name="l01975"></a><span class="lineno"> 1975</span>&#160;    <span class="keywordflow">if</span> (server.arch_bits == 32 &amp;&amp; server.maxmemory == 0) {</div><div class="line"><a name="l01976"></a><span class="lineno"> 1976</span>&#160;        serverLog(<a class="code" href="server_8h.html#a31229b9334bba7d6be2a72970967a14b">LL_WARNING</a>,<span class="stringliteral">&quot;Warning: 32 bit instance detected but no memory limit set. Setting 3 GB maxmemory limit with &#39;noeviction&#39; policy now.&quot;</span>);</div><div class="line"><a name="l01977"></a><span class="lineno"> 1977</span>&#160;        server.maxmemory = 3072LL*(1024*1024); <span class="comment">/* 3 GB */</span></div><div class="line"><a name="l01978"></a><span class="lineno"> 1978</span>&#160;        server.maxmemory_policy = <a class="code" href="server_8h.html#a418e5a222cf659c003df77830f1ae343">MAXMEMORY_NO_EVICTION</a>;</div><div class="line"><a name="l01979"></a><span class="lineno"> 1979</span>&#160;    }</div><div class="line"><a name="l01980"></a><span class="lineno"> 1980</span>&#160;</div><div class="line"><a name="l01981"></a><span class="lineno"> 1981</span>&#160;    <span class="keywordflow">if</span> (server.cluster_enabled) clusterInit();</div><div class="line"><a name="l01982"></a><span class="lineno"> 1982</span>&#160;    replicationScriptCacheInit();</div><div class="line"><a name="l01983"></a><span class="lineno"> 1983</span>&#160;    scriptingInit(1);</div><div class="line"><a name="l01984"></a><span class="lineno"> 1984</span>&#160;    slowlogInit();</div><div class="line"><a name="l01985"></a><span class="lineno"> 1985</span>&#160;    latencyMonitorInit();</div><div class="line"><a name="l01986"></a><span class="lineno"> 1986</span>&#160;    bioInit();</div><div class="line"><a name="l01987"></a><span class="lineno"> 1987</span>&#160;    server.initial_memory_usage = zmalloc_used_memory();</div><div class="line"><a name="l01988"></a><span class="lineno"> 1988</span>&#160;}</div><div class="line"><a name="l01989"></a><span class="lineno"> 1989</span>&#160;</div><div class="line"><a name="l01990"></a><span class="lineno"> 1990</span>&#160;<span class="comment">/* Populates the Redis Command Table starting from the hard coded list</span></div><div class="line"><a name="l01991"></a><span class="lineno"> 1991</span>&#160;<span class="comment"> * we have on top of redis.c file. */</span></div><div class="line"><a name="l01992"></a><span class="lineno"> 1992</span>&#160;<span class="keywordtype">void</span> populateCommandTable(<span class="keywordtype">void</span>) {</div><div class="line"><a name="l01993"></a><span class="lineno"> 1993</span>&#160;    <span class="keywordtype">int</span> j;</div><div class="line"><a name="l01994"></a><span class="lineno"> 1994</span>&#160;    <span class="keywordtype">int</span> numcommands = <span class="keyword">sizeof</span>(redisCommandTable)/<span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structredisCommand.html">redisCommand</a>);</div><div class="line"><a name="l01995"></a><span class="lineno"> 1995</span>&#160;</div><div class="line"><a name="l01996"></a><span class="lineno"> 1996</span>&#160;    <span class="keywordflow">for</span> (j = 0; j &lt; numcommands; j++) {</div><div class="line"><a name="l01997"></a><span class="lineno"> 1997</span>&#160;        <span class="keyword">struct</span> <a class="code" href="structredisCommand.html">redisCommand</a> *c = redisCommandTable+j;</div><div class="line"><a name="l01998"></a><span class="lineno"> 1998</span>&#160;        <span class="keywordtype">char</span> *f = c-&gt;sflags;</div><div class="line"><a name="l01999"></a><span class="lineno"> 1999</span>&#160;        <span class="keywordtype">int</span> retval1, retval2;</div><div class="line"><a name="l02000"></a><span class="lineno"> 2000</span>&#160;</div><div class="line"><a name="l02001"></a><span class="lineno"> 2001</span>&#160;        <span class="keywordflow">while</span>(*f != <span class="stringliteral">&#39;\0&#39;</span>) {</div><div class="line"><a name="l02002"></a><span class="lineno"> 2002</span>&#160;            <span class="keywordflow">switch</span>(*f) {</div><div class="line"><a name="l02003"></a><span class="lineno"> 2003</span>&#160;            <span class="keywordflow">case</span> <span class="stringliteral">&#39;w&#39;</span>: c-&gt;flags |= <a class="code" href="server_8h.html#a7391deb9c3a262ded3e186e94eb884e2">CMD_WRITE</a>; <span class="keywordflow">break</span>;</div><div class="line"><a name="l02004"></a><span class="lineno"> 2004</span>&#160;            <span class="keywordflow">case</span> <span class="stringliteral">&#39;r&#39;</span>: c-&gt;flags |= <a class="code" href="server_8h.html#a7e9c728f228e1c82ae1e22173375abcf">CMD_READONLY</a>; <span class="keywordflow">break</span>;</div><div class="line"><a name="l02005"></a><span class="lineno"> 2005</span>&#160;            <span class="keywordflow">case</span> <span class="stringliteral">&#39;m&#39;</span>: c-&gt;flags |= <a class="code" href="server_8h.html#aef97c640ad8dfdaca21eb67d4c37e447">CMD_DENYOOM</a>; <span class="keywordflow">break</span>;</div><div class="line"><a name="l02006"></a><span class="lineno"> 2006</span>&#160;            <span class="keywordflow">case</span> <span class="stringliteral">&#39;a&#39;</span>: c-&gt;flags |= <a class="code" href="server_8h.html#a1917805ea3942a4784ec806c33bc6033">CMD_ADMIN</a>; <span class="keywordflow">break</span>;</div><div class="line"><a name="l02007"></a><span class="lineno"> 2007</span>&#160;            <span class="keywordflow">case</span> <span class="stringliteral">&#39;p&#39;</span>: c-&gt;flags |= <a class="code" href="server_8h.html#a201d97fc457fe5bd58cb863b4ac7a0cc">CMD_PUBSUB</a>; <span class="keywordflow">break</span>;</div><div class="line"><a name="l02008"></a><span class="lineno"> 2008</span>&#160;            <span class="keywordflow">case</span> <span class="stringliteral">&#39;s&#39;</span>: c-&gt;flags |= <a class="code" href="server_8h.html#aaf26ba9b59589bc7701e36fb440a0fbe">CMD_NOSCRIPT</a>; <span class="keywordflow">break</span>;</div><div class="line"><a name="l02009"></a><span class="lineno"> 2009</span>&#160;            <span class="keywordflow">case</span> <span class="stringliteral">&#39;R&#39;</span>: c-&gt;flags |= <a class="code" href="server_8h.html#a9f6608fefa355981c2a865ef3d44f196">CMD_RANDOM</a>; <span class="keywordflow">break</span>;</div><div class="line"><a name="l02010"></a><span class="lineno"> 2010</span>&#160;            <span class="keywordflow">case</span> <span class="stringliteral">&#39;S&#39;</span>: c-&gt;flags |= <a class="code" href="server_8h.html#a819ad39aa4aef302c4421c3cd910252d">CMD_SORT_FOR_SCRIPT</a>; <span class="keywordflow">break</span>;</div><div class="line"><a name="l02011"></a><span class="lineno"> 2011</span>&#160;            <span class="keywordflow">case</span> <span class="stringliteral">&#39;l&#39;</span>: c-&gt;flags |= <a class="code" href="server_8h.html#a5327d118cf467e77d8bb0cebdce3c0ce">CMD_LOADING</a>; <span class="keywordflow">break</span>;</div><div class="line"><a name="l02012"></a><span class="lineno"> 2012</span>&#160;            <span class="keywordflow">case</span> <span class="stringliteral">&#39;t&#39;</span>: c-&gt;flags |= <a class="code" href="server_8h.html#acf1f58ff0b6790cd8d0e3edf1a7e599f">CMD_STALE</a>; <span class="keywordflow">break</span>;</div><div class="line"><a name="l02013"></a><span class="lineno"> 2013</span>&#160;            <span class="keywordflow">case</span> <span class="stringliteral">&#39;M&#39;</span>: c-&gt;flags |= <a class="code" href="server_8h.html#a43e2aecb49a88a6cd4e56bfa971bdc71">CMD_SKIP_MONITOR</a>; <span class="keywordflow">break</span>;</div><div class="line"><a name="l02014"></a><span class="lineno"> 2014</span>&#160;            <span class="keywordflow">case</span> <span class="stringliteral">&#39;k&#39;</span>: c-&gt;flags |= <a class="code" href="server_8h.html#af0b13ef0f1dabe404fd7d904cb66b548">CMD_ASKING</a>; <span class="keywordflow">break</span>;</div><div class="line"><a name="l02015"></a><span class="lineno"> 2015</span>&#160;            <span class="keywordflow">case</span> <span class="stringliteral">&#39;F&#39;</span>: c-&gt;flags |= <a class="code" href="server_8h.html#ae21dc0d9c0dcdefa14ca1054c48f252f">CMD_FAST</a>; <span class="keywordflow">break</span>;</div><div class="line"><a name="l02016"></a><span class="lineno"> 2016</span>&#160;            <span class="keywordflow">default</span>: <a class="code" href="server_8h.html#a11cc378e7778a830b41240578de3b204">serverPanic</a>(<span class="stringliteral">&quot;Unsupported command flag&quot;</span>); <span class="keywordflow">break</span>;</div><div class="line"><a name="l02017"></a><span class="lineno"> 2017</span>&#160;            }</div><div class="line"><a name="l02018"></a><span class="lineno"> 2018</span>&#160;            f++;</div><div class="line"><a name="l02019"></a><span class="lineno"> 2019</span>&#160;        }</div><div class="line"><a name="l02020"></a><span class="lineno"> 2020</span>&#160;</div><div class="line"><a name="l02021"></a><span class="lineno"> 2021</span>&#160;        retval1 = dictAdd(server.commands, sdsnew(c-&gt;name), c);</div><div class="line"><a name="l02022"></a><span class="lineno"> 2022</span>&#160;        <span class="comment">/* Populate an additional dictionary that will be unaffected</span></div><div class="line"><a name="l02023"></a><span class="lineno"> 2023</span>&#160;<span class="comment">         * by rename-command statements in redis.conf. */</span></div><div class="line"><a name="l02024"></a><span class="lineno"> 2024</span>&#160;        retval2 = dictAdd(server.orig_commands, sdsnew(c-&gt;name), c);</div><div class="line"><a name="l02025"></a><span class="lineno"> 2025</span>&#160;        <a class="code" href="server_8h.html#a88114b5169b4c382df6b56506285e56a">serverAssert</a>(retval1 == <a class="code" href="dict_8h.html#a2afecbeab8f7efbc183048f52f6d17e5">DICT_OK</a> &amp;&amp; retval2 == <a class="code" href="dict_8h.html#a2afecbeab8f7efbc183048f52f6d17e5">DICT_OK</a>);</div><div class="line"><a name="l02026"></a><span class="lineno"> 2026</span>&#160;    }</div><div class="line"><a name="l02027"></a><span class="lineno"> 2027</span>&#160;}</div><div class="line"><a name="l02028"></a><span class="lineno"> 2028</span>&#160;</div><div class="line"><a name="l02029"></a><span class="lineno"> 2029</span>&#160;<span class="keywordtype">void</span> resetCommandTableStats(<span class="keywordtype">void</span>) {</div><div class="line"><a name="l02030"></a><span class="lineno"> 2030</span>&#160;    <span class="keyword">struct</span> <a class="code" href="structredisCommand.html">redisCommand</a> *c;</div><div class="line"><a name="l02031"></a><span class="lineno"> 2031</span>&#160;    dictEntry *de;</div><div class="line"><a name="l02032"></a><span class="lineno"> 2032</span>&#160;    dictIterator *di;</div><div class="line"><a name="l02033"></a><span class="lineno"> 2033</span>&#160;</div><div class="line"><a name="l02034"></a><span class="lineno"> 2034</span>&#160;    di = dictGetSafeIterator(server.commands);</div><div class="line"><a name="l02035"></a><span class="lineno"> 2035</span>&#160;    <span class="keywordflow">while</span>((de = dictNext(di)) != NULL) {</div><div class="line"><a name="l02036"></a><span class="lineno"> 2036</span>&#160;        c = (<span class="keyword">struct</span> <a class="code" href="structredisCommand.html">redisCommand</a> *) <a class="code" href="dict_8h.html#ae8d2cc391873b2bea2b87c4f80f43120">dictGetVal</a>(de);</div><div class="line"><a name="l02037"></a><span class="lineno"> 2037</span>&#160;        c-&gt;microseconds = 0;</div><div class="line"><a name="l02038"></a><span class="lineno"> 2038</span>&#160;        c-&gt;calls = 0;</div><div class="line"><a name="l02039"></a><span class="lineno"> 2039</span>&#160;    }</div><div class="line"><a name="l02040"></a><span class="lineno"> 2040</span>&#160;    dictReleaseIterator(di);</div><div class="line"><a name="l02041"></a><span class="lineno"> 2041</span>&#160;</div><div class="line"><a name="l02042"></a><span class="lineno"> 2042</span>&#160;}</div><div class="line"><a name="l02043"></a><span class="lineno"> 2043</span>&#160;</div><div class="line"><a name="l02044"></a><span class="lineno"> 2044</span>&#160;<span class="comment">/* ========================== Redis OP Array API ============================ */</span></div><div class="line"><a name="l02045"></a><span class="lineno"> 2045</span>&#160;</div><div class="line"><a name="l02046"></a><span class="lineno"> 2046</span>&#160;<span class="keywordtype">void</span> redisOpArrayInit(redisOpArray *oa) {</div><div class="line"><a name="l02047"></a><span class="lineno"> 2047</span>&#160;    oa-&gt;ops = NULL;</div><div class="line"><a name="l02048"></a><span class="lineno"> 2048</span>&#160;    oa-&gt;numops = 0;</div><div class="line"><a name="l02049"></a><span class="lineno"> 2049</span>&#160;}</div><div class="line"><a name="l02050"></a><span class="lineno"> 2050</span>&#160;</div><div class="line"><a name="l02051"></a><span class="lineno"> 2051</span>&#160;<span class="keywordtype">int</span> redisOpArrayAppend(redisOpArray *oa, <span class="keyword">struct</span> <a class="code" href="structredisCommand.html">redisCommand</a> *cmd, <span class="keywordtype">int</span> dbid,</div><div class="line"><a name="l02052"></a><span class="lineno"> 2052</span>&#160;                       robj **argv, <span class="keywordtype">int</span> argc, <span class="keywordtype">int</span> target)</div><div class="line"><a name="l02053"></a><span class="lineno"> 2053</span>&#160;{</div><div class="line"><a name="l02054"></a><span class="lineno"> 2054</span>&#160;    redisOp *op;</div><div class="line"><a name="l02055"></a><span class="lineno"> 2055</span>&#160;</div><div class="line"><a name="l02056"></a><span class="lineno"> 2056</span>&#160;    oa-&gt;ops = zrealloc(oa-&gt;ops,<span class="keyword">sizeof</span>(redisOp)*(oa-&gt;numops+1));</div><div class="line"><a name="l02057"></a><span class="lineno"> 2057</span>&#160;    op = oa-&gt;ops+oa-&gt;numops;</div><div class="line"><a name="l02058"></a><span class="lineno"> 2058</span>&#160;    op-&gt;cmd = cmd;</div><div class="line"><a name="l02059"></a><span class="lineno"> 2059</span>&#160;    op-&gt;dbid = dbid;</div><div class="line"><a name="l02060"></a><span class="lineno"> 2060</span>&#160;    op-&gt;argv = argv;</div><div class="line"><a name="l02061"></a><span class="lineno"> 2061</span>&#160;    op-&gt;argc = argc;</div><div class="line"><a name="l02062"></a><span class="lineno"> 2062</span>&#160;    op-&gt;target = target;</div><div class="line"><a name="l02063"></a><span class="lineno"> 2063</span>&#160;    oa-&gt;numops++;</div><div class="line"><a name="l02064"></a><span class="lineno"> 2064</span>&#160;    <span class="keywordflow">return</span> oa-&gt;numops;</div><div class="line"><a name="l02065"></a><span class="lineno"> 2065</span>&#160;}</div><div class="line"><a name="l02066"></a><span class="lineno"> 2066</span>&#160;</div><div class="line"><a name="l02067"></a><span class="lineno"> 2067</span>&#160;<span class="keywordtype">void</span> redisOpArrayFree(redisOpArray *oa) {</div><div class="line"><a name="l02068"></a><span class="lineno"> 2068</span>&#160;    <span class="keywordflow">while</span>(oa-&gt;numops) {</div><div class="line"><a name="l02069"></a><span class="lineno"> 2069</span>&#160;        <span class="keywordtype">int</span> j;</div><div class="line"><a name="l02070"></a><span class="lineno"> 2070</span>&#160;        redisOp *op;</div><div class="line"><a name="l02071"></a><span class="lineno"> 2071</span>&#160;</div><div class="line"><a name="l02072"></a><span class="lineno"> 2072</span>&#160;        oa-&gt;numops--;</div><div class="line"><a name="l02073"></a><span class="lineno"> 2073</span>&#160;        op = oa-&gt;ops+oa-&gt;numops;</div><div class="line"><a name="l02074"></a><span class="lineno"> 2074</span>&#160;        <span class="keywordflow">for</span> (j = 0; j &lt; op-&gt;argc; j++)</div><div class="line"><a name="l02075"></a><span class="lineno"> 2075</span>&#160;            decrRefCount(op-&gt;argv[j]);</div><div class="line"><a name="l02076"></a><span class="lineno"> 2076</span>&#160;        zfree(op-&gt;argv);</div><div class="line"><a name="l02077"></a><span class="lineno"> 2077</span>&#160;    }</div><div class="line"><a name="l02078"></a><span class="lineno"> 2078</span>&#160;    zfree(oa-&gt;ops);</div><div class="line"><a name="l02079"></a><span class="lineno"> 2079</span>&#160;}</div><div class="line"><a name="l02080"></a><span class="lineno"> 2080</span>&#160;</div><div class="line"><a name="l02081"></a><span class="lineno"> 2081</span>&#160;<span class="comment">/* ====================== Commands lookup and execution ===================== */</span></div><div class="line"><a name="l02082"></a><span class="lineno"> 2082</span>&#160;</div><div class="line"><a name="l02083"></a><span class="lineno"> 2083</span>&#160;<span class="keyword">struct</span> <a class="code" href="structredisCommand.html">redisCommand</a> *lookupCommand(sds name) {</div><div class="line"><a name="l02084"></a><span class="lineno"> 2084</span>&#160;    <span class="keywordflow">return</span> dictFetchValue(server.commands, name);</div><div class="line"><a name="l02085"></a><span class="lineno"> 2085</span>&#160;}</div><div class="line"><a name="l02086"></a><span class="lineno"> 2086</span>&#160;</div><div class="line"><a name="l02087"></a><span class="lineno"> 2087</span>&#160;<span class="keyword">struct</span> <a class="code" href="structredisCommand.html">redisCommand</a> *lookupCommandByCString(<span class="keywordtype">char</span> *s) {</div><div class="line"><a name="l02088"></a><span class="lineno"> 2088</span>&#160;    <span class="keyword">struct</span> <a class="code" href="structredisCommand.html">redisCommand</a> *cmd;</div><div class="line"><a name="l02089"></a><span class="lineno"> 2089</span>&#160;    sds name = sdsnew(s);</div><div class="line"><a name="l02090"></a><span class="lineno"> 2090</span>&#160;</div><div class="line"><a name="l02091"></a><span class="lineno"> 2091</span>&#160;    cmd = dictFetchValue(server.commands, name);</div><div class="line"><a name="l02092"></a><span class="lineno"> 2092</span>&#160;    sdsfree(name);</div><div class="line"><a name="l02093"></a><span class="lineno"> 2093</span>&#160;    <span class="keywordflow">return</span> cmd;</div><div class="line"><a name="l02094"></a><span class="lineno"> 2094</span>&#160;}</div><div class="line"><a name="l02095"></a><span class="lineno"> 2095</span>&#160;</div><div class="line"><a name="l02096"></a><span class="lineno"> 2096</span>&#160;<span class="comment">/* Lookup the command in the current table, if not found also check in</span></div><div class="line"><a name="l02097"></a><span class="lineno"> 2097</span>&#160;<span class="comment"> * the original table containing the original command names unaffected by</span></div><div class="line"><a name="l02098"></a><span class="lineno"> 2098</span>&#160;<span class="comment"> * redis.conf rename-command statement.</span></div><div class="line"><a name="l02099"></a><span class="lineno"> 2099</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l02100"></a><span class="lineno"> 2100</span>&#160;<span class="comment"> * This is used by functions rewriting the argument vector such as</span></div><div class="line"><a name="l02101"></a><span class="lineno"> 2101</span>&#160;<span class="comment"> * rewriteClientCommandVector() in order to set client-&gt;cmd pointer</span></div><div class="line"><a name="l02102"></a><span class="lineno"> 2102</span>&#160;<span class="comment"> * correctly even if the command was renamed. */</span></div><div class="line"><a name="l02103"></a><span class="lineno"> 2103</span>&#160;<span class="keyword">struct</span> <a class="code" href="structredisCommand.html">redisCommand</a> *lookupCommandOrOriginal(sds name) {</div><div class="line"><a name="l02104"></a><span class="lineno"> 2104</span>&#160;    <span class="keyword">struct</span> <a class="code" href="structredisCommand.html">redisCommand</a> *cmd = dictFetchValue(server.commands, name);</div><div class="line"><a name="l02105"></a><span class="lineno"> 2105</span>&#160;</div><div class="line"><a name="l02106"></a><span class="lineno"> 2106</span>&#160;    <span class="keywordflow">if</span> (!cmd) cmd = dictFetchValue(server.orig_commands,name);</div><div class="line"><a name="l02107"></a><span class="lineno"> 2107</span>&#160;    <span class="keywordflow">return</span> cmd;</div><div class="line"><a name="l02108"></a><span class="lineno"> 2108</span>&#160;}</div><div class="line"><a name="l02109"></a><span class="lineno"> 2109</span>&#160;</div><div class="line"><a name="l02110"></a><span class="lineno"> 2110</span>&#160;<span class="comment">/* Propagate the specified command (in the context of the specified database id)</span></div><div class="line"><a name="l02111"></a><span class="lineno"> 2111</span>&#160;<span class="comment"> * to AOF and Slaves.</span></div><div class="line"><a name="l02112"></a><span class="lineno"> 2112</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l02113"></a><span class="lineno"> 2113</span>&#160;<span class="comment"> * flags are an xor between:</span></div><div class="line"><a name="l02114"></a><span class="lineno"> 2114</span>&#160;<span class="comment"> * + PROPAGATE_NONE (no propagation of command at all)</span></div><div class="line"><a name="l02115"></a><span class="lineno"> 2115</span>&#160;<span class="comment"> * + PROPAGATE_AOF (propagate into the AOF file if is enabled)</span></div><div class="line"><a name="l02116"></a><span class="lineno"> 2116</span>&#160;<span class="comment"> * + PROPAGATE_REPL (propagate into the replication link)</span></div><div class="line"><a name="l02117"></a><span class="lineno"> 2117</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l02118"></a><span class="lineno"> 2118</span>&#160;<span class="comment"> * This should not be used inside commands implementation. Use instead</span></div><div class="line"><a name="l02119"></a><span class="lineno"> 2119</span>&#160;<span class="comment"> * alsoPropagate(), preventCommandPropagation(), forceCommandPropagation().</span></div><div class="line"><a name="l02120"></a><span class="lineno"> 2120</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l02121"></a><span class="lineno"> 2121</span>&#160;<span class="keywordtype">void</span> propagate(<span class="keyword">struct</span> <a class="code" href="structredisCommand.html">redisCommand</a> *cmd, <span class="keywordtype">int</span> dbid, robj **argv, <span class="keywordtype">int</span> argc,</div><div class="line"><a name="l02122"></a><span class="lineno"> 2122</span>&#160;               <span class="keywordtype">int</span> flags)</div><div class="line"><a name="l02123"></a><span class="lineno"> 2123</span>&#160;{</div><div class="line"><a name="l02124"></a><span class="lineno"> 2124</span>&#160;    <span class="keywordflow">if</span> (server.aof_state != <a class="code" href="server_8h.html#a5226306fbcebcb6d5d02e0fef3c213c2">AOF_OFF</a> &amp;&amp; flags &amp; <a class="code" href="server_8h.html#a542fb79924ca427c866fd63632f60777">PROPAGATE_AOF</a>)</div><div class="line"><a name="l02125"></a><span class="lineno"> 2125</span>&#160;        feedAppendOnlyFile(cmd,dbid,argv,argc);</div><div class="line"><a name="l02126"></a><span class="lineno"> 2126</span>&#160;    <span class="keywordflow">if</span> (flags &amp; <a class="code" href="server_8h.html#a59c6e025b4ed85642a0472fc3e73e298">PROPAGATE_REPL</a>)</div><div class="line"><a name="l02127"></a><span class="lineno"> 2127</span>&#160;        replicationFeedSlaves(server.slaves,dbid,argv,argc);</div><div class="line"><a name="l02128"></a><span class="lineno"> 2128</span>&#160;}</div><div class="line"><a name="l02129"></a><span class="lineno"> 2129</span>&#160;</div><div class="line"><a name="l02130"></a><span class="lineno"> 2130</span>&#160;<span class="comment">/* Used inside commands to schedule the propagation of additional commands</span></div><div class="line"><a name="l02131"></a><span class="lineno"> 2131</span>&#160;<span class="comment"> * after the current command is propagated to AOF / Replication.</span></div><div class="line"><a name="l02132"></a><span class="lineno"> 2132</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l02133"></a><span class="lineno"> 2133</span>&#160;<span class="comment"> * &#39;cmd&#39; must be a pointer to the Redis command to replicate, dbid is the</span></div><div class="line"><a name="l02134"></a><span class="lineno"> 2134</span>&#160;<span class="comment"> * database ID the command should be propagated into.</span></div><div class="line"><a name="l02135"></a><span class="lineno"> 2135</span>&#160;<span class="comment"> * Arguments of the command to propagte are passed as an array of redis</span></div><div class="line"><a name="l02136"></a><span class="lineno"> 2136</span>&#160;<span class="comment"> * objects pointers of len &#39;argc&#39;, using the &#39;argv&#39; vector.</span></div><div class="line"><a name="l02137"></a><span class="lineno"> 2137</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l02138"></a><span class="lineno"> 2138</span>&#160;<span class="comment"> * The function does not take a reference to the passed &#39;argv&#39; vector,</span></div><div class="line"><a name="l02139"></a><span class="lineno"> 2139</span>&#160;<span class="comment"> * so it is up to the caller to release the passed argv (but it is usually</span></div><div class="line"><a name="l02140"></a><span class="lineno"> 2140</span>&#160;<span class="comment"> * stack allocated).  The function autoamtically increments ref count of</span></div><div class="line"><a name="l02141"></a><span class="lineno"> 2141</span>&#160;<span class="comment"> * passed objects, so the caller does not need to. */</span></div><div class="line"><a name="l02142"></a><span class="lineno"> 2142</span>&#160;<span class="keywordtype">void</span> alsoPropagate(<span class="keyword">struct</span> <a class="code" href="structredisCommand.html">redisCommand</a> *cmd, <span class="keywordtype">int</span> dbid, robj **argv, <span class="keywordtype">int</span> argc,</div><div class="line"><a name="l02143"></a><span class="lineno"> 2143</span>&#160;                   <span class="keywordtype">int</span> target)</div><div class="line"><a name="l02144"></a><span class="lineno"> 2144</span>&#160;{</div><div class="line"><a name="l02145"></a><span class="lineno"> 2145</span>&#160;    robj **argvcopy;</div><div class="line"><a name="l02146"></a><span class="lineno"> 2146</span>&#160;    <span class="keywordtype">int</span> j;</div><div class="line"><a name="l02147"></a><span class="lineno"> 2147</span>&#160;</div><div class="line"><a name="l02148"></a><span class="lineno"> 2148</span>&#160;    <span class="keywordflow">if</span> (server.loading) <span class="keywordflow">return</span>; <span class="comment">/* No propagation during loading. */</span></div><div class="line"><a name="l02149"></a><span class="lineno"> 2149</span>&#160;</div><div class="line"><a name="l02150"></a><span class="lineno"> 2150</span>&#160;    argvcopy = zmalloc(<span class="keyword">sizeof</span>(robj*)*argc);</div><div class="line"><a name="l02151"></a><span class="lineno"> 2151</span>&#160;    <span class="keywordflow">for</span> (j = 0; j &lt; argc; j++) {</div><div class="line"><a name="l02152"></a><span class="lineno"> 2152</span>&#160;        argvcopy[j] = argv[j];</div><div class="line"><a name="l02153"></a><span class="lineno"> 2153</span>&#160;        incrRefCount(argv[j]);</div><div class="line"><a name="l02154"></a><span class="lineno"> 2154</span>&#160;    }</div><div class="line"><a name="l02155"></a><span class="lineno"> 2155</span>&#160;    redisOpArrayAppend(&amp;server.also_propagate,cmd,dbid,argvcopy,argc,target);</div><div class="line"><a name="l02156"></a><span class="lineno"> 2156</span>&#160;}</div><div class="line"><a name="l02157"></a><span class="lineno"> 2157</span>&#160;</div><div class="line"><a name="l02158"></a><span class="lineno"> 2158</span>&#160;<span class="comment">/* It is possible to call the function forceCommandPropagation() inside a</span></div><div class="line"><a name="l02159"></a><span class="lineno"> 2159</span>&#160;<span class="comment"> * Redis command implementation in order to to force the propagation of a</span></div><div class="line"><a name="l02160"></a><span class="lineno"> 2160</span>&#160;<span class="comment"> * specific command execution into AOF / Replication. */</span></div><div class="line"><a name="l02161"></a><span class="lineno"> 2161</span>&#160;<span class="keywordtype">void</span> forceCommandPropagation(<a class="code" href="structclient.html">client</a> *c, <span class="keywordtype">int</span> flags) {</div><div class="line"><a name="l02162"></a><span class="lineno"> 2162</span>&#160;    <span class="keywordflow">if</span> (flags &amp; <a class="code" href="server_8h.html#a59c6e025b4ed85642a0472fc3e73e298">PROPAGATE_REPL</a>) c-&gt;flags |= <a class="code" href="server_8h.html#a9f89484284fb0956374bd7b6fa639602">CLIENT_FORCE_REPL</a>;</div><div class="line"><a name="l02163"></a><span class="lineno"> 2163</span>&#160;    <span class="keywordflow">if</span> (flags &amp; <a class="code" href="server_8h.html#a542fb79924ca427c866fd63632f60777">PROPAGATE_AOF</a>) c-&gt;flags |= <a class="code" href="server_8h.html#a451c1542a74f0181600d043df3f1b19a">CLIENT_FORCE_AOF</a>;</div><div class="line"><a name="l02164"></a><span class="lineno"> 2164</span>&#160;}</div><div class="line"><a name="l02165"></a><span class="lineno"> 2165</span>&#160;</div><div class="line"><a name="l02166"></a><span class="lineno"> 2166</span>&#160;<span class="comment">/* Avoid that the executed command is propagated at all. This way we</span></div><div class="line"><a name="l02167"></a><span class="lineno"> 2167</span>&#160;<span class="comment"> * are free to just propagate what we want using the alsoPropagate()</span></div><div class="line"><a name="l02168"></a><span class="lineno"> 2168</span>&#160;<span class="comment"> * API. */</span></div><div class="line"><a name="l02169"></a><span class="lineno"> 2169</span>&#160;<span class="keywordtype">void</span> preventCommandPropagation(<a class="code" href="structclient.html">client</a> *c) {</div><div class="line"><a name="l02170"></a><span class="lineno"> 2170</span>&#160;    c-&gt;flags |= <a class="code" href="server_8h.html#aea3bfee2e140aed0fc93bf087026f9a3">CLIENT_PREVENT_PROP</a>;</div><div class="line"><a name="l02171"></a><span class="lineno"> 2171</span>&#160;}</div><div class="line"><a name="l02172"></a><span class="lineno"> 2172</span>&#160;</div><div class="line"><a name="l02173"></a><span class="lineno"> 2173</span>&#160;<span class="comment">/* AOF specific version of preventCommandPropagation(). */</span></div><div class="line"><a name="l02174"></a><span class="lineno"> 2174</span>&#160;<span class="keywordtype">void</span> preventCommandAOF(<a class="code" href="structclient.html">client</a> *c) {</div><div class="line"><a name="l02175"></a><span class="lineno"> 2175</span>&#160;    c-&gt;flags |= <a class="code" href="server_8h.html#a9948ae3a2778b5a06b704231b921e7fa">CLIENT_PREVENT_AOF_PROP</a>;</div><div class="line"><a name="l02176"></a><span class="lineno"> 2176</span>&#160;}</div><div class="line"><a name="l02177"></a><span class="lineno"> 2177</span>&#160;</div><div class="line"><a name="l02178"></a><span class="lineno"> 2178</span>&#160;<span class="comment">/* Replication specific version of preventCommandPropagation(). */</span></div><div class="line"><a name="l02179"></a><span class="lineno"> 2179</span>&#160;<span class="keywordtype">void</span> preventCommandReplication(<a class="code" href="structclient.html">client</a> *c) {</div><div class="line"><a name="l02180"></a><span class="lineno"> 2180</span>&#160;    c-&gt;flags |= <a class="code" href="server_8h.html#a01c18c16bc758787b5cfc287eb7b089e">CLIENT_PREVENT_REPL_PROP</a>;</div><div class="line"><a name="l02181"></a><span class="lineno"> 2181</span>&#160;}</div><div class="line"><a name="l02182"></a><span class="lineno"> 2182</span>&#160;</div><div class="line"><a name="l02183"></a><span class="lineno"> 2183</span>&#160;<span class="comment">/* Call() is the core of Redis execution of a command.</span></div><div class="line"><a name="l02184"></a><span class="lineno"> 2184</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l02185"></a><span class="lineno"> 2185</span>&#160;<span class="comment"> * The following flags can be passed:</span></div><div class="line"><a name="l02186"></a><span class="lineno"> 2186</span>&#160;<span class="comment"> * CMD_CALL_NONE        No flags.</span></div><div class="line"><a name="l02187"></a><span class="lineno"> 2187</span>&#160;<span class="comment"> * CMD_CALL_SLOWLOG     Check command speed and log in the slow log if needed.</span></div><div class="line"><a name="l02188"></a><span class="lineno"> 2188</span>&#160;<span class="comment"> * CMD_CALL_STATS       Populate command stats.</span></div><div class="line"><a name="l02189"></a><span class="lineno"> 2189</span>&#160;<span class="comment"> * CMD_CALL_PROPAGATE_AOF   Append command to AOF if it modified the dataset</span></div><div class="line"><a name="l02190"></a><span class="lineno"> 2190</span>&#160;<span class="comment"> *                          or if the client flags are forcing propagation.</span></div><div class="line"><a name="l02191"></a><span class="lineno"> 2191</span>&#160;<span class="comment"> * CMD_CALL_PROPAGATE_REPL  Send command to salves if it modified the dataset</span></div><div class="line"><a name="l02192"></a><span class="lineno"> 2192</span>&#160;<span class="comment"> *                          or if the client flags are forcing propagation.</span></div><div class="line"><a name="l02193"></a><span class="lineno"> 2193</span>&#160;<span class="comment"> * CMD_CALL_PROPAGATE   Alias for PROPAGATE_AOF|PROPAGATE_REPL.</span></div><div class="line"><a name="l02194"></a><span class="lineno"> 2194</span>&#160;<span class="comment"> * CMD_CALL_FULL        Alias for SLOWLOG|STATS|PROPAGATE.</span></div><div class="line"><a name="l02195"></a><span class="lineno"> 2195</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l02196"></a><span class="lineno"> 2196</span>&#160;<span class="comment"> * The exact propagation behavior depends on the client flags.</span></div><div class="line"><a name="l02197"></a><span class="lineno"> 2197</span>&#160;<span class="comment"> * Specifically:</span></div><div class="line"><a name="l02198"></a><span class="lineno"> 2198</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l02199"></a><span class="lineno"> 2199</span>&#160;<span class="comment"> * 1. If the client flags CLIENT_FORCE_AOF or CLIENT_FORCE_REPL are set</span></div><div class="line"><a name="l02200"></a><span class="lineno"> 2200</span>&#160;<span class="comment"> *    and assuming the corresponding CMD_CALL_PROPAGATE_AOF/REPL is set</span></div><div class="line"><a name="l02201"></a><span class="lineno"> 2201</span>&#160;<span class="comment"> *    in the call flags, then the command is propagated even if the</span></div><div class="line"><a name="l02202"></a><span class="lineno"> 2202</span>&#160;<span class="comment"> *    dataset was not affected by the command.</span></div><div class="line"><a name="l02203"></a><span class="lineno"> 2203</span>&#160;<span class="comment"> * 2. If the client flags CLIENT_PREVENT_REPL_PROP or CLIENT_PREVENT_AOF_PROP</span></div><div class="line"><a name="l02204"></a><span class="lineno"> 2204</span>&#160;<span class="comment"> *    are set, the propagation into AOF or to slaves is not performed even</span></div><div class="line"><a name="l02205"></a><span class="lineno"> 2205</span>&#160;<span class="comment"> *    if the command modified the dataset.</span></div><div class="line"><a name="l02206"></a><span class="lineno"> 2206</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l02207"></a><span class="lineno"> 2207</span>&#160;<span class="comment"> * Note that regardless of the client flags, if CMD_CALL_PROPAGATE_AOF</span></div><div class="line"><a name="l02208"></a><span class="lineno"> 2208</span>&#160;<span class="comment"> * or CMD_CALL_PROPAGATE_REPL are not set, then respectively AOF or</span></div><div class="line"><a name="l02209"></a><span class="lineno"> 2209</span>&#160;<span class="comment"> * slaves propagation will never occur.</span></div><div class="line"><a name="l02210"></a><span class="lineno"> 2210</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l02211"></a><span class="lineno"> 2211</span>&#160;<span class="comment"> * Client flags are modified by the implementation of a given command</span></div><div class="line"><a name="l02212"></a><span class="lineno"> 2212</span>&#160;<span class="comment"> * using the following API:</span></div><div class="line"><a name="l02213"></a><span class="lineno"> 2213</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l02214"></a><span class="lineno"> 2214</span>&#160;<span class="comment"> * forceCommandPropagation(client *c, int flags);</span></div><div class="line"><a name="l02215"></a><span class="lineno"> 2215</span>&#160;<span class="comment"> * preventCommandPropagation(client *c);</span></div><div class="line"><a name="l02216"></a><span class="lineno"> 2216</span>&#160;<span class="comment"> * preventCommandAOF(client *c);</span></div><div class="line"><a name="l02217"></a><span class="lineno"> 2217</span>&#160;<span class="comment"> * preventCommandReplication(client *c);</span></div><div class="line"><a name="l02218"></a><span class="lineno"> 2218</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l02219"></a><span class="lineno"> 2219</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l02220"></a><span class="lineno"> 2220</span>&#160;<span class="keywordtype">void</span> call(<a class="code" href="structclient.html">client</a> *c, <span class="keywordtype">int</span> flags) {</div><div class="line"><a name="l02221"></a><span class="lineno"> 2221</span>&#160;    <span class="keywordtype">long</span> <span class="keywordtype">long</span> dirty, start, duration;</div><div class="line"><a name="l02222"></a><span class="lineno"> 2222</span>&#160;    <span class="keywordtype">int</span> client_old_flags = c-&gt;flags;</div><div class="line"><a name="l02223"></a><span class="lineno"> 2223</span>&#160;</div><div class="line"><a name="l02224"></a><span class="lineno"> 2224</span>&#160;    <span class="comment">/* Sent the command to clients in MONITOR mode, only if the commands are</span></div><div class="line"><a name="l02225"></a><span class="lineno"> 2225</span>&#160;<span class="comment">     * not generated from reading an AOF. */</span></div><div class="line"><a name="l02226"></a><span class="lineno"> 2226</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="adlist_8h.html#afde0ab079f934670e82119b43120e94b">listLength</a>(server.monitors) &amp;&amp;</div><div class="line"><a name="l02227"></a><span class="lineno"> 2227</span>&#160;        !server.loading &amp;&amp;</div><div class="line"><a name="l02228"></a><span class="lineno"> 2228</span>&#160;        !(c-&gt;cmd-&gt;flags &amp; (<a class="code" href="server_8h.html#a43e2aecb49a88a6cd4e56bfa971bdc71">CMD_SKIP_MONITOR</a>|<a class="code" href="server_8h.html#a1917805ea3942a4784ec806c33bc6033">CMD_ADMIN</a>)))</div><div class="line"><a name="l02229"></a><span class="lineno"> 2229</span>&#160;    {</div><div class="line"><a name="l02230"></a><span class="lineno"> 2230</span>&#160;        replicationFeedMonitors(c,server.monitors,c-&gt;db-&gt;id,c-&gt;argv,c-&gt;argc);</div><div class="line"><a name="l02231"></a><span class="lineno"> 2231</span>&#160;    }</div><div class="line"><a name="l02232"></a><span class="lineno"> 2232</span>&#160;</div><div class="line"><a name="l02233"></a><span class="lineno"> 2233</span>&#160;    <span class="comment">/* Initialization: clear the flags that must be set by the command on</span></div><div class="line"><a name="l02234"></a><span class="lineno"> 2234</span>&#160;<span class="comment">     * demand, and initialize the array for additional commands propagation. */</span></div><div class="line"><a name="l02235"></a><span class="lineno"> 2235</span>&#160;    c-&gt;flags &amp;= ~(<a class="code" href="server_8h.html#a451c1542a74f0181600d043df3f1b19a">CLIENT_FORCE_AOF</a>|<a class="code" href="server_8h.html#a9f89484284fb0956374bd7b6fa639602">CLIENT_FORCE_REPL</a>|<a class="code" href="server_8h.html#aea3bfee2e140aed0fc93bf087026f9a3">CLIENT_PREVENT_PROP</a>);</div><div class="line"><a name="l02236"></a><span class="lineno"> 2236</span>&#160;    redisOpArray prev_also_propagate = server.also_propagate;</div><div class="line"><a name="l02237"></a><span class="lineno"> 2237</span>&#160;    redisOpArrayInit(&amp;server.also_propagate);</div><div class="line"><a name="l02238"></a><span class="lineno"> 2238</span>&#160;</div><div class="line"><a name="l02239"></a><span class="lineno"> 2239</span>&#160;    <span class="comment">/* Call the command. */</span></div><div class="line"><a name="l02240"></a><span class="lineno"> 2240</span>&#160;    dirty = server.dirty;</div><div class="line"><a name="l02241"></a><span class="lineno"> 2241</span>&#160;    start = ustime();</div><div class="line"><a name="l02242"></a><span class="lineno"> 2242</span>&#160;    c-&gt;cmd-&gt;proc(c);</div><div class="line"><a name="l02243"></a><span class="lineno"> 2243</span>&#160;    duration = ustime()-start;</div><div class="line"><a name="l02244"></a><span class="lineno"> 2244</span>&#160;    dirty = server.dirty-dirty;</div><div class="line"><a name="l02245"></a><span class="lineno"> 2245</span>&#160;    <span class="keywordflow">if</span> (dirty &lt; 0) dirty = 0;</div><div class="line"><a name="l02246"></a><span class="lineno"> 2246</span>&#160;</div><div class="line"><a name="l02247"></a><span class="lineno"> 2247</span>&#160;    <span class="comment">/* When EVAL is called loading the AOF we don&#39;t want commands called</span></div><div class="line"><a name="l02248"></a><span class="lineno"> 2248</span>&#160;<span class="comment">     * from Lua to go into the slowlog or to populate statistics. */</span></div><div class="line"><a name="l02249"></a><span class="lineno"> 2249</span>&#160;    <span class="keywordflow">if</span> (server.loading &amp;&amp; c-&gt;flags &amp; <a class="code" href="server_8h.html#af9d0b0f45ef2c1fd29ac714a300de706">CLIENT_LUA</a>)</div><div class="line"><a name="l02250"></a><span class="lineno"> 2250</span>&#160;        flags &amp;= ~(<a class="code" href="server_8h.html#a934cea7b13db05a29264146cd5b14064">CMD_CALL_SLOWLOG</a> | <a class="code" href="server_8h.html#a7b1d9cf5be21e4808da0c16f03155973">CMD_CALL_STATS</a>);</div><div class="line"><a name="l02251"></a><span class="lineno"> 2251</span>&#160;</div><div class="line"><a name="l02252"></a><span class="lineno"> 2252</span>&#160;    <span class="comment">/* If the caller is Lua, we want to force the EVAL caller to propagate</span></div><div class="line"><a name="l02253"></a><span class="lineno"> 2253</span>&#160;<span class="comment">     * the script if the command flag or client flag are forcing the</span></div><div class="line"><a name="l02254"></a><span class="lineno"> 2254</span>&#160;<span class="comment">     * propagation. */</span></div><div class="line"><a name="l02255"></a><span class="lineno"> 2255</span>&#160;    <span class="keywordflow">if</span> (c-&gt;flags &amp; <a class="code" href="server_8h.html#af9d0b0f45ef2c1fd29ac714a300de706">CLIENT_LUA</a> &amp;&amp; server.lua_caller) {</div><div class="line"><a name="l02256"></a><span class="lineno"> 2256</span>&#160;        <span class="keywordflow">if</span> (c-&gt;flags &amp; <a class="code" href="server_8h.html#a9f89484284fb0956374bd7b6fa639602">CLIENT_FORCE_REPL</a>)</div><div class="line"><a name="l02257"></a><span class="lineno"> 2257</span>&#160;            server.lua_caller-&gt;flags |= <a class="code" href="server_8h.html#a9f89484284fb0956374bd7b6fa639602">CLIENT_FORCE_REPL</a>;</div><div class="line"><a name="l02258"></a><span class="lineno"> 2258</span>&#160;        <span class="keywordflow">if</span> (c-&gt;flags &amp; <a class="code" href="server_8h.html#a451c1542a74f0181600d043df3f1b19a">CLIENT_FORCE_AOF</a>)</div><div class="line"><a name="l02259"></a><span class="lineno"> 2259</span>&#160;            server.lua_caller-&gt;flags |= <a class="code" href="server_8h.html#a451c1542a74f0181600d043df3f1b19a">CLIENT_FORCE_AOF</a>;</div><div class="line"><a name="l02260"></a><span class="lineno"> 2260</span>&#160;    }</div><div class="line"><a name="l02261"></a><span class="lineno"> 2261</span>&#160;</div><div class="line"><a name="l02262"></a><span class="lineno"> 2262</span>&#160;    <span class="comment">/* Log the command into the Slow log if needed, and populate the</span></div><div class="line"><a name="l02263"></a><span class="lineno"> 2263</span>&#160;<span class="comment">     * per-command statistics that we show in INFO commandstats. */</span></div><div class="line"><a name="l02264"></a><span class="lineno"> 2264</span>&#160;    <span class="keywordflow">if</span> (flags &amp; <a class="code" href="server_8h.html#a934cea7b13db05a29264146cd5b14064">CMD_CALL_SLOWLOG</a> &amp;&amp; c-&gt;cmd-&gt;proc != execCommand) {</div><div class="line"><a name="l02265"></a><span class="lineno"> 2265</span>&#160;        <span class="keywordtype">char</span> *latency_event = (c-&gt;cmd-&gt;flags &amp; <a class="code" href="server_8h.html#ae21dc0d9c0dcdefa14ca1054c48f252f">CMD_FAST</a>) ?</div><div class="line"><a name="l02266"></a><span class="lineno"> 2266</span>&#160;                              <span class="stringliteral">&quot;fast-command&quot;</span> : <span class="stringliteral">&quot;command&quot;</span>;</div><div class="line"><a name="l02267"></a><span class="lineno"> 2267</span>&#160;        <a class="code" href="latency_8h.html#a77922ab34035890c90f98831a9071359">latencyAddSampleIfNeeded</a>(latency_event,duration/1000);</div><div class="line"><a name="l02268"></a><span class="lineno"> 2268</span>&#160;        slowlogPushEntryIfNeeded(c,c-&gt;argv,c-&gt;argc,duration);</div><div class="line"><a name="l02269"></a><span class="lineno"> 2269</span>&#160;    }</div><div class="line"><a name="l02270"></a><span class="lineno"> 2270</span>&#160;    <span class="keywordflow">if</span> (flags &amp; <a class="code" href="server_8h.html#a7b1d9cf5be21e4808da0c16f03155973">CMD_CALL_STATS</a>) {</div><div class="line"><a name="l02271"></a><span class="lineno"> 2271</span>&#160;        c-&gt;lastcmd-&gt;microseconds += duration;</div><div class="line"><a name="l02272"></a><span class="lineno"> 2272</span>&#160;        c-&gt;lastcmd-&gt;calls++;</div><div class="line"><a name="l02273"></a><span class="lineno"> 2273</span>&#160;    }</div><div class="line"><a name="l02274"></a><span class="lineno"> 2274</span>&#160;</div><div class="line"><a name="l02275"></a><span class="lineno"> 2275</span>&#160;    <span class="comment">/* Propagate the command into the AOF and replication link */</span></div><div class="line"><a name="l02276"></a><span class="lineno"> 2276</span>&#160;    <span class="keywordflow">if</span> (flags &amp; <a class="code" href="server_8h.html#a6ee9ed603f975d0d2b6ae44f1907565f">CMD_CALL_PROPAGATE</a> &amp;&amp;</div><div class="line"><a name="l02277"></a><span class="lineno"> 2277</span>&#160;        (c-&gt;flags &amp; <a class="code" href="server_8h.html#aea3bfee2e140aed0fc93bf087026f9a3">CLIENT_PREVENT_PROP</a>) != <a class="code" href="server_8h.html#aea3bfee2e140aed0fc93bf087026f9a3">CLIENT_PREVENT_PROP</a>)</div><div class="line"><a name="l02278"></a><span class="lineno"> 2278</span>&#160;    {</div><div class="line"><a name="l02279"></a><span class="lineno"> 2279</span>&#160;        <span class="keywordtype">int</span> propagate_flags = <a class="code" href="server_8h.html#a0c7409da047d754c0adeb001025acc03">PROPAGATE_NONE</a>;</div><div class="line"><a name="l02280"></a><span class="lineno"> 2280</span>&#160;</div><div class="line"><a name="l02281"></a><span class="lineno"> 2281</span>&#160;        <span class="comment">/* Check if the command operated changes in the data set. If so</span></div><div class="line"><a name="l02282"></a><span class="lineno"> 2282</span>&#160;<span class="comment">         * set for replication / AOF propagation. */</span></div><div class="line"><a name="l02283"></a><span class="lineno"> 2283</span>&#160;        <span class="keywordflow">if</span> (dirty) propagate_flags |= (<a class="code" href="server_8h.html#a542fb79924ca427c866fd63632f60777">PROPAGATE_AOF</a>|<a class="code" href="server_8h.html#a59c6e025b4ed85642a0472fc3e73e298">PROPAGATE_REPL</a>);</div><div class="line"><a name="l02284"></a><span class="lineno"> 2284</span>&#160;</div><div class="line"><a name="l02285"></a><span class="lineno"> 2285</span>&#160;        <span class="comment">/* If the client forced AOF / replication of the command, set</span></div><div class="line"><a name="l02286"></a><span class="lineno"> 2286</span>&#160;<span class="comment">         * the flags regardless of the command effects on the data set. */</span></div><div class="line"><a name="l02287"></a><span class="lineno"> 2287</span>&#160;        <span class="keywordflow">if</span> (c-&gt;flags &amp; <a class="code" href="server_8h.html#a9f89484284fb0956374bd7b6fa639602">CLIENT_FORCE_REPL</a>) propagate_flags |= <a class="code" href="server_8h.html#a59c6e025b4ed85642a0472fc3e73e298">PROPAGATE_REPL</a>;</div><div class="line"><a name="l02288"></a><span class="lineno"> 2288</span>&#160;        <span class="keywordflow">if</span> (c-&gt;flags &amp; <a class="code" href="server_8h.html#a451c1542a74f0181600d043df3f1b19a">CLIENT_FORCE_AOF</a>) propagate_flags |= <a class="code" href="server_8h.html#a542fb79924ca427c866fd63632f60777">PROPAGATE_AOF</a>;</div><div class="line"><a name="l02289"></a><span class="lineno"> 2289</span>&#160;</div><div class="line"><a name="l02290"></a><span class="lineno"> 2290</span>&#160;        <span class="comment">/* However prevent AOF / replication propagation if the command</span></div><div class="line"><a name="l02291"></a><span class="lineno"> 2291</span>&#160;<span class="comment">         * implementatino called preventCommandPropagation() or similar,</span></div><div class="line"><a name="l02292"></a><span class="lineno"> 2292</span>&#160;<span class="comment">         * or if we don&#39;t have the call() flags to do so. */</span></div><div class="line"><a name="l02293"></a><span class="lineno"> 2293</span>&#160;        <span class="keywordflow">if</span> (c-&gt;flags &amp; <a class="code" href="server_8h.html#a01c18c16bc758787b5cfc287eb7b089e">CLIENT_PREVENT_REPL_PROP</a> ||</div><div class="line"><a name="l02294"></a><span class="lineno"> 2294</span>&#160;            !(flags &amp; <a class="code" href="server_8h.html#a69e4a8fdb26588e1028deb20fd51424a">CMD_CALL_PROPAGATE_REPL</a>))</div><div class="line"><a name="l02295"></a><span class="lineno"> 2295</span>&#160;                propagate_flags &amp;= ~<a class="code" href="server_8h.html#a59c6e025b4ed85642a0472fc3e73e298">PROPAGATE_REPL</a>;</div><div class="line"><a name="l02296"></a><span class="lineno"> 2296</span>&#160;        <span class="keywordflow">if</span> (c-&gt;flags &amp; <a class="code" href="server_8h.html#a9948ae3a2778b5a06b704231b921e7fa">CLIENT_PREVENT_AOF_PROP</a> ||</div><div class="line"><a name="l02297"></a><span class="lineno"> 2297</span>&#160;            !(flags &amp; <a class="code" href="server_8h.html#a3ca848c94df18641ac372c58fca0e236">CMD_CALL_PROPAGATE_AOF</a>))</div><div class="line"><a name="l02298"></a><span class="lineno"> 2298</span>&#160;                propagate_flags &amp;= ~<a class="code" href="server_8h.html#a542fb79924ca427c866fd63632f60777">PROPAGATE_AOF</a>;</div><div class="line"><a name="l02299"></a><span class="lineno"> 2299</span>&#160;</div><div class="line"><a name="l02300"></a><span class="lineno"> 2300</span>&#160;        <span class="comment">/* Call propagate() only if at least one of AOF / replication</span></div><div class="line"><a name="l02301"></a><span class="lineno"> 2301</span>&#160;<span class="comment">         * propagation is needed. Note that modules commands handle replication</span></div><div class="line"><a name="l02302"></a><span class="lineno"> 2302</span>&#160;<span class="comment">         * in an explicit way, so we never replicate them automatically. */</span></div><div class="line"><a name="l02303"></a><span class="lineno"> 2303</span>&#160;        <span class="keywordflow">if</span> (propagate_flags != <a class="code" href="server_8h.html#a0c7409da047d754c0adeb001025acc03">PROPAGATE_NONE</a> &amp;&amp; !(c-&gt;cmd-&gt;flags &amp; <a class="code" href="server_8h.html#accabd32f20281543986166c219124f9e">CMD_MODULE</a>))</div><div class="line"><a name="l02304"></a><span class="lineno"> 2304</span>&#160;            propagate(c-&gt;cmd,c-&gt;db-&gt;id,c-&gt;argv,c-&gt;argc,propagate_flags);</div><div class="line"><a name="l02305"></a><span class="lineno"> 2305</span>&#160;    }</div><div class="line"><a name="l02306"></a><span class="lineno"> 2306</span>&#160;</div><div class="line"><a name="l02307"></a><span class="lineno"> 2307</span>&#160;    <span class="comment">/* Restore the old replication flags, since call() can be executed</span></div><div class="line"><a name="l02308"></a><span class="lineno"> 2308</span>&#160;<span class="comment">     * recursively. */</span></div><div class="line"><a name="l02309"></a><span class="lineno"> 2309</span>&#160;    c-&gt;flags &amp;= ~(<a class="code" href="server_8h.html#a451c1542a74f0181600d043df3f1b19a">CLIENT_FORCE_AOF</a>|<a class="code" href="server_8h.html#a9f89484284fb0956374bd7b6fa639602">CLIENT_FORCE_REPL</a>|<a class="code" href="server_8h.html#aea3bfee2e140aed0fc93bf087026f9a3">CLIENT_PREVENT_PROP</a>);</div><div class="line"><a name="l02310"></a><span class="lineno"> 2310</span>&#160;    c-&gt;flags |= client_old_flags &amp;</div><div class="line"><a name="l02311"></a><span class="lineno"> 2311</span>&#160;        (<a class="code" href="server_8h.html#a451c1542a74f0181600d043df3f1b19a">CLIENT_FORCE_AOF</a>|<a class="code" href="server_8h.html#a9f89484284fb0956374bd7b6fa639602">CLIENT_FORCE_REPL</a>|<a class="code" href="server_8h.html#aea3bfee2e140aed0fc93bf087026f9a3">CLIENT_PREVENT_PROP</a>);</div><div class="line"><a name="l02312"></a><span class="lineno"> 2312</span>&#160;</div><div class="line"><a name="l02313"></a><span class="lineno"> 2313</span>&#160;    <span class="comment">/* Handle the alsoPropagate() API to handle commands that want to propagate</span></div><div class="line"><a name="l02314"></a><span class="lineno"> 2314</span>&#160;<span class="comment">     * multiple separated commands. Note that alsoPropagate() is not affected</span></div><div class="line"><a name="l02315"></a><span class="lineno"> 2315</span>&#160;<span class="comment">     * by CLIENT_PREVENT_PROP flag. */</span></div><div class="line"><a name="l02316"></a><span class="lineno"> 2316</span>&#160;    <span class="keywordflow">if</span> (server.also_propagate.numops) {</div><div class="line"><a name="l02317"></a><span class="lineno"> 2317</span>&#160;        <span class="keywordtype">int</span> j;</div><div class="line"><a name="l02318"></a><span class="lineno"> 2318</span>&#160;        redisOp *rop;</div><div class="line"><a name="l02319"></a><span class="lineno"> 2319</span>&#160;</div><div class="line"><a name="l02320"></a><span class="lineno"> 2320</span>&#160;        <span class="keywordflow">if</span> (flags &amp; <a class="code" href="server_8h.html#a6ee9ed603f975d0d2b6ae44f1907565f">CMD_CALL_PROPAGATE</a>) {</div><div class="line"><a name="l02321"></a><span class="lineno"> 2321</span>&#160;            <span class="keywordflow">for</span> (j = 0; j &lt; server.also_propagate.numops; j++) {</div><div class="line"><a name="l02322"></a><span class="lineno"> 2322</span>&#160;                rop = &amp;server.also_propagate.ops[j];</div><div class="line"><a name="l02323"></a><span class="lineno"> 2323</span>&#160;                <span class="keywordtype">int</span> target = rop-&gt;target;</div><div class="line"><a name="l02324"></a><span class="lineno"> 2324</span>&#160;                <span class="comment">/* Whatever the command wish is, we honor the call() flags. */</span></div><div class="line"><a name="l02325"></a><span class="lineno"> 2325</span>&#160;                <span class="keywordflow">if</span> (!(flags&amp;<a class="code" href="server_8h.html#a3ca848c94df18641ac372c58fca0e236">CMD_CALL_PROPAGATE_AOF</a>)) target &amp;= ~<a class="code" href="server_8h.html#a542fb79924ca427c866fd63632f60777">PROPAGATE_AOF</a>;</div><div class="line"><a name="l02326"></a><span class="lineno"> 2326</span>&#160;                <span class="keywordflow">if</span> (!(flags&amp;<a class="code" href="server_8h.html#a69e4a8fdb26588e1028deb20fd51424a">CMD_CALL_PROPAGATE_REPL</a>)) target &amp;= ~<a class="code" href="server_8h.html#a59c6e025b4ed85642a0472fc3e73e298">PROPAGATE_REPL</a>;</div><div class="line"><a name="l02327"></a><span class="lineno"> 2327</span>&#160;                <span class="keywordflow">if</span> (target)</div><div class="line"><a name="l02328"></a><span class="lineno"> 2328</span>&#160;                    propagate(rop-&gt;cmd,rop-&gt;dbid,rop-&gt;argv,rop-&gt;argc,target);</div><div class="line"><a name="l02329"></a><span class="lineno"> 2329</span>&#160;            }</div><div class="line"><a name="l02330"></a><span class="lineno"> 2330</span>&#160;        }</div><div class="line"><a name="l02331"></a><span class="lineno"> 2331</span>&#160;        redisOpArrayFree(&amp;server.also_propagate);</div><div class="line"><a name="l02332"></a><span class="lineno"> 2332</span>&#160;    }</div><div class="line"><a name="l02333"></a><span class="lineno"> 2333</span>&#160;    server.also_propagate = prev_also_propagate;</div><div class="line"><a name="l02334"></a><span class="lineno"> 2334</span>&#160;    server.stat_numcommands++;</div><div class="line"><a name="l02335"></a><span class="lineno"> 2335</span>&#160;}</div><div class="line"><a name="l02336"></a><span class="lineno"> 2336</span>&#160;</div><div class="line"><a name="l02337"></a><span class="lineno"> 2337</span>&#160;<span class="comment">/* If this function gets called we already read a whole</span></div><div class="line"><a name="l02338"></a><span class="lineno"> 2338</span>&#160;<span class="comment"> * command, arguments are in the client argv/argc fields.</span></div><div class="line"><a name="l02339"></a><span class="lineno"> 2339</span>&#160;<span class="comment"> * processCommand() execute the command or prepare the</span></div><div class="line"><a name="l02340"></a><span class="lineno"> 2340</span>&#160;<span class="comment"> * server for a bulk read from the client.</span></div><div class="line"><a name="l02341"></a><span class="lineno"> 2341</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l02342"></a><span class="lineno"> 2342</span>&#160;<span class="comment"> * If C_OK is returned the client is still alive and valid and</span></div><div class="line"><a name="l02343"></a><span class="lineno"> 2343</span>&#160;<span class="comment"> * other operations can be performed by the caller. Otherwise</span></div><div class="line"><a name="l02344"></a><span class="lineno"> 2344</span>&#160;<span class="comment"> * if C_ERR is returned the client was destroyed (i.e. after QUIT). */</span></div><div class="line"><a name="l02345"></a><span class="lineno"> 2345</span>&#160;<span class="keywordtype">int</span> processCommand(<a class="code" href="structclient.html">client</a> *c) {</div><div class="line"><a name="l02346"></a><span class="lineno"> 2346</span>&#160;    <span class="comment">/* The QUIT command is handled separately. Normal command procs will</span></div><div class="line"><a name="l02347"></a><span class="lineno"> 2347</span>&#160;<span class="comment">     * go through checking for replication and QUIT will cause trouble</span></div><div class="line"><a name="l02348"></a><span class="lineno"> 2348</span>&#160;<span class="comment">     * when FORCE_REPLICATION is enabled and would be implemented in</span></div><div class="line"><a name="l02349"></a><span class="lineno"> 2349</span>&#160;<span class="comment">     * a regular command proc. */</span></div><div class="line"><a name="l02350"></a><span class="lineno"> 2350</span>&#160;    <span class="keywordflow">if</span> (!strcasecmp(c-&gt;argv[0]-&gt;ptr,<span class="stringliteral">&quot;quit&quot;</span>)) {</div><div class="line"><a name="l02351"></a><span class="lineno"> 2351</span>&#160;        addReply(c,shared.ok);</div><div class="line"><a name="l02352"></a><span class="lineno"> 2352</span>&#160;        c-&gt;flags |= <a class="code" href="server_8h.html#a8cff2154afcc2e87ac85bdbbe2814091">CLIENT_CLOSE_AFTER_REPLY</a>;</div><div class="line"><a name="l02353"></a><span class="lineno"> 2353</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="server_8h.html#af98ac28d5f4d23d7ed5985188e6fb7d1">C_ERR</a>;</div><div class="line"><a name="l02354"></a><span class="lineno"> 2354</span>&#160;    }</div><div class="line"><a name="l02355"></a><span class="lineno"> 2355</span>&#160;</div><div class="line"><a name="l02356"></a><span class="lineno"> 2356</span>&#160;    <span class="comment">/* Now lookup the command and check ASAP about trivial error conditions</span></div><div class="line"><a name="l02357"></a><span class="lineno"> 2357</span>&#160;<span class="comment">     * such as wrong arity, bad command name and so forth. */</span></div><div class="line"><a name="l02358"></a><span class="lineno"> 2358</span>&#160;    c-&gt;cmd = c-&gt;lastcmd = lookupCommand(c-&gt;argv[0]-&gt;ptr);</div><div class="line"><a name="l02359"></a><span class="lineno"> 2359</span>&#160;    <span class="keywordflow">if</span> (!c-&gt;cmd) {</div><div class="line"><a name="l02360"></a><span class="lineno"> 2360</span>&#160;        flagTransaction(c);</div><div class="line"><a name="l02361"></a><span class="lineno"> 2361</span>&#160;        addReplyErrorFormat(c,<span class="stringliteral">&quot;unknown command &#39;%s&#39;&quot;</span>,</div><div class="line"><a name="l02362"></a><span class="lineno"> 2362</span>&#160;            (<span class="keywordtype">char</span>*)c-&gt;argv[0]-&gt;ptr);</div><div class="line"><a name="l02363"></a><span class="lineno"> 2363</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="server_8h.html#a303769ef1065076e68731584e758d3e1">C_OK</a>;</div><div class="line"><a name="l02364"></a><span class="lineno"> 2364</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((c-&gt;cmd-&gt;arity &gt; 0 &amp;&amp; c-&gt;cmd-&gt;arity != c-&gt;argc) ||</div><div class="line"><a name="l02365"></a><span class="lineno"> 2365</span>&#160;               (c-&gt;argc &lt; -c-&gt;cmd-&gt;arity)) {</div><div class="line"><a name="l02366"></a><span class="lineno"> 2366</span>&#160;        flagTransaction(c);</div><div class="line"><a name="l02367"></a><span class="lineno"> 2367</span>&#160;        addReplyErrorFormat(c,<span class="stringliteral">&quot;wrong number of arguments for &#39;%s&#39; command&quot;</span>,</div><div class="line"><a name="l02368"></a><span class="lineno"> 2368</span>&#160;            c-&gt;cmd-&gt;name);</div><div class="line"><a name="l02369"></a><span class="lineno"> 2369</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="server_8h.html#a303769ef1065076e68731584e758d3e1">C_OK</a>;</div><div class="line"><a name="l02370"></a><span class="lineno"> 2370</span>&#160;    }</div><div class="line"><a name="l02371"></a><span class="lineno"> 2371</span>&#160;</div><div class="line"><a name="l02372"></a><span class="lineno"> 2372</span>&#160;    <span class="comment">/* Check if the user is authenticated */</span></div><div class="line"><a name="l02373"></a><span class="lineno"> 2373</span>&#160;    <span class="keywordflow">if</span> (server.requirepass &amp;&amp; !c-&gt;authenticated &amp;&amp; c-&gt;cmd-&gt;proc != authCommand)</div><div class="line"><a name="l02374"></a><span class="lineno"> 2374</span>&#160;    {</div><div class="line"><a name="l02375"></a><span class="lineno"> 2375</span>&#160;        flagTransaction(c);</div><div class="line"><a name="l02376"></a><span class="lineno"> 2376</span>&#160;        addReply(c,shared.noautherr);</div><div class="line"><a name="l02377"></a><span class="lineno"> 2377</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="server_8h.html#a303769ef1065076e68731584e758d3e1">C_OK</a>;</div><div class="line"><a name="l02378"></a><span class="lineno"> 2378</span>&#160;    }</div><div class="line"><a name="l02379"></a><span class="lineno"> 2379</span>&#160;</div><div class="line"><a name="l02380"></a><span class="lineno"> 2380</span>&#160;    <span class="comment">/* If cluster is enabled perform the cluster redirection here.</span></div><div class="line"><a name="l02381"></a><span class="lineno"> 2381</span>&#160;<span class="comment">     * However we don&#39;t perform the redirection if:</span></div><div class="line"><a name="l02382"></a><span class="lineno"> 2382</span>&#160;<span class="comment">     * 1) The sender of this command is our master.</span></div><div class="line"><a name="l02383"></a><span class="lineno"> 2383</span>&#160;<span class="comment">     * 2) The command has no key arguments. */</span></div><div class="line"><a name="l02384"></a><span class="lineno"> 2384</span>&#160;    <span class="keywordflow">if</span> (server.cluster_enabled &amp;&amp;</div><div class="line"><a name="l02385"></a><span class="lineno"> 2385</span>&#160;        !(c-&gt;flags &amp; <a class="code" href="server_8h.html#a3d8f0cc8d0653ee2b6dafb454292c069">CLIENT_MASTER</a>) &amp;&amp;</div><div class="line"><a name="l02386"></a><span class="lineno"> 2386</span>&#160;        !(c-&gt;flags &amp; <a class="code" href="server_8h.html#af9d0b0f45ef2c1fd29ac714a300de706">CLIENT_LUA</a> &amp;&amp;</div><div class="line"><a name="l02387"></a><span class="lineno"> 2387</span>&#160;          server.lua_caller-&gt;flags &amp; <a class="code" href="server_8h.html#a3d8f0cc8d0653ee2b6dafb454292c069">CLIENT_MASTER</a>) &amp;&amp;</div><div class="line"><a name="l02388"></a><span class="lineno"> 2388</span>&#160;        !(c-&gt;cmd-&gt;getkeys_proc == NULL &amp;&amp; c-&gt;cmd-&gt;firstkey == 0 &amp;&amp;</div><div class="line"><a name="l02389"></a><span class="lineno"> 2389</span>&#160;          c-&gt;cmd-&gt;proc != execCommand))</div><div class="line"><a name="l02390"></a><span class="lineno"> 2390</span>&#160;    {</div><div class="line"><a name="l02391"></a><span class="lineno"> 2391</span>&#160;        <span class="keywordtype">int</span> hashslot;</div><div class="line"><a name="l02392"></a><span class="lineno"> 2392</span>&#160;        <span class="keywordtype">int</span> error_code;</div><div class="line"><a name="l02393"></a><span class="lineno"> 2393</span>&#160;        clusterNode *n = getNodeByQuery(c,c-&gt;cmd,c-&gt;argv,c-&gt;argc,</div><div class="line"><a name="l02394"></a><span class="lineno"> 2394</span>&#160;                                        &amp;hashslot,&amp;error_code);</div><div class="line"><a name="l02395"></a><span class="lineno"> 2395</span>&#160;        <span class="keywordflow">if</span> (n == NULL || n != server.cluster-&gt;myself) {</div><div class="line"><a name="l02396"></a><span class="lineno"> 2396</span>&#160;            <span class="keywordflow">if</span> (c-&gt;cmd-&gt;proc == execCommand) {</div><div class="line"><a name="l02397"></a><span class="lineno"> 2397</span>&#160;                discardTransaction(c);</div><div class="line"><a name="l02398"></a><span class="lineno"> 2398</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l02399"></a><span class="lineno"> 2399</span>&#160;                flagTransaction(c);</div><div class="line"><a name="l02400"></a><span class="lineno"> 2400</span>&#160;            }</div><div class="line"><a name="l02401"></a><span class="lineno"> 2401</span>&#160;            clusterRedirectClient(c,n,hashslot,error_code);</div><div class="line"><a name="l02402"></a><span class="lineno"> 2402</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="server_8h.html#a303769ef1065076e68731584e758d3e1">C_OK</a>;</div><div class="line"><a name="l02403"></a><span class="lineno"> 2403</span>&#160;        }</div><div class="line"><a name="l02404"></a><span class="lineno"> 2404</span>&#160;    }</div><div class="line"><a name="l02405"></a><span class="lineno"> 2405</span>&#160;</div><div class="line"><a name="l02406"></a><span class="lineno"> 2406</span>&#160;    <span class="comment">/* Handle the maxmemory directive.</span></div><div class="line"><a name="l02407"></a><span class="lineno"> 2407</span>&#160;<span class="comment">     *</span></div><div class="line"><a name="l02408"></a><span class="lineno"> 2408</span>&#160;<span class="comment">     * First we try to free some memory if possible (if there are volatile</span></div><div class="line"><a name="l02409"></a><span class="lineno"> 2409</span>&#160;<span class="comment">     * keys in the dataset). If there are not the only thing we can do</span></div><div class="line"><a name="l02410"></a><span class="lineno"> 2410</span>&#160;<span class="comment">     * is returning an error. */</span></div><div class="line"><a name="l02411"></a><span class="lineno"> 2411</span>&#160;    <span class="keywordflow">if</span> (server.maxmemory) {</div><div class="line"><a name="l02412"></a><span class="lineno"> 2412</span>&#160;        <span class="keywordtype">int</span> retval = freeMemoryIfNeeded();</div><div class="line"><a name="l02413"></a><span class="lineno"> 2413</span>&#160;        <span class="comment">/* freeMemoryIfNeeded may flush slave output buffers. This may result</span></div><div class="line"><a name="l02414"></a><span class="lineno"> 2414</span>&#160;<span class="comment">         * into a slave, that may be the active client, to be freed. */</span></div><div class="line"><a name="l02415"></a><span class="lineno"> 2415</span>&#160;        <span class="keywordflow">if</span> (server.current_client == NULL) <span class="keywordflow">return</span> <a class="code" href="server_8h.html#af98ac28d5f4d23d7ed5985188e6fb7d1">C_ERR</a>;</div><div class="line"><a name="l02416"></a><span class="lineno"> 2416</span>&#160;</div><div class="line"><a name="l02417"></a><span class="lineno"> 2417</span>&#160;        <span class="comment">/* It was impossible to free enough memory, and the command the client</span></div><div class="line"><a name="l02418"></a><span class="lineno"> 2418</span>&#160;<span class="comment">         * is trying to execute is denied during OOM conditions? Error. */</span></div><div class="line"><a name="l02419"></a><span class="lineno"> 2419</span>&#160;        <span class="keywordflow">if</span> ((c-&gt;cmd-&gt;flags &amp; <a class="code" href="server_8h.html#aef97c640ad8dfdaca21eb67d4c37e447">CMD_DENYOOM</a>) &amp;&amp; retval == <a class="code" href="server_8h.html#af98ac28d5f4d23d7ed5985188e6fb7d1">C_ERR</a>) {</div><div class="line"><a name="l02420"></a><span class="lineno"> 2420</span>&#160;            flagTransaction(c);</div><div class="line"><a name="l02421"></a><span class="lineno"> 2421</span>&#160;            addReply(c, shared.oomerr);</div><div class="line"><a name="l02422"></a><span class="lineno"> 2422</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="server_8h.html#a303769ef1065076e68731584e758d3e1">C_OK</a>;</div><div class="line"><a name="l02423"></a><span class="lineno"> 2423</span>&#160;        }</div><div class="line"><a name="l02424"></a><span class="lineno"> 2424</span>&#160;    }</div><div class="line"><a name="l02425"></a><span class="lineno"> 2425</span>&#160;</div><div class="line"><a name="l02426"></a><span class="lineno"> 2426</span>&#160;    <span class="comment">/* Don&#39;t accept write commands if there are problems persisting on disk</span></div><div class="line"><a name="l02427"></a><span class="lineno"> 2427</span>&#160;<span class="comment">     * and if this is a master instance. */</span></div><div class="line"><a name="l02428"></a><span class="lineno"> 2428</span>&#160;    <span class="keywordflow">if</span> (((server.stop_writes_on_bgsave_err &amp;&amp;</div><div class="line"><a name="l02429"></a><span class="lineno"> 2429</span>&#160;          server.saveparamslen &gt; 0 &amp;&amp;</div><div class="line"><a name="l02430"></a><span class="lineno"> 2430</span>&#160;          server.lastbgsave_status == <a class="code" href="server_8h.html#af98ac28d5f4d23d7ed5985188e6fb7d1">C_ERR</a>) ||</div><div class="line"><a name="l02431"></a><span class="lineno"> 2431</span>&#160;          server.aof_last_write_status == <a class="code" href="server_8h.html#af98ac28d5f4d23d7ed5985188e6fb7d1">C_ERR</a>) &amp;&amp;</div><div class="line"><a name="l02432"></a><span class="lineno"> 2432</span>&#160;        server.masterhost == NULL &amp;&amp;</div><div class="line"><a name="l02433"></a><span class="lineno"> 2433</span>&#160;        (c-&gt;cmd-&gt;flags &amp; <a class="code" href="server_8h.html#a7391deb9c3a262ded3e186e94eb884e2">CMD_WRITE</a> ||</div><div class="line"><a name="l02434"></a><span class="lineno"> 2434</span>&#160;         c-&gt;cmd-&gt;proc == pingCommand))</div><div class="line"><a name="l02435"></a><span class="lineno"> 2435</span>&#160;    {</div><div class="line"><a name="l02436"></a><span class="lineno"> 2436</span>&#160;        flagTransaction(c);</div><div class="line"><a name="l02437"></a><span class="lineno"> 2437</span>&#160;        <span class="keywordflow">if</span> (server.aof_last_write_status == <a class="code" href="server_8h.html#a303769ef1065076e68731584e758d3e1">C_OK</a>)</div><div class="line"><a name="l02438"></a><span class="lineno"> 2438</span>&#160;            addReply(c, shared.bgsaveerr);</div><div class="line"><a name="l02439"></a><span class="lineno"> 2439</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l02440"></a><span class="lineno"> 2440</span>&#160;            addReplySds(c,</div><div class="line"><a name="l02441"></a><span class="lineno"> 2441</span>&#160;                sdscatprintf(sdsempty(),</div><div class="line"><a name="l02442"></a><span class="lineno"> 2442</span>&#160;                <span class="stringliteral">&quot;-MISCONF Errors writing to the AOF file: %s\r\n&quot;</span>,</div><div class="line"><a name="l02443"></a><span class="lineno"> 2443</span>&#160;                strerror(server.aof_last_write_errno)));</div><div class="line"><a name="l02444"></a><span class="lineno"> 2444</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="server_8h.html#a303769ef1065076e68731584e758d3e1">C_OK</a>;</div><div class="line"><a name="l02445"></a><span class="lineno"> 2445</span>&#160;    }</div><div class="line"><a name="l02446"></a><span class="lineno"> 2446</span>&#160;</div><div class="line"><a name="l02447"></a><span class="lineno"> 2447</span>&#160;    <span class="comment">/* Don&#39;t accept write commands if there are not enough good slaves and</span></div><div class="line"><a name="l02448"></a><span class="lineno"> 2448</span>&#160;<span class="comment">     * user configured the min-slaves-to-write option. */</span></div><div class="line"><a name="l02449"></a><span class="lineno"> 2449</span>&#160;    <span class="keywordflow">if</span> (server.masterhost == NULL &amp;&amp;</div><div class="line"><a name="l02450"></a><span class="lineno"> 2450</span>&#160;        server.repl_min_slaves_to_write &amp;&amp;</div><div class="line"><a name="l02451"></a><span class="lineno"> 2451</span>&#160;        server.repl_min_slaves_max_lag &amp;&amp;</div><div class="line"><a name="l02452"></a><span class="lineno"> 2452</span>&#160;        c-&gt;cmd-&gt;flags &amp; <a class="code" href="server_8h.html#a7391deb9c3a262ded3e186e94eb884e2">CMD_WRITE</a> &amp;&amp;</div><div class="line"><a name="l02453"></a><span class="lineno"> 2453</span>&#160;        server.repl_good_slaves_count &lt; server.repl_min_slaves_to_write)</div><div class="line"><a name="l02454"></a><span class="lineno"> 2454</span>&#160;    {</div><div class="line"><a name="l02455"></a><span class="lineno"> 2455</span>&#160;        flagTransaction(c);</div><div class="line"><a name="l02456"></a><span class="lineno"> 2456</span>&#160;        addReply(c, shared.noreplicaserr);</div><div class="line"><a name="l02457"></a><span class="lineno"> 2457</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="server_8h.html#a303769ef1065076e68731584e758d3e1">C_OK</a>;</div><div class="line"><a name="l02458"></a><span class="lineno"> 2458</span>&#160;    }</div><div class="line"><a name="l02459"></a><span class="lineno"> 2459</span>&#160;</div><div class="line"><a name="l02460"></a><span class="lineno"> 2460</span>&#160;    <span class="comment">/* Don&#39;t accept write commands if this is a read only slave. But</span></div><div class="line"><a name="l02461"></a><span class="lineno"> 2461</span>&#160;<span class="comment">     * accept write commands if this is our master. */</span></div><div class="line"><a name="l02462"></a><span class="lineno"> 2462</span>&#160;    <span class="keywordflow">if</span> (server.masterhost &amp;&amp; server.repl_slave_ro &amp;&amp;</div><div class="line"><a name="l02463"></a><span class="lineno"> 2463</span>&#160;        !(c-&gt;flags &amp; <a class="code" href="server_8h.html#a3d8f0cc8d0653ee2b6dafb454292c069">CLIENT_MASTER</a>) &amp;&amp;</div><div class="line"><a name="l02464"></a><span class="lineno"> 2464</span>&#160;        c-&gt;cmd-&gt;flags &amp; <a class="code" href="server_8h.html#a7391deb9c3a262ded3e186e94eb884e2">CMD_WRITE</a>)</div><div class="line"><a name="l02465"></a><span class="lineno"> 2465</span>&#160;    {</div><div class="line"><a name="l02466"></a><span class="lineno"> 2466</span>&#160;        addReply(c, shared.roslaveerr);</div><div class="line"><a name="l02467"></a><span class="lineno"> 2467</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="server_8h.html#a303769ef1065076e68731584e758d3e1">C_OK</a>;</div><div class="line"><a name="l02468"></a><span class="lineno"> 2468</span>&#160;    }</div><div class="line"><a name="l02469"></a><span class="lineno"> 2469</span>&#160;</div><div class="line"><a name="l02470"></a><span class="lineno"> 2470</span>&#160;    <span class="comment">/* Only allow SUBSCRIBE and UNSUBSCRIBE in the context of Pub/Sub */</span></div><div class="line"><a name="l02471"></a><span class="lineno"> 2471</span>&#160;    <span class="keywordflow">if</span> (c-&gt;flags &amp; <a class="code" href="server_8h.html#a20f2f5380db97cd09013118ffc9411cc">CLIENT_PUBSUB</a> &amp;&amp;</div><div class="line"><a name="l02472"></a><span class="lineno"> 2472</span>&#160;        c-&gt;cmd-&gt;proc != pingCommand &amp;&amp;</div><div class="line"><a name="l02473"></a><span class="lineno"> 2473</span>&#160;        c-&gt;cmd-&gt;proc != subscribeCommand &amp;&amp;</div><div class="line"><a name="l02474"></a><span class="lineno"> 2474</span>&#160;        c-&gt;cmd-&gt;proc != unsubscribeCommand &amp;&amp;</div><div class="line"><a name="l02475"></a><span class="lineno"> 2475</span>&#160;        c-&gt;cmd-&gt;proc != psubscribeCommand &amp;&amp;</div><div class="line"><a name="l02476"></a><span class="lineno"> 2476</span>&#160;        c-&gt;cmd-&gt;proc != punsubscribeCommand) {</div><div class="line"><a name="l02477"></a><span class="lineno"> 2477</span>&#160;        addReplyError(c,<span class="stringliteral">&quot;only (P)SUBSCRIBE / (P)UNSUBSCRIBE / PING / QUIT allowed in this context&quot;</span>);</div><div class="line"><a name="l02478"></a><span class="lineno"> 2478</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="server_8h.html#a303769ef1065076e68731584e758d3e1">C_OK</a>;</div><div class="line"><a name="l02479"></a><span class="lineno"> 2479</span>&#160;    }</div><div class="line"><a name="l02480"></a><span class="lineno"> 2480</span>&#160;</div><div class="line"><a name="l02481"></a><span class="lineno"> 2481</span>&#160;    <span class="comment">/* Only allow commands with flag &quot;t&quot;, such as INFO, SLAVEOF and so on,</span></div><div class="line"><a name="l02482"></a><span class="lineno"> 2482</span>&#160;<span class="comment">     * when slave-serve-stale-data is no and we are a slave with a broken</span></div><div class="line"><a name="l02483"></a><span class="lineno"> 2483</span>&#160;<span class="comment">     * link with master. */</span></div><div class="line"><a name="l02484"></a><span class="lineno"> 2484</span>&#160;    <span class="keywordflow">if</span> (server.masterhost &amp;&amp; server.repl_state != <a class="code" href="server_8h.html#aed693b3a9cdfc05cf5ab7551a8c86fbe">REPL_STATE_CONNECTED</a> &amp;&amp;</div><div class="line"><a name="l02485"></a><span class="lineno"> 2485</span>&#160;        server.repl_serve_stale_data == 0 &amp;&amp;</div><div class="line"><a name="l02486"></a><span class="lineno"> 2486</span>&#160;        !(c-&gt;cmd-&gt;flags &amp; <a class="code" href="server_8h.html#acf1f58ff0b6790cd8d0e3edf1a7e599f">CMD_STALE</a>))</div><div class="line"><a name="l02487"></a><span class="lineno"> 2487</span>&#160;    {</div><div class="line"><a name="l02488"></a><span class="lineno"> 2488</span>&#160;        flagTransaction(c);</div><div class="line"><a name="l02489"></a><span class="lineno"> 2489</span>&#160;        addReply(c, shared.masterdownerr);</div><div class="line"><a name="l02490"></a><span class="lineno"> 2490</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="server_8h.html#a303769ef1065076e68731584e758d3e1">C_OK</a>;</div><div class="line"><a name="l02491"></a><span class="lineno"> 2491</span>&#160;    }</div><div class="line"><a name="l02492"></a><span class="lineno"> 2492</span>&#160;</div><div class="line"><a name="l02493"></a><span class="lineno"> 2493</span>&#160;    <span class="comment">/* Loading DB? Return an error if the command has not the</span></div><div class="line"><a name="l02494"></a><span class="lineno"> 2494</span>&#160;<span class="comment">     * CMD_LOADING flag. */</span></div><div class="line"><a name="l02495"></a><span class="lineno"> 2495</span>&#160;    <span class="keywordflow">if</span> (server.loading &amp;&amp; !(c-&gt;cmd-&gt;flags &amp; <a class="code" href="server_8h.html#a5327d118cf467e77d8bb0cebdce3c0ce">CMD_LOADING</a>)) {</div><div class="line"><a name="l02496"></a><span class="lineno"> 2496</span>&#160;        addReply(c, shared.loadingerr);</div><div class="line"><a name="l02497"></a><span class="lineno"> 2497</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="server_8h.html#a303769ef1065076e68731584e758d3e1">C_OK</a>;</div><div class="line"><a name="l02498"></a><span class="lineno"> 2498</span>&#160;    }</div><div class="line"><a name="l02499"></a><span class="lineno"> 2499</span>&#160;</div><div class="line"><a name="l02500"></a><span class="lineno"> 2500</span>&#160;    <span class="comment">/* Lua script too slow? Only allow a limited number of commands. */</span></div><div class="line"><a name="l02501"></a><span class="lineno"> 2501</span>&#160;    <span class="keywordflow">if</span> (server.lua_timedout &amp;&amp;</div><div class="line"><a name="l02502"></a><span class="lineno"> 2502</span>&#160;          c-&gt;cmd-&gt;proc != authCommand &amp;&amp;</div><div class="line"><a name="l02503"></a><span class="lineno"> 2503</span>&#160;          c-&gt;cmd-&gt;proc != replconfCommand &amp;&amp;</div><div class="line"><a name="l02504"></a><span class="lineno"> 2504</span>&#160;        !(c-&gt;cmd-&gt;proc == shutdownCommand &amp;&amp;</div><div class="line"><a name="l02505"></a><span class="lineno"> 2505</span>&#160;          c-&gt;argc == 2 &amp;&amp;</div><div class="line"><a name="l02506"></a><span class="lineno"> 2506</span>&#160;          tolower(((<span class="keywordtype">char</span>*)c-&gt;argv[1]-&gt;ptr)[0]) == <span class="stringliteral">&#39;n&#39;</span>) &amp;&amp;</div><div class="line"><a name="l02507"></a><span class="lineno"> 2507</span>&#160;        !(c-&gt;cmd-&gt;proc == scriptCommand &amp;&amp;</div><div class="line"><a name="l02508"></a><span class="lineno"> 2508</span>&#160;          c-&gt;argc == 2 &amp;&amp;</div><div class="line"><a name="l02509"></a><span class="lineno"> 2509</span>&#160;          tolower(((<span class="keywordtype">char</span>*)c-&gt;argv[1]-&gt;ptr)[0]) == <span class="stringliteral">&#39;k&#39;</span>))</div><div class="line"><a name="l02510"></a><span class="lineno"> 2510</span>&#160;    {</div><div class="line"><a name="l02511"></a><span class="lineno"> 2511</span>&#160;        flagTransaction(c);</div><div class="line"><a name="l02512"></a><span class="lineno"> 2512</span>&#160;        addReply(c, shared.slowscripterr);</div><div class="line"><a name="l02513"></a><span class="lineno"> 2513</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="server_8h.html#a303769ef1065076e68731584e758d3e1">C_OK</a>;</div><div class="line"><a name="l02514"></a><span class="lineno"> 2514</span>&#160;    }</div><div class="line"><a name="l02515"></a><span class="lineno"> 2515</span>&#160;</div><div class="line"><a name="l02516"></a><span class="lineno"> 2516</span>&#160;    <span class="comment">/* Exec the command */</span></div><div class="line"><a name="l02517"></a><span class="lineno"> 2517</span>&#160;    <span class="keywordflow">if</span> (c-&gt;flags &amp; <a class="code" href="server_8h.html#a7f61f783f429419f8c593291a509b03a">CLIENT_MULTI</a> &amp;&amp;</div><div class="line"><a name="l02518"></a><span class="lineno"> 2518</span>&#160;        c-&gt;cmd-&gt;proc != execCommand &amp;&amp; c-&gt;cmd-&gt;proc != discardCommand &amp;&amp;</div><div class="line"><a name="l02519"></a><span class="lineno"> 2519</span>&#160;        c-&gt;cmd-&gt;proc != multiCommand &amp;&amp; c-&gt;cmd-&gt;proc != watchCommand)</div><div class="line"><a name="l02520"></a><span class="lineno"> 2520</span>&#160;    {</div><div class="line"><a name="l02521"></a><span class="lineno"> 2521</span>&#160;        queueMultiCommand(c);</div><div class="line"><a name="l02522"></a><span class="lineno"> 2522</span>&#160;        addReply(c,shared.queued);</div><div class="line"><a name="l02523"></a><span class="lineno"> 2523</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l02524"></a><span class="lineno"> 2524</span>&#160;        call(c,<a class="code" href="server_8h.html#a7e92e38a9fe5f713cace24d63184273e">CMD_CALL_FULL</a>);</div><div class="line"><a name="l02525"></a><span class="lineno"> 2525</span>&#160;        c-&gt;woff = server.master_repl_offset;</div><div class="line"><a name="l02526"></a><span class="lineno"> 2526</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="adlist_8h.html#afde0ab079f934670e82119b43120e94b">listLength</a>(server.ready_keys))</div><div class="line"><a name="l02527"></a><span class="lineno"> 2527</span>&#160;            handleClientsBlockedOnKeys();</div><div class="line"><a name="l02528"></a><span class="lineno"> 2528</span>&#160;    }</div><div class="line"><a name="l02529"></a><span class="lineno"> 2529</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="server_8h.html#a303769ef1065076e68731584e758d3e1">C_OK</a>;</div><div class="line"><a name="l02530"></a><span class="lineno"> 2530</span>&#160;}</div><div class="line"><a name="l02531"></a><span class="lineno"> 2531</span>&#160;</div><div class="line"><a name="l02532"></a><span class="lineno"> 2532</span>&#160;<span class="comment">/*================================== Shutdown =============================== */</span></div><div class="line"><a name="l02533"></a><span class="lineno"> 2533</span>&#160;</div><div class="line"><a name="l02534"></a><span class="lineno"> 2534</span>&#160;<span class="comment">/* Close listening sockets. Also unlink the unix domain socket if</span></div><div class="line"><a name="l02535"></a><span class="lineno"> 2535</span>&#160;<span class="comment"> * unlink_unix_socket is non-zero. */</span></div><div class="line"><a name="l02536"></a><span class="lineno"> 2536</span>&#160;<span class="keywordtype">void</span> closeListeningSockets(<span class="keywordtype">int</span> unlink_unix_socket) {</div><div class="line"><a name="l02537"></a><span class="lineno"> 2537</span>&#160;    <span class="keywordtype">int</span> j;</div><div class="line"><a name="l02538"></a><span class="lineno"> 2538</span>&#160;</div><div class="line"><a name="l02539"></a><span class="lineno"> 2539</span>&#160;    <span class="keywordflow">for</span> (j = 0; j &lt; server.ipfd_count; j++) close(server.ipfd[j]);</div><div class="line"><a name="l02540"></a><span class="lineno"> 2540</span>&#160;    <span class="keywordflow">if</span> (server.sofd != -1) close(server.sofd);</div><div class="line"><a name="l02541"></a><span class="lineno"> 2541</span>&#160;    <span class="keywordflow">if</span> (server.cluster_enabled)</div><div class="line"><a name="l02542"></a><span class="lineno"> 2542</span>&#160;        <span class="keywordflow">for</span> (j = 0; j &lt; server.cfd_count; j++) close(server.cfd[j]);</div><div class="line"><a name="l02543"></a><span class="lineno"> 2543</span>&#160;    <span class="keywordflow">if</span> (unlink_unix_socket &amp;&amp; server.unixsocket) {</div><div class="line"><a name="l02544"></a><span class="lineno"> 2544</span>&#160;        serverLog(<a class="code" href="server_8h.html#a8c54c191e436c7dd3012167212692401">LL_NOTICE</a>,<span class="stringliteral">&quot;Removing the unix socket file.&quot;</span>);</div><div class="line"><a name="l02545"></a><span class="lineno"> 2545</span>&#160;        unlink(server.unixsocket); <span class="comment">/* don&#39;t care if this fails */</span></div><div class="line"><a name="l02546"></a><span class="lineno"> 2546</span>&#160;    }</div><div class="line"><a name="l02547"></a><span class="lineno"> 2547</span>&#160;}</div><div class="line"><a name="l02548"></a><span class="lineno"> 2548</span>&#160;</div><div class="line"><a name="l02549"></a><span class="lineno"> 2549</span>&#160;<span class="keywordtype">int</span> prepareForShutdown(<span class="keywordtype">int</span> flags) {</div><div class="line"><a name="l02550"></a><span class="lineno"> 2550</span>&#160;    <span class="keywordtype">int</span> save = flags &amp; <a class="code" href="server_8h.html#ada761b94960fa20ff86d56b403b26861">SHUTDOWN_SAVE</a>;</div><div class="line"><a name="l02551"></a><span class="lineno"> 2551</span>&#160;    <span class="keywordtype">int</span> nosave = flags &amp; <a class="code" href="server_8h.html#a834b7e50f783a1eeaa1feea05fce199e">SHUTDOWN_NOSAVE</a>;</div><div class="line"><a name="l02552"></a><span class="lineno"> 2552</span>&#160;</div><div class="line"><a name="l02553"></a><span class="lineno"> 2553</span>&#160;    serverLog(<a class="code" href="server_8h.html#a31229b9334bba7d6be2a72970967a14b">LL_WARNING</a>,<span class="stringliteral">&quot;User requested shutdown...&quot;</span>);</div><div class="line"><a name="l02554"></a><span class="lineno"> 2554</span>&#160;</div><div class="line"><a name="l02555"></a><span class="lineno"> 2555</span>&#160;    <span class="comment">/* Kill all the Lua debugger forked sessions. */</span></div><div class="line"><a name="l02556"></a><span class="lineno"> 2556</span>&#160;    ldbKillForkedSessions();</div><div class="line"><a name="l02557"></a><span class="lineno"> 2557</span>&#160;</div><div class="line"><a name="l02558"></a><span class="lineno"> 2558</span>&#160;    <span class="comment">/* Kill the saving child if there is a background saving in progress.</span></div><div class="line"><a name="l02559"></a><span class="lineno"> 2559</span>&#160;<span class="comment">       We want to avoid race conditions, for instance our saving child may</span></div><div class="line"><a name="l02560"></a><span class="lineno"> 2560</span>&#160;<span class="comment">       overwrite the synchronous saving did by SHUTDOWN. */</span></div><div class="line"><a name="l02561"></a><span class="lineno"> 2561</span>&#160;    <span class="keywordflow">if</span> (server.rdb_child_pid != -1) {</div><div class="line"><a name="l02562"></a><span class="lineno"> 2562</span>&#160;        serverLog(<a class="code" href="server_8h.html#a31229b9334bba7d6be2a72970967a14b">LL_WARNING</a>,<span class="stringliteral">&quot;There is a child saving an .rdb. Killing it!&quot;</span>);</div><div class="line"><a name="l02563"></a><span class="lineno"> 2563</span>&#160;        kill(server.rdb_child_pid,SIGUSR1);</div><div class="line"><a name="l02564"></a><span class="lineno"> 2564</span>&#160;        rdbRemoveTempFile(server.rdb_child_pid);</div><div class="line"><a name="l02565"></a><span class="lineno"> 2565</span>&#160;    }</div><div class="line"><a name="l02566"></a><span class="lineno"> 2566</span>&#160;</div><div class="line"><a name="l02567"></a><span class="lineno"> 2567</span>&#160;    <span class="keywordflow">if</span> (server.aof_state != <a class="code" href="server_8h.html#a5226306fbcebcb6d5d02e0fef3c213c2">AOF_OFF</a>) {</div><div class="line"><a name="l02568"></a><span class="lineno"> 2568</span>&#160;        <span class="comment">/* Kill the AOF saving child as the AOF we already have may be longer</span></div><div class="line"><a name="l02569"></a><span class="lineno"> 2569</span>&#160;<span class="comment">         * but contains the full dataset anyway. */</span></div><div class="line"><a name="l02570"></a><span class="lineno"> 2570</span>&#160;        <span class="keywordflow">if</span> (server.aof_child_pid != -1) {</div><div class="line"><a name="l02571"></a><span class="lineno"> 2571</span>&#160;            <span class="comment">/* If we have AOF enabled but haven&#39;t written the AOF yet, don&#39;t</span></div><div class="line"><a name="l02572"></a><span class="lineno"> 2572</span>&#160;<span class="comment">             * shutdown or else the dataset will be lost. */</span></div><div class="line"><a name="l02573"></a><span class="lineno"> 2573</span>&#160;            <span class="keywordflow">if</span> (server.aof_state == <a class="code" href="server_8h.html#a7d4b86c89be4d951fbf048130431a16a">AOF_WAIT_REWRITE</a>) {</div><div class="line"><a name="l02574"></a><span class="lineno"> 2574</span>&#160;                serverLog(<a class="code" href="server_8h.html#a31229b9334bba7d6be2a72970967a14b">LL_WARNING</a>, <span class="stringliteral">&quot;Writing initial AOF, can&#39;t exit.&quot;</span>);</div><div class="line"><a name="l02575"></a><span class="lineno"> 2575</span>&#160;                <span class="keywordflow">return</span> <a class="code" href="server_8h.html#af98ac28d5f4d23d7ed5985188e6fb7d1">C_ERR</a>;</div><div class="line"><a name="l02576"></a><span class="lineno"> 2576</span>&#160;            }</div><div class="line"><a name="l02577"></a><span class="lineno"> 2577</span>&#160;            serverLog(<a class="code" href="server_8h.html#a31229b9334bba7d6be2a72970967a14b">LL_WARNING</a>,</div><div class="line"><a name="l02578"></a><span class="lineno"> 2578</span>&#160;                <span class="stringliteral">&quot;There is a child rewriting the AOF. Killing it!&quot;</span>);</div><div class="line"><a name="l02579"></a><span class="lineno"> 2579</span>&#160;            kill(server.aof_child_pid,SIGUSR1);</div><div class="line"><a name="l02580"></a><span class="lineno"> 2580</span>&#160;        }</div><div class="line"><a name="l02581"></a><span class="lineno"> 2581</span>&#160;        <span class="comment">/* Append only file: flush buffers and fsync() the AOF at exit */</span></div><div class="line"><a name="l02582"></a><span class="lineno"> 2582</span>&#160;        serverLog(<a class="code" href="server_8h.html#a8c54c191e436c7dd3012167212692401">LL_NOTICE</a>,<span class="stringliteral">&quot;Calling fsync() on the AOF file.&quot;</span>);</div><div class="line"><a name="l02583"></a><span class="lineno"> 2583</span>&#160;        flushAppendOnlyFile(1);</div><div class="line"><a name="l02584"></a><span class="lineno"> 2584</span>&#160;        <a class="code" href="config_8h.html#af5994c643c434574580bb7816af82cad">aof_fsync</a>(server.aof_fd);</div><div class="line"><a name="l02585"></a><span class="lineno"> 2585</span>&#160;    }</div><div class="line"><a name="l02586"></a><span class="lineno"> 2586</span>&#160;</div><div class="line"><a name="l02587"></a><span class="lineno"> 2587</span>&#160;    <span class="comment">/* Create a new RDB file before exiting. */</span></div><div class="line"><a name="l02588"></a><span class="lineno"> 2588</span>&#160;    <span class="keywordflow">if</span> ((server.saveparamslen &gt; 0 &amp;&amp; !nosave) || save) {</div><div class="line"><a name="l02589"></a><span class="lineno"> 2589</span>&#160;        serverLog(<a class="code" href="server_8h.html#a8c54c191e436c7dd3012167212692401">LL_NOTICE</a>,<span class="stringliteral">&quot;Saving the final RDB snapshot before exiting.&quot;</span>);</div><div class="line"><a name="l02590"></a><span class="lineno"> 2590</span>&#160;        <span class="comment">/* Snapshotting. Perform a SYNC SAVE and exit */</span></div><div class="line"><a name="l02591"></a><span class="lineno"> 2591</span>&#160;        rdbSaveInfo rsi, *rsiptr;</div><div class="line"><a name="l02592"></a><span class="lineno"> 2592</span>&#160;        rsiptr = rdbPopulateSaveInfo(&amp;rsi);</div><div class="line"><a name="l02593"></a><span class="lineno"> 2593</span>&#160;        <span class="keywordflow">if</span> (rdbSave(server.rdb_filename,rsiptr) != <a class="code" href="server_8h.html#a303769ef1065076e68731584e758d3e1">C_OK</a>) {</div><div class="line"><a name="l02594"></a><span class="lineno"> 2594</span>&#160;            <span class="comment">/* Ooops.. error saving! The best we can do is to continue</span></div><div class="line"><a name="l02595"></a><span class="lineno"> 2595</span>&#160;<span class="comment">             * operating. Note that if there was a background saving process,</span></div><div class="line"><a name="l02596"></a><span class="lineno"> 2596</span>&#160;<span class="comment">             * in the next cron() Redis will be notified that the background</span></div><div class="line"><a name="l02597"></a><span class="lineno"> 2597</span>&#160;<span class="comment">             * saving aborted, handling special stuff like slaves pending for</span></div><div class="line"><a name="l02598"></a><span class="lineno"> 2598</span>&#160;<span class="comment">             * synchronization... */</span></div><div class="line"><a name="l02599"></a><span class="lineno"> 2599</span>&#160;            serverLog(<a class="code" href="server_8h.html#a31229b9334bba7d6be2a72970967a14b">LL_WARNING</a>,<span class="stringliteral">&quot;Error trying to save the DB, can&#39;t exit.&quot;</span>);</div><div class="line"><a name="l02600"></a><span class="lineno"> 2600</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="server_8h.html#af98ac28d5f4d23d7ed5985188e6fb7d1">C_ERR</a>;</div><div class="line"><a name="l02601"></a><span class="lineno"> 2601</span>&#160;        }</div><div class="line"><a name="l02602"></a><span class="lineno"> 2602</span>&#160;    }</div><div class="line"><a name="l02603"></a><span class="lineno"> 2603</span>&#160;</div><div class="line"><a name="l02604"></a><span class="lineno"> 2604</span>&#160;    <span class="comment">/* Remove the pid file if possible and needed. */</span></div><div class="line"><a name="l02605"></a><span class="lineno"> 2605</span>&#160;    <span class="keywordflow">if</span> (server.daemonize || server.pidfile) {</div><div class="line"><a name="l02606"></a><span class="lineno"> 2606</span>&#160;        serverLog(<a class="code" href="server_8h.html#a8c54c191e436c7dd3012167212692401">LL_NOTICE</a>,<span class="stringliteral">&quot;Removing the pid file.&quot;</span>);</div><div class="line"><a name="l02607"></a><span class="lineno"> 2607</span>&#160;        unlink(server.pidfile);</div><div class="line"><a name="l02608"></a><span class="lineno"> 2608</span>&#160;    }</div><div class="line"><a name="l02609"></a><span class="lineno"> 2609</span>&#160;</div><div class="line"><a name="l02610"></a><span class="lineno"> 2610</span>&#160;    <span class="comment">/* Best effort flush of slave output buffers, so that we hopefully</span></div><div class="line"><a name="l02611"></a><span class="lineno"> 2611</span>&#160;<span class="comment">     * send them pending writes. */</span></div><div class="line"><a name="l02612"></a><span class="lineno"> 2612</span>&#160;    flushSlavesOutputBuffers();</div><div class="line"><a name="l02613"></a><span class="lineno"> 2613</span>&#160;</div><div class="line"><a name="l02614"></a><span class="lineno"> 2614</span>&#160;    <span class="comment">/* Close the listening sockets. Apparently this allows faster restarts. */</span></div><div class="line"><a name="l02615"></a><span class="lineno"> 2615</span>&#160;    closeListeningSockets(1);</div><div class="line"><a name="l02616"></a><span class="lineno"> 2616</span>&#160;    serverLog(<a class="code" href="server_8h.html#a31229b9334bba7d6be2a72970967a14b">LL_WARNING</a>,<span class="stringliteral">&quot;%s is now ready to exit, bye bye...&quot;</span>,</div><div class="line"><a name="l02617"></a><span class="lineno"> 2617</span>&#160;        server.sentinel_mode ? <span class="stringliteral">&quot;Sentinel&quot;</span> : <span class="stringliteral">&quot;Redis&quot;</span>);</div><div class="line"><a name="l02618"></a><span class="lineno"> 2618</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="server_8h.html#a303769ef1065076e68731584e758d3e1">C_OK</a>;</div><div class="line"><a name="l02619"></a><span class="lineno"> 2619</span>&#160;}</div><div class="line"><a name="l02620"></a><span class="lineno"> 2620</span>&#160;</div><div class="line"><a name="l02621"></a><span class="lineno"> 2621</span>&#160;<span class="comment">/*================================== Commands =============================== */</span></div><div class="line"><a name="l02622"></a><span class="lineno"> 2622</span>&#160;</div><div class="line"><a name="l02623"></a><span class="lineno"> 2623</span>&#160;<span class="comment">/* Return zero if strings are the same, non-zero if they are not.</span></div><div class="line"><a name="l02624"></a><span class="lineno"> 2624</span>&#160;<span class="comment"> * The comparison is performed in a way that prevents an attacker to obtain</span></div><div class="line"><a name="l02625"></a><span class="lineno"> 2625</span>&#160;<span class="comment"> * information about the nature of the strings just monitoring the execution</span></div><div class="line"><a name="l02626"></a><span class="lineno"> 2626</span>&#160;<span class="comment"> * time of the function.</span></div><div class="line"><a name="l02627"></a><span class="lineno"> 2627</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l02628"></a><span class="lineno"> 2628</span>&#160;<span class="comment"> * Note that limiting the comparison length to strings up to 512 bytes we</span></div><div class="line"><a name="l02629"></a><span class="lineno"> 2629</span>&#160;<span class="comment"> * can avoid leaking any information about the password length and any</span></div><div class="line"><a name="l02630"></a><span class="lineno"> 2630</span>&#160;<span class="comment"> * possible branch misprediction related leak.</span></div><div class="line"><a name="l02631"></a><span class="lineno"> 2631</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l02632"></a><span class="lineno"> 2632</span>&#160;<span class="keywordtype">int</span> time_independent_strcmp(<span class="keywordtype">char</span> *a, <span class="keywordtype">char</span> *b) {</div><div class="line"><a name="l02633"></a><span class="lineno"> 2633</span>&#160;    <span class="keywordtype">char</span> bufa[<a class="code" href="server_8h.html#a8e9d7cd814b95c2cbd17701efe1374f2">CONFIG_AUTHPASS_MAX_LEN</a>], bufb[<a class="code" href="server_8h.html#a8e9d7cd814b95c2cbd17701efe1374f2">CONFIG_AUTHPASS_MAX_LEN</a>];</div><div class="line"><a name="l02634"></a><span class="lineno"> 2634</span>&#160;    <span class="comment">/* The above two strlen perform len(a) + len(b) operations where either</span></div><div class="line"><a name="l02635"></a><span class="lineno"> 2635</span>&#160;<span class="comment">     * a or b are fixed (our password) length, and the difference is only</span></div><div class="line"><a name="l02636"></a><span class="lineno"> 2636</span>&#160;<span class="comment">     * relative to the length of the user provided string, so no information</span></div><div class="line"><a name="l02637"></a><span class="lineno"> 2637</span>&#160;<span class="comment">     * leak is possible in the following two lines of code. */</span></div><div class="line"><a name="l02638"></a><span class="lineno"> 2638</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> alen = strlen(a);</div><div class="line"><a name="l02639"></a><span class="lineno"> 2639</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> blen = strlen(b);</div><div class="line"><a name="l02640"></a><span class="lineno"> 2640</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j;</div><div class="line"><a name="l02641"></a><span class="lineno"> 2641</span>&#160;    <span class="keywordtype">int</span> diff = 0;</div><div class="line"><a name="l02642"></a><span class="lineno"> 2642</span>&#160;</div><div class="line"><a name="l02643"></a><span class="lineno"> 2643</span>&#160;    <span class="comment">/* We can&#39;t compare strings longer than our static buffers.</span></div><div class="line"><a name="l02644"></a><span class="lineno"> 2644</span>&#160;<span class="comment">     * Note that this will never pass the first test in practical circumstances</span></div><div class="line"><a name="l02645"></a><span class="lineno"> 2645</span>&#160;<span class="comment">     * so there is no info leak. */</span></div><div class="line"><a name="l02646"></a><span class="lineno"> 2646</span>&#160;    <span class="keywordflow">if</span> (alen &gt; <span class="keyword">sizeof</span>(bufa) || blen &gt; <span class="keyword">sizeof</span>(bufb)) <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l02647"></a><span class="lineno"> 2647</span>&#160;</div><div class="line"><a name="l02648"></a><span class="lineno"> 2648</span>&#160;    memset(bufa,0,<span class="keyword">sizeof</span>(bufa));        <span class="comment">/* Constant time. */</span></div><div class="line"><a name="l02649"></a><span class="lineno"> 2649</span>&#160;    memset(bufb,0,<span class="keyword">sizeof</span>(bufb));        <span class="comment">/* Constant time. */</span></div><div class="line"><a name="l02650"></a><span class="lineno"> 2650</span>&#160;    <span class="comment">/* Again the time of the following two copies is proportional to</span></div><div class="line"><a name="l02651"></a><span class="lineno"> 2651</span>&#160;<span class="comment">     * len(a) + len(b) so no info is leaked. */</span></div><div class="line"><a name="l02652"></a><span class="lineno"> 2652</span>&#160;    memcpy(bufa,a,alen);</div><div class="line"><a name="l02653"></a><span class="lineno"> 2653</span>&#160;    memcpy(bufb,b,blen);</div><div class="line"><a name="l02654"></a><span class="lineno"> 2654</span>&#160;</div><div class="line"><a name="l02655"></a><span class="lineno"> 2655</span>&#160;    <span class="comment">/* Always compare all the chars in the two buffers without</span></div><div class="line"><a name="l02656"></a><span class="lineno"> 2656</span>&#160;<span class="comment">     * conditional expressions. */</span></div><div class="line"><a name="l02657"></a><span class="lineno"> 2657</span>&#160;    <span class="keywordflow">for</span> (j = 0; j &lt; <span class="keyword">sizeof</span>(bufa); j++) {</div><div class="line"><a name="l02658"></a><span class="lineno"> 2658</span>&#160;        diff |= (bufa[j] ^ bufb[j]);</div><div class="line"><a name="l02659"></a><span class="lineno"> 2659</span>&#160;    }</div><div class="line"><a name="l02660"></a><span class="lineno"> 2660</span>&#160;    <span class="comment">/* Length must be equal as well. */</span></div><div class="line"><a name="l02661"></a><span class="lineno"> 2661</span>&#160;    diff |= alen ^ blen;</div><div class="line"><a name="l02662"></a><span class="lineno"> 2662</span>&#160;    <span class="keywordflow">return</span> diff; <span class="comment">/* If zero strings are the same. */</span></div><div class="line"><a name="l02663"></a><span class="lineno"> 2663</span>&#160;}</div><div class="line"><a name="l02664"></a><span class="lineno"> 2664</span>&#160;</div><div class="line"><a name="l02665"></a><span class="lineno"> 2665</span>&#160;<span class="keywordtype">void</span> authCommand(<a class="code" href="structclient.html">client</a> *c) {</div><div class="line"><a name="l02666"></a><span class="lineno"> 2666</span>&#160;    <span class="keywordflow">if</span> (!server.requirepass) {</div><div class="line"><a name="l02667"></a><span class="lineno"> 2667</span>&#160;        addReplyError(c,<span class="stringliteral">&quot;Client sent AUTH, but no password is set&quot;</span>);</div><div class="line"><a name="l02668"></a><span class="lineno"> 2668</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!time_independent_strcmp(c-&gt;argv[1]-&gt;ptr, server.requirepass)) {</div><div class="line"><a name="l02669"></a><span class="lineno"> 2669</span>&#160;      c-&gt;authenticated = 1;</div><div class="line"><a name="l02670"></a><span class="lineno"> 2670</span>&#160;      addReply(c,shared.ok);</div><div class="line"><a name="l02671"></a><span class="lineno"> 2671</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l02672"></a><span class="lineno"> 2672</span>&#160;      c-&gt;authenticated = 0;</div><div class="line"><a name="l02673"></a><span class="lineno"> 2673</span>&#160;      addReplyError(c,<span class="stringliteral">&quot;invalid password&quot;</span>);</div><div class="line"><a name="l02674"></a><span class="lineno"> 2674</span>&#160;    }</div><div class="line"><a name="l02675"></a><span class="lineno"> 2675</span>&#160;}</div><div class="line"><a name="l02676"></a><span class="lineno"> 2676</span>&#160;</div><div class="line"><a name="l02677"></a><span class="lineno"> 2677</span>&#160;<span class="comment">/* The PING command. It works in a different way if the client is in</span></div><div class="line"><a name="l02678"></a><span class="lineno"> 2678</span>&#160;<span class="comment"> * in Pub/Sub mode. */</span></div><div class="line"><a name="l02679"></a><span class="lineno"> 2679</span>&#160;<span class="keywordtype">void</span> pingCommand(<a class="code" href="structclient.html">client</a> *c) {</div><div class="line"><a name="l02680"></a><span class="lineno"> 2680</span>&#160;    <span class="comment">/* The command takes zero or one arguments. */</span></div><div class="line"><a name="l02681"></a><span class="lineno"> 2681</span>&#160;    <span class="keywordflow">if</span> (c-&gt;argc &gt; 2) {</div><div class="line"><a name="l02682"></a><span class="lineno"> 2682</span>&#160;        addReplyErrorFormat(c,<span class="stringliteral">&quot;wrong number of arguments for &#39;%s&#39; command&quot;</span>,</div><div class="line"><a name="l02683"></a><span class="lineno"> 2683</span>&#160;            c-&gt;cmd-&gt;name);</div><div class="line"><a name="l02684"></a><span class="lineno"> 2684</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l02685"></a><span class="lineno"> 2685</span>&#160;    }</div><div class="line"><a name="l02686"></a><span class="lineno"> 2686</span>&#160;</div><div class="line"><a name="l02687"></a><span class="lineno"> 2687</span>&#160;    <span class="keywordflow">if</span> (c-&gt;flags &amp; <a class="code" href="server_8h.html#a20f2f5380db97cd09013118ffc9411cc">CLIENT_PUBSUB</a>) {</div><div class="line"><a name="l02688"></a><span class="lineno"> 2688</span>&#160;        addReply(c,shared.mbulkhdr[2]);</div><div class="line"><a name="l02689"></a><span class="lineno"> 2689</span>&#160;        addReplyBulkCBuffer(c,<span class="stringliteral">&quot;pong&quot;</span>,4);</div><div class="line"><a name="l02690"></a><span class="lineno"> 2690</span>&#160;        <span class="keywordflow">if</span> (c-&gt;argc == 1)</div><div class="line"><a name="l02691"></a><span class="lineno"> 2691</span>&#160;            addReplyBulkCBuffer(c,<span class="stringliteral">&quot;&quot;</span>,0);</div><div class="line"><a name="l02692"></a><span class="lineno"> 2692</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l02693"></a><span class="lineno"> 2693</span>&#160;            addReplyBulk(c,c-&gt;argv[1]);</div><div class="line"><a name="l02694"></a><span class="lineno"> 2694</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l02695"></a><span class="lineno"> 2695</span>&#160;        <span class="keywordflow">if</span> (c-&gt;argc == 1)</div><div class="line"><a name="l02696"></a><span class="lineno"> 2696</span>&#160;            addReply(c,shared.pong);</div><div class="line"><a name="l02697"></a><span class="lineno"> 2697</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l02698"></a><span class="lineno"> 2698</span>&#160;            addReplyBulk(c,c-&gt;argv[1]);</div><div class="line"><a name="l02699"></a><span class="lineno"> 2699</span>&#160;    }</div><div class="line"><a name="l02700"></a><span class="lineno"> 2700</span>&#160;}</div><div class="line"><a name="l02701"></a><span class="lineno"> 2701</span>&#160;</div><div class="line"><a name="l02702"></a><span class="lineno"> 2702</span>&#160;<span class="keywordtype">void</span> echoCommand(<a class="code" href="structclient.html">client</a> *c) {</div><div class="line"><a name="l02703"></a><span class="lineno"> 2703</span>&#160;    addReplyBulk(c,c-&gt;argv[1]);</div><div class="line"><a name="l02704"></a><span class="lineno"> 2704</span>&#160;}</div><div class="line"><a name="l02705"></a><span class="lineno"> 2705</span>&#160;</div><div class="line"><a name="l02706"></a><span class="lineno"> 2706</span>&#160;<span class="keywordtype">void</span> timeCommand(<a class="code" href="structclient.html">client</a> *c) {</div><div class="line"><a name="l02707"></a><span class="lineno"> 2707</span>&#160;    <span class="keyword">struct</span> timeval tv;</div><div class="line"><a name="l02708"></a><span class="lineno"> 2708</span>&#160;</div><div class="line"><a name="l02709"></a><span class="lineno"> 2709</span>&#160;    <span class="comment">/* gettimeofday() can only fail if &amp;tv is a bad address so we</span></div><div class="line"><a name="l02710"></a><span class="lineno"> 2710</span>&#160;<span class="comment">     * don&#39;t check for errors. */</span></div><div class="line"><a name="l02711"></a><span class="lineno"> 2711</span>&#160;    gettimeofday(&amp;tv,NULL);</div><div class="line"><a name="l02712"></a><span class="lineno"> 2712</span>&#160;    addReplyMultiBulkLen(c,2);</div><div class="line"><a name="l02713"></a><span class="lineno"> 2713</span>&#160;    addReplyBulkLongLong(c,tv.tv_sec);</div><div class="line"><a name="l02714"></a><span class="lineno"> 2714</span>&#160;    addReplyBulkLongLong(c,tv.tv_usec);</div><div class="line"><a name="l02715"></a><span class="lineno"> 2715</span>&#160;}</div><div class="line"><a name="l02716"></a><span class="lineno"> 2716</span>&#160;</div><div class="line"><a name="l02717"></a><span class="lineno"> 2717</span>&#160;<span class="comment">/* Helper function for addReplyCommand() to output flags. */</span></div><div class="line"><a name="l02718"></a><span class="lineno"> 2718</span>&#160;<span class="keywordtype">int</span> addReplyCommandFlag(<a class="code" href="structclient.html">client</a> *c, <span class="keyword">struct</span> <a class="code" href="structredisCommand.html">redisCommand</a> *cmd, <span class="keywordtype">int</span> f, <span class="keywordtype">char</span> *reply) {</div><div class="line"><a name="l02719"></a><span class="lineno"> 2719</span>&#160;    <span class="keywordflow">if</span> (cmd-&gt;flags &amp; f) {</div><div class="line"><a name="l02720"></a><span class="lineno"> 2720</span>&#160;        addReplyStatus(c, reply);</div><div class="line"><a name="l02721"></a><span class="lineno"> 2721</span>&#160;        <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l02722"></a><span class="lineno"> 2722</span>&#160;    }</div><div class="line"><a name="l02723"></a><span class="lineno"> 2723</span>&#160;    <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l02724"></a><span class="lineno"> 2724</span>&#160;}</div><div class="line"><a name="l02725"></a><span class="lineno"> 2725</span>&#160;</div><div class="line"><a name="l02726"></a><span class="lineno"> 2726</span>&#160;<span class="comment">/* Output the representation of a Redis command. Used by the COMMAND command. */</span></div><div class="line"><a name="l02727"></a><span class="lineno"> 2727</span>&#160;<span class="keywordtype">void</span> addReplyCommand(<a class="code" href="structclient.html">client</a> *c, <span class="keyword">struct</span> <a class="code" href="structredisCommand.html">redisCommand</a> *cmd) {</div><div class="line"><a name="l02728"></a><span class="lineno"> 2728</span>&#160;    <span class="keywordflow">if</span> (!cmd) {</div><div class="line"><a name="l02729"></a><span class="lineno"> 2729</span>&#160;        addReply(c, shared.nullbulk);</div><div class="line"><a name="l02730"></a><span class="lineno"> 2730</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l02731"></a><span class="lineno"> 2731</span>&#160;        <span class="comment">/* We are adding: command name, arg count, flags, first, last, offset */</span></div><div class="line"><a name="l02732"></a><span class="lineno"> 2732</span>&#160;        addReplyMultiBulkLen(c, 6);</div><div class="line"><a name="l02733"></a><span class="lineno"> 2733</span>&#160;        addReplyBulkCString(c, cmd-&gt;name);</div><div class="line"><a name="l02734"></a><span class="lineno"> 2734</span>&#160;        addReplyLongLong(c, cmd-&gt;arity);</div><div class="line"><a name="l02735"></a><span class="lineno"> 2735</span>&#160;</div><div class="line"><a name="l02736"></a><span class="lineno"> 2736</span>&#160;        <span class="keywordtype">int</span> flagcount = 0;</div><div class="line"><a name="l02737"></a><span class="lineno"> 2737</span>&#160;        <span class="keywordtype">void</span> *flaglen = addDeferredMultiBulkLength(c);</div><div class="line"><a name="l02738"></a><span class="lineno"> 2738</span>&#160;        flagcount += addReplyCommandFlag(c,cmd,<a class="code" href="server_8h.html#a7391deb9c3a262ded3e186e94eb884e2">CMD_WRITE</a>, <span class="stringliteral">&quot;write&quot;</span>);</div><div class="line"><a name="l02739"></a><span class="lineno"> 2739</span>&#160;        flagcount += addReplyCommandFlag(c,cmd,<a class="code" href="server_8h.html#a7e9c728f228e1c82ae1e22173375abcf">CMD_READONLY</a>, <span class="stringliteral">&quot;readonly&quot;</span>);</div><div class="line"><a name="l02740"></a><span class="lineno"> 2740</span>&#160;        flagcount += addReplyCommandFlag(c,cmd,<a class="code" href="server_8h.html#aef97c640ad8dfdaca21eb67d4c37e447">CMD_DENYOOM</a>, <span class="stringliteral">&quot;denyoom&quot;</span>);</div><div class="line"><a name="l02741"></a><span class="lineno"> 2741</span>&#160;        flagcount += addReplyCommandFlag(c,cmd,<a class="code" href="server_8h.html#a1917805ea3942a4784ec806c33bc6033">CMD_ADMIN</a>, <span class="stringliteral">&quot;admin&quot;</span>);</div><div class="line"><a name="l02742"></a><span class="lineno"> 2742</span>&#160;        flagcount += addReplyCommandFlag(c,cmd,<a class="code" href="server_8h.html#a201d97fc457fe5bd58cb863b4ac7a0cc">CMD_PUBSUB</a>, <span class="stringliteral">&quot;pubsub&quot;</span>);</div><div class="line"><a name="l02743"></a><span class="lineno"> 2743</span>&#160;        flagcount += addReplyCommandFlag(c,cmd,<a class="code" href="server_8h.html#aaf26ba9b59589bc7701e36fb440a0fbe">CMD_NOSCRIPT</a>, <span class="stringliteral">&quot;noscript&quot;</span>);</div><div class="line"><a name="l02744"></a><span class="lineno"> 2744</span>&#160;        flagcount += addReplyCommandFlag(c,cmd,<a class="code" href="server_8h.html#a9f6608fefa355981c2a865ef3d44f196">CMD_RANDOM</a>, <span class="stringliteral">&quot;random&quot;</span>);</div><div class="line"><a name="l02745"></a><span class="lineno"> 2745</span>&#160;        flagcount += addReplyCommandFlag(c,cmd,<a class="code" href="server_8h.html#a819ad39aa4aef302c4421c3cd910252d">CMD_SORT_FOR_SCRIPT</a>,<span class="stringliteral">&quot;sort_for_script&quot;</span>);</div><div class="line"><a name="l02746"></a><span class="lineno"> 2746</span>&#160;        flagcount += addReplyCommandFlag(c,cmd,<a class="code" href="server_8h.html#a5327d118cf467e77d8bb0cebdce3c0ce">CMD_LOADING</a>, <span class="stringliteral">&quot;loading&quot;</span>);</div><div class="line"><a name="l02747"></a><span class="lineno"> 2747</span>&#160;        flagcount += addReplyCommandFlag(c,cmd,<a class="code" href="server_8h.html#acf1f58ff0b6790cd8d0e3edf1a7e599f">CMD_STALE</a>, <span class="stringliteral">&quot;stale&quot;</span>);</div><div class="line"><a name="l02748"></a><span class="lineno"> 2748</span>&#160;        flagcount += addReplyCommandFlag(c,cmd,<a class="code" href="server_8h.html#a43e2aecb49a88a6cd4e56bfa971bdc71">CMD_SKIP_MONITOR</a>, <span class="stringliteral">&quot;skip_monitor&quot;</span>);</div><div class="line"><a name="l02749"></a><span class="lineno"> 2749</span>&#160;        flagcount += addReplyCommandFlag(c,cmd,<a class="code" href="server_8h.html#af0b13ef0f1dabe404fd7d904cb66b548">CMD_ASKING</a>, <span class="stringliteral">&quot;asking&quot;</span>);</div><div class="line"><a name="l02750"></a><span class="lineno"> 2750</span>&#160;        flagcount += addReplyCommandFlag(c,cmd,<a class="code" href="server_8h.html#ae21dc0d9c0dcdefa14ca1054c48f252f">CMD_FAST</a>, <span class="stringliteral">&quot;fast&quot;</span>);</div><div class="line"><a name="l02751"></a><span class="lineno"> 2751</span>&#160;        <span class="keywordflow">if</span> ((cmd-&gt;getkeys_proc &amp;&amp; !(cmd-&gt;flags &amp; <a class="code" href="server_8h.html#accabd32f20281543986166c219124f9e">CMD_MODULE</a>)) ||</div><div class="line"><a name="l02752"></a><span class="lineno"> 2752</span>&#160;            cmd-&gt;flags &amp; <a class="code" href="server_8h.html#a612a8681d1a25cd86faf4139d161316a">CMD_MODULE_GETKEYS</a>)</div><div class="line"><a name="l02753"></a><span class="lineno"> 2753</span>&#160;        {</div><div class="line"><a name="l02754"></a><span class="lineno"> 2754</span>&#160;            addReplyStatus(c, <span class="stringliteral">&quot;movablekeys&quot;</span>);</div><div class="line"><a name="l02755"></a><span class="lineno"> 2755</span>&#160;            flagcount += 1;</div><div class="line"><a name="l02756"></a><span class="lineno"> 2756</span>&#160;        }</div><div class="line"><a name="l02757"></a><span class="lineno"> 2757</span>&#160;        setDeferredMultiBulkLength(c, flaglen, flagcount);</div><div class="line"><a name="l02758"></a><span class="lineno"> 2758</span>&#160;</div><div class="line"><a name="l02759"></a><span class="lineno"> 2759</span>&#160;        addReplyLongLong(c, cmd-&gt;firstkey);</div><div class="line"><a name="l02760"></a><span class="lineno"> 2760</span>&#160;        addReplyLongLong(c, cmd-&gt;lastkey);</div><div class="line"><a name="l02761"></a><span class="lineno"> 2761</span>&#160;        addReplyLongLong(c, cmd-&gt;keystep);</div><div class="line"><a name="l02762"></a><span class="lineno"> 2762</span>&#160;    }</div><div class="line"><a name="l02763"></a><span class="lineno"> 2763</span>&#160;}</div><div class="line"><a name="l02764"></a><span class="lineno"> 2764</span>&#160;</div><div class="line"><a name="l02765"></a><span class="lineno"> 2765</span>&#160;<span class="comment">/* COMMAND &lt;subcommand&gt; &lt;args&gt; */</span></div><div class="line"><a name="l02766"></a><span class="lineno"> 2766</span>&#160;<span class="keywordtype">void</span> commandCommand(<a class="code" href="structclient.html">client</a> *c) {</div><div class="line"><a name="l02767"></a><span class="lineno"> 2767</span>&#160;    dictIterator *di;</div><div class="line"><a name="l02768"></a><span class="lineno"> 2768</span>&#160;    dictEntry *de;</div><div class="line"><a name="l02769"></a><span class="lineno"> 2769</span>&#160;</div><div class="line"><a name="l02770"></a><span class="lineno"> 2770</span>&#160;    <span class="keywordflow">if</span> (c-&gt;argc == 2 &amp;&amp; !strcasecmp(c-&gt;argv[1]-&gt;ptr,<span class="stringliteral">&quot;help&quot;</span>)) {</div><div class="line"><a name="l02771"></a><span class="lineno"> 2771</span>&#160;        <span class="keyword">const</span> <span class="keywordtype">char</span> *help[] = {</div><div class="line"><a name="l02772"></a><span class="lineno"> 2772</span>&#160;<span class="stringliteral">&quot;(no subcommand) -- Return details about all Redis commands.&quot;</span>,</div><div class="line"><a name="l02773"></a><span class="lineno"> 2773</span>&#160;<span class="stringliteral">&quot;count -- Return the total number of commands in this Redis server.&quot;</span>,</div><div class="line"><a name="l02774"></a><span class="lineno"> 2774</span>&#160;<span class="stringliteral">&quot;getkeys &lt;full-command&gt; -- Return the keys from a full Redis command.&quot;</span>,</div><div class="line"><a name="l02775"></a><span class="lineno"> 2775</span>&#160;<span class="stringliteral">&quot;info [command-name ...] -- Return details about multiple Redis commands.&quot;</span>,</div><div class="line"><a name="l02776"></a><span class="lineno"> 2776</span>&#160;NULL</div><div class="line"><a name="l02777"></a><span class="lineno"> 2777</span>&#160;        };</div><div class="line"><a name="l02778"></a><span class="lineno"> 2778</span>&#160;        addReplyHelp(c, help);</div><div class="line"><a name="l02779"></a><span class="lineno"> 2779</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (c-&gt;argc == 1) {</div><div class="line"><a name="l02780"></a><span class="lineno"> 2780</span>&#160;        addReplyMultiBulkLen(c, <a class="code" href="dict_8h.html#af193430dd3d5579a52b194512f72c1f0">dictSize</a>(server.commands));</div><div class="line"><a name="l02781"></a><span class="lineno"> 2781</span>&#160;        di = dictGetIterator(server.commands);</div><div class="line"><a name="l02782"></a><span class="lineno"> 2782</span>&#160;        <span class="keywordflow">while</span> ((de = dictNext(di)) != NULL) {</div><div class="line"><a name="l02783"></a><span class="lineno"> 2783</span>&#160;            addReplyCommand(c, <a class="code" href="dict_8h.html#ae8d2cc391873b2bea2b87c4f80f43120">dictGetVal</a>(de));</div><div class="line"><a name="l02784"></a><span class="lineno"> 2784</span>&#160;        }</div><div class="line"><a name="l02785"></a><span class="lineno"> 2785</span>&#160;        dictReleaseIterator(di);</div><div class="line"><a name="l02786"></a><span class="lineno"> 2786</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(c-&gt;argv[1]-&gt;ptr, <span class="stringliteral">&quot;info&quot;</span>)) {</div><div class="line"><a name="l02787"></a><span class="lineno"> 2787</span>&#160;        <span class="keywordtype">int</span> i;</div><div class="line"><a name="l02788"></a><span class="lineno"> 2788</span>&#160;        addReplyMultiBulkLen(c, c-&gt;argc-2);</div><div class="line"><a name="l02789"></a><span class="lineno"> 2789</span>&#160;        <span class="keywordflow">for</span> (i = 2; i &lt; c-&gt;argc; i++) {</div><div class="line"><a name="l02790"></a><span class="lineno"> 2790</span>&#160;            addReplyCommand(c, dictFetchValue(server.commands, c-&gt;argv[i]-&gt;ptr));</div><div class="line"><a name="l02791"></a><span class="lineno"> 2791</span>&#160;        }</div><div class="line"><a name="l02792"></a><span class="lineno"> 2792</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(c-&gt;argv[1]-&gt;ptr, <span class="stringliteral">&quot;count&quot;</span>) &amp;&amp; c-&gt;argc == 2) {</div><div class="line"><a name="l02793"></a><span class="lineno"> 2793</span>&#160;        addReplyLongLong(c, <a class="code" href="dict_8h.html#af193430dd3d5579a52b194512f72c1f0">dictSize</a>(server.commands));</div><div class="line"><a name="l02794"></a><span class="lineno"> 2794</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(c-&gt;argv[1]-&gt;ptr,<span class="stringliteral">&quot;getkeys&quot;</span>) &amp;&amp; c-&gt;argc &gt;= 3) {</div><div class="line"><a name="l02795"></a><span class="lineno"> 2795</span>&#160;        <span class="keyword">struct</span> <a class="code" href="structredisCommand.html">redisCommand</a> *cmd = lookupCommand(c-&gt;argv[2]-&gt;ptr);</div><div class="line"><a name="l02796"></a><span class="lineno"> 2796</span>&#160;        <span class="keywordtype">int</span> *keys, numkeys, j;</div><div class="line"><a name="l02797"></a><span class="lineno"> 2797</span>&#160;</div><div class="line"><a name="l02798"></a><span class="lineno"> 2798</span>&#160;        <span class="keywordflow">if</span> (!cmd) {</div><div class="line"><a name="l02799"></a><span class="lineno"> 2799</span>&#160;            addReplyErrorFormat(c,<span class="stringliteral">&quot;Invalid command specified&quot;</span>);</div><div class="line"><a name="l02800"></a><span class="lineno"> 2800</span>&#160;            <span class="keywordflow">return</span>;</div><div class="line"><a name="l02801"></a><span class="lineno"> 2801</span>&#160;        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((cmd-&gt;arity &gt; 0 &amp;&amp; cmd-&gt;arity != c-&gt;argc-2) ||</div><div class="line"><a name="l02802"></a><span class="lineno"> 2802</span>&#160;                   ((c-&gt;argc-2) &lt; -cmd-&gt;arity))</div><div class="line"><a name="l02803"></a><span class="lineno"> 2803</span>&#160;        {</div><div class="line"><a name="l02804"></a><span class="lineno"> 2804</span>&#160;            addReplyError(c,<span class="stringliteral">&quot;Invalid number of arguments specified for command&quot;</span>);</div><div class="line"><a name="l02805"></a><span class="lineno"> 2805</span>&#160;            <span class="keywordflow">return</span>;</div><div class="line"><a name="l02806"></a><span class="lineno"> 2806</span>&#160;        }</div><div class="line"><a name="l02807"></a><span class="lineno"> 2807</span>&#160;</div><div class="line"><a name="l02808"></a><span class="lineno"> 2808</span>&#160;        keys = getKeysFromCommand(cmd,c-&gt;argv+2,c-&gt;argc-2,&amp;numkeys);</div><div class="line"><a name="l02809"></a><span class="lineno"> 2809</span>&#160;        addReplyMultiBulkLen(c,numkeys);</div><div class="line"><a name="l02810"></a><span class="lineno"> 2810</span>&#160;        <span class="keywordflow">for</span> (j = 0; j &lt; numkeys; j++) addReplyBulk(c,c-&gt;argv[keys[j]+2]);</div><div class="line"><a name="l02811"></a><span class="lineno"> 2811</span>&#160;        getKeysFreeResult(keys);</div><div class="line"><a name="l02812"></a><span class="lineno"> 2812</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l02813"></a><span class="lineno"> 2813</span>&#160;        addReplyErrorFormat(c, <span class="stringliteral">&quot;Unknown subcommand or wrong number of arguments for &#39;%s&#39;. Try COMMAND HELP&quot;</span>, (<span class="keywordtype">char</span>*)c-&gt;argv[1]-&gt;ptr);</div><div class="line"><a name="l02814"></a><span class="lineno"> 2814</span>&#160;    }</div><div class="line"><a name="l02815"></a><span class="lineno"> 2815</span>&#160;}</div><div class="line"><a name="l02816"></a><span class="lineno"> 2816</span>&#160;</div><div class="line"><a name="l02817"></a><span class="lineno"> 2817</span>&#160;<span class="comment">/* Convert an amount of bytes into a human readable string in the form</span></div><div class="line"><a name="l02818"></a><span class="lineno"> 2818</span>&#160;<span class="comment"> * of 100B, 2G, 100M, 4K, and so forth. */</span></div><div class="line"><a name="l02819"></a><span class="lineno"> 2819</span>&#160;<span class="keywordtype">void</span> bytesToHuman(<span class="keywordtype">char</span> *s, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> n) {</div><div class="line"><a name="l02820"></a><span class="lineno"> 2820</span>&#160;    <span class="keywordtype">double</span> d;</div><div class="line"><a name="l02821"></a><span class="lineno"> 2821</span>&#160;</div><div class="line"><a name="l02822"></a><span class="lineno"> 2822</span>&#160;    <span class="keywordflow">if</span> (n &lt; 1024) {</div><div class="line"><a name="l02823"></a><span class="lineno"> 2823</span>&#160;        <span class="comment">/* Bytes */</span></div><div class="line"><a name="l02824"></a><span class="lineno"> 2824</span>&#160;        sprintf(s,<span class="stringliteral">&quot;%lluB&quot;</span>,n);</div><div class="line"><a name="l02825"></a><span class="lineno"> 2825</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l02826"></a><span class="lineno"> 2826</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (n &lt; (1024*1024)) {</div><div class="line"><a name="l02827"></a><span class="lineno"> 2827</span>&#160;        d = (<span class="keywordtype">double</span>)n/(1024);</div><div class="line"><a name="l02828"></a><span class="lineno"> 2828</span>&#160;        sprintf(s,<span class="stringliteral">&quot;%.2fK&quot;</span>,d);</div><div class="line"><a name="l02829"></a><span class="lineno"> 2829</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (n &lt; (1024LL*1024*1024)) {</div><div class="line"><a name="l02830"></a><span class="lineno"> 2830</span>&#160;        d = (<span class="keywordtype">double</span>)n/(1024*1024);</div><div class="line"><a name="l02831"></a><span class="lineno"> 2831</span>&#160;        sprintf(s,<span class="stringliteral">&quot;%.2fM&quot;</span>,d);</div><div class="line"><a name="l02832"></a><span class="lineno"> 2832</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (n &lt; (1024LL*1024*1024*1024)) {</div><div class="line"><a name="l02833"></a><span class="lineno"> 2833</span>&#160;        d = (<span class="keywordtype">double</span>)n/(1024LL*1024*1024);</div><div class="line"><a name="l02834"></a><span class="lineno"> 2834</span>&#160;        sprintf(s,<span class="stringliteral">&quot;%.2fG&quot;</span>,d);</div><div class="line"><a name="l02835"></a><span class="lineno"> 2835</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (n &lt; (1024LL*1024*1024*1024*1024)) {</div><div class="line"><a name="l02836"></a><span class="lineno"> 2836</span>&#160;        d = (<span class="keywordtype">double</span>)n/(1024LL*1024*1024*1024);</div><div class="line"><a name="l02837"></a><span class="lineno"> 2837</span>&#160;        sprintf(s,<span class="stringliteral">&quot;%.2fT&quot;</span>,d);</div><div class="line"><a name="l02838"></a><span class="lineno"> 2838</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (n &lt; (1024LL*1024*1024*1024*1024*1024)) {</div><div class="line"><a name="l02839"></a><span class="lineno"> 2839</span>&#160;        d = (<span class="keywordtype">double</span>)n/(1024LL*1024*1024*1024*1024);</div><div class="line"><a name="l02840"></a><span class="lineno"> 2840</span>&#160;        sprintf(s,<span class="stringliteral">&quot;%.2fP&quot;</span>,d);</div><div class="line"><a name="l02841"></a><span class="lineno"> 2841</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l02842"></a><span class="lineno"> 2842</span>&#160;        <span class="comment">/* Let&#39;s hope we never need this */</span></div><div class="line"><a name="l02843"></a><span class="lineno"> 2843</span>&#160;        sprintf(s,<span class="stringliteral">&quot;%lluB&quot;</span>,n);</div><div class="line"><a name="l02844"></a><span class="lineno"> 2844</span>&#160;    }</div><div class="line"><a name="l02845"></a><span class="lineno"> 2845</span>&#160;}</div><div class="line"><a name="l02846"></a><span class="lineno"> 2846</span>&#160;</div><div class="line"><a name="l02847"></a><span class="lineno"> 2847</span>&#160;<span class="comment">/* Create the string returned by the INFO command. This is decoupled</span></div><div class="line"><a name="l02848"></a><span class="lineno"> 2848</span>&#160;<span class="comment"> * by the INFO command itself as we need to report the same information</span></div><div class="line"><a name="l02849"></a><span class="lineno"> 2849</span>&#160;<span class="comment"> * on memory corruption problems. */</span></div><div class="line"><a name="l02850"></a><span class="lineno"> 2850</span>&#160;sds genRedisInfoString(<span class="keywordtype">char</span> *section) {</div><div class="line"><a name="l02851"></a><span class="lineno"> 2851</span>&#160;    sds info = sdsempty();</div><div class="line"><a name="l02852"></a><span class="lineno"> 2852</span>&#160;    time_t uptime = server.unixtime-server.stat_starttime;</div><div class="line"><a name="l02853"></a><span class="lineno"> 2853</span>&#160;    <span class="keywordtype">int</span> j;</div><div class="line"><a name="l02854"></a><span class="lineno"> 2854</span>&#160;    <span class="keyword">struct</span> rusage self_ru, c_ru;</div><div class="line"><a name="l02855"></a><span class="lineno"> 2855</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> lol, bib;</div><div class="line"><a name="l02856"></a><span class="lineno"> 2856</span>&#160;    <span class="keywordtype">int</span> allsections = 0, defsections = 0;</div><div class="line"><a name="l02857"></a><span class="lineno"> 2857</span>&#160;    <span class="keywordtype">int</span> sections = 0;</div><div class="line"><a name="l02858"></a><span class="lineno"> 2858</span>&#160;</div><div class="line"><a name="l02859"></a><span class="lineno"> 2859</span>&#160;    <span class="keywordflow">if</span> (section == NULL) section = <span class="stringliteral">&quot;default&quot;</span>;</div><div class="line"><a name="l02860"></a><span class="lineno"> 2860</span>&#160;    allsections = strcasecmp(section,<span class="stringliteral">&quot;all&quot;</span>) == 0;</div><div class="line"><a name="l02861"></a><span class="lineno"> 2861</span>&#160;    defsections = strcasecmp(section,<span class="stringliteral">&quot;default&quot;</span>) == 0;</div><div class="line"><a name="l02862"></a><span class="lineno"> 2862</span>&#160;</div><div class="line"><a name="l02863"></a><span class="lineno"> 2863</span>&#160;    getrusage(RUSAGE_SELF, &amp;self_ru);</div><div class="line"><a name="l02864"></a><span class="lineno"> 2864</span>&#160;    getrusage(RUSAGE_CHILDREN, &amp;c_ru);</div><div class="line"><a name="l02865"></a><span class="lineno"> 2865</span>&#160;    getClientsMaxBuffers(&amp;lol,&amp;bib);</div><div class="line"><a name="l02866"></a><span class="lineno"> 2866</span>&#160;</div><div class="line"><a name="l02867"></a><span class="lineno"> 2867</span>&#160;    <span class="comment">/* Server */</span></div><div class="line"><a name="l02868"></a><span class="lineno"> 2868</span>&#160;    <span class="keywordflow">if</span> (allsections || defsections || !strcasecmp(section,<span class="stringliteral">&quot;server&quot;</span>)) {</div><div class="line"><a name="l02869"></a><span class="lineno"> 2869</span>&#160;        <span class="keyword">static</span> <span class="keywordtype">int</span> call_uname = 1;</div><div class="line"><a name="l02870"></a><span class="lineno"> 2870</span>&#160;        <span class="keyword">static</span> <span class="keyword">struct</span> utsname name;</div><div class="line"><a name="l02871"></a><span class="lineno"> 2871</span>&#160;        <span class="keywordtype">char</span> *mode;</div><div class="line"><a name="l02872"></a><span class="lineno"> 2872</span>&#160;</div><div class="line"><a name="l02873"></a><span class="lineno"> 2873</span>&#160;        <span class="keywordflow">if</span> (server.cluster_enabled) mode = <span class="stringliteral">&quot;cluster&quot;</span>;</div><div class="line"><a name="l02874"></a><span class="lineno"> 2874</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (server.sentinel_mode) mode = <span class="stringliteral">&quot;sentinel&quot;</span>;</div><div class="line"><a name="l02875"></a><span class="lineno"> 2875</span>&#160;        <span class="keywordflow">else</span> mode = <span class="stringliteral">&quot;standalone&quot;</span>;</div><div class="line"><a name="l02876"></a><span class="lineno"> 2876</span>&#160;</div><div class="line"><a name="l02877"></a><span class="lineno"> 2877</span>&#160;        <span class="keywordflow">if</span> (sections++) info = sdscat(info,<span class="stringliteral">&quot;\r\n&quot;</span>);</div><div class="line"><a name="l02878"></a><span class="lineno"> 2878</span>&#160;</div><div class="line"><a name="l02879"></a><span class="lineno"> 2879</span>&#160;        <span class="keywordflow">if</span> (call_uname) {</div><div class="line"><a name="l02880"></a><span class="lineno"> 2880</span>&#160;            <span class="comment">/* Uname can be slow and is always the same output. Cache it. */</span></div><div class="line"><a name="l02881"></a><span class="lineno"> 2881</span>&#160;            uname(&amp;name);</div><div class="line"><a name="l02882"></a><span class="lineno"> 2882</span>&#160;            call_uname = 0;</div><div class="line"><a name="l02883"></a><span class="lineno"> 2883</span>&#160;        }</div><div class="line"><a name="l02884"></a><span class="lineno"> 2884</span>&#160;</div><div class="line"><a name="l02885"></a><span class="lineno"> 2885</span>&#160;        <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> lruclock;</div><div class="line"><a name="l02886"></a><span class="lineno"> 2886</span>&#160;        <a class="code" href="atomicvar_8h.html#a57b17e058ecff6871debb3d1d4f3031a">atomicGet</a>(server.lruclock,lruclock);</div><div class="line"><a name="l02887"></a><span class="lineno"> 2887</span>&#160;        info = sdscatprintf(info,</div><div class="line"><a name="l02888"></a><span class="lineno"> 2888</span>&#160;            <span class="stringliteral">&quot;# Server\r\n&quot;</span></div><div class="line"><a name="l02889"></a><span class="lineno"> 2889</span>&#160;            <span class="stringliteral">&quot;redis_version:%s\r\n&quot;</span></div><div class="line"><a name="l02890"></a><span class="lineno"> 2890</span>&#160;            <span class="stringliteral">&quot;redis_git_sha1:%s\r\n&quot;</span></div><div class="line"><a name="l02891"></a><span class="lineno"> 2891</span>&#160;            <span class="stringliteral">&quot;redis_git_dirty:%d\r\n&quot;</span></div><div class="line"><a name="l02892"></a><span class="lineno"> 2892</span>&#160;            <span class="stringliteral">&quot;redis_build_id:%llx\r\n&quot;</span></div><div class="line"><a name="l02893"></a><span class="lineno"> 2893</span>&#160;            <span class="stringliteral">&quot;redis_mode:%s\r\n&quot;</span></div><div class="line"><a name="l02894"></a><span class="lineno"> 2894</span>&#160;            <span class="stringliteral">&quot;os:%s %s %s\r\n&quot;</span></div><div class="line"><a name="l02895"></a><span class="lineno"> 2895</span>&#160;            <span class="stringliteral">&quot;arch_bits:%d\r\n&quot;</span></div><div class="line"><a name="l02896"></a><span class="lineno"> 2896</span>&#160;            <span class="stringliteral">&quot;multiplexing_api:%s\r\n&quot;</span></div><div class="line"><a name="l02897"></a><span class="lineno"> 2897</span>&#160;            <span class="stringliteral">&quot;atomicvar_api:%s\r\n&quot;</span></div><div class="line"><a name="l02898"></a><span class="lineno"> 2898</span>&#160;            <span class="stringliteral">&quot;gcc_version:%d.%d.%d\r\n&quot;</span></div><div class="line"><a name="l02899"></a><span class="lineno"> 2899</span>&#160;            <span class="stringliteral">&quot;process_id:%ld\r\n&quot;</span></div><div class="line"><a name="l02900"></a><span class="lineno"> 2900</span>&#160;            <span class="stringliteral">&quot;run_id:%s\r\n&quot;</span></div><div class="line"><a name="l02901"></a><span class="lineno"> 2901</span>&#160;            <span class="stringliteral">&quot;tcp_port:%d\r\n&quot;</span></div><div class="line"><a name="l02902"></a><span class="lineno"> 2902</span>&#160;            <span class="stringliteral">&quot;uptime_in_seconds:%jd\r\n&quot;</span></div><div class="line"><a name="l02903"></a><span class="lineno"> 2903</span>&#160;            <span class="stringliteral">&quot;uptime_in_days:%jd\r\n&quot;</span></div><div class="line"><a name="l02904"></a><span class="lineno"> 2904</span>&#160;            <span class="stringliteral">&quot;hz:%d\r\n&quot;</span></div><div class="line"><a name="l02905"></a><span class="lineno"> 2905</span>&#160;            <span class="stringliteral">&quot;lru_clock:%ld\r\n&quot;</span></div><div class="line"><a name="l02906"></a><span class="lineno"> 2906</span>&#160;            <span class="stringliteral">&quot;executable:%s\r\n&quot;</span></div><div class="line"><a name="l02907"></a><span class="lineno"> 2907</span>&#160;            <span class="stringliteral">&quot;config_file:%s\r\n&quot;</span>,</div><div class="line"><a name="l02908"></a><span class="lineno"> 2908</span>&#160;            <a class="code" href="version_8h.html#a357a0d302ef7fbb42bf2db0632b9f7fe">REDIS_VERSION</a>,</div><div class="line"><a name="l02909"></a><span class="lineno"> 2909</span>&#160;            redisGitSHA1(),</div><div class="line"><a name="l02910"></a><span class="lineno"> 2910</span>&#160;            strtol(redisGitDirty(),NULL,10) &gt; 0,</div><div class="line"><a name="l02911"></a><span class="lineno"> 2911</span>&#160;            (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span>) redisBuildId(),</div><div class="line"><a name="l02912"></a><span class="lineno"> 2912</span>&#160;            mode,</div><div class="line"><a name="l02913"></a><span class="lineno"> 2913</span>&#160;            name.sysname, name.release, name.machine,</div><div class="line"><a name="l02914"></a><span class="lineno"> 2914</span>&#160;            server.arch_bits,</div><div class="line"><a name="l02915"></a><span class="lineno"> 2915</span>&#160;            aeGetApiName(),</div><div class="line"><a name="l02916"></a><span class="lineno"> 2916</span>&#160;            <a class="code" href="atomicvar_8h.html#ae3aa976bb329a4a554a853c5770c3e3d">REDIS_ATOMIC_API</a>,</div><div class="line"><a name="l02917"></a><span class="lineno"> 2917</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">ifdef</span> __GNUC__</div><div class="line"><a name="l02918"></a><span class="lineno"> 2918</span>&#160;            __GNUC__,__GNUC_MINOR__,__GNUC_PATCHLEVEL__,</div><div class="line"><a name="l02919"></a><span class="lineno"> 2919</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">else</span></div><div class="line"><a name="l02920"></a><span class="lineno"> 2920</span>&#160;            0,0,0,</div><div class="line"><a name="l02921"></a><span class="lineno"> 2921</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">endif</span></div><div class="line"><a name="l02922"></a><span class="lineno"> 2922</span>&#160;            (<span class="keywordtype">long</span>) getpid(),</div><div class="line"><a name="l02923"></a><span class="lineno"> 2923</span>&#160;            server.runid,</div><div class="line"><a name="l02924"></a><span class="lineno"> 2924</span>&#160;            server.port,</div><div class="line"><a name="l02925"></a><span class="lineno"> 2925</span>&#160;            (intmax_t)uptime,</div><div class="line"><a name="l02926"></a><span class="lineno"> 2926</span>&#160;            (intmax_t)(uptime/(3600*24)),</div><div class="line"><a name="l02927"></a><span class="lineno"> 2927</span>&#160;            server.hz,</div><div class="line"><a name="l02928"></a><span class="lineno"> 2928</span>&#160;            (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>) lruclock,</div><div class="line"><a name="l02929"></a><span class="lineno"> 2929</span>&#160;            server.executable ? server.executable : <span class="stringliteral">&quot;&quot;</span>,</div><div class="line"><a name="l02930"></a><span class="lineno"> 2930</span>&#160;            server.configfile ? server.configfile : <span class="stringliteral">&quot;&quot;</span>);</div><div class="line"><a name="l02931"></a><span class="lineno"> 2931</span>&#160;    }</div><div class="line"><a name="l02932"></a><span class="lineno"> 2932</span>&#160;</div><div class="line"><a name="l02933"></a><span class="lineno"> 2933</span>&#160;    <span class="comment">/* Clients */</span></div><div class="line"><a name="l02934"></a><span class="lineno"> 2934</span>&#160;    <span class="keywordflow">if</span> (allsections || defsections || !strcasecmp(section,<span class="stringliteral">&quot;clients&quot;</span>)) {</div><div class="line"><a name="l02935"></a><span class="lineno"> 2935</span>&#160;        <span class="keywordflow">if</span> (sections++) info = sdscat(info,<span class="stringliteral">&quot;\r\n&quot;</span>);</div><div class="line"><a name="l02936"></a><span class="lineno"> 2936</span>&#160;        info = sdscatprintf(info,</div><div class="line"><a name="l02937"></a><span class="lineno"> 2937</span>&#160;            <span class="stringliteral">&quot;# Clients\r\n&quot;</span></div><div class="line"><a name="l02938"></a><span class="lineno"> 2938</span>&#160;            <span class="stringliteral">&quot;connected_clients:%lu\r\n&quot;</span></div><div class="line"><a name="l02939"></a><span class="lineno"> 2939</span>&#160;            <span class="stringliteral">&quot;client_longest_output_list:%lu\r\n&quot;</span></div><div class="line"><a name="l02940"></a><span class="lineno"> 2940</span>&#160;            <span class="stringliteral">&quot;client_biggest_input_buf:%lu\r\n&quot;</span></div><div class="line"><a name="l02941"></a><span class="lineno"> 2941</span>&#160;            <span class="stringliteral">&quot;blocked_clients:%d\r\n&quot;</span>,</div><div class="line"><a name="l02942"></a><span class="lineno"> 2942</span>&#160;            <a class="code" href="adlist_8h.html#afde0ab079f934670e82119b43120e94b">listLength</a>(server.clients)-<a class="code" href="adlist_8h.html#afde0ab079f934670e82119b43120e94b">listLength</a>(server.slaves),</div><div class="line"><a name="l02943"></a><span class="lineno"> 2943</span>&#160;            lol, bib,</div><div class="line"><a name="l02944"></a><span class="lineno"> 2944</span>&#160;            server.blocked_clients);</div><div class="line"><a name="l02945"></a><span class="lineno"> 2945</span>&#160;    }</div><div class="line"><a name="l02946"></a><span class="lineno"> 2946</span>&#160;</div><div class="line"><a name="l02947"></a><span class="lineno"> 2947</span>&#160;    <span class="comment">/* Memory */</span></div><div class="line"><a name="l02948"></a><span class="lineno"> 2948</span>&#160;    <span class="keywordflow">if</span> (allsections || defsections || !strcasecmp(section,<span class="stringliteral">&quot;memory&quot;</span>)) {</div><div class="line"><a name="l02949"></a><span class="lineno"> 2949</span>&#160;        <span class="keywordtype">char</span> hmem[64];</div><div class="line"><a name="l02950"></a><span class="lineno"> 2950</span>&#160;        <span class="keywordtype">char</span> peak_hmem[64];</div><div class="line"><a name="l02951"></a><span class="lineno"> 2951</span>&#160;        <span class="keywordtype">char</span> total_system_hmem[64];</div><div class="line"><a name="l02952"></a><span class="lineno"> 2952</span>&#160;        <span class="keywordtype">char</span> used_memory_lua_hmem[64];</div><div class="line"><a name="l02953"></a><span class="lineno"> 2953</span>&#160;        <span class="keywordtype">char</span> used_memory_rss_hmem[64];</div><div class="line"><a name="l02954"></a><span class="lineno"> 2954</span>&#160;        <span class="keywordtype">char</span> maxmemory_hmem[64];</div><div class="line"><a name="l02955"></a><span class="lineno"> 2955</span>&#160;        size_t zmalloc_used = zmalloc_used_memory();</div><div class="line"><a name="l02956"></a><span class="lineno"> 2956</span>&#160;        size_t total_system_mem = server.system_memory_size;</div><div class="line"><a name="l02957"></a><span class="lineno"> 2957</span>&#160;        <span class="keyword">const</span> <span class="keywordtype">char</span> *evict_policy = evictPolicyToString();</div><div class="line"><a name="l02958"></a><span class="lineno"> 2958</span>&#160;        <span class="keywordtype">long</span> <span class="keywordtype">long</span> memory_lua = (<span class="keywordtype">long</span> <span class="keywordtype">long</span>)lua_gc(server.lua,LUA_GCCOUNT,0)*1024;</div><div class="line"><a name="l02959"></a><span class="lineno"> 2959</span>&#160;        <span class="keyword">struct</span> <a class="code" href="structredisMemOverhead.html">redisMemOverhead</a> *mh = getMemoryOverheadData();</div><div class="line"><a name="l02960"></a><span class="lineno"> 2960</span>&#160;</div><div class="line"><a name="l02961"></a><span class="lineno"> 2961</span>&#160;        <span class="comment">/* Peak memory is updated from time to time by serverCron() so it</span></div><div class="line"><a name="l02962"></a><span class="lineno"> 2962</span>&#160;<span class="comment">         * may happen that the instantaneous value is slightly bigger than</span></div><div class="line"><a name="l02963"></a><span class="lineno"> 2963</span>&#160;<span class="comment">         * the peak value. This may confuse users, so we update the peak</span></div><div class="line"><a name="l02964"></a><span class="lineno"> 2964</span>&#160;<span class="comment">         * if found smaller than the current memory usage. */</span></div><div class="line"><a name="l02965"></a><span class="lineno"> 2965</span>&#160;        <span class="keywordflow">if</span> (zmalloc_used &gt; server.stat_peak_memory)</div><div class="line"><a name="l02966"></a><span class="lineno"> 2966</span>&#160;            server.stat_peak_memory = zmalloc_used;</div><div class="line"><a name="l02967"></a><span class="lineno"> 2967</span>&#160;</div><div class="line"><a name="l02968"></a><span class="lineno"> 2968</span>&#160;        bytesToHuman(hmem,zmalloc_used);</div><div class="line"><a name="l02969"></a><span class="lineno"> 2969</span>&#160;        bytesToHuman(peak_hmem,server.stat_peak_memory);</div><div class="line"><a name="l02970"></a><span class="lineno"> 2970</span>&#160;        bytesToHuman(total_system_hmem,total_system_mem);</div><div class="line"><a name="l02971"></a><span class="lineno"> 2971</span>&#160;        bytesToHuman(used_memory_lua_hmem,memory_lua);</div><div class="line"><a name="l02972"></a><span class="lineno"> 2972</span>&#160;        bytesToHuman(used_memory_rss_hmem,server.resident_set_size);</div><div class="line"><a name="l02973"></a><span class="lineno"> 2973</span>&#160;        bytesToHuman(maxmemory_hmem,server.maxmemory);</div><div class="line"><a name="l02974"></a><span class="lineno"> 2974</span>&#160;</div><div class="line"><a name="l02975"></a><span class="lineno"> 2975</span>&#160;        <span class="keywordflow">if</span> (sections++) info = sdscat(info,<span class="stringliteral">&quot;\r\n&quot;</span>);</div><div class="line"><a name="l02976"></a><span class="lineno"> 2976</span>&#160;        info = sdscatprintf(info,</div><div class="line"><a name="l02977"></a><span class="lineno"> 2977</span>&#160;            <span class="stringliteral">&quot;# Memory\r\n&quot;</span></div><div class="line"><a name="l02978"></a><span class="lineno"> 2978</span>&#160;            <span class="stringliteral">&quot;used_memory:%zu\r\n&quot;</span></div><div class="line"><a name="l02979"></a><span class="lineno"> 2979</span>&#160;            <span class="stringliteral">&quot;used_memory_human:%s\r\n&quot;</span></div><div class="line"><a name="l02980"></a><span class="lineno"> 2980</span>&#160;            <span class="stringliteral">&quot;used_memory_rss:%zu\r\n&quot;</span></div><div class="line"><a name="l02981"></a><span class="lineno"> 2981</span>&#160;            <span class="stringliteral">&quot;used_memory_rss_human:%s\r\n&quot;</span></div><div class="line"><a name="l02982"></a><span class="lineno"> 2982</span>&#160;            <span class="stringliteral">&quot;used_memory_peak:%zu\r\n&quot;</span></div><div class="line"><a name="l02983"></a><span class="lineno"> 2983</span>&#160;            <span class="stringliteral">&quot;used_memory_peak_human:%s\r\n&quot;</span></div><div class="line"><a name="l02984"></a><span class="lineno"> 2984</span>&#160;            <span class="stringliteral">&quot;used_memory_peak_perc:%.2f%%\r\n&quot;</span></div><div class="line"><a name="l02985"></a><span class="lineno"> 2985</span>&#160;            <span class="stringliteral">&quot;used_memory_overhead:%zu\r\n&quot;</span></div><div class="line"><a name="l02986"></a><span class="lineno"> 2986</span>&#160;            <span class="stringliteral">&quot;used_memory_startup:%zu\r\n&quot;</span></div><div class="line"><a name="l02987"></a><span class="lineno"> 2987</span>&#160;            <span class="stringliteral">&quot;used_memory_dataset:%zu\r\n&quot;</span></div><div class="line"><a name="l02988"></a><span class="lineno"> 2988</span>&#160;            <span class="stringliteral">&quot;used_memory_dataset_perc:%.2f%%\r\n&quot;</span></div><div class="line"><a name="l02989"></a><span class="lineno"> 2989</span>&#160;            <span class="stringliteral">&quot;total_system_memory:%lu\r\n&quot;</span></div><div class="line"><a name="l02990"></a><span class="lineno"> 2990</span>&#160;            <span class="stringliteral">&quot;total_system_memory_human:%s\r\n&quot;</span></div><div class="line"><a name="l02991"></a><span class="lineno"> 2991</span>&#160;            <span class="stringliteral">&quot;used_memory_lua:%lld\r\n&quot;</span></div><div class="line"><a name="l02992"></a><span class="lineno"> 2992</span>&#160;            <span class="stringliteral">&quot;used_memory_lua_human:%s\r\n&quot;</span></div><div class="line"><a name="l02993"></a><span class="lineno"> 2993</span>&#160;            <span class="stringliteral">&quot;maxmemory:%lld\r\n&quot;</span></div><div class="line"><a name="l02994"></a><span class="lineno"> 2994</span>&#160;            <span class="stringliteral">&quot;maxmemory_human:%s\r\n&quot;</span></div><div class="line"><a name="l02995"></a><span class="lineno"> 2995</span>&#160;            <span class="stringliteral">&quot;maxmemory_policy:%s\r\n&quot;</span></div><div class="line"><a name="l02996"></a><span class="lineno"> 2996</span>&#160;            <span class="stringliteral">&quot;mem_fragmentation_ratio:%.2f\r\n&quot;</span></div><div class="line"><a name="l02997"></a><span class="lineno"> 2997</span>&#160;            <span class="stringliteral">&quot;mem_allocator:%s\r\n&quot;</span></div><div class="line"><a name="l02998"></a><span class="lineno"> 2998</span>&#160;            <span class="stringliteral">&quot;active_defrag_running:%d\r\n&quot;</span></div><div class="line"><a name="l02999"></a><span class="lineno"> 2999</span>&#160;            <span class="stringliteral">&quot;lazyfree_pending_objects:%zu\r\n&quot;</span>,</div><div class="line"><a name="l03000"></a><span class="lineno"> 3000</span>&#160;            zmalloc_used,</div><div class="line"><a name="l03001"></a><span class="lineno"> 3001</span>&#160;            hmem,</div><div class="line"><a name="l03002"></a><span class="lineno"> 3002</span>&#160;            server.resident_set_size,</div><div class="line"><a name="l03003"></a><span class="lineno"> 3003</span>&#160;            used_memory_rss_hmem,</div><div class="line"><a name="l03004"></a><span class="lineno"> 3004</span>&#160;            server.stat_peak_memory,</div><div class="line"><a name="l03005"></a><span class="lineno"> 3005</span>&#160;            peak_hmem,</div><div class="line"><a name="l03006"></a><span class="lineno"> 3006</span>&#160;            mh-&gt;peak_perc,</div><div class="line"><a name="l03007"></a><span class="lineno"> 3007</span>&#160;            mh-&gt;overhead_total,</div><div class="line"><a name="l03008"></a><span class="lineno"> 3008</span>&#160;            mh-&gt;startup_allocated,</div><div class="line"><a name="l03009"></a><span class="lineno"> 3009</span>&#160;            mh-&gt;dataset,</div><div class="line"><a name="l03010"></a><span class="lineno"> 3010</span>&#160;            mh-&gt;dataset_perc,</div><div class="line"><a name="l03011"></a><span class="lineno"> 3011</span>&#160;            (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)total_system_mem,</div><div class="line"><a name="l03012"></a><span class="lineno"> 3012</span>&#160;            total_system_hmem,</div><div class="line"><a name="l03013"></a><span class="lineno"> 3013</span>&#160;            memory_lua,</div><div class="line"><a name="l03014"></a><span class="lineno"> 3014</span>&#160;            used_memory_lua_hmem,</div><div class="line"><a name="l03015"></a><span class="lineno"> 3015</span>&#160;            server.maxmemory,</div><div class="line"><a name="l03016"></a><span class="lineno"> 3016</span>&#160;            maxmemory_hmem,</div><div class="line"><a name="l03017"></a><span class="lineno"> 3017</span>&#160;            evict_policy,</div><div class="line"><a name="l03018"></a><span class="lineno"> 3018</span>&#160;            mh-&gt;fragmentation,</div><div class="line"><a name="l03019"></a><span class="lineno"> 3019</span>&#160;            <a class="code" href="zmalloc_8h.html#a374c6d7cf6c9817e1243093e03df7319">ZMALLOC_LIB</a>,</div><div class="line"><a name="l03020"></a><span class="lineno"> 3020</span>&#160;            server.active_defrag_running,</div><div class="line"><a name="l03021"></a><span class="lineno"> 3021</span>&#160;            lazyfreeGetPendingObjectsCount()</div><div class="line"><a name="l03022"></a><span class="lineno"> 3022</span>&#160;        );</div><div class="line"><a name="l03023"></a><span class="lineno"> 3023</span>&#160;        freeMemoryOverheadData(mh);</div><div class="line"><a name="l03024"></a><span class="lineno"> 3024</span>&#160;    }</div><div class="line"><a name="l03025"></a><span class="lineno"> 3025</span>&#160;</div><div class="line"><a name="l03026"></a><span class="lineno"> 3026</span>&#160;    <span class="comment">/* Persistence */</span></div><div class="line"><a name="l03027"></a><span class="lineno"> 3027</span>&#160;    <span class="keywordflow">if</span> (allsections || defsections || !strcasecmp(section,<span class="stringliteral">&quot;persistence&quot;</span>)) {</div><div class="line"><a name="l03028"></a><span class="lineno"> 3028</span>&#160;        <span class="keywordflow">if</span> (sections++) info = sdscat(info,<span class="stringliteral">&quot;\r\n&quot;</span>);</div><div class="line"><a name="l03029"></a><span class="lineno"> 3029</span>&#160;        info = sdscatprintf(info,</div><div class="line"><a name="l03030"></a><span class="lineno"> 3030</span>&#160;            <span class="stringliteral">&quot;# Persistence\r\n&quot;</span></div><div class="line"><a name="l03031"></a><span class="lineno"> 3031</span>&#160;            <span class="stringliteral">&quot;loading:%d\r\n&quot;</span></div><div class="line"><a name="l03032"></a><span class="lineno"> 3032</span>&#160;            <span class="stringliteral">&quot;rdb_changes_since_last_save:%lld\r\n&quot;</span></div><div class="line"><a name="l03033"></a><span class="lineno"> 3033</span>&#160;            <span class="stringliteral">&quot;rdb_bgsave_in_progress:%d\r\n&quot;</span></div><div class="line"><a name="l03034"></a><span class="lineno"> 3034</span>&#160;            <span class="stringliteral">&quot;rdb_last_save_time:%jd\r\n&quot;</span></div><div class="line"><a name="l03035"></a><span class="lineno"> 3035</span>&#160;            <span class="stringliteral">&quot;rdb_last_bgsave_status:%s\r\n&quot;</span></div><div class="line"><a name="l03036"></a><span class="lineno"> 3036</span>&#160;            <span class="stringliteral">&quot;rdb_last_bgsave_time_sec:%jd\r\n&quot;</span></div><div class="line"><a name="l03037"></a><span class="lineno"> 3037</span>&#160;            <span class="stringliteral">&quot;rdb_current_bgsave_time_sec:%jd\r\n&quot;</span></div><div class="line"><a name="l03038"></a><span class="lineno"> 3038</span>&#160;            <span class="stringliteral">&quot;rdb_last_cow_size:%zu\r\n&quot;</span></div><div class="line"><a name="l03039"></a><span class="lineno"> 3039</span>&#160;            <span class="stringliteral">&quot;aof_enabled:%d\r\n&quot;</span></div><div class="line"><a name="l03040"></a><span class="lineno"> 3040</span>&#160;            <span class="stringliteral">&quot;aof_rewrite_in_progress:%d\r\n&quot;</span></div><div class="line"><a name="l03041"></a><span class="lineno"> 3041</span>&#160;            <span class="stringliteral">&quot;aof_rewrite_scheduled:%d\r\n&quot;</span></div><div class="line"><a name="l03042"></a><span class="lineno"> 3042</span>&#160;            <span class="stringliteral">&quot;aof_last_rewrite_time_sec:%jd\r\n&quot;</span></div><div class="line"><a name="l03043"></a><span class="lineno"> 3043</span>&#160;            <span class="stringliteral">&quot;aof_current_rewrite_time_sec:%jd\r\n&quot;</span></div><div class="line"><a name="l03044"></a><span class="lineno"> 3044</span>&#160;            <span class="stringliteral">&quot;aof_last_bgrewrite_status:%s\r\n&quot;</span></div><div class="line"><a name="l03045"></a><span class="lineno"> 3045</span>&#160;            <span class="stringliteral">&quot;aof_last_write_status:%s\r\n&quot;</span></div><div class="line"><a name="l03046"></a><span class="lineno"> 3046</span>&#160;            <span class="stringliteral">&quot;aof_last_cow_size:%zu\r\n&quot;</span>,</div><div class="line"><a name="l03047"></a><span class="lineno"> 3047</span>&#160;            server.loading,</div><div class="line"><a name="l03048"></a><span class="lineno"> 3048</span>&#160;            server.dirty,</div><div class="line"><a name="l03049"></a><span class="lineno"> 3049</span>&#160;            server.rdb_child_pid != -1,</div><div class="line"><a name="l03050"></a><span class="lineno"> 3050</span>&#160;            (intmax_t)server.lastsave,</div><div class="line"><a name="l03051"></a><span class="lineno"> 3051</span>&#160;            (server.lastbgsave_status == <a class="code" href="server_8h.html#a303769ef1065076e68731584e758d3e1">C_OK</a>) ? <span class="stringliteral">&quot;ok&quot;</span> : <span class="stringliteral">&quot;err&quot;</span>,</div><div class="line"><a name="l03052"></a><span class="lineno"> 3052</span>&#160;            (intmax_t)server.rdb_save_time_last,</div><div class="line"><a name="l03053"></a><span class="lineno"> 3053</span>&#160;            (intmax_t)((server.rdb_child_pid == -1) ?</div><div class="line"><a name="l03054"></a><span class="lineno"> 3054</span>&#160;                -1 : time(NULL)-server.rdb_save_time_start),</div><div class="line"><a name="l03055"></a><span class="lineno"> 3055</span>&#160;            server.stat_rdb_cow_bytes,</div><div class="line"><a name="l03056"></a><span class="lineno"> 3056</span>&#160;            server.aof_state != <a class="code" href="server_8h.html#a5226306fbcebcb6d5d02e0fef3c213c2">AOF_OFF</a>,</div><div class="line"><a name="l03057"></a><span class="lineno"> 3057</span>&#160;            server.aof_child_pid != -1,</div><div class="line"><a name="l03058"></a><span class="lineno"> 3058</span>&#160;            server.aof_rewrite_scheduled,</div><div class="line"><a name="l03059"></a><span class="lineno"> 3059</span>&#160;            (intmax_t)server.aof_rewrite_time_last,</div><div class="line"><a name="l03060"></a><span class="lineno"> 3060</span>&#160;            (intmax_t)((server.aof_child_pid == -1) ?</div><div class="line"><a name="l03061"></a><span class="lineno"> 3061</span>&#160;                -1 : time(NULL)-server.aof_rewrite_time_start),</div><div class="line"><a name="l03062"></a><span class="lineno"> 3062</span>&#160;            (server.aof_lastbgrewrite_status == <a class="code" href="server_8h.html#a303769ef1065076e68731584e758d3e1">C_OK</a>) ? <span class="stringliteral">&quot;ok&quot;</span> : <span class="stringliteral">&quot;err&quot;</span>,</div><div class="line"><a name="l03063"></a><span class="lineno"> 3063</span>&#160;            (server.aof_last_write_status == <a class="code" href="server_8h.html#a303769ef1065076e68731584e758d3e1">C_OK</a>) ? <span class="stringliteral">&quot;ok&quot;</span> : <span class="stringliteral">&quot;err&quot;</span>,</div><div class="line"><a name="l03064"></a><span class="lineno"> 3064</span>&#160;            server.stat_aof_cow_bytes);</div><div class="line"><a name="l03065"></a><span class="lineno"> 3065</span>&#160;</div><div class="line"><a name="l03066"></a><span class="lineno"> 3066</span>&#160;        <span class="keywordflow">if</span> (server.aof_state != <a class="code" href="server_8h.html#a5226306fbcebcb6d5d02e0fef3c213c2">AOF_OFF</a>) {</div><div class="line"><a name="l03067"></a><span class="lineno"> 3067</span>&#160;            info = sdscatprintf(info,</div><div class="line"><a name="l03068"></a><span class="lineno"> 3068</span>&#160;                <span class="stringliteral">&quot;aof_current_size:%lld\r\n&quot;</span></div><div class="line"><a name="l03069"></a><span class="lineno"> 3069</span>&#160;                <span class="stringliteral">&quot;aof_base_size:%lld\r\n&quot;</span></div><div class="line"><a name="l03070"></a><span class="lineno"> 3070</span>&#160;                <span class="stringliteral">&quot;aof_pending_rewrite:%d\r\n&quot;</span></div><div class="line"><a name="l03071"></a><span class="lineno"> 3071</span>&#160;                <span class="stringliteral">&quot;aof_buffer_length:%zu\r\n&quot;</span></div><div class="line"><a name="l03072"></a><span class="lineno"> 3072</span>&#160;                <span class="stringliteral">&quot;aof_rewrite_buffer_length:%lu\r\n&quot;</span></div><div class="line"><a name="l03073"></a><span class="lineno"> 3073</span>&#160;                <span class="stringliteral">&quot;aof_pending_bio_fsync:%llu\r\n&quot;</span></div><div class="line"><a name="l03074"></a><span class="lineno"> 3074</span>&#160;                <span class="stringliteral">&quot;aof_delayed_fsync:%lu\r\n&quot;</span>,</div><div class="line"><a name="l03075"></a><span class="lineno"> 3075</span>&#160;                (<span class="keywordtype">long</span> <span class="keywordtype">long</span>) server.aof_current_size,</div><div class="line"><a name="l03076"></a><span class="lineno"> 3076</span>&#160;                (<span class="keywordtype">long</span> <span class="keywordtype">long</span>) server.aof_rewrite_base_size,</div><div class="line"><a name="l03077"></a><span class="lineno"> 3077</span>&#160;                server.aof_rewrite_scheduled,</div><div class="line"><a name="l03078"></a><span class="lineno"> 3078</span>&#160;                sdslen(server.aof_buf),</div><div class="line"><a name="l03079"></a><span class="lineno"> 3079</span>&#160;                aofRewriteBufferSize(),</div><div class="line"><a name="l03080"></a><span class="lineno"> 3080</span>&#160;                bioPendingJobsOfType(<a class="code" href="bio_8h.html#a5d03c967316addafc61b7ed5d957984f">BIO_AOF_FSYNC</a>),</div><div class="line"><a name="l03081"></a><span class="lineno"> 3081</span>&#160;                server.aof_delayed_fsync);</div><div class="line"><a name="l03082"></a><span class="lineno"> 3082</span>&#160;        }</div><div class="line"><a name="l03083"></a><span class="lineno"> 3083</span>&#160;</div><div class="line"><a name="l03084"></a><span class="lineno"> 3084</span>&#160;        <span class="keywordflow">if</span> (server.loading) {</div><div class="line"><a name="l03085"></a><span class="lineno"> 3085</span>&#160;            <span class="keywordtype">double</span> perc;</div><div class="line"><a name="l03086"></a><span class="lineno"> 3086</span>&#160;            time_t eta, elapsed;</div><div class="line"><a name="l03087"></a><span class="lineno"> 3087</span>&#160;            off_t remaining_bytes = server.loading_total_bytes-</div><div class="line"><a name="l03088"></a><span class="lineno"> 3088</span>&#160;                                    server.loading_loaded_bytes;</div><div class="line"><a name="l03089"></a><span class="lineno"> 3089</span>&#160;</div><div class="line"><a name="l03090"></a><span class="lineno"> 3090</span>&#160;            perc = ((<span class="keywordtype">double</span>)server.loading_loaded_bytes /</div><div class="line"><a name="l03091"></a><span class="lineno"> 3091</span>&#160;                   (server.loading_total_bytes+1)) * 100;</div><div class="line"><a name="l03092"></a><span class="lineno"> 3092</span>&#160;</div><div class="line"><a name="l03093"></a><span class="lineno"> 3093</span>&#160;            elapsed = time(NULL)-server.loading_start_time;</div><div class="line"><a name="l03094"></a><span class="lineno"> 3094</span>&#160;            <span class="keywordflow">if</span> (elapsed == 0) {</div><div class="line"><a name="l03095"></a><span class="lineno"> 3095</span>&#160;                eta = 1; <span class="comment">/* A fake 1 second figure if we don&#39;t have</span></div><div class="line"><a name="l03096"></a><span class="lineno"> 3096</span>&#160;<span class="comment">                            enough info */</span></div><div class="line"><a name="l03097"></a><span class="lineno"> 3097</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l03098"></a><span class="lineno"> 3098</span>&#160;                eta = (elapsed*remaining_bytes)/(server.loading_loaded_bytes+1);</div><div class="line"><a name="l03099"></a><span class="lineno"> 3099</span>&#160;            }</div><div class="line"><a name="l03100"></a><span class="lineno"> 3100</span>&#160;</div><div class="line"><a name="l03101"></a><span class="lineno"> 3101</span>&#160;            info = sdscatprintf(info,</div><div class="line"><a name="l03102"></a><span class="lineno"> 3102</span>&#160;                <span class="stringliteral">&quot;loading_start_time:%jd\r\n&quot;</span></div><div class="line"><a name="l03103"></a><span class="lineno"> 3103</span>&#160;                <span class="stringliteral">&quot;loading_total_bytes:%llu\r\n&quot;</span></div><div class="line"><a name="l03104"></a><span class="lineno"> 3104</span>&#160;                <span class="stringliteral">&quot;loading_loaded_bytes:%llu\r\n&quot;</span></div><div class="line"><a name="l03105"></a><span class="lineno"> 3105</span>&#160;                <span class="stringliteral">&quot;loading_loaded_perc:%.2f\r\n&quot;</span></div><div class="line"><a name="l03106"></a><span class="lineno"> 3106</span>&#160;                <span class="stringliteral">&quot;loading_eta_seconds:%jd\r\n&quot;</span>,</div><div class="line"><a name="l03107"></a><span class="lineno"> 3107</span>&#160;                (intmax_t) server.loading_start_time,</div><div class="line"><a name="l03108"></a><span class="lineno"> 3108</span>&#160;                (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span>) server.loading_total_bytes,</div><div class="line"><a name="l03109"></a><span class="lineno"> 3109</span>&#160;                (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span>) server.loading_loaded_bytes,</div><div class="line"><a name="l03110"></a><span class="lineno"> 3110</span>&#160;                perc,</div><div class="line"><a name="l03111"></a><span class="lineno"> 3111</span>&#160;                (intmax_t)eta</div><div class="line"><a name="l03112"></a><span class="lineno"> 3112</span>&#160;            );</div><div class="line"><a name="l03113"></a><span class="lineno"> 3113</span>&#160;        }</div><div class="line"><a name="l03114"></a><span class="lineno"> 3114</span>&#160;    }</div><div class="line"><a name="l03115"></a><span class="lineno"> 3115</span>&#160;</div><div class="line"><a name="l03116"></a><span class="lineno"> 3116</span>&#160;    <span class="comment">/* Stats */</span></div><div class="line"><a name="l03117"></a><span class="lineno"> 3117</span>&#160;    <span class="keywordflow">if</span> (allsections || defsections || !strcasecmp(section,<span class="stringliteral">&quot;stats&quot;</span>)) {</div><div class="line"><a name="l03118"></a><span class="lineno"> 3118</span>&#160;        <span class="keywordflow">if</span> (sections++) info = sdscat(info,<span class="stringliteral">&quot;\r\n&quot;</span>);</div><div class="line"><a name="l03119"></a><span class="lineno"> 3119</span>&#160;        info = sdscatprintf(info,</div><div class="line"><a name="l03120"></a><span class="lineno"> 3120</span>&#160;            <span class="stringliteral">&quot;# Stats\r\n&quot;</span></div><div class="line"><a name="l03121"></a><span class="lineno"> 3121</span>&#160;            <span class="stringliteral">&quot;total_connections_received:%lld\r\n&quot;</span></div><div class="line"><a name="l03122"></a><span class="lineno"> 3122</span>&#160;            <span class="stringliteral">&quot;total_commands_processed:%lld\r\n&quot;</span></div><div class="line"><a name="l03123"></a><span class="lineno"> 3123</span>&#160;            <span class="stringliteral">&quot;instantaneous_ops_per_sec:%lld\r\n&quot;</span></div><div class="line"><a name="l03124"></a><span class="lineno"> 3124</span>&#160;            <span class="stringliteral">&quot;total_net_input_bytes:%lld\r\n&quot;</span></div><div class="line"><a name="l03125"></a><span class="lineno"> 3125</span>&#160;            <span class="stringliteral">&quot;total_net_output_bytes:%lld\r\n&quot;</span></div><div class="line"><a name="l03126"></a><span class="lineno"> 3126</span>&#160;            <span class="stringliteral">&quot;instantaneous_input_kbps:%.2f\r\n&quot;</span></div><div class="line"><a name="l03127"></a><span class="lineno"> 3127</span>&#160;            <span class="stringliteral">&quot;instantaneous_output_kbps:%.2f\r\n&quot;</span></div><div class="line"><a name="l03128"></a><span class="lineno"> 3128</span>&#160;            <span class="stringliteral">&quot;rejected_connections:%lld\r\n&quot;</span></div><div class="line"><a name="l03129"></a><span class="lineno"> 3129</span>&#160;            <span class="stringliteral">&quot;sync_full:%lld\r\n&quot;</span></div><div class="line"><a name="l03130"></a><span class="lineno"> 3130</span>&#160;            <span class="stringliteral">&quot;sync_partial_ok:%lld\r\n&quot;</span></div><div class="line"><a name="l03131"></a><span class="lineno"> 3131</span>&#160;            <span class="stringliteral">&quot;sync_partial_err:%lld\r\n&quot;</span></div><div class="line"><a name="l03132"></a><span class="lineno"> 3132</span>&#160;            <span class="stringliteral">&quot;expired_keys:%lld\r\n&quot;</span></div><div class="line"><a name="l03133"></a><span class="lineno"> 3133</span>&#160;            <span class="stringliteral">&quot;evicted_keys:%lld\r\n&quot;</span></div><div class="line"><a name="l03134"></a><span class="lineno"> 3134</span>&#160;            <span class="stringliteral">&quot;keyspace_hits:%lld\r\n&quot;</span></div><div class="line"><a name="l03135"></a><span class="lineno"> 3135</span>&#160;            <span class="stringliteral">&quot;keyspace_misses:%lld\r\n&quot;</span></div><div class="line"><a name="l03136"></a><span class="lineno"> 3136</span>&#160;            <span class="stringliteral">&quot;pubsub_channels:%ld\r\n&quot;</span></div><div class="line"><a name="l03137"></a><span class="lineno"> 3137</span>&#160;            <span class="stringliteral">&quot;pubsub_patterns:%lu\r\n&quot;</span></div><div class="line"><a name="l03138"></a><span class="lineno"> 3138</span>&#160;            <span class="stringliteral">&quot;latest_fork_usec:%lld\r\n&quot;</span></div><div class="line"><a name="l03139"></a><span class="lineno"> 3139</span>&#160;            <span class="stringliteral">&quot;migrate_cached_sockets:%ld\r\n&quot;</span></div><div class="line"><a name="l03140"></a><span class="lineno"> 3140</span>&#160;            <span class="stringliteral">&quot;slave_expires_tracked_keys:%zu\r\n&quot;</span></div><div class="line"><a name="l03141"></a><span class="lineno"> 3141</span>&#160;            <span class="stringliteral">&quot;active_defrag_hits:%lld\r\n&quot;</span></div><div class="line"><a name="l03142"></a><span class="lineno"> 3142</span>&#160;            <span class="stringliteral">&quot;active_defrag_misses:%lld\r\n&quot;</span></div><div class="line"><a name="l03143"></a><span class="lineno"> 3143</span>&#160;            <span class="stringliteral">&quot;active_defrag_key_hits:%lld\r\n&quot;</span></div><div class="line"><a name="l03144"></a><span class="lineno"> 3144</span>&#160;            <span class="stringliteral">&quot;active_defrag_key_misses:%lld\r\n&quot;</span>,</div><div class="line"><a name="l03145"></a><span class="lineno"> 3145</span>&#160;            server.stat_numconnections,</div><div class="line"><a name="l03146"></a><span class="lineno"> 3146</span>&#160;            server.stat_numcommands,</div><div class="line"><a name="l03147"></a><span class="lineno"> 3147</span>&#160;            getInstantaneousMetric(<a class="code" href="server_8h.html#ac8d50898802f96b76479bc975e1bbbf3">STATS_METRIC_COMMAND</a>),</div><div class="line"><a name="l03148"></a><span class="lineno"> 3148</span>&#160;            server.stat_net_input_bytes,</div><div class="line"><a name="l03149"></a><span class="lineno"> 3149</span>&#160;            server.stat_net_output_bytes,</div><div class="line"><a name="l03150"></a><span class="lineno"> 3150</span>&#160;            (<span class="keywordtype">float</span>)getInstantaneousMetric(<a class="code" href="server_8h.html#a6d217560ae714ab8d0cc21832b210e0b">STATS_METRIC_NET_INPUT</a>)/1024,</div><div class="line"><a name="l03151"></a><span class="lineno"> 3151</span>&#160;            (<span class="keywordtype">float</span>)getInstantaneousMetric(<a class="code" href="server_8h.html#a3885f356f3a4cef22eb96fbfcc406333">STATS_METRIC_NET_OUTPUT</a>)/1024,</div><div class="line"><a name="l03152"></a><span class="lineno"> 3152</span>&#160;            server.stat_rejected_conn,</div><div class="line"><a name="l03153"></a><span class="lineno"> 3153</span>&#160;            server.stat_sync_full,</div><div class="line"><a name="l03154"></a><span class="lineno"> 3154</span>&#160;            server.stat_sync_partial_ok,</div><div class="line"><a name="l03155"></a><span class="lineno"> 3155</span>&#160;            server.stat_sync_partial_err,</div><div class="line"><a name="l03156"></a><span class="lineno"> 3156</span>&#160;            server.stat_expiredkeys,</div><div class="line"><a name="l03157"></a><span class="lineno"> 3157</span>&#160;            server.stat_evictedkeys,</div><div class="line"><a name="l03158"></a><span class="lineno"> 3158</span>&#160;            server.stat_keyspace_hits,</div><div class="line"><a name="l03159"></a><span class="lineno"> 3159</span>&#160;            server.stat_keyspace_misses,</div><div class="line"><a name="l03160"></a><span class="lineno"> 3160</span>&#160;            <a class="code" href="dict_8h.html#af193430dd3d5579a52b194512f72c1f0">dictSize</a>(server.pubsub_channels),</div><div class="line"><a name="l03161"></a><span class="lineno"> 3161</span>&#160;            <a class="code" href="adlist_8h.html#afde0ab079f934670e82119b43120e94b">listLength</a>(server.pubsub_patterns),</div><div class="line"><a name="l03162"></a><span class="lineno"> 3162</span>&#160;            server.stat_fork_time,</div><div class="line"><a name="l03163"></a><span class="lineno"> 3163</span>&#160;            <a class="code" href="dict_8h.html#af193430dd3d5579a52b194512f72c1f0">dictSize</a>(server.migrate_cached_sockets),</div><div class="line"><a name="l03164"></a><span class="lineno"> 3164</span>&#160;            getSlaveKeyWithExpireCount(),</div><div class="line"><a name="l03165"></a><span class="lineno"> 3165</span>&#160;            server.stat_active_defrag_hits,</div><div class="line"><a name="l03166"></a><span class="lineno"> 3166</span>&#160;            server.stat_active_defrag_misses,</div><div class="line"><a name="l03167"></a><span class="lineno"> 3167</span>&#160;            server.stat_active_defrag_key_hits,</div><div class="line"><a name="l03168"></a><span class="lineno"> 3168</span>&#160;            server.stat_active_defrag_key_misses);</div><div class="line"><a name="l03169"></a><span class="lineno"> 3169</span>&#160;    }</div><div class="line"><a name="l03170"></a><span class="lineno"> 3170</span>&#160;</div><div class="line"><a name="l03171"></a><span class="lineno"> 3171</span>&#160;    <span class="comment">/* Replication */</span></div><div class="line"><a name="l03172"></a><span class="lineno"> 3172</span>&#160;    <span class="keywordflow">if</span> (allsections || defsections || !strcasecmp(section,<span class="stringliteral">&quot;replication&quot;</span>)) {</div><div class="line"><a name="l03173"></a><span class="lineno"> 3173</span>&#160;        <span class="keywordflow">if</span> (sections++) info = sdscat(info,<span class="stringliteral">&quot;\r\n&quot;</span>);</div><div class="line"><a name="l03174"></a><span class="lineno"> 3174</span>&#160;        info = sdscatprintf(info,</div><div class="line"><a name="l03175"></a><span class="lineno"> 3175</span>&#160;            <span class="stringliteral">&quot;# Replication\r\n&quot;</span></div><div class="line"><a name="l03176"></a><span class="lineno"> 3176</span>&#160;            <span class="stringliteral">&quot;role:%s\r\n&quot;</span>,</div><div class="line"><a name="l03177"></a><span class="lineno"> 3177</span>&#160;            server.masterhost == NULL ? <span class="stringliteral">&quot;master&quot;</span> : <span class="stringliteral">&quot;slave&quot;</span>);</div><div class="line"><a name="l03178"></a><span class="lineno"> 3178</span>&#160;        <span class="keywordflow">if</span> (server.masterhost) {</div><div class="line"><a name="l03179"></a><span class="lineno"> 3179</span>&#160;            <span class="keywordtype">long</span> <span class="keywordtype">long</span> slave_repl_offset = 1;</div><div class="line"><a name="l03180"></a><span class="lineno"> 3180</span>&#160;</div><div class="line"><a name="l03181"></a><span class="lineno"> 3181</span>&#160;            <span class="keywordflow">if</span> (server.master)</div><div class="line"><a name="l03182"></a><span class="lineno"> 3182</span>&#160;                slave_repl_offset = server.master-&gt;reploff;</div><div class="line"><a name="l03183"></a><span class="lineno"> 3183</span>&#160;            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (server.cached_master)</div><div class="line"><a name="l03184"></a><span class="lineno"> 3184</span>&#160;                slave_repl_offset = server.cached_master-&gt;reploff;</div><div class="line"><a name="l03185"></a><span class="lineno"> 3185</span>&#160;</div><div class="line"><a name="l03186"></a><span class="lineno"> 3186</span>&#160;            info = sdscatprintf(info,</div><div class="line"><a name="l03187"></a><span class="lineno"> 3187</span>&#160;                <span class="stringliteral">&quot;master_host:%s\r\n&quot;</span></div><div class="line"><a name="l03188"></a><span class="lineno"> 3188</span>&#160;                <span class="stringliteral">&quot;master_port:%d\r\n&quot;</span></div><div class="line"><a name="l03189"></a><span class="lineno"> 3189</span>&#160;                <span class="stringliteral">&quot;master_link_status:%s\r\n&quot;</span></div><div class="line"><a name="l03190"></a><span class="lineno"> 3190</span>&#160;                <span class="stringliteral">&quot;master_last_io_seconds_ago:%d\r\n&quot;</span></div><div class="line"><a name="l03191"></a><span class="lineno"> 3191</span>&#160;                <span class="stringliteral">&quot;master_sync_in_progress:%d\r\n&quot;</span></div><div class="line"><a name="l03192"></a><span class="lineno"> 3192</span>&#160;                <span class="stringliteral">&quot;slave_repl_offset:%lld\r\n&quot;</span></div><div class="line"><a name="l03193"></a><span class="lineno"> 3193</span>&#160;                ,server.masterhost,</div><div class="line"><a name="l03194"></a><span class="lineno"> 3194</span>&#160;                server.masterport,</div><div class="line"><a name="l03195"></a><span class="lineno"> 3195</span>&#160;                (server.repl_state == <a class="code" href="server_8h.html#aed693b3a9cdfc05cf5ab7551a8c86fbe">REPL_STATE_CONNECTED</a>) ?</div><div class="line"><a name="l03196"></a><span class="lineno"> 3196</span>&#160;                    <span class="stringliteral">&quot;up&quot;</span> : <span class="stringliteral">&quot;down&quot;</span>,</div><div class="line"><a name="l03197"></a><span class="lineno"> 3197</span>&#160;                server.master ?</div><div class="line"><a name="l03198"></a><span class="lineno"> 3198</span>&#160;                ((<span class="keywordtype">int</span>)(server.unixtime-server.master-&gt;lastinteraction)) : -1,</div><div class="line"><a name="l03199"></a><span class="lineno"> 3199</span>&#160;                server.repl_state == <a class="code" href="server_8h.html#a1d27594a2d9c8d24e4ed5a2e88d1113e">REPL_STATE_TRANSFER</a>,</div><div class="line"><a name="l03200"></a><span class="lineno"> 3200</span>&#160;                slave_repl_offset</div><div class="line"><a name="l03201"></a><span class="lineno"> 3201</span>&#160;            );</div><div class="line"><a name="l03202"></a><span class="lineno"> 3202</span>&#160;</div><div class="line"><a name="l03203"></a><span class="lineno"> 3203</span>&#160;            <span class="keywordflow">if</span> (server.repl_state == <a class="code" href="server_8h.html#a1d27594a2d9c8d24e4ed5a2e88d1113e">REPL_STATE_TRANSFER</a>) {</div><div class="line"><a name="l03204"></a><span class="lineno"> 3204</span>&#160;                info = sdscatprintf(info,</div><div class="line"><a name="l03205"></a><span class="lineno"> 3205</span>&#160;                    <span class="stringliteral">&quot;master_sync_left_bytes:%lld\r\n&quot;</span></div><div class="line"><a name="l03206"></a><span class="lineno"> 3206</span>&#160;                    <span class="stringliteral">&quot;master_sync_last_io_seconds_ago:%d\r\n&quot;</span></div><div class="line"><a name="l03207"></a><span class="lineno"> 3207</span>&#160;                    , (<span class="keywordtype">long</span> <span class="keywordtype">long</span>)</div><div class="line"><a name="l03208"></a><span class="lineno"> 3208</span>&#160;                        (server.repl_transfer_size - server.repl_transfer_read),</div><div class="line"><a name="l03209"></a><span class="lineno"> 3209</span>&#160;                    (<span class="keywordtype">int</span>)(server.unixtime-server.repl_transfer_lastio)</div><div class="line"><a name="l03210"></a><span class="lineno"> 3210</span>&#160;                );</div><div class="line"><a name="l03211"></a><span class="lineno"> 3211</span>&#160;            }</div><div class="line"><a name="l03212"></a><span class="lineno"> 3212</span>&#160;</div><div class="line"><a name="l03213"></a><span class="lineno"> 3213</span>&#160;            <span class="keywordflow">if</span> (server.repl_state != <a class="code" href="server_8h.html#aed693b3a9cdfc05cf5ab7551a8c86fbe">REPL_STATE_CONNECTED</a>) {</div><div class="line"><a name="l03214"></a><span class="lineno"> 3214</span>&#160;                info = sdscatprintf(info,</div><div class="line"><a name="l03215"></a><span class="lineno"> 3215</span>&#160;                    <span class="stringliteral">&quot;master_link_down_since_seconds:%jd\r\n&quot;</span>,</div><div class="line"><a name="l03216"></a><span class="lineno"> 3216</span>&#160;                    (intmax_t)server.unixtime-server.repl_down_since);</div><div class="line"><a name="l03217"></a><span class="lineno"> 3217</span>&#160;            }</div><div class="line"><a name="l03218"></a><span class="lineno"> 3218</span>&#160;            info = sdscatprintf(info,</div><div class="line"><a name="l03219"></a><span class="lineno"> 3219</span>&#160;                <span class="stringliteral">&quot;slave_priority:%d\r\n&quot;</span></div><div class="line"><a name="l03220"></a><span class="lineno"> 3220</span>&#160;                <span class="stringliteral">&quot;slave_read_only:%d\r\n&quot;</span>,</div><div class="line"><a name="l03221"></a><span class="lineno"> 3221</span>&#160;                server.slave_priority,</div><div class="line"><a name="l03222"></a><span class="lineno"> 3222</span>&#160;                server.repl_slave_ro);</div><div class="line"><a name="l03223"></a><span class="lineno"> 3223</span>&#160;        }</div><div class="line"><a name="l03224"></a><span class="lineno"> 3224</span>&#160;</div><div class="line"><a name="l03225"></a><span class="lineno"> 3225</span>&#160;        info = sdscatprintf(info,</div><div class="line"><a name="l03226"></a><span class="lineno"> 3226</span>&#160;            <span class="stringliteral">&quot;connected_slaves:%lu\r\n&quot;</span>,</div><div class="line"><a name="l03227"></a><span class="lineno"> 3227</span>&#160;            <a class="code" href="adlist_8h.html#afde0ab079f934670e82119b43120e94b">listLength</a>(server.slaves));</div><div class="line"><a name="l03228"></a><span class="lineno"> 3228</span>&#160;</div><div class="line"><a name="l03229"></a><span class="lineno"> 3229</span>&#160;        <span class="comment">/* If min-slaves-to-write is active, write the number of slaves</span></div><div class="line"><a name="l03230"></a><span class="lineno"> 3230</span>&#160;<span class="comment">         * currently considered &#39;good&#39;. */</span></div><div class="line"><a name="l03231"></a><span class="lineno"> 3231</span>&#160;        <span class="keywordflow">if</span> (server.repl_min_slaves_to_write &amp;&amp;</div><div class="line"><a name="l03232"></a><span class="lineno"> 3232</span>&#160;            server.repl_min_slaves_max_lag) {</div><div class="line"><a name="l03233"></a><span class="lineno"> 3233</span>&#160;            info = sdscatprintf(info,</div><div class="line"><a name="l03234"></a><span class="lineno"> 3234</span>&#160;                <span class="stringliteral">&quot;min_slaves_good_slaves:%d\r\n&quot;</span>,</div><div class="line"><a name="l03235"></a><span class="lineno"> 3235</span>&#160;                server.repl_good_slaves_count);</div><div class="line"><a name="l03236"></a><span class="lineno"> 3236</span>&#160;        }</div><div class="line"><a name="l03237"></a><span class="lineno"> 3237</span>&#160;</div><div class="line"><a name="l03238"></a><span class="lineno"> 3238</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="adlist_8h.html#afde0ab079f934670e82119b43120e94b">listLength</a>(server.slaves)) {</div><div class="line"><a name="l03239"></a><span class="lineno"> 3239</span>&#160;            <span class="keywordtype">int</span> slaveid = 0;</div><div class="line"><a name="l03240"></a><span class="lineno"> 3240</span>&#160;            listNode *ln;</div><div class="line"><a name="l03241"></a><span class="lineno"> 3241</span>&#160;            listIter li;</div><div class="line"><a name="l03242"></a><span class="lineno"> 3242</span>&#160;</div><div class="line"><a name="l03243"></a><span class="lineno"> 3243</span>&#160;            listRewind(server.slaves,&amp;li);</div><div class="line"><a name="l03244"></a><span class="lineno"> 3244</span>&#160;            <span class="keywordflow">while</span>((ln = listNext(&amp;li))) {</div><div class="line"><a name="l03245"></a><span class="lineno"> 3245</span>&#160;                <a class="code" href="structclient.html">client</a> *slave = <a class="code" href="adlist_8h.html#af84cae230e7180ebcda1e2736fce9f65">listNodeValue</a>(ln);</div><div class="line"><a name="l03246"></a><span class="lineno"> 3246</span>&#160;                <span class="keywordtype">char</span> *state = NULL;</div><div class="line"><a name="l03247"></a><span class="lineno"> 3247</span>&#160;                <span class="keywordtype">char</span> ip[<a class="code" href="server_8h.html#ad97c5405ed22a94e9fcc10fba577d6c0">NET_IP_STR_LEN</a>], *slaveip = slave-&gt;slave_ip;</div><div class="line"><a name="l03248"></a><span class="lineno"> 3248</span>&#160;                <span class="keywordtype">int</span> port;</div><div class="line"><a name="l03249"></a><span class="lineno"> 3249</span>&#160;                <span class="keywordtype">long</span> lag = 0;</div><div class="line"><a name="l03250"></a><span class="lineno"> 3250</span>&#160;</div><div class="line"><a name="l03251"></a><span class="lineno"> 3251</span>&#160;                <span class="keywordflow">if</span> (slaveip[0] == <span class="stringliteral">&#39;\0&#39;</span>) {</div><div class="line"><a name="l03252"></a><span class="lineno"> 3252</span>&#160;                    <span class="keywordflow">if</span> (anetPeerToString(slave-&gt;fd,ip,<span class="keyword">sizeof</span>(ip),&amp;port) == -1)</div><div class="line"><a name="l03253"></a><span class="lineno"> 3253</span>&#160;                        <span class="keywordflow">continue</span>;</div><div class="line"><a name="l03254"></a><span class="lineno"> 3254</span>&#160;                    slaveip = ip;</div><div class="line"><a name="l03255"></a><span class="lineno"> 3255</span>&#160;                }</div><div class="line"><a name="l03256"></a><span class="lineno"> 3256</span>&#160;                <span class="keywordflow">switch</span>(slave-&gt;replstate) {</div><div class="line"><a name="l03257"></a><span class="lineno"> 3257</span>&#160;                <span class="keywordflow">case</span> <a class="code" href="server_8h.html#a170ee2dd8cfefaf0d112edcc3152f8d7">SLAVE_STATE_WAIT_BGSAVE_START</a>:</div><div class="line"><a name="l03258"></a><span class="lineno"> 3258</span>&#160;                <span class="keywordflow">case</span> <a class="code" href="server_8h.html#a2a1b586e8f326f831f6ab466c8c3f38a">SLAVE_STATE_WAIT_BGSAVE_END</a>:</div><div class="line"><a name="l03259"></a><span class="lineno"> 3259</span>&#160;                    state = <span class="stringliteral">&quot;wait_bgsave&quot;</span>;</div><div class="line"><a name="l03260"></a><span class="lineno"> 3260</span>&#160;                    <span class="keywordflow">break</span>;</div><div class="line"><a name="l03261"></a><span class="lineno"> 3261</span>&#160;                <span class="keywordflow">case</span> <a class="code" href="server_8h.html#ada38427ad2d0c09875081868a53cc51f">SLAVE_STATE_SEND_BULK</a>:</div><div class="line"><a name="l03262"></a><span class="lineno"> 3262</span>&#160;                    state = <span class="stringliteral">&quot;send_bulk&quot;</span>;</div><div class="line"><a name="l03263"></a><span class="lineno"> 3263</span>&#160;                    <span class="keywordflow">break</span>;</div><div class="line"><a name="l03264"></a><span class="lineno"> 3264</span>&#160;                <span class="keywordflow">case</span> <a class="code" href="server_8h.html#ad895fdf16e5ed5275d19ddf8578b900f">SLAVE_STATE_ONLINE</a>:</div><div class="line"><a name="l03265"></a><span class="lineno"> 3265</span>&#160;                    state = <span class="stringliteral">&quot;online&quot;</span>;</div><div class="line"><a name="l03266"></a><span class="lineno"> 3266</span>&#160;                    <span class="keywordflow">break</span>;</div><div class="line"><a name="l03267"></a><span class="lineno"> 3267</span>&#160;                }</div><div class="line"><a name="l03268"></a><span class="lineno"> 3268</span>&#160;                <span class="keywordflow">if</span> (state == NULL) <span class="keywordflow">continue</span>;</div><div class="line"><a name="l03269"></a><span class="lineno"> 3269</span>&#160;                <span class="keywordflow">if</span> (slave-&gt;replstate == <a class="code" href="server_8h.html#ad895fdf16e5ed5275d19ddf8578b900f">SLAVE_STATE_ONLINE</a>)</div><div class="line"><a name="l03270"></a><span class="lineno"> 3270</span>&#160;                    lag = time(NULL) - slave-&gt;repl_ack_time;</div><div class="line"><a name="l03271"></a><span class="lineno"> 3271</span>&#160;</div><div class="line"><a name="l03272"></a><span class="lineno"> 3272</span>&#160;                info = sdscatprintf(info,</div><div class="line"><a name="l03273"></a><span class="lineno"> 3273</span>&#160;                    <span class="stringliteral">&quot;slave%d:ip=%s,port=%d,state=%s,&quot;</span></div><div class="line"><a name="l03274"></a><span class="lineno"> 3274</span>&#160;                    <span class="stringliteral">&quot;offset=%lld,lag=%ld\r\n&quot;</span>,</div><div class="line"><a name="l03275"></a><span class="lineno"> 3275</span>&#160;                    slaveid,slaveip,slave-&gt;slave_listening_port,state,</div><div class="line"><a name="l03276"></a><span class="lineno"> 3276</span>&#160;                    slave-&gt;repl_ack_off, lag);</div><div class="line"><a name="l03277"></a><span class="lineno"> 3277</span>&#160;                slaveid++;</div><div class="line"><a name="l03278"></a><span class="lineno"> 3278</span>&#160;            }</div><div class="line"><a name="l03279"></a><span class="lineno"> 3279</span>&#160;        }</div><div class="line"><a name="l03280"></a><span class="lineno"> 3280</span>&#160;        info = sdscatprintf(info,</div><div class="line"><a name="l03281"></a><span class="lineno"> 3281</span>&#160;            <span class="stringliteral">&quot;master_replid:%s\r\n&quot;</span></div><div class="line"><a name="l03282"></a><span class="lineno"> 3282</span>&#160;            <span class="stringliteral">&quot;master_replid2:%s\r\n&quot;</span></div><div class="line"><a name="l03283"></a><span class="lineno"> 3283</span>&#160;            <span class="stringliteral">&quot;master_repl_offset:%lld\r\n&quot;</span></div><div class="line"><a name="l03284"></a><span class="lineno"> 3284</span>&#160;            <span class="stringliteral">&quot;second_repl_offset:%lld\r\n&quot;</span></div><div class="line"><a name="l03285"></a><span class="lineno"> 3285</span>&#160;            <span class="stringliteral">&quot;repl_backlog_active:%d\r\n&quot;</span></div><div class="line"><a name="l03286"></a><span class="lineno"> 3286</span>&#160;            <span class="stringliteral">&quot;repl_backlog_size:%lld\r\n&quot;</span></div><div class="line"><a name="l03287"></a><span class="lineno"> 3287</span>&#160;            <span class="stringliteral">&quot;repl_backlog_first_byte_offset:%lld\r\n&quot;</span></div><div class="line"><a name="l03288"></a><span class="lineno"> 3288</span>&#160;            <span class="stringliteral">&quot;repl_backlog_histlen:%lld\r\n&quot;</span>,</div><div class="line"><a name="l03289"></a><span class="lineno"> 3289</span>&#160;            server.replid,</div><div class="line"><a name="l03290"></a><span class="lineno"> 3290</span>&#160;            server.replid2,</div><div class="line"><a name="l03291"></a><span class="lineno"> 3291</span>&#160;            server.master_repl_offset,</div><div class="line"><a name="l03292"></a><span class="lineno"> 3292</span>&#160;            server.second_replid_offset,</div><div class="line"><a name="l03293"></a><span class="lineno"> 3293</span>&#160;            server.repl_backlog != NULL,</div><div class="line"><a name="l03294"></a><span class="lineno"> 3294</span>&#160;            server.repl_backlog_size,</div><div class="line"><a name="l03295"></a><span class="lineno"> 3295</span>&#160;            server.repl_backlog_off,</div><div class="line"><a name="l03296"></a><span class="lineno"> 3296</span>&#160;            server.repl_backlog_histlen);</div><div class="line"><a name="l03297"></a><span class="lineno"> 3297</span>&#160;    }</div><div class="line"><a name="l03298"></a><span class="lineno"> 3298</span>&#160;</div><div class="line"><a name="l03299"></a><span class="lineno"> 3299</span>&#160;    <span class="comment">/* CPU */</span></div><div class="line"><a name="l03300"></a><span class="lineno"> 3300</span>&#160;    <span class="keywordflow">if</span> (allsections || defsections || !strcasecmp(section,<span class="stringliteral">&quot;cpu&quot;</span>)) {</div><div class="line"><a name="l03301"></a><span class="lineno"> 3301</span>&#160;        <span class="keywordflow">if</span> (sections++) info = sdscat(info,<span class="stringliteral">&quot;\r\n&quot;</span>);</div><div class="line"><a name="l03302"></a><span class="lineno"> 3302</span>&#160;        info = sdscatprintf(info,</div><div class="line"><a name="l03303"></a><span class="lineno"> 3303</span>&#160;        <span class="stringliteral">&quot;# CPU\r\n&quot;</span></div><div class="line"><a name="l03304"></a><span class="lineno"> 3304</span>&#160;        <span class="stringliteral">&quot;used_cpu_sys:%.2f\r\n&quot;</span></div><div class="line"><a name="l03305"></a><span class="lineno"> 3305</span>&#160;        <span class="stringliteral">&quot;used_cpu_user:%.2f\r\n&quot;</span></div><div class="line"><a name="l03306"></a><span class="lineno"> 3306</span>&#160;        <span class="stringliteral">&quot;used_cpu_sys_children:%.2f\r\n&quot;</span></div><div class="line"><a name="l03307"></a><span class="lineno"> 3307</span>&#160;        <span class="stringliteral">&quot;used_cpu_user_children:%.2f\r\n&quot;</span>,</div><div class="line"><a name="l03308"></a><span class="lineno"> 3308</span>&#160;        (<span class="keywordtype">float</span>)self_ru.ru_stime.tv_sec+(<span class="keywordtype">float</span>)self_ru.ru_stime.tv_usec/1000000,</div><div class="line"><a name="l03309"></a><span class="lineno"> 3309</span>&#160;        (<span class="keywordtype">float</span>)self_ru.ru_utime.tv_sec+(<span class="keywordtype">float</span>)self_ru.ru_utime.tv_usec/1000000,</div><div class="line"><a name="l03310"></a><span class="lineno"> 3310</span>&#160;        (<span class="keywordtype">float</span>)c_ru.ru_stime.tv_sec+(<span class="keywordtype">float</span>)c_ru.ru_stime.tv_usec/1000000,</div><div class="line"><a name="l03311"></a><span class="lineno"> 3311</span>&#160;        (<span class="keywordtype">float</span>)c_ru.ru_utime.tv_sec+(<span class="keywordtype">float</span>)c_ru.ru_utime.tv_usec/1000000);</div><div class="line"><a name="l03312"></a><span class="lineno"> 3312</span>&#160;    }</div><div class="line"><a name="l03313"></a><span class="lineno"> 3313</span>&#160;</div><div class="line"><a name="l03314"></a><span class="lineno"> 3314</span>&#160;    <span class="comment">/* Command statistics */</span></div><div class="line"><a name="l03315"></a><span class="lineno"> 3315</span>&#160;    <span class="keywordflow">if</span> (allsections || !strcasecmp(section,<span class="stringliteral">&quot;commandstats&quot;</span>)) {</div><div class="line"><a name="l03316"></a><span class="lineno"> 3316</span>&#160;        <span class="keywordflow">if</span> (sections++) info = sdscat(info,<span class="stringliteral">&quot;\r\n&quot;</span>);</div><div class="line"><a name="l03317"></a><span class="lineno"> 3317</span>&#160;        info = sdscatprintf(info, <span class="stringliteral">&quot;# Commandstats\r\n&quot;</span>);</div><div class="line"><a name="l03318"></a><span class="lineno"> 3318</span>&#160;</div><div class="line"><a name="l03319"></a><span class="lineno"> 3319</span>&#160;        <span class="keyword">struct</span> <a class="code" href="structredisCommand.html">redisCommand</a> *c;</div><div class="line"><a name="l03320"></a><span class="lineno"> 3320</span>&#160;        dictEntry *de;</div><div class="line"><a name="l03321"></a><span class="lineno"> 3321</span>&#160;        dictIterator *di;</div><div class="line"><a name="l03322"></a><span class="lineno"> 3322</span>&#160;        di = dictGetSafeIterator(server.commands);</div><div class="line"><a name="l03323"></a><span class="lineno"> 3323</span>&#160;        <span class="keywordflow">while</span>((de = dictNext(di)) != NULL) {</div><div class="line"><a name="l03324"></a><span class="lineno"> 3324</span>&#160;            c = (<span class="keyword">struct</span> <a class="code" href="structredisCommand.html">redisCommand</a> *) <a class="code" href="dict_8h.html#ae8d2cc391873b2bea2b87c4f80f43120">dictGetVal</a>(de);</div><div class="line"><a name="l03325"></a><span class="lineno"> 3325</span>&#160;            <span class="keywordflow">if</span> (!c-&gt;calls) <span class="keywordflow">continue</span>;</div><div class="line"><a name="l03326"></a><span class="lineno"> 3326</span>&#160;            info = sdscatprintf(info,</div><div class="line"><a name="l03327"></a><span class="lineno"> 3327</span>&#160;                <span class="stringliteral">&quot;cmdstat_%s:calls=%lld,usec=%lld,usec_per_call=%.2f\r\n&quot;</span>,</div><div class="line"><a name="l03328"></a><span class="lineno"> 3328</span>&#160;                c-&gt;name, c-&gt;calls, c-&gt;microseconds,</div><div class="line"><a name="l03329"></a><span class="lineno"> 3329</span>&#160;                (c-&gt;calls == 0) ? 0 : ((<span class="keywordtype">float</span>)c-&gt;microseconds/c-&gt;calls));</div><div class="line"><a name="l03330"></a><span class="lineno"> 3330</span>&#160;        }</div><div class="line"><a name="l03331"></a><span class="lineno"> 3331</span>&#160;        dictReleaseIterator(di);</div><div class="line"><a name="l03332"></a><span class="lineno"> 3332</span>&#160;    }</div><div class="line"><a name="l03333"></a><span class="lineno"> 3333</span>&#160;</div><div class="line"><a name="l03334"></a><span class="lineno"> 3334</span>&#160;    <span class="comment">/* Cluster */</span></div><div class="line"><a name="l03335"></a><span class="lineno"> 3335</span>&#160;    <span class="keywordflow">if</span> (allsections || defsections || !strcasecmp(section,<span class="stringliteral">&quot;cluster&quot;</span>)) {</div><div class="line"><a name="l03336"></a><span class="lineno"> 3336</span>&#160;        <span class="keywordflow">if</span> (sections++) info = sdscat(info,<span class="stringliteral">&quot;\r\n&quot;</span>);</div><div class="line"><a name="l03337"></a><span class="lineno"> 3337</span>&#160;        info = sdscatprintf(info,</div><div class="line"><a name="l03338"></a><span class="lineno"> 3338</span>&#160;        <span class="stringliteral">&quot;# Cluster\r\n&quot;</span></div><div class="line"><a name="l03339"></a><span class="lineno"> 3339</span>&#160;        <span class="stringliteral">&quot;cluster_enabled:%d\r\n&quot;</span>,</div><div class="line"><a name="l03340"></a><span class="lineno"> 3340</span>&#160;        server.cluster_enabled);</div><div class="line"><a name="l03341"></a><span class="lineno"> 3341</span>&#160;    }</div><div class="line"><a name="l03342"></a><span class="lineno"> 3342</span>&#160;</div><div class="line"><a name="l03343"></a><span class="lineno"> 3343</span>&#160;    <span class="comment">/* Key space */</span></div><div class="line"><a name="l03344"></a><span class="lineno"> 3344</span>&#160;    <span class="keywordflow">if</span> (allsections || defsections || !strcasecmp(section,<span class="stringliteral">&quot;keyspace&quot;</span>)) {</div><div class="line"><a name="l03345"></a><span class="lineno"> 3345</span>&#160;        <span class="keywordflow">if</span> (sections++) info = sdscat(info,<span class="stringliteral">&quot;\r\n&quot;</span>);</div><div class="line"><a name="l03346"></a><span class="lineno"> 3346</span>&#160;        info = sdscatprintf(info, <span class="stringliteral">&quot;# Keyspace\r\n&quot;</span>);</div><div class="line"><a name="l03347"></a><span class="lineno"> 3347</span>&#160;        <span class="keywordflow">for</span> (j = 0; j &lt; server.dbnum; j++) {</div><div class="line"><a name="l03348"></a><span class="lineno"> 3348</span>&#160;            <span class="keywordtype">long</span> <span class="keywordtype">long</span> keys, vkeys;</div><div class="line"><a name="l03349"></a><span class="lineno"> 3349</span>&#160;</div><div class="line"><a name="l03350"></a><span class="lineno"> 3350</span>&#160;            keys = <a class="code" href="dict_8h.html#af193430dd3d5579a52b194512f72c1f0">dictSize</a>(server.db[j].dict);</div><div class="line"><a name="l03351"></a><span class="lineno"> 3351</span>&#160;            vkeys = <a class="code" href="dict_8h.html#af193430dd3d5579a52b194512f72c1f0">dictSize</a>(server.db[j].expires);</div><div class="line"><a name="l03352"></a><span class="lineno"> 3352</span>&#160;            <span class="keywordflow">if</span> (keys || vkeys) {</div><div class="line"><a name="l03353"></a><span class="lineno"> 3353</span>&#160;                info = sdscatprintf(info,</div><div class="line"><a name="l03354"></a><span class="lineno"> 3354</span>&#160;                    <span class="stringliteral">&quot;db%d:keys=%lld,expires=%lld,avg_ttl=%lld\r\n&quot;</span>,</div><div class="line"><a name="l03355"></a><span class="lineno"> 3355</span>&#160;                    j, keys, vkeys, server.db[j].avg_ttl);</div><div class="line"><a name="l03356"></a><span class="lineno"> 3356</span>&#160;            }</div><div class="line"><a name="l03357"></a><span class="lineno"> 3357</span>&#160;        }</div><div class="line"><a name="l03358"></a><span class="lineno"> 3358</span>&#160;    }</div><div class="line"><a name="l03359"></a><span class="lineno"> 3359</span>&#160;    <span class="keywordflow">return</span> info;</div><div class="line"><a name="l03360"></a><span class="lineno"> 3360</span>&#160;}</div><div class="line"><a name="l03361"></a><span class="lineno"> 3361</span>&#160;</div><div class="line"><a name="l03362"></a><span class="lineno"> 3362</span>&#160;<span class="keywordtype">void</span> infoCommand(<a class="code" href="structclient.html">client</a> *c) {</div><div class="line"><a name="l03363"></a><span class="lineno"> 3363</span>&#160;    <span class="keywordtype">char</span> *section = c-&gt;argc == 2 ? c-&gt;argv[1]-&gt;ptr : <span class="stringliteral">&quot;default&quot;</span>;</div><div class="line"><a name="l03364"></a><span class="lineno"> 3364</span>&#160;</div><div class="line"><a name="l03365"></a><span class="lineno"> 3365</span>&#160;    <span class="keywordflow">if</span> (c-&gt;argc &gt; 2) {</div><div class="line"><a name="l03366"></a><span class="lineno"> 3366</span>&#160;        addReply(c,shared.syntaxerr);</div><div class="line"><a name="l03367"></a><span class="lineno"> 3367</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l03368"></a><span class="lineno"> 3368</span>&#160;    }</div><div class="line"><a name="l03369"></a><span class="lineno"> 3369</span>&#160;    addReplyBulkSds(c, genRedisInfoString(section));</div><div class="line"><a name="l03370"></a><span class="lineno"> 3370</span>&#160;}</div><div class="line"><a name="l03371"></a><span class="lineno"> 3371</span>&#160;</div><div class="line"><a name="l03372"></a><span class="lineno"> 3372</span>&#160;<span class="keywordtype">void</span> monitorCommand(<a class="code" href="structclient.html">client</a> *c) {</div><div class="line"><a name="l03373"></a><span class="lineno"> 3373</span>&#160;    <span class="comment">/* ignore MONITOR if already slave or in monitor mode */</span></div><div class="line"><a name="l03374"></a><span class="lineno"> 3374</span>&#160;    <span class="keywordflow">if</span> (c-&gt;flags &amp; <a class="code" href="server_8h.html#ae9f6995948253652bc9454d79a72f4a7">CLIENT_SLAVE</a>) <span class="keywordflow">return</span>;</div><div class="line"><a name="l03375"></a><span class="lineno"> 3375</span>&#160;</div><div class="line"><a name="l03376"></a><span class="lineno"> 3376</span>&#160;    c-&gt;flags |= (<a class="code" href="server_8h.html#ae9f6995948253652bc9454d79a72f4a7">CLIENT_SLAVE</a>|<a class="code" href="server_8h.html#a7724350e4f0ddbf1c80740699fac78be">CLIENT_MONITOR</a>);</div><div class="line"><a name="l03377"></a><span class="lineno"> 3377</span>&#160;    listAddNodeTail(server.monitors,c);</div><div class="line"><a name="l03378"></a><span class="lineno"> 3378</span>&#160;    addReply(c,shared.ok);</div><div class="line"><a name="l03379"></a><span class="lineno"> 3379</span>&#160;}</div><div class="line"><a name="l03380"></a><span class="lineno"> 3380</span>&#160;</div><div class="line"><a name="l03381"></a><span class="lineno"> 3381</span>&#160;<span class="comment">/* =================================== Main! ================================ */</span></div><div class="line"><a name="l03382"></a><span class="lineno"> 3382</span>&#160;</div><div class="line"><a name="l03383"></a><span class="lineno"> 3383</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">ifdef</span> __linux__</div><div class="line"><a name="l03384"></a><span class="lineno"> 3384</span>&#160;<span class="keywordtype">int</span> linuxOvercommitMemoryValue(<span class="keywordtype">void</span>) {</div><div class="line"><a name="l03385"></a><span class="lineno"> 3385</span>&#160;    FILE *fp = fopen(<span class="stringliteral">&quot;/proc/sys/vm/overcommit_memory&quot;</span>,<span class="stringliteral">&quot;r&quot;</span>);</div><div class="line"><a name="l03386"></a><span class="lineno"> 3386</span>&#160;    <span class="keywordtype">char</span> buf[64];</div><div class="line"><a name="l03387"></a><span class="lineno"> 3387</span>&#160;</div><div class="line"><a name="l03388"></a><span class="lineno"> 3388</span>&#160;    <span class="keywordflow">if</span> (!fp) <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l03389"></a><span class="lineno"> 3389</span>&#160;    <span class="keywordflow">if</span> (fgets(buf,64,fp) == NULL) {</div><div class="line"><a name="l03390"></a><span class="lineno"> 3390</span>&#160;        fclose(fp);</div><div class="line"><a name="l03391"></a><span class="lineno"> 3391</span>&#160;        <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l03392"></a><span class="lineno"> 3392</span>&#160;    }</div><div class="line"><a name="l03393"></a><span class="lineno"> 3393</span>&#160;    fclose(fp);</div><div class="line"><a name="l03394"></a><span class="lineno"> 3394</span>&#160;</div><div class="line"><a name="l03395"></a><span class="lineno"> 3395</span>&#160;    <span class="keywordflow">return</span> atoi(buf);</div><div class="line"><a name="l03396"></a><span class="lineno"> 3396</span>&#160;}</div><div class="line"><a name="l03397"></a><span class="lineno"> 3397</span>&#160;</div><div class="line"><a name="l03398"></a><span class="lineno"> 3398</span>&#160;<span class="keywordtype">void</span> linuxMemoryWarnings(<span class="keywordtype">void</span>) {</div><div class="line"><a name="l03399"></a><span class="lineno"> 3399</span>&#160;    <span class="keywordflow">if</span> (linuxOvercommitMemoryValue() == 0) {</div><div class="line"><a name="l03400"></a><span class="lineno"> 3400</span>&#160;        serverLog(<a class="code" href="server_8h.html#a31229b9334bba7d6be2a72970967a14b">LL_WARNING</a>,<span class="stringliteral">&quot;WARNING overcommit_memory is set to 0! Background save may fail under low memory condition. To fix this issue add &#39;vm.overcommit_memory = 1&#39; to /etc/sysctl.conf and then reboot or run the command &#39;sysctl vm.overcommit_memory=1&#39; for this to take effect.&quot;</span>);</div><div class="line"><a name="l03401"></a><span class="lineno"> 3401</span>&#160;    }</div><div class="line"><a name="l03402"></a><span class="lineno"> 3402</span>&#160;    <span class="keywordflow">if</span> (THPIsEnabled()) {</div><div class="line"><a name="l03403"></a><span class="lineno"> 3403</span>&#160;        serverLog(<a class="code" href="server_8h.html#a31229b9334bba7d6be2a72970967a14b">LL_WARNING</a>,<span class="stringliteral">&quot;WARNING you have Transparent Huge Pages (THP) support enabled in your kernel. This will create latency and memory usage issues with Redis. To fix this issue run the command &#39;echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled&#39; as root, and add it to your /etc/rc.local in order to retain the setting after a reboot. Redis must be restarted after THP is disabled.&quot;</span>);</div><div class="line"><a name="l03404"></a><span class="lineno"> 3404</span>&#160;    }</div><div class="line"><a name="l03405"></a><span class="lineno"> 3405</span>&#160;}</div><div class="line"><a name="l03406"></a><span class="lineno"> 3406</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">endif</span> <span class="comment">/* __linux__ */</span></div><div class="line"><a name="l03407"></a><span class="lineno"> 3407</span>&#160;</div><div class="line"><a name="l03408"></a><span class="lineno"> 3408</span>&#160;<span class="keywordtype">void</span> createPidFile(<span class="keywordtype">void</span>) {</div><div class="line"><a name="l03409"></a><span class="lineno"> 3409</span>&#160;    <span class="comment">/* If pidfile requested, but no pidfile defined, use</span></div><div class="line"><a name="l03410"></a><span class="lineno"> 3410</span>&#160;<span class="comment">     * default pidfile path */</span></div><div class="line"><a name="l03411"></a><span class="lineno"> 3411</span>&#160;    <span class="keywordflow">if</span> (!server.pidfile) server.pidfile = zstrdup(<a class="code" href="server_8h.html#ad0a549a4ce81a4436199706f3513bbc2">CONFIG_DEFAULT_PID_FILE</a>);</div><div class="line"><a name="l03412"></a><span class="lineno"> 3412</span>&#160;</div><div class="line"><a name="l03413"></a><span class="lineno"> 3413</span>&#160;    <span class="comment">/* Try to write the pid file in a best-effort way. */</span></div><div class="line"><a name="l03414"></a><span class="lineno"> 3414</span>&#160;    FILE *fp = fopen(server.pidfile,<span class="stringliteral">&quot;w&quot;</span>);</div><div class="line"><a name="l03415"></a><span class="lineno"> 3415</span>&#160;    <span class="keywordflow">if</span> (fp) {</div><div class="line"><a name="l03416"></a><span class="lineno"> 3416</span>&#160;        fprintf(fp,<span class="stringliteral">&quot;%d\n&quot;</span>,(<span class="keywordtype">int</span>)getpid());</div><div class="line"><a name="l03417"></a><span class="lineno"> 3417</span>&#160;        fclose(fp);</div><div class="line"><a name="l03418"></a><span class="lineno"> 3418</span>&#160;    }</div><div class="line"><a name="l03419"></a><span class="lineno"> 3419</span>&#160;}</div><div class="line"><a name="l03420"></a><span class="lineno"> 3420</span>&#160;</div><div class="line"><a name="l03421"></a><span class="lineno"> 3421</span>&#160;<span class="keywordtype">void</span> daemonize(<span class="keywordtype">void</span>) {</div><div class="line"><a name="l03422"></a><span class="lineno"> 3422</span>&#160;    <span class="keywordtype">int</span> fd;</div><div class="line"><a name="l03423"></a><span class="lineno"> 3423</span>&#160;</div><div class="line"><a name="l03424"></a><span class="lineno"> 3424</span>&#160;    <span class="keywordflow">if</span> (fork() != 0) exit(0); <span class="comment">/* parent exits */</span></div><div class="line"><a name="l03425"></a><span class="lineno"> 3425</span>&#160;    setsid(); <span class="comment">/* create a new session */</span></div><div class="line"><a name="l03426"></a><span class="lineno"> 3426</span>&#160;</div><div class="line"><a name="l03427"></a><span class="lineno"> 3427</span>&#160;    <span class="comment">/* Every output goes to /dev/null. If Redis is daemonized but</span></div><div class="line"><a name="l03428"></a><span class="lineno"> 3428</span>&#160;<span class="comment">     * the &#39;logfile&#39; is set to &#39;stdout&#39; in the configuration file</span></div><div class="line"><a name="l03429"></a><span class="lineno"> 3429</span>&#160;<span class="comment">     * it will not log at all. */</span></div><div class="line"><a name="l03430"></a><span class="lineno"> 3430</span>&#160;    <span class="keywordflow">if</span> ((fd = open(<span class="stringliteral">&quot;/dev/null&quot;</span>, O_RDWR, 0)) != -1) {</div><div class="line"><a name="l03431"></a><span class="lineno"> 3431</span>&#160;        dup2(fd, STDIN_FILENO);</div><div class="line"><a name="l03432"></a><span class="lineno"> 3432</span>&#160;        dup2(fd, STDOUT_FILENO);</div><div class="line"><a name="l03433"></a><span class="lineno"> 3433</span>&#160;        dup2(fd, STDERR_FILENO);</div><div class="line"><a name="l03434"></a><span class="lineno"> 3434</span>&#160;        <span class="keywordflow">if</span> (fd &gt; STDERR_FILENO) close(fd);</div><div class="line"><a name="l03435"></a><span class="lineno"> 3435</span>&#160;    }</div><div class="line"><a name="l03436"></a><span class="lineno"> 3436</span>&#160;}</div><div class="line"><a name="l03437"></a><span class="lineno"> 3437</span>&#160;</div><div class="line"><a name="l03438"></a><span class="lineno"> 3438</span>&#160;<span class="keywordtype">void</span> version(<span class="keywordtype">void</span>) {</div><div class="line"><a name="l03439"></a><span class="lineno"> 3439</span>&#160;    printf(<span class="stringliteral">&quot;Redis server v=%s sha=%s:%d malloc=%s bits=%d build=%llx\n&quot;</span>,</div><div class="line"><a name="l03440"></a><span class="lineno"> 3440</span>&#160;        <a class="code" href="version_8h.html#a357a0d302ef7fbb42bf2db0632b9f7fe">REDIS_VERSION</a>,</div><div class="line"><a name="l03441"></a><span class="lineno"> 3441</span>&#160;        redisGitSHA1(),</div><div class="line"><a name="l03442"></a><span class="lineno"> 3442</span>&#160;        atoi(redisGitDirty()) &gt; 0,</div><div class="line"><a name="l03443"></a><span class="lineno"> 3443</span>&#160;        <a class="code" href="zmalloc_8h.html#a374c6d7cf6c9817e1243093e03df7319">ZMALLOC_LIB</a>,</div><div class="line"><a name="l03444"></a><span class="lineno"> 3444</span>&#160;        <span class="keyword">sizeof</span>(<span class="keywordtype">long</span>) == 4 ? 32 : 64,</div><div class="line"><a name="l03445"></a><span class="lineno"> 3445</span>&#160;        (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span>) redisBuildId());</div><div class="line"><a name="l03446"></a><span class="lineno"> 3446</span>&#160;    exit(0);</div><div class="line"><a name="l03447"></a><span class="lineno"> 3447</span>&#160;}</div><div class="line"><a name="l03448"></a><span class="lineno"> 3448</span>&#160;</div><div class="line"><a name="l03449"></a><span class="lineno"> 3449</span>&#160;<span class="keywordtype">void</span> usage(<span class="keywordtype">void</span>) {</div><div class="line"><a name="l03450"></a><span class="lineno"> 3450</span>&#160;    fprintf(stderr,<span class="stringliteral">&quot;Usage: ./redis-server [/path/to/redis.conf] [options]\n&quot;</span>);</div><div class="line"><a name="l03451"></a><span class="lineno"> 3451</span>&#160;    fprintf(stderr,<span class="stringliteral">&quot;       ./redis-server - (read config from stdin)\n&quot;</span>);</div><div class="line"><a name="l03452"></a><span class="lineno"> 3452</span>&#160;    fprintf(stderr,<span class="stringliteral">&quot;       ./redis-server -v or --version\n&quot;</span>);</div><div class="line"><a name="l03453"></a><span class="lineno"> 3453</span>&#160;    fprintf(stderr,<span class="stringliteral">&quot;       ./redis-server -h or --help\n&quot;</span>);</div><div class="line"><a name="l03454"></a><span class="lineno"> 3454</span>&#160;    fprintf(stderr,<span class="stringliteral">&quot;       ./redis-server --test-memory &lt;megabytes&gt;\n\n&quot;</span>);</div><div class="line"><a name="l03455"></a><span class="lineno"> 3455</span>&#160;    fprintf(stderr,<span class="stringliteral">&quot;Examples:\n&quot;</span>);</div><div class="line"><a name="l03456"></a><span class="lineno"> 3456</span>&#160;    fprintf(stderr,<span class="stringliteral">&quot;       ./redis-server (run the server with default conf)\n&quot;</span>);</div><div class="line"><a name="l03457"></a><span class="lineno"> 3457</span>&#160;    fprintf(stderr,<span class="stringliteral">&quot;       ./redis-server /etc/redis/6379.conf\n&quot;</span>);</div><div class="line"><a name="l03458"></a><span class="lineno"> 3458</span>&#160;    fprintf(stderr,<span class="stringliteral">&quot;       ./redis-server --port 7777\n&quot;</span>);</div><div class="line"><a name="l03459"></a><span class="lineno"> 3459</span>&#160;    fprintf(stderr,<span class="stringliteral">&quot;       ./redis-server --port 7777 --slaveof 127.0.0.1 8888\n&quot;</span>);</div><div class="line"><a name="l03460"></a><span class="lineno"> 3460</span>&#160;    fprintf(stderr,<span class="stringliteral">&quot;       ./redis-server /etc/myredis.conf --loglevel verbose\n\n&quot;</span>);</div><div class="line"><a name="l03461"></a><span class="lineno"> 3461</span>&#160;    fprintf(stderr,<span class="stringliteral">&quot;Sentinel mode:\n&quot;</span>);</div><div class="line"><a name="l03462"></a><span class="lineno"> 3462</span>&#160;    fprintf(stderr,<span class="stringliteral">&quot;       ./redis-server /etc/sentinel.conf --sentinel\n&quot;</span>);</div><div class="line"><a name="l03463"></a><span class="lineno"> 3463</span>&#160;    exit(1);</div><div class="line"><a name="l03464"></a><span class="lineno"> 3464</span>&#160;}</div><div class="line"><a name="l03465"></a><span class="lineno"> 3465</span>&#160;</div><div class="line"><a name="l03466"></a><span class="lineno"> 3466</span>&#160;<span class="keywordtype">void</span> redisAsciiArt(<span class="keywordtype">void</span>) {</div><div class="line"><a name="l03467"></a><span class="lineno"> 3467</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">include</span> <a class="code" href="asciilogo_8h.html">&quot;asciilogo.h&quot;</a></div><div class="line"><a name="l03468"></a><span class="lineno"> 3468</span>&#160;    <span class="keywordtype">char</span> *buf = zmalloc(1024*16);</div><div class="line"><a name="l03469"></a><span class="lineno"> 3469</span>&#160;    <span class="keywordtype">char</span> *mode;</div><div class="line"><a name="l03470"></a><span class="lineno"> 3470</span>&#160;</div><div class="line"><a name="l03471"></a><span class="lineno"> 3471</span>&#160;    <span class="keywordflow">if</span> (server.cluster_enabled) mode = <span class="stringliteral">&quot;cluster&quot;</span>;</div><div class="line"><a name="l03472"></a><span class="lineno"> 3472</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (server.sentinel_mode) mode = <span class="stringliteral">&quot;sentinel&quot;</span>;</div><div class="line"><a name="l03473"></a><span class="lineno"> 3473</span>&#160;    <span class="keywordflow">else</span> mode = <span class="stringliteral">&quot;standalone&quot;</span>;</div><div class="line"><a name="l03474"></a><span class="lineno"> 3474</span>&#160;</div><div class="line"><a name="l03475"></a><span class="lineno"> 3475</span>&#160;    <span class="comment">/* Show the ASCII logo if: log file is stdout AND stdout is a</span></div><div class="line"><a name="l03476"></a><span class="lineno"> 3476</span>&#160;<span class="comment">     * tty AND syslog logging is disabled. Also show logo if the user</span></div><div class="line"><a name="l03477"></a><span class="lineno"> 3477</span>&#160;<span class="comment">     * forced us to do so via redis.conf. */</span></div><div class="line"><a name="l03478"></a><span class="lineno"> 3478</span>&#160;    <span class="keywordtype">int</span> show_logo = ((!server.syslog_enabled &amp;&amp;</div><div class="line"><a name="l03479"></a><span class="lineno"> 3479</span>&#160;                      server.logfile[0] == <span class="stringliteral">&#39;\0&#39;</span> &amp;&amp;</div><div class="line"><a name="l03480"></a><span class="lineno"> 3480</span>&#160;                      isatty(fileno(stdout))) ||</div><div class="line"><a name="l03481"></a><span class="lineno"> 3481</span>&#160;                     server.always_show_logo);</div><div class="line"><a name="l03482"></a><span class="lineno"> 3482</span>&#160;</div><div class="line"><a name="l03483"></a><span class="lineno"> 3483</span>&#160;    <span class="keywordflow">if</span> (!show_logo) {</div><div class="line"><a name="l03484"></a><span class="lineno"> 3484</span>&#160;        serverLog(<a class="code" href="server_8h.html#a8c54c191e436c7dd3012167212692401">LL_NOTICE</a>,</div><div class="line"><a name="l03485"></a><span class="lineno"> 3485</span>&#160;            <span class="stringliteral">&quot;Running mode=%s, port=%d.&quot;</span>,</div><div class="line"><a name="l03486"></a><span class="lineno"> 3486</span>&#160;            mode, server.port</div><div class="line"><a name="l03487"></a><span class="lineno"> 3487</span>&#160;        );</div><div class="line"><a name="l03488"></a><span class="lineno"> 3488</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l03489"></a><span class="lineno"> 3489</span>&#160;        snprintf(buf,1024*16,ascii_logo,</div><div class="line"><a name="l03490"></a><span class="lineno"> 3490</span>&#160;            <a class="code" href="version_8h.html#a357a0d302ef7fbb42bf2db0632b9f7fe">REDIS_VERSION</a>,</div><div class="line"><a name="l03491"></a><span class="lineno"> 3491</span>&#160;            redisGitSHA1(),</div><div class="line"><a name="l03492"></a><span class="lineno"> 3492</span>&#160;            strtol(redisGitDirty(),NULL,10) &gt; 0,</div><div class="line"><a name="l03493"></a><span class="lineno"> 3493</span>&#160;            (<span class="keyword">sizeof</span>(<span class="keywordtype">long</span>) == 8) ? <span class="stringliteral">&quot;64&quot;</span> : <span class="stringliteral">&quot;32&quot;</span>,</div><div class="line"><a name="l03494"></a><span class="lineno"> 3494</span>&#160;            mode, server.port,</div><div class="line"><a name="l03495"></a><span class="lineno"> 3495</span>&#160;            (<span class="keywordtype">long</span>) getpid()</div><div class="line"><a name="l03496"></a><span class="lineno"> 3496</span>&#160;        );</div><div class="line"><a name="l03497"></a><span class="lineno"> 3497</span>&#160;        serverLogRaw(<a class="code" href="server_8h.html#a8c54c191e436c7dd3012167212692401">LL_NOTICE</a>|<a class="code" href="server_8h.html#a6b3768a4d2dfb3ac580b8d999baa9350">LL_RAW</a>,buf);</div><div class="line"><a name="l03498"></a><span class="lineno"> 3498</span>&#160;    }</div><div class="line"><a name="l03499"></a><span class="lineno"> 3499</span>&#160;    zfree(buf);</div><div class="line"><a name="l03500"></a><span class="lineno"> 3500</span>&#160;}</div><div class="line"><a name="l03501"></a><span class="lineno"> 3501</span>&#160;</div><div class="line"><a name="l03502"></a><span class="lineno"> 3502</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> sigShutdownHandler(<span class="keywordtype">int</span> sig) {</div><div class="line"><a name="l03503"></a><span class="lineno"> 3503</span>&#160;    <span class="keywordtype">char</span> *msg;</div><div class="line"><a name="l03504"></a><span class="lineno"> 3504</span>&#160;</div><div class="line"><a name="l03505"></a><span class="lineno"> 3505</span>&#160;    <span class="keywordflow">switch</span> (sig) {</div><div class="line"><a name="l03506"></a><span class="lineno"> 3506</span>&#160;    <span class="keywordflow">case</span> SIGINT:</div><div class="line"><a name="l03507"></a><span class="lineno"> 3507</span>&#160;        msg = <span class="stringliteral">&quot;Received SIGINT scheduling shutdown...&quot;</span>;</div><div class="line"><a name="l03508"></a><span class="lineno"> 3508</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l03509"></a><span class="lineno"> 3509</span>&#160;    <span class="keywordflow">case</span> SIGTERM:</div><div class="line"><a name="l03510"></a><span class="lineno"> 3510</span>&#160;        msg = <span class="stringliteral">&quot;Received SIGTERM scheduling shutdown...&quot;</span>;</div><div class="line"><a name="l03511"></a><span class="lineno"> 3511</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l03512"></a><span class="lineno"> 3512</span>&#160;    <span class="keywordflow">default</span>:</div><div class="line"><a name="l03513"></a><span class="lineno"> 3513</span>&#160;        msg = <span class="stringliteral">&quot;Received shutdown signal, scheduling shutdown...&quot;</span>;</div><div class="line"><a name="l03514"></a><span class="lineno"> 3514</span>&#160;    };</div><div class="line"><a name="l03515"></a><span class="lineno"> 3515</span>&#160;</div><div class="line"><a name="l03516"></a><span class="lineno"> 3516</span>&#160;    <span class="comment">/* SIGINT is often delivered via Ctrl+C in an interactive session.</span></div><div class="line"><a name="l03517"></a><span class="lineno"> 3517</span>&#160;<span class="comment">     * If we receive the signal the second time, we interpret this as</span></div><div class="line"><a name="l03518"></a><span class="lineno"> 3518</span>&#160;<span class="comment">     * the user really wanting to quit ASAP without waiting to persist</span></div><div class="line"><a name="l03519"></a><span class="lineno"> 3519</span>&#160;<span class="comment">     * on disk. */</span></div><div class="line"><a name="l03520"></a><span class="lineno"> 3520</span>&#160;    <span class="keywordflow">if</span> (server.shutdown_asap &amp;&amp; sig == SIGINT) {</div><div class="line"><a name="l03521"></a><span class="lineno"> 3521</span>&#160;        serverLogFromHandler(<a class="code" href="server_8h.html#a31229b9334bba7d6be2a72970967a14b">LL_WARNING</a>, <span class="stringliteral">&quot;You insist... exiting now.&quot;</span>);</div><div class="line"><a name="l03522"></a><span class="lineno"> 3522</span>&#160;        rdbRemoveTempFile(getpid());</div><div class="line"><a name="l03523"></a><span class="lineno"> 3523</span>&#160;        exit(1); <span class="comment">/* Exit with an error since this was not a clean shutdown. */</span></div><div class="line"><a name="l03524"></a><span class="lineno"> 3524</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (server.loading) {</div><div class="line"><a name="l03525"></a><span class="lineno"> 3525</span>&#160;        exit(0);</div><div class="line"><a name="l03526"></a><span class="lineno"> 3526</span>&#160;    }</div><div class="line"><a name="l03527"></a><span class="lineno"> 3527</span>&#160;</div><div class="line"><a name="l03528"></a><span class="lineno"> 3528</span>&#160;    serverLogFromHandler(<a class="code" href="server_8h.html#a31229b9334bba7d6be2a72970967a14b">LL_WARNING</a>, msg);</div><div class="line"><a name="l03529"></a><span class="lineno"> 3529</span>&#160;    server.shutdown_asap = 1;</div><div class="line"><a name="l03530"></a><span class="lineno"> 3530</span>&#160;}</div><div class="line"><a name="l03531"></a><span class="lineno"> 3531</span>&#160;</div><div class="line"><a name="l03532"></a><span class="lineno"> 3532</span>&#160;<span class="keywordtype">void</span> setupSignalHandlers(<span class="keywordtype">void</span>) {</div><div class="line"><a name="l03533"></a><span class="lineno"> 3533</span>&#160;    <span class="keyword">struct</span> sigaction act;</div><div class="line"><a name="l03534"></a><span class="lineno"> 3534</span>&#160;</div><div class="line"><a name="l03535"></a><span class="lineno"> 3535</span>&#160;    <span class="comment">/* When the SA_SIGINFO flag is set in sa_flags then sa_sigaction is used.</span></div><div class="line"><a name="l03536"></a><span class="lineno"> 3536</span>&#160;<span class="comment">     * Otherwise, sa_handler is used. */</span></div><div class="line"><a name="l03537"></a><span class="lineno"> 3537</span>&#160;    sigemptyset(&amp;act.sa_mask);</div><div class="line"><a name="l03538"></a><span class="lineno"> 3538</span>&#160;    act.sa_flags = 0;</div><div class="line"><a name="l03539"></a><span class="lineno"> 3539</span>&#160;    act.sa_handler = sigShutdownHandler;</div><div class="line"><a name="l03540"></a><span class="lineno"> 3540</span>&#160;    sigaction(SIGTERM, &amp;act, NULL);</div><div class="line"><a name="l03541"></a><span class="lineno"> 3541</span>&#160;    sigaction(SIGINT, &amp;act, NULL);</div><div class="line"><a name="l03542"></a><span class="lineno"> 3542</span>&#160;</div><div class="line"><a name="l03543"></a><span class="lineno"> 3543</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">ifdef</span> HAVE_BACKTRACE</div><div class="line"><a name="l03544"></a><span class="lineno"> 3544</span>&#160;    sigemptyset(&amp;act.sa_mask);</div><div class="line"><a name="l03545"></a><span class="lineno"> 3545</span>&#160;    act.sa_flags = SA_NODEFER | SA_RESETHAND | SA_SIGINFO;</div><div class="line"><a name="l03546"></a><span class="lineno"> 3546</span>&#160;    act.sa_sigaction = sigsegvHandler;</div><div class="line"><a name="l03547"></a><span class="lineno"> 3547</span>&#160;    sigaction(SIGSEGV, &amp;act, NULL);</div><div class="line"><a name="l03548"></a><span class="lineno"> 3548</span>&#160;    sigaction(SIGBUS, &amp;act, NULL);</div><div class="line"><a name="l03549"></a><span class="lineno"> 3549</span>&#160;    sigaction(SIGFPE, &amp;act, NULL);</div><div class="line"><a name="l03550"></a><span class="lineno"> 3550</span>&#160;    sigaction(SIGILL, &amp;act, NULL);</div><div class="line"><a name="l03551"></a><span class="lineno"> 3551</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">endif</span></div><div class="line"><a name="l03552"></a><span class="lineno"> 3552</span>&#160;    <span class="keywordflow">return</span>;</div><div class="line"><a name="l03553"></a><span class="lineno"> 3553</span>&#160;}</div><div class="line"><a name="l03554"></a><span class="lineno"> 3554</span>&#160;</div><div class="line"><a name="l03555"></a><span class="lineno"> 3555</span>&#160;<span class="keywordtype">void</span> memtest(size_t megabytes, <span class="keywordtype">int</span> passes);</div><div class="line"><a name="l03556"></a><span class="lineno"> 3556</span>&#160;</div><div class="line"><a name="l03557"></a><span class="lineno"> 3557</span>&#160;<span class="comment">/* Returns 1 if there is --sentinel among the arguments or if</span></div><div class="line"><a name="l03558"></a><span class="lineno"> 3558</span>&#160;<span class="comment"> * argv[0] contains &quot;redis-sentinel&quot;. */</span></div><div class="line"><a name="l03559"></a><span class="lineno"> 3559</span>&#160;<span class="keywordtype">int</span> checkForSentinelMode(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv) {</div><div class="line"><a name="l03560"></a><span class="lineno"> 3560</span>&#160;    <span class="keywordtype">int</span> j;</div><div class="line"><a name="l03561"></a><span class="lineno"> 3561</span>&#160;</div><div class="line"><a name="l03562"></a><span class="lineno"> 3562</span>&#160;    <span class="keywordflow">if</span> (strstr(argv[0],<span class="stringliteral">&quot;redis-sentinel&quot;</span>) != NULL) <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l03563"></a><span class="lineno"> 3563</span>&#160;    <span class="keywordflow">for</span> (j = 1; j &lt; argc; j++)</div><div class="line"><a name="l03564"></a><span class="lineno"> 3564</span>&#160;        <span class="keywordflow">if</span> (!strcmp(argv[j],<span class="stringliteral">&quot;--sentinel&quot;</span>)) <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l03565"></a><span class="lineno"> 3565</span>&#160;    <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l03566"></a><span class="lineno"> 3566</span>&#160;}</div><div class="line"><a name="l03567"></a><span class="lineno"> 3567</span>&#160;</div><div class="line"><a name="l03568"></a><span class="lineno"> 3568</span>&#160;<span class="comment">/* Function called at startup to load RDB or AOF file in memory. */</span></div><div class="line"><a name="l03569"></a><span class="lineno"> 3569</span>&#160;<span class="keywordtype">void</span> loadDataFromDisk(<span class="keywordtype">void</span>) {</div><div class="line"><a name="l03570"></a><span class="lineno"> 3570</span>&#160;    <span class="keywordtype">long</span> <span class="keywordtype">long</span> start = ustime();</div><div class="line"><a name="l03571"></a><span class="lineno"> 3571</span>&#160;    <span class="keywordflow">if</span> (server.aof_state == <a class="code" href="server_8h.html#af6b151c9dced28e94c19479197113a83">AOF_ON</a>) {</div><div class="line"><a name="l03572"></a><span class="lineno"> 3572</span>&#160;        <span class="keywordflow">if</span> (loadAppendOnlyFile(server.aof_filename) == <a class="code" href="server_8h.html#a303769ef1065076e68731584e758d3e1">C_OK</a>)</div><div class="line"><a name="l03573"></a><span class="lineno"> 3573</span>&#160;            serverLog(<a class="code" href="server_8h.html#a8c54c191e436c7dd3012167212692401">LL_NOTICE</a>,<span class="stringliteral">&quot;DB loaded from append only file: %.3f seconds&quot;</span>,(<span class="keywordtype">float</span>)(ustime()-start)/1000000);</div><div class="line"><a name="l03574"></a><span class="lineno"> 3574</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l03575"></a><span class="lineno"> 3575</span>&#160;        rdbSaveInfo rsi = <a class="code" href="server_8h.html#a694b5ed5268bee8c50cc5b38fbec99ce">RDB_SAVE_INFO_INIT</a>;</div><div class="line"><a name="l03576"></a><span class="lineno"> 3576</span>&#160;        <span class="keywordflow">if</span> (rdbLoad(server.rdb_filename,&amp;rsi) == <a class="code" href="server_8h.html#a303769ef1065076e68731584e758d3e1">C_OK</a>) {</div><div class="line"><a name="l03577"></a><span class="lineno"> 3577</span>&#160;            serverLog(<a class="code" href="server_8h.html#a8c54c191e436c7dd3012167212692401">LL_NOTICE</a>,<span class="stringliteral">&quot;DB loaded from disk: %.3f seconds&quot;</span>,</div><div class="line"><a name="l03578"></a><span class="lineno"> 3578</span>&#160;                (<span class="keywordtype">float</span>)(ustime()-start)/1000000);</div><div class="line"><a name="l03579"></a><span class="lineno"> 3579</span>&#160;</div><div class="line"><a name="l03580"></a><span class="lineno"> 3580</span>&#160;            <span class="comment">/* Restore the replication ID / offset from the RDB file. */</span></div><div class="line"><a name="l03581"></a><span class="lineno"> 3581</span>&#160;            <span class="keywordflow">if</span> (server.masterhost &amp;&amp;</div><div class="line"><a name="l03582"></a><span class="lineno"> 3582</span>&#160;                rsi.repl_id_is_set &amp;&amp;</div><div class="line"><a name="l03583"></a><span class="lineno"> 3583</span>&#160;                rsi.repl_offset != -1 &amp;&amp;</div><div class="line"><a name="l03584"></a><span class="lineno"> 3584</span>&#160;                <span class="comment">/* Note that older implementations may save a repl_stream_db</span></div><div class="line"><a name="l03585"></a><span class="lineno"> 3585</span>&#160;<span class="comment">                 * of -1 inside the RDB file in a wrong way, see more information</span></div><div class="line"><a name="l03586"></a><span class="lineno"> 3586</span>&#160;<span class="comment">                 * in function rdbPopulateSaveInfo. */</span></div><div class="line"><a name="l03587"></a><span class="lineno"> 3587</span>&#160;                rsi.repl_stream_db != -1)</div><div class="line"><a name="l03588"></a><span class="lineno"> 3588</span>&#160;            {</div><div class="line"><a name="l03589"></a><span class="lineno"> 3589</span>&#160;                memcpy(server.replid,rsi.repl_id,<span class="keyword">sizeof</span>(server.replid));</div><div class="line"><a name="l03590"></a><span class="lineno"> 3590</span>&#160;                server.master_repl_offset = rsi.repl_offset;</div><div class="line"><a name="l03591"></a><span class="lineno"> 3591</span>&#160;                <span class="comment">/* If we are a slave, create a cached master from this</span></div><div class="line"><a name="l03592"></a><span class="lineno"> 3592</span>&#160;<span class="comment">                 * information, in order to allow partial resynchronizations</span></div><div class="line"><a name="l03593"></a><span class="lineno"> 3593</span>&#160;<span class="comment">                 * with masters. */</span></div><div class="line"><a name="l03594"></a><span class="lineno"> 3594</span>&#160;                replicationCacheMasterUsingMyself();</div><div class="line"><a name="l03595"></a><span class="lineno"> 3595</span>&#160;                selectDb(server.cached_master,rsi.repl_stream_db);</div><div class="line"><a name="l03596"></a><span class="lineno"> 3596</span>&#160;            }</div><div class="line"><a name="l03597"></a><span class="lineno"> 3597</span>&#160;        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (errno != ENOENT) {</div><div class="line"><a name="l03598"></a><span class="lineno"> 3598</span>&#160;            serverLog(<a class="code" href="server_8h.html#a31229b9334bba7d6be2a72970967a14b">LL_WARNING</a>,<span class="stringliteral">&quot;Fatal error loading the DB: %s. Exiting.&quot;</span>,strerror(errno));</div><div class="line"><a name="l03599"></a><span class="lineno"> 3599</span>&#160;            exit(1);</div><div class="line"><a name="l03600"></a><span class="lineno"> 3600</span>&#160;        }</div><div class="line"><a name="l03601"></a><span class="lineno"> 3601</span>&#160;    }</div><div class="line"><a name="l03602"></a><span class="lineno"> 3602</span>&#160;}</div><div class="line"><a name="l03603"></a><span class="lineno"> 3603</span>&#160;</div><div class="line"><a name="l03604"></a><span class="lineno"> 3604</span>&#160;<span class="keywordtype">void</span> redisOutOfMemoryHandler(size_t allocation_size) {</div><div class="line"><a name="l03605"></a><span class="lineno"> 3605</span>&#160;    serverLog(<a class="code" href="server_8h.html#a31229b9334bba7d6be2a72970967a14b">LL_WARNING</a>,<span class="stringliteral">&quot;Out Of Memory allocating %zu bytes!&quot;</span>,</div><div class="line"><a name="l03606"></a><span class="lineno"> 3606</span>&#160;        allocation_size);</div><div class="line"><a name="l03607"></a><span class="lineno"> 3607</span>&#160;    <a class="code" href="server_8h.html#a11cc378e7778a830b41240578de3b204">serverPanic</a>(<span class="stringliteral">&quot;Redis aborting for OUT OF MEMORY&quot;</span>);</div><div class="line"><a name="l03608"></a><span class="lineno"> 3608</span>&#160;}</div><div class="line"><a name="l03609"></a><span class="lineno"> 3609</span>&#160;</div><div class="line"><a name="l03610"></a><span class="lineno"> 3610</span>&#160;<span class="keywordtype">void</span> redisSetProcTitle(<span class="keywordtype">char</span> *title) {</div><div class="line"><a name="l03611"></a><span class="lineno"> 3611</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">ifdef</span> USE_SETPROCTITLE</div><div class="line"><a name="l03612"></a><span class="lineno"> 3612</span>&#160;    <span class="keywordtype">char</span> *server_mode = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l03613"></a><span class="lineno"> 3613</span>&#160;    <span class="keywordflow">if</span> (server.cluster_enabled) server_mode = <span class="stringliteral">&quot; [cluster]&quot;</span>;</div><div class="line"><a name="l03614"></a><span class="lineno"> 3614</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (server.sentinel_mode) server_mode = <span class="stringliteral">&quot; [sentinel]&quot;</span>;</div><div class="line"><a name="l03615"></a><span class="lineno"> 3615</span>&#160;</div><div class="line"><a name="l03616"></a><span class="lineno"> 3616</span>&#160;    setproctitle(<span class="stringliteral">&quot;%s %s:%d%s&quot;</span>,</div><div class="line"><a name="l03617"></a><span class="lineno"> 3617</span>&#160;        title,</div><div class="line"><a name="l03618"></a><span class="lineno"> 3618</span>&#160;        server.bindaddr_count ? server.bindaddr[0] : <span class="stringliteral">&quot;*&quot;</span>,</div><div class="line"><a name="l03619"></a><span class="lineno"> 3619</span>&#160;        server.port,</div><div class="line"><a name="l03620"></a><span class="lineno"> 3620</span>&#160;        server_mode);</div><div class="line"><a name="l03621"></a><span class="lineno"> 3621</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">else</span></div><div class="line"><a name="l03622"></a><span class="lineno"> 3622</span>&#160;    UNUSED(title);</div><div class="line"><a name="l03623"></a><span class="lineno"> 3623</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">endif</span></div><div class="line"><a name="l03624"></a><span class="lineno"> 3624</span>&#160;}</div><div class="line"><a name="l03625"></a><span class="lineno"> 3625</span>&#160;</div><div class="line"><a name="l03626"></a><span class="lineno"> 3626</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l03627"></a><span class="lineno"> 3627</span>&#160;<span class="comment"> * Check whether systemd or upstart have been used to start redis.</span></div><div class="line"><a name="l03628"></a><span class="lineno"> 3628</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l03629"></a><span class="lineno"> 3629</span>&#160;</div><div class="line"><a name="l03630"></a><span class="lineno"> 3630</span>&#160;<span class="keywordtype">int</span> redisSupervisedUpstart(<span class="keywordtype">void</span>) {</div><div class="line"><a name="l03631"></a><span class="lineno"> 3631</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">char</span> *upstart_job = getenv(<span class="stringliteral">&quot;UPSTART_JOB&quot;</span>);</div><div class="line"><a name="l03632"></a><span class="lineno"> 3632</span>&#160;</div><div class="line"><a name="l03633"></a><span class="lineno"> 3633</span>&#160;    <span class="keywordflow">if</span> (!upstart_job) {</div><div class="line"><a name="l03634"></a><span class="lineno"> 3634</span>&#160;        serverLog(<a class="code" href="server_8h.html#a31229b9334bba7d6be2a72970967a14b">LL_WARNING</a>,</div><div class="line"><a name="l03635"></a><span class="lineno"> 3635</span>&#160;                <span class="stringliteral">&quot;upstart supervision requested, but UPSTART_JOB not found&quot;</span>);</div><div class="line"><a name="l03636"></a><span class="lineno"> 3636</span>&#160;        <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l03637"></a><span class="lineno"> 3637</span>&#160;    }</div><div class="line"><a name="l03638"></a><span class="lineno"> 3638</span>&#160;</div><div class="line"><a name="l03639"></a><span class="lineno"> 3639</span>&#160;    serverLog(<a class="code" href="server_8h.html#a8c54c191e436c7dd3012167212692401">LL_NOTICE</a>, <span class="stringliteral">&quot;supervised by upstart, will stop to signal readiness&quot;</span>);</div><div class="line"><a name="l03640"></a><span class="lineno"> 3640</span>&#160;    raise(SIGSTOP);</div><div class="line"><a name="l03641"></a><span class="lineno"> 3641</span>&#160;    unsetenv(<span class="stringliteral">&quot;UPSTART_JOB&quot;</span>);</div><div class="line"><a name="l03642"></a><span class="lineno"> 3642</span>&#160;    <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l03643"></a><span class="lineno"> 3643</span>&#160;}</div><div class="line"><a name="l03644"></a><span class="lineno"> 3644</span>&#160;</div><div class="line"><a name="l03645"></a><span class="lineno"> 3645</span>&#160;<span class="keywordtype">int</span> redisSupervisedSystemd(<span class="keywordtype">void</span>) {</div><div class="line"><a name="l03646"></a><span class="lineno"> 3646</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">char</span> *notify_socket = getenv(<span class="stringliteral">&quot;NOTIFY_SOCKET&quot;</span>);</div><div class="line"><a name="l03647"></a><span class="lineno"> 3647</span>&#160;    <span class="keywordtype">int</span> fd = 1;</div><div class="line"><a name="l03648"></a><span class="lineno"> 3648</span>&#160;    <span class="keyword">struct</span> sockaddr_un su;</div><div class="line"><a name="l03649"></a><span class="lineno"> 3649</span>&#160;    <span class="keyword">struct</span> iovec iov;</div><div class="line"><a name="l03650"></a><span class="lineno"> 3650</span>&#160;    <span class="keyword">struct</span> msghdr hdr;</div><div class="line"><a name="l03651"></a><span class="lineno"> 3651</span>&#160;    <span class="keywordtype">int</span> sendto_flags = 0;</div><div class="line"><a name="l03652"></a><span class="lineno"> 3652</span>&#160;</div><div class="line"><a name="l03653"></a><span class="lineno"> 3653</span>&#160;    <span class="keywordflow">if</span> (!notify_socket) {</div><div class="line"><a name="l03654"></a><span class="lineno"> 3654</span>&#160;        serverLog(<a class="code" href="server_8h.html#a31229b9334bba7d6be2a72970967a14b">LL_WARNING</a>,</div><div class="line"><a name="l03655"></a><span class="lineno"> 3655</span>&#160;                <span class="stringliteral">&quot;systemd supervision requested, but NOTIFY_SOCKET not found&quot;</span>);</div><div class="line"><a name="l03656"></a><span class="lineno"> 3656</span>&#160;        <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l03657"></a><span class="lineno"> 3657</span>&#160;    }</div><div class="line"><a name="l03658"></a><span class="lineno"> 3658</span>&#160;</div><div class="line"><a name="l03659"></a><span class="lineno"> 3659</span>&#160;    <span class="keywordflow">if</span> ((strchr(<span class="stringliteral">&quot;@/&quot;</span>, notify_socket[0])) == NULL || strlen(notify_socket) &lt; 2) {</div><div class="line"><a name="l03660"></a><span class="lineno"> 3660</span>&#160;        <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l03661"></a><span class="lineno"> 3661</span>&#160;    }</div><div class="line"><a name="l03662"></a><span class="lineno"> 3662</span>&#160;</div><div class="line"><a name="l03663"></a><span class="lineno"> 3663</span>&#160;    serverLog(<a class="code" href="server_8h.html#a8c54c191e436c7dd3012167212692401">LL_NOTICE</a>, <span class="stringliteral">&quot;supervised by systemd, will signal readiness&quot;</span>);</div><div class="line"><a name="l03664"></a><span class="lineno"> 3664</span>&#160;    <span class="keywordflow">if</span> ((fd = socket(AF_UNIX, SOCK_DGRAM, 0)) == -1) {</div><div class="line"><a name="l03665"></a><span class="lineno"> 3665</span>&#160;        serverLog(<a class="code" href="server_8h.html#a31229b9334bba7d6be2a72970967a14b">LL_WARNING</a>,</div><div class="line"><a name="l03666"></a><span class="lineno"> 3666</span>&#160;                <span class="stringliteral">&quot;Can&#39;t connect to systemd socket %s&quot;</span>, notify_socket);</div><div class="line"><a name="l03667"></a><span class="lineno"> 3667</span>&#160;        <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l03668"></a><span class="lineno"> 3668</span>&#160;    }</div><div class="line"><a name="l03669"></a><span class="lineno"> 3669</span>&#160;</div><div class="line"><a name="l03670"></a><span class="lineno"> 3670</span>&#160;    memset(&amp;su, 0, <span class="keyword">sizeof</span>(su));</div><div class="line"><a name="l03671"></a><span class="lineno"> 3671</span>&#160;    su.sun_family = AF_UNIX;</div><div class="line"><a name="l03672"></a><span class="lineno"> 3672</span>&#160;    strncpy (su.sun_path, notify_socket, <span class="keyword">sizeof</span>(su.sun_path) -1);</div><div class="line"><a name="l03673"></a><span class="lineno"> 3673</span>&#160;    su.sun_path[<span class="keyword">sizeof</span>(su.sun_path) - 1] = <span class="stringliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l03674"></a><span class="lineno"> 3674</span>&#160;</div><div class="line"><a name="l03675"></a><span class="lineno"> 3675</span>&#160;    <span class="keywordflow">if</span> (notify_socket[0] == <span class="stringliteral">&#39;@&#39;</span>)</div><div class="line"><a name="l03676"></a><span class="lineno"> 3676</span>&#160;        su.sun_path[0] = <span class="stringliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l03677"></a><span class="lineno"> 3677</span>&#160;</div><div class="line"><a name="l03678"></a><span class="lineno"> 3678</span>&#160;    memset(&amp;iov, 0, <span class="keyword">sizeof</span>(iov));</div><div class="line"><a name="l03679"></a><span class="lineno"> 3679</span>&#160;    iov.iov_base = <span class="stringliteral">&quot;READY=1&quot;</span>;</div><div class="line"><a name="l03680"></a><span class="lineno"> 3680</span>&#160;    iov.iov_len = strlen(<span class="stringliteral">&quot;READY=1&quot;</span>);</div><div class="line"><a name="l03681"></a><span class="lineno"> 3681</span>&#160;</div><div class="line"><a name="l03682"></a><span class="lineno"> 3682</span>&#160;    memset(&amp;hdr, 0, <span class="keyword">sizeof</span>(hdr));</div><div class="line"><a name="l03683"></a><span class="lineno"> 3683</span>&#160;    hdr.msg_name = &amp;su;</div><div class="line"><a name="l03684"></a><span class="lineno"> 3684</span>&#160;    hdr.msg_namelen = offsetof(<span class="keyword">struct</span> sockaddr_un, sun_path) +</div><div class="line"><a name="l03685"></a><span class="lineno"> 3685</span>&#160;        strlen(notify_socket);</div><div class="line"><a name="l03686"></a><span class="lineno"> 3686</span>&#160;    hdr.msg_iov = &amp;iov;</div><div class="line"><a name="l03687"></a><span class="lineno"> 3687</span>&#160;    hdr.msg_iovlen = 1;</div><div class="line"><a name="l03688"></a><span class="lineno"> 3688</span>&#160;</div><div class="line"><a name="l03689"></a><span class="lineno"> 3689</span>&#160;    unsetenv(<span class="stringliteral">&quot;NOTIFY_SOCKET&quot;</span>);</div><div class="line"><a name="l03690"></a><span class="lineno"> 3690</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">ifdef</span> HAVE_MSG_NOSIGNAL</div><div class="line"><a name="l03691"></a><span class="lineno"> 3691</span>&#160;    sendto_flags |= MSG_NOSIGNAL;</div><div class="line"><a name="l03692"></a><span class="lineno"> 3692</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">endif</span></div><div class="line"><a name="l03693"></a><span class="lineno"> 3693</span>&#160;    <span class="keywordflow">if</span> (sendmsg(fd, &amp;hdr, sendto_flags) &lt; 0) {</div><div class="line"><a name="l03694"></a><span class="lineno"> 3694</span>&#160;        serverLog(<a class="code" href="server_8h.html#a31229b9334bba7d6be2a72970967a14b">LL_WARNING</a>, <span class="stringliteral">&quot;Can&#39;t send notification to systemd&quot;</span>);</div><div class="line"><a name="l03695"></a><span class="lineno"> 3695</span>&#160;        close(fd);</div><div class="line"><a name="l03696"></a><span class="lineno"> 3696</span>&#160;        <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l03697"></a><span class="lineno"> 3697</span>&#160;    }</div><div class="line"><a name="l03698"></a><span class="lineno"> 3698</span>&#160;    close(fd);</div><div class="line"><a name="l03699"></a><span class="lineno"> 3699</span>&#160;    <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l03700"></a><span class="lineno"> 3700</span>&#160;}</div><div class="line"><a name="l03701"></a><span class="lineno"> 3701</span>&#160;</div><div class="line"><a name="l03702"></a><span class="lineno"> 3702</span>&#160;<span class="keywordtype">int</span> redisIsSupervised(<span class="keywordtype">int</span> mode) {</div><div class="line"><a name="l03703"></a><span class="lineno"> 3703</span>&#160;    <span class="keywordflow">if</span> (mode == <a class="code" href="server_8h.html#a7b2b1d1fd04a4f2c1a141e0976dd479b">SUPERVISED_AUTODETECT</a>) {</div><div class="line"><a name="l03704"></a><span class="lineno"> 3704</span>&#160;        <span class="keyword">const</span> <span class="keywordtype">char</span> *upstart_job = getenv(<span class="stringliteral">&quot;UPSTART_JOB&quot;</span>);</div><div class="line"><a name="l03705"></a><span class="lineno"> 3705</span>&#160;        <span class="keyword">const</span> <span class="keywordtype">char</span> *notify_socket = getenv(<span class="stringliteral">&quot;NOTIFY_SOCKET&quot;</span>);</div><div class="line"><a name="l03706"></a><span class="lineno"> 3706</span>&#160;</div><div class="line"><a name="l03707"></a><span class="lineno"> 3707</span>&#160;        <span class="keywordflow">if</span> (upstart_job) {</div><div class="line"><a name="l03708"></a><span class="lineno"> 3708</span>&#160;            redisSupervisedUpstart();</div><div class="line"><a name="l03709"></a><span class="lineno"> 3709</span>&#160;        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (notify_socket) {</div><div class="line"><a name="l03710"></a><span class="lineno"> 3710</span>&#160;            redisSupervisedSystemd();</div><div class="line"><a name="l03711"></a><span class="lineno"> 3711</span>&#160;        }</div><div class="line"><a name="l03712"></a><span class="lineno"> 3712</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mode == <a class="code" href="server_8h.html#ae34bdafb8c6d3cc58fc6b319e623b604">SUPERVISED_UPSTART</a>) {</div><div class="line"><a name="l03713"></a><span class="lineno"> 3713</span>&#160;        <span class="keywordflow">return</span> redisSupervisedUpstart();</div><div class="line"><a name="l03714"></a><span class="lineno"> 3714</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mode == <a class="code" href="server_8h.html#aea7b4966d78f67f5ab89f38f0e1bde74">SUPERVISED_SYSTEMD</a>) {</div><div class="line"><a name="l03715"></a><span class="lineno"> 3715</span>&#160;        <span class="keywordflow">return</span> redisSupervisedSystemd();</div><div class="line"><a name="l03716"></a><span class="lineno"> 3716</span>&#160;    }</div><div class="line"><a name="l03717"></a><span class="lineno"> 3717</span>&#160;</div><div class="line"><a name="l03718"></a><span class="lineno"> 3718</span>&#160;    <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l03719"></a><span class="lineno"> 3719</span>&#160;}</div><div class="line"><a name="l03720"></a><span class="lineno"> 3720</span>&#160;</div><div class="line"><a name="l03721"></a><span class="lineno"> 3721</span>&#160;</div><div class="line"><a name="l03722"></a><span class="lineno"> 3722</span>&#160;<span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv) {</div><div class="line"><a name="l03723"></a><span class="lineno"> 3723</span>&#160;    <span class="keyword">struct</span> timeval tv;</div><div class="line"><a name="l03724"></a><span class="lineno"> 3724</span>&#160;    <span class="keywordtype">int</span> j;</div><div class="line"><a name="l03725"></a><span class="lineno"> 3725</span>&#160;</div><div class="line"><a name="l03726"></a><span class="lineno"> 3726</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">ifdef</span> <span class="preprocessor">REDIS_TEST</span></div><div class="line"><a name="l03727"></a><span class="lineno"> 3727</span>&#160;    <span class="keywordflow">if</span> (argc == 3 &amp;&amp; !strcasecmp(argv[1], <span class="stringliteral">&quot;test&quot;</span>)) {</div><div class="line"><a name="l03728"></a><span class="lineno"> 3728</span>&#160;        <span class="keywordflow">if</span> (!strcasecmp(argv[2], <span class="stringliteral">&quot;ziplist&quot;</span>)) {</div><div class="line"><a name="l03729"></a><span class="lineno"> 3729</span>&#160;            <span class="keywordflow">return</span> ziplistTest(argc, argv);</div><div class="line"><a name="l03730"></a><span class="lineno"> 3730</span>&#160;        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(argv[2], <span class="stringliteral">&quot;quicklist&quot;</span>)) {</div><div class="line"><a name="l03731"></a><span class="lineno"> 3731</span>&#160;            quicklistTest(argc, argv);</div><div class="line"><a name="l03732"></a><span class="lineno"> 3732</span>&#160;        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(argv[2], <span class="stringliteral">&quot;intset&quot;</span>)) {</div><div class="line"><a name="l03733"></a><span class="lineno"> 3733</span>&#160;            <span class="keywordflow">return</span> intsetTest(argc, argv);</div><div class="line"><a name="l03734"></a><span class="lineno"> 3734</span>&#160;        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(argv[2], <span class="stringliteral">&quot;zipmap&quot;</span>)) {</div><div class="line"><a name="l03735"></a><span class="lineno"> 3735</span>&#160;            <span class="keywordflow">return</span> zipmapTest(argc, argv);</div><div class="line"><a name="l03736"></a><span class="lineno"> 3736</span>&#160;        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(argv[2], <span class="stringliteral">&quot;sha1test&quot;</span>)) {</div><div class="line"><a name="l03737"></a><span class="lineno"> 3737</span>&#160;            <span class="keywordflow">return</span> sha1Test(argc, argv);</div><div class="line"><a name="l03738"></a><span class="lineno"> 3738</span>&#160;        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(argv[2], <span class="stringliteral">&quot;util&quot;</span>)) {</div><div class="line"><a name="l03739"></a><span class="lineno"> 3739</span>&#160;            <span class="keywordflow">return</span> utilTest(argc, argv);</div><div class="line"><a name="l03740"></a><span class="lineno"> 3740</span>&#160;        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(argv[2], <span class="stringliteral">&quot;sds&quot;</span>)) {</div><div class="line"><a name="l03741"></a><span class="lineno"> 3741</span>&#160;            <span class="keywordflow">return</span> sdsTest(argc, argv);</div><div class="line"><a name="l03742"></a><span class="lineno"> 3742</span>&#160;        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(argv[2], <span class="stringliteral">&quot;endianconv&quot;</span>)) {</div><div class="line"><a name="l03743"></a><span class="lineno"> 3743</span>&#160;            <span class="keywordflow">return</span> endianconvTest(argc, argv);</div><div class="line"><a name="l03744"></a><span class="lineno"> 3744</span>&#160;        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(argv[2], <span class="stringliteral">&quot;crc64&quot;</span>)) {</div><div class="line"><a name="l03745"></a><span class="lineno"> 3745</span>&#160;            <span class="keywordflow">return</span> crc64Test(argc, argv);</div><div class="line"><a name="l03746"></a><span class="lineno"> 3746</span>&#160;        }</div><div class="line"><a name="l03747"></a><span class="lineno"> 3747</span>&#160;</div><div class="line"><a name="l03748"></a><span class="lineno"> 3748</span>&#160;        <span class="keywordflow">return</span> -1; <span class="comment">/* test not found */</span></div><div class="line"><a name="l03749"></a><span class="lineno"> 3749</span>&#160;    }</div><div class="line"><a name="l03750"></a><span class="lineno"> 3750</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">endif</span></div><div class="line"><a name="l03751"></a><span class="lineno"> 3751</span>&#160;</div><div class="line"><a name="l03752"></a><span class="lineno"> 3752</span>&#160;    <span class="comment">/* We need to initialize our libraries, and the server configuration. */</span></div><div class="line"><a name="l03753"></a><span class="lineno"> 3753</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">ifdef</span> INIT_SETPROCTITLE_REPLACEMENT</div><div class="line"><a name="l03754"></a><span class="lineno"> 3754</span>&#160;    spt_init(argc, argv);</div><div class="line"><a name="l03755"></a><span class="lineno"> 3755</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">endif</span></div><div class="line"><a name="l03756"></a><span class="lineno"> 3756</span>&#160;    setlocale(LC_COLLATE,<span class="stringliteral">&quot;&quot;</span>);</div><div class="line"><a name="l03757"></a><span class="lineno"> 3757</span>&#160;    zmalloc_set_oom_handler(redisOutOfMemoryHandler);</div><div class="line"><a name="l03758"></a><span class="lineno"> 3758</span>&#160;    srand(time(NULL)^getpid());</div><div class="line"><a name="l03759"></a><span class="lineno"> 3759</span>&#160;    gettimeofday(&amp;tv,NULL);</div><div class="line"><a name="l03760"></a><span class="lineno"> 3760</span>&#160;    <span class="keywordtype">char</span> hashseed[16];</div><div class="line"><a name="l03761"></a><span class="lineno"> 3761</span>&#160;    getRandomHexChars(hashseed,<span class="keyword">sizeof</span>(hashseed));</div><div class="line"><a name="l03762"></a><span class="lineno"> 3762</span>&#160;    dictSetHashFunctionSeed((uint8_t*)hashseed);</div><div class="line"><a name="l03763"></a><span class="lineno"> 3763</span>&#160;    server.sentinel_mode = checkForSentinelMode(argc,argv);</div><div class="line"><a name="l03764"></a><span class="lineno"> 3764</span>&#160;    initServerConfig();</div><div class="line"><a name="l03765"></a><span class="lineno"> 3765</span>&#160;    moduleInitModulesSystem();</div><div class="line"><a name="l03766"></a><span class="lineno"> 3766</span>&#160;</div><div class="line"><a name="l03767"></a><span class="lineno"> 3767</span>&#160;    <span class="comment">/* Store the executable path and arguments in a safe place in order</span></div><div class="line"><a name="l03768"></a><span class="lineno"> 3768</span>&#160;<span class="comment">     * to be able to restart the server later. */</span></div><div class="line"><a name="l03769"></a><span class="lineno"> 3769</span>&#160;    server.executable = getAbsolutePath(argv[0]);</div><div class="line"><a name="l03770"></a><span class="lineno"> 3770</span>&#160;    server.exec_argv = zmalloc(<span class="keyword">sizeof</span>(<span class="keywordtype">char</span>*)*(argc+1));</div><div class="line"><a name="l03771"></a><span class="lineno"> 3771</span>&#160;    server.exec_argv[argc] = NULL;</div><div class="line"><a name="l03772"></a><span class="lineno"> 3772</span>&#160;    <span class="keywordflow">for</span> (j = 0; j &lt; argc; j++) server.exec_argv[j] = zstrdup(argv[j]);</div><div class="line"><a name="l03773"></a><span class="lineno"> 3773</span>&#160;</div><div class="line"><a name="l03774"></a><span class="lineno"> 3774</span>&#160;    <span class="comment">/* We need to init sentinel right now as parsing the configuration file</span></div><div class="line"><a name="l03775"></a><span class="lineno"> 3775</span>&#160;<span class="comment">     * in sentinel mode will have the effect of populating the sentinel</span></div><div class="line"><a name="l03776"></a><span class="lineno"> 3776</span>&#160;<span class="comment">     * data structures with master nodes to monitor. */</span></div><div class="line"><a name="l03777"></a><span class="lineno"> 3777</span>&#160;    <span class="keywordflow">if</span> (server.sentinel_mode) {</div><div class="line"><a name="l03778"></a><span class="lineno"> 3778</span>&#160;        initSentinelConfig();</div><div class="line"><a name="l03779"></a><span class="lineno"> 3779</span>&#160;        initSentinel();</div><div class="line"><a name="l03780"></a><span class="lineno"> 3780</span>&#160;    }</div><div class="line"><a name="l03781"></a><span class="lineno"> 3781</span>&#160;</div><div class="line"><a name="l03782"></a><span class="lineno"> 3782</span>&#160;    <span class="comment">/* Check if we need to start in redis-check-rdb/aof mode. We just execute</span></div><div class="line"><a name="l03783"></a><span class="lineno"> 3783</span>&#160;<span class="comment">     * the program main. However the program is part of the Redis executable</span></div><div class="line"><a name="l03784"></a><span class="lineno"> 3784</span>&#160;<span class="comment">     * so that we can easily execute an RDB check on loading errors. */</span></div><div class="line"><a name="l03785"></a><span class="lineno"> 3785</span>&#160;    <span class="keywordflow">if</span> (strstr(argv[0],<span class="stringliteral">&quot;redis-check-rdb&quot;</span>) != NULL)</div><div class="line"><a name="l03786"></a><span class="lineno"> 3786</span>&#160;        redis_check_rdb_main(argc,argv,NULL);</div><div class="line"><a name="l03787"></a><span class="lineno"> 3787</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strstr(argv[0],<span class="stringliteral">&quot;redis-check-aof&quot;</span>) != NULL)</div><div class="line"><a name="l03788"></a><span class="lineno"> 3788</span>&#160;        redis_check_aof_main(argc,argv);</div><div class="line"><a name="l03789"></a><span class="lineno"> 3789</span>&#160;</div><div class="line"><a name="l03790"></a><span class="lineno"> 3790</span>&#160;    <span class="keywordflow">if</span> (argc &gt;= 2) {</div><div class="line"><a name="l03791"></a><span class="lineno"> 3791</span>&#160;        j = 1; <span class="comment">/* First option to parse in argv[] */</span></div><div class="line"><a name="l03792"></a><span class="lineno"> 3792</span>&#160;        sds options = sdsempty();</div><div class="line"><a name="l03793"></a><span class="lineno"> 3793</span>&#160;        <span class="keywordtype">char</span> *configfile = NULL;</div><div class="line"><a name="l03794"></a><span class="lineno"> 3794</span>&#160;</div><div class="line"><a name="l03795"></a><span class="lineno"> 3795</span>&#160;        <span class="comment">/* Handle special options --help and --version */</span></div><div class="line"><a name="l03796"></a><span class="lineno"> 3796</span>&#160;        <span class="keywordflow">if</span> (strcmp(argv[1], <span class="stringliteral">&quot;-v&quot;</span>) == 0 ||</div><div class="line"><a name="l03797"></a><span class="lineno"> 3797</span>&#160;            strcmp(argv[1], <span class="stringliteral">&quot;--version&quot;</span>) == 0) version();</div><div class="line"><a name="l03798"></a><span class="lineno"> 3798</span>&#160;        <span class="keywordflow">if</span> (strcmp(argv[1], <span class="stringliteral">&quot;--help&quot;</span>) == 0 ||</div><div class="line"><a name="l03799"></a><span class="lineno"> 3799</span>&#160;            strcmp(argv[1], <span class="stringliteral">&quot;-h&quot;</span>) == 0) usage();</div><div class="line"><a name="l03800"></a><span class="lineno"> 3800</span>&#160;        <span class="keywordflow">if</span> (strcmp(argv[1], <span class="stringliteral">&quot;--test-memory&quot;</span>) == 0) {</div><div class="line"><a name="l03801"></a><span class="lineno"> 3801</span>&#160;            <span class="keywordflow">if</span> (argc == 3) {</div><div class="line"><a name="l03802"></a><span class="lineno"> 3802</span>&#160;                memtest(atoi(argv[2]),50);</div><div class="line"><a name="l03803"></a><span class="lineno"> 3803</span>&#160;                exit(0);</div><div class="line"><a name="l03804"></a><span class="lineno"> 3804</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l03805"></a><span class="lineno"> 3805</span>&#160;                fprintf(stderr,<span class="stringliteral">&quot;Please specify the amount of memory to test in megabytes.\n&quot;</span>);</div><div class="line"><a name="l03806"></a><span class="lineno"> 3806</span>&#160;                fprintf(stderr,<span class="stringliteral">&quot;Example: ./redis-server --test-memory 4096\n\n&quot;</span>);</div><div class="line"><a name="l03807"></a><span class="lineno"> 3807</span>&#160;                exit(1);</div><div class="line"><a name="l03808"></a><span class="lineno"> 3808</span>&#160;            }</div><div class="line"><a name="l03809"></a><span class="lineno"> 3809</span>&#160;        }</div><div class="line"><a name="l03810"></a><span class="lineno"> 3810</span>&#160;</div><div class="line"><a name="l03811"></a><span class="lineno"> 3811</span>&#160;        <span class="comment">/* First argument is the config file name? */</span></div><div class="line"><a name="l03812"></a><span class="lineno"> 3812</span>&#160;        <span class="keywordflow">if</span> (argv[j][0] != <span class="stringliteral">&#39;-&#39;</span> || argv[j][1] != <span class="stringliteral">&#39;-&#39;</span>) {</div><div class="line"><a name="l03813"></a><span class="lineno"> 3813</span>&#160;            configfile = argv[j];</div><div class="line"><a name="l03814"></a><span class="lineno"> 3814</span>&#160;            server.configfile = getAbsolutePath(configfile);</div><div class="line"><a name="l03815"></a><span class="lineno"> 3815</span>&#160;            <span class="comment">/* Replace the config file in server.exec_argv with</span></div><div class="line"><a name="l03816"></a><span class="lineno"> 3816</span>&#160;<span class="comment">             * its absoulte path. */</span></div><div class="line"><a name="l03817"></a><span class="lineno"> 3817</span>&#160;            zfree(server.exec_argv[j]);</div><div class="line"><a name="l03818"></a><span class="lineno"> 3818</span>&#160;            server.exec_argv[j] = zstrdup(server.configfile);</div><div class="line"><a name="l03819"></a><span class="lineno"> 3819</span>&#160;            j++;</div><div class="line"><a name="l03820"></a><span class="lineno"> 3820</span>&#160;        }</div><div class="line"><a name="l03821"></a><span class="lineno"> 3821</span>&#160;</div><div class="line"><a name="l03822"></a><span class="lineno"> 3822</span>&#160;        <span class="comment">/* All the other options are parsed and conceptually appended to the</span></div><div class="line"><a name="l03823"></a><span class="lineno"> 3823</span>&#160;<span class="comment">         * configuration file. For instance --port 6380 will generate the</span></div><div class="line"><a name="l03824"></a><span class="lineno"> 3824</span>&#160;<span class="comment">         * string &quot;port 6380\n&quot; to be parsed after the actual file name</span></div><div class="line"><a name="l03825"></a><span class="lineno"> 3825</span>&#160;<span class="comment">         * is parsed, if any. */</span></div><div class="line"><a name="l03826"></a><span class="lineno"> 3826</span>&#160;        <span class="keywordflow">while</span>(j != argc) {</div><div class="line"><a name="l03827"></a><span class="lineno"> 3827</span>&#160;            <span class="keywordflow">if</span> (argv[j][0] == <span class="stringliteral">&#39;-&#39;</span> &amp;&amp; argv[j][1] == <span class="stringliteral">&#39;-&#39;</span>) {</div><div class="line"><a name="l03828"></a><span class="lineno"> 3828</span>&#160;                <span class="comment">/* Option name */</span></div><div class="line"><a name="l03829"></a><span class="lineno"> 3829</span>&#160;                <span class="keywordflow">if</span> (!strcmp(argv[j], <span class="stringliteral">&quot;--check-rdb&quot;</span>)) {</div><div class="line"><a name="l03830"></a><span class="lineno"> 3830</span>&#160;                    <span class="comment">/* Argument has no options, need to skip for parsing. */</span></div><div class="line"><a name="l03831"></a><span class="lineno"> 3831</span>&#160;                    j++;</div><div class="line"><a name="l03832"></a><span class="lineno"> 3832</span>&#160;                    <span class="keywordflow">continue</span>;</div><div class="line"><a name="l03833"></a><span class="lineno"> 3833</span>&#160;                }</div><div class="line"><a name="l03834"></a><span class="lineno"> 3834</span>&#160;                <span class="keywordflow">if</span> (sdslen(options)) options = sdscat(options,<span class="stringliteral">&quot;\n&quot;</span>);</div><div class="line"><a name="l03835"></a><span class="lineno"> 3835</span>&#160;                options = sdscat(options,argv[j]+2);</div><div class="line"><a name="l03836"></a><span class="lineno"> 3836</span>&#160;                options = sdscat(options,<span class="stringliteral">&quot; &quot;</span>);</div><div class="line"><a name="l03837"></a><span class="lineno"> 3837</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l03838"></a><span class="lineno"> 3838</span>&#160;                <span class="comment">/* Option argument */</span></div><div class="line"><a name="l03839"></a><span class="lineno"> 3839</span>&#160;                options = sdscatrepr(options,argv[j],strlen(argv[j]));</div><div class="line"><a name="l03840"></a><span class="lineno"> 3840</span>&#160;                options = sdscat(options,<span class="stringliteral">&quot; &quot;</span>);</div><div class="line"><a name="l03841"></a><span class="lineno"> 3841</span>&#160;            }</div><div class="line"><a name="l03842"></a><span class="lineno"> 3842</span>&#160;            j++;</div><div class="line"><a name="l03843"></a><span class="lineno"> 3843</span>&#160;        }</div><div class="line"><a name="l03844"></a><span class="lineno"> 3844</span>&#160;        <span class="keywordflow">if</span> (server.sentinel_mode &amp;&amp; configfile &amp;&amp; *configfile == <span class="stringliteral">&#39;-&#39;</span>) {</div><div class="line"><a name="l03845"></a><span class="lineno"> 3845</span>&#160;            serverLog(<a class="code" href="server_8h.html#a31229b9334bba7d6be2a72970967a14b">LL_WARNING</a>,</div><div class="line"><a name="l03846"></a><span class="lineno"> 3846</span>&#160;                <span class="stringliteral">&quot;Sentinel config from STDIN not allowed.&quot;</span>);</div><div class="line"><a name="l03847"></a><span class="lineno"> 3847</span>&#160;            serverLog(<a class="code" href="server_8h.html#a31229b9334bba7d6be2a72970967a14b">LL_WARNING</a>,</div><div class="line"><a name="l03848"></a><span class="lineno"> 3848</span>&#160;                <span class="stringliteral">&quot;Sentinel needs config file on disk to save state.  Exiting...&quot;</span>);</div><div class="line"><a name="l03849"></a><span class="lineno"> 3849</span>&#160;            exit(1);</div><div class="line"><a name="l03850"></a><span class="lineno"> 3850</span>&#160;        }</div><div class="line"><a name="l03851"></a><span class="lineno"> 3851</span>&#160;        resetServerSaveParams();</div><div class="line"><a name="l03852"></a><span class="lineno"> 3852</span>&#160;        loadServerConfig(configfile,options);</div><div class="line"><a name="l03853"></a><span class="lineno"> 3853</span>&#160;        sdsfree(options);</div><div class="line"><a name="l03854"></a><span class="lineno"> 3854</span>&#160;    }</div><div class="line"><a name="l03855"></a><span class="lineno"> 3855</span>&#160;</div><div class="line"><a name="l03856"></a><span class="lineno"> 3856</span>&#160;    serverLog(<a class="code" href="server_8h.html#a31229b9334bba7d6be2a72970967a14b">LL_WARNING</a>, <span class="stringliteral">&quot;oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo&quot;</span>);</div><div class="line"><a name="l03857"></a><span class="lineno"> 3857</span>&#160;    serverLog(<a class="code" href="server_8h.html#a31229b9334bba7d6be2a72970967a14b">LL_WARNING</a>,</div><div class="line"><a name="l03858"></a><span class="lineno"> 3858</span>&#160;        <span class="stringliteral">&quot;Redis version=%s, bits=%d, commit=%s, modified=%d, pid=%d, just started&quot;</span>,</div><div class="line"><a name="l03859"></a><span class="lineno"> 3859</span>&#160;            <a class="code" href="version_8h.html#a357a0d302ef7fbb42bf2db0632b9f7fe">REDIS_VERSION</a>,</div><div class="line"><a name="l03860"></a><span class="lineno"> 3860</span>&#160;            (<span class="keyword">sizeof</span>(<span class="keywordtype">long</span>) == 8) ? 64 : 32,</div><div class="line"><a name="l03861"></a><span class="lineno"> 3861</span>&#160;            redisGitSHA1(),</div><div class="line"><a name="l03862"></a><span class="lineno"> 3862</span>&#160;            strtol(redisGitDirty(),NULL,10) &gt; 0,</div><div class="line"><a name="l03863"></a><span class="lineno"> 3863</span>&#160;            (<span class="keywordtype">int</span>)getpid());</div><div class="line"><a name="l03864"></a><span class="lineno"> 3864</span>&#160;</div><div class="line"><a name="l03865"></a><span class="lineno"> 3865</span>&#160;    <span class="keywordflow">if</span> (argc == 1) {</div><div class="line"><a name="l03866"></a><span class="lineno"> 3866</span>&#160;        serverLog(<a class="code" href="server_8h.html#a31229b9334bba7d6be2a72970967a14b">LL_WARNING</a>, <span class="stringliteral">&quot;Warning: no config file specified, using the default config. In order to specify a config file use %s /path/to/%s.conf&quot;</span>, argv[0], server.sentinel_mode ? <span class="stringliteral">&quot;sentinel&quot;</span> : <span class="stringliteral">&quot;redis&quot;</span>);</div><div class="line"><a name="l03867"></a><span class="lineno"> 3867</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l03868"></a><span class="lineno"> 3868</span>&#160;        serverLog(<a class="code" href="server_8h.html#a31229b9334bba7d6be2a72970967a14b">LL_WARNING</a>, <span class="stringliteral">&quot;Configuration loaded&quot;</span>);</div><div class="line"><a name="l03869"></a><span class="lineno"> 3869</span>&#160;    }</div><div class="line"><a name="l03870"></a><span class="lineno"> 3870</span>&#160;</div><div class="line"><a name="l03871"></a><span class="lineno"> 3871</span>&#160;    server.supervised = redisIsSupervised(server.supervised_mode);</div><div class="line"><a name="l03872"></a><span class="lineno"> 3872</span>&#160;    <span class="keywordtype">int</span> background = server.daemonize &amp;&amp; !server.supervised;</div><div class="line"><a name="l03873"></a><span class="lineno"> 3873</span>&#160;    <span class="keywordflow">if</span> (background) daemonize();</div><div class="line"><a name="l03874"></a><span class="lineno"> 3874</span>&#160;</div><div class="line"><a name="l03875"></a><span class="lineno"> 3875</span>&#160;    initServer();</div><div class="line"><a name="l03876"></a><span class="lineno"> 3876</span>&#160;    <span class="keywordflow">if</span> (background || server.pidfile) createPidFile();</div><div class="line"><a name="l03877"></a><span class="lineno"> 3877</span>&#160;    redisSetProcTitle(argv[0]);</div><div class="line"><a name="l03878"></a><span class="lineno"> 3878</span>&#160;    redisAsciiArt();</div><div class="line"><a name="l03879"></a><span class="lineno"> 3879</span>&#160;    checkTcpBacklogSettings();</div><div class="line"><a name="l03880"></a><span class="lineno"> 3880</span>&#160;</div><div class="line"><a name="l03881"></a><span class="lineno"> 3881</span>&#160;    <span class="keywordflow">if</span> (!server.sentinel_mode) {</div><div class="line"><a name="l03882"></a><span class="lineno"> 3882</span>&#160;        <span class="comment">/* Things not needed when running in Sentinel mode. */</span></div><div class="line"><a name="l03883"></a><span class="lineno"> 3883</span>&#160;        serverLog(<a class="code" href="server_8h.html#a31229b9334bba7d6be2a72970967a14b">LL_WARNING</a>,<span class="stringliteral">&quot;Server initialized&quot;</span>);</div><div class="line"><a name="l03884"></a><span class="lineno"> 3884</span>&#160;    <span class="preprocessor">#</span><span class="preprocessor">ifdef</span> __linux__</div><div class="line"><a name="l03885"></a><span class="lineno"> 3885</span>&#160;        linuxMemoryWarnings();</div><div class="line"><a name="l03886"></a><span class="lineno"> 3886</span>&#160;    <span class="preprocessor">#</span><span class="preprocessor">endif</span></div><div class="line"><a name="l03887"></a><span class="lineno"> 3887</span>&#160;        moduleLoadFromQueue();</div><div class="line"><a name="l03888"></a><span class="lineno"> 3888</span>&#160;        loadDataFromDisk();</div><div class="line"><a name="l03889"></a><span class="lineno"> 3889</span>&#160;        <span class="keywordflow">if</span> (server.cluster_enabled) {</div><div class="line"><a name="l03890"></a><span class="lineno"> 3890</span>&#160;            <span class="keywordflow">if</span> (verifyClusterConfigWithData() == <a class="code" href="server_8h.html#af98ac28d5f4d23d7ed5985188e6fb7d1">C_ERR</a>) {</div><div class="line"><a name="l03891"></a><span class="lineno"> 3891</span>&#160;                serverLog(<a class="code" href="server_8h.html#a31229b9334bba7d6be2a72970967a14b">LL_WARNING</a>,</div><div class="line"><a name="l03892"></a><span class="lineno"> 3892</span>&#160;                    <span class="stringliteral">&quot;You can&#39;t have keys in a DB different than DB 0 when in &quot;</span></div><div class="line"><a name="l03893"></a><span class="lineno"> 3893</span>&#160;                    <span class="stringliteral">&quot;Cluster mode. Exiting.&quot;</span>);</div><div class="line"><a name="l03894"></a><span class="lineno"> 3894</span>&#160;                exit(1);</div><div class="line"><a name="l03895"></a><span class="lineno"> 3895</span>&#160;            }</div><div class="line"><a name="l03896"></a><span class="lineno"> 3896</span>&#160;        }</div><div class="line"><a name="l03897"></a><span class="lineno"> 3897</span>&#160;        <span class="keywordflow">if</span> (server.ipfd_count &gt; 0)</div><div class="line"><a name="l03898"></a><span class="lineno"> 3898</span>&#160;            serverLog(<a class="code" href="server_8h.html#a8c54c191e436c7dd3012167212692401">LL_NOTICE</a>,<span class="stringliteral">&quot;Ready to accept connections&quot;</span>);</div><div class="line"><a name="l03899"></a><span class="lineno"> 3899</span>&#160;        <span class="keywordflow">if</span> (server.sofd &gt; 0)</div><div class="line"><a name="l03900"></a><span class="lineno"> 3900</span>&#160;            serverLog(<a class="code" href="server_8h.html#a8c54c191e436c7dd3012167212692401">LL_NOTICE</a>,<span class="stringliteral">&quot;The server is now ready to accept connections at %s&quot;</span>, server.unixsocket);</div><div class="line"><a name="l03901"></a><span class="lineno"> 3901</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l03902"></a><span class="lineno"> 3902</span>&#160;        sentinelIsRunning();</div><div class="line"><a name="l03903"></a><span class="lineno"> 3903</span>&#160;    }</div><div class="line"><a name="l03904"></a><span class="lineno"> 3904</span>&#160;</div><div class="line"><a name="l03905"></a><span class="lineno"> 3905</span>&#160;    <span class="comment">/* Warning the user about suspicious maxmemory setting. */</span></div><div class="line"><a name="l03906"></a><span class="lineno"> 3906</span>&#160;    <span class="keywordflow">if</span> (server.maxmemory &gt; 0 &amp;&amp; server.maxmemory &lt; 1024*1024) {</div><div class="line"><a name="l03907"></a><span class="lineno"> 3907</span>&#160;        serverLog(<a class="code" href="server_8h.html#a31229b9334bba7d6be2a72970967a14b">LL_WARNING</a>,<span class="stringliteral">&quot;WARNING: You specified a maxmemory value that is less than 1MB (current value is %llu bytes). Are you sure this is what you really want?&quot;</span>, server.maxmemory);</div><div class="line"><a name="l03908"></a><span class="lineno"> 3908</span>&#160;    }</div><div class="line"><a name="l03909"></a><span class="lineno"> 3909</span>&#160;</div><div class="line"><a name="l03910"></a><span class="lineno"> 3910</span>&#160;    aeSetBeforeSleepProc(server.el,beforeSleep);</div><div class="line"><a name="l03911"></a><span class="lineno"> 3911</span>&#160;    aeSetAfterSleepProc(server.el,afterSleep);</div><div class="line"><a name="l03912"></a><span class="lineno"> 3912</span>&#160;    aeMain(server.el);</div><div class="line"><a name="l03913"></a><span class="lineno"> 3913</span>&#160;    aeDeleteEventLoop(server.el);</div><div class="line"><a name="l03914"></a><span class="lineno"> 3914</span>&#160;    <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l03915"></a><span class="lineno"> 3915</span>&#160;}</div><div class="line"><a name="l03916"></a><span class="lineno"> 3916</span>&#160;</div><div class="line"><a name="l03917"></a><span class="lineno"> 3917</span>&#160;<span class="comment">/* The End */</span></div><div class="ttc" id="server_8h_html_a547664770d2cec2d58d144a2f5afbbd8"><div class="ttname"><a href="server_8h.html#a547664770d2cec2d58d144a2f5afbbd8">CONFIG_DEFAULT_MIN_SLAVES_MAX_LAG</a></div><div class="ttdeci">#define CONFIG_DEFAULT_MIN_SLAVES_MAX_LAG</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00147">server.h:147</a></div></div>
<div class="ttc" id="server_8h_html_a7b1d9cf5be21e4808da0c16f03155973"><div class="ttname"><a href="server_8h.html#a7b1d9cf5be21e4808da0c16f03155973">CMD_CALL_STATS</a></div><div class="ttdeci">#define CMD_CALL_STATS</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00402">server.h:402</a></div></div>
<div class="ttc" id="server_8h_html_a7bc03a080189821c8c88b31027281d4b"><div class="ttname"><a href="server_8h.html#a7bc03a080189821c8c88b31027281d4b">CONFIG_DEFAULT_ACTIVE_DEFRAG</a></div><div class="ttdeci">#define CONFIG_DEFAULT_ACTIVE_DEFRAG</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00158">server.h:158</a></div></div>
<div class="ttc" id="server_8h_html_a819ad39aa4aef302c4421c3cd910252d"><div class="ttname"><a href="server_8h.html#a819ad39aa4aef302c4421c3cd910252d">CMD_SORT_FOR_SCRIPT</a></div><div class="ttdeci">#define CMD_SORT_FOR_SCRIPT</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00206">server.h:206</a></div></div>
<div class="ttc" id="server_8h_html_ac1f765315b576de4c0ea2beb7e37ae02"><div class="ttname"><a href="server_8h.html#ac1f765315b576de4c0ea2beb7e37ae02">CONFIG_DEFAULT_LAZYFREE_LAZY_SERVER_DEL</a></div><div class="ttdeci">#define CONFIG_DEFAULT_LAZYFREE_LAZY_SERVER_DEL</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00156">server.h:156</a></div></div>
<div class="ttc" id="structredisMemOverhead_html"><div class="ttname"><a href="structredisMemOverhead.html">redisMemOverhead</a></div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00826">server.h:826</a></div></div>
<div class="ttc" id="server_8h_html_a542fb79924ca427c866fd63632f60777"><div class="ttname"><a href="server_8h.html#a542fb79924ca427c866fd63632f60777">PROPAGATE_AOF</a></div><div class="ttdeci">#define PROPAGATE_AOF</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00410">server.h:410</a></div></div>
<div class="ttc" id="server_8h_html_a407337e4d193cc8fc965938b7a247240"><div class="ttname"><a href="server_8h.html#a407337e4d193cc8fc965938b7a247240">CONFIG_DEFAULT_VERBOSITY</a></div><div class="ttdeci">#define CONFIG_DEFAULT_VERBOSITY</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00327">server.h:327</a></div></div>
<div class="ttc" id="server_8h_html_a5327d118cf467e77d8bb0cebdce3c0ce"><div class="ttname"><a href="server_8h.html#a5327d118cf467e77d8bb0cebdce3c0ce">CMD_LOADING</a></div><div class="ttdeci">#define CMD_LOADING</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00207">server.h:207</a></div></div>
<div class="ttc" id="server_8h_html_a451c1542a74f0181600d043df3f1b19a"><div class="ttname"><a href="server_8h.html#a451c1542a74f0181600d043df3f1b19a">CLIENT_FORCE_AOF</a></div><div class="ttdeci">#define CLIENT_FORCE_AOF</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00236">server.h:236</a></div></div>
<div class="ttc" id="server_8h_html_a549382a72b7490f18a44f03e2dbe5568"><div class="ttname"><a href="server_8h.html#a549382a72b7490f18a44f03e2dbe5568">CONFIG_DEFAULT_RDB_CHECKSUM</a></div><div class="ttdeci">#define CONFIG_DEFAULT_RDB_CHECKSUM</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00127">server.h:127</a></div></div>
<div class="ttc" id="server_8h_html_a077401d3a9f810d535c00725ef6c6532"><div class="ttname"><a href="server_8h.html#a077401d3a9f810d535c00725ef6c6532">SHUTDOWN_NOFLAGS</a></div><div class="ttdeci">#define SHUTDOWN_NOFLAGS</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00394">server.h:394</a></div></div>
<div class="ttc" id="server_8h_html_a5496312872886690751d1e4a248026e9"><div class="ttname"><a href="server_8h.html#a5496312872886690751d1e4a248026e9">CONFIG_DEFAULT_REPL_PING_SLAVE_PERIOD</a></div><div class="ttdeci">#define CONFIG_DEFAULT_REPL_PING_SLAVE_PERIOD</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00106">server.h:106</a></div></div>
<div class="ttc" id="server_8h_html_a68661cd596afb7595059264beee63dc7"><div class="ttname"><a href="server_8h.html#a68661cd596afb7595059264beee63dc7">CONFIG_DEFAULT_MIN_SLAVES_TO_WRITE</a></div><div class="ttdeci">#define CONFIG_DEFAULT_MIN_SLAVES_TO_WRITE</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00146">server.h:146</a></div></div>
<div class="ttc" id="server_8h_html_a38e65004c240be8a04ab492731c7da50"><div class="ttname"><a href="server_8h.html#a38e65004c240be8a04ab492731c7da50">CONFIG_DEFAULT_MAXMEMORY_SAMPLES</a></div><div class="ttdeci">#define CONFIG_DEFAULT_MAXMEMORY_SAMPLES</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00137">server.h:137</a></div></div>
<div class="ttc" id="server_8h_html_a11cc378e7778a830b41240578de3b204"><div class="ttname"><a href="server_8h.html#a11cc378e7778a830b41240578de3b204">serverPanic</a></div><div class="ttdeci">#define serverPanic(...)</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00444">server.h:444</a></div></div>
<div class="ttc" id="server_8h_html_a7e9c728f228e1c82ae1e22173375abcf"><div class="ttname"><a href="server_8h.html#a7e9c728f228e1c82ae1e22173375abcf">CMD_READONLY</a></div><div class="ttdeci">#define CMD_READONLY</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00199">server.h:199</a></div></div>
<div class="ttc" id="server_8h_html_a479b60032f8da6d8ad72e1a9d0809950"><div class="ttname"><a href="server_8h.html#a479b60032f8da6d8ad72e1a9d0809950">LL_VERBOSE</a></div><div class="ttdeci">#define LL_VERBOSE</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00323">server.h:323</a></div></div>
<div class="ttc" id="server_8h_html_a5226306fbcebcb6d5d02e0fef3c213c2"><div class="ttname"><a href="server_8h.html#a5226306fbcebcb6d5d02e0fef3c213c2">AOF_OFF</a></div><div class="ttdeci">#define AOF_OFF</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00216">server.h:216</a></div></div>
<div class="ttc" id="server_8h_html_aa6529c6ba7143b1ec4aa15d8a96b2154"><div class="ttname"><a href="server_8h.html#aa6529c6ba7143b1ec4aa15d8a96b2154">CONFIG_DEFAULT_LAZYFREE_LAZY_EVICTION</a></div><div class="ttdeci">#define CONFIG_DEFAULT_LAZYFREE_LAZY_EVICTION</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00154">server.h:154</a></div></div>
<div class="ttc" id="server_8h_html_abc5ff12d4e9b662f85d2cb11a0220926"><div class="ttname"><a href="server_8h.html#abc5ff12d4e9b662f85d2cb11a0220926">CONFIG_DEFAULT_DBNUM</a></div><div class="ttdeci">#define CONFIG_DEFAULT_DBNUM</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00088">server.h:88</a></div></div>
<div class="ttc" id="structredisServer_html"><div class="ttname"><a href="structredisServer.html">redisServer</a></div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00885">server.h:885</a></div></div>
<div class="ttc" id="server_8h_html_af3bada72076c951a9d5959e73456635a"><div class="ttname"><a href="server_8h.html#af3bada72076c951a9d5959e73456635a">CONFIG_DEFAULT_AOF_FILENAME</a></div><div class="ttdeci">#define CONFIG_DEFAULT_AOF_FILENAME</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00140">server.h:140</a></div></div>
<div class="ttc" id="server_8h_html_a6b3768a4d2dfb3ac580b8d999baa9350"><div class="ttname"><a href="server_8h.html#a6b3768a4d2dfb3ac580b8d999baa9350">LL_RAW</a></div><div class="ttdeci">#define LL_RAW</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00326">server.h:326</a></div></div>
<div class="ttc" id="server_8h_html_a9b588e3803fff7fe515f20d7bc4aa8e6"><div class="ttname"><a href="server_8h.html#a9b588e3803fff7fe515f20d7bc4aa8e6">CONFIG_DEFAULT_AOF_NO_FSYNC_ON_REWRITE</a></div><div class="ttdeci">#define CONFIG_DEFAULT_AOF_NO_FSYNC_ON_REWRITE</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00141">server.h:141</a></div></div>
<div class="ttc" id="server_8h_html_aed693b3a9cdfc05cf5ab7551a8c86fbe"><div class="ttname"><a href="server_8h.html#aed693b3a9cdfc05cf5ab7551a8c86fbe">REPL_STATE_CONNECTED</a></div><div class="ttdeci">#define REPL_STATE_CONNECTED</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00295">server.h:295</a></div></div>
<div class="ttc" id="server_8h_html_ada38427ad2d0c09875081868a53cc51f"><div class="ttname"><a href="server_8h.html#ada38427ad2d0c09875081868a53cc51f">SLAVE_STATE_SEND_BULK</a></div><div class="ttdeci">#define SLAVE_STATE_SEND_BULK</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00303">server.h:303</a></div></div>
<div class="ttc" id="cluster_8h_html_acb94b0516dcfb9814e13dfe97f3ad6b1"><div class="ttname"><a href="cluster_8h.html#acb94b0516dcfb9814e13dfe97f3ad6b1">CLUSTER_DEFAULT_NODE_TIMEOUT</a></div><div class="ttdeci">#define CLUSTER_DEFAULT_NODE_TIMEOUT</div><div class="ttdef"><b>Definition:</b> <a href="cluster_8h_source.html#l00016">cluster.h:16</a></div></div>
<div class="ttc" id="version_8h_html_a357a0d302ef7fbb42bf2db0632b9f7fe"><div class="ttname"><a href="version_8h.html#a357a0d302ef7fbb42bf2db0632b9f7fe">REDIS_VERSION</a></div><div class="ttdeci">#define REDIS_VERSION</div><div class="ttdef"><b>Definition:</b> <a href="version_8h_source.html#l00001">version.h:1</a></div></div>
<div class="ttc" id="server_8h_html_ab85c155ec2652313a561af139fdb5575"><div class="ttname"><a href="server_8h.html#ab85c155ec2652313a561af139fdb5575">CONFIG_DEFAULT_TCP_BACKLOG</a></div><div class="ttdeci">#define CONFIG_DEFAULT_TCP_BACKLOG</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00086">server.h:86</a></div></div>
<div class="ttc" id="server_8h_html_a3ca848c94df18641ac372c58fca0e236"><div class="ttname"><a href="server_8h.html#a3ca848c94df18641ac372c58fca0e236">CMD_CALL_PROPAGATE_AOF</a></div><div class="ttdeci">#define CMD_CALL_PROPAGATE_AOF</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00403">server.h:403</a></div></div>
<div class="ttc" id="server_8h_html_a314eacfa28e22254ee8cc05f2b257281"><div class="ttname"><a href="server_8h.html#a314eacfa28e22254ee8cc05f2b257281">CONFIG_DEFAULT_MAXMEMORY</a></div><div class="ttdeci">#define CONFIG_DEFAULT_MAXMEMORY</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00136">server.h:136</a></div></div>
<div class="ttc" id="server_8h_html_a7e92e38a9fe5f713cace24d63184273e"><div class="ttname"><a href="server_8h.html#a7e92e38a9fe5f713cace24d63184273e">CMD_CALL_FULL</a></div><div class="ttdeci">#define CMD_CALL_FULL</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00406">server.h:406</a></div></div>
<div class="ttc" id="server_8h_html_a950a6acbe9809f9e3dc541e8175b7b44"><div class="ttname"><a href="server_8h.html#a950a6acbe9809f9e3dc541e8175b7b44">PROTO_SHARED_SELECT_CMDS</a></div><div class="ttdeci">#define PROTO_SHARED_SELECT_CMDS</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00092">server.h:92</a></div></div>
<div class="ttc" id="server_8h_html_ab343786c44a1885885a1ac254b724317"><div class="ttname"><a href="server_8h.html#ab343786c44a1885885a1ac254b724317">CONFIG_DEFAULT_LFU_LOG_FACTOR</a></div><div class="ttdeci">#define CONFIG_DEFAULT_LFU_LOG_FACTOR</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00138">server.h:138</a></div></div>
<div class="ttc" id="adlist_8h_html_afde0ab079f934670e82119b43120e94b"><div class="ttname"><a href="adlist_8h.html#afde0ab079f934670e82119b43120e94b">listLength</a></div><div class="ttdeci">#define listLength(l)</div><div class="ttdef"><b>Definition:</b> <a href="adlist_8h_source.html#l00057">adlist.h:57</a></div></div>
<div class="ttc" id="server_8h_html_abcea50457e3de849eab11d0ba5d81d08"><div class="ttname"><a href="server_8h.html#abcea50457e3de849eab11d0ba5d81d08">CONFIG_MIN_RESERVED_FDS</a></div><div class="ttdeci">#define CONFIG_MIN_RESERVED_FDS</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00151">server.h:151</a></div></div>
<div class="ttc" id="adlist_8h_html_af84cae230e7180ebcda1e2736fce9f65"><div class="ttname"><a href="adlist_8h.html#af84cae230e7180ebcda1e2736fce9f65">listNodeValue</a></div><div class="ttdeci">#define listNodeValue(n)</div><div class="ttdef"><b>Definition:</b> <a href="adlist_8h_source.html#l00062">adlist.h:62</a></div></div>
<div class="ttc" id="server_8h_html_ab42b23884952f9887529b6efbf0d4ac6"><div class="ttname"><a href="server_8h.html#ab42b23884952f9887529b6efbf0d4ac6">CONFIG_DEFAULT_SLAVE_SERVE_STALE_DATA</a></div><div class="ttdeci">#define CONFIG_DEFAULT_SLAVE_SERVE_STALE_DATA</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00131">server.h:131</a></div></div>
<div class="ttc" id="server_8h_html_ae7c9dc8f13568a9c856573751f1ee1ec"><div class="ttname"><a href="server_8h.html#ae7c9dc8f13568a9c856573751f1ee1ec">UNUSED</a></div><div class="ttdeci">#define UNUSED(V)</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00336">server.h:336</a></div></div>
<div class="ttc" id="server_8h_html_a6ee9ed603f975d0d2b6ae44f1907565f"><div class="ttname"><a href="server_8h.html#a6ee9ed603f975d0d2b6ae44f1907565f">CMD_CALL_PROPAGATE</a></div><div class="ttdeci">#define CMD_CALL_PROPAGATE</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00405">server.h:405</a></div></div>
<div class="ttc" id="ae_8h_html_aa16dcf7effdf8f8df97f51b1cb51a9df"><div class="ttname"><a href="ae_8h.html#aa16dcf7effdf8f8df97f51b1cb51a9df">AE_ERR</a></div><div class="ttdeci">#define AE_ERR</div><div class="ttdef"><b>Definition:</b> <a href="ae_8h_source.html#l00039">ae.h:39</a></div></div>
<div class="ttc" id="dict_8h_html_aa6e4917a6a32fdf47180e03ed8969e02"><div class="ttname"><a href="dict_8h.html#aa6e4917a6a32fdf47180e03ed8969e02">dictIsRehashing</a></div><div class="ttdeci">#define dictIsRehashing(d)</div><div class="ttdef"><b>Definition:</b> <a href="dict_8h_source.html#l00148">dict.h:148</a></div></div>
<div class="ttc" id="server_8h_html_a69e4a8fdb26588e1028deb20fd51424a"><div class="ttname"><a href="server_8h.html#a69e4a8fdb26588e1028deb20fd51424a">CMD_CALL_PROPAGATE_REPL</a></div><div class="ttdeci">#define CMD_CALL_PROPAGATE_REPL</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00404">server.h:404</a></div></div>
<div class="ttc" id="latency_8h_html_a77922ab34035890c90f98831a9071359"><div class="ttname"><a href="latency_8h.html#a77922ab34035890c90f98831a9071359">latencyAddSampleIfNeeded</a></div><div class="ttdeci">#define latencyAddSampleIfNeeded(event, var)</div><div class="ttdef"><b>Definition:</b> <a href="latency_8h_source.html#l00084">latency.h:84</a></div></div>
<div class="ttc" id="server_8h_html_a694b5ed5268bee8c50cc5b38fbec99ce"><div class="ttname"><a href="server_8h.html#a694b5ed5268bee8c50cc5b38fbec99ce">RDB_SAVE_INFO_INIT</a></div><div class="ttdeci">#define RDB_SAVE_INFO_INIT</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00867">server.h:867</a></div></div>
<div class="ttc" id="server_8h_html_a356d1b1e39a75671cc55fdaf64be3a85"><div class="ttname"><a href="server_8h.html#a356d1b1e39a75671cc55fdaf64be3a85">CONFIG_DEFAULT_AOF_REWRITE_INCREMENTAL_FSYNC</a></div><div class="ttdeci">#define CONFIG_DEFAULT_AOF_REWRITE_INCREMENTAL_FSYNC</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00145">server.h:145</a></div></div>
<div class="ttc" id="server_8h_html_ae34bdafb8c6d3cc58fc6b319e623b604"><div class="ttname"><a href="server_8h.html#ae34bdafb8c6d3cc58fc6b319e623b604">SUPERVISED_UPSTART</a></div><div class="ttdeci">#define SUPERVISED_UPSTART</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00333">server.h:333</a></div></div>
<div class="ttc" id="server_8h_html_af6b151c9dced28e94c19479197113a83"><div class="ttname"><a href="server_8h.html#af6b151c9dced28e94c19479197113a83">AOF_ON</a></div><div class="ttdeci">#define AOF_ON</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00217">server.h:217</a></div></div>
<div class="ttc" id="server_8h_html_a503ad979164a52f0f5e2a63e4c7da3a0"><div class="ttname"><a href="server_8h.html#a503ad979164a52f0f5e2a63e4c7da3a0">CLIENT_BLOCKED</a></div><div class="ttdeci">#define CLIENT_BLOCKED</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00225">server.h:225</a></div></div>
<div class="ttc" id="server_8h_html_a63842e277a2ccef80f42cbae07c9f5d8"><div class="ttname"><a href="server_8h.html#a63842e277a2ccef80f42cbae07c9f5d8">OBJ_HASH_MAX_ZIPLIST_VALUE</a></div><div class="ttdeci">#define OBJ_HASH_MAX_ZIPLIST_VALUE</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00349">server.h:349</a></div></div>
<div class="ttc" id="server_8h_html_a24a132a96a693133fc057a491080aebf"><div class="ttname"><a href="server_8h.html#a24a132a96a693133fc057a491080aebf">CONFIG_DEFAULT_LFU_DECAY_TIME</a></div><div class="ttdeci">#define CONFIG_DEFAULT_LFU_DECAY_TIME</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00139">server.h:139</a></div></div>
<div class="ttc" id="server_8h_html_a86d6a82bc81e718079728c3cb6c8c5b4"><div class="ttname"><a href="server_8h.html#a86d6a82bc81e718079728c3cb6c8c5b4">CONFIG_DEFAULT_CLUSTER_ANNOUNCE_BUS_PORT</a></div><div class="ttdeci">#define CONFIG_DEFAULT_CLUSTER_ANNOUNCE_BUS_PORT</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00118">server.h:118</a></div></div>
<div class="ttc" id="ae_8h_html_a7a9a2162d007d09739955b4e55c65bf3"><div class="ttname"><a href="ae_8h.html#a7a9a2162d007d09739955b4e55c65bf3">AE_READABLE</a></div><div class="ttdeci">#define AE_READABLE</div><div class="ttdef"><b>Definition:</b> <a href="ae_8h_source.html#l00042">ae.h:42</a></div></div>
<div class="ttc" id="zmalloc_8h_html_a374c6d7cf6c9817e1243093e03df7319"><div class="ttname"><a href="zmalloc_8h.html#a374c6d7cf6c9817e1243093e03df7319">ZMALLOC_LIB</a></div><div class="ttdeci">#define ZMALLOC_LIB</div><div class="ttdef"><b>Definition:</b> <a href="zmalloc_8h_source.html#l00065">zmalloc.h:65</a></div></div>
<div class="ttc" id="server_8h_html_ae21dc0d9c0dcdefa14ca1054c48f252f"><div class="ttname"><a href="server_8h.html#ae21dc0d9c0dcdefa14ca1054c48f252f">CMD_FAST</a></div><div class="ttdeci">#define CMD_FAST</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00211">server.h:211</a></div></div>
<div class="ttc" id="server_8h_html_a68ad9c6e5f817d58fa51c1b2e88e83e0"><div class="ttname"><a href="server_8h.html#a68ad9c6e5f817d58fa51c1b2e88e83e0">CONFIG_REPL_SYNCIO_TIMEOUT</a></div><div class="ttdeci">#define CONFIG_REPL_SYNCIO_TIMEOUT</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00312">server.h:312</a></div></div>
<div class="ttc" id="server_8h_html_a7b2b1d1fd04a4f2c1a141e0976dd479b"><div class="ttname"><a href="server_8h.html#a7b2b1d1fd04a4f2c1a141e0976dd479b">SUPERVISED_AUTODETECT</a></div><div class="ttdeci">#define SUPERVISED_AUTODETECT</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00331">server.h:331</a></div></div>
<div class="ttc" id="server_8h_html_a59c6e025b4ed85642a0472fc3e73e298"><div class="ttname"><a href="server_8h.html#a59c6e025b4ed85642a0472fc3e73e298">PROPAGATE_REPL</a></div><div class="ttdeci">#define PROPAGATE_REPL</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00411">server.h:411</a></div></div>
<div class="ttc" id="server_8h_html_a486eb6d6b0e44a772877112dbd928494"><div class="ttname"><a href="server_8h.html#a486eb6d6b0e44a772877112dbd928494">CONFIG_DEFAULT_UNIX_SOCKET_PERM</a></div><div class="ttdeci">#define CONFIG_DEFAULT_UNIX_SOCKET_PERM</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00120">server.h:120</a></div></div>
<div class="ttc" id="server_8h_html_a31229b9334bba7d6be2a72970967a14b"><div class="ttname"><a href="server_8h.html#a31229b9334bba7d6be2a72970967a14b">LL_WARNING</a></div><div class="ttdeci">#define LL_WARNING</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00325">server.h:325</a></div></div>
<div class="ttc" id="server_8h_html_accabd32f20281543986166c219124f9e"><div class="ttname"><a href="server_8h.html#accabd32f20281543986166c219124f9e">CMD_MODULE</a></div><div class="ttdeci">#define CMD_MODULE</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00201">server.h:201</a></div></div>
<div class="ttc" id="server_8h_html_ac55c8423c202c1f0b4e786eb70adefb3"><div class="ttname"><a href="server_8h.html#ac55c8423c202c1f0b4e786eb70adefb3">CONFIG_DEFAULT_CLUSTER_ANNOUNCE_PORT</a></div><div class="ttdeci">#define CONFIG_DEFAULT_CLUSTER_ANNOUNCE_PORT</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00117">server.h:117</a></div></div>
<div class="ttc" id="server_8h_html_a7391deb9c3a262ded3e186e94eb884e2"><div class="ttname"><a href="server_8h.html#a7391deb9c3a262ded3e186e94eb884e2">CMD_WRITE</a></div><div class="ttdeci">#define CMD_WRITE</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00198">server.h:198</a></div></div>
<div class="ttc" id="dict_8h_html_aca9596be4bcc2caa07c17dd8cebcceec"><div class="ttname"><a href="dict_8h.html#aca9596be4bcc2caa07c17dd8cebcceec">dictSlots</a></div><div class="ttdeci">#define dictSlots(d)</div><div class="ttdef"><b>Definition:</b> <a href="dict_8h_source.html#l00146">dict.h:146</a></div></div>
<div class="ttc" id="server_8h_html_a418e5a222cf659c003df77830f1ae343"><div class="ttname"><a href="server_8h.html#a418e5a222cf659c003df77830f1ae343">MAXMEMORY_NO_EVICTION</a></div><div class="ttdeci">#define MAXMEMORY_NO_EVICTION</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00382">server.h:382</a></div></div>
<div class="ttc" id="server_8h_html_af98ac28d5f4d23d7ed5985188e6fb7d1"><div class="ttname"><a href="server_8h.html#af98ac28d5f4d23d7ed5985188e6fb7d1">C_ERR</a></div><div class="ttdeci">#define C_ERR</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00079">server.h:79</a></div></div>
<div class="ttc" id="cluster_8h_html_aa27e3466414a1464e6f2721b8872827d"><div class="ttname"><a href="cluster_8h.html#aa27e3466414a1464e6f2721b8872827d">CLUSTER_DEFAULT_REQUIRE_FULL_COVERAGE</a></div><div class="ttdeci">#define CLUSTER_DEFAULT_REQUIRE_FULL_COVERAGE</div><div class="ttdef"><b>Definition:</b> <a href="cluster_8h_source.html#l00018">cluster.h:18</a></div></div>
<div class="ttc" id="server_8h_html_acf1f58ff0b6790cd8d0e3edf1a7e599f"><div class="ttname"><a href="server_8h.html#acf1f58ff0b6790cd8d0e3edf1a7e599f">CMD_STALE</a></div><div class="ttdeci">#define CMD_STALE</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00208">server.h:208</a></div></div>
<div class="ttc" id="server_8h_html_a395f766c5962e4ee2da01dee43600f7a"><div class="ttname"><a href="server_8h.html#a395f766c5962e4ee2da01dee43600f7a">PROTO_MAX_QUERYBUF_LEN</a></div><div class="ttdeci">#define PROTO_MAX_QUERYBUF_LEN</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00179">server.h:179</a></div></div>
<div class="ttc" id="server_8h_html_a7724350e4f0ddbf1c80740699fac78be"><div class="ttname"><a href="server_8h.html#a7724350e4f0ddbf1c80740699fac78be">CLIENT_MONITOR</a></div><div class="ttdeci">#define CLIENT_MONITOR</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00223">server.h:223</a></div></div>
<div class="ttc" id="server_8h_html_af07bcc4b15ed4f7aed3f6efcb483b75b"><div class="ttname"><a href="server_8h.html#af07bcc4b15ed4f7aed3f6efcb483b75b">CONFIG_DEFAULT_AOF_FSYNC</a></div><div class="ttdeci">#define CONFIG_DEFAULT_AOF_FSYNC</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00345">server.h:345</a></div></div>
<div class="ttc" id="server_8h_html_a333fe7f520eb6f33cd1c88e4691de3ed"><div class="ttname"><a href="server_8h.html#a333fe7f520eb6f33cd1c88e4691de3ed">OBJ_SET_MAX_INTSET_ENTRIES</a></div><div class="ttdeci">#define OBJ_SET_MAX_INTSET_ENTRIES</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00350">server.h:350</a></div></div>
<div class="ttc" id="server_8h_html_aba6794fa3ee28f85165eaed93190f1df"><div class="ttname"><a href="server_8h.html#aba6794fa3ee28f85165eaed93190f1df">CONFIG_RUN_ID_SIZE</a></div><div class="ttdeci">#define CONFIG_RUN_ID_SIZE</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00107">server.h:107</a></div></div>
<div class="ttc" id="structsharedObjectsStruct_html"><div class="ttname"><a href="structsharedObjectsStruct.html">sharedObjectsStruct</a></div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00754">server.h:754</a></div></div>
<div class="ttc" id="server_8h_html_a27e00ebd25c04beef22fabf61ea0b5ea"><div class="ttname"><a href="server_8h.html#a27e00ebd25c04beef22fabf61ea0b5ea">CONFIG_BGSAVE_RETRY_DELAY</a></div><div class="ttdeci">#define CONFIG_BGSAVE_RETRY_DELAY</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00112">server.h:112</a></div></div>
<div class="ttc" id="server_8h_html_a303769ef1065076e68731584e758d3e1"><div class="ttname"><a href="server_8h.html#a303769ef1065076e68731584e758d3e1">C_OK</a></div><div class="ttdeci">#define C_OK</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00078">server.h:78</a></div></div>
<div class="ttc" id="server_8h_html_ac29d7218c448fac5b27039cf0d73fde2"><div class="ttname"><a href="server_8h.html#ac29d7218c448fac5b27039cf0d73fde2">OBJ_ZSET_MAX_ZIPLIST_ENTRIES</a></div><div class="ttdeci">#define OBJ_ZSET_MAX_ZIPLIST_ENTRIES</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00351">server.h:351</a></div></div>
<div class="ttc" id="server_8h_html_ace54c14c3b13acbf1d7a6d6e893cdfd3"><div class="ttname"><a href="server_8h.html#ace54c14c3b13acbf1d7a6d6e893cdfd3">CONFIG_DEFAULT_SLAVE_LAZY_FLUSH</a></div><div class="ttdeci">#define CONFIG_DEFAULT_SLAVE_LAZY_FLUSH</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00153">server.h:153</a></div></div>
<div class="ttc" id="atomicvar_8h_html_ae3aa976bb329a4a554a853c5770c3e3d"><div class="ttname"><a href="atomicvar_8h.html#ae3aa976bb329a4a554a853c5770c3e3d">REDIS_ATOMIC_API</a></div><div class="ttdeci">#define REDIS_ATOMIC_API</div><div class="ttdef"><b>Definition:</b> <a href="atomicvar_8h_source.html#l00130">atomicvar.h:130</a></div></div>
<div class="ttc" id="server_8h_html_af563e9454f9a1ef49de787e4fc66c448"><div class="ttname"><a href="server_8h.html#af563e9454f9a1ef49de787e4fc66c448">CONFIG_DEFAULT_RDB_FILENAME</a></div><div class="ttdeci">#define CONFIG_DEFAULT_RDB_FILENAME</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00128">server.h:128</a></div></div>
<div class="ttc" id="server_8h_html_a311fc8b18b93af94e1ad418f1386b519"><div class="ttname"><a href="server_8h.html#a311fc8b18b93af94e1ad418f1386b519">OBJ_SHARED_INTEGERS</a></div><div class="ttdeci">#define OBJ_SHARED_INTEGERS</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00093">server.h:93</a></div></div>
<div class="ttc" id="adlist_8h_html_a3dac429a545f8def9a2bf9077eb66ddc"><div class="ttname"><a href="adlist_8h.html#a3dac429a545f8def9a2bf9077eb66ddc">listSetMatchMethod</a></div><div class="ttdeci">#define listSetMatchMethod(l, m)</div><div class="ttdef"><b>Definition:</b> <a href="adlist_8h_source.html#l00066">adlist.h:66</a></div></div>
<div class="ttc" id="server_8h_html_aca61db3dff4f6e864b3e49d3f087fb51"><div class="ttname"><a href="server_8h.html#aca61db3dff4f6e864b3e49d3f087fb51">CONFIG_DEFAULT_SLAVE_ANNOUNCE_IP</a></div><div class="ttdeci">#define CONFIG_DEFAULT_SLAVE_ANNOUNCE_IP</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00133">server.h:133</a></div></div>
<div class="ttc" id="server_8h_html_a0698b50ff7fe51afd74cf20a72b75e1b"><div class="ttname"><a href="server_8h.html#a0698b50ff7fe51afd74cf20a72b75e1b">CONFIG_DEFAULT_LOGFILE</a></div><div class="ttdeci">#define CONFIG_DEFAULT_LOGFILE</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00123">server.h:123</a></div></div>
<div class="ttc" id="adlist_8h_html_aa8dc514bbe217bb2e87c1c77cfa84690"><div class="ttname"><a href="adlist_8h.html#aa8dc514bbe217bb2e87c1c77cfa84690">listFirst</a></div><div class="ttdeci">#define listFirst(l)</div><div class="ttdef"><b>Definition:</b> <a href="adlist_8h_source.html#l00058">adlist.h:58</a></div></div>
<div class="ttc" id="config_8h_html_af5994c643c434574580bb7816af82cad"><div class="ttname"><a href="config_8h.html#af5994c643c434574580bb7816af82cad">aof_fsync</a></div><div class="ttdeci">#define aof_fsync</div><div class="ttdef"><b>Definition:</b> <a href="config_8h_source.html#l00094">config.h:94</a></div></div>
<div class="ttc" id="server_8h_html_a9d23ea1ff80f9db5faef6f5aca6f76aa"><div class="ttname"><a href="server_8h.html#a9d23ea1ff80f9db5faef6f5aca6f76aa">CONFIG_DEFAULT_DEFRAG_THRESHOLD_LOWER</a></div><div class="ttdeci">#define CONFIG_DEFAULT_DEFRAG_THRESHOLD_LOWER</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00159">server.h:159</a></div></div>
<div class="ttc" id="server_8h_html_aef97c640ad8dfdaca21eb67d4c37e447"><div class="ttname"><a href="server_8h.html#aef97c640ad8dfdaca21eb67d4c37e447">CMD_DENYOOM</a></div><div class="ttdeci">#define CMD_DENYOOM</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00200">server.h:200</a></div></div>
<div class="ttc" id="server_8h_html_a85f5870a07f58d1679988f7eb84ca995"><div class="ttname"><a href="server_8h.html#a85f5870a07f58d1679988f7eb84ca995">AOF_REWRITE_PERC</a></div><div class="ttdeci">#define AOF_REWRITE_PERC</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00096">server.h:96</a></div></div>
<div class="ttc" id="server_8h_html_a050e337ffdb94f18e190cc6d6d851196"><div class="ttname"><a href="server_8h.html#a050e337ffdb94f18e190cc6d6d851196">CONFIG_DEFAULT_STOP_WRITES_ON_BGSAVE_ERROR</a></div><div class="ttdeci">#define CONFIG_DEFAULT_STOP_WRITES_ON_BGSAVE_ERROR</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00125">server.h:125</a></div></div>
<div class="ttc" id="server_8h_html_aff2f6e62c729d3f8b119d761818be317"><div class="ttname"><a href="server_8h.html#aff2f6e62c729d3f8b119d761818be317">OBJ_SHARED_BULKHDR_LEN</a></div><div class="ttdeci">#define OBJ_SHARED_BULKHDR_LEN</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00094">server.h:94</a></div></div>
<div class="ttc" id="server_8h_html_a201d97fc457fe5bd58cb863b4ac7a0cc"><div class="ttname"><a href="server_8h.html#a201d97fc457fe5bd58cb863b4ac7a0cc">CMD_PUBSUB</a></div><div class="ttdeci">#define CMD_PUBSUB</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00203">server.h:203</a></div></div>
<div class="ttc" id="structclient_html"><div class="ttname"><a href="structclient.html">client</a></div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00686">server.h:686</a></div></div>
<div class="ttc" id="server_8h_html_aee54cf0e2819c8b96136987f0f8ef0b8"><div class="ttname"><a href="server_8h.html#aee54cf0e2819c8b96136987f0f8ef0b8">CONFIG_DEFAULT_REPL_DISKLESS_SYNC_DELAY</a></div><div class="ttdeci">#define CONFIG_DEFAULT_REPL_DISKLESS_SYNC_DELAY</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00130">server.h:130</a></div></div>
<div class="ttc" id="server_8h_html_a170ee2dd8cfefaf0d112edcc3152f8d7"><div class="ttname"><a href="server_8h.html#a170ee2dd8cfefaf0d112edcc3152f8d7">SLAVE_STATE_WAIT_BGSAVE_START</a></div><div class="ttdeci">#define SLAVE_STATE_WAIT_BGSAVE_START</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00301">server.h:301</a></div></div>
<div class="ttc" id="structredisCommand_html"><div class="ttname"><a href="structredisCommand.html">redisCommand</a></div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l01224">server.h:1224</a></div></div>
<div class="ttc" id="server_8h_html_aea3bfee2e140aed0fc93bf087026f9a3"><div class="ttname"><a href="server_8h.html#aea3bfee2e140aed0fc93bf087026f9a3">CLIENT_PREVENT_PROP</a></div><div class="ttdeci">#define CLIENT_PREVENT_PROP</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00243">server.h:243</a></div></div>
<div class="ttc" id="server_8h_html_a7f61f783f429419f8c593291a509b03a"><div class="ttname"><a href="server_8h.html#a7f61f783f429419f8c593291a509b03a">CLIENT_MULTI</a></div><div class="ttdeci">#define CLIENT_MULTI</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00224">server.h:224</a></div></div>
<div class="ttc" id="server_8h_html_a5b0c46fd63529819e2c0189003d72122"><div class="ttname"><a href="server_8h.html#a5b0c46fd63529819e2c0189003d72122">CONFIG_DEFAULT_CLUSTER_CONFIG_FILE</a></div><div class="ttdeci">#define CONFIG_DEFAULT_CLUSTER_CONFIG_FILE</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00115">server.h:115</a></div></div>
<div class="ttc" id="server_8h_html_aaab0790ee1a625276dce078a9dbbe075"><div class="ttname"><a href="server_8h.html#aaab0790ee1a625276dce078a9dbbe075">CRON_DBS_PER_CALL</a></div><div class="ttdeci">#define CRON_DBS_PER_CALL</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00090">server.h:90</a></div></div>
<div class="ttc" id="server_8h_html_a6725c1ff5b6a17f930627263f484d107"><div class="ttname"><a href="server_8h.html#a6725c1ff5b6a17f930627263f484d107">CONFIG_FDSET_INCR</a></div><div class="ttdeci">#define CONFIG_FDSET_INCR</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00191">server.h:191</a></div></div>
<div class="ttc" id="server_8h_html_ada761b94960fa20ff86d56b403b26861"><div class="ttname"><a href="server_8h.html#ada761b94960fa20ff86d56b403b26861">SHUTDOWN_SAVE</a></div><div class="ttdeci">#define SHUTDOWN_SAVE</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00395">server.h:395</a></div></div>
<div class="ttc" id="server_8h_html_a43e2aecb49a88a6cd4e56bfa971bdc71"><div class="ttname"><a href="server_8h.html#a43e2aecb49a88a6cd4e56bfa971bdc71">CMD_SKIP_MONITOR</a></div><div class="ttdeci">#define CMD_SKIP_MONITOR</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00209">server.h:209</a></div></div>
<div class="ttc" id="server_8h_html_aa84cedc4d9e3da82d28324a85626a666"><div class="ttname"><a href="server_8h.html#aa84cedc4d9e3da82d28324a85626a666">CONFIG_DEFAULT_PROTECTED_MODE</a></div><div class="ttdeci">#define CONFIG_DEFAULT_PROTECTED_MODE</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00122">server.h:122</a></div></div>
<div class="ttc" id="server_8h_html_a20a7f934b2eceae8fdbb1ac112a783c3"><div class="ttname"><a href="server_8h.html#a20a7f934b2eceae8fdbb1ac112a783c3">CONFIG_DEFAULT_LATENCY_MONITOR_THRESHOLD</a></div><div class="ttdeci">#define CONFIG_DEFAULT_LATENCY_MONITOR_THRESHOLD</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00152">server.h:152</a></div></div>
<div class="ttc" id="server_8h_html_a41a8473748a5eeafbd30b20f22177c51"><div class="ttname"><a href="server_8h.html#a41a8473748a5eeafbd30b20f22177c51">OBJ_HASH_MAX_ZIPLIST_ENTRIES</a></div><div class="ttdeci">#define OBJ_HASH_MAX_ZIPLIST_ENTRIES</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00348">server.h:348</a></div></div>
<div class="ttc" id="server_8h_html_a6d217560ae714ab8d0cc21832b210e0b"><div class="ttname"><a href="server_8h.html#a6d217560ae714ab8d0cc21832b210e0b">STATS_METRIC_NET_INPUT</a></div><div class="ttdeci">#define STATS_METRIC_NET_INPUT</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00174">server.h:174</a></div></div>
<div class="ttc" id="server_8h_html_a1d6ca2cad092805de3acd7b74876a323"><div class="ttname"><a href="server_8h.html#a1d6ca2cad092805de3acd7b74876a323">CONFIG_DEFAULT_CLIENT_TIMEOUT</a></div><div class="ttdeci">#define CONFIG_DEFAULT_CLIENT_TIMEOUT</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00087">server.h:87</a></div></div>
<div class="ttc" id="server_8c_html_a79785342d159d7e8dc4547ffb330835d"><div class="ttname"><a href="server_8c.html#a79785342d159d7e8dc4547ffb330835d">CLIENTS_CRON_MIN_ITERATIONS</a></div><div class="ttdeci">#define CLIENTS_CRON_MIN_ITERATIONS</div><div class="ttdef"><b>Definition:</b> <a href="server_8c_source.html#l00852">server.c:852</a></div></div>
<div class="ttc" id="server_8h_html_a8cff2154afcc2e87ac85bdbbe2814091"><div class="ttname"><a href="server_8h.html#a8cff2154afcc2e87ac85bdbbe2814091">CLIENT_CLOSE_AFTER_REPLY</a></div><div class="ttdeci">#define CLIENT_CLOSE_AFTER_REPLY</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00227">server.h:227</a></div></div>
<div class="ttc" id="server_8h_html_a7d4b86c89be4d951fbf048130431a16a"><div class="ttname"><a href="server_8h.html#a7d4b86c89be4d951fbf048130431a16a">AOF_WAIT_REWRITE</a></div><div class="ttdeci">#define AOF_WAIT_REWRITE</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00218">server.h:218</a></div></div>
<div class="ttc" id="server_8h_html_a8e9d7cd814b95c2cbd17701efe1374f2"><div class="ttname"><a href="server_8h.html#a8e9d7cd814b95c2cbd17701efe1374f2">CONFIG_AUTHPASS_MAX_LEN</a></div><div class="ttdeci">#define CONFIG_AUTHPASS_MAX_LEN</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00103">server.h:103</a></div></div>
<div class="ttc" id="server_8h_html_aa5a3b127e21d6bf089025d953c44678a"><div class="ttname"><a href="server_8h.html#aa5a3b127e21d6bf089025d953c44678a">CONFIG_DEFAULT_HZ</a></div><div class="ttdeci">#define CONFIG_DEFAULT_HZ</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00082">server.h:82</a></div></div>
<div class="ttc" id="server_8h_html_af951fdb3aa8efbce7cde83e8a31fff6a"><div class="ttname"><a href="server_8h.html#af951fdb3aa8efbce7cde83e8a31fff6a">RESTART_SERVER_GRACEFULLY</a></div><div class="ttdeci">#define RESTART_SERVER_GRACEFULLY</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l01655">server.h:1655</a></div></div>
<div class="ttc" id="server_8h_html_a934cea7b13db05a29264146cd5b14064"><div class="ttname"><a href="server_8h.html#a934cea7b13db05a29264146cd5b14064">CMD_CALL_SLOWLOG</a></div><div class="ttdeci">#define CMD_CALL_SLOWLOG</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00401">server.h:401</a></div></div>
<div class="ttc" id="server_8h_html_a256b9506e551eaa7417f75f8fa9ed901"><div class="ttname"><a href="server_8h.html#a256b9506e551eaa7417f75f8fa9ed901">REPL_STATE_NONE</a></div><div class="ttdeci">#define REPL_STATE_NONE</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00278">server.h:278</a></div></div>
<div class="ttc" id="server_8h_html_ac7414291a371fd3a2bad4d34e13f0d77"><div class="ttname"><a href="server_8h.html#ac7414291a371fd3a2bad4d34e13f0d77">CONFIG_DEFAULT_SYSLOG_IDENT</a></div><div class="ttdeci">#define CONFIG_DEFAULT_SYSLOG_IDENT</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00114">server.h:114</a></div></div>
<div class="ttc" id="server_8h_html_ac8d50898802f96b76479bc975e1bbbf3"><div class="ttname"><a href="server_8h.html#ac8d50898802f96b76479bc975e1bbbf3">STATS_METRIC_COMMAND</a></div><div class="ttdeci">#define STATS_METRIC_COMMAND</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00173">server.h:173</a></div></div>
<div class="ttc" id="server_8h_html_a22c57e53d530d95ae346f13d6781a549"><div class="ttname"><a href="server_8h.html#a22c57e53d530d95ae346f13d6781a549">CONFIG_DEFAULT_SYSLOG_ENABLED</a></div><div class="ttdeci">#define CONFIG_DEFAULT_SYSLOG_ENABLED</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00124">server.h:124</a></div></div>
<div class="ttc" id="server_8h_html_a834b7e50f783a1eeaa1feea05fce199e"><div class="ttname"><a href="server_8h.html#a834b7e50f783a1eeaa1feea05fce199e">SHUTDOWN_NOSAVE</a></div><div class="ttdeci">#define SHUTDOWN_NOSAVE</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00397">server.h:397</a></div></div>
<div class="ttc" id="server_8h_html_af0b13ef0f1dabe404fd7d904cb66b548"><div class="ttname"><a href="server_8h.html#af0b13ef0f1dabe404fd7d904cb66b548">CMD_ASKING</a></div><div class="ttdeci">#define CMD_ASKING</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00210">server.h:210</a></div></div>
<div class="ttc" id="server_8h_html_aeb204872adbaabc0bd56c64f562b7928"><div class="ttname"><a href="server_8h.html#aeb204872adbaabc0bd56c64f562b7928">run_with_period</a></div><div class="ttdeci">#define run_with_period(_ms_)</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00439">server.h:439</a></div></div>
<div class="ttc" id="server_8h_html_af9b93e225d47183c97bc1f86db1aff2a"><div class="ttname"><a href="server_8h.html#af9b93e225d47183c97bc1f86db1aff2a">CONFIG_DEFAULT_SLAVE_READ_ONLY</a></div><div class="ttdeci">#define CONFIG_DEFAULT_SLAVE_READ_ONLY</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00132">server.h:132</a></div></div>
<div class="ttc" id="server_8h_html_aed98ddd341b643d52417b875418b2ecb"><div class="ttname"><a href="server_8h.html#aed98ddd341b643d52417b875418b2ecb">CONFIG_DEFAULT_DEFRAG_IGNORE_BYTES</a></div><div class="ttdeci">#define CONFIG_DEFAULT_DEFRAG_IGNORE_BYTES</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00161">server.h:161</a></div></div>
<div class="ttc" id="server_8h_html_a938328826b94d0e9bd07b225767cad43"><div class="ttname"><a href="server_8h.html#a938328826b94d0e9bd07b225767cad43">CONFIG_DEFAULT_AOF_USE_RDB_PREAMBLE</a></div><div class="ttdeci">#define CONFIG_DEFAULT_AOF_USE_RDB_PREAMBLE</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00143">server.h:143</a></div></div>
<div class="ttc" id="server_8h_html_a7608d2301c8447e2237ba173d8eef88e"><div class="ttname"><a href="server_8h.html#a7608d2301c8447e2237ba173d8eef88e">CONFIG_DEFAULT_REPL_TIMEOUT</a></div><div class="ttdeci">#define CONFIG_DEFAULT_REPL_TIMEOUT</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00105">server.h:105</a></div></div>
<div class="ttc" id="server_8h_html_a0c7409da047d754c0adeb001025acc03"><div class="ttname"><a href="server_8h.html#a0c7409da047d754c0adeb001025acc03">PROPAGATE_NONE</a></div><div class="ttdeci">#define PROPAGATE_NONE</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00409">server.h:409</a></div></div>
<div class="ttc" id="server_8h_html_a1d27594a2d9c8d24e4ed5a2e88d1113e"><div class="ttname"><a href="server_8h.html#a1d27594a2d9c8d24e4ed5a2e88d1113e">REPL_STATE_TRANSFER</a></div><div class="ttdeci">#define REPL_STATE_TRANSFER</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00294">server.h:294</a></div></div>
<div class="ttc" id="server_8h_html_a65236ea160f69cdef33ec942092af88f"><div class="ttname"><a href="server_8h.html#a65236ea160f69cdef33ec942092af88f">OBJ_STRING</a></div><div class="ttdeci">#define OBJ_STRING</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00453">server.h:453</a></div></div>
<div class="ttc" id="server_8h_html_a0f350070473d6d89bcd365ea4ff361cb"><div class="ttname"><a href="server_8h.html#a0f350070473d6d89bcd365ea4ff361cb">CONFIG_DEFAULT_ALWAYS_SHOW_LOGO</a></div><div class="ttdeci">#define CONFIG_DEFAULT_ALWAYS_SHOW_LOGO</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00157">server.h:157</a></div></div>
<div class="ttc" id="server_8h_html_a2a0d6ba64b419357e52a6473f48bc882"><div class="ttname"><a href="server_8h.html#a2a0d6ba64b419357e52a6473f48bc882">SUPERVISED_NONE</a></div><div class="ttdeci">#define SUPERVISED_NONE</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00330">server.h:330</a></div></div>
<div class="ttc" id="server_8h_html_a3d8f0cc8d0653ee2b6dafb454292c069"><div class="ttname"><a href="server_8h.html#a3d8f0cc8d0653ee2b6dafb454292c069">CLIENT_MASTER</a></div><div class="ttdeci">#define CLIENT_MASTER</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00222">server.h:222</a></div></div>
<div class="ttc" id="server_8h_html_a250e4ab3a143ecbce2603ffaa3a29c0a"><div class="ttname"><a href="server_8h.html#a250e4ab3a143ecbce2603ffaa3a29c0a">CONFIG_DEFAULT_RDB_COMPRESSION</a></div><div class="ttdeci">#define CONFIG_DEFAULT_RDB_COMPRESSION</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00126">server.h:126</a></div></div>
<div class="ttc" id="server_8h_html_a27f51044a8a11ab99366a77bb3ea1e93"><div class="ttname"><a href="server_8h.html#a27f51044a8a11ab99366a77bb3ea1e93">CONFIG_DEFAULT_REPL_DISABLE_TCP_NODELAY</a></div><div class="ttdeci">#define CONFIG_DEFAULT_REPL_DISABLE_TCP_NODELAY</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00135">server.h:135</a></div></div>
<div class="ttc" id="server_8h_html_a3cf317db9aeeba99be3654b11d3d0580"><div class="ttname"><a href="server_8h.html#a3cf317db9aeeba99be3654b11d3d0580">CONFIG_DEFAULT_SLOWLOG_LOG_SLOWER_THAN</a></div><div class="ttdeci">#define CONFIG_DEFAULT_SLOWLOG_LOG_SLOWER_THAN</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00100">server.h:100</a></div></div>
<div class="ttc" id="server_8h_html_a35b94be7201c7ad80e43f8aa214867b7"><div class="ttname"><a href="server_8h.html#a35b94be7201c7ad80e43f8aa214867b7">CONFIG_DEFAULT_AOF_LOAD_TRUNCATED</a></div><div class="ttdeci">#define CONFIG_DEFAULT_AOF_LOAD_TRUNCATED</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00142">server.h:142</a></div></div>
<div class="ttc" id="server_8h_html_a24b004e72489e83f721bdd334234aa49"><div class="ttname"><a href="server_8h.html#a24b004e72489e83f721bdd334234aa49">OBJ_ZSET_MAX_ZIPLIST_VALUE</a></div><div class="ttdeci">#define OBJ_ZSET_MAX_ZIPLIST_VALUE</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00352">server.h:352</a></div></div>
<div class="ttc" id="server_8h_html_a6ac2fd3dd83df43a6b262bab091bc371"><div class="ttname"><a href="server_8h.html#a6ac2fd3dd83df43a6b262bab091bc371">CONFIG_DEFAULT_REPL_BACKLOG_SIZE</a></div><div class="ttdeci">#define CONFIG_DEFAULT_REPL_BACKLOG_SIZE</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00109">server.h:109</a></div></div>
<div class="ttc" id="server_8h_html_ac5c5c62f45277671484daad919338b5e"><div class="ttname"><a href="server_8h.html#ac5c5c62f45277671484daad919338b5e">CONFIG_DEFAULT_REPL_BACKLOG_TIME_LIMIT</a></div><div class="ttdeci">#define CONFIG_DEFAULT_REPL_BACKLOG_TIME_LIMIT</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00110">server.h:110</a></div></div>
<div class="ttc" id="server_8h_html_acfd6e0670ac08e8f4c13f33c8a2c6b5e"><div class="ttname"><a href="server_8h.html#acfd6e0670ac08e8f4c13f33c8a2c6b5e">RDB_CHILD_TYPE_NONE</a></div><div class="ttdeci">#define RDB_CHILD_TYPE_NONE</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00414">server.h:414</a></div></div>
<div class="ttc" id="server_8h_html_ada65a939812527070ed001e451d9bc54"><div class="ttname"><a href="server_8h.html#ada65a939812527070ed001e451d9bc54">CONFIG_DEFAULT_SLOWLOG_MAX_LEN</a></div><div class="ttdeci">#define CONFIG_DEFAULT_SLOWLOG_MAX_LEN</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00101">server.h:101</a></div></div>
<div class="ttc" id="server_8h_html_a5d49d5c9a11564577f7e78d6f52d9db5"><div class="ttname"><a href="server_8h.html#a5d49d5c9a11564577f7e78d6f52d9db5">CONFIG_DEFAULT_DEFRAG_CYCLE_MIN</a></div><div class="ttdeci">#define CONFIG_DEFAULT_DEFRAG_CYCLE_MIN</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00162">server.h:162</a></div></div>
<div class="ttc" id="server_8h_html_ad895fdf16e5ed5275d19ddf8578b900f"><div class="ttname"><a href="server_8h.html#ad895fdf16e5ed5275d19ddf8578b900f">SLAVE_STATE_ONLINE</a></div><div class="ttdeci">#define SLAVE_STATE_ONLINE</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00304">server.h:304</a></div></div>
<div class="ttc" id="cluster_8h_html_a44b183827017eca27648d5991fc50b13"><div class="ttname"><a href="cluster_8h.html#a44b183827017eca27648d5991fc50b13">CLUSTER_DEFAULT_SLAVE_VALIDITY</a></div><div class="ttdeci">#define CLUSTER_DEFAULT_SLAVE_VALIDITY</div><div class="ttdef"><b>Definition:</b> <a href="cluster_8h_source.html#l00017">cluster.h:17</a></div></div>
<div class="ttc" id="server_8h_html_a9f89484284fb0956374bd7b6fa639602"><div class="ttname"><a href="server_8h.html#a9f89484284fb0956374bd7b6fa639602">CLIENT_FORCE_REPL</a></div><div class="ttdeci">#define CLIENT_FORCE_REPL</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00237">server.h:237</a></div></div>
<div class="ttc" id="server_8h_html_ad0a549a4ce81a4436199706f3513bbc2"><div class="ttname"><a href="server_8h.html#ad0a549a4ce81a4436199706f3513bbc2">CONFIG_DEFAULT_PID_FILE</a></div><div class="ttdeci">#define CONFIG_DEFAULT_PID_FILE</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00113">server.h:113</a></div></div>
<div class="ttc" id="structsaveparam_html"><div class="ttname"><a href="structsaveparam.html">saveparam</a></div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00743">server.h:743</a></div></div>
<div class="ttc" id="server_8h_html_a9f6608fefa355981c2a865ef3d44f196"><div class="ttname"><a href="server_8h.html#a9f6608fefa355981c2a865ef3d44f196">CMD_RANDOM</a></div><div class="ttdeci">#define CMD_RANDOM</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00205">server.h:205</a></div></div>
<div class="ttc" id="server_8h_html_af9d0b0f45ef2c1fd29ac714a300de706"><div class="ttname"><a href="server_8h.html#af9d0b0f45ef2c1fd29ac714a300de706">CLIENT_LUA</a></div><div class="ttdeci">#define CLIENT_LUA</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00230">server.h:230</a></div></div>
<div class="ttc" id="server_8h_html_ab24065d7a9205264189681ab4e4d410e"><div class="ttname"><a href="server_8h.html#ab24065d7a9205264189681ab4e4d410e">CONFIG_DEFAULT_MAX_CLIENTS</a></div><div class="ttdeci">#define CONFIG_DEFAULT_MAX_CLIENTS</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00102">server.h:102</a></div></div>
<div class="ttc" id="dict_8h_html_aa077e877a37a7dc65056290a2c9760da"><div class="ttname"><a href="dict_8h.html#aa077e877a37a7dc65056290a2c9760da">DICT_NOTUSED</a></div><div class="ttdeci">#define DICT_NOTUSED(V)</div><div class="ttdef"><b>Definition:</b> <a href="dict_8h_source.html#l00045">dict.h:45</a></div></div>
<div class="ttc" id="server_8h_html_aab8d0fb9427699c23cdbeb524f875562"><div class="ttname"><a href="server_8h.html#aab8d0fb9427699c23cdbeb524f875562">HASHTABLE_MIN_FILL</a></div><div class="ttdeci">#define HASHTABLE_MIN_FILL</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00194">server.h:194</a></div></div>
<div class="ttc" id="server_8h_html_a01c18c16bc758787b5cfc287eb7b089e"><div class="ttname"><a href="server_8h.html#a01c18c16bc758787b5cfc287eb7b089e">CLIENT_PREVENT_REPL_PROP</a></div><div class="ttdeci">#define CLIENT_PREVENT_REPL_PROP</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00242">server.h:242</a></div></div>
<div class="ttc" id="server_8h_html_a2c8d2290c3ac70d63ed2e62b11ab566b"><div class="ttname"><a href="server_8h.html#a2c8d2290c3ac70d63ed2e62b11ab566b">CONFIG_DEFAULT_TCP_KEEPALIVE</a></div><div class="ttdeci">#define CONFIG_DEFAULT_TCP_KEEPALIVE</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00121">server.h:121</a></div></div>
<div class="ttc" id="server_8h_html_a612a8681d1a25cd86faf4139d161316a"><div class="ttname"><a href="server_8h.html#a612a8681d1a25cd86faf4139d161316a">CMD_MODULE_GETKEYS</a></div><div class="ttdeci">#define CMD_MODULE_GETKEYS</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00212">server.h:212</a></div></div>
<div class="ttc" id="dict_8h_html_ae8d2cc391873b2bea2b87c4f80f43120"><div class="ttname"><a href="dict_8h.html#ae8d2cc391873b2bea2b87c4f80f43120">dictGetVal</a></div><div class="ttdeci">#define dictGetVal(he)</div><div class="ttdef"><b>Definition:</b> <a href="dict_8h_source.html#l00142">dict.h:142</a></div></div>
<div class="ttc" id="server_8h_html_ad97c5405ed22a94e9fcc10fba577d6c0"><div class="ttname"><a href="server_8h.html#ad97c5405ed22a94e9fcc10fba577d6c0">NET_IP_STR_LEN</a></div><div class="ttdeci">#define NET_IP_STR_LEN</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00148">server.h:148</a></div></div>
<div class="ttc" id="server_8h_html_a3885f356f3a4cef22eb96fbfcc406333"><div class="ttname"><a href="server_8h.html#a3885f356f3a4cef22eb96fbfcc406333">STATS_METRIC_NET_OUTPUT</a></div><div class="ttdeci">#define STATS_METRIC_NET_OUTPUT</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00175">server.h:175</a></div></div>
<div class="ttc" id="dict_8h_html_af193430dd3d5579a52b194512f72c1f0"><div class="ttname"><a href="dict_8h.html#af193430dd3d5579a52b194512f72c1f0">dictSize</a></div><div class="ttdeci">#define dictSize(d)</div><div class="ttdef"><b>Definition:</b> <a href="dict_8h_source.html#l00147">dict.h:147</a></div></div>
<div class="ttc" id="atomicvar_8h_html_a0f02b5846dcf4ed3669ecf771c512d12"><div class="ttname"><a href="atomicvar_8h.html#a0f02b5846dcf4ed3669ecf771c512d12">atomicSet</a></div><div class="ttdeci">#define atomicSet(var, value)</div><div class="ttdef"><b>Definition:</b> <a href="atomicvar_8h_source.html#l00125">atomicvar.h:125</a></div></div>
<div class="ttc" id="server_8h_html_a9b5a91047aa18eb5df52e99c97afab84"><div class="ttname"><a href="server_8h.html#a9b5a91047aa18eb5df52e99c97afab84">AOF_REWRITE_MIN_SIZE</a></div><div class="ttdeci">#define AOF_REWRITE_MIN_SIZE</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00097">server.h:97</a></div></div>
<div class="ttc" id="server_8h_html_ac8ad217da6cfbdf399948aff4d3550ca"><div class="ttname"><a href="server_8h.html#ac8ad217da6cfbdf399948aff4d3550ca">CONFIG_DEFAULT_SLAVE_ANNOUNCE_PORT</a></div><div class="ttdeci">#define CONFIG_DEFAULT_SLAVE_ANNOUNCE_PORT</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00134">server.h:134</a></div></div>
<div class="ttc" id="server_8h_html_a8c54c191e436c7dd3012167212692401"><div class="ttname"><a href="server_8h.html#a8c54c191e436c7dd3012167212692401">LL_NOTICE</a></div><div class="ttdeci">#define LL_NOTICE</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00324">server.h:324</a></div></div>
<div class="ttc" id="bio_8h_html_a5d03c967316addafc61b7ed5d957984f"><div class="ttname"><a href="bio_8h.html#a5d03c967316addafc61b7ed5d957984f">BIO_AOF_FSYNC</a></div><div class="ttdeci">#define BIO_AOF_FSYNC</div><div class="ttdef"><b>Definition:</b> <a href="bio_8h_source.html#l00040">bio.h:40</a></div></div>
<div class="ttc" id="adlist_8h_html_a648e4a2d20decff3182a72a608b0b8f2"><div class="ttname"><a href="adlist_8h.html#a648e4a2d20decff3182a72a608b0b8f2">listSetFreeMethod</a></div><div class="ttdeci">#define listSetFreeMethod(l, m)</div><div class="ttdef"><b>Definition:</b> <a href="adlist_8h_source.html#l00065">adlist.h:65</a></div></div>
<div class="ttc" id="server_8h_html_a37cd05cbfd7fb52ad21d3a822cff2ee6"><div class="ttname"><a href="server_8h.html#a37cd05cbfd7fb52ad21d3a822cff2ee6">LOG_MAX_LEN</a></div><div class="ttdeci">#define LOG_MAX_LEN</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00095">server.h:95</a></div></div>
<div class="ttc" id="dict_8h_html_aff97c19d1616cf2c697573ee3f515692"><div class="ttname"><a href="dict_8h.html#aff97c19d1616cf2c697573ee3f515692">DICT_HT_INITIAL_SIZE</a></div><div class="ttdeci">#define DICT_HT_INITIAL_SIZE</div><div class="ttdef"><b>Definition:</b> <a href="dict_8h_source.html#l00101">dict.h:101</a></div></div>
<div class="ttc" id="server_8h_html_aea8f6f3fac3a68e35807eba109dbc501"><div class="ttname"><a href="server_8h.html#aea8f6f3fac3a68e35807eba109dbc501">CLIENT_TYPE_OBUF_COUNT</a></div><div class="ttdeci">#define CLIENT_TYPE_OBUF_COUNT</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00272">server.h:272</a></div></div>
<div class="ttc" id="server_8h_html_a0b8729bdfd537311480f4c3bb3a20905"><div class="ttname"><a href="server_8h.html#a0b8729bdfd537311480f4c3bb3a20905">CONFIG_DEFAULT_CLUSTER_ANNOUNCE_IP</a></div><div class="ttdeci">#define CONFIG_DEFAULT_CLUSTER_ANNOUNCE_IP</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00116">server.h:116</a></div></div>
<div class="ttc" id="server_8h_html_ae265e849da28d7e7793659e45579ee11"><div class="ttname"><a href="server_8h.html#ae265e849da28d7e7793659e45579ee11">ACTIVE_EXPIRE_CYCLE_FAST</a></div><div class="ttdeci">#define ACTIVE_EXPIRE_CYCLE_FAST</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00169">server.h:169</a></div></div>
<div class="ttc" id="server_8h_html_a20f2f5380db97cd09013118ffc9411cc"><div class="ttname"><a href="server_8h.html#a20f2f5380db97cd09013118ffc9411cc">CLIENT_PUBSUB</a></div><div class="ttdeci">#define CLIENT_PUBSUB</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00240">server.h:240</a></div></div>
<div class="ttc" id="server_8h_html_a75b8ce2fafb93ddeb96f0e5602c2bd0c"><div class="ttname"><a href="server_8h.html#a75b8ce2fafb93ddeb96f0e5602c2bd0c">CONFIG_DEFAULT_DEFRAG_THRESHOLD_UPPER</a></div><div class="ttdeci">#define CONFIG_DEFAULT_DEFRAG_THRESHOLD_UPPER</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00160">server.h:160</a></div></div>
<div class="ttc" id="dict_8h_html_a2afecbeab8f7efbc183048f52f6d17e5"><div class="ttname"><a href="dict_8h.html#a2afecbeab8f7efbc183048f52f6d17e5">DICT_OK</a></div><div class="ttdeci">#define DICT_OK</div><div class="ttdef"><b>Definition:</b> <a href="dict_8h_source.html#l00041">dict.h:41</a></div></div>
<div class="ttc" id="anet_8h_html_a0697b7774a7e0f4ef141839fe93536fe"><div class="ttname"><a href="anet_8h.html#a0697b7774a7e0f4ef141839fe93536fe">ANET_ERR</a></div><div class="ttdeci">#define ANET_ERR</div><div class="ttdef"><b>Definition:</b> <a href="anet_8h_source.html#l00037">anet.h:37</a></div></div>
<div class="ttc" id="cluster_8h_html_a1895138f4125c5dce77e8fe28c9bd8d1"><div class="ttname"><a href="cluster_8h.html#a1895138f4125c5dce77e8fe28c9bd8d1">CLUSTER_DEFAULT_MIGRATION_BARRIER</a></div><div class="ttdeci">#define CLUSTER_DEFAULT_MIGRATION_BARRIER</div><div class="ttdef"><b>Definition:</b> <a href="cluster_8h_source.html#l00023">cluster.h:23</a></div></div>
<div class="ttc" id="server_8h_html_a62e5b6ba358ddcdef709e107e4d24744"><div class="ttname"><a href="server_8h.html#a62e5b6ba358ddcdef709e107e4d24744">ACTIVE_EXPIRE_CYCLE_SLOW</a></div><div class="ttdeci">#define ACTIVE_EXPIRE_CYCLE_SLOW</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00168">server.h:168</a></div></div>
<div class="ttc" id="server_8h_html_afc9f3396e2da1194ef2ccc6ab97d4e3d"><div class="ttname"><a href="server_8h.html#afc9f3396e2da1194ef2ccc6ab97d4e3d">CONFIG_DEFAULT_SERVER_PORT</a></div><div class="ttdeci">#define CONFIG_DEFAULT_SERVER_PORT</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00085">server.h:85</a></div></div>
<div class="ttc" id="server_8h_html_a08ebaf972da18ad58c71c615aa26c5cf"><div class="ttname"><a href="server_8h.html#a08ebaf972da18ad58c71c615aa26c5cf">CONFIG_DEFAULT_REPL_DISKLESS_SYNC</a></div><div class="ttdeci">#define CONFIG_DEFAULT_REPL_DISKLESS_SYNC</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00129">server.h:129</a></div></div>
<div class="ttc" id="server_8h_html_ae934cf008a0be0ef009c92c2d006a816"><div class="ttname"><a href="server_8h.html#ae934cf008a0be0ef009c92c2d006a816">OBJ_ENCODING_INT</a></div><div class="ttdeci">#define OBJ_ENCODING_INT</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00574">server.h:574</a></div></div>
<div class="ttc" id="server_8h_html_a1917805ea3942a4784ec806c33bc6033"><div class="ttname"><a href="server_8h.html#a1917805ea3942a4784ec806c33bc6033">CMD_ADMIN</a></div><div class="ttdeci">#define CMD_ADMIN</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00202">server.h:202</a></div></div>
<div class="ttc" id="server_8h_html_a1783425a4095949ab8b23ae4cbe0e576"><div class="ttname"><a href="server_8h.html#a1783425a4095949ab8b23ae4cbe0e576">CONFIG_DEFAULT_DAEMONIZE</a></div><div class="ttdeci">#define CONFIG_DEFAULT_DAEMONIZE</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00119">server.h:119</a></div></div>
<div class="ttc" id="atomicvar_8h_html_a57b17e058ecff6871debb3d1d4f3031a"><div class="ttname"><a href="atomicvar_8h.html#a57b17e058ecff6871debb3d1d4f3031a">atomicGet</a></div><div class="ttdeci">#define atomicGet(var, dstvar)</div><div class="ttdef"><b>Definition:</b> <a href="atomicvar_8h_source.html#l00120">atomicvar.h:120</a></div></div>
<div class="ttc" id="server_8h_html_afcfb5bd97af52d1dbce331745cae030c"><div class="ttname"><a href="server_8h.html#afcfb5bd97af52d1dbce331745cae030c">sdsEncodedObject</a></div><div class="ttdeci">#define sdsEncodedObject(objptr)</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l01487">server.h:1487</a></div></div>
<div class="ttc" id="server_8h_html_a147863f3b338d25f54e026d88a487010"><div class="ttname"><a href="server_8h.html#a147863f3b338d25f54e026d88a487010">CONFIG_DEFAULT_ACTIVE_REHASHING</a></div><div class="ttdeci">#define CONFIG_DEFAULT_ACTIVE_REHASHING</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00144">server.h:144</a></div></div>
<div class="ttc" id="server_8h_html_a7b811522f7befdc10e69883f360e45b4"><div class="ttname"><a href="server_8h.html#a7b811522f7befdc10e69883f360e45b4">OBJ_LIST_COMPRESS_DEPTH</a></div><div class="ttdeci">#define OBJ_LIST_COMPRESS_DEPTH</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00356">server.h:356</a></div></div>
<div class="ttc" id="server_8h_html_ac3f69c7e78a189639eab66a2b32753d0"><div class="ttname"><a href="server_8h.html#ac3f69c7e78a189639eab66a2b32753d0">CONFIG_DEFAULT_DEFRAG_CYCLE_MAX</a></div><div class="ttdeci">#define CONFIG_DEFAULT_DEFRAG_CYCLE_MAX</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00163">server.h:163</a></div></div>
<div class="ttc" id="server_8h_html_a479f69398ffb0f86fdbb4fa03876bc69"><div class="ttname"><a href="server_8h.html#a479f69398ffb0f86fdbb4fa03876bc69">CONFIG_DEFAULT_HLL_SPARSE_MAX_BYTES</a></div><div class="ttdeci">#define CONFIG_DEFAULT_HLL_SPARSE_MAX_BYTES</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00359">server.h:359</a></div></div>
<div class="ttc" id="server_8h_html_a7effaf912f26a1eabe495e899d705fee"><div class="ttname"><a href="server_8h.html#a7effaf912f26a1eabe495e899d705fee">CONFIG_DEFAULT_SLAVE_PRIORITY</a></div><div class="ttdeci">#define CONFIG_DEFAULT_SLAVE_PRIORITY</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00104">server.h:104</a></div></div>
<div class="ttc" id="server_8h_html_a27c7e814708df2c7eed37fbc6ac0b7f1"><div class="ttname"><a href="server_8h.html#a27c7e814708df2c7eed37fbc6ac0b7f1">OBJ_LIST_MAX_ZIPLIST_SIZE</a></div><div class="ttdeci">#define OBJ_LIST_MAX_ZIPLIST_SIZE</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00355">server.h:355</a></div></div>
<div class="ttc" id="structaeEventLoop_html"><div class="ttname"><a href="structaeEventLoop.html">aeEventLoop</a></div><div class="ttdef"><b>Definition:</b> <a href="ae_8h_source.html#l00091">ae.h:91</a></div></div>
<div class="ttc" id="server_8h_html_a5b8590d1c7aa090e48b9506c0842d206"><div class="ttname"><a href="server_8h.html#a5b8590d1c7aa090e48b9506c0842d206">CONFIG_DEFAULT_MAXMEMORY_POLICY</a></div><div class="ttdeci">#define CONFIG_DEFAULT_MAXMEMORY_POLICY</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00384">server.h:384</a></div></div>
<div class="ttc" id="server_8h_html_a88114b5169b4c382df6b56506285e56a"><div class="ttname"><a href="server_8h.html#a88114b5169b4c382df6b56506285e56a">serverAssert</a></div><div class="ttdeci">#define serverAssert(_e)</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00443">server.h:443</a></div></div>
<div class="ttc" id="server_8h_html_ae9f6995948253652bc9454d79a72f4a7"><div class="ttname"><a href="server_8h.html#ae9f6995948253652bc9454d79a72f4a7">CLIENT_SLAVE</a></div><div class="ttdeci">#define CLIENT_SLAVE</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00221">server.h:221</a></div></div>
<div class="ttc" id="server_8h_html_a2e6080731ab6e81b19f1bfedf7b298f9"><div class="ttname"><a href="server_8h.html#a2e6080731ab6e81b19f1bfedf7b298f9">CONFIG_DEFAULT_LAZYFREE_LAZY_EXPIRE</a></div><div class="ttdeci">#define CONFIG_DEFAULT_LAZYFREE_LAZY_EXPIRE</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00155">server.h:155</a></div></div>
<div class="ttc" id="server_8h_html_ad9e350cb5eeb396592d0d80f70e6e040"><div class="ttname"><a href="server_8h.html#ad9e350cb5eeb396592d0d80f70e6e040">STATS_METRIC_COUNT</a></div><div class="ttdeci">#define STATS_METRIC_COUNT</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00176">server.h:176</a></div></div>
<div class="ttc" id="server_8h_html_a2a1b586e8f326f831f6ab466c8c3f38a"><div class="ttname"><a href="server_8h.html#a2a1b586e8f326f831f6ab466c8c3f38a">SLAVE_STATE_WAIT_BGSAVE_END</a></div><div class="ttdeci">#define SLAVE_STATE_WAIT_BGSAVE_END</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00302">server.h:302</a></div></div>
<div class="ttc" id="server_8h_html_a57b24bdd0dc4a156941789096e9e1f44"><div class="ttname"><a href="server_8h.html#a57b24bdd0dc4a156941789096e9e1f44">RESTART_SERVER_CONFIG_REWRITE</a></div><div class="ttdeci">#define RESTART_SERVER_CONFIG_REWRITE</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l01656">server.h:1656</a></div></div>
<div class="ttc" id="server_8h_html_a9948ae3a2778b5a06b704231b921e7fa"><div class="ttname"><a href="server_8h.html#a9948ae3a2778b5a06b704231b921e7fa">CLIENT_PREVENT_AOF_PROP</a></div><div class="ttdeci">#define CLIENT_PREVENT_AOF_PROP</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00241">server.h:241</a></div></div>
<div class="ttc" id="server_8h_html_aea7b4966d78f67f5ab89f38f0e1bde74"><div class="ttname"><a href="server_8h.html#aea7b4966d78f67f5ab89f38f0e1bde74">SUPERVISED_SYSTEMD</a></div><div class="ttdeci">#define SUPERVISED_SYSTEMD</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00332">server.h:332</a></div></div>
<div class="ttc" id="server_8h_html_a225a9e35f2cb8aa663571625bc59a533"><div class="ttname"><a href="server_8h.html#a225a9e35f2cb8aa663571625bc59a533">STATS_METRIC_SAMPLES</a></div><div class="ttdeci">#define STATS_METRIC_SAMPLES</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00172">server.h:172</a></div></div>
<div class="ttc" id="server_8h_html_afb6bccf6f1ac66b1d563330ab499fb32"><div class="ttname"><a href="server_8h.html#afb6bccf6f1ac66b1d563330ab499fb32">PROTO_MBULK_BIG_ARG</a></div><div class="ttdeci">#define PROTO_MBULK_BIG_ARG</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00183">server.h:183</a></div></div>
<div class="ttc" id="server_8h_html_ab72fac70fbc902a7f106f4c710e08271"><div class="ttname"><a href="server_8h.html#ab72fac70fbc902a7f106f4c710e08271">LUA_SCRIPT_TIME_LIMIT</a></div><div class="ttdeci">#define LUA_SCRIPT_TIME_LIMIT</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00387">server.h:387</a></div></div>
<div class="ttc" id="server_8h_html_aaf26ba9b59589bc7701e36fb440a0fbe"><div class="ttname"><a href="server_8h.html#aaf26ba9b59589bc7701e36fb440a0fbe">CMD_NOSCRIPT</a></div><div class="ttdeci">#define CMD_NOSCRIPT</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00204">server.h:204</a></div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li><li class="navelem"><b>server.c</b></li>
    <li class="footer">Generated on Sat Dec 23 2017 10:13:23 for Redis-Quant365 by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
