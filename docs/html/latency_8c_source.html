<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Redis-Quant365: src/latency.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Redis-Quant365
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('latency_8c_source.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">latency.c</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">/* The latency monitor allows to easily observe the sources of latency</span></div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment"> * in a Redis instance using the LATENCY command. Different latency</span></div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment"> * sources are monitored, like disk I/O, execution of commands, fork</span></div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment"> * system call, and so forth.</span></div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment"> * ----------------------------------------------------------------------------</span></div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment"> * Copyright (c) 2014, Salvatore Sanfilippo &lt;antirez at gmail dot com&gt;</span></div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment"> * All rights reserved.</span></div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment"> * Redistribution and use in source and binary forms, with or without</span></div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment"> * modification, are permitted provided that the following conditions are met:</span></div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="comment"> *   * Redistributions of source code must retain the above copyright notice,</span></div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="comment"> *     this list of conditions and the following disclaimer.</span></div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="comment"> *   * Redistributions in binary form must reproduce the above copyright</span></div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="comment"> *     notice, this list of conditions and the following disclaimer in the</span></div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="comment"> *     documentation and/or other materials provided with the distribution.</span></div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="comment"> *   * Neither the name of Redis nor the names of its contributors may be used</span></div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="comment"> *     to endorse or promote products derived from this software without</span></div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="comment"> *     specific prior written permission.</span></div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="comment"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot;</span></div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="comment"> * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span></div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="comment"> * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span></div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="comment"> * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE</span></div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="comment"> * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR</span></div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="comment"> * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF</span></div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="comment"> * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS</span></div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="comment"> * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN</span></div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="comment"> * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)</span></div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="comment"> * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE</span></div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="comment"> * POSSIBILITY OF SUCH DAMAGE.</span></div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;</div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">include</span> <a class="code" href="server_8h.html">&quot;server.h&quot;</a></div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;</div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<span class="comment">/* Dictionary type for latency events. */</span></div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="keywordtype">int</span> dictStringKeyCompare(<span class="keywordtype">void</span> *privdata, <span class="keyword">const</span> <span class="keywordtype">void</span> *key1, <span class="keyword">const</span> <span class="keywordtype">void</span> *key2) {</div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;    <a class="code" href="server_8h.html#ae7c9dc8f13568a9c856573751f1ee1ec">UNUSED</a>(privdata);</div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;    <span class="keywordflow">return</span> strcmp(key1,key2) == 0;</div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;}</div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;</div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;uint64_t dictStringHash(<span class="keyword">const</span> <span class="keywordtype">void</span> *key) {</div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;    <span class="keywordflow">return</span> dictGenHashFunction(key, strlen(key));</div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;}</div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;</div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;<span class="keywordtype">void</span> dictVanillaFree(<span class="keywordtype">void</span> *privdata, <span class="keywordtype">void</span> *val);</div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;</div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;dictType latencyTimeSeriesDictType = {</div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;    dictStringHash,             <span class="comment">/* hash function */</span></div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;    NULL,                       <span class="comment">/* key dup */</span></div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;    NULL,                       <span class="comment">/* val dup */</span></div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;    dictStringKeyCompare,       <span class="comment">/* key compare */</span></div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;    dictVanillaFree,            <span class="comment">/* key destructor */</span></div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;    dictVanillaFree             <span class="comment">/* val destructor */</span></div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;};</div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;</div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;<span class="comment">/* ------------------------- Utility functions ------------------------------ */</span></div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;</div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">ifdef</span> __linux__</div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;<span class="comment">/* Returns 1 if Transparent Huge Pages support is enabled in the kernel.</span></div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;<span class="comment"> * Otherwise (or if we are unable to check) 0 is returned. */</span></div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;<span class="keywordtype">int</span> THPIsEnabled(<span class="keywordtype">void</span>) {</div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;    <span class="keywordtype">char</span> buf[1024];</div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;</div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;    FILE *fp = fopen(<span class="stringliteral">&quot;/sys/kernel/mm/transparent_hugepage/enabled&quot;</span>,<span class="stringliteral">&quot;r&quot;</span>);</div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;    <span class="keywordflow">if</span> (!fp) <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;    <span class="keywordflow">if</span> (fgets(buf,<span class="keyword">sizeof</span>(buf),fp) == NULL) {</div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;        fclose(fp);</div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;        <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;    }</div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;    fclose(fp);</div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;    <span class="keywordflow">return</span> (strstr(buf,<span class="stringliteral">&quot;[never]&quot;</span>) == NULL) ? 1 : 0;</div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;}</div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">endif</span></div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;</div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;<span class="comment">/* Report the amount of AnonHugePages in smap, in bytes. If the return</span></div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;<span class="comment"> * value of the function is non-zero, the process is being targeted by</span></div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;<span class="comment"> * THP support, and is likely to have memory usage / latency issues. */</span></div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;<span class="keywordtype">int</span> THPGetAnonHugePagesSize(<span class="keywordtype">void</span>) {</div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;    <span class="keywordflow">return</span> zmalloc_get_smap_bytes_by_field(<span class="stringliteral">&quot;AnonHugePages:&quot;</span>,-1);</div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;}</div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;</div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;<span class="comment">/* ---------------------------- Latency API --------------------------------- */</span></div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;</div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;<span class="comment">/* Latency monitor initialization. We just need to create the dictionary</span></div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;<span class="comment"> * of time series, each time serie is craeted on demand in order to avoid</span></div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;<span class="comment"> * having a fixed list to maintain. */</span></div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;<span class="keywordtype">void</span> latencyMonitorInit(<span class="keywordtype">void</span>) {</div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;    server.latency_events = dictCreate(&amp;latencyTimeSeriesDictType,NULL);</div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;}</div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;</div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;<span class="comment">/* Add the specified sample to the specified time series &quot;event&quot;.</span></div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;<span class="comment"> * This function is usually called via latencyAddSampleIfNeeded(), that</span></div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;<span class="comment"> * is a macro that only adds the sample if the latency is higher than</span></div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;<span class="comment"> * server.latency_monitor_threshold. */</span></div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;<span class="keywordtype">void</span> latencyAddSample(<span class="keywordtype">char</span> *event, mstime_t latency) {</div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;    <span class="keyword">struct</span> <a class="code" href="structlatencyTimeSeries.html">latencyTimeSeries</a> *ts = dictFetchValue(server.latency_events,event);</div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;    time_t now = time(NULL);</div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;    <span class="keywordtype">int</span> prev;</div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;</div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;    <span class="comment">/* Create the time series if it does not exist. */</span></div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;    <span class="keywordflow">if</span> (ts == NULL) {</div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;        ts = zmalloc(<span class="keyword">sizeof</span>(*ts));</div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;        ts-&gt;idx = 0;</div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;        ts-&gt;max = 0;</div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;        memset(ts-&gt;samples,0,<span class="keyword">sizeof</span>(ts-&gt;samples));</div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;        dictAdd(server.latency_events,zstrdup(event),ts);</div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;    }</div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;</div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;    <span class="comment">/* If the previous sample is in the same second, we update our old sample</span></div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;<span class="comment">     * if this latency is &gt; of the old one, or just return. */</span></div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;    prev = (ts-&gt;idx + <a class="code" href="latency_8h.html#a7e3ba352d9d7bb4c88c2c42c16e6674b">LATENCY_TS_LEN</a> - 1) % <a class="code" href="latency_8h.html#a7e3ba352d9d7bb4c88c2c42c16e6674b">LATENCY_TS_LEN</a>;</div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;    <span class="keywordflow">if</span> (ts-&gt;samples[prev].time == now) {</div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;        <span class="keywordflow">if</span> (latency &gt; ts-&gt;samples[prev].latency)</div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;            ts-&gt;samples[prev].latency = latency;</div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;    }</div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;</div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;    ts-&gt;samples[ts-&gt;idx].time = time(NULL);</div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;    ts-&gt;samples[ts-&gt;idx].latency = latency;</div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;    <span class="keywordflow">if</span> (latency &gt; ts-&gt;max) ts-&gt;max = latency;</div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;</div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;    ts-&gt;idx++;</div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;    <span class="keywordflow">if</span> (ts-&gt;idx == <a class="code" href="latency_8h.html#a7e3ba352d9d7bb4c88c2c42c16e6674b">LATENCY_TS_LEN</a>) ts-&gt;idx = 0;</div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;}</div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;</div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;<span class="comment">/* Reset data for the specified event, or all the events data if &#39;event&#39; is</span></div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;<span class="comment"> * NULL.</span></div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;<span class="comment"> * Note: this is O(N) even when event_to_reset is not NULL because makes</span></div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;<span class="comment"> * the code simpler and we have a small fixed max number of events. */</span></div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;<span class="keywordtype">int</span> latencyResetEvent(<span class="keywordtype">char</span> *event_to_reset) {</div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;    dictIterator *di;</div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;    dictEntry *de;</div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;    <span class="keywordtype">int</span> resets = 0;</div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;</div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;    di = dictGetSafeIterator(server.latency_events);</div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;    <span class="keywordflow">while</span>((de = dictNext(di)) != NULL) {</div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;        <span class="keywordtype">char</span> *event = <a class="code" href="dict_8h.html#a3271c334309904a3086deca94f96e46e">dictGetKey</a>(de);</div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;</div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;        <span class="keywordflow">if</span> (event_to_reset == NULL || strcasecmp(event,event_to_reset) == 0) {</div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;            dictDelete(server.latency_events, event);</div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;            resets++;</div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;        }</div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;    }</div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;    dictReleaseIterator(di);</div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;    <span class="keywordflow">return</span> resets;</div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;}</div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;</div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;<span class="comment">/* ------------------------ Latency reporting (doctor) ---------------------- */</span></div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;</div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;<span class="comment">/* Analyze the samples avaialble for a given event and return a structure</span></div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;<span class="comment"> * populate with different metrics, average, MAD, min, max, and so forth.</span></div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;<span class="comment"> * Check latency.h definition of struct latenctStat for more info.</span></div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;<span class="comment"> * If the specified event has no elements the structure is populate with</span></div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;<span class="comment"> * zero values. */</span></div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;<span class="keywordtype">void</span> analyzeLatencyForEvent(<span class="keywordtype">char</span> *event, <span class="keyword">struct</span> <a class="code" href="structlatencyStats.html">latencyStats</a> *ls) {</div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;    <span class="keyword">struct</span> <a class="code" href="structlatencyTimeSeries.html">latencyTimeSeries</a> *ts = dictFetchValue(server.latency_events,event);</div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;    <span class="keywordtype">int</span> j;</div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;    uint64_t sum;</div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;</div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;    ls-&gt;all_time_high = ts ? ts-&gt;max : 0;</div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;    ls-&gt;avg = 0;</div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;    ls-&gt;min = 0;</div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;    ls-&gt;max = 0;</div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;    ls-&gt;mad = 0;</div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;    ls-&gt;samples = 0;</div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;    ls-&gt;period = 0;</div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;    <span class="keywordflow">if</span> (!ts) <span class="keywordflow">return</span>;</div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;</div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;    <span class="comment">/* First pass, populate everything but the MAD. */</span></div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;    sum = 0;</div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;    <span class="keywordflow">for</span> (j = 0; j &lt; <a class="code" href="latency_8h.html#a7e3ba352d9d7bb4c88c2c42c16e6674b">LATENCY_TS_LEN</a>; j++) {</div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;        <span class="keywordflow">if</span> (ts-&gt;samples[j].time == 0) <span class="keywordflow">continue</span>;</div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;        ls-&gt;samples++;</div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;        <span class="keywordflow">if</span> (ls-&gt;samples == 1) {</div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;            ls-&gt;min = ls-&gt;max = ts-&gt;samples[j].latency;</div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;        } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;            <span class="keywordflow">if</span> (ls-&gt;min &gt; ts-&gt;samples[j].latency)</div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;                ls-&gt;min = ts-&gt;samples[j].latency;</div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;            <span class="keywordflow">if</span> (ls-&gt;max &lt; ts-&gt;samples[j].latency)</div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;                ls-&gt;max = ts-&gt;samples[j].latency;</div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;        }</div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;        sum += ts-&gt;samples[j].latency;</div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;</div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;        <span class="comment">/* Track the oldest event time in ls-&gt;period. */</span></div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;        <span class="keywordflow">if</span> (ls-&gt;period == 0 || ts-&gt;samples[j].time &lt; ls-&gt;period)</div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;            ls-&gt;period = ts-&gt;samples[j].time;</div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;    }</div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;</div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;    <span class="comment">/* So far avg is actually the sum of the latencies, and period is</span></div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;<span class="comment">     * the oldest event time. We need to make the first an average and</span></div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;<span class="comment">     * the second a range of seconds. */</span></div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;    <span class="keywordflow">if</span> (ls-&gt;samples) {</div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;        ls-&gt;avg = sum / ls-&gt;samples;</div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;        ls-&gt;period = time(NULL) - ls-&gt;period;</div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;        <span class="keywordflow">if</span> (ls-&gt;period == 0) ls-&gt;period = 1;</div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;    }</div><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;</div><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;    <span class="comment">/* Second pass, compute MAD. */</span></div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;    sum = 0;</div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;    <span class="keywordflow">for</span> (j = 0; j &lt; <a class="code" href="latency_8h.html#a7e3ba352d9d7bb4c88c2c42c16e6674b">LATENCY_TS_LEN</a>; j++) {</div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;        int64_t delta;</div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;</div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;        <span class="keywordflow">if</span> (ts-&gt;samples[j].time == 0) <span class="keywordflow">continue</span>;</div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;        delta = (int64_t)ls-&gt;avg - ts-&gt;samples[j].latency;</div><div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;        <span class="keywordflow">if</span> (delta &lt; 0) delta = -delta;</div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;        sum += delta;</div><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;    }</div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;    <span class="keywordflow">if</span> (ls-&gt;samples) ls-&gt;mad = sum / ls-&gt;samples;</div><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;}</div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;</div><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;<span class="comment">/* Create a human readable report of latency events for this Redis instance. */</span></div><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;sds createLatencyReport(<span class="keywordtype">void</span>) {</div><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;    sds report = sdsempty();</div><div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;    <span class="keywordtype">int</span> advise_better_vm = 0;       <span class="comment">/* Better virtual machines. */</span></div><div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;    <span class="keywordtype">int</span> advise_slowlog_enabled = 0; <span class="comment">/* Enable slowlog. */</span></div><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;    <span class="keywordtype">int</span> advise_slowlog_tuning = 0;  <span class="comment">/* Reconfigure slowlog. */</span></div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;    <span class="keywordtype">int</span> advise_slowlog_inspect = 0; <span class="comment">/* Check your slowlog. */</span></div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;    <span class="keywordtype">int</span> advise_disk_contention = 0; <span class="comment">/* Try to lower disk contention. */</span></div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;    <span class="keywordtype">int</span> advise_scheduler = 0;       <span class="comment">/* Intrinsic latency. */</span></div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;    <span class="keywordtype">int</span> advise_data_writeback = 0;  <span class="comment">/* data=writeback. */</span></div><div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;    <span class="keywordtype">int</span> advise_no_appendfsync = 0;  <span class="comment">/* don&#39;t fsync during rewrites. */</span></div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;    <span class="keywordtype">int</span> advise_local_disk = 0;      <span class="comment">/* Avoid remote disks. */</span></div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;    <span class="keywordtype">int</span> advise_ssd = 0;             <span class="comment">/* Use an SSD drive. */</span></div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;    <span class="keywordtype">int</span> advise_write_load_info = 0; <span class="comment">/* Print info about AOF and write load. */</span></div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;    <span class="keywordtype">int</span> advise_hz = 0;              <span class="comment">/* Use higher HZ. */</span></div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;    <span class="keywordtype">int</span> advise_large_objects = 0;   <span class="comment">/* Deletion of large objects. */</span></div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;    <span class="keywordtype">int</span> advise_mass_eviction = 0;   <span class="comment">/* Avoid mass eviction of keys. */</span></div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;    <span class="keywordtype">int</span> advise_relax_fsync_policy = 0; <span class="comment">/* appendfsync always is slow. */</span></div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;    <span class="keywordtype">int</span> advise_disable_thp = 0;     <span class="comment">/* AnonHugePages detected. */</span></div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;    <span class="keywordtype">int</span> advices = 0;</div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;</div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;    <span class="comment">/* Return ASAP if the latency engine is disabled and it looks like it</span></div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;<span class="comment">     * was never enabled so far. */</span></div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="dict_8h.html#af193430dd3d5579a52b194512f72c1f0">dictSize</a>(server.latency_events) == 0 &amp;&amp;</div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;        server.latency_monitor_threshold == 0)</div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;    {</div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;        report = sdscat(report,<span class="stringliteral">&quot;I&#39;m sorry, Dave, I can&#39;t do that. Latency monitoring is disabled in this Redis instance. You may use \&quot;CONFIG SET latency-monitor-threshold &lt;milliseconds&gt;.\&quot; in order to enable it. If we weren&#39;t in a deep space mission I&#39;d suggest to take a look at http://redis.io/topics/latency-monitor.\n&quot;</span>);</div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;        <span class="keywordflow">return</span> report;</div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;    }</div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;</div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;    <span class="comment">/* Show all the events stats and add for each event some event-related</span></div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;<span class="comment">     * comment depending on the values. */</span></div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;    dictIterator *di;</div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;    dictEntry *de;</div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;    <span class="keywordtype">int</span> eventnum = 0;</div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;</div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;    di = dictGetSafeIterator(server.latency_events);</div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;    <span class="keywordflow">while</span>((de = dictNext(di)) != NULL) {</div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;        <span class="keywordtype">char</span> *event = <a class="code" href="dict_8h.html#a3271c334309904a3086deca94f96e46e">dictGetKey</a>(de);</div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;        <span class="keyword">struct</span> <a class="code" href="structlatencyTimeSeries.html">latencyTimeSeries</a> *ts = <a class="code" href="dict_8h.html#ae8d2cc391873b2bea2b87c4f80f43120">dictGetVal</a>(de);</div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;        <span class="keyword">struct</span> <a class="code" href="structlatencyStats.html">latencyStats</a> ls;</div><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;</div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;        <span class="keywordflow">if</span> (ts == NULL) <span class="keywordflow">continue</span>;</div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;        eventnum++;</div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;        <span class="keywordflow">if</span> (eventnum == 1) {</div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;            report = sdscat(report,<span class="stringliteral">&quot;Dave, I have observed latency spikes in this Redis instance. You don&#39;t mind talking about it, do you Dave?\n\n&quot;</span>);</div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;        }</div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;        analyzeLatencyForEvent(event,&amp;ls);</div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;</div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;        report = sdscatprintf(report,</div><div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;            <span class="stringliteral">&quot;%d. %s: %d latency spikes (average %lums, mean deviation %lums, period %.2f sec). Worst all time event %lums.&quot;</span>,</div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;            eventnum, event,</div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;            ls.samples,</div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;            (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>) ls.avg,</div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;            (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>) ls.mad,</div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;            (<span class="keywordtype">double</span>) ls.period/ls.samples,</div><div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;            (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>) ts-&gt;max);</div><div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;</div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;        <span class="comment">/* Fork */</span></div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;        <span class="keywordflow">if</span> (!strcasecmp(event,<span class="stringliteral">&quot;fork&quot;</span>)) {</div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;            <span class="keywordtype">char</span> *fork_quality;</div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;            <span class="keywordflow">if</span> (server.stat_fork_rate &lt; 10) {</div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;                fork_quality = <span class="stringliteral">&quot;terrible&quot;</span>;</div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;                advise_better_vm = 1;</div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;                advices++;</div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (server.stat_fork_rate &lt; 25) {</div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;                fork_quality = <span class="stringliteral">&quot;poor&quot;</span>;</div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;                advise_better_vm = 1;</div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;                advices++;</div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (server.stat_fork_rate &lt; 100) {</div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;                fork_quality = <span class="stringliteral">&quot;good&quot;</span>;</div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;                fork_quality = <span class="stringliteral">&quot;excellent&quot;</span>;</div><div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;            }</div><div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;            report = sdscatprintf(report,</div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;                <span class="stringliteral">&quot; Fork rate is %.2f GB/sec (%s).&quot;</span>, server.stat_fork_rate,</div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;                fork_quality);</div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;        }</div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;</div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;        <span class="comment">/* Potentially commands. */</span></div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;        <span class="keywordflow">if</span> (!strcasecmp(event,<span class="stringliteral">&quot;command&quot;</span>)) {</div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;            <span class="keywordflow">if</span> (server.slowlog_log_slower_than == 0) {</div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;                advise_slowlog_enabled = 1;</div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;                advices++;</div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (server.slowlog_log_slower_than/1000 &gt;</div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;                       server.latency_monitor_threshold)</div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;            {</div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;                advise_slowlog_tuning = 1;</div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;                advices++;</div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;            }</div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;            advise_slowlog_inspect = 1;</div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;            advise_large_objects = 1;</div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;            advices += 2;</div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;        }</div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;</div><div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;        <span class="comment">/* fast-command. */</span></div><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;        <span class="keywordflow">if</span> (!strcasecmp(event,<span class="stringliteral">&quot;fast-command&quot;</span>)) {</div><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;            advise_scheduler = 1;</div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;            advices++;</div><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;        }</div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;</div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;        <span class="comment">/* AOF and I/O. */</span></div><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;        <span class="keywordflow">if</span> (!strcasecmp(event,<span class="stringliteral">&quot;aof-write-pending-fsync&quot;</span>)) {</div><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;            advise_local_disk = 1;</div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;            advise_disk_contention = 1;</div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;            advise_ssd = 1;</div><div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;            advise_data_writeback = 1;</div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;            advices += 4;</div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;        }</div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;</div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;        <span class="keywordflow">if</span> (!strcasecmp(event,<span class="stringliteral">&quot;aof-write-active-child&quot;</span>)) {</div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;            advise_no_appendfsync = 1;</div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;            advise_data_writeback = 1;</div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;            advise_ssd = 1;</div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;            advices += 3;</div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;        }</div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;</div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;        <span class="keywordflow">if</span> (!strcasecmp(event,<span class="stringliteral">&quot;aof-write-alone&quot;</span>)) {</div><div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;            advise_local_disk = 1;</div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;            advise_data_writeback = 1;</div><div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;            advise_ssd = 1;</div><div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;            advices += 3;</div><div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;        }</div><div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;</div><div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;        <span class="keywordflow">if</span> (!strcasecmp(event,<span class="stringliteral">&quot;aof-fsync-always&quot;</span>)) {</div><div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;            advise_relax_fsync_policy = 1;</div><div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;            advices++;</div><div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;        }</div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;</div><div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;        <span class="keywordflow">if</span> (!strcasecmp(event,<span class="stringliteral">&quot;aof-fstat&quot;</span>) ||</div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;            !strcasecmp(event,<span class="stringliteral">&quot;rdb-unlik-temp-file&quot;</span>)) {</div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;            advise_disk_contention = 1;</div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;            advise_local_disk = 1;</div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;            advices += 2;</div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;        }</div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;</div><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;        <span class="keywordflow">if</span> (!strcasecmp(event,<span class="stringliteral">&quot;aof-rewrite-diff-write&quot;</span>) ||</div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;            !strcasecmp(event,<span class="stringliteral">&quot;aof-rename&quot;</span>)) {</div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;            advise_write_load_info = 1;</div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;            advise_data_writeback = 1;</div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;            advise_ssd = 1;</div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;            advise_local_disk = 1;</div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;            advices += 4;</div><div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;        }</div><div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;</div><div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;        <span class="comment">/* Expire cycle. */</span></div><div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;        <span class="keywordflow">if</span> (!strcasecmp(event,<span class="stringliteral">&quot;expire-cycle&quot;</span>)) {</div><div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;            advise_hz = 1;</div><div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;            advise_large_objects = 1;</div><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;            advices += 2;</div><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;        }</div><div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;</div><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;        <span class="comment">/* Eviction cycle. */</span></div><div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;        <span class="keywordflow">if</span> (!strcasecmp(event,<span class="stringliteral">&quot;eviction-del&quot;</span>)) {</div><div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;            advise_large_objects = 1;</div><div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;            advices++;</div><div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;        }</div><div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;</div><div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;        <span class="keywordflow">if</span> (!strcasecmp(event,<span class="stringliteral">&quot;eviction-cycle&quot;</span>)) {</div><div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;            advise_mass_eviction = 1;</div><div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;            advices++;</div><div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;        }</div><div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;</div><div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;        report = sdscatlen(report,<span class="stringliteral">&quot;\n&quot;</span>,1);</div><div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;    }</div><div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;    dictReleaseIterator(di);</div><div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;</div><div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;    <span class="comment">/* Add non event based advices. */</span></div><div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;    <span class="keywordflow">if</span> (THPGetAnonHugePagesSize() &gt; 0) {</div><div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;        advise_disable_thp = 1;</div><div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;        advices++;</div><div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;    }</div><div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;</div><div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;    <span class="keywordflow">if</span> (eventnum == 0 &amp;&amp; advices == 0) {</div><div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;        report = sdscat(report,<span class="stringliteral">&quot;Dave, no latency spike was observed during the lifetime of this Redis instance, not in the slightest bit. I honestly think you ought to sit down calmly, take a stress pill, and think things over.\n&quot;</span>);</div><div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (eventnum &gt; 0 &amp;&amp; advices == 0) {</div><div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;        report = sdscat(report,<span class="stringliteral">&quot;\nWhile there are latency events logged, I&#39;m not able to suggest any easy fix. Please use the Redis community to get some help, providing this report in your help request.\n&quot;</span>);</div><div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;        <span class="comment">/* Add all the suggestions accumulated so far. */</span></div><div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;</div><div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;        <span class="comment">/* Better VM. */</span></div><div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;        report = sdscat(report,<span class="stringliteral">&quot;\nI have a few advices for you:\n\n&quot;</span>);</div><div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;        <span class="keywordflow">if</span> (advise_better_vm) {</div><div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;            report = sdscat(report,<span class="stringliteral">&quot;- If you are using a virtual machine, consider upgrading it with a faster one using an hypervisior that provides less latency during fork() calls. Xen is known to have poor fork() performance. Even in the context of the same VM provider, certain kinds of instances can execute fork faster than others.\n&quot;</span>);</div><div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;        }</div><div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;</div><div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;        <span class="comment">/* Slow log. */</span></div><div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;        <span class="keywordflow">if</span> (advise_slowlog_enabled) {</div><div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;            report = sdscatprintf(report,<span class="stringliteral">&quot;- There are latency issues with potentially slow commands you are using. Try to enable the Slow Log Redis feature using the command &#39;CONFIG SET slowlog-log-slower-than %llu&#39;. If the Slow log is disabled Redis is not able to log slow commands execution for you.\n&quot;</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span>)server.latency_monitor_threshold*1000);</div><div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;        }</div><div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;</div><div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;        <span class="keywordflow">if</span> (advise_slowlog_tuning) {</div><div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;            report = sdscatprintf(report,<span class="stringliteral">&quot;- Your current Slow Log configuration only logs events that are slower than your configured latency monitor threshold. Please use &#39;CONFIG SET slowlog-log-slower-than %llu&#39;.\n&quot;</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span>)server.latency_monitor_threshold*1000);</div><div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;        }</div><div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;</div><div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;        <span class="keywordflow">if</span> (advise_slowlog_inspect) {</div><div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;            report = sdscat(report,<span class="stringliteral">&quot;- Check your Slow Log to understand what are the commands you are running which are too slow to execute. Please check http://redis.io/commands/slowlog for more information.\n&quot;</span>);</div><div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;        }</div><div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;</div><div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;        <span class="comment">/* Intrinsic latency. */</span></div><div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;        <span class="keywordflow">if</span> (advise_scheduler) {</div><div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;            report = sdscat(report,<span class="stringliteral">&quot;- The system is slow to execute Redis code paths not containing system calls. This usually means the system does not provide Redis CPU time to run for long periods. You should try to:\n&quot;</span></div><div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;            <span class="stringliteral">&quot;  1) Lower the system load.\n&quot;</span></div><div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;            <span class="stringliteral">&quot;  2) Use a computer / VM just for Redis if you are running other softawre in the same system.\n&quot;</span></div><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;            <span class="stringliteral">&quot;  3) Check if you have a \&quot;noisy neighbour\&quot; problem.\n&quot;</span></div><div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;            <span class="stringliteral">&quot;  4) Check with &#39;redis-cli --intrinsic-latency 100&#39; what is the intrinsic latency in your system.\n&quot;</span></div><div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;            <span class="stringliteral">&quot;  5) Check if the problem is allocator-related by recompiling Redis with MALLOC=libc, if you are using Jemalloc. However this may create fragmentation problems.\n&quot;</span>);</div><div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;        }</div><div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;</div><div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;        <span class="comment">/* AOF / Disk latency. */</span></div><div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;        <span class="keywordflow">if</span> (advise_local_disk) {</div><div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;            report = sdscat(report,<span class="stringliteral">&quot;- It is strongly advised to use local disks for persistence, especially if you are using AOF. Remote disks provided by platform-as-a-service providers are known to be slow.\n&quot;</span>);</div><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;        }</div><div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;</div><div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;        <span class="keywordflow">if</span> (advise_ssd) {</div><div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;            report = sdscat(report,<span class="stringliteral">&quot;- SSD disks are able to reduce fsync latency, and total time needed for snapshotting and AOF log rewriting (resulting in smaller memory usage and smaller final AOF rewrite buffer flushes). With extremely high write load SSD disks can be a good option. However Redis should perform reasonably with high load using normal disks. Use this advice as a last resort.\n&quot;</span>);</div><div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;        }</div><div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;</div><div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;        <span class="keywordflow">if</span> (advise_data_writeback) {</div><div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;            report = sdscat(report,<span class="stringliteral">&quot;- Mounting ext3/4 filesystems with data=writeback can provide a performance boost compared to data=ordered, however this mode of operation provides less guarantees, and sometimes it can happen that after a hard crash the AOF file will have an half-written command at the end and will require to be repaired before Redis restarts.\n&quot;</span>);</div><div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;        }</div><div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;</div><div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;        <span class="keywordflow">if</span> (advise_disk_contention) {</div><div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;            report = sdscat(report,<span class="stringliteral">&quot;- Try to lower the disk contention. This is often caused by other disk intensive processes running in the same computer (including other Redis instances).\n&quot;</span>);</div><div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;        }</div><div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;</div><div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;        <span class="keywordflow">if</span> (advise_no_appendfsync) {</div><div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;            report = sdscat(report,<span class="stringliteral">&quot;- Assuming from the point of view of data safety this is viable in your environment, you could try to enable the &#39;no-appendfsync-on-rewrite&#39; option, so that fsync will not be performed while there is a child rewriting the AOF file or producing an RDB file (the moment where there is high disk contention).\n&quot;</span>);</div><div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;        }</div><div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;</div><div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;        <span class="keywordflow">if</span> (advise_relax_fsync_policy &amp;&amp; server.<a class="code" href="config_8h.html#af5994c643c434574580bb7816af82cad">aof_fsync</a> == <a class="code" href="server_8h.html#a83bfec10b7b4be60ec6d5868cadc73bb">AOF_FSYNC_ALWAYS</a>) {</div><div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;            report = sdscat(report,<span class="stringliteral">&quot;- Your fsync policy is set to &#39;always&#39;. It is very hard to get good performances with such a setup, if possible try to relax the fsync policy to &#39;onesec&#39;.\n&quot;</span>);</div><div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;        }</div><div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;</div><div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;        <span class="keywordflow">if</span> (advise_write_load_info) {</div><div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;            report = sdscat(report,<span class="stringliteral">&quot;- Latency during the AOF atomic rename operation or when the final difference is flushed to the AOF file at the end of the rewrite, sometimes is caused by very high write load, causing the AOF buffer to get very large. If possible try to send less commands to accomplish the same work, or use Lua scripts to group multiple operations into a single EVALSHA call.\n&quot;</span>);</div><div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;        }</div><div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;</div><div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;        <span class="keywordflow">if</span> (advise_hz &amp;&amp; server.hz &lt; 100) {</div><div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;            report = sdscat(report,<span class="stringliteral">&quot;- In order to make the Redis keys expiring process more incremental, try to set the &#39;hz&#39; configuration parameter to 100 using &#39;CONFIG SET hz 100&#39;.\n&quot;</span>);</div><div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;        }</div><div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;</div><div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;        <span class="keywordflow">if</span> (advise_large_objects) {</div><div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;            report = sdscat(report,<span class="stringliteral">&quot;- Deleting, expiring or evicting (because of maxmemory policy) large objects is a blocking operation. If you have very large objects that are often deleted, expired, or evicted, try to fragment those objects into multiple smaller objects.\n&quot;</span>);</div><div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;        }</div><div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;</div><div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;        <span class="keywordflow">if</span> (advise_mass_eviction) {</div><div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;            report = sdscat(report,<span class="stringliteral">&quot;- Sudden changes to the &#39;maxmemory&#39; setting via &#39;CONFIG SET&#39;, or allocation of large objects via sets or sorted sets intersections, STORE option of SORT, Redis Cluster large keys migrations (RESTORE command), may create sudden memory pressure forcing the server to block trying to evict keys. \n&quot;</span>);</div><div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;        }</div><div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;</div><div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;        <span class="keywordflow">if</span> (advise_disable_thp) {</div><div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;            report = sdscat(report,<span class="stringliteral">&quot;- I detected a non zero amount of anonymous huge pages used by your process. This creates very serious latency events in different conditions, especially when Redis is persisting on disk. To disable THP support use the command &#39;echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled&#39;, make sure to also add it into /etc/rc.local so that the command will be executed again after a reboot. Note that even if you have already disabled THP, you still need to restart the Redis process to get rid of the huge pages already created.\n&quot;</span>);</div><div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;        }</div><div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;    }</div><div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;</div><div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;    <span class="keywordflow">return</span> report;</div><div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;}</div><div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;</div><div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;<span class="comment">/* ---------------------- Latency command implementation -------------------- */</span></div><div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;</div><div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;<span class="comment">/* latencyCommand() helper to produce a time-delay reply for all the samples</span></div><div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;<span class="comment"> * in memory for the specified time series. */</span></div><div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;<span class="keywordtype">void</span> latencyCommandReplyWithSamples(<a class="code" href="structclient.html">client</a> *c, <span class="keyword">struct</span> <a class="code" href="structlatencyTimeSeries.html">latencyTimeSeries</a> *ts) {</div><div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;    <span class="keywordtype">void</span> *replylen = addDeferredMultiBulkLength(c);</div><div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;    <span class="keywordtype">int</span> samples = 0, j;</div><div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;</div><div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;    <span class="keywordflow">for</span> (j = 0; j &lt; <a class="code" href="latency_8h.html#a7e3ba352d9d7bb4c88c2c42c16e6674b">LATENCY_TS_LEN</a>; j++) {</div><div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;        <span class="keywordtype">int</span> i = (ts-&gt;idx + j) % <a class="code" href="latency_8h.html#a7e3ba352d9d7bb4c88c2c42c16e6674b">LATENCY_TS_LEN</a>;</div><div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;</div><div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;        <span class="keywordflow">if</span> (ts-&gt;samples[i].time == 0) <span class="keywordflow">continue</span>;</div><div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;        addReplyMultiBulkLen(c,2);</div><div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;        addReplyLongLong(c,ts-&gt;samples[i].time);</div><div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;        addReplyLongLong(c,ts-&gt;samples[i].latency);</div><div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;        samples++;</div><div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;    }</div><div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;    setDeferredMultiBulkLength(c,replylen,samples);</div><div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;}</div><div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;</div><div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;<span class="comment">/* latencyCommand() helper to produce the reply for the LATEST subcommand,</span></div><div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;<span class="comment"> * listing the last latency sample for every event type registered so far. */</span></div><div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;<span class="keywordtype">void</span> latencyCommandReplyWithLatestEvents(<a class="code" href="structclient.html">client</a> *c) {</div><div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;    dictIterator *di;</div><div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;    dictEntry *de;</div><div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;</div><div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;    addReplyMultiBulkLen(c,<a class="code" href="dict_8h.html#af193430dd3d5579a52b194512f72c1f0">dictSize</a>(server.latency_events));</div><div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;    di = dictGetIterator(server.latency_events);</div><div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;    <span class="keywordflow">while</span>((de = dictNext(di)) != NULL) {</div><div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;        <span class="keywordtype">char</span> *event = <a class="code" href="dict_8h.html#a3271c334309904a3086deca94f96e46e">dictGetKey</a>(de);</div><div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;        <span class="keyword">struct</span> <a class="code" href="structlatencyTimeSeries.html">latencyTimeSeries</a> *ts = <a class="code" href="dict_8h.html#ae8d2cc391873b2bea2b87c4f80f43120">dictGetVal</a>(de);</div><div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;        <span class="keywordtype">int</span> last = (ts-&gt;idx + <a class="code" href="latency_8h.html#a7e3ba352d9d7bb4c88c2c42c16e6674b">LATENCY_TS_LEN</a> - 1) % <a class="code" href="latency_8h.html#a7e3ba352d9d7bb4c88c2c42c16e6674b">LATENCY_TS_LEN</a>;</div><div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;</div><div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;        addReplyMultiBulkLen(c,4);</div><div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;        addReplyBulkCString(c,event);</div><div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;        addReplyLongLong(c,ts-&gt;samples[last].time);</div><div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;        addReplyLongLong(c,ts-&gt;samples[last].latency);</div><div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;        addReplyLongLong(c,ts-&gt;max);</div><div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;    }</div><div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;    dictReleaseIterator(di);</div><div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;}</div><div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;</div><div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">define</span> <span class="preprocessor">LATENCY_GRAPH_COLS</span> 80</div><div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;sds latencyCommandGenSparkeline(<span class="keywordtype">char</span> *event, <span class="keyword">struct</span> <a class="code" href="structlatencyTimeSeries.html">latencyTimeSeries</a> *ts) {</div><div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;    <span class="keywordtype">int</span> j;</div><div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;    <span class="keyword">struct</span> <a class="code" href="structsequence.html">sequence</a> *seq = createSparklineSequence();</div><div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;    sds graph = sdsempty();</div><div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;    uint32_t min = 0, max = 0;</div><div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;</div><div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;    <span class="keywordflow">for</span> (j = 0; j &lt; <a class="code" href="latency_8h.html#a7e3ba352d9d7bb4c88c2c42c16e6674b">LATENCY_TS_LEN</a>; j++) {</div><div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;        <span class="keywordtype">int</span> i = (ts-&gt;idx + j) % <a class="code" href="latency_8h.html#a7e3ba352d9d7bb4c88c2c42c16e6674b">LATENCY_TS_LEN</a>;</div><div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;        <span class="keywordtype">int</span> elapsed;</div><div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;        <span class="keywordtype">char</span> buf[64];</div><div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;</div><div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;        <span class="keywordflow">if</span> (ts-&gt;samples[i].time == 0) <span class="keywordflow">continue</span>;</div><div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;        <span class="comment">/* Update min and max. */</span></div><div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;        <span class="keywordflow">if</span> (seq-&gt;length == 0) {</div><div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;            min = max = ts-&gt;samples[i].latency;</div><div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;        } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;            <span class="keywordflow">if</span> (ts-&gt;samples[i].latency &gt; max) max = ts-&gt;samples[i].latency;</div><div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;            <span class="keywordflow">if</span> (ts-&gt;samples[i].latency &lt; min) min = ts-&gt;samples[i].latency;</div><div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;        }</div><div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;        <span class="comment">/* Use as label the number of seconds / minutes / hours / days</span></div><div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;<span class="comment">         * ago the event happened. */</span></div><div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;        elapsed = time(NULL) - ts-&gt;samples[i].time;</div><div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;        <span class="keywordflow">if</span> (elapsed &lt; 60)</div><div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;            snprintf(buf,<span class="keyword">sizeof</span>(buf),<span class="stringliteral">&quot;%ds&quot;</span>,elapsed);</div><div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (elapsed &lt; 3600)</div><div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;            snprintf(buf,<span class="keyword">sizeof</span>(buf),<span class="stringliteral">&quot;%dm&quot;</span>,elapsed/60);</div><div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (elapsed &lt; 3600*24)</div><div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;            snprintf(buf,<span class="keyword">sizeof</span>(buf),<span class="stringliteral">&quot;%dh&quot;</span>,elapsed/3600);</div><div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;            snprintf(buf,<span class="keyword">sizeof</span>(buf),<span class="stringliteral">&quot;%dd&quot;</span>,elapsed/(3600*24));</div><div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;        sparklineSequenceAddSample(seq,ts-&gt;samples[i].latency,buf);</div><div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;    }</div><div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;</div><div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;    graph = sdscatprintf(graph,</div><div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;        <span class="stringliteral">&quot;%s - high %lu ms, low %lu ms (all time high %lu ms)\n&quot;</span>, event,</div><div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;        (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>) max, (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>) min, (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>) ts-&gt;max);</div><div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;    <span class="keywordflow">for</span> (j = 0; j &lt; <a class="code" href="latency_8c.html#a3acc869332e75f8b926c821d6cc97c8e">LATENCY_GRAPH_COLS</a>; j++)</div><div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;        graph = sdscatlen(graph,<span class="stringliteral">&quot;-&quot;</span>,1);</div><div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;    graph = sdscatlen(graph,<span class="stringliteral">&quot;\n&quot;</span>,1);</div><div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;    graph = sparklineRender(graph,seq,<a class="code" href="latency_8c.html#a3acc869332e75f8b926c821d6cc97c8e">LATENCY_GRAPH_COLS</a>,4,<a class="code" href="sparkline_8h.html#af6a091d13a723f2ac2a848be4235a6cd">SPARKLINE_FILL</a>);</div><div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;    freeSparklineSequence(seq);</div><div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;    <span class="keywordflow">return</span> graph;</div><div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;}</div><div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;</div><div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;<span class="comment">/* LATENCY command implementations.</span></div><div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;<span class="comment"> * LATENCY SAMPLES: return time-latency samples for the specified event.</span></div><div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;<span class="comment"> * LATENCY LATEST: return the latest latency for all the events classes.</span></div><div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;<span class="comment"> * LATENCY DOCTOR: returns an human readable analysis of instance latency.</span></div><div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;<span class="comment"> * LATENCY GRAPH: provide an ASCII graph of the latency of the specified event.</span></div><div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;<span class="keywordtype">void</span> latencyCommand(<a class="code" href="structclient.html">client</a> *c) {</div><div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;    <span class="keyword">struct</span> <a class="code" href="structlatencyTimeSeries.html">latencyTimeSeries</a> *ts;</div><div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;</div><div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;    <span class="keywordflow">if</span> (!strcasecmp(c-&gt;argv[1]-&gt;ptr,<span class="stringliteral">&quot;history&quot;</span>) &amp;&amp; c-&gt;argc == 3) {</div><div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;        <span class="comment">/* LATENCY HISTORY &lt;event&gt; */</span></div><div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;        ts = dictFetchValue(server.latency_events,c-&gt;argv[2]-&gt;ptr);</div><div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;        <span class="keywordflow">if</span> (ts == NULL) {</div><div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;            addReplyMultiBulkLen(c,0);</div><div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;        } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;            latencyCommandReplyWithSamples(c,ts);</div><div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;        }</div><div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(c-&gt;argv[1]-&gt;ptr,<span class="stringliteral">&quot;graph&quot;</span>) &amp;&amp; c-&gt;argc == 3) {</div><div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;        <span class="comment">/* LATENCY GRAPH &lt;event&gt; */</span></div><div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;        sds graph;</div><div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;        dictEntry *de;</div><div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;        <span class="keywordtype">char</span> *event;</div><div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;</div><div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;        de = dictFind(server.latency_events,c-&gt;argv[2]-&gt;ptr);</div><div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;        <span class="keywordflow">if</span> (de == NULL) <span class="keywordflow">goto</span> nodataerr;</div><div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;        ts = <a class="code" href="dict_8h.html#ae8d2cc391873b2bea2b87c4f80f43120">dictGetVal</a>(de);</div><div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;        event = <a class="code" href="dict_8h.html#a3271c334309904a3086deca94f96e46e">dictGetKey</a>(de);</div><div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;</div><div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;        graph = latencyCommandGenSparkeline(event,ts);</div><div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;        addReplyBulkCString(c,graph);</div><div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;        sdsfree(graph);</div><div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(c-&gt;argv[1]-&gt;ptr,<span class="stringliteral">&quot;latest&quot;</span>) &amp;&amp; c-&gt;argc == 2) {</div><div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;        <span class="comment">/* LATENCY LATEST */</span></div><div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;        latencyCommandReplyWithLatestEvents(c);</div><div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(c-&gt;argv[1]-&gt;ptr,<span class="stringliteral">&quot;doctor&quot;</span>) &amp;&amp; c-&gt;argc == 2) {</div><div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;        <span class="comment">/* LATENCY DOCTOR */</span></div><div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;        sds report = createLatencyReport();</div><div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;</div><div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;        addReplyBulkCBuffer(c,report,sdslen(report));</div><div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;        sdsfree(report);</div><div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(c-&gt;argv[1]-&gt;ptr,<span class="stringliteral">&quot;reset&quot;</span>) &amp;&amp; c-&gt;argc &gt;= 2) {</div><div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;        <span class="comment">/* LATENCY RESET */</span></div><div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;        <span class="keywordflow">if</span> (c-&gt;argc == 2) {</div><div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;            addReplyLongLong(c,latencyResetEvent(NULL));</div><div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;        } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;            <span class="keywordtype">int</span> j, resets = 0;</div><div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;</div><div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;            <span class="keywordflow">for</span> (j = 2; j &lt; c-&gt;argc; j++)</div><div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;                resets += latencyResetEvent(c-&gt;argv[j]-&gt;ptr);</div><div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;            addReplyLongLong(c,resets);</div><div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;        }</div><div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;        addReply(c,shared.syntaxerr);</div><div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;    }</div><div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;    <span class="keywordflow">return</span>;</div><div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;</div><div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;nodataerr:</div><div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;    <span class="comment">/* Common error when the user asks for an event we have no latency</span></div><div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;<span class="comment">     * information about. */</span></div><div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;    addReplyErrorFormat(c,</div><div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;        <span class="stringliteral">&quot;No samples available for event &#39;%s&#39;&quot;</span>, (<span class="keywordtype">char</span>*) c-&gt;argv[2]-&gt;ptr);</div><div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;}</div><div class="ttc" id="structsequence_html"><div class="ttname"><a href="structsequence.html">sequence</a></div><div class="ttdef"><b>Definition:</b> <a href="sparkline_8h_source.html#l00039">sparkline.h:39</a></div></div>
<div class="ttc" id="server_8h_html_ae7c9dc8f13568a9c856573751f1ee1ec"><div class="ttname"><a href="server_8h.html#ae7c9dc8f13568a9c856573751f1ee1ec">UNUSED</a></div><div class="ttdeci">#define UNUSED(V)</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00336">server.h:336</a></div></div>
<div class="ttc" id="structlatencyStats_html"><div class="ttname"><a href="structlatencyStats.html">latencyStats</a></div><div class="ttdef"><b>Definition:</b> <a href="latency_8h_source.html#l00054">latency.h:54</a></div></div>
<div class="ttc" id="dict_8h_html_a3271c334309904a3086deca94f96e46e"><div class="ttname"><a href="dict_8h.html#a3271c334309904a3086deca94f96e46e">dictGetKey</a></div><div class="ttdeci">#define dictGetKey(he)</div><div class="ttdef"><b>Definition:</b> <a href="dict_8h_source.html#l00141">dict.h:141</a></div></div>
<div class="ttc" id="latency_8c_html_a3acc869332e75f8b926c821d6cc97c8e"><div class="ttname"><a href="latency_8c.html#a3acc869332e75f8b926c821d6cc97c8e">LATENCY_GRAPH_COLS</a></div><div class="ttdeci">#define LATENCY_GRAPH_COLS</div><div class="ttdef"><b>Definition:</b> <a href="latency_8c_source.html#l00515">latency.c:515</a></div></div>
<div class="ttc" id="sparkline_8h_html_af6a091d13a723f2ac2a848be4235a6cd"><div class="ttname"><a href="sparkline_8h.html#af6a091d13a723f2ac2a848be4235a6cd">SPARKLINE_FILL</a></div><div class="ttdeci">#define SPARKLINE_FILL</div><div class="ttdef"><b>Definition:</b> <a href="sparkline_8h_source.html#l00047">sparkline.h:47</a></div></div>
<div class="ttc" id="config_8h_html_af5994c643c434574580bb7816af82cad"><div class="ttname"><a href="config_8h.html#af5994c643c434574580bb7816af82cad">aof_fsync</a></div><div class="ttdeci">#define aof_fsync</div><div class="ttdef"><b>Definition:</b> <a href="config_8h_source.html#l00094">config.h:94</a></div></div>
<div class="ttc" id="structclient_html"><div class="ttname"><a href="structclient.html">client</a></div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00686">server.h:686</a></div></div>
<div class="ttc" id="structlatencyTimeSeries_html"><div class="ttname"><a href="structlatencyTimeSeries.html">latencyTimeSeries</a></div><div class="ttdef"><b>Definition:</b> <a href="latency_8h_source.html#l00047">latency.h:47</a></div></div>
<div class="ttc" id="dict_8h_html_ae8d2cc391873b2bea2b87c4f80f43120"><div class="ttname"><a href="dict_8h.html#ae8d2cc391873b2bea2b87c4f80f43120">dictGetVal</a></div><div class="ttdeci">#define dictGetVal(he)</div><div class="ttdef"><b>Definition:</b> <a href="dict_8h_source.html#l00142">dict.h:142</a></div></div>
<div class="ttc" id="dict_8h_html_af193430dd3d5579a52b194512f72c1f0"><div class="ttname"><a href="dict_8h.html#af193430dd3d5579a52b194512f72c1f0">dictSize</a></div><div class="ttdeci">#define dictSize(d)</div><div class="ttdef"><b>Definition:</b> <a href="dict_8h_source.html#l00147">dict.h:147</a></div></div>
<div class="ttc" id="latency_8h_html_a7e3ba352d9d7bb4c88c2c42c16e6674b"><div class="ttname"><a href="latency_8h.html#a7e3ba352d9d7bb4c88c2c42c16e6674b">LATENCY_TS_LEN</a></div><div class="ttdeci">#define LATENCY_TS_LEN</div><div class="ttdef"><b>Definition:</b> <a href="latency_8h_source.html#l00037">latency.h:37</a></div></div>
<div class="ttc" id="server_8h_html_a83bfec10b7b4be60ec6d5868cadc73bb"><div class="ttname"><a href="server_8h.html#a83bfec10b7b4be60ec6d5868cadc73bb">AOF_FSYNC_ALWAYS</a></div><div class="ttdeci">#define AOF_FSYNC_ALWAYS</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00343">server.h:343</a></div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li><li class="navelem"><b>latency.c</b></li>
    <li class="footer">Generated on Sat Dec 23 2017 11:42:47 for Redis-Quant365 by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
