<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Redis-Quant365: src/object.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Redis-Quant365
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('object_8c_source.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">object.c</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">/* Redis Object implementation.</span></div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment"> * Copyright (c) 2009-2012, Salvatore Sanfilippo &lt;antirez at gmail dot com&gt;</span></div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment"> * All rights reserved.</span></div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment"> * Redistribution and use in source and binary forms, with or without</span></div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment"> * modification, are permitted provided that the following conditions are met:</span></div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment"> *   * Redistributions of source code must retain the above copyright notice,</span></div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment"> *     this list of conditions and the following disclaimer.</span></div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment"> *   * Redistributions in binary form must reproduce the above copyright</span></div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment"> *     notice, this list of conditions and the following disclaimer in the</span></div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment"> *     documentation and/or other materials provided with the distribution.</span></div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="comment"> *   * Neither the name of Redis nor the names of its contributors may be used</span></div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="comment"> *     to endorse or promote products derived from this software without</span></div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="comment"> *     specific prior written permission.</span></div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="comment"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot;</span></div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="comment"> * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span></div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="comment"> * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span></div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="comment"> * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE</span></div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="comment"> * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR</span></div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="comment"> * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF</span></div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="comment"> * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS</span></div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="comment"> * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN</span></div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="comment"> * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)</span></div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="comment"> * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE</span></div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="comment"> * POSSIBILITY OF SUCH DAMAGE.</span></div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;</div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">include</span> <a class="code" href="server_8h.html">&quot;server.h&quot;</a></div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">include</span> <span class="preprocessor">&lt;</span><span class="preprocessor">math</span><span class="preprocessor">.</span><span class="preprocessor">h</span><span class="preprocessor">&gt;</span></div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">include</span> <span class="preprocessor">&lt;</span><span class="preprocessor">ctype</span><span class="preprocessor">.</span><span class="preprocessor">h</span><span class="preprocessor">&gt;</span></div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;</div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">ifdef</span> <span class="preprocessor">__CYGWIN__</span></div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">define</span> <span class="preprocessor">strtold</span><span class="preprocessor">(</span><span class="preprocessor">a</span><span class="preprocessor">,</span><span class="preprocessor">b</span><span class="preprocessor">)</span> <span class="preprocessor">(</span><span class="preprocessor">(</span><span class="preprocessor">long</span> <span class="preprocessor">double</span><span class="preprocessor">)</span><span class="preprocessor">strtod</span><span class="preprocessor">(</span><span class="preprocessor">(</span><span class="preprocessor">a</span><span class="preprocessor">)</span><span class="preprocessor">,</span><span class="preprocessor">(</span><span class="preprocessor">b</span><span class="preprocessor">)</span><span class="preprocessor">)</span><span class="preprocessor">)</span></div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">endif</span></div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;</div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="comment">/* ===================== Creation and parsing of objects ==================== */</span></div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;</div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;robj *createObject(<span class="keywordtype">int</span> type, <span class="keywordtype">void</span> *ptr) {</div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;    robj *o = zmalloc(<span class="keyword">sizeof</span>(*o));</div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;    o-&gt;type = type;</div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;    o-&gt;encoding = <a class="code" href="server_8h.html#a148bc85e3074e324a6dc5eebcad1bcd5">OBJ_ENCODING_RAW</a>;</div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;    o-&gt;ptr = ptr;</div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;    o-&gt;refcount = 1;</div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;</div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;    <span class="comment">/* Set the LRU to the current lruclock (minutes resolution), or</span></div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;<span class="comment">     * alternatively the LFU counter. */</span></div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;    <span class="keywordflow">if</span> (server.maxmemory_policy &amp; <a class="code" href="server_8h.html#aac2d3ad7a604f87e06e25233dbd01c9b">MAXMEMORY_FLAG_LFU</a>) {</div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;        o-&gt;lru = (LFUGetTimeInMinutes()&lt;&lt;8) | <a class="code" href="server_8h.html#a8cec44bf7da67aac58839ab5033bdc0a">LFU_INIT_VAL</a>;</div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;        o-&gt;lru = LRU_CLOCK();</div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;    }</div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;    <span class="keywordflow">return</span> o;</div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;}</div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;</div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;<span class="comment">/* Set a special refcount in the object to make it &quot;shared&quot;:</span></div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;<span class="comment"> * incrRefCount and decrRefCount() will test for this special refcount</span></div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;<span class="comment"> * and will not touch the object. This way it is free to access shared</span></div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;<span class="comment"> * objects such as small integers from different threads without any</span></div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;<span class="comment"> * mutex.</span></div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;<span class="comment"> * A common patter to create shared objects:</span></div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;<span class="comment"> * robj *myobject = makeObjectShared(createObject(...));</span></div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;robj *makeObjectShared(robj *o) {</div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;    <a class="code" href="server_8h.html#a88114b5169b4c382df6b56506285e56a">serverAssert</a>(o-&gt;refcount == 1);</div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;    o-&gt;refcount = <a class="code" href="server_8h.html#a1dc2a137875b0c8ee0fa1df43684a7b8">OBJ_SHARED_REFCOUNT</a>;</div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;    <span class="keywordflow">return</span> o;</div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;}</div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;</div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;<span class="comment">/* Create a string object with encoding OBJ_ENCODING_RAW, that is a plain</span></div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;<span class="comment"> * string object where o-&gt;ptr points to a proper sds string. */</span></div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;robj *createRawStringObject(<span class="keyword">const</span> <span class="keywordtype">char</span> *ptr, size_t len) {</div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;    <span class="keywordflow">return</span> createObject(<a class="code" href="server_8h.html#a65236ea160f69cdef33ec942092af88f">OBJ_STRING</a>, sdsnewlen(ptr,len));</div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;}</div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;</div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;<span class="comment">/* Create a string object with encoding OBJ_ENCODING_EMBSTR, that is</span></div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;<span class="comment"> * an object where the sds string is actually an unmodifiable string</span></div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;<span class="comment"> * allocated in the same chunk as the object itself. */</span></div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;robj *createEmbeddedStringObject(<span class="keyword">const</span> <span class="keywordtype">char</span> *ptr, size_t len) {</div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;    robj *o = zmalloc(<span class="keyword">sizeof</span>(robj)+<span class="keyword">sizeof</span>(<span class="keyword">struct</span> sdshdr8)+len+1);</div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;    <span class="keyword">struct</span> sdshdr8 *sh = (<span class="keywordtype">void</span>*)(o+1);</div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;</div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;    o-&gt;type = <a class="code" href="server_8h.html#a65236ea160f69cdef33ec942092af88f">OBJ_STRING</a>;</div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;    o-&gt;encoding = <a class="code" href="server_8h.html#ac5bb76b546161fd0da4b0ff89b3142ee">OBJ_ENCODING_EMBSTR</a>;</div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;    o-&gt;ptr = sh+1;</div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;    o-&gt;refcount = 1;</div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;    <span class="keywordflow">if</span> (server.maxmemory_policy &amp; <a class="code" href="server_8h.html#aac2d3ad7a604f87e06e25233dbd01c9b">MAXMEMORY_FLAG_LFU</a>) {</div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;        o-&gt;lru = (LFUGetTimeInMinutes()&lt;&lt;8) | <a class="code" href="server_8h.html#a8cec44bf7da67aac58839ab5033bdc0a">LFU_INIT_VAL</a>;</div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;        o-&gt;lru = LRU_CLOCK();</div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;    }</div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;</div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;    sh-&gt;len = len;</div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;    sh-&gt;alloc = len;</div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;    sh-&gt;flags = <a class="code" href="sds_8h.html#a504136356f04bfa2fd616dd4c8fdd71c">SDS_TYPE_8</a>;</div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;    <span class="keywordflow">if</span> (ptr) {</div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;        memcpy(sh-&gt;buf,ptr,len);</div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;        sh-&gt;buf[len] = <span class="stringliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;        memset(sh-&gt;buf,0,len+1);</div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;    }</div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;    <span class="keywordflow">return</span> o;</div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;}</div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;</div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;<span class="comment">/* Create a string object with EMBSTR encoding if it is smaller than</span></div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;<span class="comment"> * OBJ_ENCODING_EMBSTR_SIZE_LIMIT, otherwise the RAW encoding is</span></div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;<span class="comment"> * used.</span></div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;<span class="comment"> * The current limit of 39 is chosen so that the biggest string object</span></div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;<span class="comment"> * we allocate as EMBSTR will still fit into the 64 byte arena of jemalloc. */</span></div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">define</span> <span class="preprocessor">OBJ_ENCODING_EMBSTR_SIZE_LIMIT</span> 44</div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;robj *createStringObject(<span class="keyword">const</span> <span class="keywordtype">char</span> *ptr, size_t len) {</div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;    <span class="keywordflow">if</span> (len &lt;= <a class="code" href="object_8c.html#a3e762d5fac271c94b01875920ff57fb2">OBJ_ENCODING_EMBSTR_SIZE_LIMIT</a>)</div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;        <span class="keywordflow">return</span> createEmbeddedStringObject(ptr,len);</div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;        <span class="keywordflow">return</span> createRawStringObject(ptr,len);</div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;}</div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;</div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;robj *createStringObjectFromLongLong(<span class="keywordtype">long</span> <span class="keywordtype">long</span> value) {</div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;    robj *o;</div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;    <span class="keywordflow">if</span> (value &gt;= 0 &amp;&amp; value &lt; <a class="code" href="server_8h.html#a311fc8b18b93af94e1ad418f1386b519">OBJ_SHARED_INTEGERS</a>) {</div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;        incrRefCount(shared.integers[value]);</div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;        o = shared.integers[value];</div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;        <span class="keywordflow">if</span> (value &gt;= LONG_MIN &amp;&amp; value &lt;= LONG_MAX) {</div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;            o = createObject(<a class="code" href="server_8h.html#a65236ea160f69cdef33ec942092af88f">OBJ_STRING</a>, NULL);</div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;            o-&gt;encoding = <a class="code" href="server_8h.html#ae934cf008a0be0ef009c92c2d006a816">OBJ_ENCODING_INT</a>;</div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;            o-&gt;ptr = (<span class="keywordtype">void</span>*)((<span class="keywordtype">long</span>)value);</div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;        } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;            o = createObject(<a class="code" href="server_8h.html#a65236ea160f69cdef33ec942092af88f">OBJ_STRING</a>,sdsfromlonglong(value));</div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;        }</div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;    }</div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;    <span class="keywordflow">return</span> o;</div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;}</div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;</div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;<span class="comment">/* Create a string object from a long double. If humanfriendly is non-zero</span></div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;<span class="comment"> * it does not use exponential format and trims trailing zeroes at the end,</span></div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;<span class="comment"> * however this results in loss of precision. Otherwise exp format is used</span></div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;<span class="comment"> * and the output of snprintf() is not modified.</span></div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;<span class="comment"> * The &#39;humanfriendly&#39; option is used for INCRBYFLOAT and HINCRBYFLOAT. */</span></div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;robj *createStringObjectFromLongDouble(<span class="keywordtype">long</span> <span class="keywordtype">double</span> value, <span class="keywordtype">int</span> humanfriendly) {</div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;    <span class="keywordtype">char</span> buf[256];</div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;    <span class="keywordtype">int</span> len = ld2string(buf,<span class="keyword">sizeof</span>(buf),value,humanfriendly);</div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;    <span class="keywordflow">return</span> createStringObject(buf,len);</div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;}</div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;</div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;<span class="comment">/* Duplicate a string object, with the guarantee that the returned object</span></div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;<span class="comment"> * has the same encoding as the original one.</span></div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;<span class="comment"> * This function also guarantees that duplicating a small integere object</span></div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;<span class="comment"> * (or a string object that contains a representation of a small integer)</span></div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;<span class="comment"> * will always result in a fresh object that is unshared (refcount == 1).</span></div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;<span class="comment"> * The resulting object always has refcount set to 1. */</span></div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;robj *dupStringObject(<span class="keyword">const</span> robj *o) {</div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;    robj *d;</div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;</div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;    <a class="code" href="server_8h.html#a88114b5169b4c382df6b56506285e56a">serverAssert</a>(o-&gt;type == <a class="code" href="server_8h.html#a65236ea160f69cdef33ec942092af88f">OBJ_STRING</a>);</div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;</div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;    <span class="keywordflow">switch</span>(o-&gt;encoding) {</div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="server_8h.html#a148bc85e3074e324a6dc5eebcad1bcd5">OBJ_ENCODING_RAW</a>:</div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;        <span class="keywordflow">return</span> createRawStringObject(o-&gt;ptr,sdslen(o-&gt;ptr));</div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="server_8h.html#ac5bb76b546161fd0da4b0ff89b3142ee">OBJ_ENCODING_EMBSTR</a>:</div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;        <span class="keywordflow">return</span> createEmbeddedStringObject(o-&gt;ptr,sdslen(o-&gt;ptr));</div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="server_8h.html#ae934cf008a0be0ef009c92c2d006a816">OBJ_ENCODING_INT</a>:</div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;        d = createObject(<a class="code" href="server_8h.html#a65236ea160f69cdef33ec942092af88f">OBJ_STRING</a>, NULL);</div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;        d-&gt;encoding = <a class="code" href="server_8h.html#ae934cf008a0be0ef009c92c2d006a816">OBJ_ENCODING_INT</a>;</div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;        d-&gt;ptr = o-&gt;ptr;</div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;        <span class="keywordflow">return</span> d;</div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;    <span class="keywordflow">default</span>:</div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;        <a class="code" href="server_8h.html#a11cc378e7778a830b41240578de3b204">serverPanic</a>(<span class="stringliteral">&quot;Wrong encoding.&quot;</span>);</div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;    }</div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;}</div><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;</div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;robj *createQuicklistObject(<span class="keywordtype">void</span>) {</div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;    quicklist *l = quicklistCreate();</div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;    robj *o = createObject(<a class="code" href="server_8h.html#a4a5f22a280949c97a0cb0d4213275126">OBJ_LIST</a>,l);</div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;    o-&gt;encoding = <a class="code" href="server_8h.html#aec792aeed6d4bf83966672e6a23043b8">OBJ_ENCODING_QUICKLIST</a>;</div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;    <span class="keywordflow">return</span> o;</div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;}</div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;</div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;robj *createZiplistObject(<span class="keywordtype">void</span>) {</div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *zl = ziplistNew();</div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;    robj *o = createObject(<a class="code" href="server_8h.html#a4a5f22a280949c97a0cb0d4213275126">OBJ_LIST</a>,zl);</div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;    o-&gt;encoding = <a class="code" href="server_8h.html#aabf064ede983103f1fd0df2086e84eee">OBJ_ENCODING_ZIPLIST</a>;</div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;    <span class="keywordflow">return</span> o;</div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;}</div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;</div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;robj *createSetObject(<span class="keywordtype">void</span>) {</div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;    dict *d = dictCreate(&amp;setDictType,NULL);</div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;    robj *o = createObject(<a class="code" href="server_8h.html#a8d179375a4aac33d3fa7aa80c8ccc75f">OBJ_SET</a>,d);</div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;    o-&gt;encoding = <a class="code" href="server_8h.html#a9c10219f68afc557d510d108257d238b">OBJ_ENCODING_HT</a>;</div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;    <span class="keywordflow">return</span> o;</div><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;}</div><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;</div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;robj *createIntsetObject(<span class="keywordtype">void</span>) {</div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;    intset *is = intsetNew();</div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;    robj *o = createObject(<a class="code" href="server_8h.html#a8d179375a4aac33d3fa7aa80c8ccc75f">OBJ_SET</a>,is);</div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;    o-&gt;encoding = <a class="code" href="server_8h.html#a214173987de21c3b7661fddd42b05873">OBJ_ENCODING_INTSET</a>;</div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;    <span class="keywordflow">return</span> o;</div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;}</div><div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;</div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;robj *createHashObject(<span class="keywordtype">void</span>) {</div><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *zl = ziplistNew();</div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;    robj *o = createObject(<a class="code" href="server_8h.html#a87c05ba4f7f36741864277f02a4423fb">OBJ_HASH</a>, zl);</div><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;    o-&gt;encoding = <a class="code" href="server_8h.html#aabf064ede983103f1fd0df2086e84eee">OBJ_ENCODING_ZIPLIST</a>;</div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;    <span class="keywordflow">return</span> o;</div><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;}</div><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;</div><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;robj *createZsetObject(<span class="keywordtype">void</span>) {</div><div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;    zset *zs = zmalloc(<span class="keyword">sizeof</span>(*zs));</div><div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;    robj *o;</div><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;</div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;    zs-&gt;dict = dictCreate(&amp;zsetDictType,NULL);</div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;    zs-&gt;zsl = zslCreate();</div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;    o = createObject(<a class="code" href="server_8h.html#a8c356422ddbc03bd77694880a30a1953">OBJ_ZSET</a>,zs);</div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;    o-&gt;encoding = <a class="code" href="server_8h.html#acfb35db5cb30ed113ed23aeb1a224c4c">OBJ_ENCODING_SKIPLIST</a>;</div><div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;    <span class="keywordflow">return</span> o;</div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;}</div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;</div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;robj *createZsetZiplistObject(<span class="keywordtype">void</span>) {</div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *zl = ziplistNew();</div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;    robj *o = createObject(<a class="code" href="server_8h.html#a8c356422ddbc03bd77694880a30a1953">OBJ_ZSET</a>,zl);</div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;    o-&gt;encoding = <a class="code" href="server_8h.html#aabf064ede983103f1fd0df2086e84eee">OBJ_ENCODING_ZIPLIST</a>;</div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;    <span class="keywordflow">return</span> o;</div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;}</div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;</div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;robj *createStreamObject(<span class="keywordtype">void</span>) {</div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;    stream *s = streamNew();</div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;    robj *o = createObject(<a class="code" href="server_8h.html#a2c2cc41300ca6b9daca7ea8a6d66edc6">OBJ_STREAM</a>,s);</div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;    o-&gt;encoding = <a class="code" href="server_8h.html#a8ed2d5ecb3c5343c4286f9c3a2346045">OBJ_ENCODING_STREAM</a>;</div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;    <span class="keywordflow">return</span> o;</div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;}</div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;</div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;robj *createModuleObject(moduleType *mt, <span class="keywordtype">void</span> *value) {</div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;    moduleValue *mv = zmalloc(<span class="keyword">sizeof</span>(*mv));</div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;    mv-&gt;type = mt;</div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;    mv-&gt;value = value;</div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;    <span class="keywordflow">return</span> createObject(<a class="code" href="server_8h.html#a92c1fed85f709180fda0ff10d37d649b">OBJ_MODULE</a>,mv);</div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;}</div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;</div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;<span class="keywordtype">void</span> freeStringObject(robj *o) {</div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;    <span class="keywordflow">if</span> (o-&gt;encoding == <a class="code" href="server_8h.html#a148bc85e3074e324a6dc5eebcad1bcd5">OBJ_ENCODING_RAW</a>) {</div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;        sdsfree(o-&gt;ptr);</div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;    }</div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;}</div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;</div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;<span class="keywordtype">void</span> freeListObject(robj *o) {</div><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;    <span class="keywordflow">if</span> (o-&gt;encoding == <a class="code" href="server_8h.html#aec792aeed6d4bf83966672e6a23043b8">OBJ_ENCODING_QUICKLIST</a>) {</div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;        quicklistRelease(o-&gt;ptr);</div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;        <a class="code" href="server_8h.html#a11cc378e7778a830b41240578de3b204">serverPanic</a>(<span class="stringliteral">&quot;Unknown list encoding type&quot;</span>);</div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;    }</div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;}</div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;</div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;<span class="keywordtype">void</span> freeSetObject(robj *o) {</div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;    <span class="keywordflow">switch</span> (o-&gt;encoding) {</div><div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="server_8h.html#a9c10219f68afc557d510d108257d238b">OBJ_ENCODING_HT</a>:</div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;        dictRelease((dict*) o-&gt;ptr);</div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="server_8h.html#a214173987de21c3b7661fddd42b05873">OBJ_ENCODING_INTSET</a>:</div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;        zfree(o-&gt;ptr);</div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;    <span class="keywordflow">default</span>:</div><div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;        <a class="code" href="server_8h.html#a11cc378e7778a830b41240578de3b204">serverPanic</a>(<span class="stringliteral">&quot;Unknown set encoding type&quot;</span>);</div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;    }</div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;}</div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;</div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;<span class="keywordtype">void</span> freeZsetObject(robj *o) {</div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;    zset *zs;</div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;    <span class="keywordflow">switch</span> (o-&gt;encoding) {</div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="server_8h.html#acfb35db5cb30ed113ed23aeb1a224c4c">OBJ_ENCODING_SKIPLIST</a>:</div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;        zs = o-&gt;ptr;</div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;        dictRelease(zs-&gt;dict);</div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;        zslFree(zs-&gt;zsl);</div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;        zfree(zs);</div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="server_8h.html#aabf064ede983103f1fd0df2086e84eee">OBJ_ENCODING_ZIPLIST</a>:</div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;        zfree(o-&gt;ptr);</div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;    <span class="keywordflow">default</span>:</div><div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;        <a class="code" href="server_8h.html#a11cc378e7778a830b41240578de3b204">serverPanic</a>(<span class="stringliteral">&quot;Unknown sorted set encoding&quot;</span>);</div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;    }</div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;}</div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;</div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;<span class="keywordtype">void</span> freeHashObject(robj *o) {</div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;    <span class="keywordflow">switch</span> (o-&gt;encoding) {</div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="server_8h.html#a9c10219f68afc557d510d108257d238b">OBJ_ENCODING_HT</a>:</div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;        dictRelease((dict*) o-&gt;ptr);</div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="server_8h.html#aabf064ede983103f1fd0df2086e84eee">OBJ_ENCODING_ZIPLIST</a>:</div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;        zfree(o-&gt;ptr);</div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;    <span class="keywordflow">default</span>:</div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;        <a class="code" href="server_8h.html#a11cc378e7778a830b41240578de3b204">serverPanic</a>(<span class="stringliteral">&quot;Unknown hash encoding type&quot;</span>);</div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;    }</div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;}</div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;</div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;<span class="keywordtype">void</span> freeModuleObject(robj *o) {</div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;    moduleValue *mv = o-&gt;ptr;</div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;    mv-&gt;type-&gt;free(mv-&gt;value);</div><div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;    zfree(mv);</div><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;}</div><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;</div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;<span class="keywordtype">void</span> freeStreamObject(robj *o) {</div><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;    freeStream(o-&gt;ptr);</div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;}</div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;</div><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;<span class="keywordtype">void</span> incrRefCount(robj *o) {</div><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;    <span class="keywordflow">if</span> (o-&gt;refcount != <a class="code" href="server_8h.html#a1dc2a137875b0c8ee0fa1df43684a7b8">OBJ_SHARED_REFCOUNT</a>) o-&gt;refcount++;</div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;}</div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;</div><div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;<span class="keywordtype">void</span> decrRefCount(robj *o) {</div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;    <span class="keywordflow">if</span> (o-&gt;refcount == 1) {</div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;        <span class="keywordflow">switch</span>(o-&gt;type) {</div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="server_8h.html#a65236ea160f69cdef33ec942092af88f">OBJ_STRING</a>: freeStringObject(o); <span class="keywordflow">break</span>;</div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="server_8h.html#a4a5f22a280949c97a0cb0d4213275126">OBJ_LIST</a>: freeListObject(o); <span class="keywordflow">break</span>;</div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="server_8h.html#a8d179375a4aac33d3fa7aa80c8ccc75f">OBJ_SET</a>: freeSetObject(o); <span class="keywordflow">break</span>;</div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="server_8h.html#a8c356422ddbc03bd77694880a30a1953">OBJ_ZSET</a>: freeZsetObject(o); <span class="keywordflow">break</span>;</div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="server_8h.html#a87c05ba4f7f36741864277f02a4423fb">OBJ_HASH</a>: freeHashObject(o); <span class="keywordflow">break</span>;</div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="server_8h.html#a92c1fed85f709180fda0ff10d37d649b">OBJ_MODULE</a>: freeModuleObject(o); <span class="keywordflow">break</span>;</div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="server_8h.html#a2c2cc41300ca6b9daca7ea8a6d66edc6">OBJ_STREAM</a>: freeStreamObject(o); <span class="keywordflow">break</span>;</div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;        <span class="keywordflow">default</span>: <a class="code" href="server_8h.html#a11cc378e7778a830b41240578de3b204">serverPanic</a>(<span class="stringliteral">&quot;Unknown object type&quot;</span>); <span class="keywordflow">break</span>;</div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;        }</div><div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;        zfree(o);</div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;        <span class="keywordflow">if</span> (o-&gt;refcount &lt;= 0) <a class="code" href="server_8h.html#a11cc378e7778a830b41240578de3b204">serverPanic</a>(<span class="stringliteral">&quot;decrRefCount against refcount &lt;= 0&quot;</span>);</div><div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;        <span class="keywordflow">if</span> (o-&gt;refcount != <a class="code" href="server_8h.html#a1dc2a137875b0c8ee0fa1df43684a7b8">OBJ_SHARED_REFCOUNT</a>) o-&gt;refcount--;</div><div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;    }</div><div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;}</div><div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;</div><div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;<span class="comment">/* This variant of decrRefCount() gets its argument as void, and is useful</span></div><div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;<span class="comment"> * as free method in data structures that expect a &#39;void free_object(void*)&#39;</span></div><div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;<span class="comment"> * prototype for the free method. */</span></div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;<span class="keywordtype">void</span> decrRefCountVoid(<span class="keywordtype">void</span> *o) {</div><div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;    decrRefCount(o);</div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;}</div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;</div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;<span class="comment">/* This function set the ref count to zero without freeing the object.</span></div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;<span class="comment"> * It is useful in order to pass a new object to functions incrementing</span></div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;<span class="comment"> * the ref count of the received object. Example:</span></div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;<span class="comment"> *    functionThatWillIncrementRefCount(resetRefCount(CreateObject(...)));</span></div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;<span class="comment"> * Otherwise you need to resort to the less elegant pattern:</span></div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;<span class="comment"> *    *obj = createObject(...);</span></div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;<span class="comment"> *    functionThatWillIncrementRefCount(obj);</span></div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;<span class="comment"> *    decrRefCount(obj);</span></div><div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;robj *resetRefCount(robj *obj) {</div><div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;    obj-&gt;refcount = 0;</div><div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;    <span class="keywordflow">return</span> obj;</div><div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;}</div><div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;</div><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;<span class="keywordtype">int</span> checkType(<a class="code" href="structclient.html">client</a> *c, robj *o, <span class="keywordtype">int</span> type) {</div><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;    <span class="keywordflow">if</span> (o-&gt;type != type) {</div><div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;        addReply(c,shared.wrongtypeerr);</div><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;        <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;    }</div><div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;    <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;}</div><div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;</div><div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;<span class="keywordtype">int</span> isSdsRepresentableAsLongLong(sds s, <span class="keywordtype">long</span> <span class="keywordtype">long</span> *llval) {</div><div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;    <span class="keywordflow">return</span> string2ll(s,sdslen(s),llval) ? <a class="code" href="server_8h.html#a303769ef1065076e68731584e758d3e1">C_OK</a> : <a class="code" href="server_8h.html#af98ac28d5f4d23d7ed5985188e6fb7d1">C_ERR</a>;</div><div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;}</div><div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;</div><div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;<span class="keywordtype">int</span> isObjectRepresentableAsLongLong(robj *o, <span class="keywordtype">long</span> <span class="keywordtype">long</span> *llval) {</div><div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;    <a class="code" href="server_8h.html#a7308f76cbff9a8d3797fe78190b91282">serverAssertWithInfo</a>(NULL,o,o-&gt;type == <a class="code" href="server_8h.html#a65236ea160f69cdef33ec942092af88f">OBJ_STRING</a>);</div><div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;    <span class="keywordflow">if</span> (o-&gt;encoding == <a class="code" href="server_8h.html#ae934cf008a0be0ef009c92c2d006a816">OBJ_ENCODING_INT</a>) {</div><div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;        <span class="keywordflow">if</span> (llval) *llval = (<span class="keywordtype">long</span>) o-&gt;ptr;</div><div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="server_8h.html#a303769ef1065076e68731584e758d3e1">C_OK</a>;</div><div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;        <span class="keywordflow">return</span> isSdsRepresentableAsLongLong(o-&gt;ptr,llval);</div><div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;    }</div><div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;}</div><div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;</div><div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;<span class="comment">/* Try to encode a string object in order to save space */</span></div><div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;robj *tryObjectEncoding(robj *o) {</div><div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;    <span class="keywordtype">long</span> value;</div><div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;    sds s = o-&gt;ptr;</div><div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;    size_t len;</div><div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;</div><div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;    <span class="comment">/* Make sure this is a string object, the only type we encode</span></div><div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;<span class="comment">     * in this function. Other types use encoded memory efficient</span></div><div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;<span class="comment">     * representations but are handled by the commands implementing</span></div><div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;<span class="comment">     * the type. */</span></div><div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;    <a class="code" href="server_8h.html#a7308f76cbff9a8d3797fe78190b91282">serverAssertWithInfo</a>(NULL,o,o-&gt;type == <a class="code" href="server_8h.html#a65236ea160f69cdef33ec942092af88f">OBJ_STRING</a>);</div><div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;</div><div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;    <span class="comment">/* We try some specialized encoding only for objects that are</span></div><div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;<span class="comment">     * RAW or EMBSTR encoded, in other words objects that are still</span></div><div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;<span class="comment">     * in represented by an actually array of chars. */</span></div><div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="server_8h.html#afcfb5bd97af52d1dbce331745cae030c">sdsEncodedObject</a>(o)) <span class="keywordflow">return</span> o;</div><div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;</div><div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;    <span class="comment">/* It&#39;s not safe to encode shared objects: shared objects can be shared</span></div><div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;<span class="comment">     * everywhere in the &quot;object space&quot; of Redis and may end in places where</span></div><div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;<span class="comment">     * they are not handled. We handle them only as values in the keyspace. */</span></div><div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;     <span class="keywordflow">if</span> (o-&gt;refcount &gt; 1) <span class="keywordflow">return</span> o;</div><div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;</div><div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;    <span class="comment">/* Check if we can represent this string as a long integer.</span></div><div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;<span class="comment">     * Note that we are sure that a string larger than 20 chars is not</span></div><div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;<span class="comment">     * representable as a 32 nor 64 bit integer. */</span></div><div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;    len = sdslen(s);</div><div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;    <span class="keywordflow">if</span> (len &lt;= 20 &amp;&amp; string2l(s,len,&amp;value)) {</div><div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;        <span class="comment">/* This object is encodable as a long. Try to use a shared object.</span></div><div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;<span class="comment">         * Note that we avoid using shared integers when maxmemory is used</span></div><div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;<span class="comment">         * because every object needs to have a private LRU field for the LRU</span></div><div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;<span class="comment">         * algorithm to work well. */</span></div><div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;        <span class="keywordflow">if</span> ((server.maxmemory == 0 ||</div><div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;            !(server.maxmemory_policy &amp; <a class="code" href="server_8h.html#a15f4654e0f62585fa6ea50ede84598d5">MAXMEMORY_FLAG_NO_SHARED_INTEGERS</a>)) &amp;&amp;</div><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;            value &gt;= 0 &amp;&amp;</div><div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;            value &lt; <a class="code" href="server_8h.html#a311fc8b18b93af94e1ad418f1386b519">OBJ_SHARED_INTEGERS</a>)</div><div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;        {</div><div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;            decrRefCount(o);</div><div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;            incrRefCount(shared.integers[value]);</div><div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;            <span class="keywordflow">return</span> shared.integers[value];</div><div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;        } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;            <span class="keywordflow">if</span> (o-&gt;encoding == <a class="code" href="server_8h.html#a148bc85e3074e324a6dc5eebcad1bcd5">OBJ_ENCODING_RAW</a>) sdsfree(o-&gt;ptr);</div><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;            o-&gt;encoding = <a class="code" href="server_8h.html#ae934cf008a0be0ef009c92c2d006a816">OBJ_ENCODING_INT</a>;</div><div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;            o-&gt;ptr = (<span class="keywordtype">void</span>*) value;</div><div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;            <span class="keywordflow">return</span> o;</div><div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;        }</div><div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;    }</div><div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;</div><div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;    <span class="comment">/* If the string is small and is still RAW encoded,</span></div><div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;<span class="comment">     * try the EMBSTR encoding which is more efficient.</span></div><div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;<span class="comment">     * In this representation the object and the SDS string are allocated</span></div><div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;<span class="comment">     * in the same chunk of memory to save space and cache misses. */</span></div><div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;    <span class="keywordflow">if</span> (len &lt;= <a class="code" href="object_8c.html#a3e762d5fac271c94b01875920ff57fb2">OBJ_ENCODING_EMBSTR_SIZE_LIMIT</a>) {</div><div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;        robj *emb;</div><div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;</div><div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;        <span class="keywordflow">if</span> (o-&gt;encoding == <a class="code" href="server_8h.html#ac5bb76b546161fd0da4b0ff89b3142ee">OBJ_ENCODING_EMBSTR</a>) <span class="keywordflow">return</span> o;</div><div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;        emb = createEmbeddedStringObject(s,sdslen(s));</div><div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;        decrRefCount(o);</div><div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;        <span class="keywordflow">return</span> emb;</div><div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;    }</div><div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;</div><div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;    <span class="comment">/* We can&#39;t encode the object...</span></div><div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;<span class="comment">     *</span></div><div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;<span class="comment">     * Do the last try, and at least optimize the SDS string inside</span></div><div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;<span class="comment">     * the string object to require little space, in case there</span></div><div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;<span class="comment">     * is more than 10% of free space at the end of the SDS string.</span></div><div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;<span class="comment">     *</span></div><div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;<span class="comment">     * We do that only for relatively large strings as this branch</span></div><div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;<span class="comment">     * is only entered if the length of the string is greater than</span></div><div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;<span class="comment">     * OBJ_ENCODING_EMBSTR_SIZE_LIMIT. */</span></div><div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;    <span class="keywordflow">if</span> (o-&gt;encoding == <a class="code" href="server_8h.html#a148bc85e3074e324a6dc5eebcad1bcd5">OBJ_ENCODING_RAW</a> &amp;&amp;</div><div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;        sdsavail(s) &gt; len/10)</div><div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;    {</div><div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;        o-&gt;ptr = sdsRemoveFreeSpace(o-&gt;ptr);</div><div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;    }</div><div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;</div><div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;    <span class="comment">/* Return the original object. */</span></div><div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;    <span class="keywordflow">return</span> o;</div><div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;}</div><div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;</div><div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;<span class="comment">/* Get a decoded version of an encoded object (returned as a new object).</span></div><div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;<span class="comment"> * If the object is already raw-encoded just increment the ref count. */</span></div><div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;robj *getDecodedObject(robj *o) {</div><div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;    robj *dec;</div><div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;</div><div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="server_8h.html#afcfb5bd97af52d1dbce331745cae030c">sdsEncodedObject</a>(o)) {</div><div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;        incrRefCount(o);</div><div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;        <span class="keywordflow">return</span> o;</div><div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;    }</div><div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;    <span class="keywordflow">if</span> (o-&gt;type == <a class="code" href="server_8h.html#a65236ea160f69cdef33ec942092af88f">OBJ_STRING</a> &amp;&amp; o-&gt;encoding == <a class="code" href="server_8h.html#ae934cf008a0be0ef009c92c2d006a816">OBJ_ENCODING_INT</a>) {</div><div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;        <span class="keywordtype">char</span> buf[32];</div><div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;</div><div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;        ll2string(buf,32,(<span class="keywordtype">long</span>)o-&gt;ptr);</div><div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;        dec = createStringObject(buf,strlen(buf));</div><div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;        <span class="keywordflow">return</span> dec;</div><div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;        <a class="code" href="server_8h.html#a11cc378e7778a830b41240578de3b204">serverPanic</a>(<span class="stringliteral">&quot;Unknown encoding type&quot;</span>);</div><div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;    }</div><div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;}</div><div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;</div><div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;<span class="comment">/* Compare two string objects via strcmp() or strcoll() depending on flags.</span></div><div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;<span class="comment"> * Note that the objects may be integer-encoded. In such a case we</span></div><div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;<span class="comment"> * use ll2string() to get a string representation of the numbers on the stack</span></div><div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;<span class="comment"> * and compare the strings, it&#39;s much faster than calling getDecodedObject().</span></div><div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;<span class="comment"> * Important note: when REDIS_COMPARE_BINARY is used a binary-safe comparison</span></div><div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;<span class="comment"> * is used. */</span></div><div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;</div><div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">define</span> <span class="preprocessor">REDIS_COMPARE_BINARY</span> <span class="preprocessor">(</span>1<span class="preprocessor">&lt;&lt;</span>0<span class="preprocessor">)</span></div><div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">define</span> <span class="preprocessor">REDIS_COMPARE_COLL</span> <span class="preprocessor">(</span>1<span class="preprocessor">&lt;&lt;</span>1<span class="preprocessor">)</span></div><div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;</div><div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;<span class="keywordtype">int</span> compareStringObjectsWithFlags(robj *a, robj *b, <span class="keywordtype">int</span> flags) {</div><div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;    <a class="code" href="server_8h.html#a7308f76cbff9a8d3797fe78190b91282">serverAssertWithInfo</a>(NULL,a,a-&gt;type == <a class="code" href="server_8h.html#a65236ea160f69cdef33ec942092af88f">OBJ_STRING</a> &amp;&amp; b-&gt;type == <a class="code" href="server_8h.html#a65236ea160f69cdef33ec942092af88f">OBJ_STRING</a>);</div><div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;    <span class="keywordtype">char</span> bufa[128], bufb[128], *astr, *bstr;</div><div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;    size_t alen, blen, minlen;</div><div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;</div><div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;    <span class="keywordflow">if</span> (a == b) <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="server_8h.html#afcfb5bd97af52d1dbce331745cae030c">sdsEncodedObject</a>(a)) {</div><div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;        astr = a-&gt;ptr;</div><div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;        alen = sdslen(astr);</div><div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;        alen = ll2string(bufa,<span class="keyword">sizeof</span>(bufa),(<span class="keywordtype">long</span>) a-&gt;ptr);</div><div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;        astr = bufa;</div><div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;    }</div><div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="server_8h.html#afcfb5bd97af52d1dbce331745cae030c">sdsEncodedObject</a>(b)) {</div><div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;        bstr = b-&gt;ptr;</div><div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;        blen = sdslen(bstr);</div><div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;        blen = ll2string(bufb,<span class="keyword">sizeof</span>(bufb),(<span class="keywordtype">long</span>) b-&gt;ptr);</div><div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;        bstr = bufb;</div><div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;    }</div><div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;    <span class="keywordflow">if</span> (flags &amp; <a class="code" href="object_8c.html#aa471c38fc2e9e96a23693e7ff5e73209">REDIS_COMPARE_COLL</a>) {</div><div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;        <span class="keywordflow">return</span> strcoll(astr,bstr);</div><div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;        <span class="keywordtype">int</span> cmp;</div><div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;</div><div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;        minlen = (alen &lt; blen) ? alen : blen;</div><div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;        cmp = memcmp(astr,bstr,minlen);</div><div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;        <span class="keywordflow">if</span> (cmp == 0) <span class="keywordflow">return</span> alen-blen;</div><div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;        <span class="keywordflow">return</span> cmp;</div><div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;    }</div><div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;}</div><div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;</div><div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;<span class="comment">/* Wrapper for compareStringObjectsWithFlags() using binary comparison. */</span></div><div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;<span class="keywordtype">int</span> compareStringObjects(robj *a, robj *b) {</div><div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;    <span class="keywordflow">return</span> compareStringObjectsWithFlags(a,b,<a class="code" href="object_8c.html#ac672f1c478e4a045035444729510d946">REDIS_COMPARE_BINARY</a>);</div><div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;}</div><div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;</div><div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;<span class="comment">/* Wrapper for compareStringObjectsWithFlags() using collation. */</span></div><div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;<span class="keywordtype">int</span> collateStringObjects(robj *a, robj *b) {</div><div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;    <span class="keywordflow">return</span> compareStringObjectsWithFlags(a,b,<a class="code" href="object_8c.html#aa471c38fc2e9e96a23693e7ff5e73209">REDIS_COMPARE_COLL</a>);</div><div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;}</div><div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;</div><div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;<span class="comment">/* Equal string objects return 1 if the two objects are the same from the</span></div><div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;<span class="comment"> * point of view of a string comparison, otherwise 0 is returned. Note that</span></div><div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;<span class="comment"> * this function is faster then checking for (compareStringObject(a,b) == 0)</span></div><div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;<span class="comment"> * because it can perform some more optimization. */</span></div><div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;<span class="keywordtype">int</span> equalStringObjects(robj *a, robj *b) {</div><div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;    <span class="keywordflow">if</span> (a-&gt;encoding == <a class="code" href="server_8h.html#ae934cf008a0be0ef009c92c2d006a816">OBJ_ENCODING_INT</a> &amp;&amp;</div><div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;        b-&gt;encoding == <a class="code" href="server_8h.html#ae934cf008a0be0ef009c92c2d006a816">OBJ_ENCODING_INT</a>){</div><div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;        <span class="comment">/* If both strings are integer encoded just check if the stored</span></div><div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;<span class="comment">         * long is the same. */</span></div><div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;        <span class="keywordflow">return</span> a-&gt;ptr == b-&gt;ptr;</div><div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;        <span class="keywordflow">return</span> compareStringObjects(a,b) == 0;</div><div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;    }</div><div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;}</div><div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;</div><div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;size_t stringObjectLen(robj *o) {</div><div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;    <a class="code" href="server_8h.html#a7308f76cbff9a8d3797fe78190b91282">serverAssertWithInfo</a>(NULL,o,o-&gt;type == <a class="code" href="server_8h.html#a65236ea160f69cdef33ec942092af88f">OBJ_STRING</a>);</div><div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="server_8h.html#afcfb5bd97af52d1dbce331745cae030c">sdsEncodedObject</a>(o)) {</div><div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;        <span class="keywordflow">return</span> sdslen(o-&gt;ptr);</div><div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;        <span class="keywordflow">return</span> sdigits10((<span class="keywordtype">long</span>)o-&gt;ptr);</div><div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;    }</div><div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;}</div><div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;</div><div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;<span class="keywordtype">int</span> getDoubleFromObject(<span class="keyword">const</span> robj *o, <span class="keywordtype">double</span> *target) {</div><div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;    <span class="keywordtype">double</span> value;</div><div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;    <span class="keywordtype">char</span> *eptr;</div><div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;</div><div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;    <span class="keywordflow">if</span> (o == NULL) {</div><div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;        value = 0;</div><div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;        <a class="code" href="server_8h.html#a7308f76cbff9a8d3797fe78190b91282">serverAssertWithInfo</a>(NULL,o,o-&gt;type == <a class="code" href="server_8h.html#a65236ea160f69cdef33ec942092af88f">OBJ_STRING</a>);</div><div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="server_8h.html#afcfb5bd97af52d1dbce331745cae030c">sdsEncodedObject</a>(o)) {</div><div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;            errno = 0;</div><div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;            value = strtod(o-&gt;ptr, &amp;eptr);</div><div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;            <span class="keywordflow">if</span> (sdslen(o-&gt;ptr) == 0 ||</div><div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;                isspace(((<span class="keyword">const</span> <span class="keywordtype">char</span>*)o-&gt;ptr)[0]) ||</div><div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;                (size_t)(eptr-(<span class="keywordtype">char</span>*)o-&gt;ptr) != sdslen(o-&gt;ptr) ||</div><div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;                (errno == ERANGE &amp;&amp;</div><div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;                    (value == HUGE_VAL || value == -HUGE_VAL || value == 0)) ||</div><div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;                isnan(value))</div><div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;                <span class="keywordflow">return</span> <a class="code" href="server_8h.html#af98ac28d5f4d23d7ed5985188e6fb7d1">C_ERR</a>;</div><div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (o-&gt;encoding == <a class="code" href="server_8h.html#ae934cf008a0be0ef009c92c2d006a816">OBJ_ENCODING_INT</a>) {</div><div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;            value = (<span class="keywordtype">long</span>)o-&gt;ptr;</div><div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;        } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;            <a class="code" href="server_8h.html#a11cc378e7778a830b41240578de3b204">serverPanic</a>(<span class="stringliteral">&quot;Unknown string encoding&quot;</span>);</div><div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;        }</div><div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;    }</div><div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;    *target = value;</div><div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="server_8h.html#a303769ef1065076e68731584e758d3e1">C_OK</a>;</div><div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;}</div><div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;</div><div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;<span class="keywordtype">int</span> getDoubleFromObjectOrReply(<a class="code" href="structclient.html">client</a> *c, robj *o, <span class="keywordtype">double</span> *target, <span class="keyword">const</span> <span class="keywordtype">char</span> *msg) {</div><div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;    <span class="keywordtype">double</span> value;</div><div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;    <span class="keywordflow">if</span> (getDoubleFromObject(o, &amp;value) != <a class="code" href="server_8h.html#a303769ef1065076e68731584e758d3e1">C_OK</a>) {</div><div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;        <span class="keywordflow">if</span> (msg != NULL) {</div><div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;            addReplyError(c,(<span class="keywordtype">char</span>*)msg);</div><div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;        } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;            addReplyError(c,<span class="stringliteral">&quot;value is not a valid float&quot;</span>);</div><div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;        }</div><div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="server_8h.html#af98ac28d5f4d23d7ed5985188e6fb7d1">C_ERR</a>;</div><div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;    }</div><div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;    *target = value;</div><div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="server_8h.html#a303769ef1065076e68731584e758d3e1">C_OK</a>;</div><div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;}</div><div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;</div><div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;<span class="keywordtype">int</span> getLongDoubleFromObject(robj *o, <span class="keywordtype">long</span> <span class="keywordtype">double</span> *target) {</div><div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;    <span class="keywordtype">long</span> <span class="keywordtype">double</span> value;</div><div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;    <span class="keywordtype">char</span> *eptr;</div><div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;</div><div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;    <span class="keywordflow">if</span> (o == NULL) {</div><div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;        value = 0;</div><div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;        <a class="code" href="server_8h.html#a7308f76cbff9a8d3797fe78190b91282">serverAssertWithInfo</a>(NULL,o,o-&gt;type == <a class="code" href="server_8h.html#a65236ea160f69cdef33ec942092af88f">OBJ_STRING</a>);</div><div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="server_8h.html#afcfb5bd97af52d1dbce331745cae030c">sdsEncodedObject</a>(o)) {</div><div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;            errno = 0;</div><div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;            value = strtold(o-&gt;ptr, &amp;eptr);</div><div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;            <span class="keywordflow">if</span> (sdslen(o-&gt;ptr) == 0 ||</div><div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;                isspace(((<span class="keyword">const</span> <span class="keywordtype">char</span>*)o-&gt;ptr)[0]) ||</div><div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;                (size_t)(eptr-(<span class="keywordtype">char</span>*)o-&gt;ptr) != sdslen(o-&gt;ptr) ||</div><div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;                (errno == ERANGE &amp;&amp;</div><div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;                    (value == HUGE_VAL || value == -HUGE_VAL || value == 0)) ||</div><div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;                isnan(value))</div><div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;                <span class="keywordflow">return</span> <a class="code" href="server_8h.html#af98ac28d5f4d23d7ed5985188e6fb7d1">C_ERR</a>;</div><div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (o-&gt;encoding == <a class="code" href="server_8h.html#ae934cf008a0be0ef009c92c2d006a816">OBJ_ENCODING_INT</a>) {</div><div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;            value = (<span class="keywordtype">long</span>)o-&gt;ptr;</div><div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;        } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;            <a class="code" href="server_8h.html#a11cc378e7778a830b41240578de3b204">serverPanic</a>(<span class="stringliteral">&quot;Unknown string encoding&quot;</span>);</div><div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;        }</div><div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;    }</div><div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;    *target = value;</div><div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="server_8h.html#a303769ef1065076e68731584e758d3e1">C_OK</a>;</div><div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;}</div><div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;</div><div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;<span class="keywordtype">int</span> getLongDoubleFromObjectOrReply(<a class="code" href="structclient.html">client</a> *c, robj *o, <span class="keywordtype">long</span> <span class="keywordtype">double</span> *target, <span class="keyword">const</span> <span class="keywordtype">char</span> *msg) {</div><div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;    <span class="keywordtype">long</span> <span class="keywordtype">double</span> value;</div><div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;    <span class="keywordflow">if</span> (getLongDoubleFromObject(o, &amp;value) != <a class="code" href="server_8h.html#a303769ef1065076e68731584e758d3e1">C_OK</a>) {</div><div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;        <span class="keywordflow">if</span> (msg != NULL) {</div><div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;            addReplyError(c,(<span class="keywordtype">char</span>*)msg);</div><div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;        } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;            addReplyError(c,<span class="stringliteral">&quot;value is not a valid float&quot;</span>);</div><div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;        }</div><div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="server_8h.html#af98ac28d5f4d23d7ed5985188e6fb7d1">C_ERR</a>;</div><div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;    }</div><div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;    *target = value;</div><div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="server_8h.html#a303769ef1065076e68731584e758d3e1">C_OK</a>;</div><div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;}</div><div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;</div><div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;<span class="keywordtype">int</span> getLongLongFromObject(robj *o, <span class="keywordtype">long</span> <span class="keywordtype">long</span> *target) {</div><div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;    <span class="keywordtype">long</span> <span class="keywordtype">long</span> value;</div><div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;</div><div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;    <span class="keywordflow">if</span> (o == NULL) {</div><div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;        value = 0;</div><div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;        <a class="code" href="server_8h.html#a7308f76cbff9a8d3797fe78190b91282">serverAssertWithInfo</a>(NULL,o,o-&gt;type == <a class="code" href="server_8h.html#a65236ea160f69cdef33ec942092af88f">OBJ_STRING</a>);</div><div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="server_8h.html#afcfb5bd97af52d1dbce331745cae030c">sdsEncodedObject</a>(o)) {</div><div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;            <span class="keywordflow">if</span> (string2ll(o-&gt;ptr,sdslen(o-&gt;ptr),&amp;value) == 0) <span class="keywordflow">return</span> <a class="code" href="server_8h.html#af98ac28d5f4d23d7ed5985188e6fb7d1">C_ERR</a>;</div><div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (o-&gt;encoding == <a class="code" href="server_8h.html#ae934cf008a0be0ef009c92c2d006a816">OBJ_ENCODING_INT</a>) {</div><div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;            value = (<span class="keywordtype">long</span>)o-&gt;ptr;</div><div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;        } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;            <a class="code" href="server_8h.html#a11cc378e7778a830b41240578de3b204">serverPanic</a>(<span class="stringliteral">&quot;Unknown string encoding&quot;</span>);</div><div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;        }</div><div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;    }</div><div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;    <span class="keywordflow">if</span> (target) *target = value;</div><div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="server_8h.html#a303769ef1065076e68731584e758d3e1">C_OK</a>;</div><div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;}</div><div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;</div><div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;<span class="keywordtype">int</span> getLongLongFromObjectOrReply(<a class="code" href="structclient.html">client</a> *c, robj *o, <span class="keywordtype">long</span> <span class="keywordtype">long</span> *target, <span class="keyword">const</span> <span class="keywordtype">char</span> *msg) {</div><div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;    <span class="keywordtype">long</span> <span class="keywordtype">long</span> value;</div><div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;    <span class="keywordflow">if</span> (getLongLongFromObject(o, &amp;value) != <a class="code" href="server_8h.html#a303769ef1065076e68731584e758d3e1">C_OK</a>) {</div><div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;        <span class="keywordflow">if</span> (msg != NULL) {</div><div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;            addReplyError(c,(<span class="keywordtype">char</span>*)msg);</div><div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;        } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;            addReplyError(c,<span class="stringliteral">&quot;value is not an integer or out of range&quot;</span>);</div><div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;        }</div><div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="server_8h.html#af98ac28d5f4d23d7ed5985188e6fb7d1">C_ERR</a>;</div><div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;    }</div><div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;    *target = value;</div><div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="server_8h.html#a303769ef1065076e68731584e758d3e1">C_OK</a>;</div><div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;}</div><div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;</div><div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;<span class="keywordtype">int</span> getLongFromObjectOrReply(<a class="code" href="structclient.html">client</a> *c, robj *o, <span class="keywordtype">long</span> *target, <span class="keyword">const</span> <span class="keywordtype">char</span> *msg) {</div><div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;    <span class="keywordtype">long</span> <span class="keywordtype">long</span> value;</div><div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;</div><div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;    <span class="keywordflow">if</span> (getLongLongFromObjectOrReply(c, o, &amp;value, msg) != <a class="code" href="server_8h.html#a303769ef1065076e68731584e758d3e1">C_OK</a>) <span class="keywordflow">return</span> <a class="code" href="server_8h.html#af98ac28d5f4d23d7ed5985188e6fb7d1">C_ERR</a>;</div><div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;    <span class="keywordflow">if</span> (value &lt; LONG_MIN || value &gt; LONG_MAX) {</div><div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;        <span class="keywordflow">if</span> (msg != NULL) {</div><div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;            addReplyError(c,(<span class="keywordtype">char</span>*)msg);</div><div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;        } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;            addReplyError(c,<span class="stringliteral">&quot;value is out of range&quot;</span>);</div><div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;        }</div><div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="server_8h.html#af98ac28d5f4d23d7ed5985188e6fb7d1">C_ERR</a>;</div><div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;    }</div><div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;    *target = value;</div><div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="server_8h.html#a303769ef1065076e68731584e758d3e1">C_OK</a>;</div><div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;}</div><div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;</div><div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;<span class="keywordtype">char</span> *strEncoding(<span class="keywordtype">int</span> encoding) {</div><div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;    <span class="keywordflow">switch</span>(encoding) {</div><div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="server_8h.html#a148bc85e3074e324a6dc5eebcad1bcd5">OBJ_ENCODING_RAW</a>: <span class="keywordflow">return</span> <span class="stringliteral">&quot;raw&quot;</span>;</div><div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="server_8h.html#ae934cf008a0be0ef009c92c2d006a816">OBJ_ENCODING_INT</a>: <span class="keywordflow">return</span> <span class="stringliteral">&quot;int&quot;</span>;</div><div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="server_8h.html#a9c10219f68afc557d510d108257d238b">OBJ_ENCODING_HT</a>: <span class="keywordflow">return</span> <span class="stringliteral">&quot;hashtable&quot;</span>;</div><div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="server_8h.html#aec792aeed6d4bf83966672e6a23043b8">OBJ_ENCODING_QUICKLIST</a>: <span class="keywordflow">return</span> <span class="stringliteral">&quot;quicklist&quot;</span>;</div><div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="server_8h.html#aabf064ede983103f1fd0df2086e84eee">OBJ_ENCODING_ZIPLIST</a>: <span class="keywordflow">return</span> <span class="stringliteral">&quot;ziplist&quot;</span>;</div><div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="server_8h.html#a214173987de21c3b7661fddd42b05873">OBJ_ENCODING_INTSET</a>: <span class="keywordflow">return</span> <span class="stringliteral">&quot;intset&quot;</span>;</div><div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="server_8h.html#acfb35db5cb30ed113ed23aeb1a224c4c">OBJ_ENCODING_SKIPLIST</a>: <span class="keywordflow">return</span> <span class="stringliteral">&quot;skiplist&quot;</span>;</div><div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="server_8h.html#ac5bb76b546161fd0da4b0ff89b3142ee">OBJ_ENCODING_EMBSTR</a>: <span class="keywordflow">return</span> <span class="stringliteral">&quot;embstr&quot;</span>;</div><div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;    <span class="keywordflow">default</span>: <span class="keywordflow">return</span> <span class="stringliteral">&quot;unknown&quot;</span>;</div><div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;    }</div><div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;}</div><div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;</div><div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;<span class="comment">/* =========================== Memory introspection ========================== */</span></div><div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;</div><div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;<span class="comment">/* Returns the size in bytes consumed by the key&#39;s value in RAM.</span></div><div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;<span class="comment"> * Note that the returned value is just an approximation, especially in the</span></div><div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;<span class="comment"> * case of aggregated data types where only &quot;sample_size&quot; elements</span></div><div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;<span class="comment"> * are checked and averaged to estimate the total size. */</span></div><div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">define</span> <span class="preprocessor">OBJ_COMPUTE_SIZE_DEF_SAMPLES</span> 5 <span class="comment">/* Default sample size. */</span></div><div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;size_t objectComputeSize(robj *o, size_t sample_size) {</div><div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;    sds ele, ele2;</div><div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;    dict *d;</div><div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;    dictIterator *di;</div><div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;    <span class="keyword">struct</span> <a class="code" href="structdictEntry.html">dictEntry</a> *de;</div><div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;    size_t asize = 0, elesize = 0, samples = 0;</div><div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;</div><div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;    <span class="keywordflow">if</span> (o-&gt;type == <a class="code" href="server_8h.html#a65236ea160f69cdef33ec942092af88f">OBJ_STRING</a>) {</div><div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;        <span class="keywordflow">if</span>(o-&gt;encoding == <a class="code" href="server_8h.html#ae934cf008a0be0ef009c92c2d006a816">OBJ_ENCODING_INT</a>) {</div><div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;            asize = <span class="keyword">sizeof</span>(*o);</div><div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;        } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(o-&gt;encoding == <a class="code" href="server_8h.html#a148bc85e3074e324a6dc5eebcad1bcd5">OBJ_ENCODING_RAW</a>) {</div><div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;            asize = sdsAllocSize(o-&gt;ptr)+<span class="keyword">sizeof</span>(*o);</div><div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;        } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(o-&gt;encoding == <a class="code" href="server_8h.html#ac5bb76b546161fd0da4b0ff89b3142ee">OBJ_ENCODING_EMBSTR</a>) {</div><div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;            asize = sdslen(o-&gt;ptr)+2+<span class="keyword">sizeof</span>(*o);</div><div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;        } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;            <a class="code" href="server_8h.html#a11cc378e7778a830b41240578de3b204">serverPanic</a>(<span class="stringliteral">&quot;Unknown string encoding&quot;</span>);</div><div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;        }</div><div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (o-&gt;type == <a class="code" href="server_8h.html#a4a5f22a280949c97a0cb0d4213275126">OBJ_LIST</a>) {</div><div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;        <span class="keywordflow">if</span> (o-&gt;encoding == <a class="code" href="server_8h.html#aec792aeed6d4bf83966672e6a23043b8">OBJ_ENCODING_QUICKLIST</a>) {</div><div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;            quicklist *ql = o-&gt;ptr;</div><div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;            quicklistNode *node = ql-&gt;head;</div><div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;            asize = <span class="keyword">sizeof</span>(*o)+<span class="keyword">sizeof</span>(quicklist);</div><div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;            <span class="keywordflow">do</span> {</div><div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;                elesize += <span class="keyword">sizeof</span>(quicklistNode)+ziplistBlobLen(node-&gt;zl);</div><div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;                samples++;</div><div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;            } <span class="keywordflow">while</span> ((node = node-&gt;next) &amp;&amp; samples &lt; sample_size);</div><div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;            asize += (<span class="keywordtype">double</span>)elesize/samples*listTypeLength(o);</div><div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (o-&gt;encoding == <a class="code" href="server_8h.html#aabf064ede983103f1fd0df2086e84eee">OBJ_ENCODING_ZIPLIST</a>) {</div><div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;            asize = <span class="keyword">sizeof</span>(*o)+ziplistBlobLen(o-&gt;ptr);</div><div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;        } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;            <a class="code" href="server_8h.html#a11cc378e7778a830b41240578de3b204">serverPanic</a>(<span class="stringliteral">&quot;Unknown list encoding&quot;</span>);</div><div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;        }</div><div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (o-&gt;type == <a class="code" href="server_8h.html#a8d179375a4aac33d3fa7aa80c8ccc75f">OBJ_SET</a>) {</div><div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;        <span class="keywordflow">if</span> (o-&gt;encoding == <a class="code" href="server_8h.html#a9c10219f68afc557d510d108257d238b">OBJ_ENCODING_HT</a>) {</div><div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;            d = o-&gt;ptr;</div><div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;            di = dictGetIterator(d);</div><div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;            asize = <span class="keyword">sizeof</span>(*o)+<span class="keyword">sizeof</span>(dict)+(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> dictEntry*)*<a class="code" href="dict_8h.html#aca9596be4bcc2caa07c17dd8cebcceec">dictSlots</a>(d));</div><div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;            <span class="keywordflow">while</span>((de = dictNext(di)) != NULL &amp;&amp; samples &lt; sample_size) {</div><div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;                ele = <a class="code" href="dict_8h.html#a3271c334309904a3086deca94f96e46e">dictGetKey</a>(de);</div><div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;                elesize += <span class="keyword">sizeof</span>(<span class="keyword">struct</span> dictEntry) + sdsAllocSize(ele);</div><div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;                samples++;</div><div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;            }</div><div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;            dictReleaseIterator(di);</div><div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;            <span class="keywordflow">if</span> (samples) asize += (<span class="keywordtype">double</span>)elesize/samples*<a class="code" href="dict_8h.html#af193430dd3d5579a52b194512f72c1f0">dictSize</a>(d);</div><div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (o-&gt;encoding == <a class="code" href="server_8h.html#a214173987de21c3b7661fddd42b05873">OBJ_ENCODING_INTSET</a>) {</div><div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;            intset *is = o-&gt;ptr;</div><div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;            asize = <span class="keyword">sizeof</span>(*o)+<span class="keyword">sizeof</span>(*is)+is-&gt;encoding*is-&gt;length;</div><div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;        } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;            <a class="code" href="server_8h.html#a11cc378e7778a830b41240578de3b204">serverPanic</a>(<span class="stringliteral">&quot;Unknown set encoding&quot;</span>);</div><div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;        }</div><div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (o-&gt;type == <a class="code" href="server_8h.html#a8c356422ddbc03bd77694880a30a1953">OBJ_ZSET</a>) {</div><div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;        <span class="keywordflow">if</span> (o-&gt;encoding == <a class="code" href="server_8h.html#aabf064ede983103f1fd0df2086e84eee">OBJ_ENCODING_ZIPLIST</a>) {</div><div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;            asize = <span class="keyword">sizeof</span>(*o)+(ziplistBlobLen(o-&gt;ptr));</div><div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (o-&gt;encoding == <a class="code" href="server_8h.html#acfb35db5cb30ed113ed23aeb1a224c4c">OBJ_ENCODING_SKIPLIST</a>) {</div><div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;            d = ((zset*)o-&gt;ptr)-&gt;dict;</div><div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;            zskiplist *zsl = ((zset*)o-&gt;ptr)-&gt;zsl;</div><div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;            zskiplistNode *znode = zsl-&gt;header-&gt;level[0].forward;</div><div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;            asize = <span class="keyword">sizeof</span>(*o)+<span class="keyword">sizeof</span>(zset)+(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> dictEntry*)*<a class="code" href="dict_8h.html#aca9596be4bcc2caa07c17dd8cebcceec">dictSlots</a>(d));</div><div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;            <span class="keywordflow">while</span>(znode != NULL &amp;&amp; samples &lt; sample_size) {</div><div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;                elesize += sdsAllocSize(znode-&gt;ele);</div><div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;                elesize += <span class="keyword">sizeof</span>(<span class="keyword">struct</span> dictEntry) + zmalloc_size(znode);</div><div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;                samples++;</div><div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;                znode = znode-&gt;level[0].forward;</div><div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;            }</div><div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;            <span class="keywordflow">if</span> (samples) asize += (<span class="keywordtype">double</span>)elesize/samples*<a class="code" href="dict_8h.html#af193430dd3d5579a52b194512f72c1f0">dictSize</a>(d);</div><div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;        } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;            <a class="code" href="server_8h.html#a11cc378e7778a830b41240578de3b204">serverPanic</a>(<span class="stringliteral">&quot;Unknown sorted set encoding&quot;</span>);</div><div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;        }</div><div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (o-&gt;type == <a class="code" href="server_8h.html#a87c05ba4f7f36741864277f02a4423fb">OBJ_HASH</a>) {</div><div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;        <span class="keywordflow">if</span> (o-&gt;encoding == <a class="code" href="server_8h.html#aabf064ede983103f1fd0df2086e84eee">OBJ_ENCODING_ZIPLIST</a>) {</div><div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;            asize = <span class="keyword">sizeof</span>(*o)+(ziplistBlobLen(o-&gt;ptr));</div><div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (o-&gt;encoding == <a class="code" href="server_8h.html#a9c10219f68afc557d510d108257d238b">OBJ_ENCODING_HT</a>) {</div><div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;            d = o-&gt;ptr;</div><div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;            di = dictGetIterator(d);</div><div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;            asize = <span class="keyword">sizeof</span>(*o)+<span class="keyword">sizeof</span>(dict)+(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> dictEntry*)*<a class="code" href="dict_8h.html#aca9596be4bcc2caa07c17dd8cebcceec">dictSlots</a>(d));</div><div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;            <span class="keywordflow">while</span>((de = dictNext(di)) != NULL &amp;&amp; samples &lt; sample_size) {</div><div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;                ele = <a class="code" href="dict_8h.html#a3271c334309904a3086deca94f96e46e">dictGetKey</a>(de);</div><div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;                ele2 = <a class="code" href="dict_8h.html#ae8d2cc391873b2bea2b87c4f80f43120">dictGetVal</a>(de);</div><div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;                elesize += sdsAllocSize(ele) + sdsAllocSize(ele2);</div><div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;                elesize += <span class="keyword">sizeof</span>(<span class="keyword">struct</span> dictEntry);</div><div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;                samples++;</div><div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;            }</div><div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;            dictReleaseIterator(di);</div><div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;            <span class="keywordflow">if</span> (samples) asize += (<span class="keywordtype">double</span>)elesize/samples*<a class="code" href="dict_8h.html#af193430dd3d5579a52b194512f72c1f0">dictSize</a>(d);</div><div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;        } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;            <a class="code" href="server_8h.html#a11cc378e7778a830b41240578de3b204">serverPanic</a>(<span class="stringliteral">&quot;Unknown hash encoding&quot;</span>);</div><div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;        }</div><div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (o-&gt;type == <a class="code" href="server_8h.html#a2c2cc41300ca6b9daca7ea8a6d66edc6">OBJ_STREAM</a>) {</div><div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;        stream *s = o-&gt;ptr;</div><div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;        <span class="comment">/* Note: to guess the size of the radix tree is not trivial, so we</span></div><div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;<span class="comment">         * approximate it considering 64 bytes of data overhead for each</span></div><div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;<span class="comment">         * key (the ID), and then adding the number of bare nodes, plus some</span></div><div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;<span class="comment">         * overhead due by the data and child pointers. This secret recipe</span></div><div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;<span class="comment">         * was obtained by checking the average radix tree created by real</span></div><div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;<span class="comment">         * workloads, and then adjusting the constants to get numbers that</span></div><div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;<span class="comment">         * more or less match the real memory usage.</span></div><div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;<span class="comment">         *</span></div><div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;<span class="comment">         * Actually the number of nodes and keys may be different depending</span></div><div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;<span class="comment">         * on the insertion speed and thus the ability of the radix tree</span></div><div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;<span class="comment">         * to compress prefixes. */</span></div><div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;        asize = <span class="keyword">sizeof</span>(*o);</div><div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;        asize += s-&gt;rax-&gt;numele * 64;</div><div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;        asize += s-&gt;rax-&gt;numnodes * <span class="keyword">sizeof</span>(raxNode);</div><div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;        asize += s-&gt;rax-&gt;numnodes * 32*7; <span class="comment">/* Add a few child pointers... */</span></div><div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;</div><div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;        <span class="comment">/* Now we have to add the listpacks. The last listpack is often non</span></div><div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;<span class="comment">         * complete, so we estimate the size of the first N listpacks, and</span></div><div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;<span class="comment">         * use the average to compute the size of the first N-1 listpacks, and</span></div><div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;<span class="comment">         * finally add the real size of the last node. */</span></div><div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;        <a class="code" href="structraxIterator.html">raxIterator</a> ri;</div><div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;        raxStart(&amp;ri,s-&gt;rax);</div><div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;        raxSeek(&amp;ri,<span class="stringliteral">&quot;^&quot;</span>,NULL,0);</div><div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;        size_t lpsize = 0, samples = 0;</div><div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;        <span class="keywordflow">while</span>(samples &lt; sample_size &amp;&amp; raxNext(&amp;ri)) {</div><div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;            <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *lp = ri.data;</div><div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;            lpsize += lpBytes(lp);</div><div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;            samples++;</div><div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;        }</div><div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;        <span class="keywordflow">if</span> (s-&gt;rax-&gt;numele &lt;= samples) {</div><div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;            asize += lpsize;</div><div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;        } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;            <span class="keywordflow">if</span> (samples) lpsize /= samples; <span class="comment">/* Compute the average. */</span></div><div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;            asize += lpsize * (s-&gt;rax-&gt;numele-1);</div><div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;            <span class="comment">/* No need to check if seek succeeded, we enter this branch only</span></div><div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;<span class="comment">             * if there are a few elements in the radix tree. */</span></div><div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;            raxSeek(&amp;ri,<span class="stringliteral">&quot;$&quot;</span>,NULL,0);</div><div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;            raxNext(&amp;ri);</div><div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;            asize += lpBytes(ri.data);</div><div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;        }</div><div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;        raxStop(&amp;ri);</div><div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (o-&gt;type == <a class="code" href="server_8h.html#a92c1fed85f709180fda0ff10d37d649b">OBJ_MODULE</a>) {</div><div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;        moduleValue *mv = o-&gt;ptr;</div><div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;        moduleType *mt = mv-&gt;type;</div><div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;        <span class="keywordflow">if</span> (mt-&gt;mem_usage != NULL) {</div><div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;            asize = mt-&gt;mem_usage(mv-&gt;value);</div><div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;        } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;            asize = 0;</div><div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;        }</div><div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;        <a class="code" href="server_8h.html#a11cc378e7778a830b41240578de3b204">serverPanic</a>(<span class="stringliteral">&quot;Unknown object type&quot;</span>);</div><div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;    }</div><div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;    <span class="keywordflow">return</span> asize;</div><div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;}</div><div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;</div><div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;<span class="comment">/* Release data obtained with getMemoryOverheadData(). */</span></div><div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;<span class="keywordtype">void</span> freeMemoryOverheadData(<span class="keyword">struct</span> <a class="code" href="structredisMemOverhead.html">redisMemOverhead</a> *mh) {</div><div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;    zfree(mh-&gt;db);</div><div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;    zfree(mh);</div><div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;}</div><div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;</div><div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;<span class="comment">/* Return a struct redisMemOverhead filled with memory overhead</span></div><div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;<span class="comment"> * information used for the MEMORY OVERHEAD and INFO command. The returned</span></div><div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;<span class="comment"> * structure pointer should be freed calling freeMemoryOverheadData(). */</span></div><div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;<span class="keyword">struct</span> <a class="code" href="structredisMemOverhead.html">redisMemOverhead</a> *getMemoryOverheadData(<span class="keywordtype">void</span>) {</div><div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;    <span class="keywordtype">int</span> j;</div><div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;    size_t mem_total = 0;</div><div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;    size_t mem = 0;</div><div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;    size_t zmalloc_used = zmalloc_used_memory();</div><div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;    <span class="keyword">struct</span> <a class="code" href="structredisMemOverhead.html">redisMemOverhead</a> *mh = zcalloc(<span class="keyword">sizeof</span>(*mh));</div><div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;</div><div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;    mh-&gt;total_allocated = zmalloc_used;</div><div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;    mh-&gt;startup_allocated = server.initial_memory_usage;</div><div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;    mh-&gt;peak_allocated = server.stat_peak_memory;</div><div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;    mh-&gt;fragmentation =</div><div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;        zmalloc_get_fragmentation_ratio(server.resident_set_size);</div><div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;    mem_total += server.initial_memory_usage;</div><div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;</div><div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;    mem = 0;</div><div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;    <span class="keywordflow">if</span> (server.repl_backlog)</div><div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;        mem += zmalloc_size(server.repl_backlog);</div><div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;    mh-&gt;repl_backlog = mem;</div><div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;    mem_total += mem;</div><div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;</div><div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;    mem = 0;</div><div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="adlist_8h.html#afde0ab079f934670e82119b43120e94b">listLength</a>(server.slaves)) {</div><div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;        listIter li;</div><div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;        listNode *ln;</div><div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;</div><div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;        listRewind(server.slaves,&amp;li);</div><div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;        <span class="keywordflow">while</span>((ln = listNext(&amp;li))) {</div><div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;            <a class="code" href="structclient.html">client</a> *c = <a class="code" href="adlist_8h.html#af84cae230e7180ebcda1e2736fce9f65">listNodeValue</a>(ln);</div><div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;            mem += getClientOutputBufferMemoryUsage(c);</div><div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;            mem += sdsAllocSize(c-&gt;querybuf);</div><div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;            mem += <span class="keyword">sizeof</span>(client);</div><div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;        }</div><div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;    }</div><div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;    mh-&gt;clients_slaves = mem;</div><div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;    mem_total+=mem;</div><div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;</div><div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;    mem = 0;</div><div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="adlist_8h.html#afde0ab079f934670e82119b43120e94b">listLength</a>(server.clients)) {</div><div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;        listIter li;</div><div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;        listNode *ln;</div><div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;</div><div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;        listRewind(server.clients,&amp;li);</div><div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;        <span class="keywordflow">while</span>((ln = listNext(&amp;li))) {</div><div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;            <a class="code" href="structclient.html">client</a> *c = <a class="code" href="adlist_8h.html#af84cae230e7180ebcda1e2736fce9f65">listNodeValue</a>(ln);</div><div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;            <span class="keywordflow">if</span> (c-&gt;flags &amp; <a class="code" href="server_8h.html#ae9f6995948253652bc9454d79a72f4a7">CLIENT_SLAVE</a>)</div><div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;                <span class="keywordflow">continue</span>;</div><div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;            mem += getClientOutputBufferMemoryUsage(c);</div><div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;            mem += sdsAllocSize(c-&gt;querybuf);</div><div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;            mem += <span class="keyword">sizeof</span>(client);</div><div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;        }</div><div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;    }</div><div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;    mh-&gt;clients_normal = mem;</div><div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;    mem_total+=mem;</div><div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;</div><div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;    mem = 0;</div><div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;    <span class="keywordflow">if</span> (server.aof_state != <a class="code" href="server_8h.html#a5226306fbcebcb6d5d02e0fef3c213c2">AOF_OFF</a>) {</div><div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;        mem += sdslen(server.aof_buf);</div><div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;        mem += aofRewriteBufferSize();</div><div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;    }</div><div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;    mh-&gt;aof_buffer = mem;</div><div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;    mem_total+=mem;</div><div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;</div><div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;    <span class="keywordflow">for</span> (j = 0; j &lt; server.dbnum; j++) {</div><div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;        redisDb *db = server.db+j;</div><div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;        <span class="keywordtype">long</span> <span class="keywordtype">long</span> keyscount = <a class="code" href="dict_8h.html#af193430dd3d5579a52b194512f72c1f0">dictSize</a>(db-&gt;dict);</div><div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;        <span class="keywordflow">if</span> (keyscount==0) <span class="keywordflow">continue</span>;</div><div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;</div><div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;        mh-&gt;total_keys += keyscount;</div><div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;        mh-&gt;db = zrealloc(mh-&gt;db,<span class="keyword">sizeof</span>(mh-&gt;db[0])*(mh-&gt;num_dbs+1));</div><div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;        mh-&gt;db[mh-&gt;num_dbs].dbid = j;</div><div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;</div><div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;        mem = <a class="code" href="dict_8h.html#af193430dd3d5579a52b194512f72c1f0">dictSize</a>(db-&gt;dict) * <span class="keyword">sizeof</span>(dictEntry) +</div><div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;              <a class="code" href="dict_8h.html#aca9596be4bcc2caa07c17dd8cebcceec">dictSlots</a>(db-&gt;dict) * <span class="keyword">sizeof</span>(dictEntry*) +</div><div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;              <a class="code" href="dict_8h.html#af193430dd3d5579a52b194512f72c1f0">dictSize</a>(db-&gt;dict) * <span class="keyword">sizeof</span>(robj);</div><div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;        mh-&gt;db[mh-&gt;num_dbs].overhead_ht_main = mem;</div><div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;        mem_total+=mem;</div><div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;</div><div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;        mem = <a class="code" href="dict_8h.html#af193430dd3d5579a52b194512f72c1f0">dictSize</a>(db-&gt;expires) * <span class="keyword">sizeof</span>(dictEntry) +</div><div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;              <a class="code" href="dict_8h.html#aca9596be4bcc2caa07c17dd8cebcceec">dictSlots</a>(db-&gt;expires) * <span class="keyword">sizeof</span>(dictEntry*);</div><div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;        mh-&gt;db[mh-&gt;num_dbs].overhead_ht_expires = mem;</div><div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;        mem_total+=mem;</div><div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;</div><div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;        mh-&gt;num_dbs++;</div><div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;    }</div><div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;</div><div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;    mh-&gt;overhead_total = mem_total;</div><div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;    mh-&gt;dataset = zmalloc_used - mem_total;</div><div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;    mh-&gt;peak_perc = (<span class="keywordtype">float</span>)zmalloc_used*100/mh-&gt;peak_allocated;</div><div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;</div><div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;    <span class="comment">/* Metrics computed after subtracting the startup memory from</span></div><div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;<span class="comment">     * the total memory. */</span></div><div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;    size_t net_usage = 1;</div><div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;    <span class="keywordflow">if</span> (zmalloc_used &gt; mh-&gt;startup_allocated)</div><div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;        net_usage = zmalloc_used - mh-&gt;startup_allocated;</div><div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;    mh-&gt;dataset_perc = (<span class="keywordtype">float</span>)mh-&gt;dataset*100/net_usage;</div><div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;    mh-&gt;bytes_per_key = mh-&gt;total_keys ? (net_usage / mh-&gt;total_keys) : 0;</div><div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;</div><div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;    <span class="keywordflow">return</span> mh;</div><div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;}</div><div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;</div><div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;<span class="comment">/* Helper for &quot;MEMORY allocator-stats&quot;, used as a callback for the jemalloc</span></div><div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;<span class="comment"> * stats output. */</span></div><div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;<span class="keywordtype">void</span> inputCatSds(<span class="keywordtype">void</span> *result, <span class="keyword">const</span> <span class="keywordtype">char</span> *str) {</div><div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;    <span class="comment">/* result is actually a (sds *), so re-cast it here */</span></div><div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;    sds *info = (sds *)result;</div><div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;    *info = sdscat(*info, str);</div><div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;}</div><div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;</div><div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;<span class="comment">/* This implements MEMORY DOCTOR. An human readable analysis of the Redis</span></div><div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;<span class="comment"> * memory condition. */</span></div><div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;sds getMemoryDoctorReport(<span class="keywordtype">void</span>) {</div><div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;    <span class="keywordtype">int</span> empty = 0;          <span class="comment">/* Instance is empty or almost empty. */</span></div><div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;    <span class="keywordtype">int</span> big_peak = 0;       <span class="comment">/* Memory peak is much larger than used mem. */</span></div><div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;    <span class="keywordtype">int</span> high_frag = 0;      <span class="comment">/* High fragmentation. */</span></div><div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;    <span class="keywordtype">int</span> big_slave_buf = 0;  <span class="comment">/* Slave buffers are too big. */</span></div><div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;    <span class="keywordtype">int</span> big_client_buf = 0; <span class="comment">/* Client buffers are too big. */</span></div><div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;    <span class="keywordtype">int</span> num_reports = 0;</div><div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;    <span class="keyword">struct</span> <a class="code" href="structredisMemOverhead.html">redisMemOverhead</a> *mh = getMemoryOverheadData();</div><div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;</div><div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;    <span class="keywordflow">if</span> (mh-&gt;total_allocated &lt; (1024*1024*5)) {</div><div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;        empty = 1;</div><div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;        num_reports++;</div><div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;        <span class="comment">/* Peak is &gt; 150% of current used memory? */</span></div><div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;        <span class="keywordflow">if</span> (((<span class="keywordtype">float</span>)mh-&gt;peak_allocated / mh-&gt;total_allocated) &gt; 1.5) {</div><div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160;            big_peak = 1;</div><div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;            num_reports++;</div><div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;        }</div><div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;</div><div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;        <span class="comment">/* Fragmentation is higher than 1.4? */</span></div><div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;        <span class="keywordflow">if</span> (mh-&gt;fragmentation &gt; 1.4) {</div><div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;            high_frag = 1;</div><div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;            num_reports++;</div><div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;        }</div><div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;</div><div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;        <span class="comment">/* Clients using more than 200k each average? */</span></div><div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;        <span class="keywordtype">long</span> numslaves = <a class="code" href="adlist_8h.html#afde0ab079f934670e82119b43120e94b">listLength</a>(server.slaves);</div><div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;        <span class="keywordtype">long</span> numclients = <a class="code" href="adlist_8h.html#afde0ab079f934670e82119b43120e94b">listLength</a>(server.clients)-numslaves;</div><div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;        <span class="keywordflow">if</span> (mh-&gt;clients_normal / numclients &gt; (1024*200)) {</div><div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;            big_client_buf = 1;</div><div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;            num_reports++;</div><div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;        }</div><div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;</div><div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;        <span class="comment">/* Slaves using more than 10 MB each? */</span></div><div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;        <span class="keywordflow">if</span> (numslaves &gt; 0 &amp;&amp; mh-&gt;clients_slaves / numslaves &gt; (1024*1024*10)) {</div><div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;            big_slave_buf = 1;</div><div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;            num_reports++;</div><div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;        }</div><div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;    }</div><div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;</div><div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;    sds s;</div><div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;    <span class="keywordflow">if</span> (num_reports == 0) {</div><div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;        s = sdsnew(</div><div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;        <span class="stringliteral">&quot;Hi Sam, I can&#39;t find any memory issue in your instance. &quot;</span></div><div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;        <span class="stringliteral">&quot;I can only account for what occurs on this base.\n&quot;</span>);</div><div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (empty == 1) {</div><div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;        s = sdsnew(</div><div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;        <span class="stringliteral">&quot;Hi Sam, this instance is empty or is using very little memory, &quot;</span></div><div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;        <span class="stringliteral">&quot;my issues detector can&#39;t be used in these conditions. &quot;</span></div><div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;        <span class="stringliteral">&quot;Please, leave for your mission on Earth and fill it with some data. &quot;</span></div><div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;        <span class="stringliteral">&quot;The new Sam and I will be back to our programming as soon as I &quot;</span></div><div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;        <span class="stringliteral">&quot;finished rebooting.\n&quot;</span>);</div><div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;        s = sdsnew(<span class="stringliteral">&quot;Sam, I detected a few issues in this Redis instance memory implants:\n\n&quot;</span>);</div><div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;        <span class="keywordflow">if</span> (big_peak) {</div><div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;            s = sdscat(s,<span class="stringliteral">&quot; * Peak memory: In the past this instance used more than 150% the memory that is currently using. The allocator is normally not able to release memory after a peak, so you can expect to see a big fragmentation ratio, however this is actually harmless and is only due to the memory peak, and if the Redis instance Resident Set Size (RSS) is currently bigger than expected, the memory will be used as soon as you fill the Redis instance with more data. If the memory peak was only occasional and you want to try to reclaim memory, please try the MEMORY PURGE command, otherwise the only other option is to shutdown and restart the instance.\n\n&quot;</span>);</div><div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;        }</div><div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;        <span class="keywordflow">if</span> (high_frag) {</div><div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;            s = sdscatprintf(s,<span class="stringliteral">&quot; * High fragmentation: This instance has a memory fragmentation greater than 1.4 (this means that the Resident Set Size of the Redis process is much larger than the sum of the logical allocations Redis performed). This problem is usually due either to a large peak memory (check if there is a peak memory entry above in the report) or may result from a workload that causes the allocator to fragment memory a lot. If the problem is a large peak memory, then there is no issue. Otherwise, make sure you are using the Jemalloc allocator and not the default libc malloc. Note: The currently used allocator is \&quot;%s\&quot;.\n\n&quot;</span>, <a class="code" href="zmalloc_8h.html#a374c6d7cf6c9817e1243093e03df7319">ZMALLOC_LIB</a>);</div><div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;        }</div><div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;        <span class="keywordflow">if</span> (big_slave_buf) {</div><div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;            s = sdscat(s,<span class="stringliteral">&quot; * Big slave buffers: The slave output buffers in this instance are greater than 10MB for each slave (on average). This likely means that there is some slave instance that is struggling receiving data, either because it is too slow or because of networking issues. As a result, data piles on the master output buffers. Please try to identify what slave is not receiving data correctly and why. You can use the INFO output in order to check the slaves delays and the CLIENT LIST command to check the output buffers of each slave.\n\n&quot;</span>);</div><div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;        }</div><div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;        <span class="keywordflow">if</span> (big_client_buf) {</div><div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;            s = sdscat(s,<span class="stringliteral">&quot; * Big client buffers: The clients output buffers in this instance are greater than 200K per client (on average). This may result from different causes, like Pub/Sub clients subscribed to channels bot not receiving data fast enough, so that data piles on the Redis instance output buffer, or clients sending commands with large replies or very large sequences of commands in the same pipeline. Please use the CLIENT LIST command in order to investigate the issue if it causes problems in your instance, or to understand better why certain clients are using a big amount of memory.\n\n&quot;</span>);</div><div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;        }</div><div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;        s = sdscat(s,<span class="stringliteral">&quot;I&#39;m here to keep you safe, Sam. I want to help you.\n&quot;</span>);</div><div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;    }</div><div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;    freeMemoryOverheadData(mh);</div><div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;    <span class="keywordflow">return</span> s;</div><div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;}</div><div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;</div><div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;<span class="comment">/* ======================= The OBJECT and MEMORY commands =================== */</span></div><div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;</div><div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;<span class="comment">/* This is a helper function for the OBJECT command. We need to lookup keys</span></div><div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;<span class="comment"> * without any modification of LRU or other parameters. */</span></div><div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;robj *objectCommandLookup(<a class="code" href="structclient.html">client</a> *c, robj *key) {</div><div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;    dictEntry *de;</div><div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;</div><div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;    <span class="keywordflow">if</span> ((de = dictFind(c-&gt;db-&gt;dict,key-&gt;ptr)) == NULL) <span class="keywordflow">return</span> NULL;</div><div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;    <span class="keywordflow">return</span> (robj*) <a class="code" href="dict_8h.html#ae8d2cc391873b2bea2b87c4f80f43120">dictGetVal</a>(de);</div><div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;}</div><div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;</div><div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;robj *objectCommandLookupOrReply(<a class="code" href="structclient.html">client</a> *c, robj *key, robj *reply) {</div><div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;    robj *o = objectCommandLookup(c,key);</div><div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;</div><div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;    <span class="keywordflow">if</span> (!o) addReply(c, reply);</div><div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;    <span class="keywordflow">return</span> o;</div><div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;}</div><div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;</div><div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;<span class="comment">/* Object command allows to inspect the internals of an Redis Object.</span></div><div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;<span class="comment"> * Usage: OBJECT &lt;refcount|encoding|idletime|freq&gt; &lt;key&gt; */</span></div><div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;<span class="keywordtype">void</span> objectCommand(<a class="code" href="structclient.html">client</a> *c) {</div><div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160;    robj *o;</div><div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;</div><div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;    <span class="keywordflow">if</span> (c-&gt;argc == 2 &amp;&amp; !strcasecmp(c-&gt;argv[1]-&gt;ptr,<span class="stringliteral">&quot;help&quot;</span>)) {</div><div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;        <span class="keyword">const</span> <span class="keywordtype">char</span> *help[] = {</div><div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;<span class="stringliteral">&quot;encoding &lt;key&gt; -- Return the kind of internal representation used in order to store the value associated with a key.&quot;</span>,</div><div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160;<span class="stringliteral">&quot;freq &lt;key&gt; -- Return the access frequency index of the key. The returned integer is proportional to the logarithm of the recent access frequency of the key.&quot;</span>,</div><div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;<span class="stringliteral">&quot;idletime &lt;key&gt; -- Return the idle time of the key, that is the approximated number of seconds elapsed since the last access to the key.&quot;</span>,</div><div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;<span class="stringliteral">&quot;refcount &lt;key&gt; -- Return the number of references of the value associated with the specified key.&quot;</span>,</div><div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;NULL</div><div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;        };</div><div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;        addReplyHelp(c, help);</div><div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(c-&gt;argv[1]-&gt;ptr,<span class="stringliteral">&quot;refcount&quot;</span>) &amp;&amp; c-&gt;argc == 3) {</div><div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;        <span class="keywordflow">if</span> ((o = objectCommandLookupOrReply(c,c-&gt;argv[2],shared.nullbulk))</div><div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;                == NULL) <span class="keywordflow">return</span>;</div><div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;        addReplyLongLong(c,o-&gt;refcount);</div><div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(c-&gt;argv[1]-&gt;ptr,<span class="stringliteral">&quot;encoding&quot;</span>) &amp;&amp; c-&gt;argc == 3) {</div><div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;        <span class="keywordflow">if</span> ((o = objectCommandLookupOrReply(c,c-&gt;argv[2],shared.nullbulk))</div><div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;                == NULL) <span class="keywordflow">return</span>;</div><div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160;        addReplyBulkCString(c,strEncoding(o-&gt;encoding));</div><div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(c-&gt;argv[1]-&gt;ptr,<span class="stringliteral">&quot;idletime&quot;</span>) &amp;&amp; c-&gt;argc == 3) {</div><div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;        <span class="keywordflow">if</span> ((o = objectCommandLookupOrReply(c,c-&gt;argv[2],shared.nullbulk))</div><div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160;                == NULL) <span class="keywordflow">return</span>;</div><div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;        <span class="keywordflow">if</span> (server.maxmemory_policy &amp; <a class="code" href="server_8h.html#aac2d3ad7a604f87e06e25233dbd01c9b">MAXMEMORY_FLAG_LFU</a>) {</div><div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;            addReplyError(c,<span class="stringliteral">&quot;An LFU maxmemory policy is selected, idle time not tracked. Please note that when switching between policies at runtime LRU and LFU data will take some time to adjust.&quot;</span>);</div><div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;            <span class="keywordflow">return</span>;</div><div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;        }</div><div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;        addReplyLongLong(c,estimateObjectIdleTime(o)/1000);</div><div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(c-&gt;argv[1]-&gt;ptr,<span class="stringliteral">&quot;freq&quot;</span>) &amp;&amp; c-&gt;argc == 3) {</div><div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;        <span class="keywordflow">if</span> ((o = objectCommandLookupOrReply(c,c-&gt;argv[2],shared.nullbulk))</div><div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;                == NULL) <span class="keywordflow">return</span>;</div><div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;        <span class="keywordflow">if</span> (!(server.maxmemory_policy &amp; <a class="code" href="server_8h.html#aac2d3ad7a604f87e06e25233dbd01c9b">MAXMEMORY_FLAG_LFU</a>)) {</div><div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;            addReplyError(c,<span class="stringliteral">&quot;An LFU maxmemory policy is not selected, access frequency not tracked. Please note that when switching between policies at runtime LRU and LFU data will take some time to adjust.&quot;</span>);</div><div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;            <span class="keywordflow">return</span>;</div><div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;        }</div><div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;        <span class="comment">/* LFUDecrAndReturn should be called</span></div><div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;<span class="comment">         * in case of the key has not been accessed for a long time,</span></div><div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;<span class="comment">         * because we update the access time only</span></div><div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160;<span class="comment">         * when the key is read or overwritten. */</span></div><div class="line"><a name="l01110"></a><span class="lineno"> 1110</span>&#160;        addReplyLongLong(c,LFUDecrAndReturn(o));</div><div class="line"><a name="l01111"></a><span class="lineno"> 1111</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l01112"></a><span class="lineno"> 1112</span>&#160;        addReplyErrorFormat(c, <span class="stringliteral">&quot;Unknown subcommand or wrong number of arguments for &#39;%s&#39;. Try OBJECT help&quot;</span>, (<span class="keywordtype">char</span> *)c-&gt;argv[1]-&gt;ptr);</div><div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160;    }</div><div class="line"><a name="l01114"></a><span class="lineno"> 1114</span>&#160;}</div><div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;</div><div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160;<span class="comment">/* The memory command will eventually be a complete interface for the</span></div><div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;<span class="comment"> * memory introspection capabilities of Redis.</span></div><div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160;<span class="comment"> * Usage: MEMORY usage &lt;key&gt; */</span></div><div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;<span class="keywordtype">void</span> memoryCommand(<a class="code" href="structclient.html">client</a> *c) {</div><div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;    robj *o;</div><div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;</div><div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160;    <span class="keywordflow">if</span> (!strcasecmp(c-&gt;argv[1]-&gt;ptr,<span class="stringliteral">&quot;usage&quot;</span>) &amp;&amp; c-&gt;argc &gt;= 3) {</div><div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;        <span class="keywordtype">long</span> <span class="keywordtype">long</span> samples = <a class="code" href="object_8c.html#a46d9ae99d237582e21c70e7de56a032e">OBJ_COMPUTE_SIZE_DEF_SAMPLES</a>;</div><div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 3; j &lt; c-&gt;argc; j++) {</div><div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160;            <span class="keywordflow">if</span> (!strcasecmp(c-&gt;argv[j]-&gt;ptr,<span class="stringliteral">&quot;samples&quot;</span>) &amp;&amp;</div><div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;                j+1 &lt; c-&gt;argc)</div><div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160;            {</div><div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;                <span class="keywordflow">if</span> (getLongLongFromObjectOrReply(c,c-&gt;argv[j+1],&amp;samples,NULL)</div><div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;                     == <a class="code" href="server_8h.html#af98ac28d5f4d23d7ed5985188e6fb7d1">C_ERR</a>) <span class="keywordflow">return</span>;</div><div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160;                <span class="keywordflow">if</span> (samples &lt; 0) {</div><div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;                    addReply(c,shared.syntaxerr);</div><div class="line"><a name="l01133"></a><span class="lineno"> 1133</span>&#160;                    <span class="keywordflow">return</span>;</div><div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160;                }</div><div class="line"><a name="l01135"></a><span class="lineno"> 1135</span>&#160;                <span class="keywordflow">if</span> (samples == 0) samples = LLONG_MAX;;</div><div class="line"><a name="l01136"></a><span class="lineno"> 1136</span>&#160;                j++; <span class="comment">/* skip option argument. */</span></div><div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160;                addReply(c,shared.syntaxerr);</div><div class="line"><a name="l01139"></a><span class="lineno"> 1139</span>&#160;                <span class="keywordflow">return</span>;</div><div class="line"><a name="l01140"></a><span class="lineno"> 1140</span>&#160;            }</div><div class="line"><a name="l01141"></a><span class="lineno"> 1141</span>&#160;        }</div><div class="line"><a name="l01142"></a><span class="lineno"> 1142</span>&#160;        <span class="keywordflow">if</span> ((o = objectCommandLookupOrReply(c,c-&gt;argv[2],shared.nullbulk))</div><div class="line"><a name="l01143"></a><span class="lineno"> 1143</span>&#160;                == NULL) <span class="keywordflow">return</span>;</div><div class="line"><a name="l01144"></a><span class="lineno"> 1144</span>&#160;        size_t usage = objectComputeSize(o,samples);</div><div class="line"><a name="l01145"></a><span class="lineno"> 1145</span>&#160;        usage += sdsAllocSize(c-&gt;argv[2]-&gt;ptr);</div><div class="line"><a name="l01146"></a><span class="lineno"> 1146</span>&#160;        usage += <span class="keyword">sizeof</span>(dictEntry);</div><div class="line"><a name="l01147"></a><span class="lineno"> 1147</span>&#160;        addReplyLongLong(c,usage);</div><div class="line"><a name="l01148"></a><span class="lineno"> 1148</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(c-&gt;argv[1]-&gt;ptr,<span class="stringliteral">&quot;stats&quot;</span>) &amp;&amp; c-&gt;argc == 2) {</div><div class="line"><a name="l01149"></a><span class="lineno"> 1149</span>&#160;        <span class="keyword">struct</span> <a class="code" href="structredisMemOverhead.html">redisMemOverhead</a> *mh = getMemoryOverheadData();</div><div class="line"><a name="l01150"></a><span class="lineno"> 1150</span>&#160;</div><div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160;        addReplyMultiBulkLen(c,(14+mh-&gt;num_dbs)*2);</div><div class="line"><a name="l01152"></a><span class="lineno"> 1152</span>&#160;</div><div class="line"><a name="l01153"></a><span class="lineno"> 1153</span>&#160;        addReplyBulkCString(c,<span class="stringliteral">&quot;peak.allocated&quot;</span>);</div><div class="line"><a name="l01154"></a><span class="lineno"> 1154</span>&#160;        addReplyLongLong(c,mh-&gt;peak_allocated);</div><div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160;</div><div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160;        addReplyBulkCString(c,<span class="stringliteral">&quot;total.allocated&quot;</span>);</div><div class="line"><a name="l01157"></a><span class="lineno"> 1157</span>&#160;        addReplyLongLong(c,mh-&gt;total_allocated);</div><div class="line"><a name="l01158"></a><span class="lineno"> 1158</span>&#160;</div><div class="line"><a name="l01159"></a><span class="lineno"> 1159</span>&#160;        addReplyBulkCString(c,<span class="stringliteral">&quot;startup.allocated&quot;</span>);</div><div class="line"><a name="l01160"></a><span class="lineno"> 1160</span>&#160;        addReplyLongLong(c,mh-&gt;startup_allocated);</div><div class="line"><a name="l01161"></a><span class="lineno"> 1161</span>&#160;</div><div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160;        addReplyBulkCString(c,<span class="stringliteral">&quot;replication.backlog&quot;</span>);</div><div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160;        addReplyLongLong(c,mh-&gt;repl_backlog);</div><div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160;</div><div class="line"><a name="l01165"></a><span class="lineno"> 1165</span>&#160;        addReplyBulkCString(c,<span class="stringliteral">&quot;clients.slaves&quot;</span>);</div><div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160;        addReplyLongLong(c,mh-&gt;clients_slaves);</div><div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;</div><div class="line"><a name="l01168"></a><span class="lineno"> 1168</span>&#160;        addReplyBulkCString(c,<span class="stringliteral">&quot;clients.normal&quot;</span>);</div><div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160;        addReplyLongLong(c,mh-&gt;clients_normal);</div><div class="line"><a name="l01170"></a><span class="lineno"> 1170</span>&#160;</div><div class="line"><a name="l01171"></a><span class="lineno"> 1171</span>&#160;        addReplyBulkCString(c,<span class="stringliteral">&quot;aof.buffer&quot;</span>);</div><div class="line"><a name="l01172"></a><span class="lineno"> 1172</span>&#160;        addReplyLongLong(c,mh-&gt;aof_buffer);</div><div class="line"><a name="l01173"></a><span class="lineno"> 1173</span>&#160;</div><div class="line"><a name="l01174"></a><span class="lineno"> 1174</span>&#160;        <span class="keywordflow">for</span> (size_t j = 0; j &lt; mh-&gt;num_dbs; j++) {</div><div class="line"><a name="l01175"></a><span class="lineno"> 1175</span>&#160;            <span class="keywordtype">char</span> dbname[32];</div><div class="line"><a name="l01176"></a><span class="lineno"> 1176</span>&#160;            snprintf(dbname,<span class="keyword">sizeof</span>(dbname),<span class="stringliteral">&quot;db.%zd&quot;</span>,mh-&gt;db[j].dbid);</div><div class="line"><a name="l01177"></a><span class="lineno"> 1177</span>&#160;            addReplyBulkCString(c,dbname);</div><div class="line"><a name="l01178"></a><span class="lineno"> 1178</span>&#160;            addReplyMultiBulkLen(c,4);</div><div class="line"><a name="l01179"></a><span class="lineno"> 1179</span>&#160;</div><div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160;            addReplyBulkCString(c,<span class="stringliteral">&quot;overhead.hashtable.main&quot;</span>);</div><div class="line"><a name="l01181"></a><span class="lineno"> 1181</span>&#160;            addReplyLongLong(c,mh-&gt;db[j].overhead_ht_main);</div><div class="line"><a name="l01182"></a><span class="lineno"> 1182</span>&#160;</div><div class="line"><a name="l01183"></a><span class="lineno"> 1183</span>&#160;            addReplyBulkCString(c,<span class="stringliteral">&quot;overhead.hashtable.expires&quot;</span>);</div><div class="line"><a name="l01184"></a><span class="lineno"> 1184</span>&#160;            addReplyLongLong(c,mh-&gt;db[j].overhead_ht_expires);</div><div class="line"><a name="l01185"></a><span class="lineno"> 1185</span>&#160;        }</div><div class="line"><a name="l01186"></a><span class="lineno"> 1186</span>&#160;</div><div class="line"><a name="l01187"></a><span class="lineno"> 1187</span>&#160;        addReplyBulkCString(c,<span class="stringliteral">&quot;overhead.total&quot;</span>);</div><div class="line"><a name="l01188"></a><span class="lineno"> 1188</span>&#160;        addReplyLongLong(c,mh-&gt;overhead_total);</div><div class="line"><a name="l01189"></a><span class="lineno"> 1189</span>&#160;</div><div class="line"><a name="l01190"></a><span class="lineno"> 1190</span>&#160;        addReplyBulkCString(c,<span class="stringliteral">&quot;keys.count&quot;</span>);</div><div class="line"><a name="l01191"></a><span class="lineno"> 1191</span>&#160;        addReplyLongLong(c,mh-&gt;total_keys);</div><div class="line"><a name="l01192"></a><span class="lineno"> 1192</span>&#160;</div><div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160;        addReplyBulkCString(c,<span class="stringliteral">&quot;keys.bytes-per-key&quot;</span>);</div><div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160;        addReplyLongLong(c,mh-&gt;bytes_per_key);</div><div class="line"><a name="l01195"></a><span class="lineno"> 1195</span>&#160;</div><div class="line"><a name="l01196"></a><span class="lineno"> 1196</span>&#160;        addReplyBulkCString(c,<span class="stringliteral">&quot;dataset.bytes&quot;</span>);</div><div class="line"><a name="l01197"></a><span class="lineno"> 1197</span>&#160;        addReplyLongLong(c,mh-&gt;dataset);</div><div class="line"><a name="l01198"></a><span class="lineno"> 1198</span>&#160;</div><div class="line"><a name="l01199"></a><span class="lineno"> 1199</span>&#160;        addReplyBulkCString(c,<span class="stringliteral">&quot;dataset.percentage&quot;</span>);</div><div class="line"><a name="l01200"></a><span class="lineno"> 1200</span>&#160;        addReplyDouble(c,mh-&gt;dataset_perc);</div><div class="line"><a name="l01201"></a><span class="lineno"> 1201</span>&#160;</div><div class="line"><a name="l01202"></a><span class="lineno"> 1202</span>&#160;        addReplyBulkCString(c,<span class="stringliteral">&quot;peak.percentage&quot;</span>);</div><div class="line"><a name="l01203"></a><span class="lineno"> 1203</span>&#160;        addReplyDouble(c,mh-&gt;peak_perc);</div><div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160;</div><div class="line"><a name="l01205"></a><span class="lineno"> 1205</span>&#160;        addReplyBulkCString(c,<span class="stringliteral">&quot;fragmentation&quot;</span>);</div><div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160;        addReplyDouble(c,mh-&gt;fragmentation);</div><div class="line"><a name="l01207"></a><span class="lineno"> 1207</span>&#160;</div><div class="line"><a name="l01208"></a><span class="lineno"> 1208</span>&#160;        freeMemoryOverheadData(mh);</div><div class="line"><a name="l01209"></a><span class="lineno"> 1209</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(c-&gt;argv[1]-&gt;ptr,<span class="stringliteral">&quot;malloc-stats&quot;</span>) &amp;&amp; c-&gt;argc == 2) {</div><div class="line"><a name="l01210"></a><span class="lineno"> 1210</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">if</span> <span class="preprocessor">defined</span><span class="preprocessor">(</span><span class="preprocessor">USE_JEMALLOC</span><span class="preprocessor">)</span></div><div class="line"><a name="l01211"></a><span class="lineno"> 1211</span>&#160;        sds info = sdsempty();</div><div class="line"><a name="l01212"></a><span class="lineno"> 1212</span>&#160;        je_malloc_stats_print(inputCatSds, &amp;info, NULL);</div><div class="line"><a name="l01213"></a><span class="lineno"> 1213</span>&#160;        addReplyBulkSds(c, info);</div><div class="line"><a name="l01214"></a><span class="lineno"> 1214</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">else</span></div><div class="line"><a name="l01215"></a><span class="lineno"> 1215</span>&#160;        addReplyBulkCString(c,<span class="stringliteral">&quot;Stats not supported for the current allocator&quot;</span>);</div><div class="line"><a name="l01216"></a><span class="lineno"> 1216</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">endif</span></div><div class="line"><a name="l01217"></a><span class="lineno"> 1217</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(c-&gt;argv[1]-&gt;ptr,<span class="stringliteral">&quot;doctor&quot;</span>) &amp;&amp; c-&gt;argc == 2) {</div><div class="line"><a name="l01218"></a><span class="lineno"> 1218</span>&#160;        sds report = getMemoryDoctorReport();</div><div class="line"><a name="l01219"></a><span class="lineno"> 1219</span>&#160;        addReplyBulkSds(c,report);</div><div class="line"><a name="l01220"></a><span class="lineno"> 1220</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(c-&gt;argv[1]-&gt;ptr,<span class="stringliteral">&quot;purge&quot;</span>) &amp;&amp; c-&gt;argc == 2) {</div><div class="line"><a name="l01221"></a><span class="lineno"> 1221</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">if</span> <span class="preprocessor">defined</span><span class="preprocessor">(</span><span class="preprocessor">USE_JEMALLOC</span><span class="preprocessor">)</span></div><div class="line"><a name="l01222"></a><span class="lineno"> 1222</span>&#160;        <span class="keywordtype">char</span> tmp[32];</div><div class="line"><a name="l01223"></a><span class="lineno"> 1223</span>&#160;        <span class="keywordtype">unsigned</span> narenas = 0;</div><div class="line"><a name="l01224"></a><span class="lineno"> 1224</span>&#160;        size_t sz = <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span>);</div><div class="line"><a name="l01225"></a><span class="lineno"> 1225</span>&#160;        <span class="keywordflow">if</span> (!je_mallctl(<span class="stringliteral">&quot;arenas.narenas&quot;</span>, &amp;narenas, &amp;sz, NULL, 0)) {</div><div class="line"><a name="l01226"></a><span class="lineno"> 1226</span>&#160;            sprintf(tmp, <span class="stringliteral">&quot;arena.%d.purge&quot;</span>, narenas);</div><div class="line"><a name="l01227"></a><span class="lineno"> 1227</span>&#160;            <span class="keywordflow">if</span> (!je_mallctl(tmp, NULL, 0, NULL, 0)) {</div><div class="line"><a name="l01228"></a><span class="lineno"> 1228</span>&#160;                addReply(c, shared.ok);</div><div class="line"><a name="l01229"></a><span class="lineno"> 1229</span>&#160;                <span class="keywordflow">return</span>;</div><div class="line"><a name="l01230"></a><span class="lineno"> 1230</span>&#160;            }</div><div class="line"><a name="l01231"></a><span class="lineno"> 1231</span>&#160;        }</div><div class="line"><a name="l01232"></a><span class="lineno"> 1232</span>&#160;        addReplyError(c, <span class="stringliteral">&quot;Error purging dirty pages&quot;</span>);</div><div class="line"><a name="l01233"></a><span class="lineno"> 1233</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">else</span></div><div class="line"><a name="l01234"></a><span class="lineno"> 1234</span>&#160;        addReply(c, shared.ok);</div><div class="line"><a name="l01235"></a><span class="lineno"> 1235</span>&#160;        <span class="comment">/* Nothing to do for other allocators. */</span></div><div class="line"><a name="l01236"></a><span class="lineno"> 1236</span>&#160;<span class="preprocessor">#</span><span class="preprocessor">endif</span></div><div class="line"><a name="l01237"></a><span class="lineno"> 1237</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(c-&gt;argv[1]-&gt;ptr,<span class="stringliteral">&quot;help&quot;</span>) &amp;&amp; c-&gt;argc == 2) {</div><div class="line"><a name="l01238"></a><span class="lineno"> 1238</span>&#160;        addReplyMultiBulkLen(c,5);</div><div class="line"><a name="l01239"></a><span class="lineno"> 1239</span>&#160;        addReplyBulkCString(c,</div><div class="line"><a name="l01240"></a><span class="lineno"> 1240</span>&#160;<span class="stringliteral">&quot;MEMORY DOCTOR                        - Outputs memory problems report&quot;</span>);</div><div class="line"><a name="l01241"></a><span class="lineno"> 1241</span>&#160;        addReplyBulkCString(c,</div><div class="line"><a name="l01242"></a><span class="lineno"> 1242</span>&#160;<span class="stringliteral">&quot;MEMORY USAGE &lt;key&gt; [SAMPLES &lt;count&gt;] - Estimate memory usage of key&quot;</span>);</div><div class="line"><a name="l01243"></a><span class="lineno"> 1243</span>&#160;        addReplyBulkCString(c,</div><div class="line"><a name="l01244"></a><span class="lineno"> 1244</span>&#160;<span class="stringliteral">&quot;MEMORY STATS                         - Show memory usage details&quot;</span>);</div><div class="line"><a name="l01245"></a><span class="lineno"> 1245</span>&#160;        addReplyBulkCString(c,</div><div class="line"><a name="l01246"></a><span class="lineno"> 1246</span>&#160;<span class="stringliteral">&quot;MEMORY PURGE                         - Ask the allocator to release memory&quot;</span>);</div><div class="line"><a name="l01247"></a><span class="lineno"> 1247</span>&#160;        addReplyBulkCString(c,</div><div class="line"><a name="l01248"></a><span class="lineno"> 1248</span>&#160;<span class="stringliteral">&quot;MEMORY MALLOC-STATS                  - Show allocator internal stats&quot;</span>);</div><div class="line"><a name="l01249"></a><span class="lineno"> 1249</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l01250"></a><span class="lineno"> 1250</span>&#160;        addReplyError(c,<span class="stringliteral">&quot;Syntax error. Try MEMORY HELP&quot;</span>);</div><div class="line"><a name="l01251"></a><span class="lineno"> 1251</span>&#160;    }</div><div class="line"><a name="l01252"></a><span class="lineno"> 1252</span>&#160;}</div><div class="ttc" id="structredisMemOverhead_html"><div class="ttname"><a href="structredisMemOverhead.html">redisMemOverhead</a></div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00826">server.h:826</a></div></div>
<div class="ttc" id="server_8h_html_a11cc378e7778a830b41240578de3b204"><div class="ttname"><a href="server_8h.html#a11cc378e7778a830b41240578de3b204">serverPanic</a></div><div class="ttdeci">#define serverPanic(...)</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00444">server.h:444</a></div></div>
<div class="ttc" id="server_8h_html_a5226306fbcebcb6d5d02e0fef3c213c2"><div class="ttname"><a href="server_8h.html#a5226306fbcebcb6d5d02e0fef3c213c2">AOF_OFF</a></div><div class="ttdeci">#define AOF_OFF</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00216">server.h:216</a></div></div>
<div class="ttc" id="server_8h_html_ac5bb76b546161fd0da4b0ff89b3142ee"><div class="ttname"><a href="server_8h.html#ac5bb76b546161fd0da4b0ff89b3142ee">OBJ_ENCODING_EMBSTR</a></div><div class="ttdeci">#define OBJ_ENCODING_EMBSTR</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00581">server.h:581</a></div></div>
<div class="ttc" id="adlist_8h_html_afde0ab079f934670e82119b43120e94b"><div class="ttname"><a href="adlist_8h.html#afde0ab079f934670e82119b43120e94b">listLength</a></div><div class="ttdeci">#define listLength(l)</div><div class="ttdef"><b>Definition:</b> <a href="adlist_8h_source.html#l00057">adlist.h:57</a></div></div>
<div class="ttc" id="adlist_8h_html_af84cae230e7180ebcda1e2736fce9f65"><div class="ttname"><a href="adlist_8h.html#af84cae230e7180ebcda1e2736fce9f65">listNodeValue</a></div><div class="ttdeci">#define listNodeValue(n)</div><div class="ttdef"><b>Definition:</b> <a href="adlist_8h_source.html#l00062">adlist.h:62</a></div></div>
<div class="ttc" id="server_8h_html_acfb35db5cb30ed113ed23aeb1a224c4c"><div class="ttname"><a href="server_8h.html#acfb35db5cb30ed113ed23aeb1a224c4c">OBJ_ENCODING_SKIPLIST</a></div><div class="ttdeci">#define OBJ_ENCODING_SKIPLIST</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00580">server.h:580</a></div></div>
<div class="ttc" id="dict_8h_html_a3271c334309904a3086deca94f96e46e"><div class="ttname"><a href="dict_8h.html#a3271c334309904a3086deca94f96e46e">dictGetKey</a></div><div class="ttdeci">#define dictGetKey(he)</div><div class="ttdef"><b>Definition:</b> <a href="dict_8h_source.html#l00141">dict.h:141</a></div></div>
<div class="ttc" id="zmalloc_8h_html_a374c6d7cf6c9817e1243093e03df7319"><div class="ttname"><a href="zmalloc_8h.html#a374c6d7cf6c9817e1243093e03df7319">ZMALLOC_LIB</a></div><div class="ttdeci">#define ZMALLOC_LIB</div><div class="ttdef"><b>Definition:</b> <a href="zmalloc_8h_source.html#l00065">zmalloc.h:65</a></div></div>
<div class="ttc" id="structraxIterator_html"><div class="ttname"><a href="structraxIterator.html">raxIterator</a></div><div class="ttdef"><b>Definition:</b> <a href="rax_8h_source.html#l00130">rax.h:130</a></div></div>
<div class="ttc" id="sds_8h_html_a504136356f04bfa2fd616dd4c8fdd71c"><div class="ttname"><a href="sds_8h.html#a504136356f04bfa2fd616dd4c8fdd71c">SDS_TYPE_8</a></div><div class="ttdeci">#define SDS_TYPE_8</div><div class="ttdef"><b>Definition:</b> <a href="sds_8h_source.html#l00076">sds.h:76</a></div></div>
<div class="ttc" id="dict_8h_html_aca9596be4bcc2caa07c17dd8cebcceec"><div class="ttname"><a href="dict_8h.html#aca9596be4bcc2caa07c17dd8cebcceec">dictSlots</a></div><div class="ttdeci">#define dictSlots(d)</div><div class="ttdef"><b>Definition:</b> <a href="dict_8h_source.html#l00146">dict.h:146</a></div></div>
<div class="ttc" id="server_8h_html_af98ac28d5f4d23d7ed5985188e6fb7d1"><div class="ttname"><a href="server_8h.html#af98ac28d5f4d23d7ed5985188e6fb7d1">C_ERR</a></div><div class="ttdeci">#define C_ERR</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00079">server.h:79</a></div></div>
<div class="ttc" id="server_8h_html_a92c1fed85f709180fda0ff10d37d649b"><div class="ttname"><a href="server_8h.html#a92c1fed85f709180fda0ff10d37d649b">OBJ_MODULE</a></div><div class="ttdeci">#define OBJ_MODULE</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00470">server.h:470</a></div></div>
<div class="ttc" id="server_8h_html_a303769ef1065076e68731584e758d3e1"><div class="ttname"><a href="server_8h.html#a303769ef1065076e68731584e758d3e1">C_OK</a></div><div class="ttdeci">#define C_OK</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00078">server.h:78</a></div></div>
<div class="ttc" id="object_8c_html_aa471c38fc2e9e96a23693e7ff5e73209"><div class="ttname"><a href="object_8c.html#aa471c38fc2e9e96a23693e7ff5e73209">REDIS_COMPARE_COLL</a></div><div class="ttdeci">#define REDIS_COMPARE_COLL</div><div class="ttdef"><b>Definition:</b> <a href="object_8c_source.html#l00494">object.c:494</a></div></div>
<div class="ttc" id="server_8h_html_a311fc8b18b93af94e1ad418f1386b519"><div class="ttname"><a href="server_8h.html#a311fc8b18b93af94e1ad418f1386b519">OBJ_SHARED_INTEGERS</a></div><div class="ttdeci">#define OBJ_SHARED_INTEGERS</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00093">server.h:93</a></div></div>
<div class="ttc" id="server_8h_html_a15f4654e0f62585fa6ea50ede84598d5"><div class="ttname"><a href="server_8h.html#a15f4654e0f62585fa6ea50ede84598d5">MAXMEMORY_FLAG_NO_SHARED_INTEGERS</a></div><div class="ttdeci">#define MAXMEMORY_FLAG_NO_SHARED_INTEGERS</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00372">server.h:372</a></div></div>
<div class="ttc" id="server_8h_html_aabf064ede983103f1fd0df2086e84eee"><div class="ttname"><a href="server_8h.html#aabf064ede983103f1fd0df2086e84eee">OBJ_ENCODING_ZIPLIST</a></div><div class="ttdeci">#define OBJ_ENCODING_ZIPLIST</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00578">server.h:578</a></div></div>
<div class="ttc" id="structclient_html"><div class="ttname"><a href="structclient.html">client</a></div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00686">server.h:686</a></div></div>
<div class="ttc" id="server_8h_html_a8cec44bf7da67aac58839ab5033bdc0a"><div class="ttname"><a href="server_8h.html#a8cec44bf7da67aac58839ab5033bdc0a">LFU_INIT_VAL</a></div><div class="ttdeci">#define LFU_INIT_VAL</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l01822">server.h:1822</a></div></div>
<div class="ttc" id="server_8h_html_a214173987de21c3b7661fddd42b05873"><div class="ttname"><a href="server_8h.html#a214173987de21c3b7661fddd42b05873">OBJ_ENCODING_INTSET</a></div><div class="ttdeci">#define OBJ_ENCODING_INTSET</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00579">server.h:579</a></div></div>
<div class="ttc" id="server_8h_html_aac2d3ad7a604f87e06e25233dbd01c9b"><div class="ttname"><a href="server_8h.html#aac2d3ad7a604f87e06e25233dbd01c9b">MAXMEMORY_FLAG_LFU</a></div><div class="ttdeci">#define MAXMEMORY_FLAG_LFU</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00370">server.h:370</a></div></div>
<div class="ttc" id="server_8h_html_a9c10219f68afc557d510d108257d238b"><div class="ttname"><a href="server_8h.html#a9c10219f68afc557d510d108257d238b">OBJ_ENCODING_HT</a></div><div class="ttdeci">#define OBJ_ENCODING_HT</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00575">server.h:575</a></div></div>
<div class="ttc" id="object_8c_html_a46d9ae99d237582e21c70e7de56a032e"><div class="ttname"><a href="object_8c.html#a46d9ae99d237582e21c70e7de56a032e">OBJ_COMPUTE_SIZE_DEF_SAMPLES</a></div><div class="ttdeci">#define OBJ_COMPUTE_SIZE_DEF_SAMPLES</div><div class="ttdef"><b>Definition:</b> <a href="object_8c_source.html#l00715">object.c:715</a></div></div>
<div class="ttc" id="server_8h_html_a7308f76cbff9a8d3797fe78190b91282"><div class="ttname"><a href="server_8h.html#a7308f76cbff9a8d3797fe78190b91282">serverAssertWithInfo</a></div><div class="ttdeci">#define serverAssertWithInfo(_c, _o, _e)</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00442">server.h:442</a></div></div>
<div class="ttc" id="server_8h_html_a8c356422ddbc03bd77694880a30a1953"><div class="ttname"><a href="server_8h.html#a8c356422ddbc03bd77694880a30a1953">OBJ_ZSET</a></div><div class="ttdeci">#define OBJ_ZSET</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00456">server.h:456</a></div></div>
<div class="ttc" id="object_8c_html_a3e762d5fac271c94b01875920ff57fb2"><div class="ttname"><a href="object_8c.html#a3e762d5fac271c94b01875920ff57fb2">OBJ_ENCODING_EMBSTR_SIZE_LIMIT</a></div><div class="ttdeci">#define OBJ_ENCODING_EMBSTR_SIZE_LIMIT</div><div class="ttdef"><b>Definition:</b> <a href="object_8c_source.html#l00116">object.c:116</a></div></div>
<div class="ttc" id="server_8h_html_a65236ea160f69cdef33ec942092af88f"><div class="ttname"><a href="server_8h.html#a65236ea160f69cdef33ec942092af88f">OBJ_STRING</a></div><div class="ttdeci">#define OBJ_STRING</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00453">server.h:453</a></div></div>
<div class="ttc" id="server_8h_html_a87c05ba4f7f36741864277f02a4423fb"><div class="ttname"><a href="server_8h.html#a87c05ba4f7f36741864277f02a4423fb">OBJ_HASH</a></div><div class="ttdeci">#define OBJ_HASH</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00457">server.h:457</a></div></div>
<div class="ttc" id="server_8h_html_a4a5f22a280949c97a0cb0d4213275126"><div class="ttname"><a href="server_8h.html#a4a5f22a280949c97a0cb0d4213275126">OBJ_LIST</a></div><div class="ttdeci">#define OBJ_LIST</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00454">server.h:454</a></div></div>
<div class="ttc" id="dict_8h_html_ae8d2cc391873b2bea2b87c4f80f43120"><div class="ttname"><a href="dict_8h.html#ae8d2cc391873b2bea2b87c4f80f43120">dictGetVal</a></div><div class="ttdeci">#define dictGetVal(he)</div><div class="ttdef"><b>Definition:</b> <a href="dict_8h_source.html#l00142">dict.h:142</a></div></div>
<div class="ttc" id="dict_8h_html_af193430dd3d5579a52b194512f72c1f0"><div class="ttname"><a href="dict_8h.html#af193430dd3d5579a52b194512f72c1f0">dictSize</a></div><div class="ttdeci">#define dictSize(d)</div><div class="ttdef"><b>Definition:</b> <a href="dict_8h_source.html#l00147">dict.h:147</a></div></div>
<div class="ttc" id="server_8h_html_aec792aeed6d4bf83966672e6a23043b8"><div class="ttname"><a href="server_8h.html#aec792aeed6d4bf83966672e6a23043b8">OBJ_ENCODING_QUICKLIST</a></div><div class="ttdeci">#define OBJ_ENCODING_QUICKLIST</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00582">server.h:582</a></div></div>
<div class="ttc" id="server_8h_html_a1dc2a137875b0c8ee0fa1df43684a7b8"><div class="ttname"><a href="server_8h.html#a1dc2a137875b0c8ee0fa1df43684a7b8">OBJ_SHARED_REFCOUNT</a></div><div class="ttdeci">#define OBJ_SHARED_REFCOUNT</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00589">server.h:589</a></div></div>
<div class="ttc" id="structdictEntry_html"><div class="ttname"><a href="structdictEntry.html">dictEntry</a></div><div class="ttdef"><b>Definition:</b> <a href="dict_8h_source.html#l00047">dict.h:47</a></div></div>
<div class="ttc" id="server_8h_html_a8d179375a4aac33d3fa7aa80c8ccc75f"><div class="ttname"><a href="server_8h.html#a8d179375a4aac33d3fa7aa80c8ccc75f">OBJ_SET</a></div><div class="ttdeci">#define OBJ_SET</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00455">server.h:455</a></div></div>
<div class="ttc" id="object_8c_html_ac672f1c478e4a045035444729510d946"><div class="ttname"><a href="object_8c.html#ac672f1c478e4a045035444729510d946">REDIS_COMPARE_BINARY</a></div><div class="ttdeci">#define REDIS_COMPARE_BINARY</div><div class="ttdef"><b>Definition:</b> <a href="object_8c_source.html#l00493">object.c:493</a></div></div>
<div class="ttc" id="server_8h_html_ae934cf008a0be0ef009c92c2d006a816"><div class="ttname"><a href="server_8h.html#ae934cf008a0be0ef009c92c2d006a816">OBJ_ENCODING_INT</a></div><div class="ttdeci">#define OBJ_ENCODING_INT</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00574">server.h:574</a></div></div>
<div class="ttc" id="server_8h_html_afcfb5bd97af52d1dbce331745cae030c"><div class="ttname"><a href="server_8h.html#afcfb5bd97af52d1dbce331745cae030c">sdsEncodedObject</a></div><div class="ttdeci">#define sdsEncodedObject(objptr)</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l01487">server.h:1487</a></div></div>
<div class="ttc" id="server_8h_html_a2c2cc41300ca6b9daca7ea8a6d66edc6"><div class="ttname"><a href="server_8h.html#a2c2cc41300ca6b9daca7ea8a6d66edc6">OBJ_STREAM</a></div><div class="ttdeci">#define OBJ_STREAM</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00471">server.h:471</a></div></div>
<div class="ttc" id="server_8h_html_a148bc85e3074e324a6dc5eebcad1bcd5"><div class="ttname"><a href="server_8h.html#a148bc85e3074e324a6dc5eebcad1bcd5">OBJ_ENCODING_RAW</a></div><div class="ttdeci">#define OBJ_ENCODING_RAW</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00573">server.h:573</a></div></div>
<div class="ttc" id="server_8h_html_a8ed2d5ecb3c5343c4286f9c3a2346045"><div class="ttname"><a href="server_8h.html#a8ed2d5ecb3c5343c4286f9c3a2346045">OBJ_ENCODING_STREAM</a></div><div class="ttdeci">#define OBJ_ENCODING_STREAM</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00583">server.h:583</a></div></div>
<div class="ttc" id="server_8h_html_a88114b5169b4c382df6b56506285e56a"><div class="ttname"><a href="server_8h.html#a88114b5169b4c382df6b56506285e56a">serverAssert</a></div><div class="ttdeci">#define serverAssert(_e)</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00443">server.h:443</a></div></div>
<div class="ttc" id="server_8h_html_ae9f6995948253652bc9454d79a72f4a7"><div class="ttname"><a href="server_8h.html#ae9f6995948253652bc9454d79a72f4a7">CLIENT_SLAVE</a></div><div class="ttdeci">#define CLIENT_SLAVE</div><div class="ttdef"><b>Definition:</b> <a href="server_8h_source.html#l00221">server.h:221</a></div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li><li class="navelem"><b>object.c</b></li>
    <li class="footer">Generated on Sat Dec 23 2017 11:42:47 for Redis-Quant365 by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
